<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Freja-svn] r20 - in trunk: . lib src src/auxiliary
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/freja-svn/2006-March/index.html" >
   <LINK REL="made" HREF="mailto:freja-svn%40lists.berlios.de?Subject=Re%3A%20%5BFreja-svn%5D%20r20%20-%20in%20trunk%3A%20.%20lib%20src%20src/auxiliary&In-Reply-To=%3C200603310714.k2V7EY3O027654%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000015.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Freja-svn] r20 - in trunk: . lib src src/auxiliary</H1>
    <B>troelskn at BerliOS</B> 
    <A HREF="mailto:freja-svn%40lists.berlios.de?Subject=Re%3A%20%5BFreja-svn%5D%20r20%20-%20in%20trunk%3A%20.%20lib%20src%20src/auxiliary&In-Reply-To=%3C200603310714.k2V7EY3O027654%40sheep.berlios.de%3E"
       TITLE="[Freja-svn] r20 - in trunk: . lib src src/auxiliary">troelskn at berlios.de
       </A><BR>
    <I>Fri Mar 31 09:14:34 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000015.html">[Freja-svn] r19 - in trunk: lib tests
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16">[ date ]</a>
              <a href="thread.html#16">[ thread ]</a>
              <a href="subject.html#16">[ subject ]</a>
              <a href="author.html#16">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: troelskn
Date: 2006-03-31 09:14:29 +0200 (Fri, 31 Mar 2006)
New Revision: 20

Added:
   trunk/build.wsf
   trunk/src/
   trunk/src/AssetManager.js
   trunk/src/Freja.js
   trunk/src/Model.js
   trunk/src/QueryEngine.js
   trunk/src/UndoHistory.js
   trunk/src/View.js
   trunk/src/auxiliary/
   trunk/src/auxiliary/default.js
Modified:
   trunk/lib/Freja.js
Log:
Splitted the source out and made a build-script (windows script).

Added: trunk/build.wsf
===================================================================
--- trunk/build.wsf	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/build.wsf	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,59 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot; ?&gt;
+&lt;job id=&quot;Freja.Build&quot;&gt;
+	&lt;script language=&quot;JScript&quot;&gt;
+	&lt;![CDATA[
+	var Shell = WScript.CreateObject(&quot;WScript.Shell&quot;);
+	var FileSystem = WScript.CreateObject(&quot;Scripting.FileSystemObject&quot;);
+	var cwd = FileSystem.GetParentFolderName(WScript.ScriptFullName);
+	var srcDir = cwd + &quot;/src&quot;;
+	var outfile = cwd + &quot;/lib/Freja.js&quot;;
+	try {
+		FileSystem.deleteFile(outfile);
+	} catch (ex) {}
+
+	var file = FileSystem.openTextFile(srcDir + &quot;/Freja.js&quot;, 1, -2);
+	var source = file.readAll();
+	var VERSION = source.match(/Freja.VERSION \= \&quot;(.*)\&quot;/)[1];
+	file.close();
+	source = null;
+	
+	var TARGET = &quot;default&quot;;
+	var SUBMODULES = [
+		&quot;Freja&quot;,
+		&quot;auxiliary/&quot; + TARGET,
+		&quot;QueryEngine&quot;,
+		&quot;Model&quot;,
+		&quot;View&quot;,
+		&quot;UndoHistory&quot;,
+		&quot;AssetManager&quot;
+	];
+
+	var buildID = (new Date()).toUTCString();
+
+	var header = &quot;/&quot; + &quot;***\n&quot; +
+		&quot;\n    Freja &quot; + VERSION +
+		&quot;\n&quot; +
+		&quot;\n    Build $&quot; + buildID + &quot;$&quot; +
+		&quot;\n&quot; +
+		&quot;\n    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please&quot; +
+		&quot;\n    diff against the source tree, not this file.&quot; +
+		&quot;\n&quot; +
+		&quot;\n    Copyright (c) 2006 C&#233;dric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">pro at 4213miles.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;&quot; +
+		&quot;\n    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;&quot; +
+		&quot;\n&quot; +
+		&quot;\n***&quot; + &quot;/&quot; +
+		&quot;\n&quot;;
+
+	var source = &quot;&quot;;
+	for (var i=0; i &lt; SUBMODULES.length; ++i) {
+		var filename = srcDir + &quot;/&quot; + SUBMODULES[i] + &quot;.js&quot;;
+		var file = FileSystem.openTextFile(filename, 1, -2);
+		source += &quot;\n&quot; + file.readAll();
+		file.close();
+	}
+	var out = FileSystem.openTextFile(outfile, 2, -2);
+	out.write(header + source);
+	out.close();
+	]]&gt;
+	&lt;/script&gt;
+&lt;/job&gt;
\ No newline at end of file

Modified: trunk/lib/Freja.js
===================================================================
--- trunk/lib/Freja.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/lib/Freja.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -1,14 +1,17 @@
-/**
-  * Freja - a javascript Model-View-Controller Framework geared toward Zero-Latency Web Applications
-  *
-  * Copyright (c) 2006 C&#233;dric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">pro at 4213miles.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;
-  * This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;
-  *
-  * Documentation : <A HREF="http://www.csscripting.com/freja/">http://www.csscripting.com/freja/</A>
-  */
-/**
-  * Package : begin
-  */
+/***
+
+    Freja 2.0.alpha
+
+    Build $Fri, 31 Mar 2006 07:12:48 UTC$
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    Copyright (c) 2006 C&#233;dric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">pro at 4213miles.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;
+    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;
+
+***/
+
 if (typeof(dojo) != &quot;undefined&quot;) {
 	dojo.provide(&quot;Freja&quot;);
 }
@@ -24,11 +27,30 @@
 	return this.__repr__();
 };
 /**
-  * Package : end
+  * Single-hierarchy inheritance (class emulation)
+  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
+  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
   */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
 /**
   * Freja._aux
-  * wrapper for external functionality (frameworks).
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
+  *
   * You shouldn't rely on this functionality - it's merely a hook for Freja towards
   * external dependencies. This is the only part of the application you'll need to
   * adjust, to make Freja play ball with your favourite framework.
@@ -61,6 +83,9 @@
 } catch (e) {
 	throw new Error(&quot;Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!&quot;);
 }
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
 Freja._aux = {};
 /** bind(func, self[, arg, ...]) : function */
 Freja._aux.bind = MochiKit.Base.bind;
@@ -152,26 +177,8 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+
 /**
-  * Single-hierarchy inheritance (class emulation)
-  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
-  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
-  *
-  * Extends one prototype by another.
-  * The subtype will have two specialpurpose properties:
-  *     superconstructor    The parent prototype's constructor
-  *     supertype        The parent prototype
-  */
-Freja.Class = {};
-Freja.Class.extend = function(subClass, superconstructor) {
-	var inlineSuper = function(){};
-	inlineSuper.prototype = superconstructor.prototype;
-	subClass.prototype = new inlineSuper();
-	subClass.prototype.constructor = subClass;
-	subClass.prototype.superconstructor = superconstructor;
-	subClass.prototype.supertype = superconstructor.prototype;
-};
-/**
   * The baseclass for queryengines
   * @abstract
   */
@@ -249,7 +256,7 @@
 		throw new Error(&quot;Can't evaluate expression &quot; + expression);
 	}
 	return node;
-};
+};
 /**
   * Standard model component
   */
@@ -376,6 +383,7 @@
 	}
 	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
 };
+
 /**
   * Standard view component
   */
@@ -384,8 +392,9 @@
 	this.ready = false;
 	this.document = null;
 	this._renderer = renderer;
+	this._destination = null;
 	this.handlers = [];
-	this._destination = null;
+	this.placeholder = null;
 	Freja._aux.registerSignals(this, [&quot;onload&quot;,&quot;onrendercomplete&quot;]);
 	Freja._aux.connect(this, &quot;onrendercomplete&quot;, Freja._aux.bind(this._connectBehaviour, this));
 };
@@ -396,6 +405,7 @@
   * @returns MochiKit.Async.Deferred
   */
 Freja.View.prototype.render = function(model, placeholder) {
+	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
 
 	var Handler = function(model, view, deferred) {
 		this.model = model;
@@ -568,7 +578,7 @@
 	}
 	req.send(postedData);
 	return d;
-};
+};
 /**
   * This is largely s copied with minor stylistic adjustments from Freja 1.1
   * I renamed it from Controller.history to distinguish between window.history
@@ -654,6 +664,7 @@
 	this.cache[this._position] = {};
 	this._undoSteps = 0;
 };
+
 /**
   * main repository
   * @static

Added: trunk/src/AssetManager.js
===================================================================
--- trunk/src/AssetManager.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/AssetManager.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,184 @@
+/**
+  * main repository
+  * @static
+  */
+Freja.AssetManager = {
+	models : [],
+	views : [],
+	_username : null,
+	_password : null
+};
+/**
+  * Set to sync to make all requests synchroneous. You shouldn't use
+  * this setting for anything but testing/debugging.
+  * &quot;async&quot; | &quot;sync&quot;
+  */
+Freja.AssetManager.HTTP_REQUEST_TYPE = &quot;async&quot;;
+/**
+  * If this is set to null, real PUT and DELETE http-requests will be made,
+  * otherwise a header will be set instead, and the request tunneled through
+  * POST.
+  *
+  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
+  * if theese are your target platform, you can disable tunneling.
+  */
+// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
+/**
+  * Set this url to provide remote xslt-transformation for browsers that
+  * doesn't support it natively.
+  */
+Freja.AssetManager.XSLT_SERVICE_URL = &quot;srvc-xslt.php&quot;;
+/**
+  * HTML displayed while waiting for stuff to happen
+  */
+Freja.AssetManager.THROBBER_HTML = &quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
+/**
+  * returns an instance of the renderengine to use
+  */
+Freja.AssetManager.createRenderer = function() {
+//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	if (Freja._aux.hasSupportForXSLT()) {
+		return new Freja.View.Renderer.XSLTransformer();
+	} else {
+		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	}
+};
+/**
+  * Wipes all caches. This isn't something you will normally use during production,
+  * but it's very helpful for debugging/testing
+  */
+Freja.AssetManager.clearCache = function() {
+	this.models = [];
+	this.views = [];
+};
+/**
+  * Load a model-component
+  * @param    url      string
+  */
+Freja.AssetManager.getModel = function(url) {
+	for (var i=0; i &lt; this.models.length; i++) {
+		if (this.models[i].url == url) {
+			return this.models[i];
+		}
+	}
+	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, m);
+	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.models.push(m);
+	return m;
+};
+/**
+  * Load a view-component
+  * @param    url      string
+  */
+Freja.AssetManager.getView = function(url) {
+	for (var i=0; i &lt; this.views.length; i++) {
+		if (this.views[i].url == url) {
+			return this.views[i];
+		}
+	}
+	var v = new Freja.View(url, this.createRenderer());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, v);
+	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.views.push(v);
+	return v;
+};
+/**
+  * Creates and opens a http-request, tunneling exotic methods if needed.
+  */
+Freja.AssetManager.openXMLHttpRequest = function(method, url) {
+	var tunnel = null;
+	if (Freja.AssetManager.HTTP_METHOD_TUNNEL &amp;&amp; method != &quot;GET&quot; &amp;&amp; method != &quot;POST&quot;) {
+		tunnel = method;
+		method = &quot;POST&quot;;
+	}
+	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+	if (tunnel) {
+		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
+	}
+	return req;
+};
+/**
+  * Sets username + password for Http-Authentication
+  */
+Freja.AssetManager.setCredentials = function(username, password) {
+	this._username = username;
+	this._password = password;
+};
+/**
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.AssetManager.loadAsset = function(url, preventCaching) {
+	var match = /^(file:\/\/.*\/)([^/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var d = Freja._aux.createDeferred();
+	var handler = function(transport) {
+		try {
+			if (transport.responseText == &quot;&quot;) {
+				throw new Error(&quot;Empty response.&quot;);
+			}
+			if (transport.responseXML.xml == &quot;&quot;) {
+				// The server doesn't reply with Content-Type: text/xml
+				// this will happen if the file is loaded locally (through <A HREF="file://">file://</A>)
+				var document = Freja._aux.loadXML(transport.responseText);
+			} else {
+				var document = transport.responseXML;
+			}
+		} catch (ex) {
+			d.errback(ex);
+		}
+		d.callback(document);
+	};
+	try {
+		if (preventCaching &amp;&amp; Freja.AssetManager.HTTP_METHOD_TUNNEL) {
+			var req = Freja._aux.openXMLHttpRequest(&quot;POST&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, &quot;GET&quot;);
+			req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+		} else {
+			var req = Freja._aux.openXMLHttpRequest(&quot;GET&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+		}
+
+		// This shouldn't be nescesary, but alas it is - firefox chokes
+		// It's probably due to an error in MochiKit, so the problem
+		// should be fixed there.
+		var comm = Freja._aux.sendXMLHttpRequest(req);
+		if (Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;) {
+			comm.addCallbacks(handler, Freja._aux.bind(d.errback, d));
+		} else {
+			if (req.status == 0 || req.status == 200 || req.status == 304) {
+				handler(req);
+			} else {
+				d.errback(new Error(&quot;Request failed:&quot; + req.status));
+			}
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * This is a default error-handler. You should provide your own.
+  * The handler is called if an asynchronous error happens, since
+  * this could not be caught with the usual try ... catch
+  *
+  * It ought to be replaced completely with Deferred
+  */
+Freja.AssetManager.onerror = function(ex) {
+	alert(&quot;Freja.AssetManager.onerror\n&quot; + ex.message);
+};
+/**
+  * Global exports
+  */
+window.getModel = Freja._aux.bind(&quot;getModel&quot;, Freja.AssetManager);
+window.getView = Freja._aux.bind(&quot;getView&quot;, Freja.AssetManager);
\ No newline at end of file

Added: trunk/src/Freja.js
===================================================================
--- trunk/src/Freja.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/Freja.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,33 @@
+if (typeof(dojo) != &quot;undefined&quot;) {
+	dojo.provide(&quot;Freja&quot;);
+}
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja.NAME = &quot;Freja&quot;;
+Freja.VERSION = &quot;2.0.alpha&quot;;
+Freja.__repr__ = function () {
+	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
+};
+Freja.toString = function () {
+	return this.__repr__();
+};
+/**
+  * Single-hierarchy inheritance (class emulation)
+  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
+  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
+  */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
\ No newline at end of file

Added: trunk/src/Model.js
===================================================================
--- trunk/src/Model.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/Model.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,126 @@
+/**
+  * Standard model component
+  */
+Freja.Model = function(url, query) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._query = query;
+	Freja._aux.registerSignals(this, [&quot;onload&quot;]);
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.getElementById = function(id) {
+	if (this.document) {
+		return this._query.getElementById(this.document, id);
+	}
+	return null;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.get = function(expression) {
+	if (this.document) {
+		return this._query.get(this.document, expression);
+	}
+	return null;
+};
+/**
+  * Updates a value
+  */
+Freja.Model.prototype.set = function(expression, value) {
+	if (this.document) {
+		return this._query.set(this.document, expression, value);
+	}
+	return null;
+};
+/**
+  * Updates the model from a view
+  */
+Freja.Model.prototype.updateFrom = function(view) {
+	var values = view.getValues();
+	for (var i = 0; i &lt; values[0].length; ++i) {
+		this.set(values[0][i], values[1][i]);
+	}
+};
+/**
+  * Writes the model back to the remote service
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.Model.prototype.save = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	// since the serialization may fail, we create a deferred for the
+	// purpose, rather than just returning the sendXMLHttpRequest directly.
+	var d = Freja._aux.createDeferred();
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, url);
+	try {
+		// for some obscure reason exceptions aren't thrown back if I call the
+		// shorthand version of sendXMLHttpRequest in IE6.
+		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Deletes the model from the remote service
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.Model.prototype.remove = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;, url);
+	return Freja._aux.sendXMLHttpRequest(req);
+};
+/**
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.Model.prototype.reload = function() {
+	this.ready = false;
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, this);
+	var d = Freja.AssetManager.loadAsset(this.url, true);
+	d.addCallbacks(onload, Freja.AssetManager.onerror);
+	return d;
+};
+/**
+  * DataSource provides a gateway-type interface to a REST service.
+  */
+Freja.Model.DataSource = function(createURL, indexURL) {
+	this.createURL = createURL;
+	this.indexURL = indexURL;
+};
+/**
+  * Returns a list of primary-keys to records in the datasource
+  */
+Freja.Model.DataSource.prototype.select = function() {
+	return getModel(this.indexURL);
+};
+/**
+  * Creates a new instance of a record
+  * @todo errback to the deferred on errors
+  */
+Freja.Model.DataSource.prototype.create = function(values) {
+	var url = this.createURL;
+	var match = /^(file:\/\/.*\/)([^/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;, url);
+	var payload = {};
+	for (var i = 0, len = values[0].length; i &lt; len; ++i) {
+		payload[values[0][i]] = values[1][i];
+	}
+	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
+};

Added: trunk/src/QueryEngine.js
===================================================================
--- trunk/src/QueryEngine.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/QueryEngine.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,79 @@
+/**
+  * The baseclass for queryengines
+  * @abstract
+  */
+Freja.QueryEngine = function() {};
+Freja.QueryEngine.prototype.getElementById = function(document, id) {
+	// getElementById doesn't work on XML document without xml:id
+	var allElements = document.getElementsByTagName(&quot;*&quot;);
+	for (var i= 0; i &lt; allElements.length; i++) {
+		if (allElements[i].getAttribute(&quot;id&quot;) == id) {
+			return allElements[i];
+		}
+	}
+};
+Freja.QueryEngine.prototype.get = function(document, expression) {
+	return this._find(document, expression).nodeValue;
+};
+Freja.QueryEngine.prototype.set = function(document, expression, value) {
+	this._find(document, expression).nodeValue = value;
+};
+/**
+  * XPath query engine.
+  */
+Freja.QueryEngine.XPath = function() {};
+Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
+	var node = document.selectSingleNode(expression);
+	if (node &amp;&amp; node.nodeType == 2) {
+		return node;
+	} else if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	} else if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+	throw new Error(&quot;Can't evaluate expression &quot; + expression);
+};
+/**
+  * SimplePath
+  */
+Freja.QueryEngine.SimplePath = function() {};
+Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	if (!expression.match(/^[\d\w\/@\[\]]*$/)) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	var parts = expression.split(/\//);
+	var node = document;
+	var regAttr = new RegExp(&quot;^@([\\d\\w]*)&quot;);
+	var regOffset = new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
+	var attr = null;
+	var offset = 0;
+	for (var i = 0; i &lt; parts.length; ++i) {
+		var part = parts[i];
+		offset = regOffset.exec(part);
+		if (offset) {
+			part = offset[1];
+			offset = offset[2] - 1;
+		} else {
+			offset = 0;
+		}
+		if (part != &quot;&quot;) {
+			attr = regAttr.exec(part);
+			if (attr) {
+				node = node.getAttributeNode(attr[1]);
+			} else {
+				node = node.getElementsByTagName(part).item(offset);
+			}
+		}
+	}
+	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	} else if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+	if (!node) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	return node;
+};
\ No newline at end of file

Added: trunk/src/UndoHistory.js
===================================================================
--- trunk/src/UndoHistory.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/UndoHistory.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,85 @@
+/**
+  * This is largely s copied with minor stylistic adjustments from Freja 1.1
+  * I renamed it from Controller.history to distinguish between window.history
+  */
+Freja.UndoHistory = function() {
+	this.cache = [];
+	this.maxLength = 5;
+	this._position = 0;
+	this._undoSteps = 0;
+};
+/**
+  * Creates a snapshot of the model and stores it.
+  */
+Freja.UndoHistory.prototype.add = function(model) {
+	var historyIndex = this._position % this.maxLength;
+
+	var modelDoc = model.document;
+	this.cache[historyIndex] = {};
+	this.cache[historyIndex].model = model;
+	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
+
+	if (!this.cache[historyIndex].document) {
+		throw new Error(&quot;Couldn't add to history.&quot;);
+	} else {
+		this._position++;
+		// clear rest of the history if undo was used.
+		var clearHistoryIndex = historyIndex;
+		while (this._undoSteps &gt; 0) {
+			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
+			this.cache[clearHistoryIndex] = {};
+			this._undoSteps--;
+		}
+		return historyIndex; // what would anybody need this for ?
+	}
+};
+/**
+  * Rolls the state back one step.
+  */
+Freja.UndoHistory.prototype.undo = function(steps) {
+	if (this._undoSteps &lt; this.cache.length) {
+		this._undoSteps++;
+		this._position--;
+		if (this._position &lt; 0) {
+			this._position = this.maxLength - 1;
+		}
+
+		var model = this.cache[this._position].model;
+		if (this.cache[this._position].document) {
+			model.document = this.cache[this._position].document;
+		} else {
+			throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
+		}
+		if (typeof(steps) != &quot;undefined&quot; &amp;&amp; steps &gt; 1) {
+			this.undo(steps - 1);
+		}
+	} else {
+		throw new Error(&quot;Nothing to undo&quot;);
+	}
+};
+/**
+  * Reverts the effects of undo.
+  */
+Freja.UndoHistory.prototype.redo = function() {
+	if (this._undoSteps &gt; 0) {
+		this._undoSteps--;
+		this._position = (this._position + 1) % this.maxLength;
+
+		var model = this.cache[this._position].model;
+		model.document = this.cache[this._position].document;
+	} else {
+		throw new Error(&quot;Nothing to redo&quot;);
+	}
+};
+/**
+  * Removes the last entry in the cache
+  */
+Freja.UndoHistory.prototype.removeLast = function() {
+	this._position--;
+
+	if (this._position &lt; 0) {
+		this._position = this.maxLength - 1;
+	}
+	this.cache[this._position] = {};
+	this._undoSteps = 0;
+};

Added: trunk/src/View.js
===================================================================
--- trunk/src/View.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/View.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,195 @@
+/**
+  * Standard view component
+  */
+Freja.View = function(url, renderer) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._renderer = renderer;
+	this._destination = null;
+	this.handlers = [];
+	this.placeholder = null;
+	Freja._aux.registerSignals(this, [&quot;onload&quot;,&quot;onrendercomplete&quot;]);
+	Freja._aux.connect(this, &quot;onrendercomplete&quot;, Freja._aux.bind(this._connectBehaviour, this));
+};
+/**
+  * @param    model            Freja.Model
+  * @param    placeholder      string    If supplied, this will be used instead of the
+  *                                      default placeholder.
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.View.prototype.render = function(model, placeholder) {
+	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
+
+	var Handler = function(model, view, deferred) {
+		this.model = model;
+		this.view = view;
+		this.deferred = deferred;
+	};
+
+	Handler.prototype.trigger = function() {
+		try {
+			if (!this.view.ready) {
+				Freja._aux.connect(this.view, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			if (typeof(this.model) == &quot;object&quot; &amp;&amp; this.model instanceof Freja.Model &amp;&amp; !this.model.ready) {
+				Freja._aux.connect(this.model, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			var model;
+			if (typeof(this.model) == &quot;undefined&quot;) {
+				// supply dummy
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
+			} else if (this.model instanceof Freja.Model) {
+				model = this.model;
+			} else {
+				// wrap pojo's in
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot; + Freja._aux.xmlize(this.model, &quot;item&quot;)) };
+			}
+			var trans = this.view._renderer.transform(model, this.view);
+			trans.addCallback(Freja._aux.bind(function(html) {
+				this._destination.innerHTML = html;
+			}, this.view));
+			trans.addCallback(Freja._aux.bind(function() {
+				Freja._aux.signal(this, &quot;onrendercomplete&quot;, this._destination)
+			}, this.view));
+			trans.addCallback(this.deferred.callback);
+			trans.addErrback(this.deferred.errback);
+		} catch (ex) {
+			this.deferred.errback(ex);
+		}
+	};
+
+	var d = Freja._aux.createDeferred();
+	try {
+		this._destination = Freja._aux.getElement(placeholder);
+		// @todo    Is this a good idea ?
+		// Perhaps we should leave it to the programmer to do this.
+		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
+
+		var h = new Handler(model, this, d);
+		h.trigger();
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Decorates the output of the primary renderer, to inject behaviour.
+  * @note Maybe we could use cssQuery (<A HREF="http://dean.edwards.name/my/cssQuery/">http://dean.edwards.name/my/cssQuery/</A>)
+  *       to identify targets for behaviour, rather than just the id-attribute.
+  */
+Freja.View.prototype._connectBehaviour = function(destination) {
+	try {
+		var connectCallback = function(node, eventType, callback) {
+			Freja._aux.connect(node, eventType, Freja._aux.bind(
+				function(e) {
+					var allow = false;
+					try {
+						allow = callback(this);
+					} catch (ex) {
+						throw new Error(&quot;An error ocurred in user handler.\n&quot; + ex.message);
+					} finally {
+						if (!allow) {
+							e.stop();
+						}
+					}
+				}, node)
+			);
+		};
+		var applyHandlers = function(node, handlers) {
+			for (var i = 0, c = node.childNodes, l = c.length; i &lt; l; ++i) {
+				var child = c[i];
+				if (child.nodeType == 1) {
+					var id = child.getAttribute(&quot;handler&quot;);
+					if (id != &quot;&quot;) {
+						var handler = handlers[id];
+						if (handler) {
+							for (var eventType in handler) {
+								if (eventType == &quot;init&quot;) {
+									handler.init(child);
+								} else {
+									connectCallback(child, eventType, handler[eventType]);
+								}
+							}
+						}
+					}
+					applyHandlers(child, handlers);
+				}
+			}
+		};
+		applyHandlers(destination, this.handlers);
+	} catch (ex) {
+		alert(ex.message);
+	}
+};
+/**
+  * Returns the values of a formview
+  */
+Freja.View.prototype.getValues = function() {
+	return formContents(this._destination);
+};
+/**
+  * Base object for viewrenderers
+  */
+Freja.View.Renderer = function() {};
+/**
+  * XSLT based render-engine
+  */
+Freja.View.Renderer.XSLTransformer = function() {};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
+/**
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view) {
+        var d = Freja._aux.createDeferred();
+        try {
+		var html = Freja._aux.transformXSL(model.document, view.document);
+		if (!html) {
+			d.errback(new Error(&quot;XSL Transformation error.&quot;));
+		} else {
+			// fix empty textareas
+			// Can't this be fixed by outputting as html rather than xml ?
+			// &lt;xsl:output method=&quot;html&quot; /&gt;
+			html = html.replace(/&lt;textarea([^\/&gt;]*)\/&gt;/gi,&quot;&lt;textarea $1&gt;&lt;/textarea&gt;&quot;);
+			d.callback(html);
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * XSLT on a remote service for browser which have no native support.
+  * @param    url    URL of the transform service
+  */
+Freja.View.Renderer.RemoteXSLTransformer = function(url) {
+	this.url = url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
+/**
+  * @returns MochiKit.Async.Deferred
+  */
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view) {
+        var d = Freja._aux.createDeferred();
+
+	// prepare posted data  (no need to send the XSL document, just its url)
+	var xslUrl = view.url;
+	var postedData = &quot;xslFile=&quot; + encodeURIComponent(xslUrl) + &quot;&amp;xmlData=&quot; + encodeURIComponent(Freja._aux.serializeXML(model.document));
+//	if (xslParams)
+//		postedData  = postedData + &quot;&amp;xslParam=&quot; + encodeURIComponent(xslParams.toString());
+	// send request to the server-side XSL transformation service
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, Freja.AssetManager.XSLT_SERVICE_URL);
+	req.onreadystatechange = function() {
+		if (req.readyState == 4) {
+			if (req.status == 200) {
+				d.callback(req.responseText);
+			} else {
+				d.errback(req.responseText);
+			}
+		}
+	}
+	req.send(postedData);
+	return d;
+};
\ No newline at end of file

Added: trunk/src/auxiliary/default.js
===================================================================
--- trunk/src/auxiliary/default.js	2006-03-31 05:58:46 UTC (rev 19)
+++ trunk/src/auxiliary/default.js	2006-03-31 07:14:29 UTC (rev 20)
@@ -0,0 +1,132 @@
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
+  *
+  * You shouldn't rely on this functionality - it's merely a hook for Freja towards
+  * external dependencies. This is the only part of the application you'll need to
+  * adjust, to make Freja play ball with your favourite framework.
+  */
+if (typeof(dojo) != &quot;undefined&quot;) {
+	dojo.require(&quot;MochiKit.Base&quot;);
+	dojo.require(&quot;MochiKit.Signal&quot;);
+	dojo.require(&quot;MochiKit.Async&quot;);
+	dojo.require(&quot;Sarissa&quot;);
+}
+if (typeof(JSAN) != &quot;undefined&quot;) {
+	JSAN.use(&quot;MochiKit.Base&quot;, []);
+	JSAN.use(&quot;MochiKit.Signal&quot;, []);
+	JSAN.use(&quot;MochiKit.Async&quot;, []);
+	JSAN.use(&quot;Sarissa&quot;, []);
+}
+try {
+	if (typeof(MochiKit.Base) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(MochiKit.Signal) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(MochiKit.Async) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(Sarissa) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+} catch (e) {
+	throw new Error(&quot;Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!&quot;);
+}
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self[, arg, ...]) : function */
+Freja._aux.bind = MochiKit.Base.bind;
+/** formContents(elem) : Array */
+Freja._aux.formContents = MochiKit.DOM.formContents;
+/** getElement() : HTMLElement */
+Freja._aux.getElement = MochiKit.DOM.getElement;
+
+/** registerSignals(src, signals) : void */
+Freja._aux.registerSignals = MochiKit.Signal.registerSignals;
+/** connect(src, signal, dest[, func]) : void */
+Freja._aux.connect = MochiKit.Signal.connect;
+/** signal(src, signal, ...) : void */
+Freja._aux.signal = MochiKit.Signal.signal;
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new MochiKit.Async.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user &amp;&amp; pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
+		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+	}
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = MochiKit.Async.sendXMLHttpRequest;
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = Sarissa.serialize;
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	return Freja._aux.serializeXML(processor.transformToDocument(xml));
+
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+
+	// Can't clone a DocumentNode in Safari &amp; Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation &amp;&amp; document.implementation.createDocument) {
+			clone = document.implementation.createDocument(&quot;&quot;, xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+				for (var i = data.childNodes.length; i &gt;= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				// need to copy root node attributes
+				for (var i = 0; i &lt; xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}
+			}
+		}
+	}
+	return clone;
+};
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000015.html">[Freja-svn] r19 - in trunk: lib tests
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16">[ date ]</a>
              <a href="thread.html#16">[ thread ]</a>
              <a href="subject.html#16">[ subject ]</a>
              <a href="author.html#16">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/freja-svn">More information about the Freja-svn
mailing list</a><br>
</body></html>
