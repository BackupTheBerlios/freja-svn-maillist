From cedsav at mail.berlios.de  Thu Jan 25 06:39:13 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 25 Jan 2007 06:39:13 +0100
Subject: [Freja-svn] r69 - /
Message-ID: <200701250539.l0P5dDvF000489@sheep.berlios.de>

Author: cedsav
Date: 2007-01-25 06:39:01 +0100 (Thu, 25 Jan 2007)
New Revision: 69

Added:
   branch/
Log:
Created folder remotely



From cedsav at mail.berlios.de  Thu Jan 25 06:40:43 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 25 Jan 2007 06:40:43 +0100
Subject: [Freja-svn] r70 - branch
Message-ID: <200701250540.l0P5ehdg002398@sheep.berlios.de>

Author: cedsav
Date: 2007-01-25 06:40:29 +0100 (Thu, 25 Jan 2007)
New Revision: 70

Added:
   branch/2.0.1_dev/
Log:
Development branch for 2.0.1 fixes



From cedsav at mail.berlios.de  Thu Jan 25 06:41:26 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 25 Jan 2007 06:41:26 +0100
Subject: [Freja-svn] r71 - branch
Message-ID: <200701250541.l0P5fQ9I003787@sheep.berlios.de>

Author: cedsav
Date: 2007-01-25 06:41:19 +0100 (Thu, 25 Jan 2007)
New Revision: 71

Added:
   branch/2.0.1/
Log:
made a copy

Copied: branch/2.0.1 (from rev 70, trunk)



From cedsav at mail.berlios.de  Thu Jan 25 06:44:33 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 25 Jan 2007 06:44:33 +0100
Subject: [Freja-svn] r72 - in branch/2.0.1/src: . auxiliary
Message-ID: <200701250544.l0P5iX2i006387@sheep.berlios.de>

Author: cedsav
Date: 2007-01-25 06:44:24 +0100 (Thu, 25 Jan 2007)
New Revision: 72

Modified:
   branch/2.0.1/src/Freja.js
   branch/2.0.1/src/View.js
   branch/2.0.1/src/auxiliary/minimal.js
   branch/2.0.1/src/auxiliary/mochi+sarissa.js
Log:
Opera 9 Fix + remove serialization step in view rendering (not working yet)

Modified: branch/2.0.1/src/Freja.js
===================================================================
--- branch/2.0.1/src/Freja.js	2007-01-25 05:41:19 UTC (rev 71)
+++ branch/2.0.1/src/Freja.js	2007-01-25 05:44:24 UTC (rev 72)
@@ -5,7 +5,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.0.alpha";
+Freja.VERSION = "2.0";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };

Modified: branch/2.0.1/src/View.js
===================================================================
--- branch/2.0.1/src/View.js	2007-01-25 05:41:19 UTC (rev 71)
+++ branch/2.0.1/src/View.js	2007-01-25 05:44:24 UTC (rev 72)
@@ -50,7 +50,9 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
+				// this._destination.innerHTML = html;
+				this._destination.innerHTML = "";
+				this._destination.appendChild(html);
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
@@ -157,8 +159,9 @@
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!html) {
+		// var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		var dom = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!dom) {
 			d.errback(new Error("XSL Transformation error."));
 		} else {
 			// fix empty textareas
@@ -167,8 +170,10 @@
 			// (cedsav) don't remember all the details but method="xml" is the way to go.
 			// method="html" would output html not xhtml, plus I think it implies that
 			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
-			d.callback(html);
+			
+			// html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
+			
+			d.callback(dom);
 		}
 	} catch (ex) {
 		d.errback(ex);

Modified: branch/2.0.1/src/auxiliary/minimal.js
===================================================================
--- branch/2.0.1/src/auxiliary/minimal.js	2007-01-25 05:41:19 UTC (rev 71)
+++ branch/2.0.1/src/auxiliary/minimal.js	2007-01-25 05:44:24 UTC (rev 72)
@@ -247,7 +247,8 @@
 	for (var paramName in xslParameters) {
 		processor.setParameter(null, paramName, xslParameters[paramName]);
 	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	return processor.transformToDocument(xml);
 
 };
 /** cloneXMLDocument(document) : XMLDocument */
@@ -382,7 +383,10 @@
 		}
 	};
 };
-
+// Opera 9 XMLDocument Fix. Thanks to Chris D.
+if(!XMLDocument) {
+   var XMLDocument = Document;
+}
 // Adapated From Sarissa
 // * @version 0.9.6.1
 // * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
@@ -444,4 +448,3 @@
 	};
 
 }
-

Modified: branch/2.0.1/src/auxiliary/mochi+sarissa.js
===================================================================
--- branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-25 05:41:19 UTC (rev 71)
+++ branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-25 05:44:24 UTC (rev 72)
@@ -82,8 +82,8 @@
 Freja._aux.transformXSL = function(xml, xsl) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	return processor.transformToDocument(xml);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -118,6 +118,10 @@
 	}
 	return clone;
 };
+/**  Opera 9 XMLDocument Fix. Thanks to Chris D.  */
+if(!XMLDocument) {
+   var XMLDocument = Document;
+}
 /** hasSupportForXSLT() : boolean */
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */



From cedsav at mail.berlios.de  Thu Jan 25 23:10:09 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 25 Jan 2007 23:10:09 +0100
Subject: [Freja-svn] r73 - in branch/2.0.1: examples/tutorial
	examples/tutorial/views lib src src/auxiliary tests
Message-ID: <200701252210.l0PMA9TG014479@sheep.berlios.de>

Author: cedsav
Date: 2007-01-25 23:09:26 +0100 (Thu, 25 Jan 2007)
New Revision: 73

Removed:
   branch/2.0.1/examples/tutorial/example2.html
   branch/2.0.1/examples/tutorial/example2.js
Modified:
   branch/2.0.1/examples/tutorial/example.js
   branch/2.0.1/examples/tutorial/views/edit.xsl
   branch/2.0.1/lib/Freja.js
   branch/2.0.1/lib/Sarissa.js
   branch/2.0.1/src/Model.js
   branch/2.0.1/src/QueryEngine.js
   branch/2.0.1/src/View.js
   branch/2.0.1/src/auxiliary/minimal.js
   branch/2.0.1/src/auxiliary/mochi+sarissa.js
   branch/2.0.1/tests/test_Model.js
Log:
Upgraded to Sarissa 0.9.7.6. (minimal build not yet working)
Fixed bugs #008331 and #008915
Fixed bug with undoHistory in Opera
Fixed tutorial example

Modified: branch/2.0.1/examples/tutorial/example.js
===================================================================
--- branch/2.0.1/examples/tutorial/example.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/examples/tutorial/example.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -3,34 +3,23 @@
 var display = getView("views/display.xsl");
 display.placeholder = 'content';
 display.behaviors["editLink"] = {
-	onclick : function() { dispatch('edit'); }
+	onclick : function() { edit.render(data); }
 };
 
 var edit = getView("views/edit.xsl");
 edit.placeholder = 'content';
 edit.behaviors["editForm"] = {
-	onsubmit : function() { dispatch('update'); }
+	onsubmit : function() { 
+		data.updateFrom(edit);
+		display.render(data);
+		return false;
+	}
 };
 edit.behaviors["displayLink"] = {
-	onclick : function() { dispatch('display'); }
+	onclick : function() { display.render(data); }
 };
 
-dispatch = function(action) {
-	switch (action) {
-		default:
-			// fall through to case 'display'
-		case 'display':
-			display.render(data)
-			break;
-		case 'edit':
-			edit.render(data);
-			break;
-		case 'update':
-			data.updateFrom(edit);
-			dispatch('display');
-		break;
-	}
-}
+
 connect(window, "onload", function() {
-	dispatch("display");
+	display.render(data);
 });
\ No newline at end of file

Deleted: branch/2.0.1/examples/tutorial/example2.html
===================================================================
--- branch/2.0.1/examples/tutorial/example2.html	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/examples/tutorial/example2.html	2007-01-25 22:09:26 UTC (rev 73)
@@ -1,19 +0,0 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml">
-<head>
-<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
-<title>Freja Example 2</title>
-
-<!-- Freja Framework Script -->
-<script type="text/javascript" src="../../lib/MochiKit.js"></script>
-<script type="text/javascript" src="../../lib/Sarissa.js"></script>
-<script type="text/javascript" src="../../lib/Freja.js"></script>
-
-<!-- Controller Code -->
-<script type="text/javascript" src="example2.js"></script>
-</head>
-
-<body>
-<div id="content"><span style="color:white;background:firebrick">Loading ...</span></div>
-</body>
-</html>

Deleted: branch/2.0.1/examples/tutorial/example2.js
===================================================================
--- branch/2.0.1/examples/tutorial/example2.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/examples/tutorial/example2.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -1,31 +0,0 @@
-var data = getModel("models/data.xml");
-
-var display = getView("views/display.xsl");
-display.placeholder = "content";
-display.behaviors["editLink"] = {
-	onclick : function() {
-		edit.render(data);
-	}
-};
-
-var edit = getView("views/edit.xsl");
-edit.placeholder = "content";
-edit.behaviors["editForm"] = {
-	onsubmit : function() {
-		try {
-			data.updateFrom(edit);
-			display.render(data);
-		} catch (ex) {
-			alert(ex.message);
-		}
-	}
-};
-edit.behaviors["displayLink"] = {
-	onclick : function() {
-		display.render(data);
-	}
-};
-
-connect(window, "onload", function() {
-	display.render(data);
-});
\ No newline at end of file

Modified: branch/2.0.1/examples/tutorial/views/edit.xsl
===================================================================
--- branch/2.0.1/examples/tutorial/views/edit.xsl	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/examples/tutorial/views/edit.xsl	2007-01-25 22:09:26 UTC (rev 73)
@@ -3,7 +3,7 @@
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
 
 <xsl:template match="item">	
-	<form method="post" action="#" freja-behaviour="editForm">
+	<form method="post" action="#" class="editForm">
 		<h3><input name="item/name" type="text" value="{name}" /></h3>
 		<p><textarea name="item/description"><xsl:value-of select="description" /></textarea></p>
 		<p><input name="item/price" type="text" value="{price}" /></p>

Modified: branch/2.0.1/lib/Freja.js
===================================================================
--- branch/2.0.1/lib/Freja.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/lib/Freja.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -1,10 +1,10 @@
 /***
 
-    Freja 2.0.alpha
+    Freja 2.0
 
-    Build $Fri, 28 Jul 2006 13:38:48 UTC$
+    Build $Thu, 25 Jan 2007 22:01:11 UTC$
 
-    Target: minimal
+    Target: mochi+sarissa
 
     THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
     diff against the source tree, not this file.
@@ -21,7 +21,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.0.alpha";
+Freja.VERSION = "2.0";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };
@@ -51,154 +51,62 @@
   * Freja._aux
   * wrapper for external dependencies (frameworks).
   *
-  * This is the minimal auxiliary adapter. It contains self-sufficient
-  * implementations of all dependencies.
+  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
   *
+  * You shouldn't rely on this functionality - it's merely a hook for Freja towards
+  * external dependencies. This is the only part of the application you'll need to
+  * adjust, to make Freja play ball with your favourite framework.
   */
+if (typeof(dojo) != "undefined") {
+	dojo.require("MochiKit.Base");
+	dojo.require("MochiKit.Signal");
+	dojo.require("MochiKit.Async");
+	dojo.require("Sarissa");
+}
+if (typeof(JSAN) != "undefined") {
+	JSAN.use("MochiKit.Base", []);
+	JSAN.use("MochiKit.Signal", []);
+	JSAN.use("MochiKit.Async", []);
+	JSAN.use("Sarissa", []);
+}
+try {
+	if (typeof(MochiKit.Base) == "undefined") {
+		throw "";
+	}
+	if (typeof(MochiKit.Signal) == "undefined") {
+		throw "";
+	}
+	if (typeof(MochiKit.Async) == "undefined") {
+		throw "";
+	}
+	if (typeof(Sarissa) == "undefined") {
+		throw "";
+	}
+} catch (e) {
+	throw new Error("Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!");
+}
 if (typeof(Freja) == "undefined") {
 	Freja = {};
 }
 Freja._aux = {};
 /** bind(func, self) : function */
-// from http://blog.ianbicking.org/prototype-and-object-prototype.html
-Freja._aux.bind = function(func, self) {
-	if(typeof (func)=="string"){
-		func=self[func];
-	}
-
-	var im_func = null;
-    if (typeof(func.im_func) == 'function') {
-        im_func = func.im_func;
-    } else {
-        im_func = func;
-    }
-    func = function () {
-        return func.im_func.apply(func.im_self, arguments);
-    }
-    func.im_func = im_func;
-    func.im_self = self;
-	return func;
-
-};
+Freja._aux.bind = MochiKit.Base.bind;
 /** formContents(elem) : Array */
-Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
-	var names = [];
-	var values = [];
-	var inputs = elem.getElementsByTagName("INPUT");
-	for (var i = 0; i < inputs.length; ++i) {
-		var input = inputs[i];
-		if (input.name) {
-			if (input.type == "radio" || input.type == "checkbox") {
-				if (input.checked) {
-					names.push(input.name);
-					values.push(input.value);
-				} else {
-					names.push(input.name);
-					values.push("");
-				}
-			} else {
-				names.push(input.name);
-				values.push(input.value);
-			}
-		}
-	}
-	var textareas = elem.getElementsByTagName("TEXTAREA");
-	for (var i = 0; i < textareas.length; ++i) {
-		var input = textareas[i];
-		if (input.name) {
-			names.push(input.name);
-			values.push(input.value);
-		}
-	}
-	var selects = elem.getElementsByTagName("SELECT");
-	for (var i = 0; i < selects.length; ++i) {
-		var input = selects[i];
-		if (input.name) {
-			if (input.selectedIndex >= 0) {
-				var opt = input.options[input.selectedIndex];
-				names.push(input.name);
-				values.push((opt.value) ? opt.value : "");
-			}
-		}
-	}
-	return [names, values];
-};
+Freja._aux.formContents = MochiKit.DOM.formContents;
 /** getElement(id) : HTMLElement */
-Freja._aux.getElement = function(id) {
-	if (typeof(id) == "object") {
-		return id;
-	} else {
-		return document.getElementById(id);
-	}
-};
+Freja._aux.getElement = MochiKit.DOM.getElement;
 
 /** connect(src, signal, fnc) : void */
-Freja._aux.connect = function(src, signal, fnc) {
-
-	if(!src) return;
-	if (src.addEventListener) {
-		var wrapper = function(e) {
-			var evt = {
-				stop : function() {
-					if (e.cancelable) {
-						e.preventDefault();
-					}
-					e.stopPropagation();
-				}
-			}
-			fnc(evt);
-		}
-		src.addEventListener(signal.replace(/^(on)/, ""), wrapper, false);
-	} else if (src.attachEvent) {
-		var wrapper = function() {
-			var e = window.event;
-			var evt = {
-				stop : function() {
-					e.cancelBubble = true;
-					e.returnValue = false;
-				}
-			}
-			fnc(evt);
-		}
-		src.attachEvent(signal, wrapper);
-	}
-	if (!src._signals) {
-		src._signals = [];
-	}
-	if (!src._signals[signal]) {
-		src._signals[signal] = [];
-	}
-	src._signals[signal].push(fnc);
-};
-/** signal(src, signal, ...) : void */
-Freja._aux.signal = function(src, signal) {
-
-	try {
-		var sigs = src._signals[signal];
-		var args = [];
-		for (var i=2; i < arguments.length; i++) {
-			args.push(arguments[i]);
-		}
-		for (var i=0; i < sigs.length; i++) {
-			try {
-				sigs[i].apply(src, args);
-			} catch (e) { /* squelch */ }
-		}
-	} catch (e) { /* squelch */ }
-};
+Freja._aux.connect = MochiKit.Signal.connect;
+/** signal(src, signal, arg) : void */
+Freja._aux.signal = MochiKit.Signal.signal;
 /** createDeferred() : Deferred */
 Freja._aux.createDeferred = function() {
-	return new Freja._aux.Deferred();
+	return new MochiKit.Async.Deferred();
 };
 /** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
 Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject("Msxml2.XMLHTTP"); }
-	catch (e) { try { req = new ActiveXObject("Microsoft.XMLHTTP"); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error("Can't create XMLHttpRequest");
+	var req = new XMLHttpRequest();
 	if (user && pass) {
 		req.open(method, url, async, user, pass);
 	} else {
@@ -210,94 +118,21 @@
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
-Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
-	var d = Freja._aux.createDeferred();
-	var bComplete = false;
-	req.onreadystatechange = function() {
-		if (req.readyState == 4 && !bComplete) {
-			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
-				d.callback(req);
-			} else {
-				d.errback(req);
-			}
-			bComplete = true;
-		}
-	}
-	if (!sendContent) sendContent = "";
-	req.send(sendContent);
-	return d;
-};
+Freja._aux.sendXMLHttpRequest = MochiKit.Async.sendXMLHttpRequest;
 /** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&/g, "&amp;")
-			.replace(/</g, "&lt;")
-			.replace(/>/g, "&gt;")
-			.replace(/"/g, "&quot;")
-			.replace(/'/g, "&apos;");
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '<' + objectName + '>';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(""+anyObject);
-		isLeaf = true;
-	} else {
-		s += "\n";
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? "array-item key=\""+name+"\"" : name), indentSpace + "   ");
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? "</array-item>\n":"</" + objectName + ">\n");
-};
+Freja._aux.xmlize = Sarissa.xmlize;
 /** serializeXML(node) : string */
-Freja._aux.serializeXML = function(node) {
-	if (node.xml) return node.xml;
-	return (new XMLSerializer()).serializeToString(node);
-};
+Freja._aux.serializeXML = Sarissa.serialize;
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject("Msxml2.DOMDocument");
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty("SelectionLanguage", "XPath");
-		return xmlDoc;
-	}
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != "undefined") {
-		// set the parameters
-		for (var paramName in xslParameters) {
-			xsl.setProperty ("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
-		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
+Freja._aux.transformXSL = function(xml, xsl) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
-	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -305,7 +140,7 @@
 	try {
 		clone = xmlDoc.cloneNode(true);
 	} catch(e) { /* squelch */ }
-
+	
 	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
 	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
 	if (!clone) {
@@ -315,185 +150,240 @@
 			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
 			try {
 				clone.appendChild(data);
-			} catch(e) {
+			} catch(e) {				
 				// Opera has already created a documentElement and can't append another root node
 				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i >= 0; i--) {
+			
+				for (var i = data.childNodes.length-1; i >= 0; i--) {
 					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
 				}
+				
 				// need to copy root node attributes
 				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
 					var name  = xmlDoc.documentElement.attributes.item(i).name;
 					var value = xmlDoc.documentElement.attributes.item(i).value;
 					clone.documentElement.setAttribute(name, value);
-				}
+				}				
 			}
 		}
 	}
+	
 	return clone;
 };
+
 /** hasSupportForXSLT() : boolean */
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */
 Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation && document.implementation.hasFeature("XPath", "3.0"))) {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
 		return new Freja.QueryEngine.XPath();
 	} else {
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
-/** A pale replacement for MochiKit.Async.Deferred */
-Freja._aux.Deferred = function() {
-	this._good = [];
-	this._bad = [];
-	this._pending = null;
-};
-Freja._aux.Deferred.prototype.callback = function() {
-	if (this._good.length == 0) {
-		this._pending = [this.callback, arguments];
-		return;
-	}
-	for (var i=0; i < this._good.length; i++) {
-		this._good[i].apply(window, arguments);
-	}
-	this._good = [];
-};
-Freja._aux.Deferred.prototype.errback = function() {
-	if (this._bad.length == 0) {
-		this._pending = [this.errback, arguments];
-		return;
-	}
-	for (var i=0; i < this._bad.length; i++) {
-		this._bad[i].apply(window, arguments);
-	}
-	this._bad = [];
-};
-Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
-	if (fncOK) this._good[this._good.length] = fncOK;
-	if (fncError) this._bad[this._bad.length] = fncError;
-	if (this._pending) {
-		this._pending[0].apply(this, this._pending[1]);
-	}
-};
-Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
-	this.addCallbacks(fncOK);
-};
-Freja._aux.Deferred.prototype.addErrback = function(fncError) {
-	this.addCallbacks(null, fncError);
-};
-if (document.implementation && document.implementation.hasFeature("XPath", "3.0")) {
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
 
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error("Can't evaluate expression " + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i < 0 || i >= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i < nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = "("+sExpr+")[1]";
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length > 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		}
-	};
-};
 
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i < idList.length && !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
         };
     };
-    throw "Could not retrieve a valid progID.";
-}
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
 
-if(typeof XSLTProcessor == 'undefined' && typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[""+nsURI]){
-	        this.paramsSet[""+nsURI] = new Array();
-	    };
-	    this.paramsSet[""+nsURI][name] = value;
-	};
-
-}
-
 
 /**
   * The baseclass for queryengines
@@ -510,57 +400,79 @@
 	}
 };
 Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
-	}
-	if(node) return node.nodeValue;
+	
+	var node = this._find(document, expression);
 
+	if(!node) throw new Error("Can't evaluate expression " + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
+	}
+	return null;
 };
 Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
 			}
-			// else parent element does not exist.. can't do anything
+			// else parent node non existent either, give up.
 		}
+		// not an attribute, give up.
+		throw new Error("Can't evaluate expression " + expression);
 	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
 };
 /**
   * XPath query engine.
   */
 Freja.QueryEngine.XPath = function() {};
 Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node && node.nodeType == 2) {
-		return node;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error("Can't evaluate expression " + expression);
-	return null;
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
 };
 /**
   * SimplePath
@@ -568,6 +480,7 @@
 Freja.QueryEngine.SimplePath = function() {};
 Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
 Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
 	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
 		throw new Error("Can't evaluate expression " + expression);
 	}
@@ -670,7 +583,10 @@
 Freja.Model.prototype.updateFrom = function(view) {
 	var values = view.getValues();
 	for (var i = 0; i < values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
 	}
 };
 /**
@@ -806,7 +722,8 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
+				this._destination.innerHTML = "";
+				this._destination.appendChild(html);
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
@@ -913,8 +830,9 @@
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!html) {
+		// var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		var dom = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!dom) {
 			d.errback(new Error("XSL Transformation error."));
 		} else {
 			// fix empty textareas
@@ -923,8 +841,10 @@
 			// (cedsav) don't remember all the details but method="xml" is the way to go.
 			// method="html" would output html not xhtml, plus I think it implies that
 			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
-			d.callback(html);
+			
+			// html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
+			
+			d.callback(dom);
 		}
 	} catch (ex) {
 		d.errback(ex);

Modified: branch/2.0.1/lib/Sarissa.js
===================================================================
--- branch/2.0.1/lib/Sarissa.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/lib/Sarissa.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -1,75 +1,40 @@
 /**
-  * Package : begin
-  */
-if (typeof(dojo) != 'undefined') {
-	dojo.provide("Sarissa");
-}
-Sarissa = {};
-Sarissa.NAME = "Sarissa";
-Sarissa.VERSION = "0.9.6.1";
-Sarissa.__repr__ = function () {
-	return "[" + this.NAME + " " + this.VERSION + "]";
-};
-Sarissa.toString = function () {
-	return this.__repr__();
-};
-/**
-  * Package : end
-  */
-/**
  * ====================================================================
  * About
  * ====================================================================
  * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
  * The library supports Gecko based browsers like Mozilla and Firefox,
  * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
- * @version 0.9.6.1
+ * @version 0.9.7.6
  * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
  * ====================================================================
  * Licence
  * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit http://www.gnu.org
- *
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
  */
 /**
- * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument and
- * XMLHTTP objects, DOM Node serializatrion to XML strings and other goodies.</p>
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
  * @constructor
  */
-//function Sarissa(){};
-/** @private */
+function Sarissa(){};
 Sarissa.PARSED_OK = "Document contains no parsing errors";
-/**
- * Tells you whether transformNode and transformNodeToObject are available. This functionality
- * is contained in sarissa_ieemu_xslt.js and is deprecated. If you want to control XSLT transformations
- * use the XSLTProcessor
- * @deprecated
- * @type boolean
- */
-Sarissa.IS_ENABLED_TRANSFORM_NODE = false;
-/**
- * tells you whether XMLHttpRequest (or equivalent) is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_XMLHTTP = false;
-/**
- * tells you whether selectNodes/selectSingleNode is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_SELECT_NODES = false;
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
 var _sarissa_iNsCounter = 0;
 var _SARISSA_IEPREFIX4XSLPARAM = "";
 var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
@@ -78,10 +43,12 @@
 var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
 var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
 var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
-if(!window.Node || !window.Node.ELEMENT_NODE){
-    var Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
 };
 
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
 // IE initialization
 if(_SARISSA_IS_IE){
     // for XSLT parameter names, prefix needed by IE
@@ -89,13 +56,15 @@
     // used to store the most recent ProgID available out of the above
     var _SARISSA_DOM_PROGID = "";
     var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
     /**
      * Called when the Sarissa_xx.js file is parsed, to pick most recent
      * ProgIDs for IE, then gets destroyed.
+     * @private
      * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
      * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
      */
-    pickRecentProgID = function (idList, enabledList){
+    Sarissa.pickRecentProgID = function (idList){
         // found progID flag
         var bFound = false;
         for(var i=0; i < idList.length && !bFound; i++){
@@ -103,60 +72,82 @@
                 var oDoc = new ActiveXObject(idList[i]);
                 o2Store = idList[i];
                 bFound = true;
-                for(var j=0;j<enabledList.length;j++)
-                    if(i <= enabledList[j][1])
-                        Sarissa["IS_ENABLED_"+enabledList[j][0]] = true;
             }catch (objException){
                 // trap; try next progID
             };
         };
-        if (!bFound)
+        if (!bFound) {
             throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
         idList = null;
         return o2Store;
     };
     // pick best available MSXML progIDs
-    _SARISSA_DOM_PROGID = pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"], [["SELECT_NODES", 2],["TRANSFORM_NODE", 2]]);
-    _SARISSA_XMLHTTP_PROGID = pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"], [["XMLHTTP", 4]]);
-    _SARISSA_THREADEDDOM_PROGID = pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"], [["XSLTPROC", 2]]);
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
     // we dont need this anymore
-    pickRecentProgID = null;
     //============================================
     // Factory methods (IE)
     //============================================
     // see non-IE version
     Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
         var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        // if a root tag name was provided, we need to load it in the DOM
-        // object
+        // if a root tag name was provided, we need to load it in the DOM object
         if (sName){
-            // if needed, create an artifical namespace prefix the way Moz
-            // does
-            if (sUri){
-                oDoc.loadXML("<a" + _sarissa_iNsCounter + ":" + sName + " xmlns:a" + _sarissa_iNsCounter + "=\"" + sUri + "\" />");
-                // don't use the same prefix again
-                ++_sarissa_iNsCounter;
-            }
-            else
-                oDoc.loadXML("<" + sName + "/>");
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
         };
         return oDoc;
     };
-    // see non-IE version
+    // see non-IE version   
     Sarissa.getParseErrorText = function (oDoc) {
         var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc.parseError != 0){
-            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason +
-                "\nLocation: " + oDoc.parseError.url +
-                "\nLine Number " + oDoc.parseError.line + ", Column " +
-                oDoc.parseError.linepos +
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
                 ":\n" + oDoc.parseError.srcText +
                 "\n";
             for(var i = 0;  i < oDoc.parseError.linepos;i++){
                 parseErrorText += "-";
             };
             parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
         };
         return parseErrorText;
     };
@@ -164,41 +155,116 @@
     Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
         oDoc.setProperty("SelectionLanguage", "XPath");
         oDoc.setProperty("SelectionNamespaces", sNsSet);
-    };
+    };   
     /**
-     * Basic implementation of Mozilla's XSLTProcessor for IE.
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
      * Reuses the same XSLT stylesheet for multiple transforms
      * @constructor
      */
     XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
         this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
         this.processor = null;
     };
     /**
-     * Impoprts the given XSLT DOM and compiles it to a reusable transform
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
      * @argument xslDoc The XSLT DOMDocument to import
      */
     XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
         // convert stylesheet to free threaded
         var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-        converted.loadXML(xslDoc.xml);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
         this.template.stylesheet = converted;
         this.processor = this.template.createProcessor();
-        // (re)set default param values
+        // for getParameter and clearParameters
         this.paramsSet = new Array();
     };
+
     /**
-     * Transform the given XML DOM
+     * Transform the given XML DOM and return the transformation result as a new DOM document
      * @argument sourceDoc The XML DOMDocument to transform
      * @return The transformation result as a DOM Document
      */
     XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
         this.processor.input = sourceDoc;
-        var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        this.processor.output = outDoc;
         this.processor.transform();
-        return outDoc;
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
     };
+    
     /**
      * Set global XSLT parameter of the imported stylesheet
      * @argument nsURI The parameter namespace URI
@@ -206,13 +272,13 @@
      * @argument value The new parameter value
      */
     XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-        /* nsURI is optional but cannot be null */
+        // nsURI is optional but cannot be null 
         if(nsURI){
             this.processor.addParameter(name, value, nsURI);
         }else{
             this.processor.addParameter(name, value);
         };
-        /* update updated params for getParameter */
+        // update updated params for getParameter 
         if(!this.paramsSet[""+nsURI]){
             this.paramsSet[""+nsURI] = new Array();
         };
@@ -227,14 +293,28 @@
      */
     XSLTProcessor.prototype.getParameter = function(nsURI, name){
         nsURI = nsURI || "";
-        if(nsURI in this.paramsSet && name in this.paramsSet[nsURI]){
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
             return this.paramsSet[nsURI][name];
         }else{
             return null;
         };
     };
-}
-else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
     if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
         /**
          * <p>Ensures the document was loaded correctly, otherwise sets the
@@ -242,8 +322,6 @@
          * @private
          */
         Sarissa.__handleLoad__ = function(oDoc){
-            if (!oDoc.documentElement || oDoc.documentElement.tagName == "parsererror")
-                oDoc.parseError = -1;
             Sarissa.__setReadyState__(oDoc, 4);
         };
         /**
@@ -263,118 +341,57 @@
          */
         Sarissa.__setReadyState__ = function(oDoc, iReadyState){
             oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
             if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
                 oDoc.onreadystatechange();
         };
         Sarissa.getDomDocument = function(sUri, sName){
-            var oDoc = document.implementation.createDocument(sUri?sUri:"", sName?sName:"", null);
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
             oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
             return oDoc;
         };
         if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
             /**
-            * <p>Emulate IE's onreadystatechange attribute</p>
-            */
-            XMLDocument.prototype.onreadystatechange = null;
-            /**
-            * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
-            * <ul><li>1 == LOADING,</li>
-            * <li>2 == LOADED,</li>
-            * <li>3 == INTERACTIVE,</li>
-            * <li>4 == COMPLETED</li></ul>
-            */
-            XMLDocument.prototype.readyState = 0;
-            /**
-            * <p>Emulate IE's parseError attribute</p>
-            */
-            XMLDocument.prototype.parseError = 0;
-
-            // NOTE: setting async to false will only work with documents
-            // called over HTTP (meaning a server), not the local file system,
-            // unless you are using Moz 1.4+.
-            // BTW the try>catch block is for 1.4; I haven't found a way to check if
-            // the property is implemented without
-            // causing an error and I dont want to use user agent stuff for that...
-            var _SARISSA_SYNC_NON_IMPLEMENTED = false;// ("async" in XMLDocument.prototype) ? false: true;
-            /**
-            * <p>Keeps a handle to the original load() method. Internal use and only
-            * if Mozilla version is lower than 1.4</p>
-            * @private
-            */
-            XMLDocument.prototype._sarissa_load = XMLDocument.prototype.load;
-
-            /**
-            * <p>Overrides the original load method to provide synchronous loading for
-            * Mozilla versions prior to 1.4, using an XMLHttpRequest object (if
-            * async is set to false)</p>
-            * @returns the DOM Object as it was before the load() call (may be  empty)
-            */
-            XMLDocument.prototype.load = function(sURI) {
-                var oDoc = document.implementation.createDocument("", "", null);
-                Sarissa.copyChildNodes(this, oDoc);
-                this.parseError = 0;
-                Sarissa.__setReadyState__(this, 1);
-                try {
-                    if(this.async == false && _SARISSA_SYNC_NON_IMPLEMENTED) {
-                        var tmp = new XMLHttpRequest();
-                        tmp.open("GET", sURI, false);
-                        tmp.send(null);
-                        Sarissa.__setReadyState__(this, 2);
-                        Sarissa.copyChildNodes(tmp.responseXML, this);
-                        Sarissa.__setReadyState__(this, 3);
-                    }
-                    else {
-                        this._sarissa_load(sURI);
-                    };
-                }
-                catch (objException) {
-                    this.parseError = -1;
-                }
-                finally {
-                    if(this.async == false){
-                        Sarissa.__handleLoad__(this);
-                    };
-                };
-                return oDoc;
-            };
-
-
-        }//if(window.XMLDocument)
-        else if(document.implementation && document.implementation.hasFeature && document.implementation.hasFeature('LS', '3.0')){
-            Document.prototype.async = true;
-            Document.prototype.onreadystatechange = null;
-            Document.prototype.parseError = 0;
-            Document.prototype.load = function(sURI) {
-                var parser = document.implementation.createLSParser(this.async ? document.implementation.MODE_ASYNCHRONOUS : document.implementation.MODE_SYNCHRONOUS, null);
-                if(this.async){
-                    var self = this;
-                    parser.addEventListener("load",
-                        function(e) {
-                            self.readyState = 4;
-                            Sarissa.copyChildNodes(e.newDocument, self.documentElement, false);
-                            self.onreadystatechange.call();
-                        },
-                        false);
-                };
-                try {
-                    var oDoc = parser.parseURI(sURI);
-                }
-                catch(e){
-                    this.parseError = -1;
-                };
-                if(!this.async)
-                   Sarissa.copyChildNodes(oDoc, this.documentElement, false);
-                return oDoc;
-            };
-            /**
             * <p>Factory method to obtain a new DOM Document object</p>
             * @argument sUri the namespace of the root node (if any)
             * @argument sUri the local name of the root node (if any)
             * @returns a new DOM Document
             */
             Sarissa.getDomDocument = function(sUri, sName){
-                return document.implementation.createDocument(sUri?sUri:"", sName?sName:"", null);
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
             };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
         };
     };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
 };
@@ -382,29 +399,26 @@
 // Common stuff
 //==========================================
 if(!window.DOMParser){
-    /*
-    * DOMParser is a utility class, used to construct DOMDocuments from XML strings
-    * @constructor
-    */
-    DOMParser = function() {
-    };
     if(_SARISSA_IS_SAFARI){
-        /**
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
         * Construct a new DOM Document from the given XMLstring
         * @param sXml the given XML string
-        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml).
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
         * @return a new DOM Document from the given XML string
         */
         DOMParser.prototype.parseFromString = function(sXml, contentType){
-            if(contentType.toLowerCase() != "application/xml"){
-                throw "Cannot handle content type: \"" + contentType + "\"";
-            };
             var xmlhttp = new XMLHttpRequest();
-            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(str), false);
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
             xmlhttp.send(null);
             return xmlhttp.responseXML;
         };
-    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && "loadXML" in Sarissa.getDomDocument()){
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
         DOMParser.prototype.parseFromString = function(sXml, contentType){
             var doc = Sarissa.getDomDocument();
             doc.loadXML(sXml);
@@ -413,40 +427,36 @@
     };
 };
 
-if(window.XMLHttpRequest){
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-}
-else if(_SARISSA_IS_IE){
-    /**
-     * Emulate XMLHttpRequest
-     * @constructor
-     */
-    XMLHttpRequest = function() {
-        return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
-    };
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-};
-
-if(!window.document.importNode && _SARISSA_IS_IE){
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
     try{
         /**
-        * Implements importNode for the current window document in IE using innerHTML.
-        * Testing showed that DOM was multiple times slower than innerHTML for this,
-        * sorry folks. If you encounter trouble (who knows what IE does behind innerHTML)
-        * please gimme a call.
+        * Implementation of importNode for the context window document in IE
         * @param oNode the Node to import
         * @param bChildren whether to include the children of oNode
         * @returns the imported node for further use
         */
-        window.document.importNode = function(oNode, bChildren){
-            var importNode = document.createElement("div");
-            if(bChildren)
-                importNode.innerHTML = Sarissa.serialize(oNode);
-            else
-                importNode.innerHTML = Sarissa.serialize(oNode.cloneNode(false));
-            return importNode.firstChild;
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                tmp = document.createElement("table");
+            }
+            else if(oNode.nodeName == "td"){
+                tmp = document.createElement("tr");
+            }
+            else if(oNode.nodeName == "option"){
+                tmp = document.createElement("select");
+            }
+            else{
+                tmp = document.createElement("div");
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName("*")[0];
         };
-        }catch(e){};
+    }catch(e){ };
 };
 if(!Sarissa.getParseErrorText){
     /**
@@ -460,17 +470,16 @@
      */
     Sarissa.getParseErrorText = function (oDoc){
         var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc && oDoc.parseError && oDoc.parseError != 0){
-            /*moz*/
-            if(oDoc.documentElement.tagName == "parsererror"){
-                parseErrorText = oDoc.documentElement.firstChild.data;
-                parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
-            }/*konq*/
-            else{
-                parseErrorText = Sarissa.getText(oDoc.documentElement);/*.getElementsByTagName("h1")[0], false) + "\n";
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName("body")[0], false) + "\n";
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName("pre")[0], false);*/
-            };
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
         };
         return parseErrorText;
     };
@@ -483,7 +492,7 @@
         var nodeType = node.nodeType;
         if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
             s += node.data;
-        }else if(deep == true
+        } else if(deep == true
                     && (nodeType == Node.ELEMENT_NODE
                         || nodeType == Node.DOCUMENT_NODE
                         || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
@@ -492,41 +501,21 @@
     };
     return s;
 };
-if(window.XMLSerializer){
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
     /**
-     * <p>Factory method to obtain the serialization of a DOM Node</p>
-     * @returns the serialized Node as an XML string
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
      */
-    Sarissa.serialize = function(oDoc){
-        var s = null;
-        if(oDoc){
-            s = oDoc.innerHTML?oDoc.innerHTML:(new XMLSerializer()).serializeToString(oDoc);
-        };
-        return s;
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
     };
-}else{
-    if(Sarissa.getDomDocument && (Sarissa.getDomDocument("","foo", null)).xml){
-        // see non-IE version
-        Sarissa.serialize = function(oDoc) {
-            var s = null;
-            if(oDoc){
-                s = oDoc.innerHTML?oDoc.innerHTML:oDoc.xml;
-            };
-            return s;
-        };
-        /**
-         * Utility class to serialize DOM Node objects to XML strings
-         * @constructor
-         */
-        XMLSerializer = function(){};
-        /**
-         * Serialize the given DOM Node to an XML string
-         * @param oNode the DOM Node to serialize
-         */
-        XMLSerializer.prototype.serializeToString = function(oNode) {
-            return oNode.xml;
-        };
-    };
 };
 
 /**
@@ -541,13 +530,13 @@
  */
 Sarissa.clearChildNodes = function(oNode) {
     // need to check for firstChild due to opera 8 bug with hasChildNodes
-    while(oNode.firstChild){
+    while(oNode.firstChild) {
         oNode.removeChild(oNode.firstChild);
     };
 };
 /**
  * <p> Copies the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before
+ * <p> <b>Note:</b> The second object's original content is deleted before 
  * the copy operation, unless you supply a true third parameter</p>
  * @argument nodeFrom the Node to copy the childNodes from
  * @argument nodeTo the Node to copy the childNodes to
@@ -562,12 +551,11 @@
     };
     var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
     var nodes = nodeFrom.childNodes;
-    if(ownerDoc.importNode && (!_SARISSA_IS_IE)) {
+    if(typeof(ownerDoc.importNode) != "undefined")  {
         for(var i=0;i < nodes.length;i++) {
             nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
         };
-    }
-    else{
+    } else {
         for(var i=0;i < nodes.length;i++) {
             nodeTo.appendChild(nodes[i].cloneNode(true));
         };
@@ -576,12 +564,12 @@
 
 /**
  * <p> Moves the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before
+ * <p> <b>Note:</b> The second object's original content is deleted before 
  * the move operation, unless you supply a true third parameter</p>
  * @argument nodeFrom the Node to copy the childNodes from
  * @argument nodeTo the Node to copy the childNodes to
  * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
- */
+ */ 
 Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
     if((!nodeFrom) || (!nodeTo)){
         throw "Both source and destination nodes must be provided";
@@ -595,9 +583,9 @@
         while(nodeFrom.firstChild){
             nodeTo.appendChild(nodeFrom.firstChild);
         };
-    }else{
+    } else {
         var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-        if(ownerDoc.importNode && (!_SARISSA_IS_IE)) {
+        if(typeof(ownerDoc.importNode) != "undefined") {
            for(var i=0;i < nodes.length;i++) {
                nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
            };
@@ -610,9 +598,9 @@
     };
 };
 
-/**
+/** 
  * <p>Serialize any object to an XML string. All properties are serialized using the property name
- * as the XML element name. Array elements are rendered as <code>array-item</code> elements,
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
  * using their index/key as the value of the <code>key</code> attribute.</p>
  * @argument anyObject the object to serialize
  * @argument objectName a name for that object
@@ -622,7 +610,7 @@
     indentSpace = indentSpace?indentSpace:'';
     var s = indentSpace  + '<' + objectName + '>';
     var isLeaf = false;
-    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
         || anyObject instanceof Boolean || anyObject instanceof Date){
         s += Sarissa.escape(""+anyObject);
         isLeaf = true;
@@ -638,7 +626,7 @@
     return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
 };
 
-/**
+/** 
  * Escape the given string chacters that correspond to the five predefined XML entities
  * @param sXml the string to escape
  */
@@ -650,8 +638,8 @@
         .replace(/'/g, "&apos;");
 };
 
-/**
- * Unescape the given string. This turns the occurences of the predefined XML
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
  * entities to become the characters they represent correspond to the five predefined XML entities
  * @param sXml the string to unescape
  */
@@ -662,197 +650,4 @@
         .replace(/&lt;/g,"<")
         .replace(/&amp;/g,"&");
 };
-// EOF
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa cross browser XML library - IE XPath Emulation
- * @version 0.9.6.1
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- *
- * This script emulates Internet Explorer's selectNodes and selectSingleNode
- * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
- * is easy with IE's setProperty.
- * USers may also map a namespace prefix to a default (unprefixed) namespace in the
- * source document with Sarissa.setXpathNamespaces
- *
- *
- * ====================================================================
- * Licence
- * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit http://www.gnu.org
- *
- */
-if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
-    /**
-    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
-    * so it also has some properties IEs proprietery object features.</p>
-    * @private
-    * @constructor
-    * @argument i the (initial) list size
-    */
-    function SarissaNodeList(i){
-        this.length = i;
-    };
-    /** <p>Set an Array as the prototype object</p> */
-    SarissaNodeList.prototype = new Array(0);
-    /** <p>Inherit the Array constructor </p> */
-    SarissaNodeList.prototype.constructor = Array;
-    /**
-    * <p>Returns the node at the specified index or null if the given index
-    * is greater than the list size or less than zero </p>
-    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
-    * array notation instead of calling <code>item</code>
-    * @argument i the index of the member to return
-    * @returns the member corresponding to the given index
-    */
-    SarissaNodeList.prototype.item = function(i) {
-        return (i < 0 || i >= this.length)?null:this[i];
-    };
-    /**
-    * <p>Emulate IE's expr property
-    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
-    * @returns the XPath expression passed to selectNodes that resulted in
-    *          this SarissaNodeList
-    */
-    SarissaNodeList.prototype.expr = "";
-    /** dummy, used to accept IE's stuff without throwing errors */
-    XMLDocument.prototype.setProperty  = function(x,y){};
-    /**
-    * <p>Programmatically control namespace URI/prefix mappings for XPath
-    * queries.</p>
-    * <p>This method comes especially handy when used to apply XPath queries
-    * on XML documents with a default namespace, as there is no other way
-    * of mapping that to a prefix.</p>
-    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
-    * are looking for elements in the null namespace. If you need to look
-    * for nodes in the default namespace, you need to map a prefix to it
-    * first like:</p>
-    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
-    * <p><b>Note 1 </b>: Use this method only if the source document features
-    * a default namespace (without a prefix), otherwise just use IE's setProperty
-    * (moz will rezolve non-default namespaces by itself). You will need to map that
-    * namespace to a prefix for queries to work.</p>
-    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
-    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
-    * @param oDoc The target XMLDocument to set the namespace mappings for.
-    * @param sNsSet A whilespace-seperated list of namespace declarations as
-    *            those would appear in an XML document. E.g.:
-    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
-    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
-    * @throws An error if the format of the given namespace declarations is bad.
-    */
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        //oDoc._sarissa_setXpathNamespaces(sNsSet);
-        oDoc._sarissa_useCustomResolver = true;
-        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
-        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
-        for(var i=0;i < namespaces.length;i++){
-            var ns = namespaces[i];
-            var colonPos = ns.indexOf(":");
-            var assignPos = ns.indexOf("=");
-            if(colonPos == 5 && assignPos > colonPos+2){
-                var prefix = ns.substring(colonPos+1, assignPos);
-                var uri = ns.substring(assignPos+2, ns.length-1);
-                oDoc._sarissa_xpathNamespaces[prefix] = uri;
-            }else{
-                throw "Bad format on namespace declaration(s) given";
-            };
-        };
-    };
-    /**
-    * @private Flag to control whether a custom namespace resolver should
-    *          be used, set to true by Sarissa.setXpathNamespaces
-    */
-    XMLDocument.prototype._sarissa_useCustomResolver = false;
-    /** @private */
-    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
-    /**
-    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as a SarissaNodeList
-    * @throws An error if no namespace URI is found for the given prefix.
-    */
-    XMLDocument.prototype.selectNodes = function(sExpr, contextNode){
-        var nsDoc = this;
-        var nsresolver = this._sarissa_useCustomResolver
-        ? function(prefix){
-            var s = nsDoc._sarissa_xpathNamespaces[prefix];
-            if(s)return s;
-            else throw "No namespace URI found for prefix: '" + prefix+"'";
-            }
-        : this.createNSResolver(this.documentElement);
-            var oResult = this.evaluate(sExpr,
-                    (contextNode?contextNode:this),
-                    nsresolver,
-                    XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-        var nodeList = new SarissaNodeList(oResult.snapshotLength);
-        nodeList.expr = sExpr;
-        for(var i=0;i<nodeList.length;i++)
-            nodeList[i] = oResult.snapshotItem(i);
-        return nodeList;
-    };
-    /**
-    * <p>Extends the Element to emulate IE's selectNodes</p>
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An
-    *             error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectNodes = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectNodes)
-            return doc.selectNodes(sExpr, this);
-        else
-            throw "Method selectNodes is only supported by XML Elements";
-    };
-    /**
-    * <p>Extends the XMLDocument to emulate IE's selectSingleNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    */
-    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
-        var ctx = contextNode?contextNode:null;
-        sExpr = "("+sExpr+")[1]";
-        var nodeList = this.selectNodes(sExpr, ctx);
-        if(nodeList.length > 0)
-            return nodeList.item(0);
-        else
-            return null;
-    };
-    /**
-    * <p>Extends the Element to emulate IE's selectNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectSingleNode = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectSingleNode)
-            return doc.selectSingleNode(sExpr, this);
-        else
-            throw "Method selectNodes is only supported by XML Elements";
-    };
-    Sarissa.IS_ENABLED_SELECT_NODES = true;
-};
-// EOF
\ No newline at end of file
+//   EOF

Modified: branch/2.0.1/src/Model.js
===================================================================
--- branch/2.0.1/src/Model.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/src/Model.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -40,7 +40,10 @@
 Freja.Model.prototype.updateFrom = function(view) {
 	var values = view.getValues();
 	for (var i = 0; i < values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
 	}
 };
 /**

Modified: branch/2.0.1/src/QueryEngine.js
===================================================================
--- branch/2.0.1/src/QueryEngine.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/src/QueryEngine.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -13,57 +13,79 @@
 	}
 };
 Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error("Can't evaluate expression " + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
 	}
-	if(node) return node.nodeValue;
-
+	return null;
 };
 Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
 			}
-			// else parent element does not exist.. can't do anything
+			// else parent node non existent either, give up.
 		}
+		// not an attribute, give up.
+		throw new Error("Can't evaluate expression " + expression);
 	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
 };
 /**
   * XPath query engine.
   */
 Freja.QueryEngine.XPath = function() {};
 Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node && node.nodeType == 2) {
-		return node;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error("Can't evaluate expression " + expression);
-	return null;
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
 };
 /**
   * SimplePath
@@ -71,6 +93,7 @@
 Freja.QueryEngine.SimplePath = function() {};
 Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
 Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
 	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
 		throw new Error("Can't evaluate expression " + expression);
 	}

Modified: branch/2.0.1/src/View.js
===================================================================
--- branch/2.0.1/src/View.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/src/View.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -50,7 +50,6 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				// this._destination.innerHTML = html;
 				this._destination.innerHTML = "";
 				this._destination.appendChild(html);
 			}, this.view));

Modified: branch/2.0.1/src/auxiliary/minimal.js
===================================================================
--- branch/2.0.1/src/auxiliary/minimal.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/src/auxiliary/minimal.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -334,6 +334,11 @@
 	this.addCallbacks(null, fncError);
 };
 if (document.implementation && document.implementation.hasFeature("XPath", "3.0")) {
+	// Opera 9 XMLDocument Fix. Thanks to Chris D.
+	if(!XMLDocument) {
+	   var XMLDocument = Document;
+	}	
+
 	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
 		var nsDoc = this;
 		var nsresolver = this.createNSResolver(this.documentElement);
@@ -383,10 +388,7 @@
 		}
 	};
 };
-// Opera 9 XMLDocument Fix. Thanks to Chris D.
-if(!XMLDocument) {
-   var XMLDocument = Document;
-}
+
 // Adapated From Sarissa
 // * @version 0.9.6.1
 // * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net

Modified: branch/2.0.1/src/auxiliary/mochi+sarissa.js
===================================================================
--- branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -83,7 +83,7 @@
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
 	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
-	return processor.transformToDocument(xml);
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -91,7 +91,7 @@
 	try {
 		clone = xmlDoc.cloneNode(true);
 	} catch(e) { /* squelch */ }
-
+	
 	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
 	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
 	if (!clone) {
@@ -101,27 +101,27 @@
 			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
 			try {
 				clone.appendChild(data);
-			} catch(e) {
+			} catch(e) {				
 				// Opera has already created a documentElement and can't append another root node
 				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i >= 0; i--) {
+			
+				for (var i = data.childNodes.length-1; i >= 0; i--) {
 					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
 				}
+				
 				// need to copy root node attributes
 				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
 					var name  = xmlDoc.documentElement.attributes.item(i).name;
 					var value = xmlDoc.documentElement.attributes.item(i).value;
 					clone.documentElement.setAttribute(name, value);
-				}
+				}				
 			}
 		}
 	}
+	
 	return clone;
 };
-/**  Opera 9 XMLDocument Fix. Thanks to Chris D.  */
-if(!XMLDocument) {
-   var XMLDocument = Document;
-}
+
 /** hasSupportForXSLT() : boolean */
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */
@@ -132,3 +132,206 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+

Modified: branch/2.0.1/tests/test_Model.js
===================================================================
--- branch/2.0.1/tests/test_Model.js	2007-01-25 05:44:24 UTC (rev 72)
+++ branch/2.0.1/tests/test_Model.js	2007-01-25 22:09:26 UTC (rev 73)
@@ -43,8 +43,7 @@
 	var model = Freja.AssetManager.getModel("data/model2.xml");
 	t.is(model.get("item/@price"), "$3.80");
 	t.is(model.get("item/description"), "with Goat Cheese, a touch of Cumin and Cayenne");
-
-
+	
 	var model3 = Freja.AssetManager.getModel("data/model3.xml");
 	model3.set("item/price","$5.40");
 	t.is(model3.get("item/price"), "$5.40");



From cedsav at mail.berlios.de  Fri Jan 26 16:07:46 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Fri, 26 Jan 2007 16:07:46 +0100
Subject: [Freja-svn] r74 - in branch/2.0.1: lib src src/auxiliary
Message-ID: <200701261507.l0QF7kj6001385@sheep.berlios.de>

Author: cedsav
Date: 2007-01-26 16:07:38 +0100 (Fri, 26 Jan 2007)
New Revision: 74

Modified:
   branch/2.0.1/lib/Freja.js
   branch/2.0.1/src/Freja.js
   branch/2.0.1/src/View.js
   branch/2.0.1/src/auxiliary/mochi+sarissa.js
Log:
Fixed XSL parameters bug in mochi+sarissa build.

Modified: branch/2.0.1/lib/Freja.js
===================================================================
--- branch/2.0.1/lib/Freja.js	2007-01-25 22:09:26 UTC (rev 73)
+++ branch/2.0.1/lib/Freja.js	2007-01-26 15:07:38 UTC (rev 74)
@@ -1,8 +1,8 @@
 /***
 
-    Freja 2.0
+    Freja 2.0.1
 
-    Build $Thu, 25 Jan 2007 22:01:11 UTC$
+    Build $Fri, 26 Jan 2007 03:09:08 UTC$
 
     Target: mochi+sarissa
 
@@ -21,7 +21,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.0";
+Freja.VERSION = "2.0.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };
@@ -128,10 +128,15 @@
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl) {
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter(null, paramName, xslParameters[paramName]);
+		}
+	}
+	 
 	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
@@ -830,21 +835,11 @@
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		// var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		var dom = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!dom) {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
 			d.errback(new Error("XSL Transformation error."));
 		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// <xsl:output method="html" />
-			// (cedsav) don't remember all the details but method="xml" is the way to go.
-			// method="html" would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			
-			// html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
-			
-			d.callback(dom);
+			d.callback(html);
 		}
 	} catch (ex) {
 		d.errback(ex);

Modified: branch/2.0.1/src/Freja.js
===================================================================
--- branch/2.0.1/src/Freja.js	2007-01-25 22:09:26 UTC (rev 73)
+++ branch/2.0.1/src/Freja.js	2007-01-26 15:07:38 UTC (rev 74)
@@ -5,7 +5,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.0";
+Freja.VERSION = "2.0.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };

Modified: branch/2.0.1/src/View.js
===================================================================
--- branch/2.0.1/src/View.js	2007-01-25 22:09:26 UTC (rev 73)
+++ branch/2.0.1/src/View.js	2007-01-26 15:07:38 UTC (rev 74)
@@ -158,21 +158,11 @@
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		// var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		var dom = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!dom) {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
 			d.errback(new Error("XSL Transformation error."));
 		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// <xsl:output method="html" />
-			// (cedsav) don't remember all the details but method="xml" is the way to go.
-			// method="html" would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			
-			// html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
-			
-			d.callback(dom);
+			d.callback(html);
 		}
 	} catch (ex) {
 		d.errback(ex);

Modified: branch/2.0.1/src/auxiliary/mochi+sarissa.js
===================================================================
--- branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-25 22:09:26 UTC (rev 73)
+++ branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-01-26 15:07:38 UTC (rev 74)
@@ -79,10 +79,15 @@
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl) {
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter(null, paramName, xslParameters[paramName]);
+		}
+	}
+	 
 	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */



