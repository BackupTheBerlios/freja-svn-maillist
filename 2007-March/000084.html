<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Freja-svn] r86 - in trunk: . examples/basecamp_api	examples/basecamp_api/css examples/basecamp_api/views	examples/contacts examples/contacts/models/php_inc	examples/contacts/views examples/tutorial	examples/tutorial/views lib lib/minimal lib/mochi+sarissa src	src/auxiliary tests
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/freja-svn/2007-March/index.html" >
   <LINK REL="made" HREF="mailto:freja-svn%40lists.berlios.de?Subject=Re%3A%20%5BFreja-svn%5D%20r86%20-%20in%20trunk%3A%20.%20examples/basecamp_api%0A%09examples/basecamp_api/css%20examples/basecamp_api/views%0A%09examples/contacts%20examples/contacts/models/php_inc%0A%09examples/contacts/views%20examples/tutorial%0A%09examples/tutorial/views%20lib%20lib/minimal%20lib/mochi%2Bsarissa%20src%0A%09src/auxiliary%20tests&In-Reply-To=%3C200703211514.l2LFEwcY031999%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000083.html">
   <LINK REL="Next"  HREF="000085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Freja-svn] r86 - in trunk: . examples/basecamp_api	examples/basecamp_api/css examples/basecamp_api/views	examples/contacts examples/contacts/models/php_inc	examples/contacts/views examples/tutorial	examples/tutorial/views lib lib/minimal lib/mochi+sarissa src	src/auxiliary tests</H1>
    <B>cedsav at mail.berlios.de</B> 
    <A HREF="mailto:freja-svn%40lists.berlios.de?Subject=Re%3A%20%5BFreja-svn%5D%20r86%20-%20in%20trunk%3A%20.%20examples/basecamp_api%0A%09examples/basecamp_api/css%20examples/basecamp_api/views%0A%09examples/contacts%20examples/contacts/models/php_inc%0A%09examples/contacts/views%20examples/tutorial%0A%09examples/tutorial/views%20lib%20lib/minimal%20lib/mochi%2Bsarissa%20src%0A%09src/auxiliary%20tests&In-Reply-To=%3C200703211514.l2LFEwcY031999%40sheep.berlios.de%3E"
       TITLE="[Freja-svn] r86 - in trunk: . examples/basecamp_api	examples/basecamp_api/css examples/basecamp_api/views	examples/contacts examples/contacts/models/php_inc	examples/contacts/views examples/tutorial	examples/tutorial/views lib lib/minimal lib/mochi+sarissa src	src/auxiliary tests">cedsav at mail.berlios.de
       </A><BR>
    <I>Wed Mar 21 16:14:58 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000083.html">[Freja-svn] r85 - branch/2.0.1/examples/tutorial
</A></li>
        <LI>Next message: <A HREF="000085.html">[Freja-svn] r87 - trunk/external
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#84">[ date ]</a>
              <a href="thread.html#84">[ thread ]</a>
              <a href="subject.html#84">[ subject ]</a>
              <a href="author.html#84">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: cedsav
Date: 2007-03-21 16:13:46 +0100 (Wed, 21 Mar 2007)
New Revision: 86

Added:
   trunk/custom_rhino.jar
   trunk/examples/tutorial/example2.html
   trunk/examples/tutorial/example2.js
   trunk/lib/minimal/
   trunk/lib/minimal/Freja.js
   trunk/lib/minimal/Freja_pack.js
   trunk/lib/mochi+sarissa/
   trunk/lib/mochi+sarissa/Freja.js
   trunk/lib/mochi+sarissa/Freja_pack.js
   trunk/lib/mochi+sarissa/MochiKit.js
   trunk/lib/mochi+sarissa/Sarissa.js
   trunk/lib/mochi+sarissa/Sarissa_pack.js
Removed:
   trunk/examples/tutorial/example2.html
   trunk/examples/tutorial/example2.js
   trunk/lib/Freja.js
   trunk/lib/MochiKit.js
   trunk/lib/Sarissa.js
Modified:
   trunk/build.wsf
   trunk/examples/basecamp_api/basecamp.js
   trunk/examples/basecamp_api/css/main.css
   trunk/examples/basecamp_api/index.html
   trunk/examples/basecamp_api/views/category_list.xsl
   trunk/examples/basecamp_api/views/comment.xsl
   trunk/examples/basecamp_api/views/message.xsl
   trunk/examples/basecamp_api/views/message_list.xsl
   trunk/examples/basecamp_api/views/milestone_list.xsl
   trunk/examples/basecamp_api/views/project.xsl
   trunk/examples/basecamp_api/views/project_selector.xsl
   trunk/examples/basecamp_api/views/projects.xsl
   trunk/examples/basecamp_api/views/todo_list.xsl
   trunk/examples/contacts/client.html
   trunk/examples/contacts/models/php_inc/inc.resource.php
   trunk/examples/contacts/views/create.xsl
   trunk/examples/contacts/views/edit.xsl
   trunk/examples/contacts/views/index.xsl
   trunk/examples/tutorial/example.html
   trunk/examples/tutorial/example.js
   trunk/examples/tutorial/views/edit.xsl
   trunk/src/AssetManager.js
   trunk/src/Freja.js
   trunk/src/Model.js
   trunk/src/QueryEngine.js
   trunk/src/View.js
   trunk/src/auxiliary/minimal.js
   trunk/src/auxiliary/mochi+sarissa.js
   trunk/tests/index.html
   trunk/tests/test_Freja-History.html
   trunk/tests/test_Freja-Model.html
   trunk/tests/test_Freja-View.html
   trunk/tests/test_Model.js
   trunk/tests/test_View.js
Log:
Merged v2.0.1 branch. Renamed version to 2.1 (2.1 is not backward compatible due to a required change in the XSL:output method -&gt; html instead of xml).

Modified: trunk/build.wsf
===================================================================
--- trunk/build.wsf	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/build.wsf	2007-03-21 15:13:46 UTC (rev 86)
@@ -16,10 +16,12 @@
 	
 	if (dialog.ShowOpen()) {
 		var AUXILIARY = dialog.FileName;
-
-		var outfile = cwd + &quot;/lib/Freja.js&quot;;
+		var AUXILIARY_FOLDER = AUXILIARY.match(/\\([^\\]*)\.js$/)[1];
+		var outfile = cwd + &quot;\\lib\\&quot; + AUXILIARY_FOLDER + &quot;\\Freja.js&quot;;
+		var outfile_packed = cwd + &quot;\\lib\\&quot; + AUXILIARY_FOLDER + &quot;\\Freja_pack.js&quot;;
 		try {
 			FileSystem.deleteFile(outfile);
+			FileSystem.deleteFile(outfile_packed);
 		} catch (ex) {}
 
 		var file = FileSystem.openTextFile(srcDir + &quot;/Freja.js&quot;, 1, -2);
@@ -50,7 +52,7 @@
 			&quot;\n    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please&quot; +
 			&quot;\n    diff against the source tree, not this file.&quot; +
 			&quot;\n&quot; +
-			&quot;\n    Copyright (c) 2006 C&#233;dric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">pro at 4213miles.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;&quot; +
+			&quot;\n    Copyright (c) 2006-2007 Cedric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">cedric at veerwest.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;&quot; +
 			&quot;\n    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;&quot; +
 			&quot;\n&quot; +
 			&quot;\n***&quot; + &quot;/&quot; +
@@ -70,6 +72,10 @@
 		var out = FileSystem.openTextFile(outfile, 2, -2);
 		out.write(header + source);
 		out.close();
+		
+		Shell.CurrentDirectory = cwd;
+		var cmd = &quot;%comspec% /c java -jar custom_rhino.jar -c \&quot;&quot;+outfile+&quot;\&quot; &gt; \&quot;&quot;+outfile_packed+&quot;\&quot; 2&gt;&amp;1&quot;;
+		var r = Shell.run(cmd,0,true);
 	}
 	]]&gt;
 	&lt;/script&gt;

Copied: trunk/custom_rhino.jar (from rev 85, branch/2.0.1/custom_rhino.jar)

Modified: trunk/examples/basecamp_api/basecamp.js
===================================================================
--- trunk/examples/basecamp_api/basecamp.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/basecamp.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -6,6 +6,7 @@
 	
 	// Constants
 	var BASECAMP_URL = &quot;<A HREF="http://freja.projectpath.com">http://freja.projectpath.com</A>&quot;;	
+	Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
 
 	// 3rd party libraries.
 	var helpers = new wHELPERS();	// misc. javascript functions
@@ -42,11 +43,19 @@
 			currentProjectId = projects.get(&quot;//project[status='active']/id&quot;);				
 		else 
 			currentProjectId = projectId;
-			
-		todos      = getModel(&quot;models/todos.xml&quot;); 		// Snapshot. Live data: getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/todos/lists&quot;));									
-		messages   = getModel(&quot;models/posts.xml&quot;);  // getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/msg/archive&quot;));	 // 		// Snapshot.
-		milestones = getModel(&quot;models/milestones.xml&quot;); // Snapshot. Live data: getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/milestones/list&quot;));
-		categories = getModel(&quot;models/categories.xml&quot;); // Snapshot. Live data: getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/post_categories&quot;));
+
+		// snapshots (used for development only)	
+	//	todos      = getModel(&quot;models/todos.xml&quot;); 		
+	//	messages   = getModel(&quot;models/posts.xml&quot;);  
+	//	milestones = getModel(&quot;models/milestones.xml&quot;);
+	//	categories = getModel(&quot;models/categories.xml&quot;);
+
+		// Live data
+		todos      = getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/todos/lists&quot;));									
+		messages   = getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/msg/archive&quot;));	 // 		
+		milestones = getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/milestones/list&quot;));
+		categories = getModel(addProxyToUrl(&quot;/projects/&quot;+currentProjectId+&quot;/post_categories&quot;));
+		
 		requestTemplate = getModel(&quot;models/new_request.xml&quot;);   // xml wrapper for posted data
 		messageTemplate = getModel(&quot;models/new_post.xml&quot;);      // skeleton for new data
 		commentTemplate = getModel(&quot;models/new_comment.xml&quot;);   // skeleton for new data

Modified: trunk/examples/basecamp_api/css/main.css
===================================================================
--- trunk/examples/basecamp_api/css/main.css	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/css/main.css	2007-03-21 15:13:46 UTC (rev 86)
@@ -19,6 +19,11 @@
 	padding: 5px 15px;
 	font-size: medium;
 }
+h4 {
+	margin: 0;
+	font-size: small;
+	padding: 5px;
+}
 form {
 	padding: 5px 15px;
 }
@@ -57,11 +62,14 @@
 }
 .frame .frameContent {
 	background-image: url(../images/frame-bg.png);
-	background-repeat: no-repeat;
+	background-repeat: repeat-y;
 }
 .frame .top {
 	background-image: url(../images/frame-top-bg.png);
 	background-repeat: no-repeat;
+	font-size: small;
+	text-transform: uppercase;
+	padding: 2px 6px;
 }
 .frame .bottom {
 	background-image: url(../images/frame-bottom-bg.png);
@@ -94,9 +102,9 @@
 }
 
 /* ------------------------------------------------------------------ */
-.messageList ul {
+ul {
 	margin: 0;
-	padding: 0;
+	padding: 5px;
 }
 .messageList ul li {
 	list-style-type: none;

Modified: trunk/examples/basecamp_api/index.html
===================================================================
--- trunk/examples/basecamp_api/index.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/index.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -10,7 +10,7 @@
 &lt;script type=&quot;text/javascript&quot; src=&quot;lib/helpers.js&quot;&gt;&lt;/script&gt;
 
 &lt;!-- Freja Framework Script --&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Freja.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/minimal/Freja.js&quot;&gt;&lt;/script&gt;
 
 &lt;!-- Controller Code --&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;basecamp.js&quot;&gt;&lt;/script&gt;
@@ -25,6 +25,7 @@
 		&lt;/div&gt;
 		&lt;div id=&quot;content&quot;&gt;			
 
+
 			&lt;div class=&quot;frame&quot;&gt;
 				&lt;div class=&quot;top&quot;&gt;TO-DOS&lt;/div&gt;
 				&lt;div id=&quot;placeholder_todos&quot; class=&quot;frameContent&quot;&gt;&lt;/div&gt;
@@ -36,6 +37,11 @@
 				&lt;div id=&quot;placeholder_milestones&quot; class=&quot;frameContent&quot;&gt;&lt;/div&gt;
 				&lt;div class=&quot;bottom&quot;&gt;&nbsp;&lt;/div&gt;
 			&lt;/div&gt;
+			&lt;div class=&quot;frame&quot;&gt;
+				&lt;div class=&quot;top&quot;&gt;Misc.&lt;/div&gt;
+				&lt;div id=&quot;placeholder_categories&quot; class=&quot;frameContent&quot;&gt;&lt;/div&gt;
+				&lt;div class=&quot;bottom&quot;&gt;&nbsp;&lt;/div&gt;
+			&lt;/div&gt;
 
 			
 			&lt;div class=&quot;messages&quot;&gt;
@@ -43,14 +49,6 @@
 				&lt;div id=&quot;placeholder_messages&quot; class=&quot;frameContent&quot;&gt;&lt;/div&gt;
 				&lt;div class=&quot;bottom&quot;&gt;&lt;img src=&quot;images/messages-footer.png&quot; alt=&quot;*&quot; /&gt;&lt;/div&gt;
 			&lt;/div&gt;
-			
-			&lt;div class=&quot;frame&quot;&gt;
-				&lt;div class=&quot;top&quot;&gt;Misc.&lt;/div&gt;
-				&lt;div id=&quot;placeholder_categories&quot; class=&quot;frameContent&quot;&gt;&lt;/div&gt;
-				&lt;div class=&quot;bottom&quot;&gt;&nbsp;&lt;/div&gt;
-			&lt;/div&gt;
-			
-			
 			&lt;div id=&quot;placeholder_debug&quot;&gt;&lt;/div&gt;
 			&lt;div id=&quot;placeholder_debug2&quot;&gt;&lt;/div&gt;
 		&lt;/div&gt;

Modified: trunk/examples/basecamp_api/views/category_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/category_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/category_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
-
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 &lt;xsl:template match=&quot;/post-categories&quot;&gt;	
-	&lt;h3&gt;Message Categories&lt;/h3&gt;
+	&lt;h4&gt;Message Categories&lt;/h4&gt;
 	&lt;ul&gt;
 		&lt;xsl:apply-templates /&gt;
 	&lt;/ul&gt;

Modified: trunk/examples/basecamp_api/views/comment.xsl
===================================================================
--- trunk/examples/basecamp_api/views/comment.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/comment.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,8 +1,10 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 &lt;xsl:param name=&quot;commentId&quot; &gt;&lt;/xsl:param&gt;
 &lt;xsl:param name=&quot;title&quot; &gt;Edit Comment&lt;/xsl:param&gt;
+
 &lt;xsl:template match=&quot;/&quot;&gt;
 	&lt;xsl:apply-templates select=&quot;//comment[id=$commentId]&quot; /&gt;
 &lt;/xsl:template&gt;

Modified: trunk/examples/basecamp_api/views/message.xsl
===================================================================
--- trunk/examples/basecamp_api/views/message.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/message.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,8 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
+
 &lt;xsl:param name=&quot;messageId&quot; &gt;&lt;/xsl:param&gt;
 &lt;xsl:param name=&quot;title&quot; &gt;Edit Message&lt;/xsl:param&gt;
 &lt;xsl:template match=&quot;posts&quot;&gt;

Modified: trunk/examples/basecamp_api/views/message_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/message_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/message_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,6 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
-&lt;xsl:output method=&quot;xml&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;!-- ====================================================================================  
   MESSAGE LIST (POSTS+COMMENTS)  

Modified: trunk/examples/basecamp_api/views/milestone_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/milestone_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/milestone_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;xsl:template match=&quot;/milestones&quot;&gt;	
-	&lt;h3&gt;Milestones&lt;/h3&gt;
 	&lt;ul&gt;
 		&lt;xsl:apply-templates /&gt;
 	&lt;/ul&gt;

Modified: trunk/examples/basecamp_api/views/project.xsl
===================================================================
--- trunk/examples/basecamp_api/views/project.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/project.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;xsl:template match=&quot;projects&quot;&gt;	
 	&lt;xsl:apply-templates /&gt;

Modified: trunk/examples/basecamp_api/views/project_selector.xsl
===================================================================
--- trunk/examples/basecamp_api/views/project_selector.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/project_selector.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;xsl:template match=&quot;projects&quot;&gt;	
 	&lt;label for=&quot;currentProjectSelector&quot; class=&quot;preField&quot; &gt;Current Project: &lt;/label&gt;

Modified: trunk/examples/basecamp_api/views/projects.xsl
===================================================================
--- trunk/examples/basecamp_api/views/projects.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/projects.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;xsl:template match=&quot;projects&quot;&gt;	
 	&lt;xsl:apply-templates /&gt;

Modified: trunk/examples/basecamp_api/views/todo_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/todo_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/todo_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 
 &lt;xsl:template match=&quot;/todo-lists&quot;&gt;	
-	&lt;h3&gt;To-do lists&lt;/h3&gt;
 	&lt;ul&gt;
 		&lt;xsl:apply-templates /&gt;
 	&lt;/ul&gt;

Modified: trunk/examples/contacts/client.html
===================================================================
--- trunk/examples/contacts/client.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/client.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,9 +5,9 @@
 &lt;title&gt;Contacts&lt;/title&gt;
 
 &lt;!-- Freja Framework Script --&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Freja.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
 
 &lt;!-- Controller Code --&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;client.js&quot;&gt;&lt;/script&gt;

Modified: trunk/examples/contacts/models/php_inc/inc.resource.php
===================================================================
--- trunk/examples/contacts/models/php_inc/inc.resource.php	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/models/php_inc/inc.resource.php	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,12 @@
 &lt;?php
 $request_headers = apache_request_headers();
 if (isset($request_headers['Http-Method-Equivalent'])) {
-	$REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+   $REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+} elseif (isset($request_headers['http-method-equivalent'])) {
+// IE sends the Http-Method-Equivalent header in lowercase!
+    $REQUEST_METHOD = $request_headers['http-method-equivalent'];
 } else {
-	$REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
+   $REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
 }
 
 if ($REQUEST_METHOD == &quot;PUT&quot; || $REQUEST_METHOD == &quot;POST&quot;) {

Modified: trunk/examples/contacts/views/create.xsl
===================================================================
--- trunk/examples/contacts/views/create.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/create.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
-
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 &lt;xsl:template match=&quot;/&quot;&gt;
 	&lt;form method=&quot;post&quot; action=&quot;#&quot; class=&quot;form&quot;&gt;
 		&lt;p&gt;email:&lt;input name=&quot;email&quot; type=&quot;text&quot; value=&quot;&quot; /&gt;&lt;/p&gt;

Modified: trunk/examples/contacts/views/edit.xsl
===================================================================
--- trunk/examples/contacts/views/edit.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/edit.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
-
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 &lt;xsl:template match=&quot;record&quot;&gt;	
 	&lt;form method=&quot;post&quot; action=&quot;#&quot; class=&quot;form&quot;&gt;
 	&lt;xsl:attribute name=&quot;url&quot;&gt;&lt;xsl:value-of select=&quot;url&quot; /&gt;&lt;/xsl:attribute&gt;

Modified: trunk/examples/contacts/views/index.xsl
===================================================================
--- trunk/examples/contacts/views/index.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/index.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;xsl:stylesheet version=&quot;1.0&quot;
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
-
+&lt;xsl:output method=&quot;html&quot; indent=&quot;yes&quot; encoding=&quot;UTF-8&quot;/&gt;
 &lt;xsl:template match=&quot;result&quot;&gt;
 &lt;table border=&quot;1&quot; cellpadding=&quot;4&quot; cellspacing=&quot;4&quot;&gt;
 &lt;xsl:for-each select=&quot;record&quot;&gt;

Modified: trunk/examples/tutorial/example.html
===================================================================
--- trunk/examples/tutorial/example.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,9 +5,9 @@
 &lt;title&gt;Freja Example&lt;/title&gt;
 
 &lt;!-- Freja Framework Script --&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Freja.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
 
 &lt;!-- Controller Code --&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;example.js&quot;&gt;&lt;/script&gt;

Modified: trunk/examples/tutorial/example.js
===================================================================
--- trunk/examples/tutorial/example.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -3,34 +3,23 @@
 var display = getView(&quot;views/display.xsl&quot;);
 display.placeholder = 'content';
 display.behaviors[&quot;editLink&quot;] = {
-	onclick : function() { dispatch('edit'); }
+	onclick : function() { edit.render(data); }
 };
 
 var edit = getView(&quot;views/edit.xsl&quot;);
 edit.placeholder = 'content';
 edit.behaviors[&quot;editForm&quot;] = {
-	onsubmit : function() { dispatch('update'); }
+	onsubmit : function() { 
+		data.updateFrom(edit);
+		display.render(data);
+		return false;
+	}
 };
 edit.behaviors[&quot;displayLink&quot;] = {
-	onclick : function() { dispatch('display'); }
+	onclick : function() { display.render(data); }
 };
 
-dispatch = function(action) {
-	switch (action) {
-		default:
-			// fall through to case 'display'
-		case 'display':
-			display.render(data)
-			break;
-		case 'edit':
-			edit.render(data);
-			break;
-		case 'update':
-			data.updateFrom(edit);
-			dispatch('display');
-		break;
-	}
-}
+
 connect(window, &quot;onload&quot;, function() {
-	dispatch(&quot;display&quot;);
+	display.render(data);
 });
\ No newline at end of file

Deleted: trunk/examples/tutorial/example2.html
===================================================================
--- trunk/examples/tutorial/example2.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,19 +0,0 @@
-&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
-&lt;head&gt;
-&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
-&lt;title&gt;Freja Example 2&lt;/title&gt;
-
-&lt;!-- Freja Framework Script --&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/Freja.js&quot;&gt;&lt;/script&gt;
-
-&lt;!-- Controller Code --&gt;
-&lt;script type=&quot;text/javascript&quot; src=&quot;example2.js&quot;&gt;&lt;/script&gt;
-&lt;/head&gt;
-
-&lt;body&gt;
-&lt;div id=&quot;content&quot;&gt;&lt;span style=&quot;color:white;background:firebrick&quot;&gt;Loading ...&lt;/span&gt;&lt;/div&gt;
-&lt;/body&gt;
-&lt;/html&gt;

Copied: trunk/examples/tutorial/example2.html (from rev 85, branch/2.0.1/examples/tutorial/example2.html)
===================================================================
--- branch/2.0.1/examples/tutorial/example2.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,19 @@
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;
+&lt;head&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
+&lt;title&gt;Freja Example 2&lt;/title&gt;
+
+&lt;!-- Freja Framework Script --&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;../../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
+
+&lt;!-- Controller Code --&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;example2.js&quot;&gt;&lt;/script&gt;
+&lt;/head&gt;
+
+&lt;body&gt;
+&lt;div id=&quot;content&quot;&gt;&lt;span style=&quot;color:white;background:firebrick&quot;&gt;Loading ...&lt;/span&gt;&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Deleted: trunk/examples/tutorial/example2.js
===================================================================
--- trunk/examples/tutorial/example2.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,31 +0,0 @@
-var data = getModel(&quot;models/data.xml&quot;);
-
-var display = getView(&quot;views/display.xsl&quot;);
-display.placeholder = &quot;content&quot;;
-display.behaviors[&quot;editLink&quot;] = {
-	onclick : function() {
-		edit.render(data);
-	}
-};
-
-var edit = getView(&quot;views/edit.xsl&quot;);
-edit.placeholder = &quot;content&quot;;
-edit.behaviors[&quot;editForm&quot;] = {
-	onsubmit : function() {
-		try {
-			data.updateFrom(edit);
-			display.render(data);
-		} catch (ex) {
-			alert(ex.message);
-		}
-	}
-};
-edit.behaviors[&quot;displayLink&quot;] = {
-	onclick : function() {
-		display.render(data);
-	}
-};
-
-connect(window, &quot;onload&quot;, function() {
-	display.render(data);
-});
\ No newline at end of file

Copied: trunk/examples/tutorial/example2.js (from rev 85, branch/2.0.1/examples/tutorial/example2.js)

Modified: trunk/examples/tutorial/views/edit.xsl
===================================================================
--- trunk/examples/tutorial/views/edit.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/views/edit.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -3,7 +3,7 @@
 	xmlns:xsl=&quot;<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>&quot;&gt;
 
 &lt;xsl:template match=&quot;item&quot;&gt;	
-	&lt;form method=&quot;post&quot; action=&quot;#&quot; freja-behaviour=&quot;editForm&quot;&gt;
+	&lt;form method=&quot;post&quot; action=&quot;#&quot; class=&quot;editForm&quot;&gt;
 		&lt;h3&gt;&lt;input name=&quot;item/name&quot; type=&quot;text&quot; value=&quot;{name}&quot; /&gt;&lt;/h3&gt;
 		&lt;p&gt;&lt;textarea name=&quot;item/description&quot;&gt;&lt;xsl:value-of select=&quot;description&quot; /&gt;&lt;/textarea&gt;&lt;/p&gt;
 		&lt;p&gt;&lt;input name=&quot;item/price&quot; type=&quot;text&quot; value=&quot;{price}&quot; /&gt;&lt;/p&gt;

Deleted: trunk/lib/Freja.js
===================================================================
--- trunk/lib/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,1248 +0,0 @@
-/***
-
-    Freja 2.0.alpha
-
-    Build $Fri, 28 Jul 2006 13:38:48 UTC$
-
-    Target: minimal
-
-    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
-    diff against the source tree, not this file.
-
-    Copyright (c) 2006 C&#233;dric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">pro at 4213miles.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;
-    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;
-
-***/
-
-if (typeof(dojo) != &quot;undefined&quot;) {
-	dojo.provide(&quot;Freja&quot;);
-}
-if (typeof(Freja) == &quot;undefined&quot;) {
-	Freja = {};
-}
-Freja.NAME = &quot;Freja&quot;;
-Freja.VERSION = &quot;2.0.alpha&quot;;
-Freja.__repr__ = function () {
-	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
-};
-Freja.toString = function () {
-	return this.__repr__();
-};
-/**
-  * Single-hierarchy inheritance (class emulation)
-  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
-  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
-  *
-  * Extends one prototype by another.
-  * The subtype will have two specialpurpose properties:
-  *     superconstructor    The parent prototype's constructor
-  *     supertype        The parent prototype
-  */
-Freja.Class = {};
-Freja.Class.extend = function(subClass, superconstructor) {
-	var inlineSuper = function(){};
-	inlineSuper.prototype = superconstructor.prototype;
-	subClass.prototype = new inlineSuper();
-	subClass.prototype.constructor = subClass;
-	subClass.prototype.superconstructor = superconstructor;
-	subClass.prototype.supertype = superconstructor.prototype;
-};
-/**
-  * Freja._aux
-  * wrapper for external dependencies (frameworks).
-  *
-  * This is the minimal auxiliary adapter. It contains self-sufficient
-  * implementations of all dependencies.
-  *
-  */
-if (typeof(Freja) == &quot;undefined&quot;) {
-	Freja = {};
-}
-Freja._aux = {};
-/** bind(func, self) : function */
-// from <A HREF="http://blog.ianbicking.org/prototype-and-object-prototype.html">http://blog.ianbicking.org/prototype-and-object-prototype.html</A>
-Freja._aux.bind = function(func, self) {
-	if(typeof (func)==&quot;string&quot;){
-		func=self[func];
-	}
-
-	var im_func = null;
-    if (typeof(func.im_func) == 'function') {
-        im_func = func.im_func;
-    } else {
-        im_func = func;
-    }
-    func = function () {
-        return func.im_func.apply(func.im_self, arguments);
-    }
-    func.im_func = im_func;
-    func.im_self = self;
-	return func;
-
-};
-/** formContents(elem) : Array */
-Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
-	var names = [];
-	var values = [];
-	var inputs = elem.getElementsByTagName(&quot;INPUT&quot;);
-	for (var i = 0; i &lt; inputs.length; ++i) {
-		var input = inputs[i];
-		if (input.name) {
-			if (input.type == &quot;radio&quot; || input.type == &quot;checkbox&quot;) {
-				if (input.checked) {
-					names.push(input.name);
-					values.push(input.value);
-				} else {
-					names.push(input.name);
-					values.push(&quot;&quot;);
-				}
-			} else {
-				names.push(input.name);
-				values.push(input.value);
-			}
-		}
-	}
-	var textareas = elem.getElementsByTagName(&quot;TEXTAREA&quot;);
-	for (var i = 0; i &lt; textareas.length; ++i) {
-		var input = textareas[i];
-		if (input.name) {
-			names.push(input.name);
-			values.push(input.value);
-		}
-	}
-	var selects = elem.getElementsByTagName(&quot;SELECT&quot;);
-	for (var i = 0; i &lt; selects.length; ++i) {
-		var input = selects[i];
-		if (input.name) {
-			if (input.selectedIndex &gt;= 0) {
-				var opt = input.options[input.selectedIndex];
-				names.push(input.name);
-				values.push((opt.value) ? opt.value : &quot;&quot;);
-			}
-		}
-	}
-	return [names, values];
-};
-/** getElement(id) : HTMLElement */
-Freja._aux.getElement = function(id) {
-	if (typeof(id) == &quot;object&quot;) {
-		return id;
-	} else {
-		return document.getElementById(id);
-	}
-};
-
-/** connect(src, signal, fnc) : void */
-Freja._aux.connect = function(src, signal, fnc) {
-
-	if(!src) return;
-	if (src.addEventListener) {
-		var wrapper = function(e) {
-			var evt = {
-				stop : function() {
-					if (e.cancelable) {
-						e.preventDefault();
-					}
-					e.stopPropagation();
-				}
-			}
-			fnc(evt);
-		}
-		src.addEventListener(signal.replace(/^(on)/, &quot;&quot;), wrapper, false);
-	} else if (src.attachEvent) {
-		var wrapper = function() {
-			var e = window.event;
-			var evt = {
-				stop : function() {
-					e.cancelBubble = true;
-					e.returnValue = false;
-				}
-			}
-			fnc(evt);
-		}
-		src.attachEvent(signal, wrapper);
-	}
-	if (!src._signals) {
-		src._signals = [];
-	}
-	if (!src._signals[signal]) {
-		src._signals[signal] = [];
-	}
-	src._signals[signal].push(fnc);
-};
-/** signal(src, signal, ...) : void */
-Freja._aux.signal = function(src, signal) {
-
-	try {
-		var sigs = src._signals[signal];
-		var args = [];
-		for (var i=2; i &lt; arguments.length; i++) {
-			args.push(arguments[i]);
-		}
-		for (var i=0; i &lt; sigs.length; i++) {
-			try {
-				sigs[i].apply(src, args);
-			} catch (e) { /* squelch */ }
-		}
-	} catch (e) { /* squelch */ }
-};
-/** createDeferred() : Deferred */
-Freja._aux.createDeferred = function() {
-	return new Freja._aux.Deferred();
-};
-/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
-Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); }
-	catch (e) { try { req = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error(&quot;Can't create XMLHttpRequest&quot;);
-	if (user &amp;&amp; pass) {
-		req.open(method, url, async, user, pass);
-	} else {
-		req.open(method, url, async);
-	}
-	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
-		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
-	}
-	return req;
-};
-/** sendXMLHttpRequest(req, sendContent) : Deferred */
-Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
-	var d = Freja._aux.createDeferred();
-	var bComplete = false;
-	req.onreadystatechange = function() {
-		if (req.readyState == 4 &amp;&amp; !bComplete) {
-			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
-				d.callback(req);
-			} else {
-				d.errback(req);
-			}
-			bComplete = true;
-		}
-	}
-	if (!sendContent) sendContent = &quot;&quot;;
-	req.send(sendContent);
-	return d;
-};
-/** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
-			.replace(/&lt;/g, &quot;&lt;&quot;)
-			.replace(/&gt;/g, &quot;&gt;&quot;)
-			.replace(/&quot;/g, &quot;&quot;&quot;)
-			.replace(/'/g, &quot;&apos;&quot;);
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '&lt;' + objectName + '&gt;';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(&quot;&quot;+anyObject);
-		isLeaf = true;
-	} else {
-		s += &quot;\n&quot;;
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? &quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot; : name), indentSpace + &quot;   &quot;);
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? &quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
-};
-/** serializeXML(node) : string */
-Freja._aux.serializeXML = function(node) {
-	if (node.xml) return node.xml;
-	return (new XMLSerializer()).serializeToString(node);
-};
-/** loadXML(string) : XMLDocument */
-Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject(&quot;Msxml2.DOMDocument&quot;);
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
-		return xmlDoc;
-	}
-	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
-};
-/** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != &quot;undefined&quot;) {
-		// set the parameters
-		for (var paramName in xslParameters) {
-			xsl.setProperty (&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
-			var paramNode = xsl.selectSingleNode(&quot;//xsl:param[@name='&quot;+ paramName +&quot;']&quot;);
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
-		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode(&quot;//xsl:param[@name='&quot;+ paramName +&quot;']&quot;);
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
-	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
-};
-/** cloneXMLDocument(document) : XMLDocument */
-Freja._aux.cloneXMLDocument = function(xmlDoc) {
-	var clone = null;
-	try {
-		clone = xmlDoc.cloneNode(true);
-	} catch(e) { /* squelch */ }
-
-	// Can't clone a DocumentNode in Safari &amp; Opera. Let's try something else.
-	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
-	if (!clone) {
-		if (document.implementation &amp;&amp; document.implementation.createDocument) {
-			clone = document.implementation.createDocument(&quot;&quot;, xmlDoc.documentElement.nodeName, null);
-			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
-			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
-			try {
-				clone.appendChild(data);
-			} catch(e) {
-				// Opera has already created a documentElement and can't append another root node
-				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i &gt;= 0; i--) {
-					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
-				}
-				// need to copy root node attributes
-				for (var i = 0; i &lt; xmlDoc.documentElement.attributes.length; i++) {
-					var name  = xmlDoc.documentElement.attributes.item(i).name;
-					var value = xmlDoc.documentElement.attributes.item(i).value;
-					clone.documentElement.setAttribute(name, value);
-				}
-			}
-		}
-	}
-	return clone;
-};
-/** hasSupportForXSLT() : boolean */
-Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
-/** createQueryEngine() : Freja.QueryEngine */
-Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;))) {
-		return new Freja.QueryEngine.XPath();
-	} else {
-		return new Freja.QueryEngine.SimplePath();
-	}
-};
-/** A pale replacement for MochiKit.Async.Deferred */
-Freja._aux.Deferred = function() {
-	this._good = [];
-	this._bad = [];
-	this._pending = null;
-};
-Freja._aux.Deferred.prototype.callback = function() {
-	if (this._good.length == 0) {
-		this._pending = [this.callback, arguments];
-		return;
-	}
-	for (var i=0; i &lt; this._good.length; i++) {
-		this._good[i].apply(window, arguments);
-	}
-	this._good = [];
-};
-Freja._aux.Deferred.prototype.errback = function() {
-	if (this._bad.length == 0) {
-		this._pending = [this.errback, arguments];
-		return;
-	}
-	for (var i=0; i &lt; this._bad.length; i++) {
-		this._bad[i].apply(window, arguments);
-	}
-	this._bad = [];
-};
-Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
-	if (fncOK) this._good[this._good.length] = fncOK;
-	if (fncError) this._bad[this._bad.length] = fncError;
-	if (this._pending) {
-		this._pending[0].apply(this, this._pending[1]);
-	}
-};
-Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
-	this.addCallbacks(fncOK);
-};
-Freja._aux.Deferred.prototype.addErrback = function(fncError) {
-	this.addCallbacks(null, fncError);
-};
-if (document.implementation &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)) {
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
-
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error(&quot;Can't evaluate expression &quot; + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i &lt; 0 || i &gt;= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i &lt; nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error(&quot;Method selectNodes is only supported by XML Elements&quot;);
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = &quot;(&quot;+sExpr+&quot;)[1]&quot;;
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length &gt; 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error(&quot;Method selectNodes is only supported by XML Elements&quot;);
-		}
-	};
-};
-
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
-        };
-    };
-    throw &quot;Could not retrieve a valid progID.&quot;;
-}
-
-if(typeof XSLTProcessor == 'undefined' &amp;&amp; typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.DOMDocument.5.0&quot;, &quot;Msxml2.DOMDocument.4.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.XMLHTTP.5.0&quot;, &quot;Msxml2.XMLHTTP.4.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.FreeThreadedDOMDocument.5.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.4.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.XSLTemplate.5.0&quot;, &quot;Msxml2.XSLTemplate.4.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[&quot;&quot;+nsURI]){
-	        this.paramsSet[&quot;&quot;+nsURI] = new Array();
-	    };
-	    this.paramsSet[&quot;&quot;+nsURI][name] = value;
-	};
-
-}
-
-
-/**
-  * The baseclass for queryengines
-  * @abstract
-  */
-Freja.QueryEngine = function() {};
-Freja.QueryEngine.prototype.getElementById = function(document, id) {
-	// getElementById doesn't work on XML document without xml:id
-	var allElements = document.getElementsByTagName(&quot;*&quot;);
-	for (var i= 0; i &lt; allElements.length; i++) {
-		if (allElements[i].getAttribute(&quot;id&quot;) == id) {
-			return allElements[i];
-		}
-	}
-};
-Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
-	}
-	if(node) return node.nodeValue;
-
-};
-Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
-			}
-			// else parent element does not exist.. can't do anything
-		}
-	}
-};
-/**
-  * XPath query engine.
-  */
-Freja.QueryEngine.XPath = function() {};
-Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node &amp;&amp; node.nodeType == 2) {
-		return node;
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error(&quot;Can't evaluate expression &quot; + expression);
-	return null;
-};
-/**
-  * SimplePath
-  */
-Freja.QueryEngine.SimplePath = function() {};
-Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
-Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
-	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
-		throw new Error(&quot;Can't evaluate expression &quot; + expression);
-	}
-	var parts = expression.split(/\//);
-	var node = document;
-	var regAttr = new RegExp(&quot;^@([\\d\\w]*)&quot;);
-	var regOffset = new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
-	var regFilter = new RegExp(&quot;^([\\d\\w]+)\\[@([@\\d\\w]+)=['\&quot;]{1}(.*)['\&quot;]{1}\\]$&quot;);
-	var attr = null;
-	var offset = 0;
-	for (var i = 0; i &lt; parts.length; ++i) {
-		var part = parts[i];
-		var filter = regFilter.exec(part);
-		if(filter) {
-			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
-			if(i&gt;0 &amp;&amp; parts[i-1]=='') {
-				// expression was of type //element[...]
-				var cn = node.getElementsByTagName(filter[1]);
-			} else {
-				var cn = node.childNodes;
-			}
-			for(var j=0, l=cn.length; j&lt;l ; j++) {
-				if(cn[j].nodeType==1 &amp;&amp; cn[j].tagName==filter[1] &amp;&amp; cn[j].getAttribute(filter[2])== filter[3]) {
-					node = cn[j];
-					break;
-				}
-			}
-			if (j==l)
-				throw new Error(&quot;Can't evaluate expression &quot; + part);
-		}
-		else {
-			offset = regOffset.exec(part);
-			if (offset) {
-				part = offset[1];
-				offset = offset[2] - 1;
-			} else {
-				offset = 0;
-			}
-			if (part != &quot;&quot;) {
-				attr = regAttr.exec(part);
-				if (attr) {
-					node = node.getAttributeNode(attr[1]);
-				} else {
-					node = node.getElementsByTagName(part).item(offset);
-				}
-			}
-		}
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	if (!node) {
-		throw new Error(&quot;Can't evaluate expression &quot; + expression);
-	}
-	return node;
-};
-/**
-  * Standard model component
-  */
-Freja.Model = function(url, query) {
-	this.url = url;
-	this.ready = false;
-	this.document = null;
-	this._query = query;
-};
-/**
-  * Returns a single value
-  */
-Freja.Model.prototype.getElementById = function(id) {
-	if (this.document) {
-		return this._query.getElementById(this.document, id);
-	}
-	return null;
-};
-/**
-  * Returns a single value
-  */
-Freja.Model.prototype.get = function(expression) {
-	if (this.document) {
-		return this._query.get(this.document, expression);
-	}
-	return null;
-};
-/**
-  * Updates a value
-  */
-Freja.Model.prototype.set = function(expression, value) {
-	if (this.document) {
-		return this._query.set(this.document, expression, value);
-	}
-	return null;
-};
-/**
-  * Updates the model from a view
-  */
-Freja.Model.prototype.updateFrom = function(view) {
-	var values = view.getValues();
-	for (var i = 0; i &lt; values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
-	}
-};
-/**
-  * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.save = function() {
-	var url = this.url;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	// since the serialization may fail, we create a deferred for the
-	// purpose, rather than just returning the sendXMLHttpRequest directly.
-	var d = Freja._aux.createDeferred();
-	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, url);
-	try {
-		// for some obscure reason exceptions aren't thrown back if I call the
-		// shorthand version of sendXMLHttpRequest in IE6.
-		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.remove = function() {
-	var url = this.url;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var req = Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;, url);
-	return Freja._aux.sendXMLHttpRequest(req);
-};
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.reload = function() {
-	this.ready = false;
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, &quot;onload&quot;);
-	}, this);
-	var d = Freja.AssetManager.loadAsset(this.url, true);
-	d.addCallbacks(onload, Freja.AssetManager.onerror);
-	return d;
-};
-/**
-  * DataSource provides a gateway-type interface to a REST service.
-  */
-Freja.Model.DataSource = function(createURL, indexURL) {
-	this.createURL = createURL;
-	this.indexURL = indexURL;
-};
-/**
-  * Returns a list of primary-keys to records in the datasource
-  */
-Freja.Model.DataSource.prototype.select = function() {
-	return getModel(this.indexURL);
-};
-/**
-  * Creates a new instance of a record
-  * @todo errback to the deferred on errors
-  */
-Freja.Model.DataSource.prototype.create = function(values) {
-	var url = this.createURL;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var req = Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;, url);
-	var payload = {};
-	for (var i = 0, len = values[0].length; i &lt; len; ++i) {
-		payload[values[0][i]] = values[1][i];
-	}
-	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
-};
-
-/**
-  * Standard view component
-  */
-Freja.View = function(url, renderer) {
-	this.url = url;
-	this.ready = false;
-	this.document = null;
-	this._renderer = renderer;
-	this._destination = null;
-	this.behaviors = [];
-	this.placeholder = null;
-	Freja._aux.connect(this, &quot;onrendercomplete&quot;, Freja._aux.bind(this._connectBehavior, this));
-};
-/**
-  * @param    model            Freja.Model
-  * @param    placeholder      string    If supplied, this will be used instead of the
-  *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.prototype.render = function(model, placeholder, xslParameters) {
-	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
-	if (typeof(xslParameters) == &quot;undefined&quot;) xslParameters = this.xslParameters;
-
-	var Handler = function(model, view, deferred, xslParameters) {
-		this.model = model;
-		this.view = view;
-		this.deferred = deferred;
-		this.xslParameters = xslParameters;
-	};
-	Handler.prototype.trigger = function() {
-		try {
-			if (!this.view.ready) {
-				Freja._aux.connect(this.view, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
-				return;
-			}
-			if (typeof(this.model) == &quot;object&quot; &amp;&amp; this.model instanceof Freja.Model &amp;&amp; !this.model.ready) {
-				Freja._aux.connect(this.model, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
-				return;
-			}
-			var model;
-			if (typeof(this.model) == &quot;undefined&quot;) {
-				// supply dummy
-				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
-			} else if (this.model instanceof Freja.Model) {
-				model = this.model;
-			} else {
-				// wrap pojo's in
-				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot; + Freja._aux.xmlize(this.model, &quot;item&quot;)) };
-			}
-
-			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
-			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
-			}, this.view));
-			trans.addCallback(Freja._aux.bind(function() {
-				Freja._aux.signal(this, &quot;onrendercomplete&quot;, this._destination)
-			}, this.view));
-			trans.addCallback(this.deferred.callback);
-			trans.addErrback(this.deferred.errback);
-		} catch (ex) {
-			this.deferred.errback(ex);
-		}
-	};
-
-	var d = Freja._aux.createDeferred();
-	try {
-		this._destination = Freja._aux.getElement(placeholder);
-		// @todo    Is this a good idea ?
-		// Perhaps we should leave it to the programmer to do this.
-		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
-
-		var h = new Handler(model, this, d, xslParameters);
-		h.trigger();
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * Decorates the output of the primary renderer, to inject behavior.
-  * @note Maybe we could use cssQuery (<A HREF="http://dean.edwards.name/my/cssQuery/">http://dean.edwards.name/my/cssQuery/</A>)
-  *       to identify targets for behavior
-  */
-Freja.View.prototype._connectBehavior = function(destination) {
-	try {
-		var connectCallback = function(node, eventType, callback) {
-
-			Freja._aux.connect(node, eventType, Freja._aux.bind(
-				function(e) {
-					var allow = false;
-					try {
-						allow = callback(this);
-					} catch (ex) {
-						throw new Error(&quot;An error ocurred in user handler.\n&quot; + ex.message);
-					} finally {
-						if (!allow) {
-							e.stop();
-						}
-					}
-				}, node)
-			);
-		};
-		var applyHandlers = function(node, behaviors) {
-			for (var i = 0, c = node.childNodes, l = c.length; i &lt; l; ++i) {
-				var child = c[i];
-				if (child.nodeType == 1) {
-					if(child.className) {
-						var classNames = child.className.split(' ');
-						for (var j=0;j&lt;classNames.length;j++) {
-							var handler = behaviors[classNames[j]];
-							if (handler) {
-								for (var eventType in handler) {
-									if (eventType == &quot;init&quot;) {
-										handler.init(child);
-									} else {
-										connectCallback(child, eventType, handler[eventType]);
-									}
-								}
-							}
-						}
-					}
-					applyHandlers(child, behaviors);
-				}
-			}
-		};
-
-		// Avoid traversing the DOM tree if there's no handler to process.
-		// @note: is there a better way? this.behaviors.length is always 0.
-		// @note  This is fine. behaviors is a hashmap, not an array.
-		for (var ids in this.behaviors) {
-			applyHandlers(destination, this.behaviors);
-			break;
-		}
-
-	} catch (ex) {
-		alert(ex.message);
-	}
-};
-/**
-  * Returns the values of a formview
-  */
-Freja.View.prototype.getValues = function() {
-	return Freja._aux.formContents(this._destination);
-};
-/**
-  * Base object for viewrenderers
-  */
-Freja.View.Renderer = function() {};
-/**
-  * XSLT based render-engine
-  */
-Freja.View.Renderer.XSLTransformer = function() {};
-Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
-        var d = Freja._aux.createDeferred();
-        try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!html) {
-			d.errback(new Error(&quot;XSL Transformation error.&quot;));
-		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// &lt;xsl:output method=&quot;html&quot; /&gt;
-			// (cedsav) don't remember all the details but method=&quot;xml&quot; is the way to go.
-			// method=&quot;html&quot; would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/&lt;textarea([^&gt;]*)\/&gt;/gi,&quot;&lt;textarea $1&gt;&lt;/textarea&gt;&quot;);
-			d.callback(html);
-		}
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * XSLT on a remote service for browser which have no native support.
-  * @param    url    URL of the transform service
-  */
-Freja.View.Renderer.RemoteXSLTransformer = function(url) {
-	this.url = url;
-};
-Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
-        var d = Freja._aux.createDeferred();
-
-	// prepare posted data  (no need to send the XSL document, just its url)
-	var xslUrl = view.url;
-	var postedData = &quot;xslFile=&quot; + encodeURIComponent(xslUrl) + &quot;&amp;xmlData=&quot; + encodeURIComponent(Freja._aux.serializeXML(model.document));
-
-	var xslParameterString = '';
-	for (var paramname in xslParameters) {
-		xslParameterString += encodeURIComponent(paramname + &quot;,&quot; + xslParameters[paramname]);
-	}
-	if(xslParameterString.length &gt; 0) {
-		postedData  = postedData + '&amp;xslParam=' + xslParameterString;
-	}
-
-	// send request to the server-side XSL transformation service
-	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, Freja.AssetManager.XSLT_SERVICE_URL);
-	req.onreadystatechange = function() {
-		if (req.readyState == 4) {
-			if (req.status == 200) {
-				d.callback(req.responseText);
-			} else {
-				d.errback(req.responseText);
-			}
-		}
-	}
-	req.send(postedData);
-	return d;
-};
-/**
-  * This is largely s copied with minor stylistic adjustments from Freja 1.1
-  * I renamed it from Controller.history to distinguish between window.history
-  */
-Freja.UndoHistory = function() {
-	this.cache = [];
-	this.maxLength = 5;
-	this._position = 0;
-	this._undoSteps = 0;
-};
-/**
-  * Creates a snapshot of the model and stores it.
-  */
-Freja.UndoHistory.prototype.add = function(model) {
-	var historyIndex = this._position % this.maxLength;
-
-	var modelDoc = model.document;
-	this.cache[historyIndex] = {};
-	this.cache[historyIndex].model = model;
-	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
-
-	if (!this.cache[historyIndex].document) {
-		throw new Error(&quot;Couldn't add to history.&quot;);
-	} else {
-		this._position++;
-		// clear rest of the history if undo was used.
-		var clearHistoryIndex = historyIndex;
-		while (this._undoSteps &gt; 0) {
-			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
-			this.cache[clearHistoryIndex] = {};
-			this._undoSteps--;
-		}
-		return historyIndex; // what would anybody need this for ?
-	}
-};
-/**
-  * Rolls the state back one step.
-  */
-Freja.UndoHistory.prototype.undo = function(steps) {
-	if (this._undoSteps &lt; this.cache.length) {
-		this._undoSteps++;
-		this._position--;
-		if (this._position &lt; 0) {
-			this._position = this.maxLength - 1;
-		}
-
-		var model = this.cache[this._position].model;
-		if (this.cache[this._position].document) {
-			model.document = this.cache[this._position].document;
-		} else {
-			throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
-		}
-		if (typeof(steps) != &quot;undefined&quot; &amp;&amp; steps &gt; 1) {
-			this.undo(steps - 1);
-		}
-	} else {
-		throw new Error(&quot;Nothing to undo&quot;);
-	}
-};
-/**
-  * Reverts the effects of undo.
-  */
-Freja.UndoHistory.prototype.redo = function() {
-	if (this._undoSteps &gt; 0) {
-		this._undoSteps--;
-		this._position = (this._position + 1) % this.maxLength;
-
-		var model = this.cache[this._position].model;
-		model.document = this.cache[this._position].document;
-	} else {
-		throw new Error(&quot;Nothing to redo&quot;);
-	}
-};
-/**
-  * Removes the last entry in the cache
-  */
-Freja.UndoHistory.prototype.removeLast = function() {
-	this._position--;
-
-	if (this._position &lt; 0) {
-		this._position = this.maxLength - 1;
-	}
-	this.cache[this._position] = {};
-	this._undoSteps = 0;
-};
-
-/**
-  * main repository
-  * @static
-  */
-Freja.AssetManager = {
-	models : [],
-	views : [],
-	_username : null,
-	_password : null
-};
-/**
-  * Set to sync to make all requests synchroneous. You shouldn't use
-  * this setting for anything but testing/debugging.
-  * &quot;async&quot; | &quot;sync&quot;
-  */
-Freja.AssetManager.HTTP_REQUEST_TYPE = &quot;async&quot;;
-/**
-  * If this is set to null, real PUT and DELETE http-requests will be made,
-  * otherwise a header will be set instead, and the request tunneled through
-  * POST.
-  *
-  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
-  * if theese are your target platform, you can disable tunneling.
-  */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
-/**
-  * Set this url to provide remote xslt-transformation for browsers that
-  * doesn't support it natively.
-  */
-Freja.AssetManager.XSLT_SERVICE_URL = &quot;srvc-xslt.php&quot;;
-/**
-  * HTML displayed while waiting for stuff to happen
-  */
-Freja.AssetManager.THROBBER_HTML = &quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
-/**
-  * returns an instance of the renderengine to use
-  */
-Freja.AssetManager.createRenderer = function() {
-//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
-	if (Freja._aux.hasSupportForXSLT()) {
-		return new Freja.View.Renderer.XSLTransformer();
-	} else {
-		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
-	}
-};
-/**
-  * Wipes all caches. This isn't something you will normally use during production,
-  * but it's very helpful for debugging/testing
-  */
-Freja.AssetManager.clearCache = function() {
-	this.models = [];
-	this.views = [];
-};
-/**
-  * Load a model-component
-  * @param    url      string
-  */
-Freja.AssetManager.getModel = function(url) {
-	for (var i=0; i &lt; this.models.length; i++) {
-		if (this.models[i].url == url) {
-			return this.models[i];
-		}
-	}
-	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, &quot;onload&quot;);
-	}, m);
-	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
-	this.models.push(m);
-	return m;
-};
-/**
-  * Load a view-component
-  * @param    url      string
-  */
-Freja.AssetManager.getView = function(url) {
-	for (var i=0; i &lt; this.views.length; i++) {
-		if (this.views[i].url == url) {
-			return this.views[i];
-		}
-	}
-	var v = new Freja.View(url, this.createRenderer());
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, &quot;onload&quot;);
-	}, v);
-	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
-	this.views.push(v);
-	return v;
-};
-/**
-  * Creates and opens a http-request, tunneling exotic methods if needed.
-  */
-Freja.AssetManager.openXMLHttpRequest = function(method, url) {
-	var tunnel = null;
-	if (Freja.AssetManager.HTTP_METHOD_TUNNEL &amp;&amp; method != &quot;GET&quot; &amp;&amp; method != &quot;POST&quot;) {
-		tunnel = method;
-		method = &quot;POST&quot;;
-	}
-	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
-	if (tunnel) {
-		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
-	}
-	return req;
-};
-/**
-  * Sets username + password for Http-Authentication
-  */
-Freja.AssetManager.setCredentials = function(username, password) {
-	this._username = username;
-	this._password = password;
-};
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.AssetManager.loadAsset = function(url, preventCaching) {
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var d = Freja._aux.createDeferred();
-	var handler = function(transport) {
-		try {
-			if (transport.responseText == &quot;&quot;) {
-				throw new Error(&quot;Empty response.&quot;);
-			}
-			if (transport.responseXML.xml == &quot;&quot;) {
-				// The server doesn't reply with Content-Type: text/xml
-				// this will happen if the file is loaded locally (through <A HREF="file://">file://</A>)
-				var document = Freja._aux.loadXML(transport.responseText);
-			} else {
-				var document = transport.responseXML;
-			}
-		} catch (ex) {
-			d.errback(ex);
-		}
-		d.callback(document);
-	};
-	try {
-		// Why using HTTP_METHOD_TUNNEL for a GET?
-		//-- to prevent caching, since browsers won't cache a POST
-		if (preventCaching &amp;&amp; Freja.AssetManager.HTTP_METHOD_TUNNEL) {
-			var req = Freja._aux.openXMLHttpRequest(&quot;POST&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
-			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, &quot;GET&quot;);
-			req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
-		} else {
-			var req = Freja._aux.openXMLHttpRequest(&quot;GET&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
-		}
-
-		// This shouldn't be nescesary, but alas it is - firefox chokes
-		// It's probably due to an error in MochiKit, so the problem
-		// should be fixed there.
-		var comm = Freja._aux.sendXMLHttpRequest(req);
-		if (Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;) {
-			// fixes bug #7189 (<A HREF="http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189">http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189</A>)
-			comm.addCallbacks(handler, function(req) {
-				d.errback(new Error(&quot;Request failed:&quot; + req.status));
-			});
-		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
-				handler(req);
-			} else {
-				d.errback(new Error(&quot;Request failed:&quot; + req.status));
-			}
-		}
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * This is a default error-handler. You should provide your own.
-  * The handler is called if an asynchronous error happens, since
-  * this could not be caught with the usual try ... catch
-  *
-  * It ought to be replaced completely with Deferred
-  */
-Freja.AssetManager.onerror = function(ex) {
-	alert(&quot;Freja.AssetManager.onerror\n&quot; + ex.message);
-};
-/**
-  * Global exports
-  */
-window.getModel = Freja._aux.bind(&quot;getModel&quot;, Freja.AssetManager);
-window.getView = Freja._aux.bind(&quot;getView&quot;, Freja.AssetManager);
\ No newline at end of file

Deleted: trunk/lib/MochiKit.js
===================================================================
--- trunk/lib/MochiKit.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/MochiKit.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,4802 +0,0 @@
-/***
-
-    MochiKit.MochiKit 1.3.1 : PACKED VERSION
-
-    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
-    diff against the source tree, not this file.
-
-    See &lt;<A HREF="http://mochikit.com/">http://mochikit.com/</A>&gt; for documentation, downloads, license, etc.
-
-    (c) 2005 Bob Ippolito.  All rights Reserved.
-
-***/
-
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Base&quot;);
-}
-if(typeof (MochiKit)==&quot;undefined&quot;){
-MochiKit={};
-}
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-MochiKit.Base={};
-}
-MochiKit.Base.VERSION=&quot;1.3.1&quot;;
-MochiKit.Base.NAME=&quot;MochiKit.Base&quot;;
-MochiKit.Base.update=function(_1,_2){
-if(_1===null){
-_1={};
-}
-for(var i=1;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!=&quot;undefined&quot;&amp;&amp;o!==null){
-for(var k in o){
-_1[k]=o[k];
-}
-}
-}
-return _1;
-};
-MochiKit.Base.update(MochiKit.Base,{__repr__:function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-},toString:function(){
-return this.__repr__();
-},counter:function(n){
-if(arguments.length===0){
-n=1;
-}
-return function(){
-return n++;
-};
-},clone:function(_7){
-var me=arguments.callee;
-if(arguments.length==1){
-me.prototype=_7;
-return new me();
-}
-},flattenArguments:function(_9){
-var res=[];
-var m=MochiKit.Base;
-var _12=m.extend(null,arguments);
-while(_12.length){
-var o=_12.shift();
-if(o&amp;&amp;typeof (o)==&quot;object&quot;&amp;&amp;typeof (o.length)==&quot;number&quot;){
-for(var i=o.length-1;i&gt;=0;i--){
-_12.unshift(o[i]);
-}
-}else{
-res.push(o);
-}
-}
-return res;
-},extend:function(_13,obj,_15){
-if(!_15){
-_15=0;
-}
-if(obj){
-var l=obj.length;
-if(typeof (l)!=&quot;number&quot;){
-if(typeof (MochiKit.Iter)!=&quot;undefined&quot;){
-obj=MochiKit.Iter.list(obj);
-l=obj.length;
-}else{
-throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
-}
-}
-if(!_13){
-_13=[];
-}
-for(var i=_15;i&lt;l;i++){
-_13.push(obj[i]);
-}
-}
-return _13;
-},updatetree:function(_17,obj){
-if(_17===null){
-_17={};
-}
-for(var i=1;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!=&quot;undefined&quot;&amp;&amp;o!==null){
-for(var k in o){
-var v=o[k];
-if(typeof (_17[k])==&quot;object&quot;&amp;&amp;typeof (v)==&quot;object&quot;){
-arguments.callee(_17[k],v);
-}else{
-_17[k]=v;
-}
-}
-}
-}
-return _17;
-},setdefault:function(_19,obj){
-if(_19===null){
-_19={};
-}
-for(var i=1;i&lt;arguments.length;i++){
-var o=arguments[i];
-for(var k in o){
-if(!(k in _19)){
-_19[k]=o[k];
-}
-}
-}
-return _19;
-},keys:function(obj){
-var _20=[];
-for(var _21 in obj){
-_20.push(_21);
-}
-return _20;
-},items:function(obj){
-var _22=[];
-var e;
-for(var _24 in obj){
-var v;
-try{
-v=obj[_24];
-}
-catch(e){
-continue;
-}
-_22.push([_24,v]);
-}
-return _22;
-},_newNamedError:function(_25,_26,_27){
-_27.prototype=new MochiKit.Base.NamedError(_25.NAME+&quot;.&quot;+_26);
-_25[_26]=_27;
-},operator:{truth:function(a){
-return !!a;
-},lognot:function(a){
-return !a;
-},identity:function(a){
-return a;
-},not:function(a){
-return ~a;
-},neg:function(a){
-return -a;
-},add:function(a,b){
-return a+b;
-},sub:function(a,b){
-return a-b;
-},div:function(a,b){
-return a/b;
-},mod:function(a,b){
-return a%b;
-},mul:function(a,b){
-return a*b;
-},and:function(a,b){
-return a&b;
-},or:function(a,b){
-return a|b;
-},xor:function(a,b){
-return a^b;
-},lshift:function(a,b){
-return a&lt;&lt;b;
-},rshift:function(a,b){
-return a&gt;&gt;b;
-},zrshift:function(a,b){
-return a&gt;&gt;&gt;b;
-},eq:function(a,b){
-return a==b;
-},ne:function(a,b){
-return a!=b;
-},gt:function(a,b){
-return a&gt;b;
-},ge:function(a,b){
-return a&gt;=b;
-},lt:function(a,b){
-return a&lt;b;
-},le:function(a,b){
-return a&lt;=b;
-},ceq:function(a,b){
-return MochiKit.Base.compare(a,b)===0;
-},cne:function(a,b){
-return MochiKit.Base.compare(a,b)!==0;
-},cgt:function(a,b){
-return MochiKit.Base.compare(a,b)==1;
-},cge:function(a,b){
-return MochiKit.Base.compare(a,b)!=-1;
-},clt:function(a,b){
-return MochiKit.Base.compare(a,b)==-1;
-},cle:function(a,b){
-return MochiKit.Base.compare(a,b)!=1;
-},logand:function(a,b){
-return a&amp;&b;
-},logor:function(a,b){
-return a||b;
-},contains:function(a,b){
-return b in a;
-}},forwardCall:function(_30){
-return function(){
-return this[_30].apply(this,arguments);
-};
-},itemgetter:function(_31){
-return function(arg){
-return arg[_31];
-};
-},typeMatcher:function(){
-var _33={};
-for(var i=0;i&lt;arguments.length;i++){
-var typ=arguments[i];
-_33[typ]=typ;
-}
-return function(){
-for(var i=0;i&lt;arguments.length;i++){
-if(!(typeof (arguments[i]) in _33)){
-return false;
-}
-}
-return true;
-};
-},isNull:function(){
-for(var i=0;i&lt;arguments.length;i++){
-if(arguments[i]!==null){
-return false;
-}
-}
-return true;
-},isUndefinedOrNull:function(){
-for(var i=0;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(!(typeof (o)==&quot;undefined&quot;||o===null)){
-return false;
-}
-}
-return true;
-},isEmpty:function(obj){
-return !MochiKit.Base.isNotEmpty.apply(this,arguments);
-},isNotEmpty:function(obj){
-for(var i=0;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(!(o&amp;&amp;o.length)){
-return false;
-}
-}
-return true;
-},isArrayLike:function(){
-for(var i=0;i&lt;arguments.length;i++){
-var o=arguments[i];
-var typ=typeof (o);
-if((typ!=&quot;object&quot;&amp;&amp;!(typ==&quot;function&quot;&amp;&amp;typeof (o.item)==&quot;function&quot;))||o===null||typeof (o.length)!=&quot;number&quot;){
-return false;
-}
-}
-return true;
-},isDateLike:function(){
-for(var i=0;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!=&quot;object&quot;||o===null||typeof (o.getTime)!=&quot;function&quot;){
-return false;
-}
-}
-return true;
-},xmap:function(fn){
-if(fn===null){
-return MochiKit.Base.extend(null,arguments,1);
-}
-var _36=[];
-for(var i=1;i&lt;arguments.length;i++){
-_36.push(fn(arguments[i]));
-}
-return _36;
-},map:function(fn,lst){
-var m=MochiKit.Base;
-var itr=MochiKit.Iter;
-var _39=m.isArrayLike;
-if(arguments.length&lt;=2){
-if(!_39(lst)){
-if(itr){
-lst=itr.list(lst);
-if(fn===null){
-return lst;
-}
-}else{
-throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
-}
-}
-if(fn===null){
-return m.extend(null,lst);
-}
-var _40=[];
-for(var i=0;i&lt;lst.length;i++){
-_40.push(fn(lst[i]));
-}
-return _40;
-}else{
-if(fn===null){
-fn=Array;
-}
-var _41=null;
-for(i=1;i&lt;arguments.length;i++){
-if(!_39(arguments[i])){
-if(itr){
-return itr.list(itr.imap.apply(null,arguments));
-}else{
-throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
-}
-}
-var l=arguments[i].length;
-if(_41===null||_41&gt;l){
-_41=l;
-}
-}
-_40=[];
-for(i=0;i&lt;_41;i++){
-var _42=[];
-for(var j=1;j&lt;arguments.length;j++){
-_42.push(arguments[j][i]);
-}
-_40.push(fn.apply(this,_42));
-}
-return _40;
-}
-},xfilter:function(fn){
-var _44=[];
-if(fn===null){
-fn=MochiKit.Base.operator.truth;
-}
-for(var i=1;i&lt;arguments.length;i++){
-var o=arguments[i];
-if(fn(o)){
-_44.push(o);
-}
-}
-return _44;
-},filter:function(fn,lst,_45){
-var _46=[];
-var m=MochiKit.Base;
-if(!m.isArrayLike(lst)){
-if(MochiKit.Iter){
-lst=MochiKit.Iter.list(lst);
-}else{
-throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
-}
-}
-if(fn===null){
-fn=m.operator.truth;
-}
-if(typeof (Array.prototype.filter)==&quot;function&quot;){
-return Array.prototype.filter.call(lst,fn,_45);
-}else{
-if(typeof (_45)==&quot;undefined&quot;||_45===null){
-for(var i=0;i&lt;lst.length;i++){
-var o=lst[i];
-if(fn(o)){
-_46.push(o);
-}
-}
-}else{
-for(i=0;i&lt;lst.length;i++){
-o=lst[i];
-if(fn.call(_45,o)){
-_46.push(o);
-}
-}
-}
-}
-return _46;
-},_wrapDumbFunction:function(_47){
-return function(){
-switch(arguments.length){
-case 0:
-return _47();
-case 1:
-return _47(arguments[0]);
-case 2:
-return _47(arguments[0],arguments[1]);
-case 3:
-return _47(arguments[0],arguments[1],arguments[2]);
-}
-var _48=[];
-for(var i=0;i&lt;arguments.length;i++){
-_48.push(&quot;arguments[&quot;+i+&quot;]&quot;);
-}
-return eval(&quot;(func(&quot;+_48.join(&quot;,&quot;)+&quot;))&quot;);
-};
-},method:function(_49,_50){
-var m=MochiKit.Base;
-return m.bind.apply(this,m.extend([_50,_49],arguments,2));
-},bind:function(_51,_52){
-if(typeof (_51)==&quot;string&quot;){
-_51=_52[_51];
-}
-var _53=_51.im_func;
-var _54=_51.im_preargs;
-var _55=_51.im_self;
-var m=MochiKit.Base;
-if(typeof (_51)==&quot;function&quot;&amp;&amp;typeof (_51.apply)==&quot;undefined&quot;){
-_51=m._wrapDumbFunction(_51);
-}
-if(typeof (_53)!=&quot;function&quot;){
-_53=_51;
-}
-if(typeof (_52)!=&quot;undefined&quot;){
-_55=_52;
-}
-if(typeof (_54)==&quot;undefined&quot;){
-_54=[];
-}else{
-_54=_54.slice();
-}
-m.extend(_54,arguments,2);
-var _56=function(){
-var _57=arguments;
-var me=arguments.callee;
-if(me.im_preargs.length&gt;0){
-_57=m.concat(me.im_preargs,_57);
-}
-var _52=me.im_self;
-if(!_52){
-_52=this;
-}
-return me.im_func.apply(_52,_57);
-};
-_56.im_self=_55;
-_56.im_func=_53;
-_56.im_preargs=_54;
-return _56;
-},bindMethods:function(_58){
-var _59=MochiKit.Base.bind;
-for(var k in _58){
-var _60=_58[k];
-if(typeof (_60)==&quot;function&quot;){
-_58[k]=_59(_60,_58);
-}
-}
-},registerComparator:function(_61,_62,_63,_64){
-MochiKit.Base.comparatorRegistry.register(_61,_62,_63,_64);
-},_primitives:{&quot;bool&quot;:true,&quot;string&quot;:true,&quot;number&quot;:true},compare:function(a,b){
-if(a==b){
-return 0;
-}
-var _65=(typeof (a)==&quot;undefined&quot;||a===null);
-var _66=(typeof (b)==&quot;undefined&quot;||b===null);
-if(_65&amp;&amp;_66){
-return 0;
-}else{
-if(_65){
-return -1;
-}else{
-if(_66){
-return 1;
-}
-}
-}
-var m=MochiKit.Base;
-var _67=m._primitives;
-if(!(typeof (a) in _67&amp;&amp;typeof (b) in _67)){
-try{
-return m.comparatorRegistry.match(a,b);
-}
-catch(e){
-if(e!=m.NotFound){
-throw e;
-}
-}
-}
-if(a&lt;b){
-return -1;
-}else{
-if(a&gt;b){
-return 1;
-}
-}
-var _68=m.repr;
-throw new TypeError(_68(a)+&quot; and &quot;+_68(b)+&quot; can not be compared&quot;);
-},compareDateLike:function(a,b){
-return MochiKit.Base.compare(a.getTime(),b.getTime());
-},compareArrayLike:function(a,b){
-var _69=MochiKit.Base.compare;
-var _70=a.length;
-var _71=0;
-if(_70&gt;b.length){
-_71=1;
-_70=b.length;
-}else{
-if(_70&lt;b.length){
-_71=-1;
-}
-}
-for(var i=0;i&lt;_70;i++){
-var cmp=_69(a[i],b[i]);
-if(cmp){
-return cmp;
-}
-}
-return _71;
-},registerRepr:function(_73,_74,_75,_76){
-MochiKit.Base.reprRegistry.register(_73,_74,_75,_76);
-},repr:function(o){
-if(typeof (o)==&quot;undefined&quot;){
-return &quot;undefined&quot;;
-}else{
-if(o===null){
-return &quot;null&quot;;
-}
-}
-try{
-if(typeof (o.__repr__)==&quot;function&quot;){
-return o.__repr__();
-}else{
-if(typeof (o.repr)==&quot;function&quot;&amp;&amp;o.repr!=arguments.callee){
-return o.repr();
-}
-}
-return MochiKit.Base.reprRegistry.match(o);
-}
-catch(e){
-if(typeof (o.NAME)==&quot;string&quot;&amp;&amp;(o.toString==Function.prototype.toString||o.toString==Object.prototype.toString)){
-return o.NAME;
-}
-}
-try{
-var _77=(o+&quot;&quot;);
-}
-catch(e){
-return &quot;[&quot;+typeof (o)+&quot;]&quot;;
-}
-if(typeof (o)==&quot;function&quot;){
-o=_77.replace(/^\s+/,&quot;&quot;);
-var idx=o.indexOf(&quot;{&quot;);
-if(idx!=-1){
-o=o.substr(0,idx)+&quot;{...}&quot;;
-}
-}
-return _77;
-},reprArrayLike:function(o){
-var m=MochiKit.Base;
-return &quot;[&quot;+m.map(m.repr,o).join(&quot;, &quot;)+&quot;]&quot;;
-},reprString:function(o){
-return (&quot;\&quot;&quot;+o.replace(/([&quot;\\])/g,&quot;\\$1&quot;)+&quot;\&quot;&quot;).replace(/[\f]/g,&quot;\\f&quot;).replace(/[\b]/g,&quot;\\b&quot;).replace(/[\n]/g,&quot;\\n&quot;).replace(/[\t]/g,&quot;\\t&quot;).replace(/[\r]/g,&quot;\\r&quot;);
-},reprNumber:function(o){
-return o+&quot;&quot;;
-},registerJSON:function(_79,_80,_81,_82){
-MochiKit.Base.jsonRegistry.register(_79,_80,_81,_82);
-},evalJSON:function(){
-return eval(&quot;(&quot;+arguments[0]+&quot;)&quot;);
-},serializeJSON:function(o){
-var _83=typeof (o);
-if(_83==&quot;undefined&quot;){
-return &quot;undefined&quot;;
-}else{
-if(_83==&quot;number&quot;||_83==&quot;boolean&quot;){
-return o+&quot;&quot;;
-}else{
-if(o===null){
-return &quot;null&quot;;
-}
-}
-}
-var m=MochiKit.Base;
-var _84=m.reprString;
-if(_83==&quot;string&quot;){
-return _84(o);
-}
-var me=arguments.callee;
-var _85;
-if(typeof (o.__json__)==&quot;function&quot;){
-_85=o.__json__();
-if(o!==_85){
-return me(_85);
-}
-}
-if(typeof (o.json)==&quot;function&quot;){
-_85=o.json();
-if(o!==_85){
-return me(_85);
-}
-}
-if(_83!=&quot;function&quot;&amp;&amp;typeof (o.length)==&quot;number&quot;){
-var res=[];
-for(var i=0;i&lt;o.length;i++){
-var val=me(o[i]);
-if(typeof (val)!=&quot;string&quot;){
-val=&quot;undefined&quot;;
-}
-res.push(val);
-}
-return &quot;[&quot;+res.join(&quot;, &quot;)+&quot;]&quot;;
-}
-try{
-_85=m.jsonRegistry.match(o);
-return me(_85);
-}
-catch(e){
-if(e!=m.NotFound){
-throw e;
-}
-}
-if(_83==&quot;function&quot;){
-return null;
-}
-res=[];
-for(var k in o){
-var _87;
-if(typeof (k)==&quot;number&quot;){
-_87=&quot;\&quot;&quot;+k+&quot;\&quot;&quot;;
-}else{
-if(typeof (k)==&quot;string&quot;){
-_87=_84(k);
-}else{
-continue;
-}
-}
-val=me(o[k]);
-if(typeof (val)!=&quot;string&quot;){
-continue;
-}
-res.push(_87+&quot;:&quot;+val);
-}
-return &quot;{&quot;+res.join(&quot;, &quot;)+&quot;}&quot;;
-},objEqual:function(a,b){
-return (MochiKit.Base.compare(a,b)===0);
-},arrayEqual:function(_88,arr){
-if(_88.length!=arr.length){
-return false;
-}
-return (MochiKit.Base.compare(_88,arr)===0);
-},concat:function(){
-var _90=[];
-var _91=MochiKit.Base.extend;
-for(var i=0;i&lt;arguments.length;i++){
-_91(_90,arguments[i]);
-}
-return _90;
-},keyComparator:function(key){
-var m=MochiKit.Base;
-var _93=m.compare;
-if(arguments.length==1){
-return function(a,b){
-return _93(a[key],b[key]);
-};
-}
-var _94=m.extend(null,arguments);
-return function(a,b){
-var _95=0;
-for(var i=0;(_95===0)&amp;&amp;(i&lt;_94.length);i++){
-var key=_94[i];
-_95=_93(a[key],b[key]);
-}
-return _95;
-};
-},reverseKeyComparator:function(key){
-var _96=MochiKit.Base.keyComparator.apply(this,arguments);
-return function(a,b){
-return _96(b,a);
-};
-},partial:function(_97){
-var m=MochiKit.Base;
-return m.bind.apply(this,m.extend([_97,undefined],arguments,1));
-},listMinMax:function(_98,lst){
-if(lst.length===0){
-return null;
-}
-var cur=lst[0];
-var _100=MochiKit.Base.compare;
-for(var i=1;i&lt;lst.length;i++){
-var o=lst[i];
-if(_100(o,cur)==_98){
-cur=o;
-}
-}
-return cur;
-},objMax:function(){
-return MochiKit.Base.listMinMax(1,arguments);
-},objMin:function(){
-return MochiKit.Base.listMinMax(-1,arguments);
-},findIdentical:function(lst,_101,_102,end){
-if(typeof (end)==&quot;undefined&quot;||end===null){
-end=lst.length;
-}
-for(var i=(_102||0);i&lt;end;i++){
-if(lst[i]===_101){
-return i;
-}
-}
-return -1;
-},findValue:function(lst,_104,_105,end){
-if(typeof (end)==&quot;undefined&quot;||end===null){
-end=lst.length;
-}
-var cmp=MochiKit.Base.compare;
-for(var i=(_105||0);i&lt;end;i++){
-if(cmp(lst[i],_104)===0){
-return i;
-}
-}
-return -1;
-},nodeWalk:function(node,_107){
-var _108=[node];
-var _109=MochiKit.Base.extend;
-while(_108.length){
-var res=_107(_108.shift());
-if(res){
-_109(_108,res);
-}
-}
-},nameFunctions:function(_110){
-var base=_110.NAME;
-if(typeof (base)==&quot;undefined&quot;){
-base=&quot;&quot;;
-}else{
-base=base+&quot;.&quot;;
-}
-for(var name in _110){
-var o=_110[name];
-if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
-try{
-o.NAME=base+name;
-}
-catch(e){
-}
-}
-}
-},queryString:function(_113,_114){
-if(typeof (MochiKit.DOM)!=&quot;undefined&quot;&amp;&amp;arguments.length==1&amp;&amp;(typeof (_113)==&quot;string&quot;||(typeof (_113.nodeType)!=&quot;undefined&quot;&amp;&amp;_113.nodeType&gt;0))){
-var kv=MochiKit.DOM.formContents(_113);
-_113=kv[0];
-_114=kv[1];
-}else{
-if(arguments.length==1){
-var o=_113;
-_113=[];
-_114=[];
-for(var k in o){
-var v=o[k];
-if(typeof (v)!=&quot;function&quot;){
-_113.push(k);
-_114.push(v);
-}
-}
-}
-}
-var rval=[];
-var len=Math.min(_113.length,_114.length);
-var _118=MochiKit.Base.urlEncode;
-for(var i=0;i&lt;len;i++){
-v=_114[i];
-if(typeof (v)!=&quot;undefined&quot;&amp;&amp;v!==null){
-rval.push(_118(_113[i])+&quot;=&quot;+_118(v));
-}
-}
-return rval.join(&quot;&amp;&quot;);
-},parseQueryString:function(_119,_120){
-var _121=_119.replace(/\+/g,&quot;%20&quot;).split(&quot;&amp;&quot;);
-var o={};
-var _122;
-if(typeof (decodeURIComponent)!=&quot;undefined&quot;){
-_122=decodeURIComponent;
-}else{
-_122=unescape;
-}
-if(_120){
-for(var i=0;i&lt;_121.length;i++){
-var pair=_121[i].split(&quot;=&quot;);
-var name=_122(pair[0]);
-var arr=o[name];
-if(!(arr instanceof Array)){
-arr=[];
-o[name]=arr;
-}
-arr.push(_122(pair[1]));
-}
-}else{
-for(i=0;i&lt;_121.length;i++){
-pair=_121[i].split(&quot;=&quot;);
-o[_122(pair[0])]=_122(pair[1]);
-}
-}
-return o;
-}});
-MochiKit.Base.AdapterRegistry=function(){
-this.pairs=[];
-};
-MochiKit.Base.AdapterRegistry.prototype={register:function(name,_124,wrap,_126){
-if(_126){
-this.pairs.unshift([name,_124,wrap]);
-}else{
-this.pairs.push([name,_124,wrap]);
-}
-},match:function(){
-for(var i=0;i&lt;this.pairs.length;i++){
-var pair=this.pairs[i];
-if(pair[1].apply(this,arguments)){
-return pair[2].apply(this,arguments);
-}
-}
-throw MochiKit.Base.NotFound;
-},unregister:function(name){
-for(var i=0;i&lt;this.pairs.length;i++){
-var pair=this.pairs[i];
-if(pair[0]==name){
-this.pairs.splice(i,1);
-return true;
-}
-}
-return false;
-}};
-MochiKit.Base.EXPORT=[&quot;counter&quot;,&quot;clone&quot;,&quot;extend&quot;,&quot;update&quot;,&quot;updatetree&quot;,&quot;setdefault&quot;,&quot;keys&quot;,&quot;items&quot;,&quot;NamedError&quot;,&quot;operator&quot;,&quot;forwardCall&quot;,&quot;itemgetter&quot;,&quot;typeMatcher&quot;,&quot;isCallable&quot;,&quot;isUndefined&quot;,&quot;isUndefinedOrNull&quot;,&quot;isNull&quot;,&quot;isEmpty&quot;,&quot;isNotEmpty&quot;,&quot;isArrayLike&quot;,&quot;isDateLike&quot;,&quot;xmap&quot;,&quot;map&quot;,&quot;xfilter&quot;,&quot;filter&quot;,&quot;bind&quot;,&quot;bindMethods&quot;,&quot;NotFound&quot;,&quot;AdapterRegistry&quot;,&quot;registerComparator&quot;,&quot;compare&quot;,&quot;registerRepr&quot;,&quot;repr&quot;,&quot;objEqual&quot;,&quot;arrayEqual&quot;,&quot;concat&quot;,&quot;keyComparator&quot;,&quot;reverseKeyComparator&quot;,&quot;partial&quot;,&quot;merge&quot;,&quot;listMinMax&quot;,&quot;listMax&quot;,&quot;listMin&quot;,&quot;objMax&quot;,&quot;objMin&quot;,&quot;nodeWalk&quot;,&quot;zip&quot;,&quot;urlEncode&quot;,&quot;queryString&quot;,&quot;serializeJSON&quot;,&quot;registerJSON&quot;,&quot;evalJSON&quot;,&quot;parseQueryString&quot;,&quot;findValue&quot;,&quot;findIdentical&quot;,&quot;flattenArguments&quot;,&quot;method&quot;];
-MochiKit.Base.EXPORT_OK=[&quot;nameFunctions&quot;,&quot;comparatorRegistry&quot;,&quot;reprRegistry&quot;,&quot;jsonRegistry&quot;,&quot;compareDateLike&quot;,&quot;compareArrayLike&quot;,&quot;reprArrayLike&quot;,&quot;reprString&quot;,&quot;reprNumber&quot;];
-MochiKit.Base._exportSymbols=function(_127,_128){
-if(typeof (MochiKit.__export__)==&quot;undefined&quot;){
-MochiKit.__export__=(MochiKit.__compat__||(typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;));
-}
-if(!MochiKit.__export__){
-return;
-}
-var all=_128.EXPORT_TAGS[&quot;:all&quot;];
-for(var i=0;i&lt;all.length;i++){
-_127[all[i]]=_128[all[i]];
-}
-};
-MochiKit.Base.__new__=function(){
-var m=this;
-m.forward=m.forwardCall;
-m.find=m.findValue;
-if(typeof (encodeURIComponent)!=&quot;undefined&quot;){
-m.urlEncode=function(_130){
-return encodeURIComponent(_130).replace(/\'/g,&quot;%27&quot;);
-};
-}else{
-m.urlEncode=function(_131){
-return escape(_131).replace(/\+/g,&quot;%2B&quot;).replace(/\&quot;/g,&quot;%22&quot;).rval.replace(/\'/g,&quot;%27&quot;);
-};
-}
-m.NamedError=function(name){
-this.message=name;
-this.name=name;
-};
-m.NamedError.prototype=new Error();
-m.update(m.NamedError.prototype,{repr:function(){
-if(this.message&amp;&amp;this.message!=this.name){
-return this.name+&quot;(&quot;+m.repr(this.message)+&quot;)&quot;;
-}else{
-return this.name+&quot;()&quot;;
-}
-},toString:m.forwardCall(&quot;repr&quot;)});
-m.NotFound=new m.NamedError(&quot;MochiKit.Base.NotFound&quot;);
-m.listMax=m.partial(m.listMinMax,1);
-m.listMin=m.partial(m.listMinMax,-1);
-m.isCallable=m.typeMatcher(&quot;function&quot;);
-m.isUndefined=m.typeMatcher(&quot;undefined&quot;);
-m.merge=m.partial(m.update,null);
-m.zip=m.partial(m.map,null);
-m.comparatorRegistry=new m.AdapterRegistry();
-m.registerComparator(&quot;dateLike&quot;,m.isDateLike,m.compareDateLike);
-m.registerComparator(&quot;arrayLike&quot;,m.isArrayLike,m.compareArrayLike);
-m.reprRegistry=new m.AdapterRegistry();
-m.registerRepr(&quot;arrayLike&quot;,m.isArrayLike,m.reprArrayLike);
-m.registerRepr(&quot;string&quot;,m.typeMatcher(&quot;string&quot;),m.reprString);
-m.registerRepr(&quot;numbers&quot;,m.typeMatcher(&quot;number&quot;,&quot;boolean&quot;),m.reprNumber);
-m.jsonRegistry=new m.AdapterRegistry();
-var all=m.concat(m.EXPORT,m.EXPORT_OK);
-m.EXPORT_TAGS={&quot;:common&quot;:m.concat(m.EXPORT_OK),&quot;:all&quot;:all};
-m.nameFunctions(this);
-};
-MochiKit.Base.__new__();
-if(!MochiKit.__compat__){
-compare=MochiKit.Base.compare;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Base);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Iter&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Iter depends on MochiKit.Base!&quot;;
-}
-if(typeof (MochiKit.Iter)==&quot;undefined&quot;){
-MochiKit.Iter={};
-}
-MochiKit.Iter.NAME=&quot;MochiKit.Iter&quot;;
-MochiKit.Iter.VERSION=&quot;1.3.1&quot;;
-MochiKit.Base.update(MochiKit.Iter,{__repr__:function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-},toString:function(){
-return this.__repr__();
-},registerIteratorFactory:function(name,_132,_133,_134){
-MochiKit.Iter.iteratorRegistry.register(name,_132,_133,_134);
-},iter:function(_135,_136){
-var self=MochiKit.Iter;
-if(arguments.length==2){
-return self.takewhile(function(a){
-return a!=_136;
-},_135);
-}
-if(typeof (_135.next)==&quot;function&quot;){
-return _135;
-}else{
-if(typeof (_135.iter)==&quot;function&quot;){
-return _135.iter();
-}
-}
-try{
-return self.iteratorRegistry.match(_135);
-}
-catch(e){
-var m=MochiKit.Base;
-if(e==m.NotFound){
-e=new TypeError(typeof (_135)+&quot;: &quot;+m.repr(_135)+&quot; is not iterable&quot;);
-}
-throw e;
-}
-},count:function(n){
-if(!n){
-n=0;
-}
-var m=MochiKit.Base;
-return {repr:function(){
-return &quot;count(&quot;+n+&quot;)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:m.counter(n)};
-},cycle:function(p){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-var lst=[];
-var _139=self.iter(p);
-return {repr:function(){
-return &quot;cycle(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-try{
-var rval=_139.next();
-lst.push(rval);
-return rval;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-if(lst.length===0){
-this.next=function(){
-throw self.StopIteration;
-};
-}else{
-var i=-1;
-this.next=function(){
-i=(i+1)%lst.length;
-return lst[i];
-};
-}
-return this.next();
-}
-}};
-},repeat:function(elem,n){
-var m=MochiKit.Base;
-if(typeof (n)==&quot;undefined&quot;){
-return {repr:function(){
-return &quot;repeat(&quot;+m.repr(elem)+&quot;)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-return elem;
-}};
-}
-return {repr:function(){
-return &quot;repeat(&quot;+m.repr(elem)+&quot;, &quot;+n+&quot;)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-if(n&lt;=0){
-throw MochiKit.Iter.StopIteration;
-}
-n-=1;
-return elem;
-}};
-},next:function(_141){
-return _141.next();
-},izip:function(p,q){
-var m=MochiKit.Base;
-var next=MochiKit.Iter.next;
-var _144=m.map(iter,arguments);
-return {repr:function(){
-return &quot;izip(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-return m.map(next,_144);
-}};
-},ifilter:function(pred,seq){
-var m=MochiKit.Base;
-seq=MochiKit.Iter.iter(seq);
-if(pred===null){
-pred=m.operator.truth;
-}
-return {repr:function(){
-return &quot;ifilter(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-while(true){
-var rval=seq.next();
-if(pred(rval)){
-return rval;
-}
-}
-return undefined;
-}};
-},ifilterfalse:function(pred,seq){
-var m=MochiKit.Base;
-seq=MochiKit.Iter.iter(seq);
-if(pred===null){
-pred=m.operator.truth;
-}
-return {repr:function(){
-return &quot;ifilterfalse(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-while(true){
-var rval=seq.next();
-if(!pred(rval)){
-return rval;
-}
-}
-return undefined;
-}};
-},islice:function(seq){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-seq=self.iter(seq);
-var _147=0;
-var stop=0;
-var step=1;
-var i=-1;
-if(arguments.length==2){
-stop=arguments[1];
-}else{
-if(arguments.length==3){
-_147=arguments[1];
-stop=arguments[2];
-}else{
-_147=arguments[1];
-stop=arguments[2];
-step=arguments[3];
-}
-}
-return {repr:function(){
-return &quot;islice(&quot;+[&quot;...&quot;,_147,stop,step].join(&quot;, &quot;)+&quot;)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-var rval;
-while(i&lt;_147){
-rval=seq.next();
-i++;
-}
-if(_147&gt;=stop){
-throw self.StopIteration;
-}
-_147+=step;
-return rval;
-}};
-},imap:function(fun,p,q){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-var _151=m.map(self.iter,m.extend(null,arguments,1));
-var map=m.map;
-var next=self.next;
-return {repr:function(){
-return &quot;imap(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-return fun.apply(this,map(next,_151));
-}};
-},applymap:function(fun,seq,self){
-seq=MochiKit.Iter.iter(seq);
-var m=MochiKit.Base;
-return {repr:function(){
-return &quot;applymap(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-return fun.apply(self,seq.next());
-}};
-},chain:function(p,q){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-if(arguments.length==1){
-return self.iter(arguments[0]);
-}
-var _153=m.map(self.iter,arguments);
-return {repr:function(){
-return &quot;chain(...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-while(_153.length&gt;1){
-try{
-return _153[0].next();
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-_153.shift();
-}
-}
-if(_153.length==1){
-var arg=_153.shift();
-this.next=m.bind(&quot;next&quot;,arg);
-return this.next();
-}
-throw self.StopIteration;
-}};
-},takewhile:function(pred,seq){
-var self=MochiKit.Iter;
-seq=self.iter(seq);
-return {repr:function(){
-return &quot;takewhile(...)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
-var rval=seq.next();
-if(!pred(rval)){
-this.next=function(){
-throw self.StopIteration;
-};
-this.next();
-}
-return rval;
-}};
-},dropwhile:function(pred,seq){
-seq=MochiKit.Iter.iter(seq);
-var m=MochiKit.Base;
-var bind=m.bind;
-return {&quot;repr&quot;:function(){
-return &quot;dropwhile(...)&quot;;
-},&quot;toString&quot;:m.forwardCall(&quot;repr&quot;),&quot;next&quot;:function(){
-while(true){
-var rval=seq.next();
-if(!pred(rval)){
-break;
-}
-}
-this.next=bind(&quot;next&quot;,seq);
-return rval;
-}};
-},_tee:function(_155,sync,_157){
-sync.pos[_155]=-1;
-var m=MochiKit.Base;
-var _158=m.listMin;
-return {repr:function(){
-return &quot;tee(&quot;+_155+&quot;, ...)&quot;;
-},toString:m.forwardCall(&quot;repr&quot;),next:function(){
-var rval;
-var i=sync.pos[_155];
-if(i==sync.max){
-rval=_157.next();
-sync.deque.push(rval);
-sync.max+=1;
-sync.pos[_155]+=1;
-}else{
-rval=sync.deque[i-sync.min];
-sync.pos[_155]+=1;
-if(i==sync.min&amp;&amp;_158(sync.pos)!=sync.min){
-sync.min+=1;
-sync.deque.shift();
-}
-}
-return rval;
-}};
-},tee:function(_159,n){
-var rval=[];
-var sync={&quot;pos&quot;:[],&quot;deque&quot;:[],&quot;max&quot;:-1,&quot;min&quot;:-1};
-if(arguments.length==1){
-n=2;
-}
-var self=MochiKit.Iter;
-_159=self.iter(_159);
-var _tee=self._tee;
-for(var i=0;i&lt;n;i++){
-rval.push(_tee(i,sync,_159));
-}
-return rval;
-},list:function(_161){
-var m=MochiKit.Base;
-if(typeof (_161.slice)==&quot;function&quot;){
-return _161.slice();
-}else{
-if(m.isArrayLike(_161)){
-return m.concat(_161);
-}
-}
-var self=MochiKit.Iter;
-_161=self.iter(_161);
-var rval=[];
-try{
-while(true){
-rval.push(_161.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return rval;
-}
-return undefined;
-},reduce:function(fn,_162,_163){
-var i=0;
-var x=_163;
-var self=MochiKit.Iter;
-_162=self.iter(_162);
-if(arguments.length&lt;3){
-try{
-x=_162.next();
-}
-catch(e){
-if(e==self.StopIteration){
-e=new TypeError(&quot;reduce() of empty sequence with no initial value&quot;);
-}
-throw e;
-}
-i++;
-}
-try{
-while(true){
-x=fn(x,_162.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-return x;
-},range:function(){
-var _165=0;
-var stop=0;
-var step=1;
-if(arguments.length==1){
-stop=arguments[0];
-}else{
-if(arguments.length==2){
-_165=arguments[0];
-stop=arguments[1];
-}else{
-if(arguments.length==3){
-_165=arguments[0];
-stop=arguments[1];
-step=arguments[2];
-}else{
-throw new TypeError(&quot;range() takes 1, 2, or 3 arguments!&quot;);
-}
-}
-}
-if(step===0){
-throw new TypeError(&quot;range() step must not be 0&quot;);
-}
-return {next:function(){
-if((step&gt;0&amp;&amp;_165&gt;=stop)||(step&lt;0&amp;&amp;_165&lt;=stop)){
-throw MochiKit.Iter.StopIteration;
-}
-var rval=_165;
-_165+=step;
-return rval;
-},repr:function(){
-return &quot;range(&quot;+[_165,stop,step].join(&quot;, &quot;)+&quot;)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
-},sum:function(_166,_167){
-var x=_167||0;
-var self=MochiKit.Iter;
-_166=self.iter(_166);
-try{
-while(true){
-x+=_166.next();
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-return x;
-},exhaust:function(_168){
-var self=MochiKit.Iter;
-_168=self.iter(_168);
-try{
-while(true){
-_168.next();
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-},forEach:function(_169,func,self){
-var m=MochiKit.Base;
-if(arguments.length&gt;2){
-func=m.bind(func,self);
-}
-if(m.isArrayLike(_169)){
-try{
-for(var i=0;i&lt;_169.length;i++){
-func(_169[i]);
-}
-}
-catch(e){
-if(e!=MochiKit.Iter.StopIteration){
-throw e;
-}
-}
-}else{
-self=MochiKit.Iter;
-self.exhaust(self.imap(func,_169));
-}
-},every:function(_171,func){
-var self=MochiKit.Iter;
-try{
-self.ifilterfalse(func,_171).next();
-return false;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return true;
-}
-},sorted:function(_172,cmp){
-var rval=MochiKit.Iter.list(_172);
-if(arguments.length==1){
-cmp=MochiKit.Base.compare;
-}
-rval.sort(cmp);
-return rval;
-},reversed:function(_173){
-var rval=MochiKit.Iter.list(_173);
-rval.reverse();
-return rval;
-},some:function(_174,func){
-var self=MochiKit.Iter;
-try{
-self.ifilter(func,_174).next();
-return true;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return false;
-}
-},iextend:function(lst,_175){
-if(MochiKit.Base.isArrayLike(_175)){
-for(var i=0;i&lt;_175.length;i++){
-lst.push(_175[i]);
-}
-}else{
-var self=MochiKit.Iter;
-_175=self.iter(_175);
-try{
-while(true){
-lst.push(_175.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-}
-return lst;
-},groupby:function(_176,_177){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-if(arguments.length&lt;2){
-_177=m.operator.identity;
-}
-_176=self.iter(_176);
-var pk=undefined;
-var k=undefined;
-var v;
-function fetch(){
-v=_176.next();
-k=_177(v);
-}
-function eat(){
-var ret=v;
-v=undefined;
-return ret;
-}
-var _180=true;
-return {repr:function(){
-return &quot;groupby(...)&quot;;
-},next:function(){
-while(k==pk){
-fetch();
-if(_180){
-_180=false;
-break;
-}
-}
-pk=k;
-return [k,{next:function(){
-if(v==undefined){
-fetch();
-}
-if(k!=pk){
-throw self.StopIteration;
-}
-return eat();
-}}];
-}};
-},groupby_as_array:function(_181,_182){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-if(arguments.length&lt;2){
-_182=m.operator.identity;
-}
-_181=self.iter(_181);
-var _183=[];
-var _184=true;
-var _185;
-while(true){
-try{
-var _186=_181.next();
-var key=_182(_186);
-}
-catch(e){
-if(e==self.StopIteration){
-break;
-}
-throw e;
-}
-if(_184||key!=_185){
-var _187=[];
-_183.push([key,_187]);
-}
-_187.push(_186);
-_184=false;
-_185=key;
-}
-return _183;
-},arrayLikeIter:function(_188){
-var i=0;
-return {repr:function(){
-return &quot;arrayLikeIter(...)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
-if(i&gt;=_188.length){
-throw MochiKit.Iter.StopIteration;
-}
-return _188[i++];
-}};
-},hasIterateNext:function(_189){
-return (_189&amp;&amp;typeof (_189.iterateNext)==&quot;function&quot;);
-},iterateNextIter:function(_190){
-return {repr:function(){
-return &quot;iterateNextIter(...)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
-var rval=_190.iterateNext();
-if(rval===null||rval===undefined){
-throw MochiKit.Iter.StopIteration;
-}
-return rval;
-}};
-}});
-MochiKit.Iter.EXPORT_OK=[&quot;iteratorRegistry&quot;,&quot;arrayLikeIter&quot;,&quot;hasIterateNext&quot;,&quot;iterateNextIter&quot;,];
-MochiKit.Iter.EXPORT=[&quot;StopIteration&quot;,&quot;registerIteratorFactory&quot;,&quot;iter&quot;,&quot;count&quot;,&quot;cycle&quot;,&quot;repeat&quot;,&quot;next&quot;,&quot;izip&quot;,&quot;ifilter&quot;,&quot;ifilterfalse&quot;,&quot;islice&quot;,&quot;imap&quot;,&quot;applymap&quot;,&quot;chain&quot;,&quot;takewhile&quot;,&quot;dropwhile&quot;,&quot;tee&quot;,&quot;list&quot;,&quot;reduce&quot;,&quot;range&quot;,&quot;sum&quot;,&quot;exhaust&quot;,&quot;forEach&quot;,&quot;every&quot;,&quot;sorted&quot;,&quot;reversed&quot;,&quot;some&quot;,&quot;iextend&quot;,&quot;groupby&quot;,&quot;groupby_as_array&quot;];
-MochiKit.Iter.__new__=function(){
-var m=MochiKit.Base;
-this.StopIteration=new m.NamedError(&quot;StopIteration&quot;);
-this.iteratorRegistry=new m.AdapterRegistry();
-this.registerIteratorFactory(&quot;arrayLike&quot;,m.isArrayLike,this.arrayLikeIter);
-this.registerIteratorFactory(&quot;iterateNext&quot;,this.hasIterateNext,this.iterateNextIter);
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Iter.__new__();
-if(!MochiKit.__compat__){
-reduce=MochiKit.Iter.reduce;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Iter);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Logging&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Logging depends on MochiKit.Base!&quot;;
-}
-if(typeof (MochiKit.Logging)==&quot;undefined&quot;){
-MochiKit.Logging={};
-}
-MochiKit.Logging.NAME=&quot;MochiKit.Logging&quot;;
-MochiKit.Logging.VERSION=&quot;1.3.1&quot;;
-MochiKit.Logging.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.Logging.toString=function(){
-return this.__repr__();
-};
-MochiKit.Logging.EXPORT=[&quot;LogLevel&quot;,&quot;LogMessage&quot;,&quot;Logger&quot;,&quot;alertListener&quot;,&quot;logger&quot;,&quot;log&quot;,&quot;logError&quot;,&quot;logDebug&quot;,&quot;logFatal&quot;,&quot;logWarning&quot;];
-MochiKit.Logging.EXPORT_OK=[&quot;logLevelAtLeast&quot;,&quot;isLogMessage&quot;,&quot;compareLogMessage&quot;];
-MochiKit.Logging.LogMessage=function(num,_192,info){
-this.num=num;
-this.level=_192;
-this.info=info;
-this.timestamp=new Date();
-};
-MochiKit.Logging.LogMessage.prototype={repr:function(){
-var m=MochiKit.Base;
-return &quot;LogMessage(&quot;+m.map(m.repr,[this.num,this.level,this.info]).join(&quot;, &quot;)+&quot;)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
-MochiKit.Base.update(MochiKit.Logging,{logLevelAtLeast:function(_194){
-var self=MochiKit.Logging;
-if(typeof (_194)==&quot;string&quot;){
-_194=self.LogLevel[_194];
-}
-return function(msg){
-var _196=msg.level;
-if(typeof (_196)==&quot;string&quot;){
-_196=self.LogLevel[_196];
-}
-return _196&gt;=_194;
-};
-},isLogMessage:function(){
-var _197=MochiKit.Logging.LogMessage;
-for(var i=0;i&lt;arguments.length;i++){
-if(!(arguments[i] instanceof _197)){
-return false;
-}
-}
-return true;
-},compareLogMessage:function(a,b){
-return MochiKit.Base.compare([a.level,a.info],[b.level,b.info]);
-},alertListener:function(msg){
-alert(&quot;num: &quot;+msg.num+&quot;\nlevel: &quot;+msg.level+&quot;\ninfo: &quot;+msg.info.join(&quot; &quot;));
-}});
-MochiKit.Logging.Logger=function(_198){
-this.counter=0;
-if(typeof (_198)==&quot;undefined&quot;||_198===null){
-_198=-1;
-}
-this.maxSize=_198;
-this._messages=[];
-this.listeners={};
-this.useNativeConsole=false;
-};
-MochiKit.Logging.Logger.prototype={clear:function(){
-this._messages.splice(0,this._messages.length);
-},logToConsole:function(msg){
-if(typeof (window)!=&quot;undefined&quot;&amp;&amp;window.console&amp;&amp;window.console.log){
-window.console.log(msg);
-}else{
-if(typeof (opera)!=&quot;undefined&quot;&amp;&amp;opera.postError){
-opera.postError(msg);
-}else{
-if(typeof (printfire)==&quot;function&quot;){
-printfire(msg);
-}
-}
-}
-},dispatchListeners:function(msg){
-for(var k in this.listeners){
-var pair=this.listeners[k];
-if(pair.ident!=k||(pair[0]&amp;&amp;!pair[0](msg))){
-continue;
-}
-pair[1](msg);
-}
-},addListener:function(_199,_200,_201){
-if(typeof (_200)==&quot;string&quot;){
-_200=MochiKit.Logging.logLevelAtLeast(_200);
-}
-var _202=[_200,_201];
-_202.ident=_199;
-this.listeners[_199]=_202;
-},removeListener:function(_203){
-delete this.listeners[_203];
-},baseLog:function(_204,_205){
-var msg=new MochiKit.Logging.LogMessage(this.counter,_204,MochiKit.Base.extend(null,arguments,1));
-this._messages.push(msg);
-this.dispatchListeners(msg);
-if(this.useNativeConsole){
-this.logToConsole(msg.level+&quot;: &quot;+msg.info.join(&quot; &quot;));
-}
-this.counter+=1;
-while(this.maxSize&gt;=0&amp;&amp;this._messages.length&gt;this.maxSize){
-this._messages.shift();
-}
-},getMessages:function(_206){
-var _207=0;
-if(!(typeof (_206)==&quot;undefined&quot;||_206===null)){
-_207=Math.max(0,this._messages.length-_206);
-}
-return this._messages.slice(_207);
-},getMessageText:function(_208){
-if(typeof (_208)==&quot;undefined&quot;||_208===null){
-_208=30;
-}
-var _209=this.getMessages(_208);
-if(_209.length){
-var lst=map(function(m){
-return &quot;\n  [&quot;+m.num+&quot;] &quot;+m.level+&quot;: &quot;+m.info.join(&quot; &quot;);
-},_209);
-lst.unshift(&quot;LAST &quot;+_209.length+&quot; MESSAGES:&quot;);
-return lst.join(&quot;&quot;);
-}
-return &quot;&quot;;
-},debuggingBookmarklet:function(_210){
-if(typeof (MochiKit.LoggingPane)==&quot;undefined&quot;){
-alert(this.getMessageText());
-}else{
-MochiKit.LoggingPane.createLoggingPane(_210||false);
-}
-}};
-MochiKit.Logging.__new__=function(){
-this.LogLevel={ERROR:40,FATAL:50,WARNING:30,INFO:20,DEBUG:10};
-var m=MochiKit.Base;
-m.registerComparator(&quot;LogMessage&quot;,this.isLogMessage,this.compareLogMessage);
-var _211=m.partial;
-var _212=this.Logger;
-var _213=_212.prototype.baseLog;
-m.update(this.Logger.prototype,{debug:_211(_213,&quot;DEBUG&quot;),log:_211(_213,&quot;INFO&quot;),error:_211(_213,&quot;ERROR&quot;),fatal:_211(_213,&quot;FATAL&quot;),warning:_211(_213,&quot;WARNING&quot;)});
-var self=this;
-var _214=function(name){
-return function(){
-self.logger[name].apply(self.logger,arguments);
-};
-};
-this.log=_214(&quot;log&quot;);
-this.logError=_214(&quot;error&quot;);
-this.logDebug=_214(&quot;debug&quot;);
-this.logFatal=_214(&quot;fatal&quot;);
-this.logWarning=_214(&quot;warning&quot;);
-this.logger=new _212();
-this.logger.useNativeConsole=true;
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-if(typeof (printfire)==&quot;undefined&quot;&amp;&amp;typeof (document)!=&quot;undefined&quot;&amp;&amp;document.createEvent&amp;&amp;typeof (dispatchEvent)!=&quot;undefined&quot;){
-printfire=function(){
-printfire.args=arguments;
-var ev=document.createEvent(&quot;Events&quot;);
-ev.initEvent(&quot;printfire&quot;,false,true);
-dispatchEvent(ev);
-};
-}
-MochiKit.Logging.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Logging);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.DateTime&quot;);
-}
-if(typeof (MochiKit)==&quot;undefined&quot;){
-MochiKit={};
-}
-if(typeof (MochiKit.DateTime)==&quot;undefined&quot;){
-MochiKit.DateTime={};
-}
-MochiKit.DateTime.NAME=&quot;MochiKit.DateTime&quot;;
-MochiKit.DateTime.VERSION=&quot;1.3.1&quot;;
-MochiKit.DateTime.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.DateTime.toString=function(){
-return this.__repr__();
-};
-MochiKit.DateTime.isoDate=function(str){
-str=str+&quot;&quot;;
-if(typeof (str)!=&quot;string&quot;||str.length===0){
-return null;
-}
-var iso=str.split(&quot;-&quot;);
-if(iso.length===0){
-return null;
-}
-return new Date(iso[0],iso[1]-1,iso[2]);
-};
-MochiKit.DateTime._isoRegexp=/(\d{4,})(?:-(\d{1,2})(?:-(\d{1,2})(?:[T ](\d{1,2}):(\d{1,2})(?::(\d{1,2})(?:\.(\d+))?)?(?:(Z)|([+-])(\d{1,2})(?::(\d{1,2}))?)?)?)?)?/;
-MochiKit.DateTime.isoTimestamp=function(str){
-str=str+&quot;&quot;;
-if(typeof (str)!=&quot;string&quot;||str.length===0){
-return null;
-}
-var res=str.match(MochiKit.DateTime._isoRegexp);
-if(typeof (res)==&quot;undefined&quot;||res===null){
-return null;
-}
-var year,month,day,hour,min,sec,msec;
-year=parseInt(res[1],10);
-if(typeof (res[2])==&quot;undefined&quot;||res[2]===&quot;&quot;){
-return new Date(year);
-}
-month=parseInt(res[2],10)-1;
-day=parseInt(res[3],10);
-if(typeof (res[4])==&quot;undefined&quot;||res[4]===&quot;&quot;){
-return new Date(year,month,day);
-}
-hour=parseInt(res[4],10);
-min=parseInt(res[5],10);
-sec=(typeof (res[6])!=&quot;undefined&quot;&amp;&amp;res[6]!==&quot;&quot;)?parseInt(res[6],10):0;
-if(typeof (res[7])!=&quot;undefined&quot;&amp;&amp;res[7]!==&quot;&quot;){
-msec=Math.round(1000*parseFloat(&quot;0.&quot;+res[7]));
-}else{
-msec=0;
-}
-if((typeof (res[8])==&quot;undefined&quot;||res[8]===&quot;&quot;)&amp;&amp;(typeof (res[9])==&quot;undefined&quot;||res[9]===&quot;&quot;)){
-return new Date(year,month,day,hour,min,sec,msec);
-}
-var ofs;
-if(typeof (res[9])!=&quot;undefined&quot;&amp;&amp;res[9]!==&quot;&quot;){
-ofs=parseInt(res[10],10)*3600000;
-if(typeof (res[11])!=&quot;undefined&quot;&amp;&amp;res[11]!==&quot;&quot;){
-ofs+=parseInt(res[11],10)*60000;
-}
-if(res[9]==&quot;-&quot;){
-ofs=-ofs;
-}
-}else{
-ofs=0;
-}
-return new Date(Date.UTC(year,month,day,hour,min,sec,msec)-ofs);
-};
-MochiKit.DateTime.toISOTime=function(date,_221){
-if(typeof (date)==&quot;undefined&quot;||date===null){
-return null;
-}
-var hh=date.getHours();
-var mm=date.getMinutes();
-var ss=date.getSeconds();
-var lst=[((_221&amp;&amp;(hh&lt;10))?&quot;0&quot;+hh:hh),((mm&lt;10)?&quot;0&quot;+mm:mm),((ss&lt;10)?&quot;0&quot;+ss:ss)];
-return lst.join(&quot;:&quot;);
-};
-MochiKit.DateTime.toISOTimestamp=function(date,_225){
-if(typeof (date)==&quot;undefined&quot;||date===null){
-return null;
-}
-var sep=_225?&quot;T&quot;:&quot; &quot;;
-var foot=_225?&quot;Z&quot;:&quot;&quot;;
-if(_225){
-date=new Date(date.getTime()+(date.getTimezoneOffset()*60000));
-}
-return MochiKit.DateTime.toISODate(date)+sep+MochiKit.DateTime.toISOTime(date,_225)+foot;
-};
-MochiKit.DateTime.toISODate=function(date){
-if(typeof (date)==&quot;undefined&quot;||date===null){
-return null;
-}
-var _228=MochiKit.DateTime._padTwo;
-return [date.getFullYear(),_228(date.getMonth()+1),_228(date.getDate())].join(&quot;-&quot;);
-};
-MochiKit.DateTime.americanDate=function(d){
-d=d+&quot;&quot;;
-if(typeof (d)!=&quot;string&quot;||d.length===0){
-return null;
-}
-var a=d.split(&quot;/&quot;);
-return new Date(a[2],a[0]-1,a[1]);
-};
-MochiKit.DateTime._padTwo=function(n){
-return (n&gt;9)?n:&quot;0&quot;+n;
-};
-MochiKit.DateTime.toPaddedAmericanDate=function(d){
-if(typeof (d)==&quot;undefined&quot;||d===null){
-return null;
-}
-var _230=MochiKit.DateTime._padTwo;
-return [_230(d.getMonth()+1),_230(d.getDate()),d.getFullYear()].join(&quot;/&quot;);
-};
-MochiKit.DateTime.toAmericanDate=function(d){
-if(typeof (d)==&quot;undefined&quot;||d===null){
-return null;
-}
-return [d.getMonth()+1,d.getDate(),d.getFullYear()].join(&quot;/&quot;);
-};
-MochiKit.DateTime.EXPORT=[&quot;isoDate&quot;,&quot;isoTimestamp&quot;,&quot;toISOTime&quot;,&quot;toISOTimestamp&quot;,&quot;toISODate&quot;,&quot;americanDate&quot;,&quot;toPaddedAmericanDate&quot;,&quot;toAmericanDate&quot;];
-MochiKit.DateTime.EXPORT_OK=[];
-MochiKit.DateTime.EXPORT_TAGS={&quot;:common&quot;:MochiKit.DateTime.EXPORT,&quot;:all&quot;:MochiKit.DateTime.EXPORT};
-MochiKit.DateTime.__new__=function(){
-var base=this.NAME+&quot;.&quot;;
-for(var k in this){
-var o=this[k];
-if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
-try{
-o.NAME=base+k;
-}
-catch(e){
-}
-}
-}
-};
-MochiKit.DateTime.__new__();
-if(typeof (MochiKit.Base)!=&quot;undefined&quot;){
-MochiKit.Base._exportSymbols(this,MochiKit.DateTime);
-}else{
-(function(_231,_232){
-if((typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;)||(typeof (MochiKit.__compat__)==&quot;boolean&quot;&amp;&amp;MochiKit.__compat__)){
-var all=_232.EXPORT_TAGS[&quot;:all&quot;];
-for(var i=0;i&lt;all.length;i++){
-_231[all[i]]=_232[all[i]];
-}
-}
-})(this,MochiKit.DateTime);
-}
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Format&quot;);
-}
-if(typeof (MochiKit)==&quot;undefined&quot;){
-MochiKit={};
-}
-if(typeof (MochiKit.Format)==&quot;undefined&quot;){
-MochiKit.Format={};
-}
-MochiKit.Format.NAME=&quot;MochiKit.Format&quot;;
-MochiKit.Format.VERSION=&quot;1.3.1&quot;;
-MochiKit.Format.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.Format.toString=function(){
-return this.__repr__();
-};
-MochiKit.Format._numberFormatter=function(_233,_234,_235,_236,_237,_238,_239,_240,_241){
-return function(num){
-num=parseFloat(num);
-if(typeof (num)==&quot;undefined&quot;||num===null||isNaN(num)){
-return _233;
-}
-var _242=_234;
-var _243=_235;
-if(num&lt;0){
-num=-num;
-}else{
-_242=_242.replace(/-/,&quot;&quot;);
-}
-var me=arguments.callee;
-var fmt=MochiKit.Format.formatLocale(_236);
-if(_237){
-num=num*100;
-_243=fmt.percent+_243;
-}
-num=MochiKit.Format.roundToFixed(num,_238);
-var _245=num.split(/\./);
-var _246=_245[0];
-var frac=(_245.length==1)?&quot;&quot;:_245[1];
-var res=&quot;&quot;;
-while(_246.length&lt;_239){
-_246=&quot;0&quot;+_246;
-}
-if(_240){
-while(_246.length&gt;_240){
-var i=_246.length-_240;
-res=fmt.separator+_246.substring(i,_246.length)+res;
-_246=_246.substring(0,i);
-}
-}
-res=_246+res;
-if(_238&gt;0){
-while(frac.length&lt;_241){
-frac=frac+&quot;0&quot;;
-}
-res=res+fmt.decimal+frac;
-}
-return _242+res+_243;
-};
-};
-MochiKit.Format.numberFormatter=function(_248,_249,_250){
-if(typeof (_249)==&quot;undefined&quot;){
-_249=&quot;&quot;;
-}
-var _251=_248.match(/((?:[0#]+,)?[0#]+)(?:\.([0#]+))?(%)?/);
-if(!_251){
-throw TypeError(&quot;Invalid pattern&quot;);
-}
-var _252=_248.substr(0,_251.index);
-var _253=_248.substr(_251.index+_251[0].length);
-if(_252.search(/-/)==-1){
-_252=_252+&quot;-&quot;;
-}
-var _254=_251[1];
-var frac=(typeof (_251[2])==&quot;string&quot;&amp;&amp;_251[2]!=&quot;&quot;)?_251[2]:&quot;&quot;;
-var _255=(typeof (_251[3])==&quot;string&quot;&amp;&amp;_251[3]!=&quot;&quot;);
-var tmp=_254.split(/,/);
-var _257;
-if(typeof (_250)==&quot;undefined&quot;){
-_250=&quot;default&quot;;
-}
-if(tmp.length==1){
-_257=null;
-}else{
-_257=tmp[1].length;
-}
-var _258=_254.length-_254.replace(/0/g,&quot;&quot;).length;
-var _259=frac.length-frac.replace(/0/g,&quot;&quot;).length;
-var _260=frac.length;
-var rval=MochiKit.Format._numberFormatter(_249,_252,_253,_250,_255,_260,_258,_257,_259);
-var m=MochiKit.Base;
-if(m){
-var fn=arguments.callee;
-var args=m.concat(arguments);
-rval.repr=function(){
-return [self.NAME,&quot;(&quot;,map(m.repr,args).join(&quot;, &quot;),&quot;)&quot;].join(&quot;&quot;);
-};
-}
-return rval;
-};
-MochiKit.Format.formatLocale=function(_262){
-if(typeof (_262)==&quot;undefined&quot;||_262===null){
-_262=&quot;default&quot;;
-}
-if(typeof (_262)==&quot;string&quot;){
-var rval=MochiKit.Format.LOCALE[_262];
-if(typeof (rval)==&quot;string&quot;){
-rval=arguments.callee(rval);
-MochiKit.Format.LOCALE[_262]=rval;
-}
-return rval;
-}else{
-return _262;
-}
-};
-MochiKit.Format.twoDigitAverage=function(_263,_264){
-if(_264){
-var res=_263/_264;
-if(!isNaN(res)){
-return MochiKit.Format.twoDigitFloat(_263/_264);
-}
-}
-return &quot;0&quot;;
-};
-MochiKit.Format.twoDigitFloat=function(_265){
-var sign=(_265&lt;0?&quot;-&quot;:&quot;&quot;);
-var s=Math.floor(Math.abs(_265)*100).toString();
-if(s==&quot;0&quot;){
-return s;
-}
-if(s.length&lt;3){
-while(s.charAt(s.length-1)==&quot;0&quot;){
-s=s.substring(0,s.length-1);
-}
-return sign+&quot;0.&quot;+s;
-}
-var head=sign+s.substring(0,s.length-2);
-var tail=s.substring(s.length-2,s.length);
-if(tail==&quot;00&quot;){
-return head;
-}else{
-if(tail.charAt(1)==&quot;0&quot;){
-return head+&quot;.&quot;+tail.charAt(0);
-}else{
-return head+&quot;.&quot;+tail;
-}
-}
-};
-MochiKit.Format.lstrip=function(str,_270){
-str=str+&quot;&quot;;
-if(typeof (str)!=&quot;string&quot;){
-return null;
-}
-if(!_270){
-return str.replace(/^\s+/,&quot;&quot;);
-}else{
-return str.replace(new RegExp(&quot;^[&quot;+_270+&quot;]+&quot;),&quot;&quot;);
-}
-};
-MochiKit.Format.rstrip=function(str,_271){
-str=str+&quot;&quot;;
-if(typeof (str)!=&quot;string&quot;){
-return null;
-}
-if(!_271){
-return str.replace(/\s+$/,&quot;&quot;);
-}else{
-return str.replace(new RegExp(&quot;[&quot;+_271+&quot;]+$&quot;),&quot;&quot;);
-}
-};
-MochiKit.Format.strip=function(str,_272){
-var self=MochiKit.Format;
-return self.rstrip(self.lstrip(str,_272),_272);
-};
-MochiKit.Format.truncToFixed=function(_273,_274){
-_273=Math.floor(_273*Math.pow(10,_274));
-var res=(_273*Math.pow(10,-_274)).toFixed(_274);
-if(res.charAt(0)==&quot;.&quot;){
-res=&quot;0&quot;+res;
-}
-return res;
-};
-MochiKit.Format.roundToFixed=function(_275,_276){
-return MochiKit.Format.truncToFixed(_275+0.5*Math.pow(10,-_276),_276);
-};
-MochiKit.Format.percentFormat=function(_277){
-return MochiKit.Format.twoDigitFloat(100*_277)+&quot;%&quot;;
-};
-MochiKit.Format.EXPORT=[&quot;truncToFixed&quot;,&quot;roundToFixed&quot;,&quot;numberFormatter&quot;,&quot;formatLocale&quot;,&quot;twoDigitAverage&quot;,&quot;twoDigitFloat&quot;,&quot;percentFormat&quot;,&quot;lstrip&quot;,&quot;rstrip&quot;,&quot;strip&quot;];
-MochiKit.Format.LOCALE={en_US:{separator:&quot;,&quot;,decimal:&quot;.&quot;,percent:&quot;%&quot;},de_DE:{separator:&quot;.&quot;,decimal:&quot;,&quot;,percent:&quot;%&quot;},fr_FR:{separator:&quot; &quot;,decimal:&quot;,&quot;,percent:&quot;%&quot;},&quot;default&quot;:&quot;en_US&quot;};
-MochiKit.Format.EXPORT_OK=[];
-MochiKit.Format.EXPORT_TAGS={&quot;:all&quot;:MochiKit.Format.EXPORT,&quot;:common&quot;:MochiKit.Format.EXPORT};
-MochiKit.Format.__new__=function(){
-var base=this.NAME+&quot;.&quot;;
-var k,v,o;
-for(k in this.LOCALE){
-o=this.LOCALE[k];
-if(typeof (o)==&quot;object&quot;){
-o.repr=function(){
-return this.NAME;
-};
-o.NAME=base+&quot;LOCALE.&quot;+k;
-}
-}
-for(k in this){
-o=this[k];
-if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
-try{
-o.NAME=base+k;
-}
-catch(e){
-}
-}
-}
-};
-MochiKit.Format.__new__();
-if(typeof (MochiKit.Base)!=&quot;undefined&quot;){
-MochiKit.Base._exportSymbols(this,MochiKit.Format);
-}else{
-(function(_278,_279){
-if((typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;)||(typeof (MochiKit.__compat__)==&quot;boolean&quot;&amp;&amp;MochiKit.__compat__)){
-var all=_279.EXPORT_TAGS[&quot;:all&quot;];
-for(var i=0;i&lt;all.length;i++){
-_278[all[i]]=_279[all[i]];
-}
-}
-})(this,MochiKit.Format);
-}
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Async&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Async depends on MochiKit.Base!&quot;;
-}
-if(typeof (MochiKit.Async)==&quot;undefined&quot;){
-MochiKit.Async={};
-}
-MochiKit.Async.NAME=&quot;MochiKit.Async&quot;;
-MochiKit.Async.VERSION=&quot;1.3.1&quot;;
-MochiKit.Async.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.Async.toString=function(){
-return this.__repr__();
-};
-MochiKit.Async.Deferred=function(_280){
-this.chain=[];
-this.id=this._nextId();
-this.fired=-1;
-this.paused=0;
-this.results=[null,null];
-this.canceller=_280;
-this.silentlyCancelled=false;
-this.chained=false;
-};
-MochiKit.Async.Deferred.prototype={repr:function(){
-var _281;
-if(this.fired==-1){
-_281=&quot;unfired&quot;;
-}else{
-if(this.fired===0){
-_281=&quot;success&quot;;
-}else{
-_281=&quot;error&quot;;
-}
-}
-return &quot;Deferred(&quot;+this.id+&quot;, &quot;+_281+&quot;)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),_nextId:MochiKit.Base.counter(),cancel:function(){
-var self=MochiKit.Async;
-if(this.fired==-1){
-if(this.canceller){
-this.canceller(this);
-}else{
-this.silentlyCancelled=true;
-}
-if(this.fired==-1){
-this.errback(new self.CancelledError(this));
-}
-}else{
-if((this.fired===0)&amp;&amp;(this.results[0] instanceof self.Deferred)){
-this.results[0].cancel();
-}
-}
-},_pause:function(){
-this.paused++;
-},_unpause:function(){
-this.paused--;
-if((this.paused===0)&amp;&amp;(this.fired&gt;=0)){
-this._fire();
-}
-},_continue:function(res){
-this._resback(res);
-this._unpause();
-},_resback:function(res){
-this.fired=((res instanceof Error)?1:0);
-this.results[this.fired]=res;
-this._fire();
-},_check:function(){
-if(this.fired!=-1){
-if(!this.silentlyCancelled){
-throw new MochiKit.Async.AlreadyCalledError(this);
-}
-this.silentlyCancelled=false;
-return;
-}
-},callback:function(res){
-this._check();
-if(res instanceof MochiKit.Async.Deferred){
-throw new Error(&quot;Deferred instances can only be chained if they are the result of a callback&quot;);
-}
-this._resback(res);
-},errback:function(res){
-this._check();
-var self=MochiKit.Async;
-if(res instanceof self.Deferred){
-throw new Error(&quot;Deferred instances can only be chained if they are the result of a callback&quot;);
-}
-if(!(res instanceof Error)){
-res=new self.GenericError(res);
-}
-this._resback(res);
-},addBoth:function(fn){
-if(arguments.length&gt;1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(fn,fn);
-},addCallback:function(fn){
-if(arguments.length&gt;1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(fn,null);
-},addErrback:function(fn){
-if(arguments.length&gt;1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(null,fn);
-},addCallbacks:function(cb,eb){
-if(this.chained){
-throw new Error(&quot;Chained Deferreds can not be re-used&quot;);
-}
-this.chain.push([cb,eb]);
-if(this.fired&gt;=0){
-this._fire();
-}
-return this;
-},_fire:function(){
-var _284=this.chain;
-var _285=this.fired;
-var res=this.results[_285];
-var self=this;
-var cb=null;
-while(_284.length&gt;0&amp;&amp;this.paused===0){
-var pair=_284.shift();
-var f=pair[_285];
-if(f===null){
-continue;
-}
-try{
-res=f(res);
-_285=((res instanceof Error)?1:0);
-if(res instanceof MochiKit.Async.Deferred){
-cb=function(res){
-self._continue(res);
-};
-this._pause();
-}
-}
-catch(err){
-_285=1;
-if(!(err instanceof Error)){
-err=new MochiKit.Async.GenericError(err);
-}
-res=err;
-}
-}
-this.fired=_285;
-this.results[_285]=res;
-if(cb&amp;&amp;this.paused){
-res.addBoth(cb);
-res.chained=true;
-}
-}};
-MochiKit.Base.update(MochiKit.Async,{evalJSONRequest:function(){
-return eval(&quot;(&quot;+arguments[0].responseText+&quot;)&quot;);
-},succeed:function(_287){
-var d=new MochiKit.Async.Deferred();
-d.callback.apply(d,arguments);
-return d;
-},fail:function(_288){
-var d=new MochiKit.Async.Deferred();
-d.errback.apply(d,arguments);
-return d;
-},getXMLHttpRequest:function(){
-var self=arguments.callee;
-if(!self.XMLHttpRequest){
-var _289=[function(){
-return new XMLHttpRequest();
-},function(){
-return new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
-},function(){
-return new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
-},function(){
-return new ActiveXObject(&quot;Msxml2.XMLHTTP.4.0&quot;);
-},function(){
-throw new MochiKit.Async.BrowserComplianceError(&quot;Browser does not support XMLHttpRequest&quot;);
-}];
-for(var i=0;i&lt;_289.length;i++){
-var func=_289[i];
-try{
-self.XMLHttpRequest=func;
-return func();
-}
-catch(e){
-}
-}
-}
-return self.XMLHttpRequest();
-},_nothing:function(){
-},_xhr_onreadystatechange:function(d){
-if(this.readyState==4){
-try{
-this.onreadystatechange=null;
-}
-catch(e){
-try{
-this.onreadystatechange=MochiKit.Async._nothing;
-}
-catch(e){
-}
-}
-var _290=null;
-try{
-_290=this.status;
-if(!_290&amp;&amp;MochiKit.Base.isNotEmpty(this.responseText)){
-_290=304;
-}
-}
-catch(e){
-}
-if(_290==200||_290==304){
-d.callback(this);
-}else{
-var err=new MochiKit.Async.XMLHttpRequestError(this,&quot;Request failed&quot;);
-if(err.number){
-d.errback(err);
-}else{
-d.errback(err);
-}
-}
-}
-},_xhr_canceller:function(req){
-try{
-req.onreadystatechange=null;
-}
-catch(e){
-try{
-req.onreadystatechange=MochiKit.Async._nothing;
-}
-catch(e){
-}
-}
-req.abort();
-},sendXMLHttpRequest:function(req,_293){
-if(typeof (_293)==&quot;undefined&quot;||_293===null){
-_293=&quot;&quot;;
-}
-var m=MochiKit.Base;
-var self=MochiKit.Async;
-var d=new self.Deferred(m.partial(self._xhr_canceller,req));
-try{
-req.onreadystatechange=m.bind(self._xhr_onreadystatechange,req,d);
-req.send(_293);
-}
-catch(e){
-try{
-req.onreadystatechange=null;
-}
-catch(ignore){
-}
-d.errback(e);
-}
-return d;
-},doSimpleXMLHttpRequest:function(url){
-var self=MochiKit.Async;
-var req=self.getXMLHttpRequest();
-if(arguments.length&gt;1){
-var m=MochiKit.Base;
-var qs=m.queryString.apply(null,m.extend(null,arguments,1));
-if(qs){
-url+=&quot;?&quot;+qs;
-}
-}
-req.open(&quot;GET&quot;,url,true);
-return self.sendXMLHttpRequest(req);
-},loadJSONDoc:function(url){
-var self=MochiKit.Async;
-var d=self.doSimpleXMLHttpRequest.apply(self,arguments);
-d=d.addCallback(self.evalJSONRequest);
-return d;
-},wait:function(_296,_297){
-var d=new MochiKit.Async.Deferred();
-var m=MochiKit.Base;
-if(typeof (_297)!=&quot;undefined&quot;){
-d.addCallback(function(){
-return _297;
-});
-}
-var _298=setTimeout(m.bind(&quot;callback&quot;,d),Math.floor(_296*1000));
-d.canceller=function(){
-try{
-clearTimeout(_298);
-}
-catch(e){
-}
-};
-return d;
-},callLater:function(_299,func){
-var m=MochiKit.Base;
-var _300=m.partial.apply(m,m.extend(null,arguments,1));
-return MochiKit.Async.wait(_299).addCallback(function(res){
-return _300();
-});
-}});
-MochiKit.Async.DeferredLock=function(){
-this.waiting=[];
-this.locked=false;
-this.id=this._nextId();
-};
-MochiKit.Async.DeferredLock.prototype={__class__:MochiKit.Async.DeferredLock,acquire:function(){
-d=new MochiKit.Async.Deferred();
-if(this.locked){
-this.waiting.push(d);
-}else{
-this.locked=true;
-d.callback(this);
-}
-return d;
-},release:function(){
-if(!this.locked){
-throw TypeError(&quot;Tried to release an unlocked DeferredLock&quot;);
-}
-this.locked=false;
-if(this.waiting.length&gt;0){
-this.locked=true;
-this.waiting.shift().callback(this);
-}
-},_nextId:MochiKit.Base.counter(),repr:function(){
-var _301;
-if(this.locked){
-_301=&quot;locked, &quot;+this.waiting.length+&quot; waiting&quot;;
-}else{
-_301=&quot;unlocked&quot;;
-}
-return &quot;DeferredLock(&quot;+this.id+&quot;, &quot;+_301+&quot;)&quot;;
-},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
-MochiKit.Async.DeferredList=function(list,_303,_304,_305,_306){
-this.list=list;
-this.resultList=new Array(this.list.length);
-this.chain=[];
-this.id=this._nextId();
-this.fired=-1;
-this.paused=0;
-this.results=[null,null];
-this.canceller=_306;
-this.silentlyCancelled=false;
-if(this.list.length===0&amp;&amp;!_303){
-this.callback(this.resultList);
-}
-this.finishedCount=0;
-this.fireOnOneCallback=_303;
-this.fireOnOneErrback=_304;
-this.consumeErrors=_305;
-var _307=0;
-MochiKit.Base.map(MochiKit.Base.bind(function(d){
-d.addCallback(MochiKit.Base.bind(this._cbDeferred,this),_307,true);
-d.addErrback(MochiKit.Base.bind(this._cbDeferred,this),_307,false);
-_307+=1;
-},this),this.list);
-};
-MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,MochiKit.Async.Deferred.prototype);
-MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,{_cbDeferred:function(_308,_309,_310){
-this.resultList[_308]=[_309,_310];
-this.finishedCount+=1;
-if(this.fired!==0){
-if(_309&amp;&amp;this.fireOnOneCallback){
-this.callback([_308,_310]);
-}else{
-if(!_309&amp;&amp;this.fireOnOneErrback){
-this.errback(_310);
-}else{
-if(this.finishedCount==this.list.length){
-this.callback(this.resultList);
-}
-}
-}
-}
-if(!_309&amp;&amp;this.consumeErrors){
-_310=null;
-}
-return _310;
-}});
-MochiKit.Async.gatherResults=function(_311){
-var d=new MochiKit.Async.DeferredList(_311,false,true,false);
-d.addCallback(function(_312){
-var ret=[];
-for(var i=0;i&lt;_312.length;i++){
-ret.push(_312[i][1]);
-}
-return ret;
-});
-return d;
-};
-MochiKit.Async.maybeDeferred=function(func){
-var self=MochiKit.Async;
-var _313;
-try{
-var r=func.apply(null,MochiKit.Base.extend([],arguments,1));
-if(r instanceof self.Deferred){
-_313=r;
-}else{
-if(r instanceof Error){
-_313=self.fail(r);
-}else{
-_313=self.succeed(r);
-}
-}
-}
-catch(e){
-_313=self.fail(e);
-}
-return _313;
-};
-MochiKit.Async.EXPORT=[&quot;AlreadyCalledError&quot;,&quot;CancelledError&quot;,&quot;BrowserComplianceError&quot;,&quot;GenericError&quot;,&quot;XMLHttpRequestError&quot;,&quot;Deferred&quot;,&quot;succeed&quot;,&quot;fail&quot;,&quot;getXMLHttpRequest&quot;,&quot;doSimpleXMLHttpRequest&quot;,&quot;loadJSONDoc&quot;,&quot;wait&quot;,&quot;callLater&quot;,&quot;sendXMLHttpRequest&quot;,&quot;DeferredLock&quot;,&quot;DeferredList&quot;,&quot;gatherResults&quot;,&quot;maybeDeferred&quot;];
-MochiKit.Async.EXPORT_OK=[&quot;evalJSONRequest&quot;];
-MochiKit.Async.__new__=function(){
-var m=MochiKit.Base;
-var ne=m.partial(m._newNamedError,this);
-ne(&quot;AlreadyCalledError&quot;,function(_316){
-this.deferred=_316;
-});
-ne(&quot;CancelledError&quot;,function(_317){
-this.deferred=_317;
-});
-ne(&quot;BrowserComplianceError&quot;,function(msg){
-this.message=msg;
-});
-ne(&quot;GenericError&quot;,function(msg){
-this.message=msg;
-});
-ne(&quot;XMLHttpRequestError&quot;,function(req,msg){
-this.req=req;
-this.message=msg;
-try{
-this.number=req.status;
-}
-catch(e){
-}
-});
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Async.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Async);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.DOM&quot;);
-dojo.require(&quot;MochiKit.Iter&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Iter&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Iter)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.DOM depends on MochiKit.Iter!&quot;;
-}
-if(typeof (MochiKit.DOM)==&quot;undefined&quot;){
-MochiKit.DOM={};
-}
-MochiKit.DOM.NAME=&quot;MochiKit.DOM&quot;;
-MochiKit.DOM.VERSION=&quot;1.3.1&quot;;
-MochiKit.DOM.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.DOM.toString=function(){
-return this.__repr__();
-};
-MochiKit.DOM.EXPORT=[&quot;formContents&quot;,&quot;currentWindow&quot;,&quot;currentDocument&quot;,&quot;withWindow&quot;,&quot;withDocument&quot;,&quot;registerDOMConverter&quot;,&quot;coerceToDOM&quot;,&quot;createDOM&quot;,&quot;createDOMFunc&quot;,&quot;getNodeAttribute&quot;,&quot;setNodeAttribute&quot;,&quot;updateNodeAttributes&quot;,&quot;appendChildNodes&quot;,&quot;replaceChildNodes&quot;,&quot;removeElement&quot;,&quot;swapDOM&quot;,&quot;BUTTON&quot;,&quot;TT&quot;,&quot;PRE&quot;,&quot;H1&quot;,&quot;H2&quot;,&quot;H3&quot;,&quot;BR&quot;,&quot;CANVAS&quot;,&quot;HR&quot;,&quot;LABEL&quot;,&quot;TEXTAREA&quot;,&quot;FORM&quot;,&quot;STRONG&quot;,&quot;SELECT&quot;,&quot;OPTION&quot;,&quot;OPTGROUP&quot;,&quot;LEGEND&quot;,&quot;FIELDSET&quot;,&quot;P&quot;,&quot;UL&quot;,&quot;OL&quot;,&quot;LI&quot;,&quot;TD&quot;,&quot;TR&quot;,&quot;THEAD&quot;,&quot;TBODY&quot;,&quot;TFOOT&quot;,&quot;TABLE&quot;,&quot;TH&quot;,&quot;INPUT&quot;,&quot;SPAN&quot;,&quot;A&quot;,&quot;DIV&quot;,&quot;IMG&quot;,&quot;getElement&quot;,&quot;$&quot;,&quot;computedStyle&quot;,&quot;getElementsByTagAndClassName&quot;,&quot;addToCallStack&quot;,&quot;addLoadEvent&quot;,&quot;focusOnLoad&quot;,&quot;setElementClass&quot;,&quot;toggleElementClass&quot;,&quot;addElementClass&quot;,&quot;removeElementClass&quot;,&quot;swapElementClass&quot;,&quot;hasElementClass&quot;,&quot;escapeHTML&quot;,&quot;toHTML&quot;,&quot;emitHTML&quot;,&quot;setDisplayForElement&quot;,&quot;hideElement&quot;,&quot;showElement&quot;,&quot;scrapeText&quot;,&quot;elementDimensions&quot;,&quot;elementPosition&quot;,&quot;setElementDimensions&quot;,&quot;setElementPosition&quot;,&quot;getViewportDimensions&quot;,&quot;setOpacity&quot;];
-MochiKit.DOM.EXPORT_OK=[&quot;domConverters&quot;];
-MochiKit.DOM.Dimensions=function(w,h){
-this.w=w;
-this.h=h;
-};
-MochiKit.DOM.Dimensions.prototype.repr=function(){
-var repr=MochiKit.Base.repr;
-return &quot;{w: &quot;+repr(this.w)+&quot;, h: &quot;+repr(this.h)+&quot;}&quot;;
-};
-MochiKit.DOM.Coordinates=function(x,y){
-this.x=x;
-this.y=y;
-};
-MochiKit.DOM.Coordinates.prototype.repr=function(){
-var repr=MochiKit.Base.repr;
-return &quot;{x: &quot;+repr(this.x)+&quot;, y: &quot;+repr(this.y)+&quot;}&quot;;
-};
-MochiKit.DOM.Coordinates.prototype.toString=function(){
-return this.repr();
-};
-MochiKit.Base.update(MochiKit.DOM,{setOpacity:function(elem,o){
-elem=MochiKit.DOM.getElement(elem);
-MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;opacity&quot;:o,&quot;-moz-opacity&quot;:o,&quot;-khtml-opacity&quot;:o,&quot;filter&quot;:&quot; alpha(opacity=&quot;+(o*100)+&quot;)&quot;}});
-},getViewportDimensions:function(){
-var d=new MochiKit.DOM.Dimensions();
-var w=MochiKit.DOM._window;
-var b=MochiKit.DOM._document.body;
-if(w.innerWidth){
-d.w=w.innerWidth;
-d.h=w.innerHeight;
-}else{
-if(b.parentElement.clientWidth){
-d.w=b.parentElement.clientWidth;
-d.h=b.parentElement.clientHeight;
-}else{
-if(b&amp;&amp;b.clientWidth){
-d.w=b.clientWidth;
-d.h=b.clientHeight;
-}
-}
-}
-return d;
-},elementDimensions:function(elem){
-var self=MochiKit.DOM;
-if(typeof (elem.w)==&quot;number&quot;||typeof (elem.h)==&quot;number&quot;){
-return new self.Dimensions(elem.w||0,elem.h||0);
-}
-elem=self.getElement(elem);
-if(!elem){
-return undefined;
-}
-if(self.computedStyle(elem,&quot;display&quot;)!=&quot;none&quot;){
-return new self.Dimensions(elem.offsetWidth||0,elem.offsetHeight||0);
-}
-var s=elem.style;
-var _322=s.visibility;
-var _323=s.position;
-s.visibility=&quot;hidden&quot;;
-s.position=&quot;absolute&quot;;
-s.display=&quot;&quot;;
-var _324=elem.offsetWidth;
-var _325=elem.offsetHeight;
-s.display=&quot;none&quot;;
-s.position=_323;
-s.visibility=_322;
-return new self.Dimensions(_324,_325);
-},elementPosition:function(elem,_326){
-var self=MochiKit.DOM;
-elem=self.getElement(elem);
-if(!elem){
-return undefined;
-}
-var c=new self.Coordinates(0,0);
-if(elem.x&amp;&amp;elem.y){
-c.x+=elem.x||0;
-c.y+=elem.y||0;
-return c;
-}else{
-if(elem.parentNode===null||self.computedStyle(elem,&quot;display&quot;)==&quot;none&quot;){
-return undefined;
-}
-}
-var box=null;
-var _329=null;
-var d=MochiKit.DOM._document;
-var de=d.documentElement;
-var b=d.body;
-if(elem.getBoundingClientRect){
-box=elem.getBoundingClientRect();
-c.x+=box.left+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
-c.y+=box.top+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
-}else{
-if(d.getBoxObjectFor){
-box=d.getBoxObjectFor(elem);
-c.x+=box.x;
-c.y+=box.y;
-}else{
-if(elem.offsetParent){
-c.x+=elem.offsetLeft;
-c.y+=elem.offsetTop;
-_329=elem.offsetParent;
-if(_329!=elem){
-while(_329){
-c.x+=_329.offsetLeft;
-c.y+=_329.offsetTop;
-_329=_329.offsetParent;
-}
-}
-var ua=navigator.userAgent.toLowerCase();
-if((typeof (opera)!=&quot;undefined&quot;&amp;&amp;parseFloat(opera.version())&lt;9)||(ua.indexOf(&quot;safari&quot;)!=-1&amp;&amp;self.computedStyle(elem,&quot;position&quot;)==&quot;absolute&quot;)){
-c.x-=b.offsetLeft;
-c.y-=b.offsetTop;
-}
-}
-}
-}
-if(typeof (_326)!=&quot;undefined&quot;){
-_326=arguments.callee(_326);
-if(_326){
-c.x-=(_326.x||0);
-c.y-=(_326.y||0);
-}
-}
-if(elem.parentNode){
-_329=elem.parentNode;
-}else{
-_329=null;
-}
-while(_329&amp;&amp;_329.tagName!=&quot;BODY&quot;&amp;&amp;_329.tagName!=&quot;HTML&quot;){
-c.x-=_329.scrollLeft;
-c.y-=_329.scrollTop;
-if(_329.parentNode){
-_329=_329.parentNode;
-}else{
-_329=null;
-}
-}
-return c;
-},setElementDimensions:function(elem,_332,_333){
-elem=MochiKit.DOM.getElement(elem);
-if(typeof (_333)==&quot;undefined&quot;){
-_333=&quot;px&quot;;
-}
-MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;width&quot;:_332.w+_333,&quot;height&quot;:_332.h+_333}});
-},setElementPosition:function(elem,_334,_335){
-elem=MochiKit.DOM.getElement(elem);
-if(typeof (_335)==&quot;undefined&quot;){
-_335=&quot;px&quot;;
-}
-MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;left&quot;:_334.x+_335,&quot;top&quot;:_334.y+_335}});
-},currentWindow:function(){
-return MochiKit.DOM._window;
-},currentDocument:function(){
-return MochiKit.DOM._document;
-},withWindow:function(win,func){
-var self=MochiKit.DOM;
-var _337=self._document;
-var _338=self._win;
-var rval;
-try{
-self._window=win;
-self._document=win.document;
-rval=func();
-}
-catch(e){
-self._window=_338;
-self._document=_337;
-throw e;
-}
-self._window=_338;
-self._document=_337;
-return rval;
-},formContents:function(elem){
-var _339=[];
-var _340=[];
-var m=MochiKit.Base;
-var self=MochiKit.DOM;
-if(typeof (elem)==&quot;undefined&quot;||elem===null){
-elem=self._document;
-}else{
-elem=self.getElement(elem);
-}
-m.nodeWalk(elem,function(elem){
-var name=elem.name;
-if(m.isNotEmpty(name)){
-var _341=elem.nodeName;
-if(_341==&quot;INPUT&quot;&amp;&amp;(elem.type==&quot;radio&quot;||elem.type==&quot;checkbox&quot;)&amp;&amp;!elem.checked){
-return null;
-}
-if(_341==&quot;SELECT&quot;){
-if(elem.selectedIndex&gt;=0){
-var opt=elem.options[elem.selectedIndex];
-_339.push(name);
-_340.push((opt.value)?opt.value:opt.text);
-return null;
-}
-_339.push(name);
-_340.push(&quot;&quot;);
-return null;
-}
-if(_341==&quot;FORM&quot;||_341==&quot;P&quot;||_341==&quot;SPAN&quot;||_341==&quot;DIV&quot;){
-return elem.childNodes;
-}
-_339.push(name);
-_340.push(elem.value||&quot;&quot;);
-return null;
-}
-return elem.childNodes;
-});
-return [_339,_340];
-},withDocument:function(doc,func){
-var self=MochiKit.DOM;
-var _344=self._document;
-var rval;
-try{
-self._document=doc;
-rval=func();
-}
-catch(e){
-self._document=_344;
-throw e;
-}
-self._document=_344;
-return rval;
-},registerDOMConverter:function(name,_345,wrap,_346){
-MochiKit.DOM.domConverters.register(name,_345,wrap,_346);
-},coerceToDOM:function(node,ctx){
-var im=MochiKit.Iter;
-var self=MochiKit.DOM;
-var iter=im.iter;
-var _350=im.repeat;
-var imap=im.imap;
-var _352=self.domConverters;
-var _353=self.coerceToDOM;
-var _354=MochiKit.Base.NotFound;
-while(true){
-if(typeof (node)==&quot;undefined&quot;||node===null){
-return null;
-}
-if(typeof (node.nodeType)!=&quot;undefined&quot;&amp;&amp;node.nodeType&gt;0){
-return node;
-}
-if(typeof (node)==&quot;number&quot;||typeof (node)==&quot;bool&quot;){
-node=node.toString();
-}
-if(typeof (node)==&quot;string&quot;){
-return self._document.createTextNode(node);
-}
-if(typeof (node.toDOM)==&quot;function&quot;){
-node=node.toDOM(ctx);
-continue;
-}
-if(typeof (node)==&quot;function&quot;){
-node=node(ctx);
-continue;
-}
-var _355=null;
-try{
-_355=iter(node);
-}
-catch(e){
-}
-if(_355){
-return imap(_353,_355,_350(ctx));
-}
-try{
-node=_352.match(node,ctx);
-continue;
-}
-catch(e){
-if(e!=_354){
-throw e;
-}
-}
-return self._document.createTextNode(node.toString());
-}
-return undefined;
-},setNodeAttribute:function(node,attr,_357){
-var o={};
-o[attr]=_357;
-try{
-return MochiKit.DOM.updateNodeAttributes(node,o);
-}
-catch(e){
-}
-return null;
-},getNodeAttribute:function(node,attr){
-var self=MochiKit.DOM;
-var _358=self.attributeArray.renames[attr];
-node=self.getElement(node);
-try{
-if(_358){
-return node[_358];
-}
-return node.getAttribute(attr);
-}
-catch(e){
-}
-return null;
-},updateNodeAttributes:function(node,_359){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)==&quot;string&quot;){
-elem=self.getElement(node);
-}
-if(_359){
-var _360=MochiKit.Base.updatetree;
-if(self.attributeArray.compliant){
-for(var k in _359){
-var v=_359[k];
-if(typeof (v)==&quot;object&quot;&amp;&amp;typeof (elem[k])==&quot;object&quot;){
-_360(elem[k],v);
-}else{
-if(k.substring(0,2)==&quot;on&quot;){
-if(typeof (v)==&quot;string&quot;){
-v=new Function(v);
-}
-elem[k]=v;
-}else{
-elem.setAttribute(k,v);
-}
-}
-}
-}else{
-var _361=self.attributeArray.renames;
-for(k in _359){
-v=_359[k];
-var _362=_361[k];
-if(k==&quot;style&quot;&amp;&amp;typeof (v)==&quot;string&quot;){
-elem.style.cssText=v;
-}else{
-if(typeof (_362)==&quot;string&quot;){
-elem[_362]=v;
-}else{
-if(typeof (elem[k])==&quot;object&quot;&amp;&amp;typeof (v)==&quot;object&quot;){
-_360(elem[k],v);
-}else{
-if(k.substring(0,2)==&quot;on&quot;){
-if(typeof (v)==&quot;string&quot;){
-v=new Function(v);
-}
-elem[k]=v;
-}else{
-elem.setAttribute(k,v);
-}
-}
-}
-}
-}
-}
-}
-return elem;
-},appendChildNodes:function(node){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)==&quot;string&quot;){
-elem=self.getElement(node);
-}
-var _363=[self.coerceToDOM(MochiKit.Base.extend(null,arguments,1),elem)];
-var _364=MochiKit.Base.concat;
-while(_363.length){
-var n=_363.shift();
-if(typeof (n)==&quot;undefined&quot;||n===null){
-}else{
-if(typeof (n.nodeType)==&quot;number&quot;){
-elem.appendChild(n);
-}else{
-_363=_364(n,_363);
-}
-}
-}
-return elem;
-},replaceChildNodes:function(node){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)==&quot;string&quot;){
-elem=self.getElement(node);
-arguments[0]=elem;
-}
-var _365;
-while((_365=elem.firstChild)){
-elem.removeChild(_365);
-}
-if(arguments.length&lt;2){
-return elem;
-}else{
-return self.appendChildNodes.apply(this,arguments);
-}
-},createDOM:function(name,_366){
-var elem;
-var self=MochiKit.DOM;
-var m=MochiKit.Base;
-if(typeof (_366)==&quot;string&quot;||typeof (_366)==&quot;number&quot;){
-var args=m.extend([name,null],arguments,1);
-return arguments.callee.apply(this,args);
-}
-if(typeof (name)==&quot;string&quot;){
-if(_366&amp;&amp;&quot;name&quot; in _366&amp;&amp;!self.attributeArray.compliant){
-name=(&quot;&lt;&quot;+name+&quot; name=\&quot;&quot;+self.escapeHTML(_366.name)+&quot;\&quot;&gt;&quot;);
-}
-elem=self._document.createElement(name);
-}else{
-elem=name;
-}
-if(_366){
-self.updateNodeAttributes(elem,_366);
-}
-if(arguments.length&lt;=2){
-return elem;
-}else{
-var args=m.extend([elem],arguments,2);
-return self.appendChildNodes.apply(this,args);
-}
-},createDOMFunc:function(){
-var m=MochiKit.Base;
-return m.partial.apply(this,m.extend([MochiKit.DOM.createDOM],arguments));
-},swapDOM:function(dest,src){
-var self=MochiKit.DOM;
-dest=self.getElement(dest);
-var _369=dest.parentNode;
-if(src){
-src=self.getElement(src);
-_369.replaceChild(src,dest);
-}else{
-_369.removeChild(dest);
-}
-return src;
-},getElement:function(id){
-var self=MochiKit.DOM;
-if(arguments.length==1){
-return ((typeof (id)==&quot;string&quot;)?self._document.getElementById(id):id);
-}else{
-return MochiKit.Base.map(self.getElement,arguments);
-}
-},computedStyle:function(_371,_372,_373){
-if(arguments.length==2){
-_373=_372;
-}
-var self=MochiKit.DOM;
-var el=self.getElement(_371);
-var _375=self._document;
-if(!el||el==_375){
-return undefined;
-}
-if(el.currentStyle){
-return el.currentStyle[_372];
-}
-if(typeof (_375.defaultView)==&quot;undefined&quot;){
-return undefined;
-}
-if(_375.defaultView===null){
-return undefined;
-}
-var _376=_375.defaultView.getComputedStyle(el,null);
-if(typeof (_376)==&quot;undefined&quot;||_376===null){
-return undefined;
-}
-return _376.getPropertyValue(_373);
-},getElementsByTagAndClassName:function(_377,_378,_379){
-var self=MochiKit.DOM;
-if(typeof (_377)==&quot;undefined&quot;||_377===null){
-_377=&quot;*&quot;;
-}
-if(typeof (_379)==&quot;undefined&quot;||_379===null){
-_379=self._document;
-}
-_379=self.getElement(_379);
-var _380=(_379.getElementsByTagName(_377)||self._document.all);
-if(typeof (_378)==&quot;undefined&quot;||_378===null){
-return MochiKit.Base.extend(null,_380);
-}
-var _381=[];
-for(var i=0;i&lt;_380.length;i++){
-var _382=_380[i];
-var _383=_382.className.split(&quot; &quot;);
-for(var j=0;j&lt;_383.length;j++){
-if(_383[j]==_378){
-_381.push(_382);
-break;
-}
-}
-}
-return _381;
-},_newCallStack:function(path,once){
-var rval=function(){
-var _386=arguments.callee.callStack;
-for(var i=0;i&lt;_386.length;i++){
-if(_386[i].apply(this,arguments)===false){
-break;
-}
-}
-if(once){
-try{
-this[path]=null;
-}
-catch(e){
-}
-}
-};
-rval.callStack=[];
-return rval;
-},addToCallStack:function(_387,path,func,once){
-var self=MochiKit.DOM;
-var _388=_387[path];
-var _389=_388;
-if(!(typeof (_388)==&quot;function&quot;&amp;&amp;typeof (_388.callStack)==&quot;object&quot;&amp;&amp;_388.callStack!==null)){
-_389=self._newCallStack(path,once);
-if(typeof (_388)==&quot;function&quot;){
-_389.callStack.push(_388);
-}
-_387[path]=_389;
-}
-_389.callStack.push(func);
-},addLoadEvent:function(func){
-var self=MochiKit.DOM;
-self.addToCallStack(self._window,&quot;onload&quot;,func,true);
-},focusOnLoad:function(_390){
-var self=MochiKit.DOM;
-self.addLoadEvent(function(){
-_390=self.getElement(_390);
-if(_390){
-_390.focus();
-}
-});
-},setElementClass:function(_391,_392){
-var self=MochiKit.DOM;
-var obj=self.getElement(_391);
-if(self.attributeArray.compliant){
-obj.setAttribute(&quot;class&quot;,_392);
-}else{
-obj.setAttribute(&quot;className&quot;,_392);
-}
-},toggleElementClass:function(_393){
-var self=MochiKit.DOM;
-for(var i=1;i&lt;arguments.length;i++){
-var obj=self.getElement(arguments[i]);
-if(!self.addElementClass(obj,_393)){
-self.removeElementClass(obj,_393);
-}
-}
-},addElementClass:function(_394,_395){
-var self=MochiKit.DOM;
-var obj=self.getElement(_394);
-var cls=obj.className;
-if(cls.length===0){
-self.setElementClass(obj,_395);
-return true;
-}
-if(cls==_395){
-return false;
-}
-var _397=obj.className.split(&quot; &quot;);
-for(var i=0;i&lt;_397.length;i++){
-if(_397[i]==_395){
-return false;
-}
-}
-self.setElementClass(obj,cls+&quot; &quot;+_395);
-return true;
-},removeElementClass:function(_398,_399){
-var self=MochiKit.DOM;
-var obj=self.getElement(_398);
-var cls=obj.className;
-if(cls.length===0){
-return false;
-}
-if(cls==_399){
-self.setElementClass(obj,&quot;&quot;);
-return true;
-}
-var _400=obj.className.split(&quot; &quot;);
-for(var i=0;i&lt;_400.length;i++){
-if(_400[i]==_399){
-_400.splice(i,1);
-self.setElementClass(obj,_400.join(&quot; &quot;));
-return true;
-}
-}
-return false;
-},swapElementClass:function(_401,_402,_403){
-var obj=MochiKit.DOM.getElement(_401);
-var res=MochiKit.DOM.removeElementClass(obj,_402);
-if(res){
-MochiKit.DOM.addElementClass(obj,_403);
-}
-return res;
-},hasElementClass:function(_404,_405){
-var obj=MochiKit.DOM.getElement(_404);
-var _406=obj.className.split(&quot; &quot;);
-for(var i=1;i&lt;arguments.length;i++){
-var good=false;
-for(var j=0;j&lt;_406.length;j++){
-if(_406[j]==arguments[i]){
-good=true;
-break;
-}
-}
-if(!good){
-return false;
-}
-}
-return true;
-},escapeHTML:function(s){
-return s.replace(/&amp;/g,&quot;&amp;&quot;).replace(/&quot;/g,&quot;&quot;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&gt;/g,&quot;&gt;&quot;);
-},toHTML:function(dom){
-return MochiKit.DOM.emitHTML(dom).join(&quot;&quot;);
-},emitHTML:function(dom,lst){
-if(typeof (lst)==&quot;undefined&quot;||lst===null){
-lst=[];
-}
-var _409=[dom];
-var self=MochiKit.DOM;
-var _410=self.escapeHTML;
-var _411=self.attributeArray;
-while(_409.length){
-dom=_409.pop();
-if(typeof (dom)==&quot;string&quot;){
-lst.push(dom);
-}else{
-if(dom.nodeType==1){
-lst.push(&quot;&lt;&quot;+dom.nodeName.toLowerCase());
-var _412=[];
-var _413=_411(dom);
-for(var i=0;i&lt;_413.length;i++){
-var a=_413[i];
-_412.push([&quot; &quot;,a.name,&quot;=\&quot;&quot;,_410(a.value),&quot;\&quot;&quot;]);
-}
-_412.sort();
-for(i=0;i&lt;_412.length;i++){
-var _414=_412[i];
-for(var j=0;j&lt;_414.length;j++){
-lst.push(_414[j]);
-}
-}
-if(dom.hasChildNodes()){
-lst.push(&quot;&gt;&quot;);
-_409.push(&quot;&lt;/&quot;+dom.nodeName.toLowerCase()+&quot;&gt;&quot;);
-var _415=dom.childNodes;
-for(i=_415.length-1;i&gt;=0;i--){
-_409.push(_415[i]);
-}
-}else{
-lst.push(&quot;/&gt;&quot;);
-}
-}else{
-if(dom.nodeType==3){
-lst.push(_410(dom.nodeValue));
-}
-}
-}
-}
-return lst;
-},setDisplayForElement:function(_416,_417){
-var m=MochiKit.Base;
-var _418=m.extend(null,arguments,1);
-MochiKit.Iter.forEach(m.filter(null,m.map(MochiKit.DOM.getElement,_418)),function(_417){
-_417.style.display=_416;
-});
-},scrapeText:function(node,_419){
-var rval=[];
-(function(node){
-var cn=node.childNodes;
-if(cn){
-for(var i=0;i&lt;cn.length;i++){
-arguments.callee.call(this,cn[i]);
-}
-}
-var _421=node.nodeValue;
-if(typeof (_421)==&quot;string&quot;){
-rval.push(_421);
-}
-})(MochiKit.DOM.getElement(node));
-if(_419){
-return rval;
-}else{
-return rval.join(&quot;&quot;);
-}
-},__new__:function(win){
-var m=MochiKit.Base;
-this._document=document;
-this._window=win;
-this.domConverters=new m.AdapterRegistry();
-var _422=this._document.createElement(&quot;span&quot;);
-var _423;
-if(_422&amp;&amp;_422.attributes&amp;&amp;_422.attributes.length&gt;0){
-var _424=m.filter;
-_423=function(node){
-return _424(_423.ignoreAttrFilter,node.attributes);
-};
-_423.ignoreAttr={};
-MochiKit.Iter.forEach(_422.attributes,function(a){
-_423.ignoreAttr[a.name]=a.value;
-});
-_423.ignoreAttrFilter=function(a){
-return (_423.ignoreAttr[a.name]!=a.value);
-};
-_423.compliant=false;
-_423.renames={&quot;class&quot;:&quot;className&quot;,&quot;checked&quot;:&quot;defaultChecked&quot;,&quot;usemap&quot;:&quot;useMap&quot;,&quot;for&quot;:&quot;htmlFor&quot;};
-}else{
-_423=function(node){
-return node.attributes;
-};
-_423.compliant=true;
-_423.renames={};
-}
-this.attributeArray=_423;
-var _425=this.createDOMFunc;
-this.UL=_425(&quot;ul&quot;);
-this.OL=_425(&quot;ol&quot;);
-this.LI=_425(&quot;li&quot;);
-this.TD=_425(&quot;td&quot;);
-this.TR=_425(&quot;tr&quot;);
-this.TBODY=_425(&quot;tbody&quot;);
-this.THEAD=_425(&quot;thead&quot;);
-this.TFOOT=_425(&quot;tfoot&quot;);
-this.TABLE=_425(&quot;table&quot;);
-this.TH=_425(&quot;th&quot;);
-this.INPUT=_425(&quot;input&quot;);
-this.SPAN=_425(&quot;span&quot;);
-this.A=_425(&quot;a&quot;);
-this.DIV=_425(&quot;div&quot;);
-this.IMG=_425(&quot;img&quot;);
-this.BUTTON=_425(&quot;button&quot;);
-this.TT=_425(&quot;tt&quot;);
-this.PRE=_425(&quot;pre&quot;);
-this.H1=_425(&quot;h1&quot;);
-this.H2=_425(&quot;h2&quot;);
-this.H3=_425(&quot;h3&quot;);
-this.BR=_425(&quot;br&quot;);
-this.HR=_425(&quot;hr&quot;);
-this.LABEL=_425(&quot;label&quot;);
-this.TEXTAREA=_425(&quot;textarea&quot;);
-this.FORM=_425(&quot;form&quot;);
-this.P=_425(&quot;p&quot;);
-this.SELECT=_425(&quot;select&quot;);
-this.OPTION=_425(&quot;option&quot;);
-this.OPTGROUP=_425(&quot;optgroup&quot;);
-this.LEGEND=_425(&quot;legend&quot;);
-this.FIELDSET=_425(&quot;fieldset&quot;);
-this.STRONG=_425(&quot;strong&quot;);
-this.CANVAS=_425(&quot;canvas&quot;);
-this.hideElement=m.partial(this.setDisplayForElement,&quot;none&quot;);
-this.showElement=m.partial(this.setDisplayForElement,&quot;block&quot;);
-this.removeElement=this.swapDOM;
-this.$=this.getElement;
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-}});
-MochiKit.DOM.__new__(((typeof (window)==&quot;undefined&quot;)?this:window));
-if(!MochiKit.__compat__){
-withWindow=MochiKit.DOM.withWindow;
-withDocument=MochiKit.DOM.withDocument;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.DOM);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.LoggingPane&quot;);
-dojo.require(&quot;MochiKit.Logging&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Logging&quot;,[]);
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;||typeof (MochiKit.Logging)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.LoggingPane depends on MochiKit.Base and MochiKit.Logging!&quot;;
-}
-if(typeof (MochiKit.LoggingPane)==&quot;undefined&quot;){
-MochiKit.LoggingPane={};
-}
-MochiKit.LoggingPane.NAME=&quot;MochiKit.LoggingPane&quot;;
-MochiKit.LoggingPane.VERSION=&quot;1.3.1&quot;;
-MochiKit.LoggingPane.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.LoggingPane.toString=function(){
-return this.__repr__();
-};
-MochiKit.LoggingPane.createLoggingPane=function(_426){
-var m=MochiKit.LoggingPane;
-_426=!(!_426);
-if(m._loggingPane&amp;&amp;m._loggingPane.inline!=_426){
-m._loggingPane.closePane();
-m._loggingPane=null;
-}
-if(!m._loggingPane||m._loggingPane.closed){
-m._loggingPane=new m.LoggingPane(_426,MochiKit.Logging.logger);
-}
-return m._loggingPane;
-};
-MochiKit.LoggingPane.LoggingPane=function(_427,_428){
-if(typeof (_428)==&quot;undefined&quot;||_428===null){
-_428=MochiKit.Logging.logger;
-}
-this.logger=_428;
-var _429=MochiKit.Base.update;
-var _430=MochiKit.Base.updatetree;
-var bind=MochiKit.Base.bind;
-var _431=MochiKit.Base.clone;
-var win=window;
-var uid=&quot;_MochiKit_LoggingPane&quot;;
-if(typeof (MochiKit.DOM)!=&quot;undefined&quot;){
-win=MochiKit.DOM.currentWindow();
-}
-if(!_427){
-var url=win.location.href.split(&quot;?&quot;)[0].replace(/[:\/.&gt;&lt;&amp;]/g,&quot;_&quot;);
-var name=uid+&quot;_&quot;+url;
-var nwin=win.open(&quot;&quot;,name,&quot;dependent,resizable,height=200&quot;);
-if(!nwin){
-alert(&quot;Not able to open debugging window due to pop-up blocking.&quot;);
-return undefined;
-}
-nwin.document.write(&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 4.0 Transitional//EN\&quot; &quot;+&quot;\&quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd\">http://www.w3.org/TR/html4/loose.dtd\</A>&quot;&gt;&quot;+&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;[MochiKit.LoggingPane]&lt;/title&gt;&lt;/head&gt;&quot;+&quot;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;);
-nwin.document.close();
-nwin.document.title+=&quot; &quot;+win.document.title;
-win=nwin;
-}
-var doc=win.document;
-this.doc=doc;
-var _434=doc.getElementById(uid);
-var _435=!!_434;
-if(_434&amp;&amp;typeof (_434.loggingPane)!=&quot;undefined&quot;){
-_434.loggingPane.logger=this.logger;
-_434.loggingPane.buildAndApplyFilter();
-return _434.loggingPane;
-}
-if(_435){
-var _436;
-while((_436=_434.firstChild)){
-_434.removeChild(_436);
-}
-}else{
-_434=doc.createElement(&quot;div&quot;);
-_434.id=uid;
-}
-_434.loggingPane=this;
-var _437=doc.createElement(&quot;input&quot;);
-var _438=doc.createElement(&quot;input&quot;);
-var _439=doc.createElement(&quot;button&quot;);
-var _440=doc.createElement(&quot;button&quot;);
-var _441=doc.createElement(&quot;button&quot;);
-var _442=doc.createElement(&quot;button&quot;);
-var _443=doc.createElement(&quot;div&quot;);
-var _444=doc.createElement(&quot;div&quot;);
-var _445=uid+&quot;_Listener&quot;;
-this.colorTable=_431(this.colorTable);
-var _446=[];
-var _447=null;
-var _448=function(msg){
-var _449=msg.level;
-if(typeof (_449)==&quot;number&quot;){
-_449=MochiKit.Logging.LogLevel[_449];
-}
-return _449;
-};
-var _450=function(msg){
-return msg.info.join(&quot; &quot;);
-};
-var _451=bind(function(msg){
-var _452=_448(msg);
-var text=_450(msg);
-var c=this.colorTable[_452];
-var p=doc.createElement(&quot;span&quot;);
-p.className=&quot;MochiKit-LogMessage MochiKit-LogLevel-&quot;+_452;
-p.style.cssText=&quot;margin: 0px; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; white-space: pre-wrap; white-space: pre-line; word-wrap: break-word; wrap-option: emergency; color: &quot;+c;
-p.appendChild(doc.createTextNode(_452+&quot;: &quot;+text));
-_444.appendChild(p);
-_444.appendChild(doc.createElement(&quot;br&quot;));
-if(_443.offsetHeight&gt;_443.scrollHeight){
-_443.scrollTop=0;
-}else{
-_443.scrollTop=_443.scrollHeight;
-}
-},this);
-var _454=function(msg){
-_446[_446.length]=msg;
-_451(msg);
-};
-var _455=function(){
-var _456,infore;
-try{
-_456=new RegExp(_437.value);
-infore=new RegExp(_438.value);
-}
-catch(e){
-logDebug(&quot;Error in filter regex: &quot;+e.message);
-return null;
-}
-return function(msg){
-return (_456.test(_448(msg))&amp;&amp;infore.test(_450(msg)));
-};
-};
-var _457=function(){
-while(_444.firstChild){
-_444.removeChild(_444.firstChild);
-}
-};
-var _458=function(){
-_446=[];
-_457();
-};
-var _459=bind(function(){
-if(this.closed){
-return;
-}
-this.closed=true;
-if(MochiKit.LoggingPane._loggingPane==this){
-MochiKit.LoggingPane._loggingPane=null;
-}
-this.logger.removeListener(_445);
-_434.loggingPane=null;
-if(_427){
-_434.parentNode.removeChild(_434);
-}else{
-this.win.close();
-}
-},this);
-var _460=function(){
-_457();
-for(var i=0;i&lt;_446.length;i++){
-var msg=_446[i];
-if(_447===null||_447(msg)){
-_451(msg);
-}
-}
-};
-this.buildAndApplyFilter=function(){
-_447=_455();
-_460();
-this.logger.removeListener(_445);
-this.logger.addListener(_445,_447,_454);
-};
-var _461=bind(function(){
-_446=this.logger.getMessages();
-_460();
-},this);
-var _462=bind(function(_463){
-_463=_463||window.event;
-key=_463.which||_463.keyCode;
-if(key==13){
-this.buildAndApplyFilter();
-}
-},this);
-var _464=&quot;display: block; z-index: 1000; left: 0px; bottom: 0px; position: fixed; width: 100%; background-color: white; font: &quot;+this.logFont;
-if(_427){
-_464+=&quot;; height: 10em; border-top: 2px solid black&quot;;
-}else{
-_464+=&quot;; height: 100%;&quot;;
-}
-_434.style.cssText=_464;
-if(!_435){
-doc.body.appendChild(_434);
-}
-_464={&quot;cssText&quot;:&quot;width: 33%; display: inline; font: &quot;+this.logFont};
-_430(_437,{&quot;value&quot;:&quot;FATAL|ERROR|WARNING|INFO|DEBUG&quot;,&quot;onkeypress&quot;:_462,&quot;style&quot;:_464});
-_434.appendChild(_437);
-_430(_438,{&quot;value&quot;:&quot;.*&quot;,&quot;onkeypress&quot;:_462,&quot;style&quot;:_464});
-_434.appendChild(_438);
-_464=&quot;width: 8%; display:inline; font: &quot;+this.logFont;
-_439.appendChild(doc.createTextNode(&quot;Filter&quot;));
-_439.onclick=bind(&quot;buildAndApplyFilter&quot;,this);
-_439.style.cssText=_464;
-_434.appendChild(_439);
-_440.appendChild(doc.createTextNode(&quot;Load&quot;));
-_440.onclick=_461;
-_440.style.cssText=_464;
-_434.appendChild(_440);
-_441.appendChild(doc.createTextNode(&quot;Clear&quot;));
-_441.onclick=_458;
-_441.style.cssText=_464;
-_434.appendChild(_441);
-_442.appendChild(doc.createTextNode(&quot;Close&quot;));
-_442.onclick=_459;
-_442.style.cssText=_464;
-_434.appendChild(_442);
-_443.style.cssText=&quot;overflow: auto; width: 100%&quot;;
-_444.style.cssText=&quot;width: 100%; height: &quot;+(_427?&quot;8em&quot;:&quot;100%&quot;);
-_443.appendChild(_444);
-_434.appendChild(_443);
-this.buildAndApplyFilter();
-_461();
-if(_427){
-this.win=undefined;
-}else{
-this.win=win;
-}
-this.inline=_427;
-this.closePane=_459;
-this.closed=false;
-return this;
-};
-MochiKit.LoggingPane.LoggingPane.prototype={&quot;logFont&quot;:&quot;8pt Verdana,sans-serif&quot;,&quot;colorTable&quot;:{&quot;ERROR&quot;:&quot;red&quot;,&quot;FATAL&quot;:&quot;darkred&quot;,&quot;WARNING&quot;:&quot;blue&quot;,&quot;INFO&quot;:&quot;black&quot;,&quot;DEBUG&quot;:&quot;green&quot;}};
-MochiKit.LoggingPane.EXPORT_OK=[&quot;LoggingPane&quot;];
-MochiKit.LoggingPane.EXPORT=[&quot;createLoggingPane&quot;];
-MochiKit.LoggingPane.__new__=function(){
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:MochiKit.Base.concat(this.EXPORT,this.EXPORT_OK)};
-MochiKit.Base.nameFunctions(this);
-MochiKit.LoggingPane._loggingPane=null;
-};
-MochiKit.LoggingPane.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.LoggingPane);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Color&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Color depends on MochiKit.Base&quot;;
-}
-if(typeof (MochiKit.Color)==&quot;undefined&quot;){
-MochiKit.Color={};
-}
-MochiKit.Color.NAME=&quot;MochiKit.Color&quot;;
-MochiKit.Color.VERSION=&quot;1.3.1&quot;;
-MochiKit.Color.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.Color.toString=function(){
-return this.__repr__();
-};
-MochiKit.Color.Color=function(red,_466,blue,_468){
-if(typeof (_468)==&quot;undefined&quot;||_468===null){
-_468=1;
-}
-this.rgb={r:red,g:_466,b:blue,a:_468};
-};
-MochiKit.Color.Color.prototype={__class__:MochiKit.Color.Color,colorWithAlpha:function(_469){
-var rgb=this.rgb;
-var m=MochiKit.Color;
-return m.Color.fromRGB(rgb.r,rgb.g,rgb.b,_469);
-},colorWithHue:function(hue){
-var hsl=this.asHSL();
-hsl.h=hue;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},colorWithSaturation:function(_473){
-var hsl=this.asHSL();
-hsl.s=_473;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},colorWithLightness:function(_474){
-var hsl=this.asHSL();
-hsl.l=_474;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},darkerColorWithLevel:function(_475){
-var hsl=this.asHSL();
-hsl.l=Math.max(hsl.l-_475,0);
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},lighterColorWithLevel:function(_476){
-var hsl=this.asHSL();
-hsl.l=Math.min(hsl.l+_476,1);
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},blendedColor:function(_477,_478){
-if(typeof (_478)==&quot;undefined&quot;||_478===null){
-_478=0.5;
-}
-var sf=1-_478;
-var s=this.rgb;
-var d=_477.rgb;
-var df=_478;
-return MochiKit.Color.Color.fromRGB((s.r*sf)+(d.r*df),(s.g*sf)+(d.g*df),(s.b*sf)+(d.b*df),(s.a*sf)+(d.a*df));
-},compareRGB:function(_481){
-var a=this.asRGB();
-var b=_481.asRGB();
-return MochiKit.Base.compare([a.r,a.g,a.b,a.a],[b.r,b.g,b.b,b.a]);
-},isLight:function(){
-return this.asHSL().b&gt;0.5;
-},isDark:function(){
-return (!this.isLight());
-},toHSLString:function(){
-var c=this.asHSL();
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._hslString;
-if(!rval){
-var mid=(ccc(c.h,360).toFixed(0)+&quot;,&quot;+ccc(c.s,100).toPrecision(4)+&quot;%&quot;+&quot;,&quot;+ccc(c.l,100).toPrecision(4)+&quot;%&quot;);
-var a=c.a;
-if(a&gt;=1){
-a=1;
-rval=&quot;hsl(&quot;+mid+&quot;)&quot;;
-}else{
-if(a&lt;=0){
-a=0;
-}
-rval=&quot;hsla(&quot;+mid+&quot;,&quot;+a+&quot;)&quot;;
-}
-this._hslString=rval;
-}
-return rval;
-},toRGBString:function(){
-var c=this.rgb;
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._rgbString;
-if(!rval){
-var mid=(ccc(c.r,255).toFixed(0)+&quot;,&quot;+ccc(c.g,255).toFixed(0)+&quot;,&quot;+ccc(c.b,255).toFixed(0));
-if(c.a!=1){
-rval=&quot;rgba(&quot;+mid+&quot;,&quot;+c.a+&quot;)&quot;;
-}else{
-rval=&quot;rgb(&quot;+mid+&quot;)&quot;;
-}
-this._rgbString=rval;
-}
-return rval;
-},asRGB:function(){
-return MochiKit.Base.clone(this.rgb);
-},toHexString:function(){
-var m=MochiKit.Color;
-var c=this.rgb;
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._hexString;
-if(!rval){
-rval=(&quot;#&quot;+m.toColorPart(ccc(c.r,255))+m.toColorPart(ccc(c.g,255))+m.toColorPart(ccc(c.b,255)));
-this._hexString=rval;
-}
-return rval;
-},asHSV:function(){
-var hsv=this.hsv;
-var c=this.rgb;
-if(typeof (hsv)==&quot;undefined&quot;||hsv===null){
-hsv=MochiKit.Color.rgbToHSV(this.rgb);
-this.hsv=hsv;
-}
-return MochiKit.Base.clone(hsv);
-},asHSL:function(){
-var hsl=this.hsl;
-var c=this.rgb;
-if(typeof (hsl)==&quot;undefined&quot;||hsl===null){
-hsl=MochiKit.Color.rgbToHSL(this.rgb);
-this.hsl=hsl;
-}
-return MochiKit.Base.clone(hsl);
-},toString:function(){
-return this.toRGBString();
-},repr:function(){
-var c=this.rgb;
-var col=[c.r,c.g,c.b,c.a];
-return this.__class__.NAME+&quot;(&quot;+col.join(&quot;, &quot;)+&quot;)&quot;;
-}};
-MochiKit.Base.update(MochiKit.Color.Color,{fromRGB:function(red,_486,blue,_487){
-var _488=MochiKit.Color.Color;
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_486=rgb.g;
-blue=rgb.b;
-if(typeof (rgb.a)==&quot;undefined&quot;){
-_487=undefined;
-}else{
-_487=rgb.a;
-}
-}
-return new _488(red,_486,blue,_487);
-},fromHSL:function(hue,_489,_490,_491){
-var m=MochiKit.Color;
-return m.Color.fromRGB(m.hslToRGB.apply(m,arguments));
-},fromHSV:function(hue,_492,_493,_494){
-var m=MochiKit.Color;
-return m.Color.fromRGB(m.hsvToRGB.apply(m,arguments));
-},fromName:function(name){
-var _495=MochiKit.Color.Color;
-if(name.charAt(0)==&quot;\&quot;&quot;){
-name=name.substr(1,name.length-2);
-}
-var _496=_495._namedColors[name.toLowerCase()];
-if(typeof (_496)==&quot;string&quot;){
-return _495.fromHexString(_496);
-}else{
-if(name==&quot;transparent&quot;){
-return _495.transparentColor();
-}
-}
-return null;
-},fromString:function(_497){
-var self=MochiKit.Color.Color;
-var _498=_497.substr(0,3);
-if(_498==&quot;rgb&quot;){
-return self.fromRGBString(_497);
-}else{
-if(_498==&quot;hsl&quot;){
-return self.fromHSLString(_497);
-}else{
-if(_497.charAt(0)==&quot;#&quot;){
-return self.fromHexString(_497);
-}
-}
-}
-return self.fromName(_497);
-},fromHexString:function(_499){
-if(_499.charAt(0)==&quot;#&quot;){
-_499=_499.substring(1);
-}
-var _500=[];
-var i,hex;
-if(_499.length==3){
-for(i=0;i&lt;3;i++){
-hex=_499.substr(i,1);
-_500.push(parseInt(hex+hex,16)/255);
-}
-}else{
-for(i=0;i&lt;6;i+=2){
-hex=_499.substr(i,2);
-_500.push(parseInt(hex,16)/255);
-}
-}
-var _501=MochiKit.Color.Color;
-return _501.fromRGB.apply(_501,_500);
-},_fromColorString:function(pre,_503,_504,_505){
-if(_505.indexOf(pre)===0){
-_505=_505.substring(_505.indexOf(&quot;(&quot;,3)+1,_505.length-1);
-}
-var _506=_505.split(/\s*,\s*/);
-var _507=[];
-for(var i=0;i&lt;_506.length;i++){
-var c=_506[i];
-var val;
-var _508=c.substring(c.length-3);
-if(c.charAt(c.length-1)==&quot;%&quot;){
-val=0.01*parseFloat(c.substring(0,c.length-1));
-}else{
-if(_508==&quot;deg&quot;){
-val=parseFloat(c)/360;
-}else{
-if(_508==&quot;rad&quot;){
-val=parseFloat(c)/(Math.PI*2);
-}else{
-val=_504[i]*parseFloat(c);
-}
-}
-}
-_507.push(val);
-}
-return this[_503].apply(this,_507);
-},fromComputedStyle:function(elem,_509,_510){
-var d=MochiKit.DOM;
-var cls=MochiKit.Color.Color;
-for(elem=d.getElement(elem);elem;elem=elem.parentNode){
-var _511=d.computedStyle.apply(d,arguments);
-if(!_511){
-continue;
-}
-var _512=cls.fromString(_511);
-if(!_512){
-break;
-}
-if(_512.asRGB().a&gt;0){
-return _512;
-}
-}
-return null;
-},fromBackground:function(elem){
-var cls=MochiKit.Color.Color;
-return cls.fromComputedStyle(elem,&quot;backgroundColor&quot;,&quot;background-color&quot;)||cls.whiteColor();
-},fromText:function(elem){
-var cls=MochiKit.Color.Color;
-return cls.fromComputedStyle(elem,&quot;color&quot;,&quot;color&quot;)||cls.blackColor();
-},namedColors:function(){
-return MochiKit.Base.clone(MochiKit.Color.Color._namedColors);
-}});
-MochiKit.Base.update(MochiKit.Color,{clampColorComponent:function(v,_513){
-v*=_513;
-if(v&lt;0){
-return 0;
-}else{
-if(v&gt;_513){
-return _513;
-}else{
-return v;
-}
-}
-},_hslValue:function(n1,n2,hue){
-if(hue&gt;6){
-hue-=6;
-}else{
-if(hue&lt;0){
-hue+=6;
-}
-}
-var val;
-if(hue&lt;1){
-val=n1+(n2-n1)*hue;
-}else{
-if(hue&lt;3){
-val=n2;
-}else{
-if(hue&lt;4){
-val=n1+(n2-n1)*(4-hue);
-}else{
-val=n1;
-}
-}
-}
-return val;
-},hsvToRGB:function(hue,_516,_517,_518){
-if(arguments.length==1){
-var hsv=hue;
-hue=hsv.h;
-_516=hsv.s;
-_517=hsv.v;
-_518=hsv.a;
-}
-var red;
-var _519;
-var blue;
-if(_516===0){
-red=0;
-_519=0;
-blue=0;
-}else{
-var i=Math.floor(hue*6);
-var f=(hue*6)-i;
-var p=_517*(1-_516);
-var q=_517*(1-(_516*f));
-var t=_517*(1-(_516*(1-f)));
-switch(i){
-case 1:
-red=q;
-_519=_517;
-blue=p;
-break;
-case 2:
-red=p;
-_519=_517;
-blue=t;
-break;
-case 3:
-red=p;
-_519=q;
-blue=_517;
-break;
-case 4:
-red=t;
-_519=p;
-blue=_517;
-break;
-case 5:
-red=_517;
-_519=p;
-blue=q;
-break;
-case 6:
-case 0:
-red=_517;
-_519=t;
-blue=p;
-break;
-}
-}
-return {r:red,g:_519,b:blue,a:_518};
-},hslToRGB:function(hue,_521,_522,_523){
-if(arguments.length==1){
-var hsl=hue;
-hue=hsl.h;
-_521=hsl.s;
-_522=hsl.l;
-_523=hsl.a;
-}
-var red;
-var _524;
-var blue;
-if(_521===0){
-red=_522;
-_524=_522;
-blue=_522;
-}else{
-var m2;
-if(_522&lt;=0.5){
-m2=_522*(1+_521);
-}else{
-m2=_522+_521-(_522*_521);
-}
-var m1=(2*_522)-m2;
-var f=MochiKit.Color._hslValue;
-var h6=hue*6;
-red=f(m1,m2,h6+2);
-_524=f(m1,m2,h6);
-blue=f(m1,m2,h6-2);
-}
-return {r:red,g:_524,b:blue,a:_523};
-},rgbToHSV:function(red,_528,blue,_529){
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_528=rgb.g;
-blue=rgb.b;
-_529=rgb.a;
-}
-var max=Math.max(Math.max(red,_528),blue);
-var min=Math.min(Math.min(red,_528),blue);
-var hue;
-var _532;
-var _533=max;
-if(min==max){
-hue=0;
-_532=0;
-}else{
-var _534=(max-min);
-_532=_534/max;
-if(red==max){
-hue=(_528-blue)/_534;
-}else{
-if(_528==max){
-hue=2+((blue-red)/_534);
-}else{
-hue=4+((red-_528)/_534);
-}
-}
-hue/=6;
-if(hue&lt;0){
-hue+=1;
-}
-if(hue&gt;1){
-hue-=1;
-}
-}
-return {h:hue,s:_532,v:_533,a:_529};
-},rgbToHSL:function(red,_535,blue,_536){
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_535=rgb.g;
-blue=rgb.b;
-_536=rgb.a;
-}
-var max=Math.max(red,Math.max(_535,blue));
-var min=Math.min(red,Math.min(_535,blue));
-var hue;
-var _537;
-var _538=(max+min)/2;
-var _539=max-min;
-if(_539===0){
-hue=0;
-_537=0;
-}else{
-if(_538&lt;=0.5){
-_537=_539/(max+min);
-}else{
-_537=_539/(2-max-min);
-}
-if(red==max){
-hue=(_535-blue)/_539;
-}else{
-if(_535==max){
-hue=2+((blue-red)/_539);
-}else{
-hue=4+((red-_535)/_539);
-}
-}
-hue/=6;
-if(hue&lt;0){
-hue+=1;
-}
-if(hue&gt;1){
-hue-=1;
-}
-}
-return {h:hue,s:_537,l:_538,a:_536};
-},toColorPart:function(num){
-num=Math.round(num);
-var _540=num.toString(16);
-if(num&lt;16){
-return &quot;0&quot;+_540;
-}
-return _540;
-},__new__:function(){
-var m=MochiKit.Base;
-this.Color.fromRGBString=m.bind(this.Color._fromColorString,this.Color,&quot;rgb&quot;,&quot;fromRGB&quot;,[1/255,1/255,1/255,1]);
-this.Color.fromHSLString=m.bind(this.Color._fromColorString,this.Color,&quot;hsl&quot;,&quot;fromHSL&quot;,[1/360,0.01,0.01,1]);
-var _541=1/3;
-var _542={black:[0,0,0],blue:[0,0,1],brown:[0.6,0.4,0.2],cyan:[0,1,1],darkGray:[_541,_541,_541],gray:[0.5,0.5,0.5],green:[0,1,0],lightGray:[2*_541,2*_541,2*_541],magenta:[1,0,1],orange:[1,0.5,0],purple:[0.5,0,0.5],red:[1,0,0],transparent:[0,0,0,0],white:[1,1,1],yellow:[1,1,0]};
-var _543=function(name,r,g,b,a){
-var rval=this.fromRGB(r,g,b,a);
-this[name]=function(){
-return rval;
-};
-return rval;
-};
-for(var k in _542){
-var name=k+&quot;Color&quot;;
-var _545=m.concat([_543,this.Color,name],_542[k]);
-this.Color[name]=m.bind.apply(null,_545);
-}
-var _546=function(){
-for(var i=0;i&lt;arguments.length;i++){
-if(!(arguments[i] instanceof Color)){
-return false;
-}
-}
-return true;
-};
-var _547=function(a,b){
-return a.compareRGB(b);
-};
-m.nameFunctions(this);
-m.registerComparator(this.Color.NAME,_546,_547);
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-}});
-MochiKit.Color.EXPORT=[&quot;Color&quot;];
-MochiKit.Color.EXPORT_OK=[&quot;clampColorComponent&quot;,&quot;rgbToHSL&quot;,&quot;hslToRGB&quot;,&quot;rgbToHSV&quot;,&quot;hsvToRGB&quot;,&quot;toColorPart&quot;];
-MochiKit.Color.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Color);
-MochiKit.Color.Color._namedColors={aliceblue:&quot;#f0f8ff&quot;,antiquewhite:&quot;#faebd7&quot;,aqua:&quot;#00ffff&quot;,aquamarine:&quot;#7fffd4&quot;,azure:&quot;#f0ffff&quot;,beige:&quot;#f5f5dc&quot;,bisque:&quot;#ffe4c4&quot;,black:&quot;#000000&quot;,blanchedalmond:&quot;#ffebcd&quot;,blue:&quot;#0000ff&quot;,blueviolet:&quot;#8a2be2&quot;,brown:&quot;#a52a2a&quot;,burlywood:&quot;#deb887&quot;,cadetblue:&quot;#5f9ea0&quot;,chartreuse:&quot;#7fff00&quot;,chocolate:&quot;#d2691e&quot;,coral:&quot;#ff7f50&quot;,cornflowerblue:&quot;#6495ed&quot;,cornsilk:&quot;#fff8dc&quot;,crimson:&quot;#dc143c&quot;,cyan:&quot;#00ffff&quot;,darkblue:&quot;#00008b&quot;,darkcyan:&quot;#008b8b&quot;,darkgoldenrod:&quot;#b8860b&quot;,darkgray:&quot;#a9a9a9&quot;,darkgreen:&quot;#006400&quot;,darkgrey:&quot;#a9a9a9&quot;,darkkhaki:&quot;#bdb76b&quot;,darkmagenta:&quot;#8b008b&quot;,darkolivegreen:&quot;#556b2f&quot;,darkorange:&quot;#ff8c00&quot;,darkorchid:&quot;#9932cc&quot;,darkred:&quot;#8b0000&quot;,darksalmon:&quot;#e9967a&quot;,darkseagreen:&quot;#8fbc8f&quot;,darkslateblue:&quot;#483d8b&quot;,darkslategray:&quot;#2f4f4f&quot;,darkslategrey:&quot;#2f4f4f&quot;,darkturquoise:&quot;#00ced1&quot;,darkviolet:&quot;#9400d3&quot;,deeppink:&quot;#ff1493&quot;,deepskyblue:&quot;#00bfff&quot;,dimgray:&quot;#696969&quot;,dimgrey:&quot;#696969&quot;,dodgerblue:&quot;#1e90ff&quot;,firebrick:&quot;#b22222&quot;,floralwhite:&quot;#fffaf0&quot;,forestgree!
 n:&quot;#228b22&quot;,fuchsia:&quot;#ff00ff&quot;,gainsboro:&quot;#dcdcdc&quot;,ghostwhite:&quot;#f8f8ff&quot;,gold:&quot;#ffd700&quot;,goldenrod:&quot;#daa520&quot;,gray:&quot;#808080&quot;,green:&quot;#008000&quot;,greenyellow:&quot;#adff2f&quot;,grey:&quot;#808080&quot;,honeydew:&quot;#f0fff0&quot;,hotpink:&quot;#ff69b4&quot;,indianred:&quot;#cd5c5c&quot;,indigo:&quot;#4b0082&quot;,ivory:&quot;#fffff0&quot;,khaki:&quot;#f0e68c&quot;,lavender:&quot;#e6e6fa&quot;,lavenderblush:&quot;#fff0f5&quot;,lawngreen:&quot;#7cfc00&quot;,lemonchiffon:&quot;#fffacd&quot;,lightblue:&quot;#add8e6&quot;,lightcoral:&quot;#f08080&quot;,lightcyan:&quot;#e0ffff&quot;,lightgoldenrodyellow:&quot;#fafad2&quot;,lightgray:&quot;#d3d3d3&quot;,lightgreen:&quot;#90ee90&quot;,lightgrey:&quot;#d3d3d3&quot;,lightpink:&quot;#ffb6c1&quot;,lightsalmon:&quot;#ffa07a&quot;,lightseagreen:&quot;#20b2aa&quot;,lightskyblue:&quot;#87cefa&quot;,lightslategray:&quot;#778899&quot;,lightslategrey:&quot;#778899&quot;,lightsteelblue:&quot;#b0c4de&quot;,lightyellow:&quot;#ffffe0&quot;,lime:&quot;#00ff00&quot;,limegreen:&quot;#32cd32&quot;,linen:&quot;#faf0e6&quot;,magenta:&quot;#ff00ff&quot;,maroon:&quot;#800000&quot;,mediumaquamarine:&quot;#66cdaa&quot;,mediumblue:&quot;#0000cd&quot;,mediumorchid:&quot;#ba55d3&quot;,mediumpurple:&quot;#9370db&quot;,mediumseagreen:&quot;#3cb371&quot;,mediumslateblue:&quot;#7b68ee&quot;,mediumspringgreen:&quot;#00fa9a&quot;,mediumturquoise:&quot;#48d1cc!
 &quot;,mediumvioletred:&quot;#c71585&quot;,midnightblue:&quot;#191970&quot;,mintcream:&quot;!
 #f5fffa&quot;
,mistyrose:&quot;#ffe4e1&quot;,moccasin:&quot;#ffe4b5&quot;,navajowhite:&quot;#ffdead&quot;,navy:&quot;#000080&quot;,oldlace:&quot;#fdf5e6&quot;,olive:&quot;#808000&quot;,olivedrab:&quot;#6b8e23&quot;,orange:&quot;#ffa500&quot;,orangered:&quot;#ff4500&quot;,orchid:&quot;#da70d6&quot;,palegoldenrod:&quot;#eee8aa&quot;,palegreen:&quot;#98fb98&quot;,paleturquoise:&quot;#afeeee&quot;,palevioletred:&quot;#db7093&quot;,papayawhip:&quot;#ffefd5&quot;,peachpuff:&quot;#ffdab9&quot;,peru:&quot;#cd853f&quot;,pink:&quot;#ffc0cb&quot;,plum:&quot;#dda0dd&quot;,powderblue:&quot;#b0e0e6&quot;,purple:&quot;#800080&quot;,red:&quot;#ff0000&quot;,rosybrown:&quot;#bc8f8f&quot;,royalblue:&quot;#4169e1&quot;,saddlebrown:&quot;#8b4513&quot;,salmon:&quot;#fa8072&quot;,sandybrown:&quot;#f4a460&quot;,seagreen:&quot;#2e8b57&quot;,seashell:&quot;#fff5ee&quot;,sienna:&quot;#a0522d&quot;,silver:&quot;#c0c0c0&quot;,skyblue:&quot;#87ceeb&quot;,slateblue:&quot;#6a5acd&quot;,slategray:&quot;#708090&quot;,slategrey:&quot;#708090&quot;,snow:&quot;#fffafa&quot;,springgreen:&quot;#00ff7f&quot;,steelblue:&quot;#4682b4&quot;,tan:&quot;#d2b48c&quot;,teal:&quot;#008080&quot;,thistle:&quot;#d8bfd8&quot;,tomato:&quot;#ff6347&quot;,turquoise:&quot;#40e0d0&quot;,violet:&quot;#ee82ee&quot;,wheat:&quot;#f5deb3&quot;,white:&quot;#ffffff&quot;,whitesmoke:&quot;#f5f5f5&quot;,yellow:&quot;#ffff00&quot;,yellowgreen:&quot;#9acd32&quot;};
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Signal&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-dojo.require(&quot;MochiKit.DOM&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-JSAN.use(&quot;MochiKit.DOM&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Signal depends on MochiKit.Base!&quot;;
-}
-try{
-if(typeof (MochiKit.DOM)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Signal depends on MochiKit.DOM!&quot;;
-}
-if(typeof (MochiKit.Signal)==&quot;undefined&quot;){
-MochiKit.Signal={};
-}
-MochiKit.Signal.NAME=&quot;MochiKit.Signal&quot;;
-MochiKit.Signal.VERSION=&quot;1.3.1&quot;;
-MochiKit.Signal._observers=[];
-MochiKit.Signal.Event=function(src,e){
-this._event=e||window.event;
-this._src=src;
-};
-MochiKit.Base.update(MochiKit.Signal.Event.prototype,{__repr__:function(){
-var repr=MochiKit.Base.repr;
-var str=&quot;{event(): &quot;+repr(this.event())+&quot;, src(): &quot;+repr(this.src())+&quot;, type(): &quot;+repr(this.type())+&quot;, target(): &quot;+repr(this.target())+&quot;, modifier(): &quot;+&quot;{alt: &quot;+repr(this.modifier().alt)+&quot;, ctrl: &quot;+repr(this.modifier().ctrl)+&quot;, meta: &quot;+repr(this.modifier().meta)+&quot;, shift: &quot;+repr(this.modifier().shift)+&quot;, any: &quot;+repr(this.modifier().any)+&quot;}&quot;;
-if(this.type()&amp;&amp;this.type().indexOf(&quot;key&quot;)===0){
-str+=&quot;, key(): {code: &quot;+repr(this.key().code)+&quot;, string: &quot;+repr(this.key().string)+&quot;}&quot;;
-}
-if(this.type()&amp;&amp;(this.type().indexOf(&quot;mouse&quot;)===0||this.type().indexOf(&quot;click&quot;)!=-1||this.type()==&quot;contextmenu&quot;)){
-str+=&quot;, mouse(): {page: &quot;+repr(this.mouse().page)+&quot;, client: &quot;+repr(this.mouse().client);
-if(this.type()!=&quot;mousemove&quot;){
-str+=&quot;, button: {left: &quot;+repr(this.mouse().button.left)+&quot;, middle: &quot;+repr(this.mouse().button.middle)+&quot;, right: &quot;+repr(this.mouse().button.right)+&quot;}}&quot;;
-}else{
-str+=&quot;}&quot;;
-}
-}
-if(this.type()==&quot;mouseover&quot;||this.type()==&quot;mouseout&quot;){
-str+=&quot;, relatedTarget(): &quot;+repr(this.relatedTarget());
-}
-str+=&quot;}&quot;;
-return str;
-},toString:function(){
-return this.__repr__();
-},src:function(){
-return this._src;
-},event:function(){
-return this._event;
-},type:function(){
-return this._event.type||undefined;
-},target:function(){
-return this._event.target||this._event.srcElement;
-},relatedTarget:function(){
-if(this.type()==&quot;mouseover&quot;){
-return (this._event.relatedTarget||this._event.fromElement);
-}else{
-if(this.type()==&quot;mouseout&quot;){
-return (this._event.relatedTarget||this._event.toElement);
-}
-}
-return undefined;
-},modifier:function(){
-var m={};
-m.alt=this._event.altKey;
-m.ctrl=this._event.ctrlKey;
-m.meta=this._event.metaKey||false;
-m.shift=this._event.shiftKey;
-m.any=m.alt||m.ctrl||m.shift||m.meta;
-return m;
-},key:function(){
-var k={};
-if(this.type()&amp;&amp;this.type().indexOf(&quot;key&quot;)===0){
-if(this.type()==&quot;keydown&quot;||this.type()==&quot;keyup&quot;){
-k.code=this._event.keyCode;
-k.string=(MochiKit.Signal._specialKeys[k.code]||&quot;KEY_UNKNOWN&quot;);
-return k;
-}else{
-if(this.type()==&quot;keypress&quot;){
-k.code=0;
-k.string=&quot;&quot;;
-if(typeof (this._event.charCode)!=&quot;undefined&quot;&amp;&amp;this._event.charCode!==0&amp;&amp;!MochiKit.Signal._specialMacKeys[this._event.charCode]){
-k.code=this._event.charCode;
-k.string=String.fromCharCode(k.code);
-}else{
-if(this._event.keyCode&amp;&amp;typeof (this._event.charCode)==&quot;undefined&quot;){
-k.code=this._event.keyCode;
-k.string=String.fromCharCode(k.code);
-}
-}
-return k;
-}
-}
-}
-return undefined;
-},mouse:function(){
-var m={};
-var e=this._event;
-if(this.type()&amp;&amp;(this.type().indexOf(&quot;mouse&quot;)===0||this.type().indexOf(&quot;click&quot;)!=-1||this.type()==&quot;contextmenu&quot;)){
-m.client=new MochiKit.DOM.Coordinates(0,0);
-if(e.clientX||e.clientY){
-m.client.x=(!e.clientX||e.clientX&lt;0)?0:e.clientX;
-m.client.y=(!e.clientY||e.clientY&lt;0)?0:e.clientY;
-}
-m.page=new MochiKit.DOM.Coordinates(0,0);
-if(e.pageX||e.pageY){
-m.page.x=(!e.pageX||e.pageX&lt;0)?0:e.pageX;
-m.page.y=(!e.pageY||e.pageY&lt;0)?0:e.pageY;
-}else{
-var de=MochiKit.DOM._document.documentElement;
-var b=MochiKit.DOM._document.body;
-m.page.x=e.clientX+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
-m.page.y=e.clientY+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
-}
-if(this.type()!=&quot;mousemove&quot;){
-m.button={};
-m.button.left=false;
-m.button.right=false;
-m.button.middle=false;
-if(e.which){
-m.button.left=(e.which==1);
-m.button.middle=(e.which==2);
-m.button.right=(e.which==3);
-}else{
-m.button.left=!!(e.button&amp;1);
-m.button.right=!!(e.button&amp;2);
-m.button.middle=!!(e.button&amp;4);
-}
-}
-return m;
-}
-return undefined;
-},stop:function(){
-this.stopPropagation();
-this.preventDefault();
-},stopPropagation:function(){
-if(this._event.stopPropagation){
-this._event.stopPropagation();
-}else{
-this._event.cancelBubble=true;
-}
-},preventDefault:function(){
-if(this._event.preventDefault){
-this._event.preventDefault();
-}else{
-this._event.returnValue=false;
-}
-}});
-MochiKit.Signal._specialMacKeys={3:&quot;KEY_ENTER&quot;,63289:&quot;KEY_NUM_PAD_CLEAR&quot;,63276:&quot;KEY_PAGE_UP&quot;,63277:&quot;KEY_PAGE_DOWN&quot;,63275:&quot;KEY_END&quot;,63273:&quot;KEY_HOME&quot;,63234:&quot;KEY_ARROW_LEFT&quot;,63232:&quot;KEY_ARROW_UP&quot;,63235:&quot;KEY_ARROW_RIGHT&quot;,63233:&quot;KEY_ARROW_DOWN&quot;,63302:&quot;KEY_INSERT&quot;,63272:&quot;KEY_DELETE&quot;};
-for(i=63236;i&lt;=63242;i++){
-MochiKit.Signal._specialMacKeys[i]=&quot;KEY_F&quot;+(i-63236+1);
-}
-MochiKit.Signal._specialKeys={8:&quot;KEY_BACKSPACE&quot;,9:&quot;KEY_TAB&quot;,12:&quot;KEY_NUM_PAD_CLEAR&quot;,13:&quot;KEY_ENTER&quot;,16:&quot;KEY_SHIFT&quot;,17:&quot;KEY_CTRL&quot;,18:&quot;KEY_ALT&quot;,19:&quot;KEY_PAUSE&quot;,20:&quot;KEY_CAPS_LOCK&quot;,27:&quot;KEY_ESCAPE&quot;,32:&quot;KEY_SPACEBAR&quot;,33:&quot;KEY_PAGE_UP&quot;,34:&quot;KEY_PAGE_DOWN&quot;,35:&quot;KEY_END&quot;,36:&quot;KEY_HOME&quot;,37:&quot;KEY_ARROW_LEFT&quot;,38:&quot;KEY_ARROW_UP&quot;,39:&quot;KEY_ARROW_RIGHT&quot;,40:&quot;KEY_ARROW_DOWN&quot;,44:&quot;KEY_PRINT_SCREEN&quot;,45:&quot;KEY_INSERT&quot;,46:&quot;KEY_DELETE&quot;,59:&quot;KEY_SEMICOLON&quot;,91:&quot;KEY_WINDOWS_LEFT&quot;,92:&quot;KEY_WINDOWS_RIGHT&quot;,93:&quot;KEY_SELECT&quot;,106:&quot;KEY_NUM_PAD_ASTERISK&quot;,107:&quot;KEY_NUM_PAD_PLUS_SIGN&quot;,109:&quot;KEY_NUM_PAD_HYPHEN-MINUS&quot;,110:&quot;KEY_NUM_PAD_FULL_STOP&quot;,111:&quot;KEY_NUM_PAD_SOLIDUS&quot;,144:&quot;KEY_NUM_LOCK&quot;,145:&quot;KEY_SCROLL_LOCK&quot;,186:&quot;KEY_SEMICOLON&quot;,187:&quot;KEY_EQUALS_SIGN&quot;,188:&quot;KEY_COMMA&quot;,189:&quot;KEY_HYPHEN-MINUS&quot;,190:&quot;KEY_FULL_STOP&quot;,191:&quot;KEY_SOLIDUS&quot;,192:&quot;KEY_GRAVE_ACCENT&quot;,219:&quot;KEY_LEFT_SQUARE_BRACKET&quot;,220:&quot;KEY_REVERSE_SOLIDUS&quot;,221:&quot;KEY_RIGHT_SQUARE_BRACKET&quot;,222:&quot;KEY_APOSTROPHE&quot;};
-for(var i=48;i&lt;=57;i++){
-MochiKit.Signal._specialKeys[i]=&quot;KEY_&quot;+(i-48);
-}
-for(i=65;i&lt;=90;i++){
-MochiKit.Signal._specialKeys[i]=&quot;KEY_&quot;+String.fromCharCode(i);
-}
-for(i=96;i&lt;=105;i++){
-MochiKit.Signal._specialKeys[i]=&quot;KEY_NUM_PAD_&quot;+(i-96);
-}
-for(i=112;i&lt;=123;i++){
-MochiKit.Signal._specialKeys[i]=&quot;KEY_F&quot;+(i-112+1);
-}
-MochiKit.Base.update(MochiKit.Signal,{__repr__:function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-},toString:function(){
-return this.__repr__();
-},_unloadCache:function(){
-var self=MochiKit.Signal;
-var _548=self._observers;
-for(var i=0;i&lt;_548.length;i++){
-self._disconnect(_548[i]);
-}
-delete self._observers;
-try{
-window.onload=undefined;
-}
-catch(e){
-}
-try{
-window.onunload=undefined;
-}
-catch(e){
-}
-},_listener:function(src,func,obj,_549){
-var E=MochiKit.Signal.Event;
-if(!_549){
-return MochiKit.Base.bind(func,obj);
-}
-obj=obj||src;
-if(typeof (func)==&quot;string&quot;){
-return function(_551){
-obj[func].apply(obj,[new E(src,_551)]);
-};
-}else{
-return function(_552){
-func.apply(obj,[new E(src,_552)]);
-};
-}
-},connect:function(src,sig,_554,_555){
-src=MochiKit.DOM.getElement(src);
-var self=MochiKit.Signal;
-if(typeof (sig)!=&quot;string&quot;){
-throw new Error(&quot;'sig' must be a string&quot;);
-}
-var obj=null;
-var func=null;
-if(typeof (_555)!=&quot;undefined&quot;){
-obj=_554;
-func=_555;
-if(typeof (_555)==&quot;string&quot;){
-if(typeof (_554[_555])!=&quot;function&quot;){
-throw new Error(&quot;'funcOrStr' must be a function on 'objOrFunc'&quot;);
-}
-}else{
-if(typeof (_555)!=&quot;function&quot;){
-throw new Error(&quot;'funcOrStr' must be a function or string&quot;);
-}
-}
-}else{
-if(typeof (_554)!=&quot;function&quot;){
-throw new Error(&quot;'objOrFunc' must be a function if 'funcOrStr' is not given&quot;);
-}else{
-func=_554;
-}
-}
-if(typeof (obj)==&quot;undefined&quot;||obj===null){
-obj=src;
-}
-var _556=!!(src.addEventListener||src.attachEvent);
-var _557=self._listener(src,func,obj,_556);
-if(src.addEventListener){
-src.addEventListener(sig.substr(2),_557,false);
-}else{
-if(src.attachEvent){
-src.attachEvent(sig,_557);
-}
-}
-var _558=[src,sig,_557,_556,_554,_555];
-self._observers.push(_558);
-return _558;
-},_disconnect:function(_559){
-if(!_559[3]){
-return;
-}
-var src=_559[0];
-var sig=_559[1];
-var _560=_559[2];
-if(src.removeEventListener){
-src.removeEventListener(sig.substr(2),_560,false);
-}else{
-if(src.detachEvent){
-src.detachEvent(sig,_560);
-}else{
-throw new Error(&quot;'src' must be a DOM element&quot;);
-}
-}
-},disconnect:function(_561){
-var self=MochiKit.Signal;
-var _562=self._observers;
-var m=MochiKit.Base;
-if(arguments.length&gt;1){
-var src=MochiKit.DOM.getElement(arguments[0]);
-var sig=arguments[1];
-var obj=arguments[2];
-var func=arguments[3];
-for(var i=_562.length-1;i&gt;=0;i--){
-var o=_562[i];
-if(o[0]===src&amp;&amp;o[1]===sig&amp;&amp;o[4]===obj&amp;&amp;o[5]===func){
-self._disconnect(o);
-_562.splice(i,1);
-return true;
-}
-}
-}else{
-var idx=m.findIdentical(_562,_561);
-if(idx&gt;=0){
-self._disconnect(_561);
-_562.splice(idx,1);
-return true;
-}
-}
-return false;
-},disconnectAll:function(src,sig){
-src=MochiKit.DOM.getElement(src);
-var m=MochiKit.Base;
-var _563=m.flattenArguments(m.extend(null,arguments,1));
-var self=MochiKit.Signal;
-var _564=self._disconnect;
-var _565=self._observers;
-if(_563.length===0){
-for(var i=_565.length-1;i&gt;=0;i--){
-var _566=_565[i];
-if(_566[0]===src){
-_564(_566);
-_565.splice(i,1);
-}
-}
-}else{
-var sigs={};
-for(var i=0;i&lt;_563.length;i++){
-sigs[_563[i]]=true;
-}
-for(var i=_565.length-1;i&gt;=0;i--){
-var _566=_565[i];
-if(_566[0]===src&amp;&amp;_566[1] in sigs){
-_564(_566);
-_565.splice(i,1);
-}
-}
-}
-},signal:function(src,sig){
-var _568=MochiKit.Signal._observers;
-src=MochiKit.DOM.getElement(src);
-var args=MochiKit.Base.extend(null,arguments,2);
-var _569=[];
-for(var i=0;i&lt;_568.length;i++){
-var _570=_568[i];
-if(_570[0]===src&amp;&amp;_570[1]===sig){
-try{
-_570[2].apply(src,args);
-}
-catch(e){
-_569.push(e);
-}
-}
-}
-if(_569.length==1){
-throw _569[0];
-}else{
-if(_569.length&gt;1){
-var e=new Error(&quot;Multiple errors thrown in handling 'sig', see errors property&quot;);
-e.errors=_569;
-throw e;
-}
-}
-}});
-MochiKit.Signal.EXPORT_OK=[];
-MochiKit.Signal.EXPORT=[&quot;connect&quot;,&quot;disconnect&quot;,&quot;signal&quot;,&quot;disconnectAll&quot;];
-MochiKit.Signal.__new__=function(win){
-var m=MochiKit.Base;
-this._document=document;
-this._window=win;
-try{
-this.connect(window,&quot;onunload&quot;,this._unloadCache);
-}
-catch(e){
-}
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Signal.__new__(this);
-if(!MochiKit.__compat__){
-connect=MochiKit.Signal.connect;
-disconnect=MochiKit.Signal.disconnect;
-disconnectAll=MochiKit.Signal.disconnectAll;
-signal=MochiKit.Signal.signal;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Signal);
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.Visual&quot;);
-dojo.require(&quot;MochiKit.Base&quot;);
-dojo.require(&quot;MochiKit.DOM&quot;);
-dojo.require(&quot;MochiKit.Color&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-JSAN.use(&quot;MochiKit.DOM&quot;,[]);
-JSAN.use(&quot;MochiKit.Color&quot;,[]);
-}
-try{
-if(typeof (MochiKit.Base)==&quot;undefined&quot;||typeof (MochiKit.DOM)==&quot;undefined&quot;||typeof (MochiKit.Color)==&quot;undefined&quot;){
-throw &quot;&quot;;
-}
-}
-catch(e){
-throw &quot;MochiKit.Visual depends on MochiKit.Base, MochiKit.DOM and MochiKit.Color!&quot;;
-}
-if(typeof (MochiKit.Visual)==&quot;undefined&quot;){
-MochiKit.Visual={};
-}
-MochiKit.Visual.NAME=&quot;MochiKit.Visual&quot;;
-MochiKit.Visual.VERSION=&quot;1.3.1&quot;;
-MochiKit.Visual.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.Visual.toString=function(){
-return this.__repr__();
-};
-MochiKit.Visual._RoundCorners=function(e,_571){
-e=MochiKit.DOM.getElement(e);
-this._setOptions(_571);
-if(this.options.__unstable__wrapElement){
-e=this._doWrap(e);
-}
-var _572=this.options.color;
-var C=MochiKit.Color.Color;
-if(this.options.color==&quot;fromElement&quot;){
-_572=C.fromBackground(e);
-}else{
-if(!(_572 instanceof C)){
-_572=C.fromString(_572);
-}
-}
-this.isTransparent=(_572.asRGB().a&lt;=0);
-var _574=this.options.bgColor;
-if(this.options.bgColor==&quot;fromParent&quot;){
-_574=C.fromBackground(e.offsetParent);
-}else{
-if(!(_574 instanceof C)){
-_574=C.fromString(_574);
-}
-}
-this._roundCornersImpl(e,_572,_574);
-};
-MochiKit.Visual._RoundCorners.prototype={_doWrap:function(e){
-var _575=e.parentNode;
-var doc=MochiKit.DOM.currentDocument();
-if(typeof (doc.defaultView)==&quot;undefined&quot;||doc.defaultView===null){
-return e;
-}
-var _576=doc.defaultView.getComputedStyle(e,null);
-if(typeof (_576)==&quot;undefined&quot;||_576===null){
-return e;
-}
-var _577=MochiKit.DOM.DIV({&quot;style&quot;:{display:&quot;block&quot;,marginTop:_576.getPropertyValue(&quot;padding-top&quot;),marginRight:_576.getPropertyValue(&quot;padding-right&quot;),marginBottom:_576.getPropertyValue(&quot;padding-bottom&quot;),marginLeft:_576.getPropertyValue(&quot;padding-left&quot;),padding:&quot;0px&quot;}});
-_577.innerHTML=e.innerHTML;
-e.innerHTML=&quot;&quot;;
-e.appendChild(_577);
-return e;
-},_roundCornersImpl:function(e,_578,_579){
-if(this.options.border){
-this._renderBorder(e,_579);
-}
-if(this._isTopRounded()){
-this._roundTopCorners(e,_578,_579);
-}
-if(this._isBottomRounded()){
-this._roundBottomCorners(e,_578,_579);
-}
-},_renderBorder:function(el,_580){
-var _581=&quot;1px solid &quot;+this._borderColor(_580);
-var _582=&quot;border-left: &quot;+_581;
-var _583=&quot;border-right: &quot;+_581;
-var _584=&quot;style='&quot;+_582+&quot;;&quot;+_583+&quot;'&quot;;
-el.innerHTML=&quot;&lt;div &quot;+_584+&quot;&gt;&quot;+el.innerHTML+&quot;&lt;/div&gt;&quot;;
-},_roundTopCorners:function(el,_585,_586){
-var _587=this._createCorner(_586);
-for(var i=0;i&lt;this.options.numSlices;i++){
-_587.appendChild(this._createCornerSlice(_585,_586,i,&quot;top&quot;));
-}
-el.style.paddingTop=0;
-el.insertBefore(_587,el.firstChild);
-},_roundBottomCorners:function(el,_588,_589){
-var _590=this._createCorner(_589);
-for(var i=(this.options.numSlices-1);i&gt;=0;i--){
-_590.appendChild(this._createCornerSlice(_588,_589,i,&quot;bottom&quot;));
-}
-el.style.paddingBottom=0;
-el.appendChild(_590);
-},_createCorner:function(_591){
-var dom=MochiKit.DOM;
-return dom.DIV({style:{backgroundColor:_591.toString()}});
-},_createCornerSlice:function(_592,_593,n,_594){
-var _595=MochiKit.DOM.SPAN();
-var _596=_595.style;
-_596.backgroundColor=_592.toString();
-_596.display=&quot;block&quot;;
-_596.height=&quot;1px&quot;;
-_596.overflow=&quot;hidden&quot;;
-_596.fontSize=&quot;1px&quot;;
-var _597=this._borderColor(_592,_593);
-if(this.options.border&amp;&amp;n===0){
-_596.borderTopStyle=&quot;solid&quot;;
-_596.borderTopWidth=&quot;1px&quot;;
-_596.borderLeftWidth=&quot;0px&quot;;
-_596.borderRightWidth=&quot;0px&quot;;
-_596.borderBottomWidth=&quot;0px&quot;;
-_596.height=&quot;0px&quot;;
-_596.borderColor=_597.toString();
-}else{
-if(_597){
-_596.borderColor=_597.toString();
-_596.borderStyle=&quot;solid&quot;;
-_596.borderWidth=&quot;0px 1px&quot;;
-}
-}
-if(!this.options.compact&amp;&amp;(n==(this.options.numSlices-1))){
-_596.height=&quot;2px&quot;;
-}
-this._setMargin(_595,n,_594);
-this._setBorder(_595,n,_594);
-return _595;
-},_setOptions:function(_598){
-this.options={corners:&quot;all&quot;,color:&quot;fromElement&quot;,bgColor:&quot;fromParent&quot;,blend:true,border:false,compact:false,__unstable__wrapElement:false};
-MochiKit.Base.update(this.options,_598);
-this.options.numSlices=(this.options.compact?2:4);
-},_whichSideTop:function(){
-var _599=this.options.corners;
-if(this._hasString(_599,&quot;all&quot;,&quot;top&quot;)){
-return &quot;&quot;;
-}
-var _600=(_599.indexOf(&quot;tl&quot;)!=-1);
-var _601=(_599.indexOf(&quot;tr&quot;)!=-1);
-if(_600&amp;&amp;_601){
-return &quot;&quot;;
-}
-if(_600){
-return &quot;left&quot;;
-}
-if(_601){
-return &quot;right&quot;;
-}
-return &quot;&quot;;
-},_whichSideBottom:function(){
-var _602=this.options.corners;
-if(this._hasString(_602,&quot;all&quot;,&quot;bottom&quot;)){
-return &quot;&quot;;
-}
-var _603=(_602.indexOf(&quot;bl&quot;)!=-1);
-var _604=(_602.indexOf(&quot;br&quot;)!=-1);
-if(_603&amp;&amp;_604){
-return &quot;&quot;;
-}
-if(_603){
-return &quot;left&quot;;
-}
-if(_604){
-return &quot;right&quot;;
-}
-return &quot;&quot;;
-},_borderColor:function(_605,_606){
-if(_605==&quot;transparent&quot;){
-return _606;
-}else{
-if(this.options.border){
-return this.options.border;
-}else{
-if(this.options.blend){
-return _606.blendedColor(_605);
-}
-}
-}
-return &quot;&quot;;
-},_setMargin:function(el,n,_607){
-var _608=this._marginSize(n)+&quot;px&quot;;
-var _609=(_607==&quot;top&quot;?this._whichSideTop():this._whichSideBottom());
-var _610=el.style;
-if(_609==&quot;left&quot;){
-_610.marginLeft=_608;
-_610.marginRight=&quot;0px&quot;;
-}else{
-if(_609==&quot;right&quot;){
-_610.marginRight=_608;
-_610.marginLeft=&quot;0px&quot;;
-}else{
-_610.marginLeft=_608;
-_610.marginRight=_608;
-}
-}
-},_setBorder:function(el,n,_611){
-var _612=this._borderSize(n)+&quot;px&quot;;
-var _613=(_611==&quot;top&quot;?this._whichSideTop():this._whichSideBottom());
-var _614=el.style;
-if(_613==&quot;left&quot;){
-_614.borderLeftWidth=_612;
-_614.borderRightWidth=&quot;0px&quot;;
-}else{
-if(_613==&quot;right&quot;){
-_614.borderRightWidth=_612;
-_614.borderLeftWidth=&quot;0px&quot;;
-}else{
-_614.borderLeftWidth=_612;
-_614.borderRightWidth=_612;
-}
-}
-},_marginSize:function(n){
-if(this.isTransparent){
-return 0;
-}
-var o=this.options;
-if(o.compact&amp;&amp;o.blend){
-var _615=[1,0];
-return _615[n];
-}else{
-if(o.compact){
-var _616=[2,1];
-return _616[n];
-}else{
-if(o.blend){
-var _617=[3,2,1,0];
-return _617[n];
-}else{
-var _618=[5,3,2,1];
-return _618[n];
-}
-}
-}
-},_borderSize:function(n){
-var o=this.options;
-var _619;
-if(o.compact&amp;&amp;(o.blend||this.isTransparent)){
-return 1;
-}else{
-if(o.compact){
-_619=[1,0];
-}else{
-if(o.blend){
-_619=[2,1,1,1];
-}else{
-if(o.border){
-_619=[0,2,0,0];
-}else{
-if(this.isTransparent){
-_619=[5,3,2,1];
-}else{
-return 0;
-}
-}
-}
-}
-}
-return _619[n];
-},_hasString:function(str){
-for(var i=1;i&lt;arguments.length;i++){
-if(str.indexOf(arguments[i])!=-1){
-return true;
-}
-}
-return false;
-},_isTopRounded:function(){
-return this._hasString(this.options.corners,&quot;all&quot;,&quot;top&quot;,&quot;tl&quot;,&quot;tr&quot;);
-},_isBottomRounded:function(){
-return this._hasString(this.options.corners,&quot;all&quot;,&quot;bottom&quot;,&quot;bl&quot;,&quot;br&quot;);
-},_hasSingleTextChild:function(el){
-return (el.childNodes.length==1&amp;&amp;el.childNodes[0].nodeType==3);
-}};
-MochiKit.Visual.roundElement=function(e,_620){
-new MochiKit.Visual._RoundCorners(e,_620);
-};
-MochiKit.Visual.roundClass=function(_621,_622,_623){
-var _624=MochiKit.DOM.getElementsByTagAndClassName(_621,_622);
-for(var i=0;i&lt;_624.length;i++){
-MochiKit.Visual.roundElement(_624[i],_623);
-}
-};
-MochiKit.Visual.Color=MochiKit.Color.Color;
-MochiKit.Visual.getElementsComputedStyle=MochiKit.DOM.computedStyle;
-MochiKit.Visual.__new__=function(){
-var m=MochiKit.Base;
-m.nameFunctions(this);
-this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
-};
-MochiKit.Visual.EXPORT=[&quot;roundElement&quot;,&quot;roundClass&quot;];
-MochiKit.Visual.EXPORT_OK=[];
-MochiKit.Visual.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Visual);
-if(typeof (MochiKit)==&quot;undefined&quot;){
-MochiKit={};
-}
-if(typeof (MochiKit.MochiKit)==&quot;undefined&quot;){
-MochiKit.MochiKit={};
-}
-MochiKit.MochiKit.NAME=&quot;MochiKit.MochiKit&quot;;
-MochiKit.MochiKit.VERSION=&quot;1.3.1&quot;;
-MochiKit.MochiKit.__repr__=function(){
-return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
-};
-MochiKit.MochiKit.toString=function(){
-return this.__repr__();
-};
-MochiKit.MochiKit.SUBMODULES=[&quot;Base&quot;,&quot;Iter&quot;,&quot;Logging&quot;,&quot;DateTime&quot;,&quot;Format&quot;,&quot;Async&quot;,&quot;DOM&quot;,&quot;LoggingPane&quot;,&quot;Color&quot;,&quot;Signal&quot;,&quot;Visual&quot;];
-if(typeof (JSAN)!=&quot;undefined&quot;||typeof (dojo)!=&quot;undefined&quot;){
-if(typeof (dojo)!=&quot;undefined&quot;){
-dojo.provide(&quot;MochiKit.MochiKit&quot;);
-dojo.require(&quot;MochiKit.*&quot;);
-}
-if(typeof (JSAN)!=&quot;undefined&quot;){
-JSAN.use(&quot;MochiKit.Base&quot;,[]);
-JSAN.use(&quot;MochiKit.Iter&quot;,[]);
-JSAN.use(&quot;MochiKit.Logging&quot;,[]);
-JSAN.use(&quot;MochiKit.DateTime&quot;,[]);
-JSAN.use(&quot;MochiKit.Format&quot;,[]);
-JSAN.use(&quot;MochiKit.Async&quot;,[]);
-JSAN.use(&quot;MochiKit.DOM&quot;,[]);
-JSAN.use(&quot;MochiKit.LoggingPane&quot;,[]);
-JSAN.use(&quot;MochiKit.Color&quot;,[]);
-JSAN.use(&quot;MochiKit.Signal&quot;,[]);
-JSAN.use(&quot;MochiKit.Visual&quot;,[]);
-}
-(function(){
-var _625=MochiKit.Base.extend;
-var self=MochiKit.MochiKit;
-var _626=self.SUBMODULES;
-var _627=[];
-var _628=[];
-var _629={};
-var i,k,m,all;
-for(i=0;i&lt;_626.length;i++){
-m=MochiKit[_626[i]];
-_625(_627,m.EXPORT);
-_625(_628,m.EXPORT_OK);
-for(k in m.EXPORT_TAGS){
-_629[k]=_625(_629[k],m.EXPORT_TAGS[k]);
-}
-all=m.EXPORT_TAGS[&quot;:all&quot;];
-if(!all){
-all=_625(null,m.EXPORT,m.EXPORT_OK);
-}
-var j;
-for(j=0;j&lt;all.length;j++){
-k=all[j];
-self[k]=m[k];
-}
-}
-self.EXPORT=_627;
-self.EXPORT_OK=_628;
-self.EXPORT_TAGS=_629;
-}());
-}else{
-if(typeof (MochiKit.__compat__)==&quot;undefined&quot;){
-MochiKit.__compat__=true;
-}
-(function(){
-var _630=document.getElementsByTagName(&quot;script&quot;);
-var _631=&quot;<A HREF="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul</A>&quot;;
-var base=null;
-var _632=null;
-var _633={};
-var i;
-for(i=0;i&lt;_630.length;i++){
-var src=_630[i].getAttribute(&quot;src&quot;);
-if(!src){
-continue;
-}
-_633[src]=true;
-if(src.match(/MochiKit.js$/)){
-base=src.substring(0,src.lastIndexOf(&quot;MochiKit.js&quot;));
-_632=_630[i];
-}
-}
-if(base===null){
-return;
-}
-var _634=MochiKit.MochiKit.SUBMODULES;
-for(var i=0;i&lt;_634.length;i++){
-if(MochiKit[_634[i]]){
-continue;
-}
-var uri=base+_634[i]+&quot;.js&quot;;
-if(uri in _633){
-continue;
-}
-if(document.documentElement&amp;&amp;document.documentElement.namespaceURI==_631){
-var s=document.createElementNS(_631,&quot;script&quot;);
-s.setAttribute(&quot;id&quot;,&quot;MochiKit_&quot;+base+_634[i]);
-s.setAttribute(&quot;src&quot;,uri);
-s.setAttribute(&quot;type&quot;,&quot;application/x-javascript&quot;);
-_632.parentNode.appendChild(s);
-}else{
-document.write(&quot;&lt;script src=\&quot;&quot;+uri+&quot;\&quot; type=\&quot;text/javascript\&quot;&gt;&lt;/script&gt;&quot;);
-}
-}
-})();
-}
-
-

Deleted: trunk/lib/Sarissa.js
===================================================================
--- trunk/lib/Sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/Sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,858 +0,0 @@
-/**
-  * Package : begin
-  */
-if (typeof(dojo) != 'undefined') {
-	dojo.provide(&quot;Sarissa&quot;);
-}
-Sarissa = {};
-Sarissa.NAME = &quot;Sarissa&quot;;
-Sarissa.VERSION = &quot;0.9.6.1&quot;;
-Sarissa.__repr__ = function () {
-	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
-};
-Sarissa.toString = function () {
-	return this.__repr__();
-};
-/**
-  * Package : end
-  */
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
- * The library supports Gecko based browsers like Mozilla and Firefox,
- * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
- * @version 0.9.6.1
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- * ====================================================================
- * Licence
- * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit <A HREF="http://www.gnu.org">http://www.gnu.org</A>
- *
- */
-/**
- * &lt;p&gt;Sarissa is a utility class. Provides &quot;static&quot; methods for DOMDocument and
- * XMLHTTP objects, DOM Node serializatrion to XML strings and other goodies.&lt;/p&gt;
- * @constructor
- */
-//function Sarissa(){};
-/** @private */
-Sarissa.PARSED_OK = &quot;Document contains no parsing errors&quot;;
-/**
- * Tells you whether transformNode and transformNodeToObject are available. This functionality
- * is contained in sarissa_ieemu_xslt.js and is deprecated. If you want to control XSLT transformations
- * use the XSLTProcessor
- * @deprecated
- * @type boolean
- */
-Sarissa.IS_ENABLED_TRANSFORM_NODE = false;
-/**
- * tells you whether XMLHttpRequest (or equivalent) is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_XMLHTTP = false;
-/**
- * tells you whether selectNodes/selectSingleNode is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_SELECT_NODES = false;
-var _sarissa_iNsCounter = 0;
-var _SARISSA_IEPREFIX4XSLPARAM = &quot;&quot;;
-var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation &amp;&amp; true;
-var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.createDocument;
-var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.hasFeature;
-var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT &amp;&amp; _SARISSA_HAS_DOM_FEATURE;
-var _SARISSA_IS_SAFARI = (navigator.userAgent &amp;&amp; navigator.vendor &amp;&amp; (navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;) != -1 || navigator.vendor.indexOf(&quot;Apple&quot;) != -1));
-var _SARISSA_IS_IE = document.all &amp;&amp; window.ActiveXObject &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;) &gt; -1  &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;) == -1;
-if(!window.Node || !window.Node.ELEMENT_NODE){
-    var Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
-};
-
-// IE initialization
-if(_SARISSA_IS_IE){
-    // for XSLT parameter names, prefix needed by IE
-    _SARISSA_IEPREFIX4XSLPARAM = &quot;xsl:&quot;;
-    // used to store the most recent ProgID available out of the above
-    var _SARISSA_DOM_PROGID = &quot;&quot;;
-    var _SARISSA_XMLHTTP_PROGID = &quot;&quot;;
-    /**
-     * Called when the Sarissa_xx.js file is parsed, to pick most recent
-     * ProgIDs for IE, then gets destroyed.
-     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
-     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
-     */
-    pickRecentProgID = function (idList, enabledList){
-        // found progID flag
-        var bFound = false;
-        for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
-            try{
-                var oDoc = new ActiveXObject(idList[i]);
-                o2Store = idList[i];
-                bFound = true;
-                for(var j=0;j&lt;enabledList.length;j++)
-                    if(i &lt;= enabledList[j][1])
-                        Sarissa[&quot;IS_ENABLED_&quot;+enabledList[j][0]] = true;
-            }catch (objException){
-                // trap; try next progID
-            };
-        };
-        if (!bFound)
-            throw &quot;Could not retreive a valid progID of Class: &quot; + idList[idList.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
-        idList = null;
-        return o2Store;
-    };
-    // pick best available MSXML progIDs
-    _SARISSA_DOM_PROGID = pickRecentProgID([&quot;Msxml2.DOMDocument.5.0&quot;, &quot;Msxml2.DOMDocument.4.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;], [[&quot;SELECT_NODES&quot;, 2],[&quot;TRANSFORM_NODE&quot;, 2]]);
-    _SARISSA_XMLHTTP_PROGID = pickRecentProgID([&quot;Msxml2.XMLHTTP.5.0&quot;, &quot;Msxml2.XMLHTTP.4.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;], [[&quot;XMLHTTP&quot;, 4]]);
-    _SARISSA_THREADEDDOM_PROGID = pickRecentProgID([&quot;Msxml2.FreeThreadedDOMDocument.5.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.4.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
-    _SARISSA_XSLTEMPLATE_PROGID = pickRecentProgID([&quot;Msxml2.XSLTemplate.5.0&quot;, &quot;Msxml2.XSLTemplate.4.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;], [[&quot;XSLTPROC&quot;, 2]]);
-    // we dont need this anymore
-    pickRecentProgID = null;
-    //============================================
-    // Factory methods (IE)
-    //============================================
-    // see non-IE version
-    Sarissa.getDomDocument = function(sUri, sName){
-        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        // if a root tag name was provided, we need to load it in the DOM
-        // object
-        if (sName){
-            // if needed, create an artifical namespace prefix the way Moz
-            // does
-            if (sUri){
-                oDoc.loadXML(&quot;&lt;a&quot; + _sarissa_iNsCounter + &quot;:&quot; + sName + &quot; xmlns:a&quot; + _sarissa_iNsCounter + &quot;=\&quot;&quot; + sUri + &quot;\&quot; /&gt;&quot;);
-                // don't use the same prefix again
-                ++_sarissa_iNsCounter;
-            }
-            else
-                oDoc.loadXML(&quot;&lt;&quot; + sName + &quot;/&gt;&quot;);
-        };
-        return oDoc;
-    };
-    // see non-IE version
-    Sarissa.getParseErrorText = function (oDoc) {
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc.parseError != 0){
-            parseErrorText = &quot;XML Parsing Error: &quot; + oDoc.parseError.reason +
-                &quot;\nLocation: &quot; + oDoc.parseError.url +
-                &quot;\nLine Number &quot; + oDoc.parseError.line + &quot;, Column &quot; +
-                oDoc.parseError.linepos +
-                &quot;:\n&quot; + oDoc.parseError.srcText +
-                &quot;\n&quot;;
-            for(var i = 0;  i &lt; oDoc.parseError.linepos;i++){
-                parseErrorText += &quot;-&quot;;
-            };
-            parseErrorText +=  &quot;^\n&quot;;
-        };
-        return parseErrorText;
-    };
-    // see non-IE version
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        oDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
-        oDoc.setProperty(&quot;SelectionNamespaces&quot;, sNsSet);
-    };
-    /**
-     * Basic implementation of Mozilla's XSLTProcessor for IE.
-     * Reuses the same XSLT stylesheet for multiple transforms
-     * @constructor
-     */
-    XSLTProcessor = function(){
-        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-        this.processor = null;
-    };
-    /**
-     * Impoprts the given XSLT DOM and compiles it to a reusable transform
-     * @argument xslDoc The XSLT DOMDocument to import
-     */
-    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-        // convert stylesheet to free threaded
-        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-        converted.loadXML(xslDoc.xml);
-        this.template.stylesheet = converted;
-        this.processor = this.template.createProcessor();
-        // (re)set default param values
-        this.paramsSet = new Array();
-    };
-    /**
-     * Transform the given XML DOM
-     * @argument sourceDoc The XML DOMDocument to transform
-     * @return The transformation result as a DOM Document
-     */
-    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-        this.processor.input = sourceDoc;
-        var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        this.processor.output = outDoc;
-        this.processor.transform();
-        return outDoc;
-    };
-    /**
-     * Set global XSLT parameter of the imported stylesheet
-     * @argument nsURI The parameter namespace URI
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     */
-    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-        /* nsURI is optional but cannot be null */
-        if(nsURI){
-            this.processor.addParameter(name, value, nsURI);
-        }else{
-            this.processor.addParameter(name, value);
-        };
-        /* update updated params for getParameter */
-        if(!this.paramsSet[&quot;&quot;+nsURI]){
-            this.paramsSet[&quot;&quot;+nsURI] = new Array();
-        };
-        this.paramsSet[&quot;&quot;+nsURI][name] = value;
-    };
-    /**
-     * Gets a parameter if previously set by setParameter. Returns null
-     * otherwise
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     * @return The parameter value if reviously set by setParameter, null otherwise
-     */
-    XSLTProcessor.prototype.getParameter = function(nsURI, name){
-        nsURI = nsURI || &quot;&quot;;
-        if(nsURI in this.paramsSet &amp;&amp; name in this.paramsSet[nsURI]){
-            return this.paramsSet[nsURI][name];
-        }else{
-            return null;
-        };
-    };
-}
-else{ /* end IE initialization, try to deal with real browsers now ;-) */
-    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
-        /**
-         * &lt;p&gt;Ensures the document was loaded correctly, otherwise sets the
-         * parseError to -1 to indicate something went wrong. Internal use&lt;/p&gt;
-         * @private
-         */
-        Sarissa.__handleLoad__ = function(oDoc){
-            if (!oDoc.documentElement || oDoc.documentElement.tagName == &quot;parsererror&quot;)
-                oDoc.parseError = -1;
-            Sarissa.__setReadyState__(oDoc, 4);
-        };
-        /**
-        * &lt;p&gt;Attached by an event handler to the load event. Internal use.&lt;/p&gt;
-        * @private
-        */
-        _sarissa_XMLDocument_onload = function(){
-            Sarissa.__handleLoad__(this);
-        };
-        /**
-         * &lt;p&gt;Sets the readyState property of the given DOM Document object.
-         * Internal use.&lt;/p&gt;
-         * @private
-         * @argument oDoc the DOM Document object to fire the
-         *          readystatechange event
-         * @argument iReadyState the number to change the readystate property to
-         */
-        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
-            oDoc.readyState = iReadyState;
-            if (oDoc.onreadystatechange != null &amp;&amp; typeof oDoc.onreadystatechange == &quot;function&quot;)
-                oDoc.onreadystatechange();
-        };
-        Sarissa.getDomDocument = function(sUri, sName){
-            var oDoc = document.implementation.createDocument(sUri?sUri:&quot;&quot;, sName?sName:&quot;&quot;, null);
-            oDoc.addEventListener(&quot;load&quot;, _sarissa_XMLDocument_onload, false);
-            return oDoc;
-        };
-        if(window.XMLDocument){
-            /**
-            * &lt;p&gt;Emulate IE's onreadystatechange attribute&lt;/p&gt;
-            */
-            XMLDocument.prototype.onreadystatechange = null;
-            /**
-            * &lt;p&gt;Emulates IE's readyState property, which always gives an integer from 0 to 4:&lt;/p&gt;
-            * &lt;ul&gt;&lt;li&gt;1 == LOADING,&lt;/li&gt;
-            * &lt;li&gt;2 == LOADED,&lt;/li&gt;
-            * &lt;li&gt;3 == INTERACTIVE,&lt;/li&gt;
-            * &lt;li&gt;4 == COMPLETED&lt;/li&gt;&lt;/ul&gt;
-            */
-            XMLDocument.prototype.readyState = 0;
-            /**
-            * &lt;p&gt;Emulate IE's parseError attribute&lt;/p&gt;
-            */
-            XMLDocument.prototype.parseError = 0;
-
-            // NOTE: setting async to false will only work with documents
-            // called over HTTP (meaning a server), not the local file system,
-            // unless you are using Moz 1.4+.
-            // BTW the try&gt;catch block is for 1.4; I haven't found a way to check if
-            // the property is implemented without
-            // causing an error and I dont want to use user agent stuff for that...
-            var _SARISSA_SYNC_NON_IMPLEMENTED = false;// (&quot;async&quot; in XMLDocument.prototype) ? false: true;
-            /**
-            * &lt;p&gt;Keeps a handle to the original load() method. Internal use and only
-            * if Mozilla version is lower than 1.4&lt;/p&gt;
-            * @private
-            */
-            XMLDocument.prototype._sarissa_load = XMLDocument.prototype.load;
-
-            /**
-            * &lt;p&gt;Overrides the original load method to provide synchronous loading for
-            * Mozilla versions prior to 1.4, using an XMLHttpRequest object (if
-            * async is set to false)&lt;/p&gt;
-            * @returns the DOM Object as it was before the load() call (may be  empty)
-            */
-            XMLDocument.prototype.load = function(sURI) {
-                var oDoc = document.implementation.createDocument(&quot;&quot;, &quot;&quot;, null);
-                Sarissa.copyChildNodes(this, oDoc);
-                this.parseError = 0;
-                Sarissa.__setReadyState__(this, 1);
-                try {
-                    if(this.async == false &amp;&amp; _SARISSA_SYNC_NON_IMPLEMENTED) {
-                        var tmp = new XMLHttpRequest();
-                        tmp.open(&quot;GET&quot;, sURI, false);
-                        tmp.send(null);
-                        Sarissa.__setReadyState__(this, 2);
-                        Sarissa.copyChildNodes(tmp.responseXML, this);
-                        Sarissa.__setReadyState__(this, 3);
-                    }
-                    else {
-                        this._sarissa_load(sURI);
-                    };
-                }
-                catch (objException) {
-                    this.parseError = -1;
-                }
-                finally {
-                    if(this.async == false){
-                        Sarissa.__handleLoad__(this);
-                    };
-                };
-                return oDoc;
-            };
-
-
-        }//if(window.XMLDocument)
-        else if(document.implementation &amp;&amp; document.implementation.hasFeature &amp;&amp; document.implementation.hasFeature('LS', '3.0')){
-            Document.prototype.async = true;
-            Document.prototype.onreadystatechange = null;
-            Document.prototype.parseError = 0;
-            Document.prototype.load = function(sURI) {
-                var parser = document.implementation.createLSParser(this.async ? document.implementation.MODE_ASYNCHRONOUS : document.implementation.MODE_SYNCHRONOUS, null);
-                if(this.async){
-                    var self = this;
-                    parser.addEventListener(&quot;load&quot;,
-                        function(e) {
-                            self.readyState = 4;
-                            Sarissa.copyChildNodes(e.newDocument, self.documentElement, false);
-                            self.onreadystatechange.call();
-                        },
-                        false);
-                };
-                try {
-                    var oDoc = parser.parseURI(sURI);
-                }
-                catch(e){
-                    this.parseError = -1;
-                };
-                if(!this.async)
-                   Sarissa.copyChildNodes(oDoc, this.documentElement, false);
-                return oDoc;
-            };
-            /**
-            * &lt;p&gt;Factory method to obtain a new DOM Document object&lt;/p&gt;
-            * @argument sUri the namespace of the root node (if any)
-            * @argument sUri the local name of the root node (if any)
-            * @returns a new DOM Document
-            */
-            Sarissa.getDomDocument = function(sUri, sName){
-                return document.implementation.createDocument(sUri?sUri:&quot;&quot;, sName?sName:&quot;&quot;, null);
-            };
-        };
-    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
-};
-//==========================================
-// Common stuff
-//==========================================
-if(!window.DOMParser){
-    /*
-    * DOMParser is a utility class, used to construct DOMDocuments from XML strings
-    * @constructor
-    */
-    DOMParser = function() {
-    };
-    if(_SARISSA_IS_SAFARI){
-        /**
-        * Construct a new DOM Document from the given XMLstring
-        * @param sXml the given XML string
-        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml).
-        * @return a new DOM Document from the given XML string
-        */
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            if(contentType.toLowerCase() != &quot;application/xml&quot;){
-                throw &quot;Cannot handle content type: \&quot;&quot; + contentType + &quot;\&quot;&quot;;
-            };
-            var xmlhttp = new XMLHttpRequest();
-            xmlhttp.open(&quot;GET&quot;, &quot;data:text/xml;charset=utf-8,&quot; + encodeURIComponent(str), false);
-            xmlhttp.send(null);
-            return xmlhttp.responseXML;
-        };
-    }else if(Sarissa.getDomDocument &amp;&amp; Sarissa.getDomDocument() &amp;&amp; &quot;loadXML&quot; in Sarissa.getDomDocument()){
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            var doc = Sarissa.getDomDocument();
-            doc.loadXML(sXml);
-            return doc;
-        };
-    };
-};
-
-if(window.XMLHttpRequest){
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-}
-else if(_SARISSA_IS_IE){
-    /**
-     * Emulate XMLHttpRequest
-     * @constructor
-     */
-    XMLHttpRequest = function() {
-        return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
-    };
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-};
-
-if(!window.document.importNode &amp;&amp; _SARISSA_IS_IE){
-    try{
-        /**
-        * Implements importNode for the current window document in IE using innerHTML.
-        * Testing showed that DOM was multiple times slower than innerHTML for this,
-        * sorry folks. If you encounter trouble (who knows what IE does behind innerHTML)
-        * please gimme a call.
-        * @param oNode the Node to import
-        * @param bChildren whether to include the children of oNode
-        * @returns the imported node for further use
-        */
-        window.document.importNode = function(oNode, bChildren){
-            var importNode = document.createElement(&quot;div&quot;);
-            if(bChildren)
-                importNode.innerHTML = Sarissa.serialize(oNode);
-            else
-                importNode.innerHTML = Sarissa.serialize(oNode.cloneNode(false));
-            return importNode.firstChild;
-        };
-        }catch(e){};
-};
-if(!Sarissa.getParseErrorText){
-    /**
-     * &lt;p&gt;Returns a human readable description of the parsing error. Usefull
-     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
-     * element if you want to render it.&lt;/p&gt;
-     * &lt;p&gt;Many thanks to Christian Stocker for the initial patch.&lt;/p&gt;
-     * @argument oDoc The target DOM document
-     * @returns The parsing error description of the target Document in
-     *          human readable form (preformated text)
-     */
-    Sarissa.getParseErrorText = function (oDoc){
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc &amp;&amp; oDoc.parseError &amp;&amp; oDoc.parseError != 0){
-            /*moz*/
-            if(oDoc.documentElement.tagName == &quot;parsererror&quot;){
-                parseErrorText = oDoc.documentElement.firstChild.data;
-                parseErrorText += &quot;\n&quot; +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
-            }/*konq*/
-            else{
-                parseErrorText = Sarissa.getText(oDoc.documentElement);/*.getElementsByTagName(&quot;h1&quot;)[0], false) + &quot;\n&quot;;
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName(&quot;body&quot;)[0], false) + &quot;\n&quot;;
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName(&quot;pre&quot;)[0], false);*/
-            };
-        };
-        return parseErrorText;
-    };
-};
-Sarissa.getText = function(oNode, deep){
-    var s = &quot;&quot;;
-    var nodes = oNode.childNodes;
-    for(var i=0; i &lt; nodes.length; i++){
-        var node = nodes[i];
-        var nodeType = node.nodeType;
-        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
-            s += node.data;
-        }else if(deep == true
-                    &amp;&amp; (nodeType == Node.ELEMENT_NODE
-                        || nodeType == Node.DOCUMENT_NODE
-                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
-            s += Sarissa.getText(node, true);
-        };
-    };
-    return s;
-};
-if(window.XMLSerializer){
-    /**
-     * &lt;p&gt;Factory method to obtain the serialization of a DOM Node&lt;/p&gt;
-     * @returns the serialized Node as an XML string
-     */
-    Sarissa.serialize = function(oDoc){
-        var s = null;
-        if(oDoc){
-            s = oDoc.innerHTML?oDoc.innerHTML:(new XMLSerializer()).serializeToString(oDoc);
-        };
-        return s;
-    };
-}else{
-    if(Sarissa.getDomDocument &amp;&amp; (Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;, null)).xml){
-        // see non-IE version
-        Sarissa.serialize = function(oDoc) {
-            var s = null;
-            if(oDoc){
-                s = oDoc.innerHTML?oDoc.innerHTML:oDoc.xml;
-            };
-            return s;
-        };
-        /**
-         * Utility class to serialize DOM Node objects to XML strings
-         * @constructor
-         */
-        XMLSerializer = function(){};
-        /**
-         * Serialize the given DOM Node to an XML string
-         * @param oNode the DOM Node to serialize
-         */
-        XMLSerializer.prototype.serializeToString = function(oNode) {
-            return oNode.xml;
-        };
-    };
-};
-
-/**
- * strips tags from a markup string
- */
-Sarissa.stripTags = function (s) {
-    return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
-};
-/**
- * &lt;p&gt;Deletes all child nodes of the given node&lt;/p&gt;
- * @argument oNode the Node to empty
- */
-Sarissa.clearChildNodes = function(oNode) {
-    // need to check for firstChild due to opera 8 bug with hasChildNodes
-    while(oNode.firstChild){
-        oNode.removeChild(oNode.firstChild);
-    };
-};
-/**
- * &lt;p&gt; Copies the childNodes of nodeFrom to nodeTo&lt;/p&gt;
- * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before
- * the copy operation, unless you supply a true third parameter&lt;/p&gt;
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
- */
-Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw &quot;Both source and destination nodes must be provided&quot;;
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-    var nodes = nodeFrom.childNodes;
-    if(ownerDoc.importNode &amp;&amp; (!_SARISSA_IS_IE)) {
-        for(var i=0;i &lt; nodes.length;i++) {
-            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-        };
-    }
-    else{
-        for(var i=0;i &lt; nodes.length;i++) {
-            nodeTo.appendChild(nodes[i].cloneNode(true));
-        };
-    };
-};
-
-/**
- * &lt;p&gt; Moves the childNodes of nodeFrom to nodeTo&lt;/p&gt;
- * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before
- * the move operation, unless you supply a true third parameter&lt;/p&gt;
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
- */
-Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw &quot;Both source and destination nodes must be provided&quot;;
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var nodes = nodeFrom.childNodes;
-    // if within the same doc, just move, else copy and delete
-    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
-        while(nodeFrom.firstChild){
-            nodeTo.appendChild(nodeFrom.firstChild);
-        };
-    }else{
-        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-        if(ownerDoc.importNode &amp;&amp; (!_SARISSA_IS_IE)) {
-           for(var i=0;i &lt; nodes.length;i++) {
-               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-           };
-        }else{
-           for(var i=0;i &lt; nodes.length;i++) {
-               nodeTo.appendChild(nodes[i].cloneNode(true));
-           };
-        };
-        Sarissa.clearChildNodes(nodeFrom);
-    };
-};
-
-/**
- * &lt;p&gt;Serialize any object to an XML string. All properties are serialized using the property name
- * as the XML element name. Array elements are rendered as &lt;code&gt;array-item&lt;/code&gt; elements,
- * using their index/key as the value of the &lt;code&gt;key&lt;/code&gt; attribute.&lt;/p&gt;
- * @argument anyObject the object to serialize
- * @argument objectName a name for that object
- * @return the XML serializationj of the given object as a string
- */
-Sarissa.xmlize = function(anyObject, objectName, indentSpace){
-    indentSpace = indentSpace?indentSpace:'';
-    var s = indentSpace  + '&lt;' + objectName + '&gt;';
-    var isLeaf = false;
-    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-        || anyObject instanceof Boolean || anyObject instanceof Date){
-        s += Sarissa.escape(&quot;&quot;+anyObject);
-        isLeaf = true;
-    }else{
-        s += &quot;\n&quot;;
-        var itemKey = '';
-        var isArrayItem = anyObject instanceof Array;
-        for(var name in anyObject){
-            s += Sarissa.xmlize(anyObject[name], (isArrayItem?&quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot;:name), indentSpace + &quot;   &quot;);
-        };
-        s += indentSpace;
-    };
-    return s += (objectName.indexOf(' ')!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
-};
-
-/**
- * Escape the given string chacters that correspond to the five predefined XML entities
- * @param sXml the string to escape
- */
-Sarissa.escape = function(sXml){
-    return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
-        .replace(/&lt;/g, &quot;&lt;&quot;)
-        .replace(/&gt;/g, &quot;&gt;&quot;)
-        .replace(/&quot;/g, &quot;&quot;&quot;)
-        .replace(/'/g, &quot;&apos;&quot;);
-};
-
-/**
- * Unescape the given string. This turns the occurences of the predefined XML
- * entities to become the characters they represent correspond to the five predefined XML entities
- * @param sXml the string to unescape
- */
-Sarissa.unescape = function(sXml){
-    return sXml.replace(/&apos;/g,&quot;'&quot;)
-        .replace(/&quot;/g,&quot;\&quot;&quot;)
-        .replace(/&gt;/g,&quot;&gt;&quot;)
-        .replace(/&lt;/g,&quot;&lt;&quot;)
-        .replace(/&amp;/g,&quot;&amp;&quot;);
-};
-// EOF
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa cross browser XML library - IE XPath Emulation
- * @version 0.9.6.1
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- *
- * This script emulates Internet Explorer's selectNodes and selectSingleNode
- * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
- * is easy with IE's setProperty.
- * USers may also map a namespace prefix to a default (unprefixed) namespace in the
- * source document with Sarissa.setXpathNamespaces
- *
- *
- * ====================================================================
- * Licence
- * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit <A HREF="http://www.gnu.org">http://www.gnu.org</A>
- *
- */
-if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)){
-    /**
-    * &lt;p&gt;SarissaNodeList behaves as a NodeList but is only used as a result to &lt;code&gt;selectNodes&lt;/code&gt;,
-    * so it also has some properties IEs proprietery object features.&lt;/p&gt;
-    * @private
-    * @constructor
-    * @argument i the (initial) list size
-    */
-    function SarissaNodeList(i){
-        this.length = i;
-    };
-    /** &lt;p&gt;Set an Array as the prototype object&lt;/p&gt; */
-    SarissaNodeList.prototype = new Array(0);
-    /** &lt;p&gt;Inherit the Array constructor &lt;/p&gt; */
-    SarissaNodeList.prototype.constructor = Array;
-    /**
-    * &lt;p&gt;Returns the node at the specified index or null if the given index
-    * is greater than the list size or less than zero &lt;/p&gt;
-    * &lt;p&gt;&lt;b&gt;Note&lt;/b&gt; that in ECMAScript you can also use the square-bracket
-    * array notation instead of calling &lt;code&gt;item&lt;/code&gt;
-    * @argument i the index of the member to return
-    * @returns the member corresponding to the given index
-    */
-    SarissaNodeList.prototype.item = function(i) {
-        return (i &lt; 0 || i &gt;= this.length)?null:this[i];
-    };
-    /**
-    * &lt;p&gt;Emulate IE's expr property
-    * (Here the SarissaNodeList object is given as the result of selectNodes).&lt;/p&gt;
-    * @returns the XPath expression passed to selectNodes that resulted in
-    *          this SarissaNodeList
-    */
-    SarissaNodeList.prototype.expr = &quot;&quot;;
-    /** dummy, used to accept IE's stuff without throwing errors */
-    XMLDocument.prototype.setProperty  = function(x,y){};
-    /**
-    * &lt;p&gt;Programmatically control namespace URI/prefix mappings for XPath
-    * queries.&lt;/p&gt;
-    * &lt;p&gt;This method comes especially handy when used to apply XPath queries
-    * on XML documents with a default namespace, as there is no other way
-    * of mapping that to a prefix.&lt;/p&gt;
-    * &lt;p&gt;Using no namespace prefix in DOM Level 3 XPath queries, implies you
-    * are looking for elements in the null namespace. If you need to look
-    * for nodes in the default namespace, you need to map a prefix to it
-    * first like:&lt;/p&gt;
-    * &lt;pre&gt;Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;<A HREF="aposhttp://mynsURI&amp;amp;apos&amp;quot;">aposhttp://mynsURI&amp;apos&quot;</A>);&lt;/pre&gt;
-    * &lt;p&gt;&lt;b&gt;Note 1 &lt;/b&gt;: Use this method only if the source document features
-    * a default namespace (without a prefix), otherwise just use IE's setProperty
-    * (moz will rezolve non-default namespaces by itself). You will need to map that
-    * namespace to a prefix for queries to work.&lt;/p&gt;
-    * &lt;p&gt;&lt;b&gt;Note 2 &lt;/b&gt;: This method calls IE's setProperty method to set the
-    * appropriate namespace-prefix mappings, so you dont have to do that.&lt;/p&gt;
-    * @param oDoc The target XMLDocument to set the namespace mappings for.
-    * @param sNsSet A whilespace-seperated list of namespace declarations as
-    *            those would appear in an XML document. E.g.:
-    *            &lt;code&gt;&quot;xmlns:xhtml=&apos;<A HREF="http://www.w3.org/1999/xhtml&amp;apos;">http://www.w3.org/1999/xhtml&apos;</A>
-    * xmlns:&apos;<A HREF="http://www.w3.org/1999/XSL/Transform&amp;apos;&amp;quot;&lt;/code">http://www.w3.org/1999/XSL/Transform&apos;&quot;&lt;/code</A>&gt;
-    * @throws An error if the format of the given namespace declarations is bad.
-    */
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        //oDoc._sarissa_setXpathNamespaces(sNsSet);
-        oDoc._sarissa_useCustomResolver = true;
-        var namespaces = sNsSet.indexOf(&quot; &quot;)&gt;-1?sNsSet.split(&quot; &quot;):new Array(sNsSet);
-        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
-        for(var i=0;i &lt; namespaces.length;i++){
-            var ns = namespaces[i];
-            var colonPos = ns.indexOf(&quot;:&quot;);
-            var assignPos = ns.indexOf(&quot;=&quot;);
-            if(colonPos == 5 &amp;&amp; assignPos &gt; colonPos+2){
-                var prefix = ns.substring(colonPos+1, assignPos);
-                var uri = ns.substring(assignPos+2, ns.length-1);
-                oDoc._sarissa_xpathNamespaces[prefix] = uri;
-            }else{
-                throw &quot;Bad format on namespace declaration(s) given&quot;;
-            };
-        };
-    };
-    /**
-    * @private Flag to control whether a custom namespace resolver should
-    *          be used, set to true by Sarissa.setXpathNamespaces
-    */
-    XMLDocument.prototype._sarissa_useCustomResolver = false;
-    /** @private */
-    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
-    /**
-    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectNodes.&lt;/p&gt;
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as a SarissaNodeList
-    * @throws An error if no namespace URI is found for the given prefix.
-    */
-    XMLDocument.prototype.selectNodes = function(sExpr, contextNode){
-        var nsDoc = this;
-        var nsresolver = this._sarissa_useCustomResolver
-        ? function(prefix){
-            var s = nsDoc._sarissa_xpathNamespaces[prefix];
-            if(s)return s;
-            else throw &quot;No namespace URI found for prefix: '&quot; + prefix+&quot;'&quot;;
-            }
-        : this.createNSResolver(this.documentElement);
-            var oResult = this.evaluate(sExpr,
-                    (contextNode?contextNode:this),
-                    nsresolver,
-                    XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-        var nodeList = new SarissaNodeList(oResult.snapshotLength);
-        nodeList.expr = sExpr;
-        for(var i=0;i&lt;nodeList.length;i++)
-            nodeList[i] = oResult.snapshotItem(i);
-        return nodeList;
-    };
-    /**
-    * &lt;p&gt;Extends the Element to emulate IE's selectNodes&lt;/p&gt;
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An
-    *             error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectNodes = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectNodes)
-            return doc.selectNodes(sExpr, this);
-        else
-            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
-    };
-    /**
-    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectSingleNodes.&lt;/p&gt;
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    */
-    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
-        var ctx = contextNode?contextNode:null;
-        sExpr = &quot;(&quot;+sExpr+&quot;)[1]&quot;;
-        var nodeList = this.selectNodes(sExpr, ctx);
-        if(nodeList.length &gt; 0)
-            return nodeList.item(0);
-        else
-            return null;
-    };
-    /**
-    * &lt;p&gt;Extends the Element to emulate IE's selectNodes.&lt;/p&gt;
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectSingleNode = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectSingleNode)
-            return doc.selectSingleNode(sExpr, this);
-        else
-            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
-    };
-    Sarissa.IS_ENABLED_SELECT_NODES = true;
-};
-// EOF
\ No newline at end of file

Added: trunk/lib/minimal/Freja.js
===================================================================
--- trunk/lib/minimal/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/minimal/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1984 @@
+/***
+
+    Freja 2.1
+
+    Build $Wed, 21 Mar 2007 15:05:31 UTC$
+
+    Target: minimal
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    Copyright (c) 2006-2007 Cedric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">cedric at veerwest.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;
+    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;
+
+***/
+
+if (typeof(dojo) != &quot;undefined&quot;) {
+	dojo.provide(&quot;Freja&quot;);
+}
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja.NAME = &quot;Freja&quot;;
+Freja.VERSION = &quot;2.1&quot;;
+Freja.__repr__ = function () {
+	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
+};
+Freja.toString = function () {
+	return this.__repr__();
+};
+/**
+  * Single-hierarchy inheritance (class emulation)
+  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
+  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
+  */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * &lt;p&gt;Sarissa is a utility class. Provides &quot;static&quot; methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.&lt;/p&gt;
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = &quot;Document contains no parsing errors&quot;;
+Sarissa.PARSED_EMPTY = &quot;Document is empty&quot;;
+Sarissa.PARSED_UNKNOWN_ERROR = &quot;Not well-formed or other error&quot;;
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = &quot;&quot;;
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation &amp;&amp; true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT &amp;&amp; _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent &amp;&amp; navigator.vendor &amp;&amp; (navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;) != -1 || navigator.vendor.indexOf(&quot;Apple&quot;) != -1));
+var _SARISSA_IS_IE = document.all &amp;&amp; window.ActiveXObject &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;) &gt; -1  &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;) == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == &quot;undefined&quot; &amp;&amp; typeof Document !=&quot;undefined&quot;){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = &quot;xsl:&quot;;
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = &quot;&quot;;
+    var _SARISSA_XMLHTTP_PROGID = &quot;&quot;;
+    var _SARISSA_DOM_XMLWRITER = &quot;&quot;;
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw &quot;Could not retreive a valid progID of Class: &quot; + idList[idList.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XMLHTTP.6.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.DOMDocument.6.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = &quot;&quot;;
+            if(sUri){
+                if(sName.indexOf(&quot;:&quot;) &gt; 1){
+                    prefix = sName.substring(0, sName.indexOf(&quot;:&quot;));
+                    sName = sName.substring(sName.indexOf(&quot;:&quot;)+1); 
+                }else{
+                    prefix = &quot;a&quot; + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('&lt;' + prefix+':'+sName + &quot; xmlns:&quot; + prefix + &quot;=\&quot;&quot; + sUri + &quot;\&quot;&quot; + &quot; /&gt;&quot;);
+            } else {
+                oDoc.loadXML('&lt;' + sName + &quot; /&gt;&quot;);
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = &quot;XML Parsing Error: &quot; + oDoc.parseError.reason + 
+                &quot;\nLocation: &quot; + oDoc.parseError.url + 
+                &quot;\nLine Number &quot; + oDoc.parseError.line + &quot;, Column &quot; + 
+                oDoc.parseError.linepos + 
+                &quot;:\n&quot; + oDoc.parseError.srcText +
+                &quot;\n&quot;;
+            for(var i = 0;  i &lt; oDoc.parseError.linepos;i++){
+                parseErrorText += &quot;-&quot;;
+            };
+            parseErrorText +=  &quot;^\n&quot;;
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        oDoc.setProperty(&quot;SelectionNamespaces&quot;, sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XSLTemplate.6.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * &lt;b&gt;Note:&lt;/b&gt; If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID([&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
+        };
+        xslDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        xslDoc.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url &amp;&amp; xslDoc.selectSingleNode(&quot;//xsl:*[local-name() = 'import' or local-name() = 'include']&quot;) != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == &quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;) { 
+                converted.setProperty(&quot;AllowDocumentFunction&quot;, true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        var output = converted.selectSingleNode(&quot;//xsl:output&quot;);
+        this.outputMethod = output ? output.getAttribute(&quot;method&quot;) : &quot;html&quot;;
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID([&quot;Msxml2.MXXMLWriter.6.0&quot;, &quot;Msxml2.MXXMLWriter.3.0&quot;, &quot;MSXML2.MXXMLWriter&quot;, &quot;MSXML.MXXMLWriter&quot;, &quot;Microsoft.XMLDOM&quot;]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+&quot;&quot;);
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * &lt;b&gt;Note&lt;/b&gt;: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body &amp;&amp; ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '&lt;?xml') {
+                s = s.substring(s.indexOf('?&gt;') + 2);
+            }
+            var xml = ''.concat('&lt;my&gt;', s, '&lt;/my&gt;');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[&quot;&quot;+nsURI]){
+            this.paramsSet[&quot;&quot;+nsURI] = new Array();
+        };
+        this.paramsSet[&quot;&quot;+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || &quot;&quot;;
+        if(this.paramsSet[nsURI] &amp;&amp; this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * &lt;p&gt;Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use&lt;/p&gt;
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * &lt;p&gt;Attached by an event handler to the load event. Internal use.&lt;/p&gt;
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * &lt;p&gt;Sets the readyState property of the given DOM Document object.
+         * Internal use.&lt;/p&gt;
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null &amp;&amp; typeof oDoc.onreadystatechange == &quot;function&quot;)
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * &lt;p&gt;Emulate IE's onreadystatechange attribute&lt;/p&gt;
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * &lt;p&gt;Emulates IE's readyState property, which always gives an integer from 0 to 4:&lt;/p&gt;
+                * &lt;ul&gt;&lt;li&gt;1 == LOADING,&lt;/li&gt;
+                * &lt;li&gt;2 == LOADED,&lt;/li&gt;
+                * &lt;li&gt;3 == INTERACTIVE,&lt;/li&gt;
+                * &lt;li&gt;4 == COMPLETED&lt;/li&gt;&lt;/ul&gt;
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener(&quot;load&quot;, _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; window.Document &amp;&amp; !Document.prototype.load &amp;&amp; document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * &lt;p&gt;Factory method to obtain a new DOM Document object&lt;/p&gt;
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc &amp;&amp; (sUri || sName) &amp;&amp; !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open(&quot;GET&quot;, &quot;data:text/xml;charset=utf-8,&quot; + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument &amp;&amp; Sarissa.getDomDocument() &amp;&amp; Sarissa.getDomDocument(null, &quot;bar&quot;).xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == &quot;undefined&quot;) &amp;&amp; _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == &quot;tbody&quot; || oNode.nodeName == &quot;tr&quot;){
+                tmp = document.createElement(&quot;table&quot;);
+            }
+            else if(oNode.nodeName == &quot;td&quot;){
+                tmp = document.createElement(&quot;tr&quot;);
+            }
+            else if(oNode.nodeName == &quot;option&quot;){
+                tmp = document.createElement(&quot;select&quot;);
+            }
+            else{
+                tmp = document.createElement(&quot;div&quot;);
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName(&quot;*&quot;)[0];
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * &lt;p&gt;Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.&lt;/p&gt;
+     * &lt;p&gt;Many thanks to Christian Stocker for the initial patch.&lt;/p&gt;
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == &quot;parsererror&quot;){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += &quot;\n&quot; +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName(&quot;parsererror&quot;).length &gt; 0){
+            var parsererror = oDoc.getElementsByTagName(&quot;parsererror&quot;)[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+&quot;\n&quot;;
+        } else if(oDoc.parseError &amp;&amp; oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = &quot;&quot;;
+    var nodes = oNode.childNodes;
+    for(var i=0; i &lt; nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    &amp;&amp; (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    &amp;&amp; Sarissa.getDomDocument 
+    &amp;&amp; Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;, null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
+};
+/**
+ * &lt;p&gt;Deletes all child nodes of the given node&lt;/p&gt;
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * &lt;p&gt; Copies the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != &quot;undefined&quot;)  {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * &lt;p&gt; Moves the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != &quot;undefined&quot;) {
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * &lt;p&gt;Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as &lt;code&gt;array-item&lt;/code&gt; elements, 
+ * using their index/key as the value of the &lt;code&gt;key&lt;/code&gt; attribute.&lt;/p&gt;
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '&lt;' + objectName + '&gt;';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(&quot;&quot;+anyObject);
+        isLeaf = true;
+    }else{
+        s += &quot;\n&quot;;
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?&quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot;:name), indentSpace + &quot;   &quot;);
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
+        .replace(/&lt;/g, &quot;&lt;&quot;)
+        .replace(/&gt;/g, &quot;&gt;&quot;)
+        .replace(/&quot;/g, &quot;&quot;&quot;)
+        .replace(/'/g, &quot;&apos;&quot;);
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,&quot;'&quot;)
+        .replace(/&quot;/g,&quot;\&quot;&quot;)
+        .replace(/&gt;/g,&quot;&gt;&quot;)
+        .replace(/&lt;/g,&quot;&lt;&quot;)
+        .replace(/&amp;/g,&quot;&amp;&quot;);
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ *
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)){
+    /**
+    * &lt;p&gt;SarissaNodeList behaves as a NodeList but is only used as a result to &lt;code&gt;selectNodes&lt;/code&gt;,
+    * so it also has some properties IEs proprietery object features.&lt;/p&gt;
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** &lt;p&gt;Set an Array as the prototype object&lt;/p&gt; */
+    SarissaNodeList.prototype = new Array(0);
+    /** &lt;p&gt;Inherit the Array constructor &lt;/p&gt; */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * &lt;p&gt;Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero &lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note&lt;/b&gt; that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling &lt;code&gt;item&lt;/code&gt;
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i &lt; 0 || i &gt;= this.length)?null:this[i];
+    };
+    /**
+    * &lt;p&gt;Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).&lt;/p&gt;
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = &quot;&quot;;
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument &amp;&amp; (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * &lt;p&gt;Programmatically control namespace URI/prefix mappings for XPath
+    * queries.&lt;/p&gt;
+    * &lt;p&gt;This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.&lt;/p&gt;
+    * &lt;p&gt;Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:&lt;/p&gt;
+    * &lt;pre&gt;Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;<A HREF="aposhttp://mynsURI&amp;amp;apos&amp;quot;">aposhttp://mynsURI&amp;apos&quot;</A>);&lt;/pre&gt;
+    * &lt;p&gt;&lt;b&gt;Note 1 &lt;/b&gt;: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.&lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note 2 &lt;/b&gt;: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.&lt;/p&gt;
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            &lt;code&gt;&quot;xmlns:xhtml=&apos;<A HREF="http://www.w3.org/1999/xhtml&amp;apos;">http://www.w3.org/1999/xhtml&apos;</A>
+    * xmlns:&apos;<A HREF="http://www.w3.org/1999/XSL/Transform&amp;apos;&amp;quot;&lt;/code">http://www.w3.org/1999/XSL/Transform&apos;&quot;&lt;/code</A>&gt;
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(&quot; &quot;)&gt;-1?sNsSet.split(&quot; &quot;):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i &lt; namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(&quot;:&quot;);
+            var assignPos = ns.indexOf(&quot;=&quot;);
+            if(colonPos &gt; 0 &amp;&amp; assignPos &gt; colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw &quot;Bad format on namespace declaration(s) given&quot;;
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectNodes.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw &quot;No namespace URI found for prefix: '&quot; + prefix+&quot;'&quot;;
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i&lt;nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectNodes&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the minimal auxiliary adapter. It contains self-sufficient
+  * implementations of all dependencies.
+  * 
+  */
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self) : function */
+// from <A HREF="http://blog.ianbicking.org/prototype-and-object-prototype.html">http://blog.ianbicking.org/prototype-and-object-prototype.html</A>
+Freja._aux.bind = function(func, self) {
+	if(typeof (func)==&quot;string&quot;){
+		func=self[func];
+	}
+
+	var im_func = null;
+    if (typeof(func.im_func) == 'function') {
+        im_func = func.im_func;
+    } else {
+        im_func = func;
+    }
+    func = function () {
+        return func.im_func.apply(func.im_self, arguments);
+    }
+    func.im_func = im_func;
+    func.im_self = self;
+	return func;
+};
+/** formContents(elem) : Array */
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName(&quot;INPUT&quot;);
+	for (var i = 0; i &lt; inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == &quot;radio&quot; || input.type == &quot;checkbox&quot;) {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push(&quot;&quot;);
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName(&quot;TEXTAREA&quot;);
+	for (var i = 0; i &lt; textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName(&quot;SELECT&quot;);
+	for (var i = 0; i &lt; selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex &gt;= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : &quot;&quot;);
+			}
+		}
+	}
+	return [names, values];
+};
+/** getElement(id) : HTMLElement */
+Freja._aux.getElement = function(id) {
+	if (typeof(id) == &quot;object&quot;) {
+		return id;
+	} else {
+		return document.getElementById(id);
+	}
+};
+
+/** connect(src, signal, fnc) : void */
+Freja._aux.connect = function(src, signal, fnc) {
+
+	if(!src) return;
+	if (src.addEventListener) {
+		var wrapper = function(e) {
+			var evt = {
+				stop : function() {
+					if (e.cancelable) {
+						e.preventDefault();
+					}
+					e.stopPropagation();
+				}
+			}
+			fnc(evt);
+		}
+		src.addEventListener(signal.replace(/^(on)/, &quot;&quot;), wrapper, false);
+	} else if (src.attachEvent) {
+		var wrapper = function() {
+			var e = window.event;
+			var evt = {
+				stop : function() {
+					e.cancelBubble = true;
+					e.returnValue = false;
+				}
+			}
+			fnc(evt);
+		}
+		src.attachEvent(signal, wrapper);
+	}
+	if (!src._signals) {
+		src._signals = [];
+	}
+	if (!src._signals[signal]) {
+		src._signals[signal] = [];
+	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item &lt; src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
+	src._signals[signal].push(fnc);
+};
+/** signal(src, signal, ...) : void */
+Freja._aux.signal = function(src, signal) {
+
+	try {
+		var sigs = src._signals[signal];
+		var args = [];
+		for (var i=2; i &lt; arguments.length; i++) {
+			args.push(arguments[i]);
+		}
+		for (var i=0; i &lt; sigs.length; i++) {
+			try {
+				sigs[i].apply(src, args);
+			} catch (e) { /* squelch */ }
+		}
+	} catch (e) { /* squelch */ }
+};
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new Freja._aux.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user &amp;&amp; pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
+		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
+	var d = Freja._aux.createDeferred();
+	var bComplete = false;
+	req.onreadystatechange = function() {
+		if (req.readyState == 4 &amp;&amp; !bComplete) {
+			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
+				d.callback(req);
+			} else {
+				d.errback(req);
+			}
+			bComplete = true;
+		}
+	}
+	if (!sendContent) sendContent = &quot;&quot;;
+	req.send(sendContent);
+	return d;
+};
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter(&quot;&quot;, paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+
+	// Can't clone a DocumentNode in Safari &amp; Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation &amp;&amp; document.implementation.createDocument) {
+			clone = document.implementation.createDocument(&quot;&quot;, xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+				for (var i = data.childNodes.length; i &gt;= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				// need to copy root node attributes
+				for (var i = 0; i &lt; xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}
+			}
+		}
+	}
+	return clone;
+};
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};
+/** A pale replacement for MochiKit.Async.Deferred */
+Freja._aux.Deferred = function() {
+	this._good = [];
+	this._bad = [];
+	this._pending = null;
+};
+Freja._aux.Deferred.prototype.callback = function() {
+	if (this._good.length == 0) {
+		this._pending = [this.callback, arguments];
+		return;
+	}
+	for (var i=0; i &lt; this._good.length; i++) {
+		this._good[i].apply(window, arguments);
+	}
+	this._good = [];
+};
+Freja._aux.Deferred.prototype.errback = function() {
+	if (this._bad.length == 0) {
+		this._pending = [this.errback, arguments];
+		return;
+	}
+	for (var i=0; i &lt; this._bad.length; i++) {
+		this._bad[i].apply(window, arguments);
+	}
+	this._bad = [];
+};
+Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
+	if (fncOK) this._good[this._good.length] = fncOK;
+	if (fncError) this._bad[this._bad.length] = fncError;
+	if (this._pending) {
+		this._pending[0].apply(this, this._pending[1]);
+	}
+};
+Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
+	this.addCallbacks(fncOK);
+};
+Freja._aux.Deferred.prototype.addErrback = function(fncError) {
+	this.addCallbacks(null, fncError);
+};
+
+/**
+  * The baseclass for queryengines
+  * @abstract
+  */
+Freja.QueryEngine = function() {};
+Freja.QueryEngine.prototype.getElementById = function(document, id) {
+	// getElementById doesn't work on XML document without xml:id
+	var allElements = document.getElementsByTagName(&quot;*&quot;);
+	for (var i= 0; i &lt; allElements.length; i++) {
+		if (allElements[i].getAttribute(&quot;id&quot;) == id) {
+			return allElements[i];
+		}
+	}
+};
+Freja.QueryEngine.prototype.get = function(document, expression) {
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error(&quot;Can't evaluate expression &quot; + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
+	}
+	return null;
+};
+Freja.QueryEngine.prototype.set = function(document, expression, value) {
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
+			}
+			// else parent node non existent either, give up.
+		}
+		// not an attribute, give up.
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!=&quot;&quot;) // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
+};
+/**
+  * XPath query engine.
+  */
+Freja.QueryEngine.XPath = function() {};
+Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
+};
+/**
+  * SimplePath
+  */
+Freja.QueryEngine.SimplePath = function() {};
+Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
+	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	var parts = expression.split(&quot;/&quot;);
+	var node = document;
+	var regAttr = new RegExp(&quot;^@([\\d\\w]*)&quot;);
+	var regOffset = new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
+	var regFilter = new RegExp(&quot;^([\\d\\w]+)\\[@([@\\d\\w]+)=['\&quot;]{1}(.*)['\&quot;]{1}\\]$&quot;);
+	var attr = null;
+	var offset = 0;
+	for (var i = 0; i &lt; parts.length; ++i) {
+		var part = parts[i];
+		var filter = regFilter.exec(part);
+		if(filter) {
+			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
+			if(i&gt;0 &amp;&amp; parts[i-1]=='') {
+				// expression was of type //element[...]
+				var cn = node.getElementsByTagName(filter[1]);
+			} else {
+				var cn = node.childNodes;
+			}
+			for(var j=0, l=cn.length; j&lt;l ; j++) {
+				if(cn[j].nodeType==1 &amp;&amp; cn[j].tagName==filter[1] &amp;&amp; cn[j].getAttribute(filter[2])== filter[3]) {
+					node = cn[j];
+					break;
+				}
+			}
+			if (j==l)
+				throw new Error(&quot;Can't evaluate expression &quot; + part);
+		}
+		else {
+			offset = regOffset.exec(part);
+			if (offset) {
+				part = offset[1];
+				offset = offset[2] - 1;
+			} else {
+				offset = 0;
+			}
+			if (part != &quot;&quot;) {
+				attr = regAttr.exec(part);
+				if (attr) {
+					node = node.getAttributeNode(attr[1]);
+				} else {
+					node = node.getElementsByTagName(part).item(offset);
+				}
+			}
+		}
+	}
+	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	}
+	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+
+	if (!node) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	return node;
+};
+/**
+  * Standard model component
+  */
+Freja.Model = function(url, query) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._query = query;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.getElementById = function(id) {
+	if (this.document) {
+		return this._query.getElementById(this.document, id);
+	}
+	return null;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.get = function(expression) {
+	if (this.document) {
+		return this._query.get(this.document, expression);
+	}
+	return null;
+};
+/**
+  * Updates a value
+  */
+Freja.Model.prototype.set = function(expression, value) {
+	if (this.document) {
+		return this._query.set(this.document, expression, value);
+	}
+	return null;
+};
+/**
+  * Updates the model from a view
+  */
+Freja.Model.prototype.updateFrom = function(view) {
+	var values = view.getValues();
+	for (var i = 0; i &lt; values[0].length; ++i) {
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
+	}
+};
+/**
+  * Writes the model back to the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.save = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	// since the serialization may fail, we create a deferred for the
+	// purpose, rather than just returning the sendXMLHttpRequest directly.
+	var d = Freja._aux.createDeferred();
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, url);
+	try {
+		// for some obscure reason exceptions aren't thrown back if I call the
+		// shorthand version of sendXMLHttpRequest in IE6.
+		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Deletes the model from the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.remove = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;, url);
+	return Freja._aux.sendXMLHttpRequest(req);
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.reload = function() {
+	this.ready = false;
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, this);
+	var d = Freja.AssetManager.loadAsset(this.url, true);
+	d.addCallbacks(onload, Freja.AssetManager.onerror);
+	return d;
+};
+/**
+  * DataSource provides a gateway-type interface to a REST service.
+  */
+Freja.Model.DataSource = function(createURL, indexURL) {
+	this.createURL = createURL;
+	this.indexURL = indexURL;
+};
+/**
+  * Returns a list of primary-keys to records in the datasource
+  */
+Freja.Model.DataSource.prototype.select = function() {
+	return getModel(this.indexURL);
+};
+/**
+  * Creates a new instance of a record
+  * @todo errback to the deferred on errors
+  */
+Freja.Model.DataSource.prototype.create = function(values) {
+	var url = this.createURL;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;, url);
+	var payload = {};
+	for (var i = 0, len = values[0].length; i &lt; len; ++i) {
+		payload[values[0][i]] = values[1][i];
+	}
+	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
+};
+
+/**
+  * Standard view component
+  */
+Freja.View = function(url, renderer) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._renderer = renderer;
+	this._destination = null;
+	this.behaviors = [];
+	this.placeholder = null;
+	Freja._aux.connect(this, &quot;onrendercomplete&quot;, Freja._aux.bind(this._connectBehavior, this));
+};
+/**
+  * @param    model            Freja.Model
+  * @param    placeholder      string    If supplied, this will be used instead of the
+  *                                      default placeholder.
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.prototype.render = function(model, placeholder, xslParameters) {
+	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
+	if (typeof(xslParameters) == &quot;undefined&quot;) xslParameters = this.xslParameters;
+
+	var Handler = function(model, view, deferred, xslParameters) {
+		this.model = model;
+		this.view = view;
+		this.deferred = deferred;
+		this.xslParameters = xslParameters;
+	};
+	Handler.prototype.trigger = function() {
+		try {
+			if (!this.view.ready) {
+				Freja._aux.connect(this.view, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			if (typeof(this.model) == &quot;object&quot; &amp;&amp; this.model instanceof Freja.Model &amp;&amp; !this.model.ready) {
+				Freja._aux.connect(this.model, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			var model;
+			if (typeof(this.model) == &quot;undefined&quot;) {
+				// supply dummy
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
+			} else if (this.model instanceof Freja.Model) {
+				model = this.model;
+			} else {
+				// wrap pojo's in
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot; + Freja._aux.xmlize(this.model, &quot;item&quot;)) };
+			}
+
+			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
+			trans.addCallback(Freja._aux.bind(function(html) {
+				if(typeof html == &quot;string&quot;) {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = &quot;&quot;;   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
+			}, this.view));
+			trans.addCallback(Freja._aux.bind(function() {
+				Freja._aux.signal(this, &quot;onrendercomplete&quot;, this._destination)
+			}, this.view));
+			trans.addCallback(this.deferred.callback);
+			trans.addErrback(this.deferred.errback);
+		} catch (ex) {
+			this.deferred.errback(ex);
+		}
+	};
+
+	var d = Freja._aux.createDeferred();
+	try {
+		if (typeof(placeholder) == &quot;object&quot;) {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
+		// @todo    Is this a good idea ?
+		// Perhaps we should leave it to the programmer to do this.
+		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
+
+		var h = new Handler(model, this, d, xslParameters);
+		h.trigger();
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Decorates the output of the primary renderer, to inject behavior.
+  * @note Maybe we could use cssQuery (<A HREF="http://dean.edwards.name/my/cssQuery/">http://dean.edwards.name/my/cssQuery/</A>)
+  *       to identify targets for behavior
+  */
+Freja.View.prototype._connectBehavior = function(destination) {
+	try {
+		var connectCallback = function(node, eventType, callback) {
+
+			Freja._aux.connect(node, eventType, Freja._aux.bind(
+				function(e) {
+					var allow = false;
+					try {
+						allow = callback(this);
+					} catch (ex) {
+						throw new Error(&quot;An error ocurred in user handler.\n&quot; + ex.message);
+					} finally {
+						if (!allow) {
+							e.stop();
+						}
+					}
+				}, node)
+			);
+		};
+		var applyHandlers = function(node, behaviors) {
+			for (var i = 0, c = node.childNodes, l = c.length; i &lt; l; ++i) {
+				var child = c[i];
+				if (child.nodeType == 1) {
+					if(child.className) {
+						var classNames = child.className.split(' ');
+						for (var j=0;j&lt;classNames.length;j++) {
+							var handler = behaviors[classNames[j]];
+							if (handler) {
+								for (var eventType in handler) {
+									if (eventType == &quot;init&quot;) {
+										handler.init(child);
+									} else {
+										connectCallback(child, eventType, handler[eventType]);
+									}
+								}
+							}
+						}
+					}
+					applyHandlers(child, behaviors);
+				}
+			}
+		};
+
+		// Avoid traversing the DOM tree if there's no handler to process.
+		// @note: is there a better way? this.behaviors.length is always 0.
+		// @note  This is fine. behaviors is a hashmap, not an array.
+		for (var ids in this.behaviors) {
+			applyHandlers(destination, this.behaviors);
+			break;
+		}
+
+	} catch (ex) {
+		alert(ex.message);
+	}
+};
+/**
+  * Returns the values of a formview
+  */
+Freja.View.prototype.getValues = function() {
+	return Freja._aux.formContents(this._destination);
+};
+/**
+  * Base object for viewrenderers
+  */
+Freja.View.Renderer = function() {};
+/**
+  * XSLT based render-engine
+  */
+Freja.View.Renderer.XSLTransformer = function() {};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+        try {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
+			d.errback(new Error(&quot;XSL Transformation error.&quot;));
+		} else {
+			d.callback(html);
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * XSLT on a remote service for browser which have no native support.
+  * @param    url    URL of the transform service
+  */
+Freja.View.Renderer.RemoteXSLTransformer = function(url) {
+	this.url = url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+
+	// prepare posted data  (no need to send the XSL document, just its url)
+	var xslUrl = view.url;
+	var postedData = &quot;xslFile=&quot; + encodeURIComponent(xslUrl) + &quot;&amp;xmlData=&quot; + encodeURIComponent(Freja._aux.serializeXML(model.document));
+
+	var xslParameterString = '';
+	for (var paramname in xslParameters) {
+		xslParameterString += encodeURIComponent(paramname + &quot;,&quot; + xslParameters[paramname]);
+	}
+	if(xslParameterString.length &gt; 0) {
+		postedData  = postedData + '&amp;xslParam=' + xslParameterString;
+	}
+
+	// send request to the server-side XSL transformation service
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, Freja.AssetManager.XSLT_SERVICE_URL);
+	req.onreadystatechange = function() {
+		if (req.readyState == 4) {
+			if (req.status == 200) {
+				d.callback(req.responseText);
+			} else {
+				d.errback(req.responseText);
+			}
+		}
+	}
+	req.send(postedData);
+	return d;
+};
+/**
+  * This is largely s copied with minor stylistic adjustments from Freja 1.1
+  * I renamed it from Controller.history to distinguish between window.history
+  */
+Freja.UndoHistory = function() {
+	this.cache = [];
+	this.maxLength = 5;
+	this._position = 0;
+	this._undoSteps = 0;
+};
+/**
+  * Creates a snapshot of the model and stores it.
+  */
+Freja.UndoHistory.prototype.add = function(model) {
+	var historyIndex = this._position % this.maxLength;
+
+	var modelDoc = model.document;
+	this.cache[historyIndex] = {};
+	this.cache[historyIndex].model = model;
+	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
+
+	if (!this.cache[historyIndex].document) {
+		throw new Error(&quot;Couldn't add to history.&quot;);
+	} else {
+		this._position++;
+		// clear rest of the history if undo was used.
+		var clearHistoryIndex = historyIndex;
+		while (this._undoSteps &gt; 0) {
+			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
+			this.cache[clearHistoryIndex] = {};
+			this._undoSteps--;
+		}
+		return historyIndex; // what would anybody need this for ?
+	}
+};
+/**
+  * Rolls the state back one step.
+  */
+Freja.UndoHistory.prototype.undo = function(steps) {
+	if (this._undoSteps &lt; this.cache.length) {
+		this._undoSteps++;
+		this._position--;
+		if (this._position &lt; 0) {
+			this._position = this.maxLength - 1;
+		}
+
+		var model = this.cache[this._position].model;
+		if (this.cache[this._position].document) {
+			model.document = this.cache[this._position].document;
+		} else {
+			throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
+		}
+		if (typeof(steps) != &quot;undefined&quot; &amp;&amp; steps &gt; 1) {
+			this.undo(steps - 1);
+		}
+	} else {
+		throw new Error(&quot;Nothing to undo&quot;);
+	}
+};
+/**
+  * Reverts the effects of undo.
+  */
+Freja.UndoHistory.prototype.redo = function() {
+	if (this._undoSteps &gt; 0) {
+		this._undoSteps--;
+		this._position = (this._position + 1) % this.maxLength;
+
+		var model = this.cache[this._position].model;
+		model.document = this.cache[this._position].document;
+	} else {
+		throw new Error(&quot;Nothing to redo&quot;);
+	}
+};
+/**
+  * Removes the last entry in the cache
+  */
+Freja.UndoHistory.prototype.removeLast = function() {
+	this._position--;
+
+	if (this._position &lt; 0) {
+		this._position = this.maxLength - 1;
+	}
+	this.cache[this._position] = {};
+	this._undoSteps = 0;
+};
+
+/**
+  * main repository
+  * @static
+  */
+Freja.AssetManager = {
+	models : [],
+	views : [],
+	_username : null,
+	_password : null
+};
+/**
+  * Set to sync to make all requests synchroneous. You shouldn't use
+  * this setting for anything but testing/debugging.
+  * &quot;async&quot; | &quot;sync&quot;
+  */
+Freja.AssetManager.HTTP_REQUEST_TYPE = &quot;async&quot;;
+/**
+  * If this is set to null, real PUT and DELETE http-requests will be made,
+  * otherwise a header will be set instead, and the request tunneled through
+  * POST.
+  *
+  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
+  * if theese are your target platform, you can disable tunneling.
+  */
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
+/**
+  * Set this url to provide remote xslt-transformation for browsers that
+  * doesn't support it natively.
+  */
+Freja.AssetManager.XSLT_SERVICE_URL = &quot;srvc-xslt.php&quot;;
+/**
+  * HTML displayed while waiting for stuff to happen
+  */
+Freja.AssetManager.THROBBER_HTML = &quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
+/**
+  * returns an instance of the renderengine to use
+  */
+Freja.AssetManager.createRenderer = function() {
+//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	if (Freja._aux.hasSupportForXSLT()) {
+		return new Freja.View.Renderer.XSLTransformer();
+	} else {
+		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	}
+};
+/**
+  * Wipes all caches. This isn't something you will normally use during production,
+  * but it's very helpful for debugging/testing
+  */
+Freja.AssetManager.clearCache = function() {
+	this.models = [];
+	this.views = [];
+};
+/**
+  * Load a model-component
+  * @param    url      string
+  */
+Freja.AssetManager.getModel = function(url) {
+	for (var i=0; i &lt; this.models.length; i++) {
+		if (this.models[i].url == url) {
+			return this.models[i];
+		}
+	}
+	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, m);
+	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.models.push(m);
+	return m;
+};
+/**
+  * Load a view-component
+  * @param    url      string
+  */
+Freja.AssetManager.getView = function(url) {
+	for (var i=0; i &lt; this.views.length; i++) {
+		if (this.views[i].url == url) {
+			return this.views[i];
+		}
+	}
+	var v = new Freja.View(url, this.createRenderer());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, v);
+	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.views.push(v);
+	return v;
+};
+/**
+  * Creates and opens a http-request, tunneling exotic methods if needed.
+  */
+Freja.AssetManager.openXMLHttpRequest = function(method, url) {
+	var tunnel = null;
+	if (Freja.AssetManager.HTTP_METHOD_TUNNEL &amp;&amp; method != &quot;GET&quot; &amp;&amp; method != &quot;POST&quot;) {
+		tunnel = method;
+		method = &quot;POST&quot;;
+	}
+	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+	if (tunnel) {
+		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
+	}
+	return req;
+};
+/**
+  * Sets username + password for Http-Authentication
+  */
+Freja.AssetManager.setCredentials = function(username, password) {
+	this._username = username;
+	this._password = password;
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.AssetManager.loadAsset = function(url, preventCaching) {
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var d = Freja._aux.createDeferred();
+	var handler = function(transport) {
+		try {
+			if (transport.responseText == &quot;&quot;) {
+				throw new Error(&quot;Empty response.&quot;);
+			}
+			if (transport.responseXML.xml == &quot;&quot;) {
+				// The server doesn't reply with Content-Type: text/xml
+				// this will happen if the file is loaded locally (through <A HREF="file://">file://</A>)
+				var document = Freja._aux.loadXML(transport.responseText);
+			} else {
+				var document = transport.responseXML;
+			}
+		} catch (ex) {
+			d.errback(ex);
+		}
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
+	};
+	try {
+		// Why using HTTP_METHOD_TUNNEL for a GET?
+		//-- to prevent caching, since browsers won't cache a POST
+		if (preventCaching &amp;&amp; Freja.AssetManager.HTTP_METHOD_TUNNEL) {
+			var req = Freja._aux.openXMLHttpRequest(&quot;POST&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, &quot;GET&quot;);
+			req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+		} else {
+			var req = Freja._aux.openXMLHttpRequest(&quot;GET&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+		}
+
+		// This shouldn't be nescesary, but alas it is - firefox chokes
+		// It's probably due to an error in MochiKit, so the problem
+		// should be fixed there.
+		var comm = Freja._aux.sendXMLHttpRequest(req);
+		if (Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;) {
+			// fixes bug #7189 (<A HREF="http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189">http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189</A>)
+			comm.addCallbacks(handler, function(req) {
+				d.errback(new Error(&quot;Request failed:&quot; + req.status));
+			});
+		} else {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
+				handler(req);
+			} else {
+				d.errback(new Error(&quot;Request failed:&quot; + req.status));
+			}
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * This is a default error-handler. You should provide your own.
+  * The handler is called if an asynchronous error happens, since
+  * this could not be caught with the usual try ... catch
+  *
+  * It ought to be replaced completely with Deferred
+  */
+Freja.AssetManager.onerror = function(ex) {
+	alert(&quot;Freja.AssetManager.onerror\n&quot; + ex.message);
+};
+/**
+  * Global exports
+  */
+window.getModel = Freja._aux.bind(&quot;getModel&quot;, Freja.AssetManager);
+window.getView = Freja._aux.bind(&quot;getView&quot;, Freja.AssetManager);
\ No newline at end of file

Added: trunk/lib/minimal/Freja_pack.js
===================================================================
--- trunk/lib/minimal/Freja_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/minimal/Freja_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1385 @@
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;Freja&quot;);
+}
+if(typeof (Freja)==&quot;undefined&quot;){
+Freja={};
+}
+Freja.NAME=&quot;Freja&quot;;
+Freja.VERSION=&quot;2.1&quot;;
+Freja.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+Freja.toString=function(){
+return this.__repr__();
+};
+Freja.Class={};
+Freja.Class.extend=function(_1,_2){
+var _3=function(){
+};
+_3.prototype=_2.prototype;
+_1.prototype=new _3();
+_1.prototype.constructor=_1;
+_1.prototype.superconstructor=_2;
+_1.prototype.supertype=_2.prototype;
+};
+function Sarissa(){
+}
+Sarissa.PARSED_OK=&quot;Document contains no parsing errors&quot;;
+Sarissa.PARSED_EMPTY=&quot;Document is empty&quot;;
+Sarissa.PARSED_UNKNOWN_ERROR=&quot;Not well-formed or other error&quot;;
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM=&quot;&quot;;
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&amp;&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&amp;&amp;document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&amp;&amp;document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&amp;&amp;_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&amp;&amp;navigator.vendor&amp;&amp;(navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;)!=-1||navigator.vendor.indexOf(&quot;Apple&quot;)!=-1));
+var _SARISSA_IS_IE=document.all&amp;&amp;window.ActiveXObject&amp;&amp;navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;)&gt;-1&amp;&amp;navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;)==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument==&quot;undefined&quot;&amp;&amp;typeof Document!=&quot;undefined&quot;){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM=&quot;xsl:&quot;;
+var _SARISSA_DOM_PROGID=&quot;&quot;;
+var _SARISSA_XMLHTTP_PROGID=&quot;&quot;;
+var _SARISSA_DOM_XMLWRITER=&quot;&quot;;
+Sarissa.pickRecentProgID=function(_4){
+var _5=false;
+for(var i=0;i&lt;_4.length&amp;&amp;!_5;i++){
+try{
+var _7=new ActiveXObject(_4[i]);
+o2Store=_4[i];
+_5=true;
+}
+catch(objException){
+}
+}
+if(!_5){
+throw &quot;Could not retreive a valid progID of Class: &quot;+_4[_4.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
+}
+_4=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.XMLHTTP.6.0&quot;,&quot;MSXML2.XMLHTTP.3.0&quot;,&quot;MSXML2.XMLHTTP&quot;,&quot;Microsoft.XMLHTTP&quot;]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_8,_9){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.DOMDocument.6.0&quot;,&quot;Msxml2.DOMDocument.3.0&quot;,&quot;MSXML2.DOMDocument&quot;,&quot;MSXML.DOMDocument&quot;,&quot;Microsoft.XMLDOM&quot;]);
+}
+var _a=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_9){
+var _b=&quot;&quot;;
+if(_8){
+if(_9.indexOf(&quot;:&quot;)&gt;1){
+_b=_9.substring(0,_9.indexOf(&quot;:&quot;));
+_9=_9.substring(_9.indexOf(&quot;:&quot;)+1);
+}else{
+_b=&quot;a&quot;+(_sarissa_iNsCounter++);
+}
+}
+if(_8){
+_a.loadXML(&quot;&lt;&quot;+_b+&quot;:&quot;+_9+&quot; xmlns:&quot;+_b+&quot;=\&quot;&quot;+_8+&quot;\&quot;&quot;+&quot; /&gt;&quot;);
+}else{
+_a.loadXML(&quot;&lt;&quot;+_9+&quot; /&gt;&quot;);
+}
+}
+return _a;
+};
+Sarissa.getParseErrorText=function(_c){
+var _d=Sarissa.PARSED_OK;
+if(_c.parseError.errorCode!=0){
+_d=&quot;XML Parsing Error: &quot;+_c.parseError.reason+&quot;\nLocation: &quot;+_c.parseError.url+&quot;\nLine Number &quot;+_c.parseError.line+&quot;, Column &quot;+_c.parseError.linepos+&quot;:\n&quot;+_c.parseError.srcText+&quot;\n&quot;;
+for(var i=0;i&lt;_c.parseError.linepos;i++){
+_d+=&quot;-&quot;;
+}
+_d+=&quot;^\n&quot;;
+}else{
+if(_c.documentElement==null){
+_d=Sarissa.PARSED_EMPTY;
+}
+}
+return _d;
+};
+Sarissa.setXpathNamespaces=function(_f,_10){
+_f.setProperty(&quot;SelectionLanguage&quot;,&quot;XPath&quot;);
+_f.setProperty(&quot;SelectionNamespaces&quot;,_10);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.XSLTemplate.6.0&quot;,&quot;MSXML2.XSLTemplate.3.0&quot;]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_11){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID([&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;,&quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
+}
+_11.setProperty(&quot;SelectionLanguage&quot;,&quot;XPath&quot;);
+_11.setProperty(&quot;SelectionNamespaces&quot;,&quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+var _12=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_11.url&amp;&amp;_11.selectSingleNode(&quot;//xsl:*[local-name() = 'import' or local-name() = 'include']&quot;)!=null){
+_12.async=false;
+if(_SARISSA_THREADEDDOM_PROGID==&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;){
+_12.setProperty(&quot;AllowDocumentFunction&quot;,true);
+_12.resolveExternals=true;
+}
+_12.load(_11.url);
+}else{
+_12.loadXML(_11.xml);
+}
+_12.setProperty(&quot;SelectionNamespaces&quot;,&quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+var _13=_12.selectSingleNode(&quot;//xsl:output&quot;);
+this.outputMethod=_13?_13.getAttribute(&quot;method&quot;):&quot;html&quot;;
+this.template.stylesheet=_12;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_14){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_15;
+this.processor.transform();
+return _15;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID([&quot;Msxml2.MXXMLWriter.6.0&quot;,&quot;Msxml2.MXXMLWriter.3.0&quot;,&quot;MSXML2.MXXMLWriter&quot;,&quot;MSXML.MXXMLWriter&quot;,&quot;Microsoft.XMLDOM&quot;]);
+}
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_15;
+this.processor.transform();
+var _16=new ActiveXObject(_SARISSA_DOM_PROGID);
+_16.loadXML(_15.output+&quot;&quot;);
+return _16;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_17,_18){
+this.processor.input=_17;
+this.processor.transform();
+var s=this.processor.output;
+var f=_18.createDocumentFragment();
+if(this.outputMethod==&quot;text&quot;){
+f.appendChild(_18.createTextNode(s));
+}else{
+if(_18.body&amp;&amp;_18.body.innerHTML){
+var _1b=_18.createElement(&quot;div&quot;);
+_1b.innerHTML=s;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}else{
+var _1c=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)==&quot;&lt;?xml&quot;){
+s=s.substring(s.indexOf(&quot;?&gt;&quot;)+2);
+}
+var xml=&quot;&quot;.concat(&quot;&lt;my&gt;&quot;,s,&quot;&lt;/my&gt;&quot;);
+_1c.loadXML(xml);
+var _1b=_1c.documentElement;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1e,_1f,_20){
+if(_1e){
+this.processor.addParameter(_1f,_20,_1e);
+}else{
+this.processor.addParameter(_1f,_20);
+}
+if(!this.paramsSet[&quot;&quot;+_1e]){
+this.paramsSet[&quot;&quot;+_1e]=new Array();
+}
+this.paramsSet[&quot;&quot;+_1e][_1f]=_20;
+};
+XSLTProcessor.prototype.getParameter=function(_21,_22){
+_21=_21||&quot;&quot;;
+if(this.paramsSet[_21]&amp;&amp;this.paramsSet[_21][_22]){
+return this.paramsSet[_21][_22];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _23 in this.paramsSet){
+for(var _24 in this.paramsSet[_23]){
+if(_23){
+this.processor.addParameter(_24,null,_23);
+}else{
+this.processor.addParameter(_24,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_25){
+Sarissa.__setReadyState__(_25,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_26,_27){
+_26.readyState=_27;
+_26.readystate=_27;
+if(_26.onreadystatechange!=null&amp;&amp;typeof _26.onreadystatechange==&quot;function&quot;){
+_26.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+if(!_2a.onreadystatechange){
+_2a.onreadystatechange=null;
+}
+if(!_2a.readyState){
+_2a.readyState=0;
+}
+_2a.addEventListener(&quot;load&quot;,_sarissa_XMLDocument_onload,false);
+return _2a;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&amp;&amp;window.Document&amp;&amp;!Document.prototype.load&amp;&amp;document.implementation.hasFeature(&quot;LS&quot;,&quot;3.0&quot;)){
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+return _2d;
+};
+}else{
+Sarissa.getDomDocument=function(_2e,_2f){
+var _30=document.implementation.createDocument(_2e?_2e:null,_2f?_2f:null,null);
+if(_30&amp;&amp;(_2e||_2f)&amp;&amp;!_30.documentElement){
+_30.appendChild(_30.createElementNS(_2e,_2f));
+}
+return _30;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var _33=new XMLHttpRequest();
+_33.open(&quot;GET&quot;,&quot;data:text/xml;charset=utf-8,&quot;+encodeURIComponent(_31),false);
+_33.send(null);
+return _33.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&amp;&amp;Sarissa.getDomDocument()&amp;&amp;Sarissa.getDomDocument(null,&quot;bar&quot;).xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_34,_35){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_34);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)==&quot;undefined&quot;)&amp;&amp;_SARISSA_IS_IE){
+try{
+document.importNode=function(_37,_38){
+var tmp;
+if(_37.nodeName==&quot;tbody&quot;||_37.nodeName==&quot;tr&quot;){
+tmp=document.createElement(&quot;table&quot;);
+}else{
+if(_37.nodeName==&quot;td&quot;){
+tmp=document.createElement(&quot;tr&quot;);
+}else{
+if(_37.nodeName==&quot;option&quot;){
+tmp=document.createElement(&quot;select&quot;);
+}else{
+tmp=document.createElement(&quot;div&quot;);
+}
+}
+}
+if(_38){
+tmp.innerHTML=_37.xml?_37.xml:_37.outerHTML;
+}else{
+tmp.innerHTML=_37.xml?_37.cloneNode(false).xml:_37.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName(&quot;*&quot;)[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_3a){
+var _3b=Sarissa.PARSED_OK;
+if(!_3a.documentElement){
+_3b=Sarissa.PARSED_EMPTY;
+}else{
+if(_3a.documentElement.tagName==&quot;parsererror&quot;){
+_3b=_3a.documentElement.firstChild.data;
+_3b+=&quot;\n&quot;+_3a.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_3a.getElementsByTagName(&quot;parsererror&quot;).length&gt;0){
+var _3c=_3a.getElementsByTagName(&quot;parsererror&quot;)[0];
+_3b=Sarissa.getText(_3c,true)+&quot;\n&quot;;
+}else{
+if(_3a.parseError&amp;&amp;_3a.parseError.errorCode!=0){
+_3b=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _3b;
+};
+}
+Sarissa.getText=function(_3d,_3e){
+var s=&quot;&quot;;
+var _40=_3d.childNodes;
+for(var i=0;i&lt;_40.length;i++){
+var _42=_40[i];
+var _43=_42.nodeType;
+if(_43==Node.TEXT_NODE||_43==Node.CDATA_SECTION_NODE){
+s+=_42.data;
+}else{
+if(_3e==true&amp;&amp;(_43==Node.ELEMENT_NODE||_43==Node.DOCUMENT_NODE||_43==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_42,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&amp;&amp;Sarissa.getDomDocument&amp;&amp;Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;,null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_44){
+return _44.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
+};
+Sarissa.clearChildNodes=function(_46){
+while(_46.firstChild){
+_46.removeChild(_46.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_47,_48,_49){
+if((!_47)||(!_48)){
+throw &quot;Both source and destination nodes must be provided&quot;;
+}
+if(!_49){
+Sarissa.clearChildNodes(_48);
+}
+var _4a=_48.nodeType==Node.DOCUMENT_NODE?_48:_48.ownerDocument;
+var _4b=_47.childNodes;
+if(typeof (_4a.importNode)!=&quot;undefined&quot;){
+for(var i=0;i&lt;_4b.length;i++){
+_48.appendChild(_4a.importNode(_4b[i],true));
+}
+}else{
+for(var i=0;i&lt;_4b.length;i++){
+_48.appendChild(_4b[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4d,_4e,_4f){
+if((!_4d)||(!_4e)){
+throw &quot;Both source and destination nodes must be provided&quot;;
+}
+if(!_4f){
+Sarissa.clearChildNodes(_4e);
+}
+var _50=_4d.childNodes;
+if(_4d.ownerDocument==_4e.ownerDocument){
+while(_4d.firstChild){
+_4e.appendChild(_4d.firstChild);
+}
+}else{
+var _51=_4e.nodeType==Node.DOCUMENT_NODE?_4e:_4e.ownerDocument;
+if(typeof (_51.importNode)!=&quot;undefined&quot;){
+for(var i=0;i&lt;_50.length;i++){
+_4e.appendChild(_51.importNode(_50[i],true));
+}
+}else{
+for(var i=0;i&lt;_50.length;i++){
+_4e.appendChild(_50[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4d);
+}
+};
+Sarissa.xmlize=function(_53,_54,_55){
+_55=_55?_55:&quot;&quot;;
+var s=_55+&quot;&lt;&quot;+_54+&quot;&gt;&quot;;
+var _57=false;
+if(!(_53 instanceof Object)||_53 instanceof Number||_53 instanceof String||_53 instanceof Boolean||_53 instanceof Date){
+s+=Sarissa.escape(&quot;&quot;+_53);
+_57=true;
+}else{
+s+=&quot;\n&quot;;
+var _58=&quot;&quot;;
+var _59=_53 instanceof Array;
+for(var _5a in _53){
+s+=Sarissa.xmlize(_53[_5a],(_59?&quot;array-item key=\&quot;&quot;+_5a+&quot;\&quot;&quot;:_5a),_55+&quot;   &quot;);
+}
+s+=_55;
+}
+return s+=(_54.indexOf(&quot; &quot;)!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot;+_54+&quot;&gt;\n&quot;);
+};
+Sarissa.escape=function(_5b){
+return _5b.replace(/&amp;/g,&quot;&amp;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&gt;/g,&quot;&gt;&quot;).replace(/&quot;/g,&quot;&quot;&quot;).replace(/'/g,&quot;&apos;&quot;);
+};
+Sarissa.unescape=function(_5c){
+return _5c.replace(/&apos;/g,&quot;'&quot;).replace(/&quot;/g,&quot;\&quot;&quot;).replace(/&gt;/g,&quot;&gt;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&amp;/g,&quot;&amp;&quot;);
+};
+if(_SARISSA_HAS_DOM_FEATURE&amp;&amp;document.implementation.hasFeature(&quot;XPath&quot;,&quot;3.0&quot;)){
+function SarissaNodeList(i){
+this.length=i;
+}
+SarissaNodeList.prototype=new Array(0);
+SarissaNodeList.prototype.constructor=Array;
+SarissaNodeList.prototype.item=function(i){
+return (i&lt;0||i&gt;=this.length)?null:this[i];
+};
+SarissaNodeList.prototype.expr=&quot;&quot;;
+if(window.XMLDocument&amp;&amp;(!XMLDocument.prototype.setProperty)){
+XMLDocument.prototype.setProperty=function(x,y){
+};
+}
+Sarissa.setXpathNamespaces=function(_61,_62){
+_61._sarissa_useCustomResolver=true;
+var _63=_62.indexOf(&quot; &quot;)&gt;-1?_62.split(&quot; &quot;):new Array(_62);
+_61._sarissa_xpathNamespaces=new Array(_63.length);
+for(var i=0;i&lt;_63.length;i++){
+var ns=_63[i];
+var _66=ns.indexOf(&quot;:&quot;);
+var _67=ns.indexOf(&quot;=&quot;);
+if(_66&gt;0&amp;&amp;_67&gt;_66+1){
+var _68=ns.substring(_66+1,_67);
+var uri=ns.substring(_67+2,ns.length-1);
+_61._sarissa_xpathNamespaces[_68]=uri;
+}else{
+throw &quot;Bad format on namespace declaration(s) given&quot;;
+}
+}
+};
+XMLDocument.prototype._sarissa_useCustomResolver=false;
+XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
+XMLDocument.prototype.selectNodes=function(_6a,_6b,_6c){
+var _6d=this;
+var _6e=this._sarissa_useCustomResolver?function(_6f){
+var s=_6d._sarissa_xpathNamespaces[_6f];
+if(s){
+return s;
+}else{
+throw &quot;No namespace URI found for prefix: '&quot;+_6f+&quot;'&quot;;
+}
+}:this.createNSResolver(this.documentElement);
+var _71=null;
+if(!_6c){
+var _72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _73=new SarissaNodeList(_72.snapshotLength);
+_73.expr=_6a;
+for(var i=0;i&lt;_73.length;i++){
+_73[i]=_72.snapshotItem(i);
+}
+_71=_73;
+}else{
+_71=_72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+}
+return _71;
+};
+Element.prototype.selectNodes=function(_75){
+var doc=this.ownerDocument;
+if(doc.selectNodes){
+return doc.selectNodes(_75,this);
+}else{
+throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+}
+};
+XMLDocument.prototype.selectSingleNode=function(_77,_78){
+var ctx=_78?_78:null;
+return this.selectNodes(_77,ctx,true);
+};
+Element.prototype.selectSingleNode=function(_7a){
+var doc=this.ownerDocument;
+if(doc.selectSingleNode){
+return doc.selectSingleNode(_7a,this);
+}else{
+throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+}
+};
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(_SARISSA_IS_IE){
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(typeof (Freja)==&quot;undefined&quot;){
+Freja={};
+}
+Freja._aux={};
+Freja._aux.bind=function(_7c,_7d){
+if(typeof (_7c)==&quot;string&quot;){
+_7c=_7d[_7c];
+}
+var _7e=null;
+if(typeof (_7c.im_func)==&quot;function&quot;){
+_7e=_7c.im_func;
+}else{
+_7e=_7c;
+}
+_7c=function(){
+return _7c.im_func.apply(_7c.im_self,arguments);
+};
+_7c.im_func=_7e;
+_7c.im_self=_7d;
+return _7c;
+};
+Freja._aux.formContents=function(_7f){
+if(!_7f){
+_7f=document;
+}
+var _80=[];
+var _81=[];
+var _82=_7f.getElementsByTagName(&quot;INPUT&quot;);
+for(var i=0;i&lt;_82.length;++i){
+var _84=_82[i];
+if(_84.name){
+if(_84.type==&quot;radio&quot;||_84.type==&quot;checkbox&quot;){
+if(_84.checked){
+_80.push(_84.name);
+_81.push(_84.value);
+}else{
+_80.push(_84.name);
+_81.push(&quot;&quot;);
+}
+}else{
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+}
+var _85=_7f.getElementsByTagName(&quot;TEXTAREA&quot;);
+for(var i=0;i&lt;_85.length;++i){
+var _84=_85[i];
+if(_84.name){
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+var _86=_7f.getElementsByTagName(&quot;SELECT&quot;);
+for(var i=0;i&lt;_86.length;++i){
+var _84=_86[i];
+if(_84.name){
+if(_84.selectedIndex&gt;=0){
+var opt=_84.options[_84.selectedIndex];
+_80.push(_84.name);
+_81.push((opt.value)?opt.value:&quot;&quot;);
+}
+}
+}
+return [_80,_81];
+};
+Freja._aux.getElement=function(id){
+if(typeof (id)==&quot;object&quot;){
+return id;
+}else{
+return document.getElementById(id);
+}
+};
+Freja._aux.connect=function(src,_8a,fnc){
+if(!src){
+return;
+}
+if(src.addEventListener){
+var _8c=function(e){
+var evt={stop:function(){
+if(e.cancelable){
+e.preventDefault();
+}
+e.stopPropagation();
+}};
+fnc(evt);
+};
+src.addEventListener(_8a.replace(/^(on)/,&quot;&quot;),_8c,false);
+}else{
+if(src.attachEvent){
+var _8c=function(){
+var e=window.event;
+var evt={stop:function(){
+e.cancelBubble=true;
+e.returnValue=false;
+}};
+fnc(evt);
+};
+src.attachEvent(_8a,_8c);
+}
+}
+if(!src._signals){
+src._signals=[];
+}
+if(!src._signals[_8a]){
+src._signals[_8a]=[];
+}
+for(var _91=0;_91&lt;src._signals[_8a].length;_91++){
+if(src._signals[_8a][_91].toString()==fnc.toString()){
+return;
+}
+}
+src._signals[_8a].push(fnc);
+};
+Freja._aux.signal=function(src,_93){
+try{
+var _94=src._signals[_93];
+var _95=[];
+for(var i=2;i&lt;arguments.length;i++){
+_95.push(arguments[i]);
+}
+for(var i=0;i&lt;_94.length;i++){
+try{
+_94[i].apply(src,_95);
+}
+catch(e){
+}
+}
+}
+catch(e){
+}
+};
+Freja._aux.createDeferred=function(){
+return new Freja._aux.Deferred();
+};
+Freja._aux.openXMLHttpRequest=function(_97,url,_99,_9a,_9b){
+var req=new XMLHttpRequest();
+if(_9a&amp;&amp;_9b){
+req.open(_97,url,_99,_9a,_9b);
+}else{
+req.open(_97,url,_99);
+}
+if(_97==&quot;POST&quot;||_97==&quot;PUT&quot;){
+req.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);
+}
+req.setRequestHeader(&quot;X-Requested-With&quot;,&quot;XMLHttpRequest&quot;);
+return req;
+};
+Freja._aux.sendXMLHttpRequest=function(req,_9e){
+var d=Freja._aux.createDeferred();
+var _a0=false;
+req.onreadystatechange=function(){
+if(req.readyState==4&amp;&amp;!_a0){
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+d.callback(req);
+}else{
+d.errback(req);
+}
+_a0=true;
+}
+};
+if(!_9e){
+_9e=&quot;&quot;;
+}
+req.send(_9e);
+return d;
+};
+Freja._aux.xmlize=Sarissa.xmlize;
+Freja._aux.serializeXML=function(_a1){
+if(_a1.xml){
+return _a1.xml;
+}
+return (new XMLSerializer()).serializeToString(_a1);
+};
+Freja._aux.loadXML=function(_a2){
+return (new DOMParser()).parseFromString(_a2,&quot;text/xml&quot;);
+};
+Freja._aux.transformXSL=function(xml,xsl,_a5){
+var _a6=new XSLTProcessor();
+_a6.importStylesheet(xsl);
+if(_a5){
+for(var _a7 in _a5){
+_a6.setParameter(&quot;&quot;,_a7,_a5[_a7]);
+}
+}
+return _a6.transformToFragment(xml,window.document);
+};
+Freja._aux.cloneXMLDocument=function(_a8){
+var _a9=null;
+try{
+_a9=_a8.cloneNode(true);
+}
+catch(e){
+}
+if(!_a9){
+if(document.implementation&amp;&amp;document.implementation.createDocument){
+_a9=document.implementation.createDocument(&quot;&quot;,_a8.documentElement.nodeName,null);
+var _aa=_a9.importNode(_a8.documentElement.cloneNode(true),true);
+try{
+_a9.appendChild(_aa);
+}
+catch(e){
+var _ab=_a9.documentElement;
+for(var i=_aa.childNodes.length;i&gt;=0;i--){
+_ab.insertBefore(_aa.childNodes[i],_ab.firstChild);
+}
+for(var i=0;i&lt;_a8.documentElement.attributes.length;i++){
+var _ad=_a8.documentElement.attributes.item(i).name;
+var _ae=_a8.documentElement.attributes.item(i).value;
+_a9.documentElement.setAttribute(_ad,_ae);
+}
+}
+}
+}
+return _a9;
+};
+Freja._aux.hasSupportForXSLT=function(){
+return (typeof (XSLTProcessor)!=&quot;undefined&quot;);
+};
+Freja._aux.createQueryEngine=function(){
+if(Sarissa.IS_ENABLED_SELECT_NODES){
+return new Freja.QueryEngine.XPath();
+}else{
+return new Freja.QueryEngine.SimplePath();
+}
+};
+Freja._aux.Deferred=function(){
+this._good=[];
+this._bad=[];
+this._pending=null;
+};
+Freja._aux.Deferred.prototype.callback=function(){
+if(this._good.length==0){
+this._pending=[this.callback,arguments];
+return;
+}
+for(var i=0;i&lt;this._good.length;i++){
+this._good[i].apply(window,arguments);
+}
+this._good=[];
+};
+Freja._aux.Deferred.prototype.errback=function(){
+if(this._bad.length==0){
+this._pending=[this.errback,arguments];
+return;
+}
+for(var i=0;i&lt;this._bad.length;i++){
+this._bad[i].apply(window,arguments);
+}
+this._bad=[];
+};
+Freja._aux.Deferred.prototype.addCallbacks=function(_b1,_b2){
+if(_b1){
+this._good[this._good.length]=_b1;
+}
+if(_b2){
+this._bad[this._bad.length]=_b2;
+}
+if(this._pending){
+this._pending[0].apply(this,this._pending[1]);
+}
+};
+Freja._aux.Deferred.prototype.addCallback=function(_b3){
+this.addCallbacks(_b3);
+};
+Freja._aux.Deferred.prototype.addErrback=function(_b4){
+this.addCallbacks(null,_b4);
+};
+Freja.QueryEngine=function(){
+};
+Freja.QueryEngine.prototype.getElementById=function(_b5,id){
+var _b7=_b5.getElementsByTagName(&quot;*&quot;);
+for(var i=0;i&lt;_b7.length;i++){
+if(_b7[i].getAttribute(&quot;id&quot;)==id){
+return _b7[i];
+}
+}
+};
+Freja.QueryEngine.prototype.get=function(_b9,_ba){
+var _bb=this._find(_b9,_ba);
+if(!_bb){
+throw new Error(&quot;Can't evaluate expression &quot;+_ba);
+}
+switch(_bb.nodeType){
+case 1:
+if(_bb.firstChild&amp;&amp;(_bb.firstChild.nodeType==3||_bb.firstChild.nodeType==4)){
+return _bb.firstChild.nodeValue;
+}
+break;
+case 2:
+return _bb.nodeValue;
+break;
+case 3:
+case 4:
+return _bb.nodeValue;
+break;
+}
+return null;
+};
+Freja.QueryEngine.prototype.set=function(_bc,_bd,_be){
+var _bf=this._find(_bc,_bd);
+if(!_bf){
+var _c0=_bd.substr(_bd.lastIndexOf(&quot;/&quot;)+1);
+if(_c0.charAt(0)==&quot;@&quot;){
+var _c1=_bd.substring(0,_bd.lastIndexOf(&quot;/&quot;));
+var _c2=this._find(_bc,_c1);
+if(_c2){
+_c2.setAttribute(_c0.substr(1),_be);
+return;
+}
+}
+throw new Error(&quot;Can't evaluate expression &quot;+_bd);
+}
+switch(_bf.nodeType){
+case 1:
+if(_bf.firstChild&amp;&amp;(_bf.firstChild.nodeType==3||_bf.firstChild.nodeType==4)){
+_bf.firstChild.nodeValue=_be;
+}else{
+if(_be!=&quot;&quot;){
+_bf.appendChild(_bc.createTextNode(_be));
+}
+}
+break;
+case 2:
+_bf.nodeValue=_be;
+break;
+case 3:
+case 4:
+_bf.nodeValue=_be;
+break;
+}
+return;
+};
+Freja.QueryEngine.XPath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find=function(_c3,_c4){
+var _c5=_c3.selectSingleNode(_c4);
+return _c5;
+};
+Freja.QueryEngine.SimplePath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find=function(_c6,_c7){
+if(!_c7.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error(&quot;Can't evaluate expression &quot;+_c7);
+}
+var _c8=_c7.split(&quot;/&quot;);
+var _c9=_c6;
+var _ca=new RegExp(&quot;^@([\\d\\w]*)&quot;);
+var _cb=new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
+var _cc=new RegExp(&quot;^([\\d\\w]+)\\[@([@\\d\\w]+)=['\&quot;]{1}(.*)['\&quot;]{1}\\]$&quot;);
+var _cd=null;
+var _ce=0;
+for(var i=0;i&lt;_c8.length;++i){
+var _d0=_c8[i];
+var _d1=_cc.exec(_d0);
+if(_d1){
+if(i&gt;0&amp;&amp;_c8[i-1]==&quot;&quot;){
+var cn=_c9.getElementsByTagName(_d1[1]);
+}else{
+var cn=_c9.childNodes;
+}
+for(var j=0,l=cn.length;j&lt;l;j++){
+if(cn[j].nodeType==1&amp;&amp;cn[j].tagName==_d1[1]&amp;&amp;cn[j].getAttribute(_d1[2])==_d1[3]){
+_c9=cn[j];
+break;
+}
+}
+if(j==l){
+throw new Error(&quot;Can't evaluate expression &quot;+_d0);
+}
+}else{
+_ce=_cb.exec(_d0);
+if(_ce){
+_d0=_ce[1];
+_ce=_ce[2]-1;
+}else{
+_ce=0;
+}
+if(_d0!=&quot;&quot;){
+_cd=_ca.exec(_d0);
+if(_cd){
+_c9=_c9.getAttributeNode(_cd[1]);
+}else{
+_c9=_c9.getElementsByTagName(_d0).item(_ce);
+}
+}
+}
+}
+if(_c9&amp;&amp;_c9.firstChild&amp;&amp;_c9.firstChild.nodeType==3){
+return _c9.firstChild;
+}
+if(_c9&amp;&amp;_c9.firstChild&amp;&amp;_c9.firstChild.nodeType==4){
+return _c9.firstChild;
+}
+if(!_c9){
+throw new Error(&quot;Can't evaluate expression &quot;+_c7);
+}
+return _c9;
+};
+Freja.Model=function(url,_d5){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._query=_d5;
+};
+Freja.Model.prototype.getElementById=function(id){
+if(this.document){
+return this._query.getElementById(this.document,id);
+}
+return null;
+};
+Freja.Model.prototype.get=function(_d7){
+if(this.document){
+return this._query.get(this.document,_d7);
+}
+return null;
+};
+Freja.Model.prototype.set=function(_d8,_d9){
+if(this.document){
+return this._query.set(this.document,_d8,_d9);
+}
+return null;
+};
+Freja.Model.prototype.updateFrom=function(_da){
+var _db=_da.getValues();
+for(var i=0;i&lt;_db[0].length;++i){
+if(_db[0][i].lastIndexOf(&quot;/&quot;)!=-1){
+this.set(_db[0][i],_db[1][i]);
+}
+}
+};
+Freja.Model.prototype.save=function(){
+var url=this.url;
+var _de=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_de){
+url=_de[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;,url);
+try{
+Freja._aux.sendXMLHttpRequest(req,Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback,d),Freja._aux.bind(d.errback,d));
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.Model.prototype.remove=function(){
+var url=this.url;
+var _e2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_e2){
+url=_e2[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;,url);
+return Freja._aux.sendXMLHttpRequest(req);
+};
+Freja.Model.prototype.reload=function(){
+this.ready=false;
+var _e4=Freja._aux.bind(function(_e5){
+this.document=_e5;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},this);
+var d=Freja.AssetManager.loadAsset(this.url,true);
+d.addCallbacks(_e4,Freja.AssetManager.onerror);
+return d;
+};
+Freja.Model.DataSource=function(_e7,_e8){
+this.createURL=_e7;
+this.indexURL=_e8;
+};
+Freja.Model.DataSource.prototype.select=function(){
+return getModel(this.indexURL);
+};
+Freja.Model.DataSource.prototype.create=function(_e9){
+var url=this.createURL;
+var _eb=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_eb){
+url=_eb[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;,url);
+var _ed={};
+for(var i=0,len=_e9[0].length;i&lt;len;++i){
+_ed[_e9[0][i]]=_e9[1][i];
+}
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_ed,&quot;record&quot;));
+};
+Freja.View=function(url,_f0){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._renderer=_f0;
+this._destination=null;
+this.behaviors=[];
+this.placeholder=null;
+Freja._aux.connect(this,&quot;onrendercomplete&quot;,Freja._aux.bind(this._connectBehavior,this));
+};
+Freja.View.prototype.render=function(_f1,_f2,_f3){
+if(typeof (_f2)==&quot;undefined&quot;){
+_f2=this.placeholder;
+}
+if(typeof (_f3)==&quot;undefined&quot;){
+_f3=this.xslParameters;
+}
+var _f4=function(_f5,_f6,_f7,_f8){
+this.model=_f5;
+this.view=_f6;
+this.deferred=_f7;
+this.xslParameters=_f8;
+};
+_f4.prototype.trigger=function(){
+try{
+if(!this.view.ready){
+Freja._aux.connect(this.view,&quot;onload&quot;,Freja._aux.bind(this.trigger,this));
+return;
+}
+if(typeof (this.model)==&quot;object&quot;&amp;&amp;this.model instanceof Freja.Model&amp;&amp;!this.model.ready){
+Freja._aux.connect(this.model,&quot;onload&quot;,Freja._aux.bind(this.trigger,this));
+return;
+}
+var _f9;
+if(typeof (this.model)==&quot;undefined&quot;){
+_f9={document:Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
+}else{
+if(this.model instanceof Freja.Model){
+_f9=this.model;
+}else{
+_f9={document:Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot;+Freja._aux.xmlize(this.model,&quot;item&quot;))};
+}
+}
+var _fa=this.view._renderer.transform(_f9,this.view,this.xslParameters);
+_fa.addCallback(Freja._aux.bind(function(_fb){
+if(typeof _fb==&quot;string&quot;){
+this._destination.innerHTML=_fb;
+}else{
+this._destination.innerHTML=&quot;&quot;;
+this._destination.appendChild(_fb);
+}
+},this.view));
+_fa.addCallback(Freja._aux.bind(function(){
+Freja._aux.signal(this,&quot;onrendercomplete&quot;,this._destination);
+},this.view));
+_fa.addCallback(this.deferred.callback);
+_fa.addErrback(this.deferred.errback);
+}
+catch(ex){
+this.deferred.errback(ex);
+}
+};
+var d=Freja._aux.createDeferred();
+try{
+if(typeof (_f2)==&quot;object&quot;){
+this._destination=_f2;
+}else{
+this._destination=document.getElementById(_f2);
+}
+this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
+var h=new _f4(_f1,this,d,_f3);
+h.trigger();
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.prototype._connectBehavior=function(_fe){
+try{
+var _ff=function(node,_101,_102){
+Freja._aux.connect(node,_101,Freja._aux.bind(function(e){
+var _104=false;
+try{
+_104=_102(this);
+}
+catch(ex){
+throw new Error(&quot;An error ocurred in user handler.\n&quot;+ex.message);
+}
+finally{
+if(!_104){
+e.stop();
+}
+}
+},node));
+};
+var _105=function(node,_107){
+for(var i=0,c=node.childNodes,l=c.length;i&lt;l;++i){
+var _109=c[i];
+if(_109.nodeType==1){
+if(_109.className){
+var _10a=_109.className.split(&quot; &quot;);
+for(var j=0;j&lt;_10a.length;j++){
+var _10c=_107[_10a[j]];
+if(_10c){
+for(var _10d in _10c){
+if(_10d==&quot;init&quot;){
+_10c.init(_109);
+}else{
+_ff(_109,_10d,_10c[_10d]);
+}
+}
+}
+}
+}
+_105(_109,_107);
+}
+}
+};
+for(var ids in this.behaviors){
+_105(_fe,this.behaviors);
+break;
+}
+}
+catch(ex){
+alert(ex.message);
+}
+};
+Freja.View.prototype.getValues=function(){
+return Freja._aux.formContents(this._destination);
+};
+Freja.View.Renderer=function(){
+};
+Freja.View.Renderer.XSLTransformer=function(){
+};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_10f,view,_111){
+var d=Freja._aux.createDeferred();
+try{
+var html=Freja._aux.transformXSL(_10f.document,view.document,_111);
+if(!html){
+d.errback(new Error(&quot;XSL Transformation error.&quot;));
+}else{
+d.callback(html);
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.Renderer.RemoteXSLTransformer=function(url){
+this.url=url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_115,view,_117){
+var d=Freja._aux.createDeferred();
+var _119=view.url;
+var _11a=&quot;xslFile=&quot;+encodeURIComponent(_119)+&quot;&amp;xmlData=&quot;+encodeURIComponent(Freja._aux.serializeXML(_115.document));
+var _11b=&quot;&quot;;
+for(var _11c in _117){
+_11b+=encodeURIComponent(_11c+&quot;,&quot;+_117[_11c]);
+}
+if(_11b.length&gt;0){
+_11a=_11a+&quot;&amp;xslParam=&quot;+_11b;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;,Freja.AssetManager.XSLT_SERVICE_URL);
+req.onreadystatechange=function(){
+if(req.readyState==4){
+if(req.status==200){
+d.callback(req.responseText);
+}else{
+d.errback(req.responseText);
+}
+}
+};
+req.send(_11a);
+return d;
+};
+Freja.UndoHistory=function(){
+this.cache=[];
+this.maxLength=5;
+this._position=0;
+this._undoSteps=0;
+};
+Freja.UndoHistory.prototype.add=function(_11e){
+var _11f=this._position%this.maxLength;
+var _120=_11e.document;
+this.cache[_11f]={};
+this.cache[_11f].model=_11e;
+this.cache[_11f].document=Freja._aux.cloneXMLDocument(_120);
+if(!this.cache[_11f].document){
+throw new Error(&quot;Couldn't add to history.&quot;);
+}else{
+this._position++;
+var _121=_11f;
+while(this._undoSteps&gt;0){
+_121=(_121+1)%this.maxLength;
+this.cache[_121]={};
+this._undoSteps--;
+}
+return _11f;
+}
+};
+Freja.UndoHistory.prototype.undo=function(_122){
+if(this._undoSteps&lt;this.cache.length){
+this._undoSteps++;
+this._position--;
+if(this._position&lt;0){
+this._position=this.maxLength-1;
+}
+var _123=this.cache[this._position].model;
+if(this.cache[this._position].document){
+_123.document=this.cache[this._position].document;
+}else{
+throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
+}
+if(typeof (_122)!=&quot;undefined&quot;&amp;&amp;_122&gt;1){
+this.undo(_122-1);
+}
+}else{
+throw new Error(&quot;Nothing to undo&quot;);
+}
+};
+Freja.UndoHistory.prototype.redo=function(){
+if(this._undoSteps&gt;0){
+this._undoSteps--;
+this._position=(this._position+1)%this.maxLength;
+var _124=this.cache[this._position].model;
+_124.document=this.cache[this._position].document;
+}else{
+throw new Error(&quot;Nothing to redo&quot;);
+}
+};
+Freja.UndoHistory.prototype.removeLast=function(){
+this._position--;
+if(this._position&lt;0){
+this._position=this.maxLength-1;
+}
+this.cache[this._position]={};
+this._undoSteps=0;
+};
+Freja.AssetManager={models:[],views:[],_username:null,_password:null};
+Freja.AssetManager.HTTP_REQUEST_TYPE=&quot;async&quot;;
+Freja.AssetManager.HTTP_METHOD_TUNNEL=&quot;Http-Method-Equivalent&quot;;
+Freja.AssetManager.XSLT_SERVICE_URL=&quot;srvc-xslt.php&quot;;
+Freja.AssetManager.THROBBER_HTML=&quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
+Freja.AssetManager.createRenderer=function(){
+if(Freja._aux.hasSupportForXSLT()){
+return new Freja.View.Renderer.XSLTransformer();
+}else{
+return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+}
+};
+Freja.AssetManager.clearCache=function(){
+this.models=[];
+this.views=[];
+};
+Freja.AssetManager.getModel=function(url){
+for(var i=0;i&lt;this.models.length;i++){
+if(this.models[i].url==url){
+return this.models[i];
+}
+}
+var m=new Freja.Model(url,Freja._aux.createQueryEngine());
+var _128=Freja._aux.bind(function(_129){
+this.document=_129;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},m);
+this.loadAsset(url,true).addCallbacks(_128,Freja.AssetManager.onerror);
+this.models.push(m);
+return m;
+};
+Freja.AssetManager.getView=function(url){
+for(var i=0;i&lt;this.views.length;i++){
+if(this.views[i].url==url){
+return this.views[i];
+}
+}
+var v=new Freja.View(url,this.createRenderer());
+var _12d=Freja._aux.bind(function(_12e){
+this.document=_12e;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},v);
+this.loadAsset(url,false).addCallbacks(_12d,Freja.AssetManager.onerror);
+this.views.push(v);
+return v;
+};
+Freja.AssetManager.openXMLHttpRequest=function(_12f,url){
+var _131=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&amp;&amp;_12f!=&quot;GET&quot;&amp;&amp;_12f!=&quot;POST&quot;){
+_131=_12f;
+_12f=&quot;POST&quot;;
+}
+var req=Freja._aux.openXMLHttpRequest(_12f,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+if(_131){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_131);
+}
+return req;
+};
+Freja.AssetManager.setCredentials=function(_133,_134){
+this._username=_133;
+this._password=_134;
+};
+Freja.AssetManager.loadAsset=function(url,_136){
+var _137=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_137){
+url=_137[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var _139=function(_13a){
+try{
+if(_13a.responseText==&quot;&quot;){
+throw new Error(&quot;Empty response.&quot;);
+}
+if(_13a.responseXML.xml==&quot;&quot;){
+var _13b=Freja._aux.loadXML(_13a.responseText);
+}else{
+var _13b=_13a.responseXML;
+}
+}
+catch(ex){
+d.errback(ex);
+}
+if(window.document.all){
+setTimeout(function(){
+d.callback(_13b);
+},1);
+}else{
+d.callback(_13b);
+}
+};
+try{
+if(_136&amp;&amp;Freja.AssetManager.HTTP_METHOD_TUNNEL){
+var req=Freja._aux.openXMLHttpRequest(&quot;POST&quot;,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,&quot;GET&quot;);
+req.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);
+}else{
+var req=Freja._aux.openXMLHttpRequest(&quot;GET&quot;,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+}
+var comm=Freja._aux.sendXMLHttpRequest(req);
+if(Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;){
+comm.addCallbacks(_139,function(req){
+d.errback(new Error(&quot;Request failed:&quot;+req.status));
+});
+}else{
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+_139(req);
+}else{
+d.errback(new Error(&quot;Request failed:&quot;+req.status));
+}
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.AssetManager.onerror=function(ex){
+alert(&quot;Freja.AssetManager.onerror\n&quot;+ex.message);
+};
+window.getModel=Freja._aux.bind(&quot;getModel&quot;,Freja.AssetManager);
+window.getView=Freja._aux.bind(&quot;getView&quot;,Freja.AssetManager);
+

Added: trunk/lib/mochi+sarissa/Freja.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1229 @@
+/***
+
+    Freja 2.1
+
+    Build $Wed, 21 Mar 2007 15:06:18 UTC$
+
+    Target: mochi+sarissa
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    Copyright (c) 2006-2007 Cedric Savarese &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">cedric at veerwest.com</A>&gt;, Troels Knak-Nielsen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freja-svn">troelskn at gmail.com</A>&gt;
+    This software is licensed under the CC-GNU LGPL &lt;<A HREF="http://creativecommons.org/licenses/LGPL/2.1/">http://creativecommons.org/licenses/LGPL/2.1/</A>&gt;
+
+***/
+
+if (typeof(dojo) != &quot;undefined&quot;) {
+	dojo.provide(&quot;Freja&quot;);
+}
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja.NAME = &quot;Freja&quot;;
+Freja.VERSION = &quot;2.1&quot;;
+Freja.__repr__ = function () {
+	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
+};
+Freja.toString = function () {
+	return this.__repr__();
+};
+/**
+  * Single-hierarchy inheritance (class emulation)
+  * @see    <A HREF="http://www.itsalleasy.com/2006/02/05/prototype-chain/">http://www.itsalleasy.com/2006/02/05/prototype-chain/</A>
+  *         <A HREF="http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/">http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/</A>
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
+  */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
+  *
+  * You shouldn't rely on this functionality - it's merely a hook for Freja towards
+  * external dependencies. This is the only part of the application you'll need to
+  * adjust, to make Freja play ball with your favourite framework.
+  */
+if (typeof(dojo) != &quot;undefined&quot;) {
+	dojo.require(&quot;MochiKit.Base&quot;);
+	dojo.require(&quot;MochiKit.Signal&quot;);
+	dojo.require(&quot;MochiKit.Async&quot;);
+	dojo.require(&quot;Sarissa&quot;);
+}
+if (typeof(JSAN) != &quot;undefined&quot;) {
+	JSAN.use(&quot;MochiKit.Base&quot;, []);
+	JSAN.use(&quot;MochiKit.Signal&quot;, []);
+	JSAN.use(&quot;MochiKit.Async&quot;, []);
+	JSAN.use(&quot;Sarissa&quot;, []);
+}
+try {
+	if (typeof(MochiKit.Base) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(MochiKit.Signal) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(MochiKit.Async) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+	if (typeof(Sarissa) == &quot;undefined&quot;) {
+		throw &quot;&quot;;
+	}
+} catch (e) {
+	throw new Error(&quot;Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!&quot;);
+}
+if (typeof(Freja) == &quot;undefined&quot;) {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self) : function */
+Freja._aux.bind = MochiKit.Base.bind;
+/** formContents(elem) : Array */
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName(&quot;INPUT&quot;);
+	for (var i = 0; i &lt; inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == &quot;radio&quot; || input.type == &quot;checkbox&quot;) {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push(&quot;&quot;);
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName(&quot;TEXTAREA&quot;);
+	for (var i = 0; i &lt; textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName(&quot;SELECT&quot;);
+	for (var i = 0; i &lt; selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex &gt;= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : &quot;&quot;);
+			}
+		}
+	}
+	return [names, values];
+};
+
+/** getElement(id) : HTMLElement */
+Freja._aux.getElement = MochiKit.DOM.getElement;
+
+/** connect(src, signal, fnc) : void */
+Freja._aux.connect = MochiKit.Signal.connect;
+/** signal(src, signal, arg) : void */
+Freja._aux.signal = MochiKit.Signal.signal;
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new MochiKit.Async.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user &amp;&amp; pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
+		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = MochiKit.Async.sendXMLHttpRequest;
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter(&quot;&quot;, paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+	
+	// Can't clone a DocumentNode in Safari &amp; Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation &amp;&amp; document.implementation.createDocument) {
+			clone = document.implementation.createDocument(&quot;&quot;, xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {				
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+			
+				for (var i = data.childNodes.length-1; i &gt;= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				
+				// need to copy root node attributes
+				for (var i = 0; i &lt; xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}				
+			}
+		}
+	}
+	
+	return clone;
+};
+
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};
+
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ *
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)){
+    /**
+    * &lt;p&gt;SarissaNodeList behaves as a NodeList but is only used as a result to &lt;code&gt;selectNodes&lt;/code&gt;,
+    * so it also has some properties IEs proprietery object features.&lt;/p&gt;
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** &lt;p&gt;Set an Array as the prototype object&lt;/p&gt; */
+    SarissaNodeList.prototype = new Array(0);
+    /** &lt;p&gt;Inherit the Array constructor &lt;/p&gt; */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * &lt;p&gt;Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero &lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note&lt;/b&gt; that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling &lt;code&gt;item&lt;/code&gt;
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i &lt; 0 || i &gt;= this.length)?null:this[i];
+    };
+    /**
+    * &lt;p&gt;Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).&lt;/p&gt;
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = &quot;&quot;;
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument &amp;&amp; (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * &lt;p&gt;Programmatically control namespace URI/prefix mappings for XPath
+    * queries.&lt;/p&gt;
+    * &lt;p&gt;This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.&lt;/p&gt;
+    * &lt;p&gt;Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:&lt;/p&gt;
+    * &lt;pre&gt;Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;<A HREF="aposhttp://mynsURI&amp;amp;apos&amp;quot;">aposhttp://mynsURI&amp;apos&quot;</A>);&lt;/pre&gt;
+    * &lt;p&gt;&lt;b&gt;Note 1 &lt;/b&gt;: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.&lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note 2 &lt;/b&gt;: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.&lt;/p&gt;
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            &lt;code&gt;&quot;xmlns:xhtml=&apos;<A HREF="http://www.w3.org/1999/xhtml&amp;apos;">http://www.w3.org/1999/xhtml&apos;</A>
+    * xmlns:&apos;<A HREF="http://www.w3.org/1999/XSL/Transform&amp;apos;&amp;quot;&lt;/code">http://www.w3.org/1999/XSL/Transform&apos;&quot;&lt;/code</A>&gt;
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(&quot; &quot;)&gt;-1?sNsSet.split(&quot; &quot;):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i &lt; namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(&quot;:&quot;);
+            var assignPos = ns.indexOf(&quot;=&quot;);
+            if(colonPos &gt; 0 &amp;&amp; assignPos &gt; colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw &quot;Bad format on namespace declaration(s) given&quot;;
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectNodes.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw &quot;No namespace URI found for prefix: '&quot; + prefix+&quot;'&quot;;
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i&lt;nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectNodes&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
+  * The baseclass for queryengines
+  * @abstract
+  */
+Freja.QueryEngine = function() {};
+Freja.QueryEngine.prototype.getElementById = function(document, id) {
+	// getElementById doesn't work on XML document without xml:id
+	var allElements = document.getElementsByTagName(&quot;*&quot;);
+	for (var i= 0; i &lt; allElements.length; i++) {
+		if (allElements[i].getAttribute(&quot;id&quot;) == id) {
+			return allElements[i];
+		}
+	}
+};
+Freja.QueryEngine.prototype.get = function(document, expression) {
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error(&quot;Can't evaluate expression &quot; + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
+	}
+	return null;
+};
+Freja.QueryEngine.prototype.set = function(document, expression, value) {
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
+			}
+			// else parent node non existent either, give up.
+		}
+		// not an attribute, give up.
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!=&quot;&quot;) // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
+};
+/**
+  * XPath query engine.
+  */
+Freja.QueryEngine.XPath = function() {};
+Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
+};
+/**
+  * SimplePath
+  */
+Freja.QueryEngine.SimplePath = function() {};
+Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
+	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	var parts = expression.split(&quot;/&quot;);
+	var node = document;
+	var regAttr = new RegExp(&quot;^@([\\d\\w]*)&quot;);
+	var regOffset = new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
+	var regFilter = new RegExp(&quot;^([\\d\\w]+)\\[@([@\\d\\w]+)=['\&quot;]{1}(.*)['\&quot;]{1}\\]$&quot;);
+	var attr = null;
+	var offset = 0;
+	for (var i = 0; i &lt; parts.length; ++i) {
+		var part = parts[i];
+		var filter = regFilter.exec(part);
+		if(filter) {
+			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
+			if(i&gt;0 &amp;&amp; parts[i-1]=='') {
+				// expression was of type //element[...]
+				var cn = node.getElementsByTagName(filter[1]);
+			} else {
+				var cn = node.childNodes;
+			}
+			for(var j=0, l=cn.length; j&lt;l ; j++) {
+				if(cn[j].nodeType==1 &amp;&amp; cn[j].tagName==filter[1] &amp;&amp; cn[j].getAttribute(filter[2])== filter[3]) {
+					node = cn[j];
+					break;
+				}
+			}
+			if (j==l)
+				throw new Error(&quot;Can't evaluate expression &quot; + part);
+		}
+		else {
+			offset = regOffset.exec(part);
+			if (offset) {
+				part = offset[1];
+				offset = offset[2] - 1;
+			} else {
+				offset = 0;
+			}
+			if (part != &quot;&quot;) {
+				attr = regAttr.exec(part);
+				if (attr) {
+					node = node.getAttributeNode(attr[1]);
+				} else {
+					node = node.getElementsByTagName(part).item(offset);
+				}
+			}
+		}
+	}
+	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	}
+	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+
+	if (!node) {
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
+	}
+	return node;
+};
+/**
+  * Standard model component
+  */
+Freja.Model = function(url, query) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._query = query;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.getElementById = function(id) {
+	if (this.document) {
+		return this._query.getElementById(this.document, id);
+	}
+	return null;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.get = function(expression) {
+	if (this.document) {
+		return this._query.get(this.document, expression);
+	}
+	return null;
+};
+/**
+  * Updates a value
+  */
+Freja.Model.prototype.set = function(expression, value) {
+	if (this.document) {
+		return this._query.set(this.document, expression, value);
+	}
+	return null;
+};
+/**
+  * Updates the model from a view
+  */
+Freja.Model.prototype.updateFrom = function(view) {
+	var values = view.getValues();
+	for (var i = 0; i &lt; values[0].length; ++i) {
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
+	}
+};
+/**
+  * Writes the model back to the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.save = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	// since the serialization may fail, we create a deferred for the
+	// purpose, rather than just returning the sendXMLHttpRequest directly.
+	var d = Freja._aux.createDeferred();
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, url);
+	try {
+		// for some obscure reason exceptions aren't thrown back if I call the
+		// shorthand version of sendXMLHttpRequest in IE6.
+		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Deletes the model from the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.remove = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;, url);
+	return Freja._aux.sendXMLHttpRequest(req);
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.reload = function() {
+	this.ready = false;
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, this);
+	var d = Freja.AssetManager.loadAsset(this.url, true);
+	d.addCallbacks(onload, Freja.AssetManager.onerror);
+	return d;
+};
+/**
+  * DataSource provides a gateway-type interface to a REST service.
+  */
+Freja.Model.DataSource = function(createURL, indexURL) {
+	this.createURL = createURL;
+	this.indexURL = indexURL;
+};
+/**
+  * Returns a list of primary-keys to records in the datasource
+  */
+Freja.Model.DataSource.prototype.select = function() {
+	return getModel(this.indexURL);
+};
+/**
+  * Creates a new instance of a record
+  * @todo errback to the deferred on errors
+  */
+Freja.Model.DataSource.prototype.create = function(values) {
+	var url = this.createURL;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;, url);
+	var payload = {};
+	for (var i = 0, len = values[0].length; i &lt; len; ++i) {
+		payload[values[0][i]] = values[1][i];
+	}
+	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
+};
+
+/**
+  * Standard view component
+  */
+Freja.View = function(url, renderer) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._renderer = renderer;
+	this._destination = null;
+	this.behaviors = [];
+	this.placeholder = null;
+	Freja._aux.connect(this, &quot;onrendercomplete&quot;, Freja._aux.bind(this._connectBehavior, this));
+};
+/**
+  * @param    model            Freja.Model
+  * @param    placeholder      string    If supplied, this will be used instead of the
+  *                                      default placeholder.
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.prototype.render = function(model, placeholder, xslParameters) {
+	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
+	if (typeof(xslParameters) == &quot;undefined&quot;) xslParameters = this.xslParameters;
+
+	var Handler = function(model, view, deferred, xslParameters) {
+		this.model = model;
+		this.view = view;
+		this.deferred = deferred;
+		this.xslParameters = xslParameters;
+	};
+	Handler.prototype.trigger = function() {
+		try {
+			if (!this.view.ready) {
+				Freja._aux.connect(this.view, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			if (typeof(this.model) == &quot;object&quot; &amp;&amp; this.model instanceof Freja.Model &amp;&amp; !this.model.ready) {
+				Freja._aux.connect(this.model, &quot;onload&quot;, Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			var model;
+			if (typeof(this.model) == &quot;undefined&quot;) {
+				// supply dummy
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
+			} else if (this.model instanceof Freja.Model) {
+				model = this.model;
+			} else {
+				// wrap pojo's in
+				model = { document : Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot; + Freja._aux.xmlize(this.model, &quot;item&quot;)) };
+			}
+
+			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
+			trans.addCallback(Freja._aux.bind(function(html) {
+				if(typeof html == &quot;string&quot;) {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = &quot;&quot;;   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
+			}, this.view));
+			trans.addCallback(Freja._aux.bind(function() {
+				Freja._aux.signal(this, &quot;onrendercomplete&quot;, this._destination)
+			}, this.view));
+			trans.addCallback(this.deferred.callback);
+			trans.addErrback(this.deferred.errback);
+		} catch (ex) {
+			this.deferred.errback(ex);
+		}
+	};
+
+	var d = Freja._aux.createDeferred();
+	try {
+		if (typeof(placeholder) == &quot;object&quot;) {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
+		// @todo    Is this a good idea ?
+		// Perhaps we should leave it to the programmer to do this.
+		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
+
+		var h = new Handler(model, this, d, xslParameters);
+		h.trigger();
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Decorates the output of the primary renderer, to inject behavior.
+  * @note Maybe we could use cssQuery (<A HREF="http://dean.edwards.name/my/cssQuery/">http://dean.edwards.name/my/cssQuery/</A>)
+  *       to identify targets for behavior
+  */
+Freja.View.prototype._connectBehavior = function(destination) {
+	try {
+		var connectCallback = function(node, eventType, callback) {
+
+			Freja._aux.connect(node, eventType, Freja._aux.bind(
+				function(e) {
+					var allow = false;
+					try {
+						allow = callback(this);
+					} catch (ex) {
+						throw new Error(&quot;An error ocurred in user handler.\n&quot; + ex.message);
+					} finally {
+						if (!allow) {
+							e.stop();
+						}
+					}
+				}, node)
+			);
+		};
+		var applyHandlers = function(node, behaviors) {
+			for (var i = 0, c = node.childNodes, l = c.length; i &lt; l; ++i) {
+				var child = c[i];
+				if (child.nodeType == 1) {
+					if(child.className) {
+						var classNames = child.className.split(' ');
+						for (var j=0;j&lt;classNames.length;j++) {
+							var handler = behaviors[classNames[j]];
+							if (handler) {
+								for (var eventType in handler) {
+									if (eventType == &quot;init&quot;) {
+										handler.init(child);
+									} else {
+										connectCallback(child, eventType, handler[eventType]);
+									}
+								}
+							}
+						}
+					}
+					applyHandlers(child, behaviors);
+				}
+			}
+		};
+
+		// Avoid traversing the DOM tree if there's no handler to process.
+		// @note: is there a better way? this.behaviors.length is always 0.
+		// @note  This is fine. behaviors is a hashmap, not an array.
+		for (var ids in this.behaviors) {
+			applyHandlers(destination, this.behaviors);
+			break;
+		}
+
+	} catch (ex) {
+		alert(ex.message);
+	}
+};
+/**
+  * Returns the values of a formview
+  */
+Freja.View.prototype.getValues = function() {
+	return Freja._aux.formContents(this._destination);
+};
+/**
+  * Base object for viewrenderers
+  */
+Freja.View.Renderer = function() {};
+/**
+  * XSLT based render-engine
+  */
+Freja.View.Renderer.XSLTransformer = function() {};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+        try {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
+			d.errback(new Error(&quot;XSL Transformation error.&quot;));
+		} else {
+			d.callback(html);
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * XSLT on a remote service for browser which have no native support.
+  * @param    url    URL of the transform service
+  */
+Freja.View.Renderer.RemoteXSLTransformer = function(url) {
+	this.url = url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+
+	// prepare posted data  (no need to send the XSL document, just its url)
+	var xslUrl = view.url;
+	var postedData = &quot;xslFile=&quot; + encodeURIComponent(xslUrl) + &quot;&amp;xmlData=&quot; + encodeURIComponent(Freja._aux.serializeXML(model.document));
+
+	var xslParameterString = '';
+	for (var paramname in xslParameters) {
+		xslParameterString += encodeURIComponent(paramname + &quot;,&quot; + xslParameters[paramname]);
+	}
+	if(xslParameterString.length &gt; 0) {
+		postedData  = postedData + '&amp;xslParam=' + xslParameterString;
+	}
+
+	// send request to the server-side XSL transformation service
+	var req = Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;, Freja.AssetManager.XSLT_SERVICE_URL);
+	req.onreadystatechange = function() {
+		if (req.readyState == 4) {
+			if (req.status == 200) {
+				d.callback(req.responseText);
+			} else {
+				d.errback(req.responseText);
+			}
+		}
+	}
+	req.send(postedData);
+	return d;
+};
+/**
+  * This is largely s copied with minor stylistic adjustments from Freja 1.1
+  * I renamed it from Controller.history to distinguish between window.history
+  */
+Freja.UndoHistory = function() {
+	this.cache = [];
+	this.maxLength = 5;
+	this._position = 0;
+	this._undoSteps = 0;
+};
+/**
+  * Creates a snapshot of the model and stores it.
+  */
+Freja.UndoHistory.prototype.add = function(model) {
+	var historyIndex = this._position % this.maxLength;
+
+	var modelDoc = model.document;
+	this.cache[historyIndex] = {};
+	this.cache[historyIndex].model = model;
+	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
+
+	if (!this.cache[historyIndex].document) {
+		throw new Error(&quot;Couldn't add to history.&quot;);
+	} else {
+		this._position++;
+		// clear rest of the history if undo was used.
+		var clearHistoryIndex = historyIndex;
+		while (this._undoSteps &gt; 0) {
+			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
+			this.cache[clearHistoryIndex] = {};
+			this._undoSteps--;
+		}
+		return historyIndex; // what would anybody need this for ?
+	}
+};
+/**
+  * Rolls the state back one step.
+  */
+Freja.UndoHistory.prototype.undo = function(steps) {
+	if (this._undoSteps &lt; this.cache.length) {
+		this._undoSteps++;
+		this._position--;
+		if (this._position &lt; 0) {
+			this._position = this.maxLength - 1;
+		}
+
+		var model = this.cache[this._position].model;
+		if (this.cache[this._position].document) {
+			model.document = this.cache[this._position].document;
+		} else {
+			throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
+		}
+		if (typeof(steps) != &quot;undefined&quot; &amp;&amp; steps &gt; 1) {
+			this.undo(steps - 1);
+		}
+	} else {
+		throw new Error(&quot;Nothing to undo&quot;);
+	}
+};
+/**
+  * Reverts the effects of undo.
+  */
+Freja.UndoHistory.prototype.redo = function() {
+	if (this._undoSteps &gt; 0) {
+		this._undoSteps--;
+		this._position = (this._position + 1) % this.maxLength;
+
+		var model = this.cache[this._position].model;
+		model.document = this.cache[this._position].document;
+	} else {
+		throw new Error(&quot;Nothing to redo&quot;);
+	}
+};
+/**
+  * Removes the last entry in the cache
+  */
+Freja.UndoHistory.prototype.removeLast = function() {
+	this._position--;
+
+	if (this._position &lt; 0) {
+		this._position = this.maxLength - 1;
+	}
+	this.cache[this._position] = {};
+	this._undoSteps = 0;
+};
+
+/**
+  * main repository
+  * @static
+  */
+Freja.AssetManager = {
+	models : [],
+	views : [],
+	_username : null,
+	_password : null
+};
+/**
+  * Set to sync to make all requests synchroneous. You shouldn't use
+  * this setting for anything but testing/debugging.
+  * &quot;async&quot; | &quot;sync&quot;
+  */
+Freja.AssetManager.HTTP_REQUEST_TYPE = &quot;async&quot;;
+/**
+  * If this is set to null, real PUT and DELETE http-requests will be made,
+  * otherwise a header will be set instead, and the request tunneled through
+  * POST.
+  *
+  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
+  * if theese are your target platform, you can disable tunneling.
+  */
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
+/**
+  * Set this url to provide remote xslt-transformation for browsers that
+  * doesn't support it natively.
+  */
+Freja.AssetManager.XSLT_SERVICE_URL = &quot;srvc-xslt.php&quot;;
+/**
+  * HTML displayed while waiting for stuff to happen
+  */
+Freja.AssetManager.THROBBER_HTML = &quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
+/**
+  * returns an instance of the renderengine to use
+  */
+Freja.AssetManager.createRenderer = function() {
+//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	if (Freja._aux.hasSupportForXSLT()) {
+		return new Freja.View.Renderer.XSLTransformer();
+	} else {
+		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	}
+};
+/**
+  * Wipes all caches. This isn't something you will normally use during production,
+  * but it's very helpful for debugging/testing
+  */
+Freja.AssetManager.clearCache = function() {
+	this.models = [];
+	this.views = [];
+};
+/**
+  * Load a model-component
+  * @param    url      string
+  */
+Freja.AssetManager.getModel = function(url) {
+	for (var i=0; i &lt; this.models.length; i++) {
+		if (this.models[i].url == url) {
+			return this.models[i];
+		}
+	}
+	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, m);
+	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.models.push(m);
+	return m;
+};
+/**
+  * Load a view-component
+  * @param    url      string
+  */
+Freja.AssetManager.getView = function(url) {
+	for (var i=0; i &lt; this.views.length; i++) {
+		if (this.views[i].url == url) {
+			return this.views[i];
+		}
+	}
+	var v = new Freja.View(url, this.createRenderer());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, &quot;onload&quot;);
+	}, v);
+	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.views.push(v);
+	return v;
+};
+/**
+  * Creates and opens a http-request, tunneling exotic methods if needed.
+  */
+Freja.AssetManager.openXMLHttpRequest = function(method, url) {
+	var tunnel = null;
+	if (Freja.AssetManager.HTTP_METHOD_TUNNEL &amp;&amp; method != &quot;GET&quot; &amp;&amp; method != &quot;POST&quot;) {
+		tunnel = method;
+		method = &quot;POST&quot;;
+	}
+	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+	if (tunnel) {
+		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
+	}
+	return req;
+};
+/**
+  * Sets username + password for Http-Authentication
+  */
+Freja.AssetManager.setCredentials = function(username, password) {
+	this._username = username;
+	this._password = password;
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.AssetManager.loadAsset = function(url, preventCaching) {
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var d = Freja._aux.createDeferred();
+	var handler = function(transport) {
+		try {
+			if (transport.responseText == &quot;&quot;) {
+				throw new Error(&quot;Empty response.&quot;);
+			}
+			if (transport.responseXML.xml == &quot;&quot;) {
+				// The server doesn't reply with Content-Type: text/xml
+				// this will happen if the file is loaded locally (through <A HREF="file://">file://</A>)
+				var document = Freja._aux.loadXML(transport.responseText);
+			} else {
+				var document = transport.responseXML;
+			}
+		} catch (ex) {
+			d.errback(ex);
+		}
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
+	};
+	try {
+		// Why using HTTP_METHOD_TUNNEL for a GET?
+		//-- to prevent caching, since browsers won't cache a POST
+		if (preventCaching &amp;&amp; Freja.AssetManager.HTTP_METHOD_TUNNEL) {
+			var req = Freja._aux.openXMLHttpRequest(&quot;POST&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, &quot;GET&quot;);
+			req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
+		} else {
+			var req = Freja._aux.openXMLHttpRequest(&quot;GET&quot;, url, Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;, Freja.AssetManager._username, Freja.AssetManager._password);
+		}
+
+		// This shouldn't be nescesary, but alas it is - firefox chokes
+		// It's probably due to an error in MochiKit, so the problem
+		// should be fixed there.
+		var comm = Freja._aux.sendXMLHttpRequest(req);
+		if (Freja.AssetManager.HTTP_REQUEST_TYPE == &quot;async&quot;) {
+			// fixes bug #7189 (<A HREF="http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189">http://developer.berlios.de/bugs/?func=detailbug&amp;group_id=6277&amp;bug_id=7189</A>)
+			comm.addCallbacks(handler, function(req) {
+				d.errback(new Error(&quot;Request failed:&quot; + req.status));
+			});
+		} else {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
+				handler(req);
+			} else {
+				d.errback(new Error(&quot;Request failed:&quot; + req.status));
+			}
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * This is a default error-handler. You should provide your own.
+  * The handler is called if an asynchronous error happens, since
+  * this could not be caught with the usual try ... catch
+  *
+  * It ought to be replaced completely with Deferred
+  */
+Freja.AssetManager.onerror = function(ex) {
+	alert(&quot;Freja.AssetManager.onerror\n&quot; + ex.message);
+};
+/**
+  * Global exports
+  */
+window.getModel = Freja._aux.bind(&quot;getModel&quot;, Freja.AssetManager);
+window.getView = Freja._aux.bind(&quot;getView&quot;, Freja.AssetManager);
\ No newline at end of file

Added: trunk/lib/mochi+sarissa/Freja_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,851 @@
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;Freja&quot;);
+}
+if(typeof (Freja)==&quot;undefined&quot;){
+Freja={};
+}
+Freja.NAME=&quot;Freja&quot;;
+Freja.VERSION=&quot;2.1&quot;;
+Freja.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+Freja.toString=function(){
+return this.__repr__();
+};
+Freja.Class={};
+Freja.Class.extend=function(_1,_2){
+var _3=function(){
+};
+_3.prototype=_2.prototype;
+_1.prototype=new _3();
+_1.prototype.constructor=_1;
+_1.prototype.superconstructor=_2;
+_1.prototype.supertype=_2.prototype;
+};
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.require(&quot;MochiKit.Base&quot;);
+dojo.require(&quot;MochiKit.Signal&quot;);
+dojo.require(&quot;MochiKit.Async&quot;);
+dojo.require(&quot;Sarissa&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+JSAN.use(&quot;MochiKit.Signal&quot;,[]);
+JSAN.use(&quot;MochiKit.Async&quot;,[]);
+JSAN.use(&quot;Sarissa&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+if(typeof (MochiKit.Signal)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+if(typeof (MochiKit.Async)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+if(typeof (Sarissa)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw new Error(&quot;Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!&quot;);
+}
+if(typeof (Freja)==&quot;undefined&quot;){
+Freja={};
+}
+Freja._aux={};
+Freja._aux.bind=MochiKit.Base.bind;
+Freja._aux.formContents=function(_4){
+if(!_4){
+_4=document;
+}
+var _5=[];
+var _6=[];
+var _7=_4.getElementsByTagName(&quot;INPUT&quot;);
+for(var i=0;i&lt;_7.length;++i){
+var _9=_7[i];
+if(_9.name){
+if(_9.type==&quot;radio&quot;||_9.type==&quot;checkbox&quot;){
+if(_9.checked){
+_5.push(_9.name);
+_6.push(_9.value);
+}else{
+_5.push(_9.name);
+_6.push(&quot;&quot;);
+}
+}else{
+_5.push(_9.name);
+_6.push(_9.value);
+}
+}
+}
+var _a=_4.getElementsByTagName(&quot;TEXTAREA&quot;);
+for(var i=0;i&lt;_a.length;++i){
+var _9=_a[i];
+if(_9.name){
+_5.push(_9.name);
+_6.push(_9.value);
+}
+}
+var _b=_4.getElementsByTagName(&quot;SELECT&quot;);
+for(var i=0;i&lt;_b.length;++i){
+var _9=_b[i];
+if(_9.name){
+if(_9.selectedIndex&gt;=0){
+var _c=_9.options[_9.selectedIndex];
+_5.push(_9.name);
+_6.push((_c.value)?_c.value:&quot;&quot;);
+}
+}
+}
+return [_5,_6];
+};
+Freja._aux.getElement=MochiKit.DOM.getElement;
+Freja._aux.connect=MochiKit.Signal.connect;
+Freja._aux.signal=MochiKit.Signal.signal;
+Freja._aux.createDeferred=function(){
+return new MochiKit.Async.Deferred();
+};
+Freja._aux.openXMLHttpRequest=function(_d,_e,_f,_10,_11){
+var req=new XMLHttpRequest();
+if(_10&amp;&amp;_11){
+req.open(_d,_e,_f,_10,_11);
+}else{
+req.open(_d,_e,_f);
+}
+if(_d==&quot;POST&quot;||_d==&quot;PUT&quot;){
+req.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);
+}
+req.setRequestHeader(&quot;X-Requested-With&quot;,&quot;XMLHttpRequest&quot;);
+return req;
+};
+Freja._aux.sendXMLHttpRequest=MochiKit.Async.sendXMLHttpRequest;
+Freja._aux.xmlize=Sarissa.xmlize;
+Freja._aux.serializeXML=function(_13){
+if(_13.xml){
+return _13.xml;
+}
+return (new XMLSerializer()).serializeToString(_13);
+};
+Freja._aux.loadXML=function(_14){
+return (new DOMParser()).parseFromString(_14,&quot;text/xml&quot;);
+};
+Freja._aux.transformXSL=function(xml,xsl,_17){
+var _18=new XSLTProcessor();
+_18.importStylesheet(xsl);
+if(_17){
+for(var _19 in _17){
+_18.setParameter(&quot;&quot;,_19,_17[_19]);
+}
+}
+return _18.transformToFragment(xml,window.document);
+};
+Freja._aux.cloneXMLDocument=function(_1a){
+var _1b=null;
+try{
+_1b=_1a.cloneNode(true);
+}
+catch(e){
+}
+if(!_1b){
+if(document.implementation&amp;&amp;document.implementation.createDocument){
+_1b=document.implementation.createDocument(&quot;&quot;,_1a.documentElement.nodeName,null);
+var _1c=_1b.importNode(_1a.documentElement.cloneNode(true),true);
+try{
+_1b.appendChild(_1c);
+}
+catch(e){
+var _1d=_1b.documentElement;
+for(var i=_1c.childNodes.length-1;i&gt;=0;i--){
+_1d.insertBefore(_1c.childNodes[i],_1d.firstChild);
+}
+for(var i=0;i&lt;_1a.documentElement.attributes.length;i++){
+var _1f=_1a.documentElement.attributes.item(i).name;
+var _20=_1a.documentElement.attributes.item(i).value;
+_1b.documentElement.setAttribute(_1f,_20);
+}
+}
+}
+}
+return _1b;
+};
+Freja._aux.hasSupportForXSLT=function(){
+return (typeof (XSLTProcessor)!=&quot;undefined&quot;);
+};
+Freja._aux.createQueryEngine=function(){
+if(Sarissa.IS_ENABLED_SELECT_NODES){
+return new Freja.QueryEngine.XPath();
+}else{
+return new Freja.QueryEngine.SimplePath();
+}
+};
+if(_SARISSA_HAS_DOM_FEATURE&amp;&amp;document.implementation.hasFeature(&quot;XPath&quot;,&quot;3.0&quot;)){
+function SarissaNodeList(i){
+this.length=i;
+}
+SarissaNodeList.prototype=new Array(0);
+SarissaNodeList.prototype.constructor=Array;
+SarissaNodeList.prototype.item=function(i){
+return (i&lt;0||i&gt;=this.length)?null:this[i];
+};
+SarissaNodeList.prototype.expr=&quot;&quot;;
+if(window.XMLDocument&amp;&amp;(!XMLDocument.prototype.setProperty)){
+XMLDocument.prototype.setProperty=function(x,y){
+};
+}
+Sarissa.setXpathNamespaces=function(_25,_26){
+_25._sarissa_useCustomResolver=true;
+var _27=_26.indexOf(&quot; &quot;)&gt;-1?_26.split(&quot; &quot;):new Array(_26);
+_25._sarissa_xpathNamespaces=new Array(_27.length);
+for(var i=0;i&lt;_27.length;i++){
+var ns=_27[i];
+var _2a=ns.indexOf(&quot;:&quot;);
+var _2b=ns.indexOf(&quot;=&quot;);
+if(_2a&gt;0&amp;&amp;_2b&gt;_2a+1){
+var _2c=ns.substring(_2a+1,_2b);
+var uri=ns.substring(_2b+2,ns.length-1);
+_25._sarissa_xpathNamespaces[_2c]=uri;
+}else{
+throw &quot;Bad format on namespace declaration(s) given&quot;;
+}
+}
+};
+XMLDocument.prototype._sarissa_useCustomResolver=false;
+XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
+XMLDocument.prototype.selectNodes=function(_2e,_2f,_30){
+var _31=this;
+var _32=this._sarissa_useCustomResolver?function(_33){
+var s=_31._sarissa_xpathNamespaces[_33];
+if(s){
+return s;
+}else{
+throw &quot;No namespace URI found for prefix: '&quot;+_33+&quot;'&quot;;
+}
+}:this.createNSResolver(this.documentElement);
+var _35=null;
+if(!_30){
+var _36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _37=new SarissaNodeList(_36.snapshotLength);
+_37.expr=_2e;
+for(var i=0;i&lt;_37.length;i++){
+_37[i]=_36.snapshotItem(i);
+}
+_35=_37;
+}else{
+_35=_36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+}
+return _35;
+};
+Element.prototype.selectNodes=function(_39){
+var doc=this.ownerDocument;
+if(doc.selectNodes){
+return doc.selectNodes(_39,this);
+}else{
+throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+}
+};
+XMLDocument.prototype.selectSingleNode=function(_3b,_3c){
+var ctx=_3c?_3c:null;
+return this.selectNodes(_3b,ctx,true);
+};
+Element.prototype.selectSingleNode=function(_3e){
+var doc=this.ownerDocument;
+if(doc.selectSingleNode){
+return doc.selectSingleNode(_3e,this);
+}else{
+throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+}
+};
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(_SARISSA_IS_IE){
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+Freja.QueryEngine=function(){
+};
+Freja.QueryEngine.prototype.getElementById=function(_40,id){
+var _42=_40.getElementsByTagName(&quot;*&quot;);
+for(var i=0;i&lt;_42.length;i++){
+if(_42[i].getAttribute(&quot;id&quot;)==id){
+return _42[i];
+}
+}
+};
+Freja.QueryEngine.prototype.get=function(_44,_45){
+var _46=this._find(_44,_45);
+if(!_46){
+throw new Error(&quot;Can't evaluate expression &quot;+_45);
+}
+switch(_46.nodeType){
+case 1:
+if(_46.firstChild&amp;&amp;(_46.firstChild.nodeType==3||_46.firstChild.nodeType==4)){
+return _46.firstChild.nodeValue;
+}
+break;
+case 2:
+return _46.nodeValue;
+break;
+case 3:
+case 4:
+return _46.nodeValue;
+break;
+}
+return null;
+};
+Freja.QueryEngine.prototype.set=function(_47,_48,_49){
+var _4a=this._find(_47,_48);
+if(!_4a){
+var _4b=_48.substr(_48.lastIndexOf(&quot;/&quot;)+1);
+if(_4b.charAt(0)==&quot;@&quot;){
+var _4c=_48.substring(0,_48.lastIndexOf(&quot;/&quot;));
+var _4d=this._find(_47,_4c);
+if(_4d){
+_4d.setAttribute(_4b.substr(1),_49);
+return;
+}
+}
+throw new Error(&quot;Can't evaluate expression &quot;+_48);
+}
+switch(_4a.nodeType){
+case 1:
+if(_4a.firstChild&amp;&amp;(_4a.firstChild.nodeType==3||_4a.firstChild.nodeType==4)){
+_4a.firstChild.nodeValue=_49;
+}else{
+if(_49!=&quot;&quot;){
+_4a.appendChild(_47.createTextNode(_49));
+}
+}
+break;
+case 2:
+_4a.nodeValue=_49;
+break;
+case 3:
+case 4:
+_4a.nodeValue=_49;
+break;
+}
+return;
+};
+Freja.QueryEngine.XPath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find=function(_4e,_4f){
+var _50=_4e.selectSingleNode(_4f);
+return _50;
+};
+Freja.QueryEngine.SimplePath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find=function(_51,_52){
+if(!_52.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error(&quot;Can't evaluate expression &quot;+_52);
+}
+var _53=_52.split(&quot;/&quot;);
+var _54=_51;
+var _55=new RegExp(&quot;^@([\\d\\w]*)&quot;);
+var _56=new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);
+var _57=new RegExp(&quot;^([\\d\\w]+)\\[@([@\\d\\w]+)=['\&quot;]{1}(.*)['\&quot;]{1}\\]$&quot;);
+var _58=null;
+var _59=0;
+for(var i=0;i&lt;_53.length;++i){
+var _5b=_53[i];
+var _5c=_57.exec(_5b);
+if(_5c){
+if(i&gt;0&amp;&amp;_53[i-1]==&quot;&quot;){
+var cn=_54.getElementsByTagName(_5c[1]);
+}else{
+var cn=_54.childNodes;
+}
+for(var j=0,l=cn.length;j&lt;l;j++){
+if(cn[j].nodeType==1&amp;&amp;cn[j].tagName==_5c[1]&amp;&amp;cn[j].getAttribute(_5c[2])==_5c[3]){
+_54=cn[j];
+break;
+}
+}
+if(j==l){
+throw new Error(&quot;Can't evaluate expression &quot;+_5b);
+}
+}else{
+_59=_56.exec(_5b);
+if(_59){
+_5b=_59[1];
+_59=_59[2]-1;
+}else{
+_59=0;
+}
+if(_5b!=&quot;&quot;){
+_58=_55.exec(_5b);
+if(_58){
+_54=_54.getAttributeNode(_58[1]);
+}else{
+_54=_54.getElementsByTagName(_5b).item(_59);
+}
+}
+}
+}
+if(_54&amp;&amp;_54.firstChild&amp;&amp;_54.firstChild.nodeType==3){
+return _54.firstChild;
+}
+if(_54&amp;&amp;_54.firstChild&amp;&amp;_54.firstChild.nodeType==4){
+return _54.firstChild;
+}
+if(!_54){
+throw new Error(&quot;Can't evaluate expression &quot;+_52);
+}
+return _54;
+};
+Freja.Model=function(url,_60){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._query=_60;
+};
+Freja.Model.prototype.getElementById=function(id){
+if(this.document){
+return this._query.getElementById(this.document,id);
+}
+return null;
+};
+Freja.Model.prototype.get=function(_62){
+if(this.document){
+return this._query.get(this.document,_62);
+}
+return null;
+};
+Freja.Model.prototype.set=function(_63,_64){
+if(this.document){
+return this._query.set(this.document,_63,_64);
+}
+return null;
+};
+Freja.Model.prototype.updateFrom=function(_65){
+var _66=_65.getValues();
+for(var i=0;i&lt;_66[0].length;++i){
+if(_66[0][i].lastIndexOf(&quot;/&quot;)!=-1){
+this.set(_66[0][i],_66[1][i]);
+}
+}
+};
+Freja.Model.prototype.save=function(){
+var url=this.url;
+var _69=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_69){
+url=_69[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;,url);
+try{
+Freja._aux.sendXMLHttpRequest(req,Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback,d),Freja._aux.bind(d.errback,d));
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.Model.prototype.remove=function(){
+var url=this.url;
+var _6d=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_6d){
+url=_6d[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;DELETE&quot;,url);
+return Freja._aux.sendXMLHttpRequest(req);
+};
+Freja.Model.prototype.reload=function(){
+this.ready=false;
+var _6f=Freja._aux.bind(function(_70){
+this.document=_70;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},this);
+var d=Freja.AssetManager.loadAsset(this.url,true);
+d.addCallbacks(_6f,Freja.AssetManager.onerror);
+return d;
+};
+Freja.Model.DataSource=function(_72,_73){
+this.createURL=_72;
+this.indexURL=_73;
+};
+Freja.Model.DataSource.prototype.select=function(){
+return getModel(this.indexURL);
+};
+Freja.Model.DataSource.prototype.create=function(_74){
+var url=this.createURL;
+var _76=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_76){
+url=_76[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;PUT&quot;,url);
+var _78={};
+for(var i=0,len=_74[0].length;i&lt;len;++i){
+_78[_74[0][i]]=_74[1][i];
+}
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_78,&quot;record&quot;));
+};
+Freja.View=function(url,_7b){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._renderer=_7b;
+this._destination=null;
+this.behaviors=[];
+this.placeholder=null;
+Freja._aux.connect(this,&quot;onrendercomplete&quot;,Freja._aux.bind(this._connectBehavior,this));
+};
+Freja.View.prototype.render=function(_7c,_7d,_7e){
+if(typeof (_7d)==&quot;undefined&quot;){
+_7d=this.placeholder;
+}
+if(typeof (_7e)==&quot;undefined&quot;){
+_7e=this.xslParameters;
+}
+var _7f=function(_80,_81,_82,_83){
+this.model=_80;
+this.view=_81;
+this.deferred=_82;
+this.xslParameters=_83;
+};
+_7f.prototype.trigger=function(){
+try{
+if(!this.view.ready){
+Freja._aux.connect(this.view,&quot;onload&quot;,Freja._aux.bind(this.trigger,this));
+return;
+}
+if(typeof (this.model)==&quot;object&quot;&amp;&amp;this.model instanceof Freja.Model&amp;&amp;!this.model.ready){
+Freja._aux.connect(this.model,&quot;onload&quot;,Freja._aux.bind(this.trigger,this));
+return;
+}
+var _84;
+if(typeof (this.model)==&quot;undefined&quot;){
+_84={document:Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;&lt;dummy/&gt;&quot;)};
+}else{
+if(this.model instanceof Freja.Model){
+_84=this.model;
+}else{
+_84={document:Freja._aux.loadXML(&quot;&lt;?xml version='1.0' ?&gt;\n&quot;+Freja._aux.xmlize(this.model,&quot;item&quot;))};
+}
+}
+var _85=this.view._renderer.transform(_84,this.view,this.xslParameters);
+_85.addCallback(Freja._aux.bind(function(_86){
+if(typeof _86==&quot;string&quot;){
+this._destination.innerHTML=_86;
+}else{
+this._destination.innerHTML=&quot;&quot;;
+this._destination.appendChild(_86);
+}
+},this.view));
+_85.addCallback(Freja._aux.bind(function(){
+Freja._aux.signal(this,&quot;onrendercomplete&quot;,this._destination);
+},this.view));
+_85.addCallback(this.deferred.callback);
+_85.addErrback(this.deferred.errback);
+}
+catch(ex){
+this.deferred.errback(ex);
+}
+};
+var d=Freja._aux.createDeferred();
+try{
+if(typeof (_7d)==&quot;object&quot;){
+this._destination=_7d;
+}else{
+this._destination=document.getElementById(_7d);
+}
+this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
+var h=new _7f(_7c,this,d,_7e);
+h.trigger();
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.prototype._connectBehavior=function(_89){
+try{
+var _8a=function(_8b,_8c,_8d){
+Freja._aux.connect(_8b,_8c,Freja._aux.bind(function(e){
+var _8f=false;
+try{
+_8f=_8d(this);
+}
+catch(ex){
+throw new Error(&quot;An error ocurred in user handler.\n&quot;+ex.message);
+}
+finally{
+if(!_8f){
+e.stop();
+}
+}
+},_8b));
+};
+var _90=function(_91,_92){
+for(var i=0,c=_91.childNodes,l=c.length;i&lt;l;++i){
+var _94=c[i];
+if(_94.nodeType==1){
+if(_94.className){
+var _95=_94.className.split(&quot; &quot;);
+for(var j=0;j&lt;_95.length;j++){
+var _97=_92[_95[j]];
+if(_97){
+for(var _98 in _97){
+if(_98==&quot;init&quot;){
+_97.init(_94);
+}else{
+_8a(_94,_98,_97[_98]);
+}
+}
+}
+}
+}
+_90(_94,_92);
+}
+}
+};
+for(var ids in this.behaviors){
+_90(_89,this.behaviors);
+break;
+}
+}
+catch(ex){
+alert(ex.message);
+}
+};
+Freja.View.prototype.getValues=function(){
+return Freja._aux.formContents(this._destination);
+};
+Freja.View.Renderer=function(){
+};
+Freja.View.Renderer.XSLTransformer=function(){
+};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9a,_9b,_9c){
+var d=Freja._aux.createDeferred();
+try{
+var _9e=Freja._aux.transformXSL(_9a.document,_9b.document,_9c);
+if(!_9e){
+d.errback(new Error(&quot;XSL Transformation error.&quot;));
+}else{
+d.callback(_9e);
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.Renderer.RemoteXSLTransformer=function(url){
+this.url=url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a0,_a1,_a2){
+var d=Freja._aux.createDeferred();
+var _a4=_a1.url;
+var _a5=&quot;xslFile=&quot;+encodeURIComponent(_a4)+&quot;&amp;xmlData=&quot;+encodeURIComponent(Freja._aux.serializeXML(_a0.document));
+var _a6=&quot;&quot;;
+for(var _a7 in _a2){
+_a6+=encodeURIComponent(_a7+&quot;,&quot;+_a2[_a7]);
+}
+if(_a6.length&gt;0){
+_a5=_a5+&quot;&amp;xslParam=&quot;+_a6;
+}
+var req=Freja.AssetManager.openXMLHttpRequest(&quot;POST&quot;,Freja.AssetManager.XSLT_SERVICE_URL);
+req.onreadystatechange=function(){
+if(req.readyState==4){
+if(req.status==200){
+d.callback(req.responseText);
+}else{
+d.errback(req.responseText);
+}
+}
+};
+req.send(_a5);
+return d;
+};
+Freja.UndoHistory=function(){
+this.cache=[];
+this.maxLength=5;
+this._position=0;
+this._undoSteps=0;
+};
+Freja.UndoHistory.prototype.add=function(_a9){
+var _aa=this._position%this.maxLength;
+var _ab=_a9.document;
+this.cache[_aa]={};
+this.cache[_aa].model=_a9;
+this.cache[_aa].document=Freja._aux.cloneXMLDocument(_ab);
+if(!this.cache[_aa].document){
+throw new Error(&quot;Couldn't add to history.&quot;);
+}else{
+this._position++;
+var _ac=_aa;
+while(this._undoSteps&gt;0){
+_ac=(_ac+1)%this.maxLength;
+this.cache[_ac]={};
+this._undoSteps--;
+}
+return _aa;
+}
+};
+Freja.UndoHistory.prototype.undo=function(_ad){
+if(this._undoSteps&lt;this.cache.length){
+this._undoSteps++;
+this._position--;
+if(this._position&lt;0){
+this._position=this.maxLength-1;
+}
+var _ae=this.cache[this._position].model;
+if(this.cache[this._position].document){
+_ae.document=this.cache[this._position].document;
+}else{
+throw new Error(&quot;The model's DOMDocument wasn't properly copied into the history&quot;);
+}
+if(typeof (_ad)!=&quot;undefined&quot;&amp;&amp;_ad&gt;1){
+this.undo(_ad-1);
+}
+}else{
+throw new Error(&quot;Nothing to undo&quot;);
+}
+};
+Freja.UndoHistory.prototype.redo=function(){
+if(this._undoSteps&gt;0){
+this._undoSteps--;
+this._position=(this._position+1)%this.maxLength;
+var _af=this.cache[this._position].model;
+_af.document=this.cache[this._position].document;
+}else{
+throw new Error(&quot;Nothing to redo&quot;);
+}
+};
+Freja.UndoHistory.prototype.removeLast=function(){
+this._position--;
+if(this._position&lt;0){
+this._position=this.maxLength-1;
+}
+this.cache[this._position]={};
+this._undoSteps=0;
+};
+Freja.AssetManager={models:[],views:[],_username:null,_password:null};
+Freja.AssetManager.HTTP_REQUEST_TYPE=&quot;async&quot;;
+Freja.AssetManager.HTTP_METHOD_TUNNEL=&quot;Http-Method-Equivalent&quot;;
+Freja.AssetManager.XSLT_SERVICE_URL=&quot;srvc-xslt.php&quot;;
+Freja.AssetManager.THROBBER_HTML=&quot;&lt;span style='color:white;background:firebrick'&gt;Loading ...&lt;/span&gt;&quot;;
+Freja.AssetManager.createRenderer=function(){
+if(Freja._aux.hasSupportForXSLT()){
+return new Freja.View.Renderer.XSLTransformer();
+}else{
+return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+}
+};
+Freja.AssetManager.clearCache=function(){
+this.models=[];
+this.views=[];
+};
+Freja.AssetManager.getModel=function(url){
+for(var i=0;i&lt;this.models.length;i++){
+if(this.models[i].url==url){
+return this.models[i];
+}
+}
+var m=new Freja.Model(url,Freja._aux.createQueryEngine());
+var _b3=Freja._aux.bind(function(_b4){
+this.document=_b4;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},m);
+this.loadAsset(url,true).addCallbacks(_b3,Freja.AssetManager.onerror);
+this.models.push(m);
+return m;
+};
+Freja.AssetManager.getView=function(url){
+for(var i=0;i&lt;this.views.length;i++){
+if(this.views[i].url==url){
+return this.views[i];
+}
+}
+var v=new Freja.View(url,this.createRenderer());
+var _b8=Freja._aux.bind(function(_b9){
+this.document=_b9;
+this.ready=true;
+Freja._aux.signal(this,&quot;onload&quot;);
+},v);
+this.loadAsset(url,false).addCallbacks(_b8,Freja.AssetManager.onerror);
+this.views.push(v);
+return v;
+};
+Freja.AssetManager.openXMLHttpRequest=function(_ba,url){
+var _bc=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&amp;&amp;_ba!=&quot;GET&quot;&amp;&amp;_ba!=&quot;POST&quot;){
+_bc=_ba;
+_ba=&quot;POST&quot;;
+}
+var req=Freja._aux.openXMLHttpRequest(_ba,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+if(_bc){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_bc);
+}
+return req;
+};
+Freja.AssetManager.setCredentials=function(_be,_bf){
+this._username=_be;
+this._password=_bf;
+};
+Freja.AssetManager.loadAsset=function(url,_c1){
+var _c2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_c2){
+url=_c2[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var _c4=function(_c5){
+try{
+if(_c5.responseText==&quot;&quot;){
+throw new Error(&quot;Empty response.&quot;);
+}
+if(_c5.responseXML.xml==&quot;&quot;){
+var _c6=Freja._aux.loadXML(_c5.responseText);
+}else{
+var _c6=_c5.responseXML;
+}
+}
+catch(ex){
+d.errback(ex);
+}
+if(window.document.all){
+setTimeout(function(){
+d.callback(_c6);
+},1);
+}else{
+d.callback(_c6);
+}
+};
+try{
+if(_c1&amp;&amp;Freja.AssetManager.HTTP_METHOD_TUNNEL){
+var req=Freja._aux.openXMLHttpRequest(&quot;POST&quot;,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,&quot;GET&quot;);
+req.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);
+}else{
+var req=Freja._aux.openXMLHttpRequest(&quot;GET&quot;,url,Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;,Freja.AssetManager._username,Freja.AssetManager._password);
+}
+var _c8=Freja._aux.sendXMLHttpRequest(req);
+if(Freja.AssetManager.HTTP_REQUEST_TYPE==&quot;async&quot;){
+_c8.addCallbacks(_c4,function(req){
+d.errback(new Error(&quot;Request failed:&quot;+req.status));
+});
+}else{
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+_c4(req);
+}else{
+d.errback(new Error(&quot;Request failed:&quot;+req.status));
+}
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.AssetManager.onerror=function(ex){
+alert(&quot;Freja.AssetManager.onerror\n&quot;+ex.message);
+};
+window.getModel=Freja._aux.bind(&quot;getModel&quot;,Freja.AssetManager);
+window.getView=Freja._aux.bind(&quot;getView&quot;,Freja.AssetManager);
+

Added: trunk/lib/mochi+sarissa/MochiKit.js
===================================================================
--- trunk/lib/mochi+sarissa/MochiKit.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/MochiKit.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,4802 @@
+/***
+
+    MochiKit.MochiKit 1.3.1 : PACKED VERSION
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    See &lt;<A HREF="http://mochikit.com/">http://mochikit.com/</A>&gt; for documentation, downloads, license, etc.
+
+    (c) 2005 Bob Ippolito.  All rights Reserved.
+
+***/
+
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Base&quot;);
+}
+if(typeof (MochiKit)==&quot;undefined&quot;){
+MochiKit={};
+}
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+MochiKit.Base={};
+}
+MochiKit.Base.VERSION=&quot;1.3.1&quot;;
+MochiKit.Base.NAME=&quot;MochiKit.Base&quot;;
+MochiKit.Base.update=function(_1,_2){
+if(_1===null){
+_1={};
+}
+for(var i=1;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!=&quot;undefined&quot;&amp;&amp;o!==null){
+for(var k in o){
+_1[k]=o[k];
+}
+}
+}
+return _1;
+};
+MochiKit.Base.update(MochiKit.Base,{__repr__:function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+},toString:function(){
+return this.__repr__();
+},counter:function(n){
+if(arguments.length===0){
+n=1;
+}
+return function(){
+return n++;
+};
+},clone:function(_7){
+var me=arguments.callee;
+if(arguments.length==1){
+me.prototype=_7;
+return new me();
+}
+},flattenArguments:function(_9){
+var res=[];
+var m=MochiKit.Base;
+var _12=m.extend(null,arguments);
+while(_12.length){
+var o=_12.shift();
+if(o&amp;&amp;typeof (o)==&quot;object&quot;&amp;&amp;typeof (o.length)==&quot;number&quot;){
+for(var i=o.length-1;i&gt;=0;i--){
+_12.unshift(o[i]);
+}
+}else{
+res.push(o);
+}
+}
+return res;
+},extend:function(_13,obj,_15){
+if(!_15){
+_15=0;
+}
+if(obj){
+var l=obj.length;
+if(typeof (l)!=&quot;number&quot;){
+if(typeof (MochiKit.Iter)!=&quot;undefined&quot;){
+obj=MochiKit.Iter.list(obj);
+l=obj.length;
+}else{
+throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
+}
+}
+if(!_13){
+_13=[];
+}
+for(var i=_15;i&lt;l;i++){
+_13.push(obj[i]);
+}
+}
+return _13;
+},updatetree:function(_17,obj){
+if(_17===null){
+_17={};
+}
+for(var i=1;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!=&quot;undefined&quot;&amp;&amp;o!==null){
+for(var k in o){
+var v=o[k];
+if(typeof (_17[k])==&quot;object&quot;&amp;&amp;typeof (v)==&quot;object&quot;){
+arguments.callee(_17[k],v);
+}else{
+_17[k]=v;
+}
+}
+}
+}
+return _17;
+},setdefault:function(_19,obj){
+if(_19===null){
+_19={};
+}
+for(var i=1;i&lt;arguments.length;i++){
+var o=arguments[i];
+for(var k in o){
+if(!(k in _19)){
+_19[k]=o[k];
+}
+}
+}
+return _19;
+},keys:function(obj){
+var _20=[];
+for(var _21 in obj){
+_20.push(_21);
+}
+return _20;
+},items:function(obj){
+var _22=[];
+var e;
+for(var _24 in obj){
+var v;
+try{
+v=obj[_24];
+}
+catch(e){
+continue;
+}
+_22.push([_24,v]);
+}
+return _22;
+},_newNamedError:function(_25,_26,_27){
+_27.prototype=new MochiKit.Base.NamedError(_25.NAME+&quot;.&quot;+_26);
+_25[_26]=_27;
+},operator:{truth:function(a){
+return !!a;
+},lognot:function(a){
+return !a;
+},identity:function(a){
+return a;
+},not:function(a){
+return ~a;
+},neg:function(a){
+return -a;
+},add:function(a,b){
+return a+b;
+},sub:function(a,b){
+return a-b;
+},div:function(a,b){
+return a/b;
+},mod:function(a,b){
+return a%b;
+},mul:function(a,b){
+return a*b;
+},and:function(a,b){
+return a&b;
+},or:function(a,b){
+return a|b;
+},xor:function(a,b){
+return a^b;
+},lshift:function(a,b){
+return a&lt;&lt;b;
+},rshift:function(a,b){
+return a&gt;&gt;b;
+},zrshift:function(a,b){
+return a&gt;&gt;&gt;b;
+},eq:function(a,b){
+return a==b;
+},ne:function(a,b){
+return a!=b;
+},gt:function(a,b){
+return a&gt;b;
+},ge:function(a,b){
+return a&gt;=b;
+},lt:function(a,b){
+return a&lt;b;
+},le:function(a,b){
+return a&lt;=b;
+},ceq:function(a,b){
+return MochiKit.Base.compare(a,b)===0;
+},cne:function(a,b){
+return MochiKit.Base.compare(a,b)!==0;
+},cgt:function(a,b){
+return MochiKit.Base.compare(a,b)==1;
+},cge:function(a,b){
+return MochiKit.Base.compare(a,b)!=-1;
+},clt:function(a,b){
+return MochiKit.Base.compare(a,b)==-1;
+},cle:function(a,b){
+return MochiKit.Base.compare(a,b)!=1;
+},logand:function(a,b){
+return a&amp;&b;
+},logor:function(a,b){
+return a||b;
+},contains:function(a,b){
+return b in a;
+}},forwardCall:function(_30){
+return function(){
+return this[_30].apply(this,arguments);
+};
+},itemgetter:function(_31){
+return function(arg){
+return arg[_31];
+};
+},typeMatcher:function(){
+var _33={};
+for(var i=0;i&lt;arguments.length;i++){
+var typ=arguments[i];
+_33[typ]=typ;
+}
+return function(){
+for(var i=0;i&lt;arguments.length;i++){
+if(!(typeof (arguments[i]) in _33)){
+return false;
+}
+}
+return true;
+};
+},isNull:function(){
+for(var i=0;i&lt;arguments.length;i++){
+if(arguments[i]!==null){
+return false;
+}
+}
+return true;
+},isUndefinedOrNull:function(){
+for(var i=0;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(!(typeof (o)==&quot;undefined&quot;||o===null)){
+return false;
+}
+}
+return true;
+},isEmpty:function(obj){
+return !MochiKit.Base.isNotEmpty.apply(this,arguments);
+},isNotEmpty:function(obj){
+for(var i=0;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(!(o&amp;&amp;o.length)){
+return false;
+}
+}
+return true;
+},isArrayLike:function(){
+for(var i=0;i&lt;arguments.length;i++){
+var o=arguments[i];
+var typ=typeof (o);
+if((typ!=&quot;object&quot;&amp;&amp;!(typ==&quot;function&quot;&amp;&amp;typeof (o.item)==&quot;function&quot;))||o===null||typeof (o.length)!=&quot;number&quot;){
+return false;
+}
+}
+return true;
+},isDateLike:function(){
+for(var i=0;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!=&quot;object&quot;||o===null||typeof (o.getTime)!=&quot;function&quot;){
+return false;
+}
+}
+return true;
+},xmap:function(fn){
+if(fn===null){
+return MochiKit.Base.extend(null,arguments,1);
+}
+var _36=[];
+for(var i=1;i&lt;arguments.length;i++){
+_36.push(fn(arguments[i]));
+}
+return _36;
+},map:function(fn,lst){
+var m=MochiKit.Base;
+var itr=MochiKit.Iter;
+var _39=m.isArrayLike;
+if(arguments.length&lt;=2){
+if(!_39(lst)){
+if(itr){
+lst=itr.list(lst);
+if(fn===null){
+return lst;
+}
+}else{
+throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
+}
+}
+if(fn===null){
+return m.extend(null,lst);
+}
+var _40=[];
+for(var i=0;i&lt;lst.length;i++){
+_40.push(fn(lst[i]));
+}
+return _40;
+}else{
+if(fn===null){
+fn=Array;
+}
+var _41=null;
+for(i=1;i&lt;arguments.length;i++){
+if(!_39(arguments[i])){
+if(itr){
+return itr.list(itr.imap.apply(null,arguments));
+}else{
+throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
+}
+}
+var l=arguments[i].length;
+if(_41===null||_41&gt;l){
+_41=l;
+}
+}
+_40=[];
+for(i=0;i&lt;_41;i++){
+var _42=[];
+for(var j=1;j&lt;arguments.length;j++){
+_42.push(arguments[j][i]);
+}
+_40.push(fn.apply(this,_42));
+}
+return _40;
+}
+},xfilter:function(fn){
+var _44=[];
+if(fn===null){
+fn=MochiKit.Base.operator.truth;
+}
+for(var i=1;i&lt;arguments.length;i++){
+var o=arguments[i];
+if(fn(o)){
+_44.push(o);
+}
+}
+return _44;
+},filter:function(fn,lst,_45){
+var _46=[];
+var m=MochiKit.Base;
+if(!m.isArrayLike(lst)){
+if(MochiKit.Iter){
+lst=MochiKit.Iter.list(lst);
+}else{
+throw new TypeError(&quot;Argument not an array-like and MochiKit.Iter not present&quot;);
+}
+}
+if(fn===null){
+fn=m.operator.truth;
+}
+if(typeof (Array.prototype.filter)==&quot;function&quot;){
+return Array.prototype.filter.call(lst,fn,_45);
+}else{
+if(typeof (_45)==&quot;undefined&quot;||_45===null){
+for(var i=0;i&lt;lst.length;i++){
+var o=lst[i];
+if(fn(o)){
+_46.push(o);
+}
+}
+}else{
+for(i=0;i&lt;lst.length;i++){
+o=lst[i];
+if(fn.call(_45,o)){
+_46.push(o);
+}
+}
+}
+}
+return _46;
+},_wrapDumbFunction:function(_47){
+return function(){
+switch(arguments.length){
+case 0:
+return _47();
+case 1:
+return _47(arguments[0]);
+case 2:
+return _47(arguments[0],arguments[1]);
+case 3:
+return _47(arguments[0],arguments[1],arguments[2]);
+}
+var _48=[];
+for(var i=0;i&lt;arguments.length;i++){
+_48.push(&quot;arguments[&quot;+i+&quot;]&quot;);
+}
+return eval(&quot;(func(&quot;+_48.join(&quot;,&quot;)+&quot;))&quot;);
+};
+},method:function(_49,_50){
+var m=MochiKit.Base;
+return m.bind.apply(this,m.extend([_50,_49],arguments,2));
+},bind:function(_51,_52){
+if(typeof (_51)==&quot;string&quot;){
+_51=_52[_51];
+}
+var _53=_51.im_func;
+var _54=_51.im_preargs;
+var _55=_51.im_self;
+var m=MochiKit.Base;
+if(typeof (_51)==&quot;function&quot;&amp;&amp;typeof (_51.apply)==&quot;undefined&quot;){
+_51=m._wrapDumbFunction(_51);
+}
+if(typeof (_53)!=&quot;function&quot;){
+_53=_51;
+}
+if(typeof (_52)!=&quot;undefined&quot;){
+_55=_52;
+}
+if(typeof (_54)==&quot;undefined&quot;){
+_54=[];
+}else{
+_54=_54.slice();
+}
+m.extend(_54,arguments,2);
+var _56=function(){
+var _57=arguments;
+var me=arguments.callee;
+if(me.im_preargs.length&gt;0){
+_57=m.concat(me.im_preargs,_57);
+}
+var _52=me.im_self;
+if(!_52){
+_52=this;
+}
+return me.im_func.apply(_52,_57);
+};
+_56.im_self=_55;
+_56.im_func=_53;
+_56.im_preargs=_54;
+return _56;
+},bindMethods:function(_58){
+var _59=MochiKit.Base.bind;
+for(var k in _58){
+var _60=_58[k];
+if(typeof (_60)==&quot;function&quot;){
+_58[k]=_59(_60,_58);
+}
+}
+},registerComparator:function(_61,_62,_63,_64){
+MochiKit.Base.comparatorRegistry.register(_61,_62,_63,_64);
+},_primitives:{&quot;bool&quot;:true,&quot;string&quot;:true,&quot;number&quot;:true},compare:function(a,b){
+if(a==b){
+return 0;
+}
+var _65=(typeof (a)==&quot;undefined&quot;||a===null);
+var _66=(typeof (b)==&quot;undefined&quot;||b===null);
+if(_65&amp;&amp;_66){
+return 0;
+}else{
+if(_65){
+return -1;
+}else{
+if(_66){
+return 1;
+}
+}
+}
+var m=MochiKit.Base;
+var _67=m._primitives;
+if(!(typeof (a) in _67&amp;&amp;typeof (b) in _67)){
+try{
+return m.comparatorRegistry.match(a,b);
+}
+catch(e){
+if(e!=m.NotFound){
+throw e;
+}
+}
+}
+if(a&lt;b){
+return -1;
+}else{
+if(a&gt;b){
+return 1;
+}
+}
+var _68=m.repr;
+throw new TypeError(_68(a)+&quot; and &quot;+_68(b)+&quot; can not be compared&quot;);
+},compareDateLike:function(a,b){
+return MochiKit.Base.compare(a.getTime(),b.getTime());
+},compareArrayLike:function(a,b){
+var _69=MochiKit.Base.compare;
+var _70=a.length;
+var _71=0;
+if(_70&gt;b.length){
+_71=1;
+_70=b.length;
+}else{
+if(_70&lt;b.length){
+_71=-1;
+}
+}
+for(var i=0;i&lt;_70;i++){
+var cmp=_69(a[i],b[i]);
+if(cmp){
+return cmp;
+}
+}
+return _71;
+},registerRepr:function(_73,_74,_75,_76){
+MochiKit.Base.reprRegistry.register(_73,_74,_75,_76);
+},repr:function(o){
+if(typeof (o)==&quot;undefined&quot;){
+return &quot;undefined&quot;;
+}else{
+if(o===null){
+return &quot;null&quot;;
+}
+}
+try{
+if(typeof (o.__repr__)==&quot;function&quot;){
+return o.__repr__();
+}else{
+if(typeof (o.repr)==&quot;function&quot;&amp;&amp;o.repr!=arguments.callee){
+return o.repr();
+}
+}
+return MochiKit.Base.reprRegistry.match(o);
+}
+catch(e){
+if(typeof (o.NAME)==&quot;string&quot;&amp;&amp;(o.toString==Function.prototype.toString||o.toString==Object.prototype.toString)){
+return o.NAME;
+}
+}
+try{
+var _77=(o+&quot;&quot;);
+}
+catch(e){
+return &quot;[&quot;+typeof (o)+&quot;]&quot;;
+}
+if(typeof (o)==&quot;function&quot;){
+o=_77.replace(/^\s+/,&quot;&quot;);
+var idx=o.indexOf(&quot;{&quot;);
+if(idx!=-1){
+o=o.substr(0,idx)+&quot;{...}&quot;;
+}
+}
+return _77;
+},reprArrayLike:function(o){
+var m=MochiKit.Base;
+return &quot;[&quot;+m.map(m.repr,o).join(&quot;, &quot;)+&quot;]&quot;;
+},reprString:function(o){
+return (&quot;\&quot;&quot;+o.replace(/([&quot;\\])/g,&quot;\\$1&quot;)+&quot;\&quot;&quot;).replace(/[\f]/g,&quot;\\f&quot;).replace(/[\b]/g,&quot;\\b&quot;).replace(/[\n]/g,&quot;\\n&quot;).replace(/[\t]/g,&quot;\\t&quot;).replace(/[\r]/g,&quot;\\r&quot;);
+},reprNumber:function(o){
+return o+&quot;&quot;;
+},registerJSON:function(_79,_80,_81,_82){
+MochiKit.Base.jsonRegistry.register(_79,_80,_81,_82);
+},evalJSON:function(){
+return eval(&quot;(&quot;+arguments[0]+&quot;)&quot;);
+},serializeJSON:function(o){
+var _83=typeof (o);
+if(_83==&quot;undefined&quot;){
+return &quot;undefined&quot;;
+}else{
+if(_83==&quot;number&quot;||_83==&quot;boolean&quot;){
+return o+&quot;&quot;;
+}else{
+if(o===null){
+return &quot;null&quot;;
+}
+}
+}
+var m=MochiKit.Base;
+var _84=m.reprString;
+if(_83==&quot;string&quot;){
+return _84(o);
+}
+var me=arguments.callee;
+var _85;
+if(typeof (o.__json__)==&quot;function&quot;){
+_85=o.__json__();
+if(o!==_85){
+return me(_85);
+}
+}
+if(typeof (o.json)==&quot;function&quot;){
+_85=o.json();
+if(o!==_85){
+return me(_85);
+}
+}
+if(_83!=&quot;function&quot;&amp;&amp;typeof (o.length)==&quot;number&quot;){
+var res=[];
+for(var i=0;i&lt;o.length;i++){
+var val=me(o[i]);
+if(typeof (val)!=&quot;string&quot;){
+val=&quot;undefined&quot;;
+}
+res.push(val);
+}
+return &quot;[&quot;+res.join(&quot;, &quot;)+&quot;]&quot;;
+}
+try{
+_85=m.jsonRegistry.match(o);
+return me(_85);
+}
+catch(e){
+if(e!=m.NotFound){
+throw e;
+}
+}
+if(_83==&quot;function&quot;){
+return null;
+}
+res=[];
+for(var k in o){
+var _87;
+if(typeof (k)==&quot;number&quot;){
+_87=&quot;\&quot;&quot;+k+&quot;\&quot;&quot;;
+}else{
+if(typeof (k)==&quot;string&quot;){
+_87=_84(k);
+}else{
+continue;
+}
+}
+val=me(o[k]);
+if(typeof (val)!=&quot;string&quot;){
+continue;
+}
+res.push(_87+&quot;:&quot;+val);
+}
+return &quot;{&quot;+res.join(&quot;, &quot;)+&quot;}&quot;;
+},objEqual:function(a,b){
+return (MochiKit.Base.compare(a,b)===0);
+},arrayEqual:function(_88,arr){
+if(_88.length!=arr.length){
+return false;
+}
+return (MochiKit.Base.compare(_88,arr)===0);
+},concat:function(){
+var _90=[];
+var _91=MochiKit.Base.extend;
+for(var i=0;i&lt;arguments.length;i++){
+_91(_90,arguments[i]);
+}
+return _90;
+},keyComparator:function(key){
+var m=MochiKit.Base;
+var _93=m.compare;
+if(arguments.length==1){
+return function(a,b){
+return _93(a[key],b[key]);
+};
+}
+var _94=m.extend(null,arguments);
+return function(a,b){
+var _95=0;
+for(var i=0;(_95===0)&amp;&amp;(i&lt;_94.length);i++){
+var key=_94[i];
+_95=_93(a[key],b[key]);
+}
+return _95;
+};
+},reverseKeyComparator:function(key){
+var _96=MochiKit.Base.keyComparator.apply(this,arguments);
+return function(a,b){
+return _96(b,a);
+};
+},partial:function(_97){
+var m=MochiKit.Base;
+return m.bind.apply(this,m.extend([_97,undefined],arguments,1));
+},listMinMax:function(_98,lst){
+if(lst.length===0){
+return null;
+}
+var cur=lst[0];
+var _100=MochiKit.Base.compare;
+for(var i=1;i&lt;lst.length;i++){
+var o=lst[i];
+if(_100(o,cur)==_98){
+cur=o;
+}
+}
+return cur;
+},objMax:function(){
+return MochiKit.Base.listMinMax(1,arguments);
+},objMin:function(){
+return MochiKit.Base.listMinMax(-1,arguments);
+},findIdentical:function(lst,_101,_102,end){
+if(typeof (end)==&quot;undefined&quot;||end===null){
+end=lst.length;
+}
+for(var i=(_102||0);i&lt;end;i++){
+if(lst[i]===_101){
+return i;
+}
+}
+return -1;
+},findValue:function(lst,_104,_105,end){
+if(typeof (end)==&quot;undefined&quot;||end===null){
+end=lst.length;
+}
+var cmp=MochiKit.Base.compare;
+for(var i=(_105||0);i&lt;end;i++){
+if(cmp(lst[i],_104)===0){
+return i;
+}
+}
+return -1;
+},nodeWalk:function(node,_107){
+var _108=[node];
+var _109=MochiKit.Base.extend;
+while(_108.length){
+var res=_107(_108.shift());
+if(res){
+_109(_108,res);
+}
+}
+},nameFunctions:function(_110){
+var base=_110.NAME;
+if(typeof (base)==&quot;undefined&quot;){
+base=&quot;&quot;;
+}else{
+base=base+&quot;.&quot;;
+}
+for(var name in _110){
+var o=_110[name];
+if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
+try{
+o.NAME=base+name;
+}
+catch(e){
+}
+}
+}
+},queryString:function(_113,_114){
+if(typeof (MochiKit.DOM)!=&quot;undefined&quot;&amp;&amp;arguments.length==1&amp;&amp;(typeof (_113)==&quot;string&quot;||(typeof (_113.nodeType)!=&quot;undefined&quot;&amp;&amp;_113.nodeType&gt;0))){
+var kv=MochiKit.DOM.formContents(_113);
+_113=kv[0];
+_114=kv[1];
+}else{
+if(arguments.length==1){
+var o=_113;
+_113=[];
+_114=[];
+for(var k in o){
+var v=o[k];
+if(typeof (v)!=&quot;function&quot;){
+_113.push(k);
+_114.push(v);
+}
+}
+}
+}
+var rval=[];
+var len=Math.min(_113.length,_114.length);
+var _118=MochiKit.Base.urlEncode;
+for(var i=0;i&lt;len;i++){
+v=_114[i];
+if(typeof (v)!=&quot;undefined&quot;&amp;&amp;v!==null){
+rval.push(_118(_113[i])+&quot;=&quot;+_118(v));
+}
+}
+return rval.join(&quot;&amp;&quot;);
+},parseQueryString:function(_119,_120){
+var _121=_119.replace(/\+/g,&quot;%20&quot;).split(&quot;&amp;&quot;);
+var o={};
+var _122;
+if(typeof (decodeURIComponent)!=&quot;undefined&quot;){
+_122=decodeURIComponent;
+}else{
+_122=unescape;
+}
+if(_120){
+for(var i=0;i&lt;_121.length;i++){
+var pair=_121[i].split(&quot;=&quot;);
+var name=_122(pair[0]);
+var arr=o[name];
+if(!(arr instanceof Array)){
+arr=[];
+o[name]=arr;
+}
+arr.push(_122(pair[1]));
+}
+}else{
+for(i=0;i&lt;_121.length;i++){
+pair=_121[i].split(&quot;=&quot;);
+o[_122(pair[0])]=_122(pair[1]);
+}
+}
+return o;
+}});
+MochiKit.Base.AdapterRegistry=function(){
+this.pairs=[];
+};
+MochiKit.Base.AdapterRegistry.prototype={register:function(name,_124,wrap,_126){
+if(_126){
+this.pairs.unshift([name,_124,wrap]);
+}else{
+this.pairs.push([name,_124,wrap]);
+}
+},match:function(){
+for(var i=0;i&lt;this.pairs.length;i++){
+var pair=this.pairs[i];
+if(pair[1].apply(this,arguments)){
+return pair[2].apply(this,arguments);
+}
+}
+throw MochiKit.Base.NotFound;
+},unregister:function(name){
+for(var i=0;i&lt;this.pairs.length;i++){
+var pair=this.pairs[i];
+if(pair[0]==name){
+this.pairs.splice(i,1);
+return true;
+}
+}
+return false;
+}};
+MochiKit.Base.EXPORT=[&quot;counter&quot;,&quot;clone&quot;,&quot;extend&quot;,&quot;update&quot;,&quot;updatetree&quot;,&quot;setdefault&quot;,&quot;keys&quot;,&quot;items&quot;,&quot;NamedError&quot;,&quot;operator&quot;,&quot;forwardCall&quot;,&quot;itemgetter&quot;,&quot;typeMatcher&quot;,&quot;isCallable&quot;,&quot;isUndefined&quot;,&quot;isUndefinedOrNull&quot;,&quot;isNull&quot;,&quot;isEmpty&quot;,&quot;isNotEmpty&quot;,&quot;isArrayLike&quot;,&quot;isDateLike&quot;,&quot;xmap&quot;,&quot;map&quot;,&quot;xfilter&quot;,&quot;filter&quot;,&quot;bind&quot;,&quot;bindMethods&quot;,&quot;NotFound&quot;,&quot;AdapterRegistry&quot;,&quot;registerComparator&quot;,&quot;compare&quot;,&quot;registerRepr&quot;,&quot;repr&quot;,&quot;objEqual&quot;,&quot;arrayEqual&quot;,&quot;concat&quot;,&quot;keyComparator&quot;,&quot;reverseKeyComparator&quot;,&quot;partial&quot;,&quot;merge&quot;,&quot;listMinMax&quot;,&quot;listMax&quot;,&quot;listMin&quot;,&quot;objMax&quot;,&quot;objMin&quot;,&quot;nodeWalk&quot;,&quot;zip&quot;,&quot;urlEncode&quot;,&quot;queryString&quot;,&quot;serializeJSON&quot;,&quot;registerJSON&quot;,&quot;evalJSON&quot;,&quot;parseQueryString&quot;,&quot;findValue&quot;,&quot;findIdentical&quot;,&quot;flattenArguments&quot;,&quot;method&quot;];
+MochiKit.Base.EXPORT_OK=[&quot;nameFunctions&quot;,&quot;comparatorRegistry&quot;,&quot;reprRegistry&quot;,&quot;jsonRegistry&quot;,&quot;compareDateLike&quot;,&quot;compareArrayLike&quot;,&quot;reprArrayLike&quot;,&quot;reprString&quot;,&quot;reprNumber&quot;];
+MochiKit.Base._exportSymbols=function(_127,_128){
+if(typeof (MochiKit.__export__)==&quot;undefined&quot;){
+MochiKit.__export__=(MochiKit.__compat__||(typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;));
+}
+if(!MochiKit.__export__){
+return;
+}
+var all=_128.EXPORT_TAGS[&quot;:all&quot;];
+for(var i=0;i&lt;all.length;i++){
+_127[all[i]]=_128[all[i]];
+}
+};
+MochiKit.Base.__new__=function(){
+var m=this;
+m.forward=m.forwardCall;
+m.find=m.findValue;
+if(typeof (encodeURIComponent)!=&quot;undefined&quot;){
+m.urlEncode=function(_130){
+return encodeURIComponent(_130).replace(/\'/g,&quot;%27&quot;);
+};
+}else{
+m.urlEncode=function(_131){
+return escape(_131).replace(/\+/g,&quot;%2B&quot;).replace(/\&quot;/g,&quot;%22&quot;).rval.replace(/\'/g,&quot;%27&quot;);
+};
+}
+m.NamedError=function(name){
+this.message=name;
+this.name=name;
+};
+m.NamedError.prototype=new Error();
+m.update(m.NamedError.prototype,{repr:function(){
+if(this.message&amp;&amp;this.message!=this.name){
+return this.name+&quot;(&quot;+m.repr(this.message)+&quot;)&quot;;
+}else{
+return this.name+&quot;()&quot;;
+}
+},toString:m.forwardCall(&quot;repr&quot;)});
+m.NotFound=new m.NamedError(&quot;MochiKit.Base.NotFound&quot;);
+m.listMax=m.partial(m.listMinMax,1);
+m.listMin=m.partial(m.listMinMax,-1);
+m.isCallable=m.typeMatcher(&quot;function&quot;);
+m.isUndefined=m.typeMatcher(&quot;undefined&quot;);
+m.merge=m.partial(m.update,null);
+m.zip=m.partial(m.map,null);
+m.comparatorRegistry=new m.AdapterRegistry();
+m.registerComparator(&quot;dateLike&quot;,m.isDateLike,m.compareDateLike);
+m.registerComparator(&quot;arrayLike&quot;,m.isArrayLike,m.compareArrayLike);
+m.reprRegistry=new m.AdapterRegistry();
+m.registerRepr(&quot;arrayLike&quot;,m.isArrayLike,m.reprArrayLike);
+m.registerRepr(&quot;string&quot;,m.typeMatcher(&quot;string&quot;),m.reprString);
+m.registerRepr(&quot;numbers&quot;,m.typeMatcher(&quot;number&quot;,&quot;boolean&quot;),m.reprNumber);
+m.jsonRegistry=new m.AdapterRegistry();
+var all=m.concat(m.EXPORT,m.EXPORT_OK);
+m.EXPORT_TAGS={&quot;:common&quot;:m.concat(m.EXPORT_OK),&quot;:all&quot;:all};
+m.nameFunctions(this);
+};
+MochiKit.Base.__new__();
+if(!MochiKit.__compat__){
+compare=MochiKit.Base.compare;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Base);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Iter&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Iter depends on MochiKit.Base!&quot;;
+}
+if(typeof (MochiKit.Iter)==&quot;undefined&quot;){
+MochiKit.Iter={};
+}
+MochiKit.Iter.NAME=&quot;MochiKit.Iter&quot;;
+MochiKit.Iter.VERSION=&quot;1.3.1&quot;;
+MochiKit.Base.update(MochiKit.Iter,{__repr__:function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+},toString:function(){
+return this.__repr__();
+},registerIteratorFactory:function(name,_132,_133,_134){
+MochiKit.Iter.iteratorRegistry.register(name,_132,_133,_134);
+},iter:function(_135,_136){
+var self=MochiKit.Iter;
+if(arguments.length==2){
+return self.takewhile(function(a){
+return a!=_136;
+},_135);
+}
+if(typeof (_135.next)==&quot;function&quot;){
+return _135;
+}else{
+if(typeof (_135.iter)==&quot;function&quot;){
+return _135.iter();
+}
+}
+try{
+return self.iteratorRegistry.match(_135);
+}
+catch(e){
+var m=MochiKit.Base;
+if(e==m.NotFound){
+e=new TypeError(typeof (_135)+&quot;: &quot;+m.repr(_135)+&quot; is not iterable&quot;);
+}
+throw e;
+}
+},count:function(n){
+if(!n){
+n=0;
+}
+var m=MochiKit.Base;
+return {repr:function(){
+return &quot;count(&quot;+n+&quot;)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:m.counter(n)};
+},cycle:function(p){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+var lst=[];
+var _139=self.iter(p);
+return {repr:function(){
+return &quot;cycle(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+try{
+var rval=_139.next();
+lst.push(rval);
+return rval;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+if(lst.length===0){
+this.next=function(){
+throw self.StopIteration;
+};
+}else{
+var i=-1;
+this.next=function(){
+i=(i+1)%lst.length;
+return lst[i];
+};
+}
+return this.next();
+}
+}};
+},repeat:function(elem,n){
+var m=MochiKit.Base;
+if(typeof (n)==&quot;undefined&quot;){
+return {repr:function(){
+return &quot;repeat(&quot;+m.repr(elem)+&quot;)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+return elem;
+}};
+}
+return {repr:function(){
+return &quot;repeat(&quot;+m.repr(elem)+&quot;, &quot;+n+&quot;)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+if(n&lt;=0){
+throw MochiKit.Iter.StopIteration;
+}
+n-=1;
+return elem;
+}};
+},next:function(_141){
+return _141.next();
+},izip:function(p,q){
+var m=MochiKit.Base;
+var next=MochiKit.Iter.next;
+var _144=m.map(iter,arguments);
+return {repr:function(){
+return &quot;izip(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+return m.map(next,_144);
+}};
+},ifilter:function(pred,seq){
+var m=MochiKit.Base;
+seq=MochiKit.Iter.iter(seq);
+if(pred===null){
+pred=m.operator.truth;
+}
+return {repr:function(){
+return &quot;ifilter(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+while(true){
+var rval=seq.next();
+if(pred(rval)){
+return rval;
+}
+}
+return undefined;
+}};
+},ifilterfalse:function(pred,seq){
+var m=MochiKit.Base;
+seq=MochiKit.Iter.iter(seq);
+if(pred===null){
+pred=m.operator.truth;
+}
+return {repr:function(){
+return &quot;ifilterfalse(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+while(true){
+var rval=seq.next();
+if(!pred(rval)){
+return rval;
+}
+}
+return undefined;
+}};
+},islice:function(seq){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+seq=self.iter(seq);
+var _147=0;
+var stop=0;
+var step=1;
+var i=-1;
+if(arguments.length==2){
+stop=arguments[1];
+}else{
+if(arguments.length==3){
+_147=arguments[1];
+stop=arguments[2];
+}else{
+_147=arguments[1];
+stop=arguments[2];
+step=arguments[3];
+}
+}
+return {repr:function(){
+return &quot;islice(&quot;+[&quot;...&quot;,_147,stop,step].join(&quot;, &quot;)+&quot;)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+var rval;
+while(i&lt;_147){
+rval=seq.next();
+i++;
+}
+if(_147&gt;=stop){
+throw self.StopIteration;
+}
+_147+=step;
+return rval;
+}};
+},imap:function(fun,p,q){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+var _151=m.map(self.iter,m.extend(null,arguments,1));
+var map=m.map;
+var next=self.next;
+return {repr:function(){
+return &quot;imap(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+return fun.apply(this,map(next,_151));
+}};
+},applymap:function(fun,seq,self){
+seq=MochiKit.Iter.iter(seq);
+var m=MochiKit.Base;
+return {repr:function(){
+return &quot;applymap(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+return fun.apply(self,seq.next());
+}};
+},chain:function(p,q){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+if(arguments.length==1){
+return self.iter(arguments[0]);
+}
+var _153=m.map(self.iter,arguments);
+return {repr:function(){
+return &quot;chain(...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+while(_153.length&gt;1){
+try{
+return _153[0].next();
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+_153.shift();
+}
+}
+if(_153.length==1){
+var arg=_153.shift();
+this.next=m.bind(&quot;next&quot;,arg);
+return this.next();
+}
+throw self.StopIteration;
+}};
+},takewhile:function(pred,seq){
+var self=MochiKit.Iter;
+seq=self.iter(seq);
+return {repr:function(){
+return &quot;takewhile(...)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
+var rval=seq.next();
+if(!pred(rval)){
+this.next=function(){
+throw self.StopIteration;
+};
+this.next();
+}
+return rval;
+}};
+},dropwhile:function(pred,seq){
+seq=MochiKit.Iter.iter(seq);
+var m=MochiKit.Base;
+var bind=m.bind;
+return {&quot;repr&quot;:function(){
+return &quot;dropwhile(...)&quot;;
+},&quot;toString&quot;:m.forwardCall(&quot;repr&quot;),&quot;next&quot;:function(){
+while(true){
+var rval=seq.next();
+if(!pred(rval)){
+break;
+}
+}
+this.next=bind(&quot;next&quot;,seq);
+return rval;
+}};
+},_tee:function(_155,sync,_157){
+sync.pos[_155]=-1;
+var m=MochiKit.Base;
+var _158=m.listMin;
+return {repr:function(){
+return &quot;tee(&quot;+_155+&quot;, ...)&quot;;
+},toString:m.forwardCall(&quot;repr&quot;),next:function(){
+var rval;
+var i=sync.pos[_155];
+if(i==sync.max){
+rval=_157.next();
+sync.deque.push(rval);
+sync.max+=1;
+sync.pos[_155]+=1;
+}else{
+rval=sync.deque[i-sync.min];
+sync.pos[_155]+=1;
+if(i==sync.min&amp;&amp;_158(sync.pos)!=sync.min){
+sync.min+=1;
+sync.deque.shift();
+}
+}
+return rval;
+}};
+},tee:function(_159,n){
+var rval=[];
+var sync={&quot;pos&quot;:[],&quot;deque&quot;:[],&quot;max&quot;:-1,&quot;min&quot;:-1};
+if(arguments.length==1){
+n=2;
+}
+var self=MochiKit.Iter;
+_159=self.iter(_159);
+var _tee=self._tee;
+for(var i=0;i&lt;n;i++){
+rval.push(_tee(i,sync,_159));
+}
+return rval;
+},list:function(_161){
+var m=MochiKit.Base;
+if(typeof (_161.slice)==&quot;function&quot;){
+return _161.slice();
+}else{
+if(m.isArrayLike(_161)){
+return m.concat(_161);
+}
+}
+var self=MochiKit.Iter;
+_161=self.iter(_161);
+var rval=[];
+try{
+while(true){
+rval.push(_161.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return rval;
+}
+return undefined;
+},reduce:function(fn,_162,_163){
+var i=0;
+var x=_163;
+var self=MochiKit.Iter;
+_162=self.iter(_162);
+if(arguments.length&lt;3){
+try{
+x=_162.next();
+}
+catch(e){
+if(e==self.StopIteration){
+e=new TypeError(&quot;reduce() of empty sequence with no initial value&quot;);
+}
+throw e;
+}
+i++;
+}
+try{
+while(true){
+x=fn(x,_162.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+return x;
+},range:function(){
+var _165=0;
+var stop=0;
+var step=1;
+if(arguments.length==1){
+stop=arguments[0];
+}else{
+if(arguments.length==2){
+_165=arguments[0];
+stop=arguments[1];
+}else{
+if(arguments.length==3){
+_165=arguments[0];
+stop=arguments[1];
+step=arguments[2];
+}else{
+throw new TypeError(&quot;range() takes 1, 2, or 3 arguments!&quot;);
+}
+}
+}
+if(step===0){
+throw new TypeError(&quot;range() step must not be 0&quot;);
+}
+return {next:function(){
+if((step&gt;0&amp;&amp;_165&gt;=stop)||(step&lt;0&amp;&amp;_165&lt;=stop)){
+throw MochiKit.Iter.StopIteration;
+}
+var rval=_165;
+_165+=step;
+return rval;
+},repr:function(){
+return &quot;range(&quot;+[_165,stop,step].join(&quot;, &quot;)+&quot;)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
+},sum:function(_166,_167){
+var x=_167||0;
+var self=MochiKit.Iter;
+_166=self.iter(_166);
+try{
+while(true){
+x+=_166.next();
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+return x;
+},exhaust:function(_168){
+var self=MochiKit.Iter;
+_168=self.iter(_168);
+try{
+while(true){
+_168.next();
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+},forEach:function(_169,func,self){
+var m=MochiKit.Base;
+if(arguments.length&gt;2){
+func=m.bind(func,self);
+}
+if(m.isArrayLike(_169)){
+try{
+for(var i=0;i&lt;_169.length;i++){
+func(_169[i]);
+}
+}
+catch(e){
+if(e!=MochiKit.Iter.StopIteration){
+throw e;
+}
+}
+}else{
+self=MochiKit.Iter;
+self.exhaust(self.imap(func,_169));
+}
+},every:function(_171,func){
+var self=MochiKit.Iter;
+try{
+self.ifilterfalse(func,_171).next();
+return false;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return true;
+}
+},sorted:function(_172,cmp){
+var rval=MochiKit.Iter.list(_172);
+if(arguments.length==1){
+cmp=MochiKit.Base.compare;
+}
+rval.sort(cmp);
+return rval;
+},reversed:function(_173){
+var rval=MochiKit.Iter.list(_173);
+rval.reverse();
+return rval;
+},some:function(_174,func){
+var self=MochiKit.Iter;
+try{
+self.ifilter(func,_174).next();
+return true;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return false;
+}
+},iextend:function(lst,_175){
+if(MochiKit.Base.isArrayLike(_175)){
+for(var i=0;i&lt;_175.length;i++){
+lst.push(_175[i]);
+}
+}else{
+var self=MochiKit.Iter;
+_175=self.iter(_175);
+try{
+while(true){
+lst.push(_175.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+}
+return lst;
+},groupby:function(_176,_177){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+if(arguments.length&lt;2){
+_177=m.operator.identity;
+}
+_176=self.iter(_176);
+var pk=undefined;
+var k=undefined;
+var v;
+function fetch(){
+v=_176.next();
+k=_177(v);
+}
+function eat(){
+var ret=v;
+v=undefined;
+return ret;
+}
+var _180=true;
+return {repr:function(){
+return &quot;groupby(...)&quot;;
+},next:function(){
+while(k==pk){
+fetch();
+if(_180){
+_180=false;
+break;
+}
+}
+pk=k;
+return [k,{next:function(){
+if(v==undefined){
+fetch();
+}
+if(k!=pk){
+throw self.StopIteration;
+}
+return eat();
+}}];
+}};
+},groupby_as_array:function(_181,_182){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+if(arguments.length&lt;2){
+_182=m.operator.identity;
+}
+_181=self.iter(_181);
+var _183=[];
+var _184=true;
+var _185;
+while(true){
+try{
+var _186=_181.next();
+var key=_182(_186);
+}
+catch(e){
+if(e==self.StopIteration){
+break;
+}
+throw e;
+}
+if(_184||key!=_185){
+var _187=[];
+_183.push([key,_187]);
+}
+_187.push(_186);
+_184=false;
+_185=key;
+}
+return _183;
+},arrayLikeIter:function(_188){
+var i=0;
+return {repr:function(){
+return &quot;arrayLikeIter(...)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
+if(i&gt;=_188.length){
+throw MochiKit.Iter.StopIteration;
+}
+return _188[i++];
+}};
+},hasIterateNext:function(_189){
+return (_189&amp;&amp;typeof (_189.iterateNext)==&quot;function&quot;);
+},iterateNextIter:function(_190){
+return {repr:function(){
+return &quot;iterateNextIter(...)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),next:function(){
+var rval=_190.iterateNext();
+if(rval===null||rval===undefined){
+throw MochiKit.Iter.StopIteration;
+}
+return rval;
+}};
+}});
+MochiKit.Iter.EXPORT_OK=[&quot;iteratorRegistry&quot;,&quot;arrayLikeIter&quot;,&quot;hasIterateNext&quot;,&quot;iterateNextIter&quot;,];
+MochiKit.Iter.EXPORT=[&quot;StopIteration&quot;,&quot;registerIteratorFactory&quot;,&quot;iter&quot;,&quot;count&quot;,&quot;cycle&quot;,&quot;repeat&quot;,&quot;next&quot;,&quot;izip&quot;,&quot;ifilter&quot;,&quot;ifilterfalse&quot;,&quot;islice&quot;,&quot;imap&quot;,&quot;applymap&quot;,&quot;chain&quot;,&quot;takewhile&quot;,&quot;dropwhile&quot;,&quot;tee&quot;,&quot;list&quot;,&quot;reduce&quot;,&quot;range&quot;,&quot;sum&quot;,&quot;exhaust&quot;,&quot;forEach&quot;,&quot;every&quot;,&quot;sorted&quot;,&quot;reversed&quot;,&quot;some&quot;,&quot;iextend&quot;,&quot;groupby&quot;,&quot;groupby_as_array&quot;];
+MochiKit.Iter.__new__=function(){
+var m=MochiKit.Base;
+this.StopIteration=new m.NamedError(&quot;StopIteration&quot;);
+this.iteratorRegistry=new m.AdapterRegistry();
+this.registerIteratorFactory(&quot;arrayLike&quot;,m.isArrayLike,this.arrayLikeIter);
+this.registerIteratorFactory(&quot;iterateNext&quot;,this.hasIterateNext,this.iterateNextIter);
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Iter.__new__();
+if(!MochiKit.__compat__){
+reduce=MochiKit.Iter.reduce;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Iter);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Logging&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Logging depends on MochiKit.Base!&quot;;
+}
+if(typeof (MochiKit.Logging)==&quot;undefined&quot;){
+MochiKit.Logging={};
+}
+MochiKit.Logging.NAME=&quot;MochiKit.Logging&quot;;
+MochiKit.Logging.VERSION=&quot;1.3.1&quot;;
+MochiKit.Logging.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.Logging.toString=function(){
+return this.__repr__();
+};
+MochiKit.Logging.EXPORT=[&quot;LogLevel&quot;,&quot;LogMessage&quot;,&quot;Logger&quot;,&quot;alertListener&quot;,&quot;logger&quot;,&quot;log&quot;,&quot;logError&quot;,&quot;logDebug&quot;,&quot;logFatal&quot;,&quot;logWarning&quot;];
+MochiKit.Logging.EXPORT_OK=[&quot;logLevelAtLeast&quot;,&quot;isLogMessage&quot;,&quot;compareLogMessage&quot;];
+MochiKit.Logging.LogMessage=function(num,_192,info){
+this.num=num;
+this.level=_192;
+this.info=info;
+this.timestamp=new Date();
+};
+MochiKit.Logging.LogMessage.prototype={repr:function(){
+var m=MochiKit.Base;
+return &quot;LogMessage(&quot;+m.map(m.repr,[this.num,this.level,this.info]).join(&quot;, &quot;)+&quot;)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
+MochiKit.Base.update(MochiKit.Logging,{logLevelAtLeast:function(_194){
+var self=MochiKit.Logging;
+if(typeof (_194)==&quot;string&quot;){
+_194=self.LogLevel[_194];
+}
+return function(msg){
+var _196=msg.level;
+if(typeof (_196)==&quot;string&quot;){
+_196=self.LogLevel[_196];
+}
+return _196&gt;=_194;
+};
+},isLogMessage:function(){
+var _197=MochiKit.Logging.LogMessage;
+for(var i=0;i&lt;arguments.length;i++){
+if(!(arguments[i] instanceof _197)){
+return false;
+}
+}
+return true;
+},compareLogMessage:function(a,b){
+return MochiKit.Base.compare([a.level,a.info],[b.level,b.info]);
+},alertListener:function(msg){
+alert(&quot;num: &quot;+msg.num+&quot;\nlevel: &quot;+msg.level+&quot;\ninfo: &quot;+msg.info.join(&quot; &quot;));
+}});
+MochiKit.Logging.Logger=function(_198){
+this.counter=0;
+if(typeof (_198)==&quot;undefined&quot;||_198===null){
+_198=-1;
+}
+this.maxSize=_198;
+this._messages=[];
+this.listeners={};
+this.useNativeConsole=false;
+};
+MochiKit.Logging.Logger.prototype={clear:function(){
+this._messages.splice(0,this._messages.length);
+},logToConsole:function(msg){
+if(typeof (window)!=&quot;undefined&quot;&amp;&amp;window.console&amp;&amp;window.console.log){
+window.console.log(msg);
+}else{
+if(typeof (opera)!=&quot;undefined&quot;&amp;&amp;opera.postError){
+opera.postError(msg);
+}else{
+if(typeof (printfire)==&quot;function&quot;){
+printfire(msg);
+}
+}
+}
+},dispatchListeners:function(msg){
+for(var k in this.listeners){
+var pair=this.listeners[k];
+if(pair.ident!=k||(pair[0]&amp;&amp;!pair[0](msg))){
+continue;
+}
+pair[1](msg);
+}
+},addListener:function(_199,_200,_201){
+if(typeof (_200)==&quot;string&quot;){
+_200=MochiKit.Logging.logLevelAtLeast(_200);
+}
+var _202=[_200,_201];
+_202.ident=_199;
+this.listeners[_199]=_202;
+},removeListener:function(_203){
+delete this.listeners[_203];
+},baseLog:function(_204,_205){
+var msg=new MochiKit.Logging.LogMessage(this.counter,_204,MochiKit.Base.extend(null,arguments,1));
+this._messages.push(msg);
+this.dispatchListeners(msg);
+if(this.useNativeConsole){
+this.logToConsole(msg.level+&quot;: &quot;+msg.info.join(&quot; &quot;));
+}
+this.counter+=1;
+while(this.maxSize&gt;=0&amp;&amp;this._messages.length&gt;this.maxSize){
+this._messages.shift();
+}
+},getMessages:function(_206){
+var _207=0;
+if(!(typeof (_206)==&quot;undefined&quot;||_206===null)){
+_207=Math.max(0,this._messages.length-_206);
+}
+return this._messages.slice(_207);
+},getMessageText:function(_208){
+if(typeof (_208)==&quot;undefined&quot;||_208===null){
+_208=30;
+}
+var _209=this.getMessages(_208);
+if(_209.length){
+var lst=map(function(m){
+return &quot;\n  [&quot;+m.num+&quot;] &quot;+m.level+&quot;: &quot;+m.info.join(&quot; &quot;);
+},_209);
+lst.unshift(&quot;LAST &quot;+_209.length+&quot; MESSAGES:&quot;);
+return lst.join(&quot;&quot;);
+}
+return &quot;&quot;;
+},debuggingBookmarklet:function(_210){
+if(typeof (MochiKit.LoggingPane)==&quot;undefined&quot;){
+alert(this.getMessageText());
+}else{
+MochiKit.LoggingPane.createLoggingPane(_210||false);
+}
+}};
+MochiKit.Logging.__new__=function(){
+this.LogLevel={ERROR:40,FATAL:50,WARNING:30,INFO:20,DEBUG:10};
+var m=MochiKit.Base;
+m.registerComparator(&quot;LogMessage&quot;,this.isLogMessage,this.compareLogMessage);
+var _211=m.partial;
+var _212=this.Logger;
+var _213=_212.prototype.baseLog;
+m.update(this.Logger.prototype,{debug:_211(_213,&quot;DEBUG&quot;),log:_211(_213,&quot;INFO&quot;),error:_211(_213,&quot;ERROR&quot;),fatal:_211(_213,&quot;FATAL&quot;),warning:_211(_213,&quot;WARNING&quot;)});
+var self=this;
+var _214=function(name){
+return function(){
+self.logger[name].apply(self.logger,arguments);
+};
+};
+this.log=_214(&quot;log&quot;);
+this.logError=_214(&quot;error&quot;);
+this.logDebug=_214(&quot;debug&quot;);
+this.logFatal=_214(&quot;fatal&quot;);
+this.logWarning=_214(&quot;warning&quot;);
+this.logger=new _212();
+this.logger.useNativeConsole=true;
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+if(typeof (printfire)==&quot;undefined&quot;&amp;&amp;typeof (document)!=&quot;undefined&quot;&amp;&amp;document.createEvent&amp;&amp;typeof (dispatchEvent)!=&quot;undefined&quot;){
+printfire=function(){
+printfire.args=arguments;
+var ev=document.createEvent(&quot;Events&quot;);
+ev.initEvent(&quot;printfire&quot;,false,true);
+dispatchEvent(ev);
+};
+}
+MochiKit.Logging.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Logging);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.DateTime&quot;);
+}
+if(typeof (MochiKit)==&quot;undefined&quot;){
+MochiKit={};
+}
+if(typeof (MochiKit.DateTime)==&quot;undefined&quot;){
+MochiKit.DateTime={};
+}
+MochiKit.DateTime.NAME=&quot;MochiKit.DateTime&quot;;
+MochiKit.DateTime.VERSION=&quot;1.3.1&quot;;
+MochiKit.DateTime.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.DateTime.toString=function(){
+return this.__repr__();
+};
+MochiKit.DateTime.isoDate=function(str){
+str=str+&quot;&quot;;
+if(typeof (str)!=&quot;string&quot;||str.length===0){
+return null;
+}
+var iso=str.split(&quot;-&quot;);
+if(iso.length===0){
+return null;
+}
+return new Date(iso[0],iso[1]-1,iso[2]);
+};
+MochiKit.DateTime._isoRegexp=/(\d{4,})(?:-(\d{1,2})(?:-(\d{1,2})(?:[T ](\d{1,2}):(\d{1,2})(?::(\d{1,2})(?:\.(\d+))?)?(?:(Z)|([+-])(\d{1,2})(?::(\d{1,2}))?)?)?)?)?/;
+MochiKit.DateTime.isoTimestamp=function(str){
+str=str+&quot;&quot;;
+if(typeof (str)!=&quot;string&quot;||str.length===0){
+return null;
+}
+var res=str.match(MochiKit.DateTime._isoRegexp);
+if(typeof (res)==&quot;undefined&quot;||res===null){
+return null;
+}
+var year,month,day,hour,min,sec,msec;
+year=parseInt(res[1],10);
+if(typeof (res[2])==&quot;undefined&quot;||res[2]===&quot;&quot;){
+return new Date(year);
+}
+month=parseInt(res[2],10)-1;
+day=parseInt(res[3],10);
+if(typeof (res[4])==&quot;undefined&quot;||res[4]===&quot;&quot;){
+return new Date(year,month,day);
+}
+hour=parseInt(res[4],10);
+min=parseInt(res[5],10);
+sec=(typeof (res[6])!=&quot;undefined&quot;&amp;&amp;res[6]!==&quot;&quot;)?parseInt(res[6],10):0;
+if(typeof (res[7])!=&quot;undefined&quot;&amp;&amp;res[7]!==&quot;&quot;){
+msec=Math.round(1000*parseFloat(&quot;0.&quot;+res[7]));
+}else{
+msec=0;
+}
+if((typeof (res[8])==&quot;undefined&quot;||res[8]===&quot;&quot;)&amp;&amp;(typeof (res[9])==&quot;undefined&quot;||res[9]===&quot;&quot;)){
+return new Date(year,month,day,hour,min,sec,msec);
+}
+var ofs;
+if(typeof (res[9])!=&quot;undefined&quot;&amp;&amp;res[9]!==&quot;&quot;){
+ofs=parseInt(res[10],10)*3600000;
+if(typeof (res[11])!=&quot;undefined&quot;&amp;&amp;res[11]!==&quot;&quot;){
+ofs+=parseInt(res[11],10)*60000;
+}
+if(res[9]==&quot;-&quot;){
+ofs=-ofs;
+}
+}else{
+ofs=0;
+}
+return new Date(Date.UTC(year,month,day,hour,min,sec,msec)-ofs);
+};
+MochiKit.DateTime.toISOTime=function(date,_221){
+if(typeof (date)==&quot;undefined&quot;||date===null){
+return null;
+}
+var hh=date.getHours();
+var mm=date.getMinutes();
+var ss=date.getSeconds();
+var lst=[((_221&amp;&amp;(hh&lt;10))?&quot;0&quot;+hh:hh),((mm&lt;10)?&quot;0&quot;+mm:mm),((ss&lt;10)?&quot;0&quot;+ss:ss)];
+return lst.join(&quot;:&quot;);
+};
+MochiKit.DateTime.toISOTimestamp=function(date,_225){
+if(typeof (date)==&quot;undefined&quot;||date===null){
+return null;
+}
+var sep=_225?&quot;T&quot;:&quot; &quot;;
+var foot=_225?&quot;Z&quot;:&quot;&quot;;
+if(_225){
+date=new Date(date.getTime()+(date.getTimezoneOffset()*60000));
+}
+return MochiKit.DateTime.toISODate(date)+sep+MochiKit.DateTime.toISOTime(date,_225)+foot;
+};
+MochiKit.DateTime.toISODate=function(date){
+if(typeof (date)==&quot;undefined&quot;||date===null){
+return null;
+}
+var _228=MochiKit.DateTime._padTwo;
+return [date.getFullYear(),_228(date.getMonth()+1),_228(date.getDate())].join(&quot;-&quot;);
+};
+MochiKit.DateTime.americanDate=function(d){
+d=d+&quot;&quot;;
+if(typeof (d)!=&quot;string&quot;||d.length===0){
+return null;
+}
+var a=d.split(&quot;/&quot;);
+return new Date(a[2],a[0]-1,a[1]);
+};
+MochiKit.DateTime._padTwo=function(n){
+return (n&gt;9)?n:&quot;0&quot;+n;
+};
+MochiKit.DateTime.toPaddedAmericanDate=function(d){
+if(typeof (d)==&quot;undefined&quot;||d===null){
+return null;
+}
+var _230=MochiKit.DateTime._padTwo;
+return [_230(d.getMonth()+1),_230(d.getDate()),d.getFullYear()].join(&quot;/&quot;);
+};
+MochiKit.DateTime.toAmericanDate=function(d){
+if(typeof (d)==&quot;undefined&quot;||d===null){
+return null;
+}
+return [d.getMonth()+1,d.getDate(),d.getFullYear()].join(&quot;/&quot;);
+};
+MochiKit.DateTime.EXPORT=[&quot;isoDate&quot;,&quot;isoTimestamp&quot;,&quot;toISOTime&quot;,&quot;toISOTimestamp&quot;,&quot;toISODate&quot;,&quot;americanDate&quot;,&quot;toPaddedAmericanDate&quot;,&quot;toAmericanDate&quot;];
+MochiKit.DateTime.EXPORT_OK=[];
+MochiKit.DateTime.EXPORT_TAGS={&quot;:common&quot;:MochiKit.DateTime.EXPORT,&quot;:all&quot;:MochiKit.DateTime.EXPORT};
+MochiKit.DateTime.__new__=function(){
+var base=this.NAME+&quot;.&quot;;
+for(var k in this){
+var o=this[k];
+if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
+try{
+o.NAME=base+k;
+}
+catch(e){
+}
+}
+}
+};
+MochiKit.DateTime.__new__();
+if(typeof (MochiKit.Base)!=&quot;undefined&quot;){
+MochiKit.Base._exportSymbols(this,MochiKit.DateTime);
+}else{
+(function(_231,_232){
+if((typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;)||(typeof (MochiKit.__compat__)==&quot;boolean&quot;&amp;&amp;MochiKit.__compat__)){
+var all=_232.EXPORT_TAGS[&quot;:all&quot;];
+for(var i=0;i&lt;all.length;i++){
+_231[all[i]]=_232[all[i]];
+}
+}
+})(this,MochiKit.DateTime);
+}
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Format&quot;);
+}
+if(typeof (MochiKit)==&quot;undefined&quot;){
+MochiKit={};
+}
+if(typeof (MochiKit.Format)==&quot;undefined&quot;){
+MochiKit.Format={};
+}
+MochiKit.Format.NAME=&quot;MochiKit.Format&quot;;
+MochiKit.Format.VERSION=&quot;1.3.1&quot;;
+MochiKit.Format.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.Format.toString=function(){
+return this.__repr__();
+};
+MochiKit.Format._numberFormatter=function(_233,_234,_235,_236,_237,_238,_239,_240,_241){
+return function(num){
+num=parseFloat(num);
+if(typeof (num)==&quot;undefined&quot;||num===null||isNaN(num)){
+return _233;
+}
+var _242=_234;
+var _243=_235;
+if(num&lt;0){
+num=-num;
+}else{
+_242=_242.replace(/-/,&quot;&quot;);
+}
+var me=arguments.callee;
+var fmt=MochiKit.Format.formatLocale(_236);
+if(_237){
+num=num*100;
+_243=fmt.percent+_243;
+}
+num=MochiKit.Format.roundToFixed(num,_238);
+var _245=num.split(/\./);
+var _246=_245[0];
+var frac=(_245.length==1)?&quot;&quot;:_245[1];
+var res=&quot;&quot;;
+while(_246.length&lt;_239){
+_246=&quot;0&quot;+_246;
+}
+if(_240){
+while(_246.length&gt;_240){
+var i=_246.length-_240;
+res=fmt.separator+_246.substring(i,_246.length)+res;
+_246=_246.substring(0,i);
+}
+}
+res=_246+res;
+if(_238&gt;0){
+while(frac.length&lt;_241){
+frac=frac+&quot;0&quot;;
+}
+res=res+fmt.decimal+frac;
+}
+return _242+res+_243;
+};
+};
+MochiKit.Format.numberFormatter=function(_248,_249,_250){
+if(typeof (_249)==&quot;undefined&quot;){
+_249=&quot;&quot;;
+}
+var _251=_248.match(/((?:[0#]+,)?[0#]+)(?:\.([0#]+))?(%)?/);
+if(!_251){
+throw TypeError(&quot;Invalid pattern&quot;);
+}
+var _252=_248.substr(0,_251.index);
+var _253=_248.substr(_251.index+_251[0].length);
+if(_252.search(/-/)==-1){
+_252=_252+&quot;-&quot;;
+}
+var _254=_251[1];
+var frac=(typeof (_251[2])==&quot;string&quot;&amp;&amp;_251[2]!=&quot;&quot;)?_251[2]:&quot;&quot;;
+var _255=(typeof (_251[3])==&quot;string&quot;&amp;&amp;_251[3]!=&quot;&quot;);
+var tmp=_254.split(/,/);
+var _257;
+if(typeof (_250)==&quot;undefined&quot;){
+_250=&quot;default&quot;;
+}
+if(tmp.length==1){
+_257=null;
+}else{
+_257=tmp[1].length;
+}
+var _258=_254.length-_254.replace(/0/g,&quot;&quot;).length;
+var _259=frac.length-frac.replace(/0/g,&quot;&quot;).length;
+var _260=frac.length;
+var rval=MochiKit.Format._numberFormatter(_249,_252,_253,_250,_255,_260,_258,_257,_259);
+var m=MochiKit.Base;
+if(m){
+var fn=arguments.callee;
+var args=m.concat(arguments);
+rval.repr=function(){
+return [self.NAME,&quot;(&quot;,map(m.repr,args).join(&quot;, &quot;),&quot;)&quot;].join(&quot;&quot;);
+};
+}
+return rval;
+};
+MochiKit.Format.formatLocale=function(_262){
+if(typeof (_262)==&quot;undefined&quot;||_262===null){
+_262=&quot;default&quot;;
+}
+if(typeof (_262)==&quot;string&quot;){
+var rval=MochiKit.Format.LOCALE[_262];
+if(typeof (rval)==&quot;string&quot;){
+rval=arguments.callee(rval);
+MochiKit.Format.LOCALE[_262]=rval;
+}
+return rval;
+}else{
+return _262;
+}
+};
+MochiKit.Format.twoDigitAverage=function(_263,_264){
+if(_264){
+var res=_263/_264;
+if(!isNaN(res)){
+return MochiKit.Format.twoDigitFloat(_263/_264);
+}
+}
+return &quot;0&quot;;
+};
+MochiKit.Format.twoDigitFloat=function(_265){
+var sign=(_265&lt;0?&quot;-&quot;:&quot;&quot;);
+var s=Math.floor(Math.abs(_265)*100).toString();
+if(s==&quot;0&quot;){
+return s;
+}
+if(s.length&lt;3){
+while(s.charAt(s.length-1)==&quot;0&quot;){
+s=s.substring(0,s.length-1);
+}
+return sign+&quot;0.&quot;+s;
+}
+var head=sign+s.substring(0,s.length-2);
+var tail=s.substring(s.length-2,s.length);
+if(tail==&quot;00&quot;){
+return head;
+}else{
+if(tail.charAt(1)==&quot;0&quot;){
+return head+&quot;.&quot;+tail.charAt(0);
+}else{
+return head+&quot;.&quot;+tail;
+}
+}
+};
+MochiKit.Format.lstrip=function(str,_270){
+str=str+&quot;&quot;;
+if(typeof (str)!=&quot;string&quot;){
+return null;
+}
+if(!_270){
+return str.replace(/^\s+/,&quot;&quot;);
+}else{
+return str.replace(new RegExp(&quot;^[&quot;+_270+&quot;]+&quot;),&quot;&quot;);
+}
+};
+MochiKit.Format.rstrip=function(str,_271){
+str=str+&quot;&quot;;
+if(typeof (str)!=&quot;string&quot;){
+return null;
+}
+if(!_271){
+return str.replace(/\s+$/,&quot;&quot;);
+}else{
+return str.replace(new RegExp(&quot;[&quot;+_271+&quot;]+$&quot;),&quot;&quot;);
+}
+};
+MochiKit.Format.strip=function(str,_272){
+var self=MochiKit.Format;
+return self.rstrip(self.lstrip(str,_272),_272);
+};
+MochiKit.Format.truncToFixed=function(_273,_274){
+_273=Math.floor(_273*Math.pow(10,_274));
+var res=(_273*Math.pow(10,-_274)).toFixed(_274);
+if(res.charAt(0)==&quot;.&quot;){
+res=&quot;0&quot;+res;
+}
+return res;
+};
+MochiKit.Format.roundToFixed=function(_275,_276){
+return MochiKit.Format.truncToFixed(_275+0.5*Math.pow(10,-_276),_276);
+};
+MochiKit.Format.percentFormat=function(_277){
+return MochiKit.Format.twoDigitFloat(100*_277)+&quot;%&quot;;
+};
+MochiKit.Format.EXPORT=[&quot;truncToFixed&quot;,&quot;roundToFixed&quot;,&quot;numberFormatter&quot;,&quot;formatLocale&quot;,&quot;twoDigitAverage&quot;,&quot;twoDigitFloat&quot;,&quot;percentFormat&quot;,&quot;lstrip&quot;,&quot;rstrip&quot;,&quot;strip&quot;];
+MochiKit.Format.LOCALE={en_US:{separator:&quot;,&quot;,decimal:&quot;.&quot;,percent:&quot;%&quot;},de_DE:{separator:&quot;.&quot;,decimal:&quot;,&quot;,percent:&quot;%&quot;},fr_FR:{separator:&quot; &quot;,decimal:&quot;,&quot;,percent:&quot;%&quot;},&quot;default&quot;:&quot;en_US&quot;};
+MochiKit.Format.EXPORT_OK=[];
+MochiKit.Format.EXPORT_TAGS={&quot;:all&quot;:MochiKit.Format.EXPORT,&quot;:common&quot;:MochiKit.Format.EXPORT};
+MochiKit.Format.__new__=function(){
+var base=this.NAME+&quot;.&quot;;
+var k,v,o;
+for(k in this.LOCALE){
+o=this.LOCALE[k];
+if(typeof (o)==&quot;object&quot;){
+o.repr=function(){
+return this.NAME;
+};
+o.NAME=base+&quot;LOCALE.&quot;+k;
+}
+}
+for(k in this){
+o=this[k];
+if(typeof (o)==&quot;function&quot;&amp;&amp;typeof (o.NAME)==&quot;undefined&quot;){
+try{
+o.NAME=base+k;
+}
+catch(e){
+}
+}
+}
+};
+MochiKit.Format.__new__();
+if(typeof (MochiKit.Base)!=&quot;undefined&quot;){
+MochiKit.Base._exportSymbols(this,MochiKit.Format);
+}else{
+(function(_278,_279){
+if((typeof (JSAN)==&quot;undefined&quot;&amp;&amp;typeof (dojo)==&quot;undefined&quot;)||(typeof (MochiKit.__compat__)==&quot;boolean&quot;&amp;&amp;MochiKit.__compat__)){
+var all=_279.EXPORT_TAGS[&quot;:all&quot;];
+for(var i=0;i&lt;all.length;i++){
+_278[all[i]]=_279[all[i]];
+}
+}
+})(this,MochiKit.Format);
+}
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Async&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Async depends on MochiKit.Base!&quot;;
+}
+if(typeof (MochiKit.Async)==&quot;undefined&quot;){
+MochiKit.Async={};
+}
+MochiKit.Async.NAME=&quot;MochiKit.Async&quot;;
+MochiKit.Async.VERSION=&quot;1.3.1&quot;;
+MochiKit.Async.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.Async.toString=function(){
+return this.__repr__();
+};
+MochiKit.Async.Deferred=function(_280){
+this.chain=[];
+this.id=this._nextId();
+this.fired=-1;
+this.paused=0;
+this.results=[null,null];
+this.canceller=_280;
+this.silentlyCancelled=false;
+this.chained=false;
+};
+MochiKit.Async.Deferred.prototype={repr:function(){
+var _281;
+if(this.fired==-1){
+_281=&quot;unfired&quot;;
+}else{
+if(this.fired===0){
+_281=&quot;success&quot;;
+}else{
+_281=&quot;error&quot;;
+}
+}
+return &quot;Deferred(&quot;+this.id+&quot;, &quot;+_281+&quot;)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;),_nextId:MochiKit.Base.counter(),cancel:function(){
+var self=MochiKit.Async;
+if(this.fired==-1){
+if(this.canceller){
+this.canceller(this);
+}else{
+this.silentlyCancelled=true;
+}
+if(this.fired==-1){
+this.errback(new self.CancelledError(this));
+}
+}else{
+if((this.fired===0)&amp;&amp;(this.results[0] instanceof self.Deferred)){
+this.results[0].cancel();
+}
+}
+},_pause:function(){
+this.paused++;
+},_unpause:function(){
+this.paused--;
+if((this.paused===0)&amp;&amp;(this.fired&gt;=0)){
+this._fire();
+}
+},_continue:function(res){
+this._resback(res);
+this._unpause();
+},_resback:function(res){
+this.fired=((res instanceof Error)?1:0);
+this.results[this.fired]=res;
+this._fire();
+},_check:function(){
+if(this.fired!=-1){
+if(!this.silentlyCancelled){
+throw new MochiKit.Async.AlreadyCalledError(this);
+}
+this.silentlyCancelled=false;
+return;
+}
+},callback:function(res){
+this._check();
+if(res instanceof MochiKit.Async.Deferred){
+throw new Error(&quot;Deferred instances can only be chained if they are the result of a callback&quot;);
+}
+this._resback(res);
+},errback:function(res){
+this._check();
+var self=MochiKit.Async;
+if(res instanceof self.Deferred){
+throw new Error(&quot;Deferred instances can only be chained if they are the result of a callback&quot;);
+}
+if(!(res instanceof Error)){
+res=new self.GenericError(res);
+}
+this._resback(res);
+},addBoth:function(fn){
+if(arguments.length&gt;1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(fn,fn);
+},addCallback:function(fn){
+if(arguments.length&gt;1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(fn,null);
+},addErrback:function(fn){
+if(arguments.length&gt;1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(null,fn);
+},addCallbacks:function(cb,eb){
+if(this.chained){
+throw new Error(&quot;Chained Deferreds can not be re-used&quot;);
+}
+this.chain.push([cb,eb]);
+if(this.fired&gt;=0){
+this._fire();
+}
+return this;
+},_fire:function(){
+var _284=this.chain;
+var _285=this.fired;
+var res=this.results[_285];
+var self=this;
+var cb=null;
+while(_284.length&gt;0&amp;&amp;this.paused===0){
+var pair=_284.shift();
+var f=pair[_285];
+if(f===null){
+continue;
+}
+try{
+res=f(res);
+_285=((res instanceof Error)?1:0);
+if(res instanceof MochiKit.Async.Deferred){
+cb=function(res){
+self._continue(res);
+};
+this._pause();
+}
+}
+catch(err){
+_285=1;
+if(!(err instanceof Error)){
+err=new MochiKit.Async.GenericError(err);
+}
+res=err;
+}
+}
+this.fired=_285;
+this.results[_285]=res;
+if(cb&amp;&amp;this.paused){
+res.addBoth(cb);
+res.chained=true;
+}
+}};
+MochiKit.Base.update(MochiKit.Async,{evalJSONRequest:function(){
+return eval(&quot;(&quot;+arguments[0].responseText+&quot;)&quot;);
+},succeed:function(_287){
+var d=new MochiKit.Async.Deferred();
+d.callback.apply(d,arguments);
+return d;
+},fail:function(_288){
+var d=new MochiKit.Async.Deferred();
+d.errback.apply(d,arguments);
+return d;
+},getXMLHttpRequest:function(){
+var self=arguments.callee;
+if(!self.XMLHttpRequest){
+var _289=[function(){
+return new XMLHttpRequest();
+},function(){
+return new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
+},function(){
+return new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
+},function(){
+return new ActiveXObject(&quot;Msxml2.XMLHTTP.4.0&quot;);
+},function(){
+throw new MochiKit.Async.BrowserComplianceError(&quot;Browser does not support XMLHttpRequest&quot;);
+}];
+for(var i=0;i&lt;_289.length;i++){
+var func=_289[i];
+try{
+self.XMLHttpRequest=func;
+return func();
+}
+catch(e){
+}
+}
+}
+return self.XMLHttpRequest();
+},_nothing:function(){
+},_xhr_onreadystatechange:function(d){
+if(this.readyState==4){
+try{
+this.onreadystatechange=null;
+}
+catch(e){
+try{
+this.onreadystatechange=MochiKit.Async._nothing;
+}
+catch(e){
+}
+}
+var _290=null;
+try{
+_290=this.status;
+if(!_290&amp;&amp;MochiKit.Base.isNotEmpty(this.responseText)){
+_290=304;
+}
+}
+catch(e){
+}
+if(_290==0||_290==200||_290==201||_290==304){
+d.callback(this);
+}else{
+var err=new MochiKit.Async.XMLHttpRequestError(this,&quot;Request failed&quot;);
+if(err.number){
+d.errback(err);
+}else{
+d.errback(err);
+}
+}
+}
+},_xhr_canceller:function(req){
+try{
+req.onreadystatechange=null;
+}
+catch(e){
+try{
+req.onreadystatechange=MochiKit.Async._nothing;
+}
+catch(e){
+}
+}
+req.abort();
+},sendXMLHttpRequest:function(req,_293){
+if(typeof (_293)==&quot;undefined&quot;||_293===null){
+_293=&quot;&quot;;
+}
+var m=MochiKit.Base;
+var self=MochiKit.Async;
+var d=new self.Deferred(m.partial(self._xhr_canceller,req));
+try{
+req.onreadystatechange=m.bind(self._xhr_onreadystatechange,req,d);
+req.send(_293);
+}
+catch(e){
+try{
+req.onreadystatechange=null;
+}
+catch(ignore){
+}
+d.errback(e);
+}
+return d;
+},doSimpleXMLHttpRequest:function(url){
+var self=MochiKit.Async;
+var req=self.getXMLHttpRequest();
+if(arguments.length&gt;1){
+var m=MochiKit.Base;
+var qs=m.queryString.apply(null,m.extend(null,arguments,1));
+if(qs){
+url+=&quot;?&quot;+qs;
+}
+}
+req.open(&quot;GET&quot;,url,true);
+return self.sendXMLHttpRequest(req);
+},loadJSONDoc:function(url){
+var self=MochiKit.Async;
+var d=self.doSimpleXMLHttpRequest.apply(self,arguments);
+d=d.addCallback(self.evalJSONRequest);
+return d;
+},wait:function(_296,_297){
+var d=new MochiKit.Async.Deferred();
+var m=MochiKit.Base;
+if(typeof (_297)!=&quot;undefined&quot;){
+d.addCallback(function(){
+return _297;
+});
+}
+var _298=setTimeout(m.bind(&quot;callback&quot;,d),Math.floor(_296*1000));
+d.canceller=function(){
+try{
+clearTimeout(_298);
+}
+catch(e){
+}
+};
+return d;
+},callLater:function(_299,func){
+var m=MochiKit.Base;
+var _300=m.partial.apply(m,m.extend(null,arguments,1));
+return MochiKit.Async.wait(_299).addCallback(function(res){
+return _300();
+});
+}});
+MochiKit.Async.DeferredLock=function(){
+this.waiting=[];
+this.locked=false;
+this.id=this._nextId();
+};
+MochiKit.Async.DeferredLock.prototype={__class__:MochiKit.Async.DeferredLock,acquire:function(){
+d=new MochiKit.Async.Deferred();
+if(this.locked){
+this.waiting.push(d);
+}else{
+this.locked=true;
+d.callback(this);
+}
+return d;
+},release:function(){
+if(!this.locked){
+throw TypeError(&quot;Tried to release an unlocked DeferredLock&quot;);
+}
+this.locked=false;
+if(this.waiting.length&gt;0){
+this.locked=true;
+this.waiting.shift().callback(this);
+}
+},_nextId:MochiKit.Base.counter(),repr:function(){
+var _301;
+if(this.locked){
+_301=&quot;locked, &quot;+this.waiting.length+&quot; waiting&quot;;
+}else{
+_301=&quot;unlocked&quot;;
+}
+return &quot;DeferredLock(&quot;+this.id+&quot;, &quot;+_301+&quot;)&quot;;
+},toString:MochiKit.Base.forwardCall(&quot;repr&quot;)};
+MochiKit.Async.DeferredList=function(list,_303,_304,_305,_306){
+this.list=list;
+this.resultList=new Array(this.list.length);
+this.chain=[];
+this.id=this._nextId();
+this.fired=-1;
+this.paused=0;
+this.results=[null,null];
+this.canceller=_306;
+this.silentlyCancelled=false;
+if(this.list.length===0&amp;&amp;!_303){
+this.callback(this.resultList);
+}
+this.finishedCount=0;
+this.fireOnOneCallback=_303;
+this.fireOnOneErrback=_304;
+this.consumeErrors=_305;
+var _307=0;
+MochiKit.Base.map(MochiKit.Base.bind(function(d){
+d.addCallback(MochiKit.Base.bind(this._cbDeferred,this),_307,true);
+d.addErrback(MochiKit.Base.bind(this._cbDeferred,this),_307,false);
+_307+=1;
+},this),this.list);
+};
+MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,MochiKit.Async.Deferred.prototype);
+MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,{_cbDeferred:function(_308,_309,_310){
+this.resultList[_308]=[_309,_310];
+this.finishedCount+=1;
+if(this.fired!==0){
+if(_309&amp;&amp;this.fireOnOneCallback){
+this.callback([_308,_310]);
+}else{
+if(!_309&amp;&amp;this.fireOnOneErrback){
+this.errback(_310);
+}else{
+if(this.finishedCount==this.list.length){
+this.callback(this.resultList);
+}
+}
+}
+}
+if(!_309&amp;&amp;this.consumeErrors){
+_310=null;
+}
+return _310;
+}});
+MochiKit.Async.gatherResults=function(_311){
+var d=new MochiKit.Async.DeferredList(_311,false,true,false);
+d.addCallback(function(_312){
+var ret=[];
+for(var i=0;i&lt;_312.length;i++){
+ret.push(_312[i][1]);
+}
+return ret;
+});
+return d;
+};
+MochiKit.Async.maybeDeferred=function(func){
+var self=MochiKit.Async;
+var _313;
+try{
+var r=func.apply(null,MochiKit.Base.extend([],arguments,1));
+if(r instanceof self.Deferred){
+_313=r;
+}else{
+if(r instanceof Error){
+_313=self.fail(r);
+}else{
+_313=self.succeed(r);
+}
+}
+}
+catch(e){
+_313=self.fail(e);
+}
+return _313;
+};
+MochiKit.Async.EXPORT=[&quot;AlreadyCalledError&quot;,&quot;CancelledError&quot;,&quot;BrowserComplianceError&quot;,&quot;GenericError&quot;,&quot;XMLHttpRequestError&quot;,&quot;Deferred&quot;,&quot;succeed&quot;,&quot;fail&quot;,&quot;getXMLHttpRequest&quot;,&quot;doSimpleXMLHttpRequest&quot;,&quot;loadJSONDoc&quot;,&quot;wait&quot;,&quot;callLater&quot;,&quot;sendXMLHttpRequest&quot;,&quot;DeferredLock&quot;,&quot;DeferredList&quot;,&quot;gatherResults&quot;,&quot;maybeDeferred&quot;];
+MochiKit.Async.EXPORT_OK=[&quot;evalJSONRequest&quot;];
+MochiKit.Async.__new__=function(){
+var m=MochiKit.Base;
+var ne=m.partial(m._newNamedError,this);
+ne(&quot;AlreadyCalledError&quot;,function(_316){
+this.deferred=_316;
+});
+ne(&quot;CancelledError&quot;,function(_317){
+this.deferred=_317;
+});
+ne(&quot;BrowserComplianceError&quot;,function(msg){
+this.message=msg;
+});
+ne(&quot;GenericError&quot;,function(msg){
+this.message=msg;
+});
+ne(&quot;XMLHttpRequestError&quot;,function(req,msg){
+this.req=req;
+this.message=msg;
+try{
+this.number=req.status;
+}
+catch(e){
+}
+});
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Async.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Async);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.DOM&quot;);
+dojo.require(&quot;MochiKit.Iter&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Iter&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Iter)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.DOM depends on MochiKit.Iter!&quot;;
+}
+if(typeof (MochiKit.DOM)==&quot;undefined&quot;){
+MochiKit.DOM={};
+}
+MochiKit.DOM.NAME=&quot;MochiKit.DOM&quot;;
+MochiKit.DOM.VERSION=&quot;1.3.1&quot;;
+MochiKit.DOM.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.DOM.toString=function(){
+return this.__repr__();
+};
+MochiKit.DOM.EXPORT=[&quot;formContents&quot;,&quot;currentWindow&quot;,&quot;currentDocument&quot;,&quot;withWindow&quot;,&quot;withDocument&quot;,&quot;registerDOMConverter&quot;,&quot;coerceToDOM&quot;,&quot;createDOM&quot;,&quot;createDOMFunc&quot;,&quot;getNodeAttribute&quot;,&quot;setNodeAttribute&quot;,&quot;updateNodeAttributes&quot;,&quot;appendChildNodes&quot;,&quot;replaceChildNodes&quot;,&quot;removeElement&quot;,&quot;swapDOM&quot;,&quot;BUTTON&quot;,&quot;TT&quot;,&quot;PRE&quot;,&quot;H1&quot;,&quot;H2&quot;,&quot;H3&quot;,&quot;BR&quot;,&quot;CANVAS&quot;,&quot;HR&quot;,&quot;LABEL&quot;,&quot;TEXTAREA&quot;,&quot;FORM&quot;,&quot;STRONG&quot;,&quot;SELECT&quot;,&quot;OPTION&quot;,&quot;OPTGROUP&quot;,&quot;LEGEND&quot;,&quot;FIELDSET&quot;,&quot;P&quot;,&quot;UL&quot;,&quot;OL&quot;,&quot;LI&quot;,&quot;TD&quot;,&quot;TR&quot;,&quot;THEAD&quot;,&quot;TBODY&quot;,&quot;TFOOT&quot;,&quot;TABLE&quot;,&quot;TH&quot;,&quot;INPUT&quot;,&quot;SPAN&quot;,&quot;A&quot;,&quot;DIV&quot;,&quot;IMG&quot;,&quot;getElement&quot;,&quot;$&quot;,&quot;computedStyle&quot;,&quot;getElementsByTagAndClassName&quot;,&quot;addToCallStack&quot;,&quot;addLoadEvent&quot;,&quot;focusOnLoad&quot;,&quot;setElementClass&quot;,&quot;toggleElementClass&quot;,&quot;addElementClass&quot;,&quot;removeElementClass&quot;,&quot;swapElementClass&quot;,&quot;hasElementClass&quot;,&quot;escapeHTML&quot;,&quot;toHTML&quot;,&quot;emitHTML&quot;,&quot;setDisplayForElement&quot;,&quot;hideElement&quot;,&quot;showElement&quot;,&quot;scrapeText&quot;,&quot;elementDimensions&quot;,&quot;elementPosition&quot;,&quot;setElementDimensions&quot;,&quot;setElementPosition&quot;,&quot;getViewportDimensions&quot;,&quot;setOpacity&quot;];
+MochiKit.DOM.EXPORT_OK=[&quot;domConverters&quot;];
+MochiKit.DOM.Dimensions=function(w,h){
+this.w=w;
+this.h=h;
+};
+MochiKit.DOM.Dimensions.prototype.repr=function(){
+var repr=MochiKit.Base.repr;
+return &quot;{w: &quot;+repr(this.w)+&quot;, h: &quot;+repr(this.h)+&quot;}&quot;;
+};
+MochiKit.DOM.Coordinates=function(x,y){
+this.x=x;
+this.y=y;
+};
+MochiKit.DOM.Coordinates.prototype.repr=function(){
+var repr=MochiKit.Base.repr;
+return &quot;{x: &quot;+repr(this.x)+&quot;, y: &quot;+repr(this.y)+&quot;}&quot;;
+};
+MochiKit.DOM.Coordinates.prototype.toString=function(){
+return this.repr();
+};
+MochiKit.Base.update(MochiKit.DOM,{setOpacity:function(elem,o){
+elem=MochiKit.DOM.getElement(elem);
+MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;opacity&quot;:o,&quot;-moz-opacity&quot;:o,&quot;-khtml-opacity&quot;:o,&quot;filter&quot;:&quot; alpha(opacity=&quot;+(o*100)+&quot;)&quot;}});
+},getViewportDimensions:function(){
+var d=new MochiKit.DOM.Dimensions();
+var w=MochiKit.DOM._window;
+var b=MochiKit.DOM._document.body;
+if(w.innerWidth){
+d.w=w.innerWidth;
+d.h=w.innerHeight;
+}else{
+if(b.parentElement.clientWidth){
+d.w=b.parentElement.clientWidth;
+d.h=b.parentElement.clientHeight;
+}else{
+if(b&amp;&amp;b.clientWidth){
+d.w=b.clientWidth;
+d.h=b.clientHeight;
+}
+}
+}
+return d;
+},elementDimensions:function(elem){
+var self=MochiKit.DOM;
+if(typeof (elem.w)==&quot;number&quot;||typeof (elem.h)==&quot;number&quot;){
+return new self.Dimensions(elem.w||0,elem.h||0);
+}
+elem=self.getElement(elem);
+if(!elem){
+return undefined;
+}
+if(self.computedStyle(elem,&quot;display&quot;)!=&quot;none&quot;){
+return new self.Dimensions(elem.offsetWidth||0,elem.offsetHeight||0);
+}
+var s=elem.style;
+var _322=s.visibility;
+var _323=s.position;
+s.visibility=&quot;hidden&quot;;
+s.position=&quot;absolute&quot;;
+s.display=&quot;&quot;;
+var _324=elem.offsetWidth;
+var _325=elem.offsetHeight;
+s.display=&quot;none&quot;;
+s.position=_323;
+s.visibility=_322;
+return new self.Dimensions(_324,_325);
+},elementPosition:function(elem,_326){
+var self=MochiKit.DOM;
+elem=self.getElement(elem);
+if(!elem){
+return undefined;
+}
+var c=new self.Coordinates(0,0);
+if(elem.x&amp;&amp;elem.y){
+c.x+=elem.x||0;
+c.y+=elem.y||0;
+return c;
+}else{
+if(elem.parentNode===null||self.computedStyle(elem,&quot;display&quot;)==&quot;none&quot;){
+return undefined;
+}
+}
+var box=null;
+var _329=null;
+var d=MochiKit.DOM._document;
+var de=d.documentElement;
+var b=d.body;
+if(elem.getBoundingClientRect){
+box=elem.getBoundingClientRect();
+c.x+=box.left+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
+c.y+=box.top+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
+}else{
+if(d.getBoxObjectFor){
+box=d.getBoxObjectFor(elem);
+c.x+=box.x;
+c.y+=box.y;
+}else{
+if(elem.offsetParent){
+c.x+=elem.offsetLeft;
+c.y+=elem.offsetTop;
+_329=elem.offsetParent;
+if(_329!=elem){
+while(_329){
+c.x+=_329.offsetLeft;
+c.y+=_329.offsetTop;
+_329=_329.offsetParent;
+}
+}
+var ua=navigator.userAgent.toLowerCase();
+if((typeof (opera)!=&quot;undefined&quot;&amp;&amp;parseFloat(opera.version())&lt;9)||(ua.indexOf(&quot;safari&quot;)!=-1&amp;&amp;self.computedStyle(elem,&quot;position&quot;)==&quot;absolute&quot;)){
+c.x-=b.offsetLeft;
+c.y-=b.offsetTop;
+}
+}
+}
+}
+if(typeof (_326)!=&quot;undefined&quot;){
+_326=arguments.callee(_326);
+if(_326){
+c.x-=(_326.x||0);
+c.y-=(_326.y||0);
+}
+}
+if(elem.parentNode){
+_329=elem.parentNode;
+}else{
+_329=null;
+}
+while(_329&amp;&amp;_329.tagName!=&quot;BODY&quot;&amp;&amp;_329.tagName!=&quot;HTML&quot;){
+c.x-=_329.scrollLeft;
+c.y-=_329.scrollTop;
+if(_329.parentNode){
+_329=_329.parentNode;
+}else{
+_329=null;
+}
+}
+return c;
+},setElementDimensions:function(elem,_332,_333){
+elem=MochiKit.DOM.getElement(elem);
+if(typeof (_333)==&quot;undefined&quot;){
+_333=&quot;px&quot;;
+}
+MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;width&quot;:_332.w+_333,&quot;height&quot;:_332.h+_333}});
+},setElementPosition:function(elem,_334,_335){
+elem=MochiKit.DOM.getElement(elem);
+if(typeof (_335)==&quot;undefined&quot;){
+_335=&quot;px&quot;;
+}
+MochiKit.DOM.updateNodeAttributes(elem,{&quot;style&quot;:{&quot;left&quot;:_334.x+_335,&quot;top&quot;:_334.y+_335}});
+},currentWindow:function(){
+return MochiKit.DOM._window;
+},currentDocument:function(){
+return MochiKit.DOM._document;
+},withWindow:function(win,func){
+var self=MochiKit.DOM;
+var _337=self._document;
+var _338=self._win;
+var rval;
+try{
+self._window=win;
+self._document=win.document;
+rval=func();
+}
+catch(e){
+self._window=_338;
+self._document=_337;
+throw e;
+}
+self._window=_338;
+self._document=_337;
+return rval;
+},formContents:function(elem){
+var _339=[];
+var _340=[];
+var m=MochiKit.Base;
+var self=MochiKit.DOM;
+if(typeof (elem)==&quot;undefined&quot;||elem===null){
+elem=self._document;
+}else{
+elem=self.getElement(elem);
+}
+m.nodeWalk(elem,function(elem){
+var name=elem.name;
+if(m.isNotEmpty(name)){
+var _341=elem.nodeName;
+if(_341==&quot;INPUT&quot;&amp;&amp;(elem.type==&quot;radio&quot;||elem.type==&quot;checkbox&quot;)&amp;&amp;!elem.checked){
+return null;
+}
+if(_341==&quot;SELECT&quot;){
+if(elem.selectedIndex&gt;=0){
+var opt=elem.options[elem.selectedIndex];
+_339.push(name);
+_340.push((opt.value)?opt.value:opt.text);
+return null;
+}
+_339.push(name);
+_340.push(&quot;&quot;);
+return null;
+}
+if(_341==&quot;FORM&quot;||_341==&quot;P&quot;||_341==&quot;SPAN&quot;||_341==&quot;DIV&quot;){
+return elem.childNodes;
+}
+_339.push(name);
+_340.push(elem.value||&quot;&quot;);
+return null;
+}
+return elem.childNodes;
+});
+return [_339,_340];
+},withDocument:function(doc,func){
+var self=MochiKit.DOM;
+var _344=self._document;
+var rval;
+try{
+self._document=doc;
+rval=func();
+}
+catch(e){
+self._document=_344;
+throw e;
+}
+self._document=_344;
+return rval;
+},registerDOMConverter:function(name,_345,wrap,_346){
+MochiKit.DOM.domConverters.register(name,_345,wrap,_346);
+},coerceToDOM:function(node,ctx){
+var im=MochiKit.Iter;
+var self=MochiKit.DOM;
+var iter=im.iter;
+var _350=im.repeat;
+var imap=im.imap;
+var _352=self.domConverters;
+var _353=self.coerceToDOM;
+var _354=MochiKit.Base.NotFound;
+while(true){
+if(typeof (node)==&quot;undefined&quot;||node===null){
+return null;
+}
+if(typeof (node.nodeType)!=&quot;undefined&quot;&amp;&amp;node.nodeType&gt;0){
+return node;
+}
+if(typeof (node)==&quot;number&quot;||typeof (node)==&quot;bool&quot;){
+node=node.toString();
+}
+if(typeof (node)==&quot;string&quot;){
+return self._document.createTextNode(node);
+}
+if(typeof (node.toDOM)==&quot;function&quot;){
+node=node.toDOM(ctx);
+continue;
+}
+if(typeof (node)==&quot;function&quot;){
+node=node(ctx);
+continue;
+}
+var _355=null;
+try{
+_355=iter(node);
+}
+catch(e){
+}
+if(_355){
+return imap(_353,_355,_350(ctx));
+}
+try{
+node=_352.match(node,ctx);
+continue;
+}
+catch(e){
+if(e!=_354){
+throw e;
+}
+}
+return self._document.createTextNode(node.toString());
+}
+return undefined;
+},setNodeAttribute:function(node,attr,_357){
+var o={};
+o[attr]=_357;
+try{
+return MochiKit.DOM.updateNodeAttributes(node,o);
+}
+catch(e){
+}
+return null;
+},getNodeAttribute:function(node,attr){
+var self=MochiKit.DOM;
+var _358=self.attributeArray.renames[attr];
+node=self.getElement(node);
+try{
+if(_358){
+return node[_358];
+}
+return node.getAttribute(attr);
+}
+catch(e){
+}
+return null;
+},updateNodeAttributes:function(node,_359){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)==&quot;string&quot;){
+elem=self.getElement(node);
+}
+if(_359){
+var _360=MochiKit.Base.updatetree;
+if(self.attributeArray.compliant){
+for(var k in _359){
+var v=_359[k];
+if(typeof (v)==&quot;object&quot;&amp;&amp;typeof (elem[k])==&quot;object&quot;){
+_360(elem[k],v);
+}else{
+if(k.substring(0,2)==&quot;on&quot;){
+if(typeof (v)==&quot;string&quot;){
+v=new Function(v);
+}
+elem[k]=v;
+}else{
+elem.setAttribute(k,v);
+}
+}
+}
+}else{
+var _361=self.attributeArray.renames;
+for(k in _359){
+v=_359[k];
+var _362=_361[k];
+if(k==&quot;style&quot;&amp;&amp;typeof (v)==&quot;string&quot;){
+elem.style.cssText=v;
+}else{
+if(typeof (_362)==&quot;string&quot;){
+elem[_362]=v;
+}else{
+if(typeof (elem[k])==&quot;object&quot;&amp;&amp;typeof (v)==&quot;object&quot;){
+_360(elem[k],v);
+}else{
+if(k.substring(0,2)==&quot;on&quot;){
+if(typeof (v)==&quot;string&quot;){
+v=new Function(v);
+}
+elem[k]=v;
+}else{
+elem.setAttribute(k,v);
+}
+}
+}
+}
+}
+}
+}
+return elem;
+},appendChildNodes:function(node){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)==&quot;string&quot;){
+elem=self.getElement(node);
+}
+var _363=[self.coerceToDOM(MochiKit.Base.extend(null,arguments,1),elem)];
+var _364=MochiKit.Base.concat;
+while(_363.length){
+var n=_363.shift();
+if(typeof (n)==&quot;undefined&quot;||n===null){
+}else{
+if(typeof (n.nodeType)==&quot;number&quot;){
+elem.appendChild(n);
+}else{
+_363=_364(n,_363);
+}
+}
+}
+return elem;
+},replaceChildNodes:function(node){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)==&quot;string&quot;){
+elem=self.getElement(node);
+arguments[0]=elem;
+}
+var _365;
+while((_365=elem.firstChild)){
+elem.removeChild(_365);
+}
+if(arguments.length&lt;2){
+return elem;
+}else{
+return self.appendChildNodes.apply(this,arguments);
+}
+},createDOM:function(name,_366){
+var elem;
+var self=MochiKit.DOM;
+var m=MochiKit.Base;
+if(typeof (_366)==&quot;string&quot;||typeof (_366)==&quot;number&quot;){
+var args=m.extend([name,null],arguments,1);
+return arguments.callee.apply(this,args);
+}
+if(typeof (name)==&quot;string&quot;){
+if(_366&amp;&amp;&quot;name&quot; in _366&amp;&amp;!self.attributeArray.compliant){
+name=(&quot;&lt;&quot;+name+&quot; name=\&quot;&quot;+self.escapeHTML(_366.name)+&quot;\&quot;&gt;&quot;);
+}
+elem=self._document.createElement(name);
+}else{
+elem=name;
+}
+if(_366){
+self.updateNodeAttributes(elem,_366);
+}
+if(arguments.length&lt;=2){
+return elem;
+}else{
+var args=m.extend([elem],arguments,2);
+return self.appendChildNodes.apply(this,args);
+}
+},createDOMFunc:function(){
+var m=MochiKit.Base;
+return m.partial.apply(this,m.extend([MochiKit.DOM.createDOM],arguments));
+},swapDOM:function(dest,src){
+var self=MochiKit.DOM;
+dest=self.getElement(dest);
+var _369=dest.parentNode;
+if(src){
+src=self.getElement(src);
+_369.replaceChild(src,dest);
+}else{
+_369.removeChild(dest);
+}
+return src;
+},getElement:function(id){
+var self=MochiKit.DOM;
+if(arguments.length==1){
+return ((typeof (id)==&quot;string&quot;)?self._document.getElementById(id):id);
+}else{
+return MochiKit.Base.map(self.getElement,arguments);
+}
+},computedStyle:function(_371,_372,_373){
+if(arguments.length==2){
+_373=_372;
+}
+var self=MochiKit.DOM;
+var el=self.getElement(_371);
+var _375=self._document;
+if(!el||el==_375){
+return undefined;
+}
+if(el.currentStyle){
+return el.currentStyle[_372];
+}
+if(typeof (_375.defaultView)==&quot;undefined&quot;){
+return undefined;
+}
+if(_375.defaultView===null){
+return undefined;
+}
+var _376=_375.defaultView.getComputedStyle(el,null);
+if(typeof (_376)==&quot;undefined&quot;||_376===null){
+return undefined;
+}
+return _376.getPropertyValue(_373);
+},getElementsByTagAndClassName:function(_377,_378,_379){
+var self=MochiKit.DOM;
+if(typeof (_377)==&quot;undefined&quot;||_377===null){
+_377=&quot;*&quot;;
+}
+if(typeof (_379)==&quot;undefined&quot;||_379===null){
+_379=self._document;
+}
+_379=self.getElement(_379);
+var _380=(_379.getElementsByTagName(_377)||self._document.all);
+if(typeof (_378)==&quot;undefined&quot;||_378===null){
+return MochiKit.Base.extend(null,_380);
+}
+var _381=[];
+for(var i=0;i&lt;_380.length;i++){
+var _382=_380[i];
+var _383=_382.className.split(&quot; &quot;);
+for(var j=0;j&lt;_383.length;j++){
+if(_383[j]==_378){
+_381.push(_382);
+break;
+}
+}
+}
+return _381;
+},_newCallStack:function(path,once){
+var rval=function(){
+var _386=arguments.callee.callStack;
+for(var i=0;i&lt;_386.length;i++){
+if(_386[i].apply(this,arguments)===false){
+break;
+}
+}
+if(once){
+try{
+this[path]=null;
+}
+catch(e){
+}
+}
+};
+rval.callStack=[];
+return rval;
+},addToCallStack:function(_387,path,func,once){
+var self=MochiKit.DOM;
+var _388=_387[path];
+var _389=_388;
+if(!(typeof (_388)==&quot;function&quot;&amp;&amp;typeof (_388.callStack)==&quot;object&quot;&amp;&amp;_388.callStack!==null)){
+_389=self._newCallStack(path,once);
+if(typeof (_388)==&quot;function&quot;){
+_389.callStack.push(_388);
+}
+_387[path]=_389;
+}
+_389.callStack.push(func);
+},addLoadEvent:function(func){
+var self=MochiKit.DOM;
+self.addToCallStack(self._window,&quot;onload&quot;,func,true);
+},focusOnLoad:function(_390){
+var self=MochiKit.DOM;
+self.addLoadEvent(function(){
+_390=self.getElement(_390);
+if(_390){
+_390.focus();
+}
+});
+},setElementClass:function(_391,_392){
+var self=MochiKit.DOM;
+var obj=self.getElement(_391);
+if(self.attributeArray.compliant){
+obj.setAttribute(&quot;class&quot;,_392);
+}else{
+obj.setAttribute(&quot;className&quot;,_392);
+}
+},toggleElementClass:function(_393){
+var self=MochiKit.DOM;
+for(var i=1;i&lt;arguments.length;i++){
+var obj=self.getElement(arguments[i]);
+if(!self.addElementClass(obj,_393)){
+self.removeElementClass(obj,_393);
+}
+}
+},addElementClass:function(_394,_395){
+var self=MochiKit.DOM;
+var obj=self.getElement(_394);
+var cls=obj.className;
+if(cls.length===0){
+self.setElementClass(obj,_395);
+return true;
+}
+if(cls==_395){
+return false;
+}
+var _397=obj.className.split(&quot; &quot;);
+for(var i=0;i&lt;_397.length;i++){
+if(_397[i]==_395){
+return false;
+}
+}
+self.setElementClass(obj,cls+&quot; &quot;+_395);
+return true;
+},removeElementClass:function(_398,_399){
+var self=MochiKit.DOM;
+var obj=self.getElement(_398);
+var cls=obj.className;
+if(cls.length===0){
+return false;
+}
+if(cls==_399){
+self.setElementClass(obj,&quot;&quot;);
+return true;
+}
+var _400=obj.className.split(&quot; &quot;);
+for(var i=0;i&lt;_400.length;i++){
+if(_400[i]==_399){
+_400.splice(i,1);
+self.setElementClass(obj,_400.join(&quot; &quot;));
+return true;
+}
+}
+return false;
+},swapElementClass:function(_401,_402,_403){
+var obj=MochiKit.DOM.getElement(_401);
+var res=MochiKit.DOM.removeElementClass(obj,_402);
+if(res){
+MochiKit.DOM.addElementClass(obj,_403);
+}
+return res;
+},hasElementClass:function(_404,_405){
+var obj=MochiKit.DOM.getElement(_404);
+var _406=obj.className.split(&quot; &quot;);
+for(var i=1;i&lt;arguments.length;i++){
+var good=false;
+for(var j=0;j&lt;_406.length;j++){
+if(_406[j]==arguments[i]){
+good=true;
+break;
+}
+}
+if(!good){
+return false;
+}
+}
+return true;
+},escapeHTML:function(s){
+return s.replace(/&amp;/g,&quot;&amp;&quot;).replace(/&quot;/g,&quot;&quot;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&gt;/g,&quot;&gt;&quot;);
+},toHTML:function(dom){
+return MochiKit.DOM.emitHTML(dom).join(&quot;&quot;);
+},emitHTML:function(dom,lst){
+if(typeof (lst)==&quot;undefined&quot;||lst===null){
+lst=[];
+}
+var _409=[dom];
+var self=MochiKit.DOM;
+var _410=self.escapeHTML;
+var _411=self.attributeArray;
+while(_409.length){
+dom=_409.pop();
+if(typeof (dom)==&quot;string&quot;){
+lst.push(dom);
+}else{
+if(dom.nodeType==1){
+lst.push(&quot;&lt;&quot;+dom.nodeName.toLowerCase());
+var _412=[];
+var _413=_411(dom);
+for(var i=0;i&lt;_413.length;i++){
+var a=_413[i];
+_412.push([&quot; &quot;,a.name,&quot;=\&quot;&quot;,_410(a.value),&quot;\&quot;&quot;]);
+}
+_412.sort();
+for(i=0;i&lt;_412.length;i++){
+var _414=_412[i];
+for(var j=0;j&lt;_414.length;j++){
+lst.push(_414[j]);
+}
+}
+if(dom.hasChildNodes()){
+lst.push(&quot;&gt;&quot;);
+_409.push(&quot;&lt;/&quot;+dom.nodeName.toLowerCase()+&quot;&gt;&quot;);
+var _415=dom.childNodes;
+for(i=_415.length-1;i&gt;=0;i--){
+_409.push(_415[i]);
+}
+}else{
+lst.push(&quot;/&gt;&quot;);
+}
+}else{
+if(dom.nodeType==3){
+lst.push(_410(dom.nodeValue));
+}
+}
+}
+}
+return lst;
+},setDisplayForElement:function(_416,_417){
+var m=MochiKit.Base;
+var _418=m.extend(null,arguments,1);
+MochiKit.Iter.forEach(m.filter(null,m.map(MochiKit.DOM.getElement,_418)),function(_417){
+_417.style.display=_416;
+});
+},scrapeText:function(node,_419){
+var rval=[];
+(function(node){
+var cn=node.childNodes;
+if(cn){
+for(var i=0;i&lt;cn.length;i++){
+arguments.callee.call(this,cn[i]);
+}
+}
+var _421=node.nodeValue;
+if(typeof (_421)==&quot;string&quot;){
+rval.push(_421);
+}
+})(MochiKit.DOM.getElement(node));
+if(_419){
+return rval;
+}else{
+return rval.join(&quot;&quot;);
+}
+},__new__:function(win){
+var m=MochiKit.Base;
+this._document=document;
+this._window=win;
+this.domConverters=new m.AdapterRegistry();
+var _422=this._document.createElement(&quot;span&quot;);
+var _423;
+if(_422&amp;&amp;_422.attributes&amp;&amp;_422.attributes.length&gt;0){
+var _424=m.filter;
+_423=function(node){
+return _424(_423.ignoreAttrFilter,node.attributes);
+};
+_423.ignoreAttr={};
+MochiKit.Iter.forEach(_422.attributes,function(a){
+_423.ignoreAttr[a.name]=a.value;
+});
+_423.ignoreAttrFilter=function(a){
+return (_423.ignoreAttr[a.name]!=a.value);
+};
+_423.compliant=false;
+_423.renames={&quot;class&quot;:&quot;className&quot;,&quot;checked&quot;:&quot;defaultChecked&quot;,&quot;usemap&quot;:&quot;useMap&quot;,&quot;for&quot;:&quot;htmlFor&quot;};
+}else{
+_423=function(node){
+return node.attributes;
+};
+_423.compliant=true;
+_423.renames={};
+}
+this.attributeArray=_423;
+var _425=this.createDOMFunc;
+this.UL=_425(&quot;ul&quot;);
+this.OL=_425(&quot;ol&quot;);
+this.LI=_425(&quot;li&quot;);
+this.TD=_425(&quot;td&quot;);
+this.TR=_425(&quot;tr&quot;);
+this.TBODY=_425(&quot;tbody&quot;);
+this.THEAD=_425(&quot;thead&quot;);
+this.TFOOT=_425(&quot;tfoot&quot;);
+this.TABLE=_425(&quot;table&quot;);
+this.TH=_425(&quot;th&quot;);
+this.INPUT=_425(&quot;input&quot;);
+this.SPAN=_425(&quot;span&quot;);
+this.A=_425(&quot;a&quot;);
+this.DIV=_425(&quot;div&quot;);
+this.IMG=_425(&quot;img&quot;);
+this.BUTTON=_425(&quot;button&quot;);
+this.TT=_425(&quot;tt&quot;);
+this.PRE=_425(&quot;pre&quot;);
+this.H1=_425(&quot;h1&quot;);
+this.H2=_425(&quot;h2&quot;);
+this.H3=_425(&quot;h3&quot;);
+this.BR=_425(&quot;br&quot;);
+this.HR=_425(&quot;hr&quot;);
+this.LABEL=_425(&quot;label&quot;);
+this.TEXTAREA=_425(&quot;textarea&quot;);
+this.FORM=_425(&quot;form&quot;);
+this.P=_425(&quot;p&quot;);
+this.SELECT=_425(&quot;select&quot;);
+this.OPTION=_425(&quot;option&quot;);
+this.OPTGROUP=_425(&quot;optgroup&quot;);
+this.LEGEND=_425(&quot;legend&quot;);
+this.FIELDSET=_425(&quot;fieldset&quot;);
+this.STRONG=_425(&quot;strong&quot;);
+this.CANVAS=_425(&quot;canvas&quot;);
+this.hideElement=m.partial(this.setDisplayForElement,&quot;none&quot;);
+this.showElement=m.partial(this.setDisplayForElement,&quot;block&quot;);
+this.removeElement=this.swapDOM;
+this.$=this.getElement;
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+}});
+MochiKit.DOM.__new__(((typeof (window)==&quot;undefined&quot;)?this:window));
+if(!MochiKit.__compat__){
+withWindow=MochiKit.DOM.withWindow;
+withDocument=MochiKit.DOM.withDocument;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.DOM);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.LoggingPane&quot;);
+dojo.require(&quot;MochiKit.Logging&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Logging&quot;,[]);
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;||typeof (MochiKit.Logging)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.LoggingPane depends on MochiKit.Base and MochiKit.Logging!&quot;;
+}
+if(typeof (MochiKit.LoggingPane)==&quot;undefined&quot;){
+MochiKit.LoggingPane={};
+}
+MochiKit.LoggingPane.NAME=&quot;MochiKit.LoggingPane&quot;;
+MochiKit.LoggingPane.VERSION=&quot;1.3.1&quot;;
+MochiKit.LoggingPane.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.LoggingPane.toString=function(){
+return this.__repr__();
+};
+MochiKit.LoggingPane.createLoggingPane=function(_426){
+var m=MochiKit.LoggingPane;
+_426=!(!_426);
+if(m._loggingPane&amp;&amp;m._loggingPane.inline!=_426){
+m._loggingPane.closePane();
+m._loggingPane=null;
+}
+if(!m._loggingPane||m._loggingPane.closed){
+m._loggingPane=new m.LoggingPane(_426,MochiKit.Logging.logger);
+}
+return m._loggingPane;
+};
+MochiKit.LoggingPane.LoggingPane=function(_427,_428){
+if(typeof (_428)==&quot;undefined&quot;||_428===null){
+_428=MochiKit.Logging.logger;
+}
+this.logger=_428;
+var _429=MochiKit.Base.update;
+var _430=MochiKit.Base.updatetree;
+var bind=MochiKit.Base.bind;
+var _431=MochiKit.Base.clone;
+var win=window;
+var uid=&quot;_MochiKit_LoggingPane&quot;;
+if(typeof (MochiKit.DOM)!=&quot;undefined&quot;){
+win=MochiKit.DOM.currentWindow();
+}
+if(!_427){
+var url=win.location.href.split(&quot;?&quot;)[0].replace(/[:\/.&gt;&lt;&amp;]/g,&quot;_&quot;);
+var name=uid+&quot;_&quot;+url;
+var nwin=win.open(&quot;&quot;,name,&quot;dependent,resizable,height=200&quot;);
+if(!nwin){
+alert(&quot;Not able to open debugging window due to pop-up blocking.&quot;);
+return undefined;
+}
+nwin.document.write(&quot;&lt;!DOCTYPE HTML PUBLIC \&quot;-//W3C//DTD HTML 4.0 Transitional//EN\&quot; &quot;+&quot;\&quot;<A HREF="http://www.w3.org/TR/html4/loose.dtd\">http://www.w3.org/TR/html4/loose.dtd\</A>&quot;&gt;&quot;+&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;[MochiKit.LoggingPane]&lt;/title&gt;&lt;/head&gt;&quot;+&quot;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;);
+nwin.document.close();
+nwin.document.title+=&quot; &quot;+win.document.title;
+win=nwin;
+}
+var doc=win.document;
+this.doc=doc;
+var _434=doc.getElementById(uid);
+var _435=!!_434;
+if(_434&amp;&amp;typeof (_434.loggingPane)!=&quot;undefined&quot;){
+_434.loggingPane.logger=this.logger;
+_434.loggingPane.buildAndApplyFilter();
+return _434.loggingPane;
+}
+if(_435){
+var _436;
+while((_436=_434.firstChild)){
+_434.removeChild(_436);
+}
+}else{
+_434=doc.createElement(&quot;div&quot;);
+_434.id=uid;
+}
+_434.loggingPane=this;
+var _437=doc.createElement(&quot;input&quot;);
+var _438=doc.createElement(&quot;input&quot;);
+var _439=doc.createElement(&quot;button&quot;);
+var _440=doc.createElement(&quot;button&quot;);
+var _441=doc.createElement(&quot;button&quot;);
+var _442=doc.createElement(&quot;button&quot;);
+var _443=doc.createElement(&quot;div&quot;);
+var _444=doc.createElement(&quot;div&quot;);
+var _445=uid+&quot;_Listener&quot;;
+this.colorTable=_431(this.colorTable);
+var _446=[];
+var _447=null;
+var _448=function(msg){
+var _449=msg.level;
+if(typeof (_449)==&quot;number&quot;){
+_449=MochiKit.Logging.LogLevel[_449];
+}
+return _449;
+};
+var _450=function(msg){
+return msg.info.join(&quot; &quot;);
+};
+var _451=bind(function(msg){
+var _452=_448(msg);
+var text=_450(msg);
+var c=this.colorTable[_452];
+var p=doc.createElement(&quot;span&quot;);
+p.className=&quot;MochiKit-LogMessage MochiKit-LogLevel-&quot;+_452;
+p.style.cssText=&quot;margin: 0px; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; white-space: pre-wrap; white-space: pre-line; word-wrap: break-word; wrap-option: emergency; color: &quot;+c;
+p.appendChild(doc.createTextNode(_452+&quot;: &quot;+text));
+_444.appendChild(p);
+_444.appendChild(doc.createElement(&quot;br&quot;));
+if(_443.offsetHeight&gt;_443.scrollHeight){
+_443.scrollTop=0;
+}else{
+_443.scrollTop=_443.scrollHeight;
+}
+},this);
+var _454=function(msg){
+_446[_446.length]=msg;
+_451(msg);
+};
+var _455=function(){
+var _456,infore;
+try{
+_456=new RegExp(_437.value);
+infore=new RegExp(_438.value);
+}
+catch(e){
+logDebug(&quot;Error in filter regex: &quot;+e.message);
+return null;
+}
+return function(msg){
+return (_456.test(_448(msg))&amp;&amp;infore.test(_450(msg)));
+};
+};
+var _457=function(){
+while(_444.firstChild){
+_444.removeChild(_444.firstChild);
+}
+};
+var _458=function(){
+_446=[];
+_457();
+};
+var _459=bind(function(){
+if(this.closed){
+return;
+}
+this.closed=true;
+if(MochiKit.LoggingPane._loggingPane==this){
+MochiKit.LoggingPane._loggingPane=null;
+}
+this.logger.removeListener(_445);
+_434.loggingPane=null;
+if(_427){
+_434.parentNode.removeChild(_434);
+}else{
+this.win.close();
+}
+},this);
+var _460=function(){
+_457();
+for(var i=0;i&lt;_446.length;i++){
+var msg=_446[i];
+if(_447===null||_447(msg)){
+_451(msg);
+}
+}
+};
+this.buildAndApplyFilter=function(){
+_447=_455();
+_460();
+this.logger.removeListener(_445);
+this.logger.addListener(_445,_447,_454);
+};
+var _461=bind(function(){
+_446=this.logger.getMessages();
+_460();
+},this);
+var _462=bind(function(_463){
+_463=_463||window.event;
+key=_463.which||_463.keyCode;
+if(key==13){
+this.buildAndApplyFilter();
+}
+},this);
+var _464=&quot;display: block; z-index: 1000; left: 0px; bottom: 0px; position: fixed; width: 100%; background-color: white; font: &quot;+this.logFont;
+if(_427){
+_464+=&quot;; height: 10em; border-top: 2px solid black&quot;;
+}else{
+_464+=&quot;; height: 100%;&quot;;
+}
+_434.style.cssText=_464;
+if(!_435){
+doc.body.appendChild(_434);
+}
+_464={&quot;cssText&quot;:&quot;width: 33%; display: inline; font: &quot;+this.logFont};
+_430(_437,{&quot;value&quot;:&quot;FATAL|ERROR|WARNING|INFO|DEBUG&quot;,&quot;onkeypress&quot;:_462,&quot;style&quot;:_464});
+_434.appendChild(_437);
+_430(_438,{&quot;value&quot;:&quot;.*&quot;,&quot;onkeypress&quot;:_462,&quot;style&quot;:_464});
+_434.appendChild(_438);
+_464=&quot;width: 8%; display:inline; font: &quot;+this.logFont;
+_439.appendChild(doc.createTextNode(&quot;Filter&quot;));
+_439.onclick=bind(&quot;buildAndApplyFilter&quot;,this);
+_439.style.cssText=_464;
+_434.appendChild(_439);
+_440.appendChild(doc.createTextNode(&quot;Load&quot;));
+_440.onclick=_461;
+_440.style.cssText=_464;
+_434.appendChild(_440);
+_441.appendChild(doc.createTextNode(&quot;Clear&quot;));
+_441.onclick=_458;
+_441.style.cssText=_464;
+_434.appendChild(_441);
+_442.appendChild(doc.createTextNode(&quot;Close&quot;));
+_442.onclick=_459;
+_442.style.cssText=_464;
+_434.appendChild(_442);
+_443.style.cssText=&quot;overflow: auto; width: 100%&quot;;
+_444.style.cssText=&quot;width: 100%; height: &quot;+(_427?&quot;8em&quot;:&quot;100%&quot;);
+_443.appendChild(_444);
+_434.appendChild(_443);
+this.buildAndApplyFilter();
+_461();
+if(_427){
+this.win=undefined;
+}else{
+this.win=win;
+}
+this.inline=_427;
+this.closePane=_459;
+this.closed=false;
+return this;
+};
+MochiKit.LoggingPane.LoggingPane.prototype={&quot;logFont&quot;:&quot;8pt Verdana,sans-serif&quot;,&quot;colorTable&quot;:{&quot;ERROR&quot;:&quot;red&quot;,&quot;FATAL&quot;:&quot;darkred&quot;,&quot;WARNING&quot;:&quot;blue&quot;,&quot;INFO&quot;:&quot;black&quot;,&quot;DEBUG&quot;:&quot;green&quot;}};
+MochiKit.LoggingPane.EXPORT_OK=[&quot;LoggingPane&quot;];
+MochiKit.LoggingPane.EXPORT=[&quot;createLoggingPane&quot;];
+MochiKit.LoggingPane.__new__=function(){
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:MochiKit.Base.concat(this.EXPORT,this.EXPORT_OK)};
+MochiKit.Base.nameFunctions(this);
+MochiKit.LoggingPane._loggingPane=null;
+};
+MochiKit.LoggingPane.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.LoggingPane);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Color&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Color depends on MochiKit.Base&quot;;
+}
+if(typeof (MochiKit.Color)==&quot;undefined&quot;){
+MochiKit.Color={};
+}
+MochiKit.Color.NAME=&quot;MochiKit.Color&quot;;
+MochiKit.Color.VERSION=&quot;1.3.1&quot;;
+MochiKit.Color.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.Color.toString=function(){
+return this.__repr__();
+};
+MochiKit.Color.Color=function(red,_466,blue,_468){
+if(typeof (_468)==&quot;undefined&quot;||_468===null){
+_468=1;
+}
+this.rgb={r:red,g:_466,b:blue,a:_468};
+};
+MochiKit.Color.Color.prototype={__class__:MochiKit.Color.Color,colorWithAlpha:function(_469){
+var rgb=this.rgb;
+var m=MochiKit.Color;
+return m.Color.fromRGB(rgb.r,rgb.g,rgb.b,_469);
+},colorWithHue:function(hue){
+var hsl=this.asHSL();
+hsl.h=hue;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},colorWithSaturation:function(_473){
+var hsl=this.asHSL();
+hsl.s=_473;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},colorWithLightness:function(_474){
+var hsl=this.asHSL();
+hsl.l=_474;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},darkerColorWithLevel:function(_475){
+var hsl=this.asHSL();
+hsl.l=Math.max(hsl.l-_475,0);
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},lighterColorWithLevel:function(_476){
+var hsl=this.asHSL();
+hsl.l=Math.min(hsl.l+_476,1);
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},blendedColor:function(_477,_478){
+if(typeof (_478)==&quot;undefined&quot;||_478===null){
+_478=0.5;
+}
+var sf=1-_478;
+var s=this.rgb;
+var d=_477.rgb;
+var df=_478;
+return MochiKit.Color.Color.fromRGB((s.r*sf)+(d.r*df),(s.g*sf)+(d.g*df),(s.b*sf)+(d.b*df),(s.a*sf)+(d.a*df));
+},compareRGB:function(_481){
+var a=this.asRGB();
+var b=_481.asRGB();
+return MochiKit.Base.compare([a.r,a.g,a.b,a.a],[b.r,b.g,b.b,b.a]);
+},isLight:function(){
+return this.asHSL().b&gt;0.5;
+},isDark:function(){
+return (!this.isLight());
+},toHSLString:function(){
+var c=this.asHSL();
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._hslString;
+if(!rval){
+var mid=(ccc(c.h,360).toFixed(0)+&quot;,&quot;+ccc(c.s,100).toPrecision(4)+&quot;%&quot;+&quot;,&quot;+ccc(c.l,100).toPrecision(4)+&quot;%&quot;);
+var a=c.a;
+if(a&gt;=1){
+a=1;
+rval=&quot;hsl(&quot;+mid+&quot;)&quot;;
+}else{
+if(a&lt;=0){
+a=0;
+}
+rval=&quot;hsla(&quot;+mid+&quot;,&quot;+a+&quot;)&quot;;
+}
+this._hslString=rval;
+}
+return rval;
+},toRGBString:function(){
+var c=this.rgb;
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._rgbString;
+if(!rval){
+var mid=(ccc(c.r,255).toFixed(0)+&quot;,&quot;+ccc(c.g,255).toFixed(0)+&quot;,&quot;+ccc(c.b,255).toFixed(0));
+if(c.a!=1){
+rval=&quot;rgba(&quot;+mid+&quot;,&quot;+c.a+&quot;)&quot;;
+}else{
+rval=&quot;rgb(&quot;+mid+&quot;)&quot;;
+}
+this._rgbString=rval;
+}
+return rval;
+},asRGB:function(){
+return MochiKit.Base.clone(this.rgb);
+},toHexString:function(){
+var m=MochiKit.Color;
+var c=this.rgb;
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._hexString;
+if(!rval){
+rval=(&quot;#&quot;+m.toColorPart(ccc(c.r,255))+m.toColorPart(ccc(c.g,255))+m.toColorPart(ccc(c.b,255)));
+this._hexString=rval;
+}
+return rval;
+},asHSV:function(){
+var hsv=this.hsv;
+var c=this.rgb;
+if(typeof (hsv)==&quot;undefined&quot;||hsv===null){
+hsv=MochiKit.Color.rgbToHSV(this.rgb);
+this.hsv=hsv;
+}
+return MochiKit.Base.clone(hsv);
+},asHSL:function(){
+var hsl=this.hsl;
+var c=this.rgb;
+if(typeof (hsl)==&quot;undefined&quot;||hsl===null){
+hsl=MochiKit.Color.rgbToHSL(this.rgb);
+this.hsl=hsl;
+}
+return MochiKit.Base.clone(hsl);
+},toString:function(){
+return this.toRGBString();
+},repr:function(){
+var c=this.rgb;
+var col=[c.r,c.g,c.b,c.a];
+return this.__class__.NAME+&quot;(&quot;+col.join(&quot;, &quot;)+&quot;)&quot;;
+}};
+MochiKit.Base.update(MochiKit.Color.Color,{fromRGB:function(red,_486,blue,_487){
+var _488=MochiKit.Color.Color;
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_486=rgb.g;
+blue=rgb.b;
+if(typeof (rgb.a)==&quot;undefined&quot;){
+_487=undefined;
+}else{
+_487=rgb.a;
+}
+}
+return new _488(red,_486,blue,_487);
+},fromHSL:function(hue,_489,_490,_491){
+var m=MochiKit.Color;
+return m.Color.fromRGB(m.hslToRGB.apply(m,arguments));
+},fromHSV:function(hue,_492,_493,_494){
+var m=MochiKit.Color;
+return m.Color.fromRGB(m.hsvToRGB.apply(m,arguments));
+},fromName:function(name){
+var _495=MochiKit.Color.Color;
+if(name.charAt(0)==&quot;\&quot;&quot;){
+name=name.substr(1,name.length-2);
+}
+var _496=_495._namedColors[name.toLowerCase()];
+if(typeof (_496)==&quot;string&quot;){
+return _495.fromHexString(_496);
+}else{
+if(name==&quot;transparent&quot;){
+return _495.transparentColor();
+}
+}
+return null;
+},fromString:function(_497){
+var self=MochiKit.Color.Color;
+var _498=_497.substr(0,3);
+if(_498==&quot;rgb&quot;){
+return self.fromRGBString(_497);
+}else{
+if(_498==&quot;hsl&quot;){
+return self.fromHSLString(_497);
+}else{
+if(_497.charAt(0)==&quot;#&quot;){
+return self.fromHexString(_497);
+}
+}
+}
+return self.fromName(_497);
+},fromHexString:function(_499){
+if(_499.charAt(0)==&quot;#&quot;){
+_499=_499.substring(1);
+}
+var _500=[];
+var i,hex;
+if(_499.length==3){
+for(i=0;i&lt;3;i++){
+hex=_499.substr(i,1);
+_500.push(parseInt(hex+hex,16)/255);
+}
+}else{
+for(i=0;i&lt;6;i+=2){
+hex=_499.substr(i,2);
+_500.push(parseInt(hex,16)/255);
+}
+}
+var _501=MochiKit.Color.Color;
+return _501.fromRGB.apply(_501,_500);
+},_fromColorString:function(pre,_503,_504,_505){
+if(_505.indexOf(pre)===0){
+_505=_505.substring(_505.indexOf(&quot;(&quot;,3)+1,_505.length-1);
+}
+var _506=_505.split(/\s*,\s*/);
+var _507=[];
+for(var i=0;i&lt;_506.length;i++){
+var c=_506[i];
+var val;
+var _508=c.substring(c.length-3);
+if(c.charAt(c.length-1)==&quot;%&quot;){
+val=0.01*parseFloat(c.substring(0,c.length-1));
+}else{
+if(_508==&quot;deg&quot;){
+val=parseFloat(c)/360;
+}else{
+if(_508==&quot;rad&quot;){
+val=parseFloat(c)/(Math.PI*2);
+}else{
+val=_504[i]*parseFloat(c);
+}
+}
+}
+_507.push(val);
+}
+return this[_503].apply(this,_507);
+},fromComputedStyle:function(elem,_509,_510){
+var d=MochiKit.DOM;
+var cls=MochiKit.Color.Color;
+for(elem=d.getElement(elem);elem;elem=elem.parentNode){
+var _511=d.computedStyle.apply(d,arguments);
+if(!_511){
+continue;
+}
+var _512=cls.fromString(_511);
+if(!_512){
+break;
+}
+if(_512.asRGB().a&gt;0){
+return _512;
+}
+}
+return null;
+},fromBackground:function(elem){
+var cls=MochiKit.Color.Color;
+return cls.fromComputedStyle(elem,&quot;backgroundColor&quot;,&quot;background-color&quot;)||cls.whiteColor();
+},fromText:function(elem){
+var cls=MochiKit.Color.Color;
+return cls.fromComputedStyle(elem,&quot;color&quot;,&quot;color&quot;)||cls.blackColor();
+},namedColors:function(){
+return MochiKit.Base.clone(MochiKit.Color.Color._namedColors);
+}});
+MochiKit.Base.update(MochiKit.Color,{clampColorComponent:function(v,_513){
+v*=_513;
+if(v&lt;0){
+return 0;
+}else{
+if(v&gt;_513){
+return _513;
+}else{
+return v;
+}
+}
+},_hslValue:function(n1,n2,hue){
+if(hue&gt;6){
+hue-=6;
+}else{
+if(hue&lt;0){
+hue+=6;
+}
+}
+var val;
+if(hue&lt;1){
+val=n1+(n2-n1)*hue;
+}else{
+if(hue&lt;3){
+val=n2;
+}else{
+if(hue&lt;4){
+val=n1+(n2-n1)*(4-hue);
+}else{
+val=n1;
+}
+}
+}
+return val;
+},hsvToRGB:function(hue,_516,_517,_518){
+if(arguments.length==1){
+var hsv=hue;
+hue=hsv.h;
+_516=hsv.s;
+_517=hsv.v;
+_518=hsv.a;
+}
+var red;
+var _519;
+var blue;
+if(_516===0){
+red=0;
+_519=0;
+blue=0;
+}else{
+var i=Math.floor(hue*6);
+var f=(hue*6)-i;
+var p=_517*(1-_516);
+var q=_517*(1-(_516*f));
+var t=_517*(1-(_516*(1-f)));
+switch(i){
+case 1:
+red=q;
+_519=_517;
+blue=p;
+break;
+case 2:
+red=p;
+_519=_517;
+blue=t;
+break;
+case 3:
+red=p;
+_519=q;
+blue=_517;
+break;
+case 4:
+red=t;
+_519=p;
+blue=_517;
+break;
+case 5:
+red=_517;
+_519=p;
+blue=q;
+break;
+case 6:
+case 0:
+red=_517;
+_519=t;
+blue=p;
+break;
+}
+}
+return {r:red,g:_519,b:blue,a:_518};
+},hslToRGB:function(hue,_521,_522,_523){
+if(arguments.length==1){
+var hsl=hue;
+hue=hsl.h;
+_521=hsl.s;
+_522=hsl.l;
+_523=hsl.a;
+}
+var red;
+var _524;
+var blue;
+if(_521===0){
+red=_522;
+_524=_522;
+blue=_522;
+}else{
+var m2;
+if(_522&lt;=0.5){
+m2=_522*(1+_521);
+}else{
+m2=_522+_521-(_522*_521);
+}
+var m1=(2*_522)-m2;
+var f=MochiKit.Color._hslValue;
+var h6=hue*6;
+red=f(m1,m2,h6+2);
+_524=f(m1,m2,h6);
+blue=f(m1,m2,h6-2);
+}
+return {r:red,g:_524,b:blue,a:_523};
+},rgbToHSV:function(red,_528,blue,_529){
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_528=rgb.g;
+blue=rgb.b;
+_529=rgb.a;
+}
+var max=Math.max(Math.max(red,_528),blue);
+var min=Math.min(Math.min(red,_528),blue);
+var hue;
+var _532;
+var _533=max;
+if(min==max){
+hue=0;
+_532=0;
+}else{
+var _534=(max-min);
+_532=_534/max;
+if(red==max){
+hue=(_528-blue)/_534;
+}else{
+if(_528==max){
+hue=2+((blue-red)/_534);
+}else{
+hue=4+((red-_528)/_534);
+}
+}
+hue/=6;
+if(hue&lt;0){
+hue+=1;
+}
+if(hue&gt;1){
+hue-=1;
+}
+}
+return {h:hue,s:_532,v:_533,a:_529};
+},rgbToHSL:function(red,_535,blue,_536){
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_535=rgb.g;
+blue=rgb.b;
+_536=rgb.a;
+}
+var max=Math.max(red,Math.max(_535,blue));
+var min=Math.min(red,Math.min(_535,blue));
+var hue;
+var _537;
+var _538=(max+min)/2;
+var _539=max-min;
+if(_539===0){
+hue=0;
+_537=0;
+}else{
+if(_538&lt;=0.5){
+_537=_539/(max+min);
+}else{
+_537=_539/(2-max-min);
+}
+if(red==max){
+hue=(_535-blue)/_539;
+}else{
+if(_535==max){
+hue=2+((blue-red)/_539);
+}else{
+hue=4+((red-_535)/_539);
+}
+}
+hue/=6;
+if(hue&lt;0){
+hue+=1;
+}
+if(hue&gt;1){
+hue-=1;
+}
+}
+return {h:hue,s:_537,l:_538,a:_536};
+},toColorPart:function(num){
+num=Math.round(num);
+var _540=num.toString(16);
+if(num&lt;16){
+return &quot;0&quot;+_540;
+}
+return _540;
+},__new__:function(){
+var m=MochiKit.Base;
+this.Color.fromRGBString=m.bind(this.Color._fromColorString,this.Color,&quot;rgb&quot;,&quot;fromRGB&quot;,[1/255,1/255,1/255,1]);
+this.Color.fromHSLString=m.bind(this.Color._fromColorString,this.Color,&quot;hsl&quot;,&quot;fromHSL&quot;,[1/360,0.01,0.01,1]);
+var _541=1/3;
+var _542={black:[0,0,0],blue:[0,0,1],brown:[0.6,0.4,0.2],cyan:[0,1,1],darkGray:[_541,_541,_541],gray:[0.5,0.5,0.5],green:[0,1,0],lightGray:[2*_541,2*_541,2*_541],magenta:[1,0,1],orange:[1,0.5,0],purple:[0.5,0,0.5],red:[1,0,0],transparent:[0,0,0,0],white:[1,1,1],yellow:[1,1,0]};
+var _543=function(name,r,g,b,a){
+var rval=this.fromRGB(r,g,b,a);
+this[name]=function(){
+return rval;
+};
+return rval;
+};
+for(var k in _542){
+var name=k+&quot;Color&quot;;
+var _545=m.concat([_543,this.Color,name],_542[k]);
+this.Color[name]=m.bind.apply(null,_545);
+}
+var _546=function(){
+for(var i=0;i&lt;arguments.length;i++){
+if(!(arguments[i] instanceof Color)){
+return false;
+}
+}
+return true;
+};
+var _547=function(a,b){
+return a.compareRGB(b);
+};
+m.nameFunctions(this);
+m.registerComparator(this.Color.NAME,_546,_547);
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+}});
+MochiKit.Color.EXPORT=[&quot;Color&quot;];
+MochiKit.Color.EXPORT_OK=[&quot;clampColorComponent&quot;,&quot;rgbToHSL&quot;,&quot;hslToRGB&quot;,&quot;rgbToHSV&quot;,&quot;hsvToRGB&quot;,&quot;toColorPart&quot;];
+MochiKit.Color.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Color);
+MochiKit.Color.Color._namedColors={aliceblue:&quot;#f0f8ff&quot;,antiquewhite:&quot;#faebd7&quot;,aqua:&quot;#00ffff&quot;,aquamarine:&quot;#7fffd4&quot;,azure:&quot;#f0ffff&quot;,beige:&quot;#f5f5dc&quot;,bisque:&quot;#ffe4c4&quot;,black:&quot;#000000&quot;,blanchedalmond:&quot;#ffebcd&quot;,blue:&quot;#0000ff&quot;,blueviolet:&quot;#8a2be2&quot;,brown:&quot;#a52a2a&quot;,burlywood:&quot;#deb887&quot;,cadetblue:&quot;#5f9ea0&quot;,chartreuse:&quot;#7fff00&quot;,chocolate:&quot;#d2691e&quot;,coral:&quot;#ff7f50&quot;,cornflowerblue:&quot;#6495ed&quot;,cornsilk:&quot;#fff8dc&quot;,crimson:&quot;#dc143c&quot;,cyan:&quot;#00ffff&quot;,darkblue:&quot;#00008b&quot;,darkcyan:&quot;#008b8b&quot;,darkgoldenrod:&quot;#b8860b&quot;,darkgray:&quot;#a9a9a9&quot;,darkgreen:&quot;#006400&quot;,darkgrey:&quot;#a9a9a9&quot;,darkkhaki:&quot;#bdb76b&quot;,darkmagenta:&quot;#8b008b&quot;,darkolivegreen:&quot;#556b2f&quot;,darkorange:&quot;#ff8c00&quot;,darkorchid:&quot;#9932cc&quot;,darkred:&quot;#8b0000&quot;,darksalmon:&quot;#e9967a&quot;,darkseagreen:&quot;#8fbc8f&quot;,darkslateblue:&quot;#483d8b&quot;,darkslategray:&quot;#2f4f4f&quot;,darkslategrey:&quot;#2f4f4f&quot;,darkturquoise:&quot;#00ced1&quot;,darkviolet:&quot;#9400d3&quot;,deeppink:&quot;#ff1493&quot;,deepskyblue:&quot;#00bfff&quot;,dimgray:&quot;#696969&quot;,dimgrey:&quot;#696969&quot;,dodgerblue:&quot;#1e90ff&quot;,firebrick:&quot;#b22222&quot;,floralwhite:&quot;#fffaf0&quot;,forestgree!
 n:&quot;#228b22&quot;,fuchsia:&quot;#ff00ff&quot;,gainsboro:&quot;#dcdcdc&quot;,ghostwhite:&quot;#f8f8ff&quot;,gold:&quot;#ffd700&quot;,goldenrod:&quot;#daa520&quot;,gray:&quot;#808080&quot;,green:&quot;#008000&quot;,greenyellow:&quot;#adff2f&quot;,grey:&quot;#808080&quot;,honeydew:&quot;#f0fff0&quot;,hotpink:&quot;#ff69b4&quot;,indianred:&quot;#cd5c5c&quot;,indigo:&quot;#4b0082&quot;,ivory:&quot;#fffff0&quot;,khaki:&quot;#f0e68c&quot;,lavender:&quot;#e6e6fa&quot;,lavenderblush:&quot;#fff0f5&quot;,lawngreen:&quot;#7cfc00&quot;,lemonchiffon:&quot;#fffacd&quot;,lightblue:&quot;#add8e6&quot;,lightcoral:&quot;#f08080&quot;,lightcyan:&quot;#e0ffff&quot;,lightgoldenrodyellow:&quot;#fafad2&quot;,lightgray:&quot;#d3d3d3&quot;,lightgreen:&quot;#90ee90&quot;,lightgrey:&quot;#d3d3d3&quot;,lightpink:&quot;#ffb6c1&quot;,lightsalmon:&quot;#ffa07a&quot;,lightseagreen:&quot;#20b2aa&quot;,lightskyblue:&quot;#87cefa&quot;,lightslategray:&quot;#778899&quot;,lightslategrey:&quot;#778899&quot;,lightsteelblue:&quot;#b0c4de&quot;,lightyellow:&quot;#ffffe0&quot;,lime:&quot;#00ff00&quot;,limegreen:&quot;#32cd32&quot;,linen:&quot;#faf0e6&quot;,magenta:&quot;#ff00ff&quot;,maroon:&quot;#800000&quot;,mediumaquamarine:&quot;#66cdaa&quot;,mediumblue:&quot;#0000cd&quot;,mediumorchid:&quot;#ba55d3&quot;,mediumpurple:&quot;#9370db&quot;,mediumseagreen:&quot;#3cb371&quot;,mediumslateblue:&quot;#7b68ee&quot;,mediumspringgreen:&quot;#00fa9a&quot;,mediumturquoise:&quot;#48d1cc!
 &quot;,mediumvioletred:&quot;#c71585&quot;,midnightblue:&quot;#191970&quot;,mintcream:&quot;!
 #f5fffa&quot;
,mistyrose:&quot;#ffe4e1&quot;,moccasin:&quot;#ffe4b5&quot;,navajowhite:&quot;#ffdead&quot;,navy:&quot;#000080&quot;,oldlace:&quot;#fdf5e6&quot;,olive:&quot;#808000&quot;,olivedrab:&quot;#6b8e23&quot;,orange:&quot;#ffa500&quot;,orangered:&quot;#ff4500&quot;,orchid:&quot;#da70d6&quot;,palegoldenrod:&quot;#eee8aa&quot;,palegreen:&quot;#98fb98&quot;,paleturquoise:&quot;#afeeee&quot;,palevioletred:&quot;#db7093&quot;,papayawhip:&quot;#ffefd5&quot;,peachpuff:&quot;#ffdab9&quot;,peru:&quot;#cd853f&quot;,pink:&quot;#ffc0cb&quot;,plum:&quot;#dda0dd&quot;,powderblue:&quot;#b0e0e6&quot;,purple:&quot;#800080&quot;,red:&quot;#ff0000&quot;,rosybrown:&quot;#bc8f8f&quot;,royalblue:&quot;#4169e1&quot;,saddlebrown:&quot;#8b4513&quot;,salmon:&quot;#fa8072&quot;,sandybrown:&quot;#f4a460&quot;,seagreen:&quot;#2e8b57&quot;,seashell:&quot;#fff5ee&quot;,sienna:&quot;#a0522d&quot;,silver:&quot;#c0c0c0&quot;,skyblue:&quot;#87ceeb&quot;,slateblue:&quot;#6a5acd&quot;,slategray:&quot;#708090&quot;,slategrey:&quot;#708090&quot;,snow:&quot;#fffafa&quot;,springgreen:&quot;#00ff7f&quot;,steelblue:&quot;#4682b4&quot;,tan:&quot;#d2b48c&quot;,teal:&quot;#008080&quot;,thistle:&quot;#d8bfd8&quot;,tomato:&quot;#ff6347&quot;,turquoise:&quot;#40e0d0&quot;,violet:&quot;#ee82ee&quot;,wheat:&quot;#f5deb3&quot;,white:&quot;#ffffff&quot;,whitesmoke:&quot;#f5f5f5&quot;,yellow:&quot;#ffff00&quot;,yellowgreen:&quot;#9acd32&quot;};
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Signal&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+dojo.require(&quot;MochiKit.DOM&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+JSAN.use(&quot;MochiKit.DOM&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Signal depends on MochiKit.Base!&quot;;
+}
+try{
+if(typeof (MochiKit.DOM)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Signal depends on MochiKit.DOM!&quot;;
+}
+if(typeof (MochiKit.Signal)==&quot;undefined&quot;){
+MochiKit.Signal={};
+}
+MochiKit.Signal.NAME=&quot;MochiKit.Signal&quot;;
+MochiKit.Signal.VERSION=&quot;1.3.1&quot;;
+MochiKit.Signal._observers=[];
+MochiKit.Signal.Event=function(src,e){
+this._event=e||window.event;
+this._src=src;
+};
+MochiKit.Base.update(MochiKit.Signal.Event.prototype,{__repr__:function(){
+var repr=MochiKit.Base.repr;
+var str=&quot;{event(): &quot;+repr(this.event())+&quot;, src(): &quot;+repr(this.src())+&quot;, type(): &quot;+repr(this.type())+&quot;, target(): &quot;+repr(this.target())+&quot;, modifier(): &quot;+&quot;{alt: &quot;+repr(this.modifier().alt)+&quot;, ctrl: &quot;+repr(this.modifier().ctrl)+&quot;, meta: &quot;+repr(this.modifier().meta)+&quot;, shift: &quot;+repr(this.modifier().shift)+&quot;, any: &quot;+repr(this.modifier().any)+&quot;}&quot;;
+if(this.type()&amp;&amp;this.type().indexOf(&quot;key&quot;)===0){
+str+=&quot;, key(): {code: &quot;+repr(this.key().code)+&quot;, string: &quot;+repr(this.key().string)+&quot;}&quot;;
+}
+if(this.type()&amp;&amp;(this.type().indexOf(&quot;mouse&quot;)===0||this.type().indexOf(&quot;click&quot;)!=-1||this.type()==&quot;contextmenu&quot;)){
+str+=&quot;, mouse(): {page: &quot;+repr(this.mouse().page)+&quot;, client: &quot;+repr(this.mouse().client);
+if(this.type()!=&quot;mousemove&quot;){
+str+=&quot;, button: {left: &quot;+repr(this.mouse().button.left)+&quot;, middle: &quot;+repr(this.mouse().button.middle)+&quot;, right: &quot;+repr(this.mouse().button.right)+&quot;}}&quot;;
+}else{
+str+=&quot;}&quot;;
+}
+}
+if(this.type()==&quot;mouseover&quot;||this.type()==&quot;mouseout&quot;){
+str+=&quot;, relatedTarget(): &quot;+repr(this.relatedTarget());
+}
+str+=&quot;}&quot;;
+return str;
+},toString:function(){
+return this.__repr__();
+},src:function(){
+return this._src;
+},event:function(){
+return this._event;
+},type:function(){
+return this._event.type||undefined;
+},target:function(){
+return this._event.target||this._event.srcElement;
+},relatedTarget:function(){
+if(this.type()==&quot;mouseover&quot;){
+return (this._event.relatedTarget||this._event.fromElement);
+}else{
+if(this.type()==&quot;mouseout&quot;){
+return (this._event.relatedTarget||this._event.toElement);
+}
+}
+return undefined;
+},modifier:function(){
+var m={};
+m.alt=this._event.altKey;
+m.ctrl=this._event.ctrlKey;
+m.meta=this._event.metaKey||false;
+m.shift=this._event.shiftKey;
+m.any=m.alt||m.ctrl||m.shift||m.meta;
+return m;
+},key:function(){
+var k={};
+if(this.type()&amp;&amp;this.type().indexOf(&quot;key&quot;)===0){
+if(this.type()==&quot;keydown&quot;||this.type()==&quot;keyup&quot;){
+k.code=this._event.keyCode;
+k.string=(MochiKit.Signal._specialKeys[k.code]||&quot;KEY_UNKNOWN&quot;);
+return k;
+}else{
+if(this.type()==&quot;keypress&quot;){
+k.code=0;
+k.string=&quot;&quot;;
+if(typeof (this._event.charCode)!=&quot;undefined&quot;&amp;&amp;this._event.charCode!==0&amp;&amp;!MochiKit.Signal._specialMacKeys[this._event.charCode]){
+k.code=this._event.charCode;
+k.string=String.fromCharCode(k.code);
+}else{
+if(this._event.keyCode&amp;&amp;typeof (this._event.charCode)==&quot;undefined&quot;){
+k.code=this._event.keyCode;
+k.string=String.fromCharCode(k.code);
+}
+}
+return k;
+}
+}
+}
+return undefined;
+},mouse:function(){
+var m={};
+var e=this._event;
+if(this.type()&amp;&amp;(this.type().indexOf(&quot;mouse&quot;)===0||this.type().indexOf(&quot;click&quot;)!=-1||this.type()==&quot;contextmenu&quot;)){
+m.client=new MochiKit.DOM.Coordinates(0,0);
+if(e.clientX||e.clientY){
+m.client.x=(!e.clientX||e.clientX&lt;0)?0:e.clientX;
+m.client.y=(!e.clientY||e.clientY&lt;0)?0:e.clientY;
+}
+m.page=new MochiKit.DOM.Coordinates(0,0);
+if(e.pageX||e.pageY){
+m.page.x=(!e.pageX||e.pageX&lt;0)?0:e.pageX;
+m.page.y=(!e.pageY||e.pageY&lt;0)?0:e.pageY;
+}else{
+var de=MochiKit.DOM._document.documentElement;
+var b=MochiKit.DOM._document.body;
+m.page.x=e.clientX+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
+m.page.y=e.clientY+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
+}
+if(this.type()!=&quot;mousemove&quot;){
+m.button={};
+m.button.left=false;
+m.button.right=false;
+m.button.middle=false;
+if(e.which){
+m.button.left=(e.which==1);
+m.button.middle=(e.which==2);
+m.button.right=(e.which==3);
+}else{
+m.button.left=!!(e.button&amp;1);
+m.button.right=!!(e.button&amp;2);
+m.button.middle=!!(e.button&amp;4);
+}
+}
+return m;
+}
+return undefined;
+},stop:function(){
+this.stopPropagation();
+this.preventDefault();
+},stopPropagation:function(){
+if(this._event.stopPropagation){
+this._event.stopPropagation();
+}else{
+this._event.cancelBubble=true;
+}
+},preventDefault:function(){
+if(this._event.preventDefault){
+this._event.preventDefault();
+}else{
+this._event.returnValue=false;
+}
+}});
+MochiKit.Signal._specialMacKeys={3:&quot;KEY_ENTER&quot;,63289:&quot;KEY_NUM_PAD_CLEAR&quot;,63276:&quot;KEY_PAGE_UP&quot;,63277:&quot;KEY_PAGE_DOWN&quot;,63275:&quot;KEY_END&quot;,63273:&quot;KEY_HOME&quot;,63234:&quot;KEY_ARROW_LEFT&quot;,63232:&quot;KEY_ARROW_UP&quot;,63235:&quot;KEY_ARROW_RIGHT&quot;,63233:&quot;KEY_ARROW_DOWN&quot;,63302:&quot;KEY_INSERT&quot;,63272:&quot;KEY_DELETE&quot;};
+for(i=63236;i&lt;=63242;i++){
+MochiKit.Signal._specialMacKeys[i]=&quot;KEY_F&quot;+(i-63236+1);
+}
+MochiKit.Signal._specialKeys={8:&quot;KEY_BACKSPACE&quot;,9:&quot;KEY_TAB&quot;,12:&quot;KEY_NUM_PAD_CLEAR&quot;,13:&quot;KEY_ENTER&quot;,16:&quot;KEY_SHIFT&quot;,17:&quot;KEY_CTRL&quot;,18:&quot;KEY_ALT&quot;,19:&quot;KEY_PAUSE&quot;,20:&quot;KEY_CAPS_LOCK&quot;,27:&quot;KEY_ESCAPE&quot;,32:&quot;KEY_SPACEBAR&quot;,33:&quot;KEY_PAGE_UP&quot;,34:&quot;KEY_PAGE_DOWN&quot;,35:&quot;KEY_END&quot;,36:&quot;KEY_HOME&quot;,37:&quot;KEY_ARROW_LEFT&quot;,38:&quot;KEY_ARROW_UP&quot;,39:&quot;KEY_ARROW_RIGHT&quot;,40:&quot;KEY_ARROW_DOWN&quot;,44:&quot;KEY_PRINT_SCREEN&quot;,45:&quot;KEY_INSERT&quot;,46:&quot;KEY_DELETE&quot;,59:&quot;KEY_SEMICOLON&quot;,91:&quot;KEY_WINDOWS_LEFT&quot;,92:&quot;KEY_WINDOWS_RIGHT&quot;,93:&quot;KEY_SELECT&quot;,106:&quot;KEY_NUM_PAD_ASTERISK&quot;,107:&quot;KEY_NUM_PAD_PLUS_SIGN&quot;,109:&quot;KEY_NUM_PAD_HYPHEN-MINUS&quot;,110:&quot;KEY_NUM_PAD_FULL_STOP&quot;,111:&quot;KEY_NUM_PAD_SOLIDUS&quot;,144:&quot;KEY_NUM_LOCK&quot;,145:&quot;KEY_SCROLL_LOCK&quot;,186:&quot;KEY_SEMICOLON&quot;,187:&quot;KEY_EQUALS_SIGN&quot;,188:&quot;KEY_COMMA&quot;,189:&quot;KEY_HYPHEN-MINUS&quot;,190:&quot;KEY_FULL_STOP&quot;,191:&quot;KEY_SOLIDUS&quot;,192:&quot;KEY_GRAVE_ACCENT&quot;,219:&quot;KEY_LEFT_SQUARE_BRACKET&quot;,220:&quot;KEY_REVERSE_SOLIDUS&quot;,221:&quot;KEY_RIGHT_SQUARE_BRACKET&quot;,222:&quot;KEY_APOSTROPHE&quot;};
+for(var i=48;i&lt;=57;i++){
+MochiKit.Signal._specialKeys[i]=&quot;KEY_&quot;+(i-48);
+}
+for(i=65;i&lt;=90;i++){
+MochiKit.Signal._specialKeys[i]=&quot;KEY_&quot;+String.fromCharCode(i);
+}
+for(i=96;i&lt;=105;i++){
+MochiKit.Signal._specialKeys[i]=&quot;KEY_NUM_PAD_&quot;+(i-96);
+}
+for(i=112;i&lt;=123;i++){
+MochiKit.Signal._specialKeys[i]=&quot;KEY_F&quot;+(i-112+1);
+}
+MochiKit.Base.update(MochiKit.Signal,{__repr__:function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+},toString:function(){
+return this.__repr__();
+},_unloadCache:function(){
+var self=MochiKit.Signal;
+var _548=self._observers;
+for(var i=0;i&lt;_548.length;i++){
+self._disconnect(_548[i]);
+}
+delete self._observers;
+try{
+window.onload=undefined;
+}
+catch(e){
+}
+try{
+window.onunload=undefined;
+}
+catch(e){
+}
+},_listener:function(src,func,obj,_549){
+var E=MochiKit.Signal.Event;
+if(!_549){
+return MochiKit.Base.bind(func,obj);
+}
+obj=obj||src;
+if(typeof (func)==&quot;string&quot;){
+return function(_551){
+obj[func].apply(obj,[new E(src,_551)]);
+};
+}else{
+return function(_552){
+func.apply(obj,[new E(src,_552)]);
+};
+}
+},connect:function(src,sig,_554,_555){
+src=MochiKit.DOM.getElement(src);
+var self=MochiKit.Signal;
+if(typeof (sig)!=&quot;string&quot;){
+throw new Error(&quot;'sig' must be a string&quot;);
+}
+var obj=null;
+var func=null;
+if(typeof (_555)!=&quot;undefined&quot;){
+obj=_554;
+func=_555;
+if(typeof (_555)==&quot;string&quot;){
+if(typeof (_554[_555])!=&quot;function&quot;){
+throw new Error(&quot;'funcOrStr' must be a function on 'objOrFunc'&quot;);
+}
+}else{
+if(typeof (_555)!=&quot;function&quot;){
+throw new Error(&quot;'funcOrStr' must be a function or string&quot;);
+}
+}
+}else{
+if(typeof (_554)!=&quot;function&quot;){
+throw new Error(&quot;'objOrFunc' must be a function if 'funcOrStr' is not given&quot;);
+}else{
+func=_554;
+}
+}
+if(typeof (obj)==&quot;undefined&quot;||obj===null){
+obj=src;
+}
+var _556=!!(src.addEventListener||src.attachEvent);
+var _557=self._listener(src,func,obj,_556);
+if(src.addEventListener){
+src.addEventListener(sig.substr(2),_557,false);
+}else{
+if(src.attachEvent){
+src.attachEvent(sig,_557);
+}
+}
+var _558=[src,sig,_557,_556,_554,_555];
+self._observers.push(_558);
+return _558;
+},_disconnect:function(_559){
+if(!_559[3]){
+return;
+}
+var src=_559[0];
+var sig=_559[1];
+var _560=_559[2];
+if(src.removeEventListener){
+src.removeEventListener(sig.substr(2),_560,false);
+}else{
+if(src.detachEvent){
+src.detachEvent(sig,_560);
+}else{
+throw new Error(&quot;'src' must be a DOM element&quot;);
+}
+}
+},disconnect:function(_561){
+var self=MochiKit.Signal;
+var _562=self._observers;
+var m=MochiKit.Base;
+if(arguments.length&gt;1){
+var src=MochiKit.DOM.getElement(arguments[0]);
+var sig=arguments[1];
+var obj=arguments[2];
+var func=arguments[3];
+for(var i=_562.length-1;i&gt;=0;i--){
+var o=_562[i];
+if(o[0]===src&amp;&amp;o[1]===sig&amp;&amp;o[4]===obj&amp;&amp;o[5]===func){
+self._disconnect(o);
+_562.splice(i,1);
+return true;
+}
+}
+}else{
+var idx=m.findIdentical(_562,_561);
+if(idx&gt;=0){
+self._disconnect(_561);
+_562.splice(idx,1);
+return true;
+}
+}
+return false;
+},disconnectAll:function(src,sig){
+src=MochiKit.DOM.getElement(src);
+var m=MochiKit.Base;
+var _563=m.flattenArguments(m.extend(null,arguments,1));
+var self=MochiKit.Signal;
+var _564=self._disconnect;
+var _565=self._observers;
+if(_563.length===0){
+for(var i=_565.length-1;i&gt;=0;i--){
+var _566=_565[i];
+if(_566[0]===src){
+_564(_566);
+_565.splice(i,1);
+}
+}
+}else{
+var sigs={};
+for(var i=0;i&lt;_563.length;i++){
+sigs[_563[i]]=true;
+}
+for(var i=_565.length-1;i&gt;=0;i--){
+var _566=_565[i];
+if(_566[0]===src&amp;&amp;_566[1] in sigs){
+_564(_566);
+_565.splice(i,1);
+}
+}
+}
+},signal:function(src,sig){
+var _568=MochiKit.Signal._observers;
+src=MochiKit.DOM.getElement(src);
+var args=MochiKit.Base.extend(null,arguments,2);
+var _569=[];
+for(var i=0;i&lt;_568.length;i++){
+var _570=_568[i];
+if(_570[0]===src&amp;&amp;_570[1]===sig){
+try{
+_570[2].apply(src,args);
+}
+catch(e){
+_569.push(e);
+}
+}
+}
+if(_569.length==1){
+throw _569[0];
+}else{
+if(_569.length&gt;1){
+var e=new Error(&quot;Multiple errors thrown in handling 'sig', see errors property&quot;);
+e.errors=_569;
+throw e;
+}
+}
+}});
+MochiKit.Signal.EXPORT_OK=[];
+MochiKit.Signal.EXPORT=[&quot;connect&quot;,&quot;disconnect&quot;,&quot;signal&quot;,&quot;disconnectAll&quot;];
+MochiKit.Signal.__new__=function(win){
+var m=MochiKit.Base;
+this._document=document;
+this._window=win;
+try{
+this.connect(window,&quot;onunload&quot;,this._unloadCache);
+}
+catch(e){
+}
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Signal.__new__(this);
+if(!MochiKit.__compat__){
+connect=MochiKit.Signal.connect;
+disconnect=MochiKit.Signal.disconnect;
+disconnectAll=MochiKit.Signal.disconnectAll;
+signal=MochiKit.Signal.signal;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Signal);
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.Visual&quot;);
+dojo.require(&quot;MochiKit.Base&quot;);
+dojo.require(&quot;MochiKit.DOM&quot;);
+dojo.require(&quot;MochiKit.Color&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+JSAN.use(&quot;MochiKit.DOM&quot;,[]);
+JSAN.use(&quot;MochiKit.Color&quot;,[]);
+}
+try{
+if(typeof (MochiKit.Base)==&quot;undefined&quot;||typeof (MochiKit.DOM)==&quot;undefined&quot;||typeof (MochiKit.Color)==&quot;undefined&quot;){
+throw &quot;&quot;;
+}
+}
+catch(e){
+throw &quot;MochiKit.Visual depends on MochiKit.Base, MochiKit.DOM and MochiKit.Color!&quot;;
+}
+if(typeof (MochiKit.Visual)==&quot;undefined&quot;){
+MochiKit.Visual={};
+}
+MochiKit.Visual.NAME=&quot;MochiKit.Visual&quot;;
+MochiKit.Visual.VERSION=&quot;1.3.1&quot;;
+MochiKit.Visual.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.Visual.toString=function(){
+return this.__repr__();
+};
+MochiKit.Visual._RoundCorners=function(e,_571){
+e=MochiKit.DOM.getElement(e);
+this._setOptions(_571);
+if(this.options.__unstable__wrapElement){
+e=this._doWrap(e);
+}
+var _572=this.options.color;
+var C=MochiKit.Color.Color;
+if(this.options.color==&quot;fromElement&quot;){
+_572=C.fromBackground(e);
+}else{
+if(!(_572 instanceof C)){
+_572=C.fromString(_572);
+}
+}
+this.isTransparent=(_572.asRGB().a&lt;=0);
+var _574=this.options.bgColor;
+if(this.options.bgColor==&quot;fromParent&quot;){
+_574=C.fromBackground(e.offsetParent);
+}else{
+if(!(_574 instanceof C)){
+_574=C.fromString(_574);
+}
+}
+this._roundCornersImpl(e,_572,_574);
+};
+MochiKit.Visual._RoundCorners.prototype={_doWrap:function(e){
+var _575=e.parentNode;
+var doc=MochiKit.DOM.currentDocument();
+if(typeof (doc.defaultView)==&quot;undefined&quot;||doc.defaultView===null){
+return e;
+}
+var _576=doc.defaultView.getComputedStyle(e,null);
+if(typeof (_576)==&quot;undefined&quot;||_576===null){
+return e;
+}
+var _577=MochiKit.DOM.DIV({&quot;style&quot;:{display:&quot;block&quot;,marginTop:_576.getPropertyValue(&quot;padding-top&quot;),marginRight:_576.getPropertyValue(&quot;padding-right&quot;),marginBottom:_576.getPropertyValue(&quot;padding-bottom&quot;),marginLeft:_576.getPropertyValue(&quot;padding-left&quot;),padding:&quot;0px&quot;}});
+_577.innerHTML=e.innerHTML;
+e.innerHTML=&quot;&quot;;
+e.appendChild(_577);
+return e;
+},_roundCornersImpl:function(e,_578,_579){
+if(this.options.border){
+this._renderBorder(e,_579);
+}
+if(this._isTopRounded()){
+this._roundTopCorners(e,_578,_579);
+}
+if(this._isBottomRounded()){
+this._roundBottomCorners(e,_578,_579);
+}
+},_renderBorder:function(el,_580){
+var _581=&quot;1px solid &quot;+this._borderColor(_580);
+var _582=&quot;border-left: &quot;+_581;
+var _583=&quot;border-right: &quot;+_581;
+var _584=&quot;style='&quot;+_582+&quot;;&quot;+_583+&quot;'&quot;;
+el.innerHTML=&quot;&lt;div &quot;+_584+&quot;&gt;&quot;+el.innerHTML+&quot;&lt;/div&gt;&quot;;
+},_roundTopCorners:function(el,_585,_586){
+var _587=this._createCorner(_586);
+for(var i=0;i&lt;this.options.numSlices;i++){
+_587.appendChild(this._createCornerSlice(_585,_586,i,&quot;top&quot;));
+}
+el.style.paddingTop=0;
+el.insertBefore(_587,el.firstChild);
+},_roundBottomCorners:function(el,_588,_589){
+var _590=this._createCorner(_589);
+for(var i=(this.options.numSlices-1);i&gt;=0;i--){
+_590.appendChild(this._createCornerSlice(_588,_589,i,&quot;bottom&quot;));
+}
+el.style.paddingBottom=0;
+el.appendChild(_590);
+},_createCorner:function(_591){
+var dom=MochiKit.DOM;
+return dom.DIV({style:{backgroundColor:_591.toString()}});
+},_createCornerSlice:function(_592,_593,n,_594){
+var _595=MochiKit.DOM.SPAN();
+var _596=_595.style;
+_596.backgroundColor=_592.toString();
+_596.display=&quot;block&quot;;
+_596.height=&quot;1px&quot;;
+_596.overflow=&quot;hidden&quot;;
+_596.fontSize=&quot;1px&quot;;
+var _597=this._borderColor(_592,_593);
+if(this.options.border&amp;&amp;n===0){
+_596.borderTopStyle=&quot;solid&quot;;
+_596.borderTopWidth=&quot;1px&quot;;
+_596.borderLeftWidth=&quot;0px&quot;;
+_596.borderRightWidth=&quot;0px&quot;;
+_596.borderBottomWidth=&quot;0px&quot;;
+_596.height=&quot;0px&quot;;
+_596.borderColor=_597.toString();
+}else{
+if(_597){
+_596.borderColor=_597.toString();
+_596.borderStyle=&quot;solid&quot;;
+_596.borderWidth=&quot;0px 1px&quot;;
+}
+}
+if(!this.options.compact&amp;&amp;(n==(this.options.numSlices-1))){
+_596.height=&quot;2px&quot;;
+}
+this._setMargin(_595,n,_594);
+this._setBorder(_595,n,_594);
+return _595;
+},_setOptions:function(_598){
+this.options={corners:&quot;all&quot;,color:&quot;fromElement&quot;,bgColor:&quot;fromParent&quot;,blend:true,border:false,compact:false,__unstable__wrapElement:false};
+MochiKit.Base.update(this.options,_598);
+this.options.numSlices=(this.options.compact?2:4);
+},_whichSideTop:function(){
+var _599=this.options.corners;
+if(this._hasString(_599,&quot;all&quot;,&quot;top&quot;)){
+return &quot;&quot;;
+}
+var _600=(_599.indexOf(&quot;tl&quot;)!=-1);
+var _601=(_599.indexOf(&quot;tr&quot;)!=-1);
+if(_600&amp;&amp;_601){
+return &quot;&quot;;
+}
+if(_600){
+return &quot;left&quot;;
+}
+if(_601){
+return &quot;right&quot;;
+}
+return &quot;&quot;;
+},_whichSideBottom:function(){
+var _602=this.options.corners;
+if(this._hasString(_602,&quot;all&quot;,&quot;bottom&quot;)){
+return &quot;&quot;;
+}
+var _603=(_602.indexOf(&quot;bl&quot;)!=-1);
+var _604=(_602.indexOf(&quot;br&quot;)!=-1);
+if(_603&amp;&amp;_604){
+return &quot;&quot;;
+}
+if(_603){
+return &quot;left&quot;;
+}
+if(_604){
+return &quot;right&quot;;
+}
+return &quot;&quot;;
+},_borderColor:function(_605,_606){
+if(_605==&quot;transparent&quot;){
+return _606;
+}else{
+if(this.options.border){
+return this.options.border;
+}else{
+if(this.options.blend){
+return _606.blendedColor(_605);
+}
+}
+}
+return &quot;&quot;;
+},_setMargin:function(el,n,_607){
+var _608=this._marginSize(n)+&quot;px&quot;;
+var _609=(_607==&quot;top&quot;?this._whichSideTop():this._whichSideBottom());
+var _610=el.style;
+if(_609==&quot;left&quot;){
+_610.marginLeft=_608;
+_610.marginRight=&quot;0px&quot;;
+}else{
+if(_609==&quot;right&quot;){
+_610.marginRight=_608;
+_610.marginLeft=&quot;0px&quot;;
+}else{
+_610.marginLeft=_608;
+_610.marginRight=_608;
+}
+}
+},_setBorder:function(el,n,_611){
+var _612=this._borderSize(n)+&quot;px&quot;;
+var _613=(_611==&quot;top&quot;?this._whichSideTop():this._whichSideBottom());
+var _614=el.style;
+if(_613==&quot;left&quot;){
+_614.borderLeftWidth=_612;
+_614.borderRightWidth=&quot;0px&quot;;
+}else{
+if(_613==&quot;right&quot;){
+_614.borderRightWidth=_612;
+_614.borderLeftWidth=&quot;0px&quot;;
+}else{
+_614.borderLeftWidth=_612;
+_614.borderRightWidth=_612;
+}
+}
+},_marginSize:function(n){
+if(this.isTransparent){
+return 0;
+}
+var o=this.options;
+if(o.compact&amp;&amp;o.blend){
+var _615=[1,0];
+return _615[n];
+}else{
+if(o.compact){
+var _616=[2,1];
+return _616[n];
+}else{
+if(o.blend){
+var _617=[3,2,1,0];
+return _617[n];
+}else{
+var _618=[5,3,2,1];
+return _618[n];
+}
+}
+}
+},_borderSize:function(n){
+var o=this.options;
+var _619;
+if(o.compact&amp;&amp;(o.blend||this.isTransparent)){
+return 1;
+}else{
+if(o.compact){
+_619=[1,0];
+}else{
+if(o.blend){
+_619=[2,1,1,1];
+}else{
+if(o.border){
+_619=[0,2,0,0];
+}else{
+if(this.isTransparent){
+_619=[5,3,2,1];
+}else{
+return 0;
+}
+}
+}
+}
+}
+return _619[n];
+},_hasString:function(str){
+for(var i=1;i&lt;arguments.length;i++){
+if(str.indexOf(arguments[i])!=-1){
+return true;
+}
+}
+return false;
+},_isTopRounded:function(){
+return this._hasString(this.options.corners,&quot;all&quot;,&quot;top&quot;,&quot;tl&quot;,&quot;tr&quot;);
+},_isBottomRounded:function(){
+return this._hasString(this.options.corners,&quot;all&quot;,&quot;bottom&quot;,&quot;bl&quot;,&quot;br&quot;);
+},_hasSingleTextChild:function(el){
+return (el.childNodes.length==1&amp;&amp;el.childNodes[0].nodeType==3);
+}};
+MochiKit.Visual.roundElement=function(e,_620){
+new MochiKit.Visual._RoundCorners(e,_620);
+};
+MochiKit.Visual.roundClass=function(_621,_622,_623){
+var _624=MochiKit.DOM.getElementsByTagAndClassName(_621,_622);
+for(var i=0;i&lt;_624.length;i++){
+MochiKit.Visual.roundElement(_624[i],_623);
+}
+};
+MochiKit.Visual.Color=MochiKit.Color.Color;
+MochiKit.Visual.getElementsComputedStyle=MochiKit.DOM.computedStyle;
+MochiKit.Visual.__new__=function(){
+var m=MochiKit.Base;
+m.nameFunctions(this);
+this.EXPORT_TAGS={&quot;:common&quot;:this.EXPORT,&quot;:all&quot;:m.concat(this.EXPORT,this.EXPORT_OK)};
+};
+MochiKit.Visual.EXPORT=[&quot;roundElement&quot;,&quot;roundClass&quot;];
+MochiKit.Visual.EXPORT_OK=[];
+MochiKit.Visual.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Visual);
+if(typeof (MochiKit)==&quot;undefined&quot;){
+MochiKit={};
+}
+if(typeof (MochiKit.MochiKit)==&quot;undefined&quot;){
+MochiKit.MochiKit={};
+}
+MochiKit.MochiKit.NAME=&quot;MochiKit.MochiKit&quot;;
+MochiKit.MochiKit.VERSION=&quot;1.3.1&quot;;
+MochiKit.MochiKit.__repr__=function(){
+return &quot;[&quot;+this.NAME+&quot; &quot;+this.VERSION+&quot;]&quot;;
+};
+MochiKit.MochiKit.toString=function(){
+return this.__repr__();
+};
+MochiKit.MochiKit.SUBMODULES=[&quot;Base&quot;,&quot;Iter&quot;,&quot;Logging&quot;,&quot;DateTime&quot;,&quot;Format&quot;,&quot;Async&quot;,&quot;DOM&quot;,&quot;LoggingPane&quot;,&quot;Color&quot;,&quot;Signal&quot;,&quot;Visual&quot;];
+if(typeof (JSAN)!=&quot;undefined&quot;||typeof (dojo)!=&quot;undefined&quot;){
+if(typeof (dojo)!=&quot;undefined&quot;){
+dojo.provide(&quot;MochiKit.MochiKit&quot;);
+dojo.require(&quot;MochiKit.*&quot;);
+}
+if(typeof (JSAN)!=&quot;undefined&quot;){
+JSAN.use(&quot;MochiKit.Base&quot;,[]);
+JSAN.use(&quot;MochiKit.Iter&quot;,[]);
+JSAN.use(&quot;MochiKit.Logging&quot;,[]);
+JSAN.use(&quot;MochiKit.DateTime&quot;,[]);
+JSAN.use(&quot;MochiKit.Format&quot;,[]);
+JSAN.use(&quot;MochiKit.Async&quot;,[]);
+JSAN.use(&quot;MochiKit.DOM&quot;,[]);
+JSAN.use(&quot;MochiKit.LoggingPane&quot;,[]);
+JSAN.use(&quot;MochiKit.Color&quot;,[]);
+JSAN.use(&quot;MochiKit.Signal&quot;,[]);
+JSAN.use(&quot;MochiKit.Visual&quot;,[]);
+}
+(function(){
+var _625=MochiKit.Base.extend;
+var self=MochiKit.MochiKit;
+var _626=self.SUBMODULES;
+var _627=[];
+var _628=[];
+var _629={};
+var i,k,m,all;
+for(i=0;i&lt;_626.length;i++){
+m=MochiKit[_626[i]];
+_625(_627,m.EXPORT);
+_625(_628,m.EXPORT_OK);
+for(k in m.EXPORT_TAGS){
+_629[k]=_625(_629[k],m.EXPORT_TAGS[k]);
+}
+all=m.EXPORT_TAGS[&quot;:all&quot;];
+if(!all){
+all=_625(null,m.EXPORT,m.EXPORT_OK);
+}
+var j;
+for(j=0;j&lt;all.length;j++){
+k=all[j];
+self[k]=m[k];
+}
+}
+self.EXPORT=_627;
+self.EXPORT_OK=_628;
+self.EXPORT_TAGS=_629;
+}());
+}else{
+if(typeof (MochiKit.__compat__)==&quot;undefined&quot;){
+MochiKit.__compat__=true;
+}
+(function(){
+var _630=document.getElementsByTagName(&quot;script&quot;);
+var _631=&quot;<A HREF="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul</A>&quot;;
+var base=null;
+var _632=null;
+var _633={};
+var i;
+for(i=0;i&lt;_630.length;i++){
+var src=_630[i].getAttribute(&quot;src&quot;);
+if(!src){
+continue;
+}
+_633[src]=true;
+if(src.match(/MochiKit.js$/)){
+base=src.substring(0,src.lastIndexOf(&quot;MochiKit.js&quot;));
+_632=_630[i];
+}
+}
+if(base===null){
+return;
+}
+var _634=MochiKit.MochiKit.SUBMODULES;
+for(var i=0;i&lt;_634.length;i++){
+if(MochiKit[_634[i]]){
+continue;
+}
+var uri=base+_634[i]+&quot;.js&quot;;
+if(uri in _633){
+continue;
+}
+if(document.documentElement&amp;&amp;document.documentElement.namespaceURI==_631){
+var s=document.createElementNS(_631,&quot;script&quot;);
+s.setAttribute(&quot;id&quot;,&quot;MochiKit_&quot;+base+_634[i]);
+s.setAttribute(&quot;src&quot;,uri);
+s.setAttribute(&quot;type&quot;,&quot;application/x-javascript&quot;);
+_632.parentNode.appendChild(s);
+}else{
+document.write(&quot;&lt;script src=\&quot;&quot;+uri+&quot;\&quot; type=\&quot;text/javascript\&quot;&gt;&lt;/script&gt;&quot;);
+}
+}
+})();
+}
+
+

Added: trunk/lib/mochi+sarissa/Sarissa.js
===================================================================
--- trunk/lib/mochi+sarissa/Sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,662 @@
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version @sarissa.version@
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * &lt;p&gt;Sarissa is a utility class. Provides &quot;static&quot; methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.&lt;/p&gt;
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = &quot;Document contains no parsing errors&quot;;
+Sarissa.PARSED_EMPTY = &quot;Document is empty&quot;;
+Sarissa.PARSED_UNKNOWN_ERROR = &quot;Not well-formed or other error&quot;;
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = &quot;&quot;;
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation &amp;&amp; true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT &amp;&amp; _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent &amp;&amp; navigator.vendor &amp;&amp; (navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;) != -1 || navigator.vendor.indexOf(&quot;Apple&quot;) != -1));
+var _SARISSA_IS_IE = document.all &amp;&amp; window.ActiveXObject &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;) &gt; -1  &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;) == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == &quot;undefined&quot; &amp;&amp; typeof Document !=&quot;undefined&quot;){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = &quot;xsl:&quot;;
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = &quot;&quot;;
+    var _SARISSA_XMLHTTP_PROGID = &quot;&quot;;
+    var _SARISSA_DOM_XMLWRITER = &quot;&quot;;
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw &quot;Could not retreive a valid progID of Class: &quot; + idList[idList.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XMLHTTP.6.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.DOMDocument.6.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = &quot;&quot;;
+            if(sUri){
+                if(sName.indexOf(&quot;:&quot;) &gt; 1){
+                    prefix = sName.substring(0, sName.indexOf(&quot;:&quot;));
+                    sName = sName.substring(sName.indexOf(&quot;:&quot;)+1); 
+                }else{
+                    prefix = &quot;a&quot; + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('&lt;' + prefix+':'+sName + &quot; xmlns:&quot; + prefix + &quot;=\&quot;&quot; + sUri + &quot;\&quot;&quot; + &quot; /&gt;&quot;);
+            } else {
+                oDoc.loadXML('&lt;' + sName + &quot; /&gt;&quot;);
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = &quot;XML Parsing Error: &quot; + oDoc.parseError.reason + 
+                &quot;\nLocation: &quot; + oDoc.parseError.url + 
+                &quot;\nLine Number &quot; + oDoc.parseError.line + &quot;, Column &quot; + 
+                oDoc.parseError.linepos + 
+                &quot;:\n&quot; + oDoc.parseError.srcText +
+                &quot;\n&quot;;
+            for(var i = 0;  i &lt; oDoc.parseError.linepos;i++){
+                parseErrorText += &quot;-&quot;;
+            };
+            parseErrorText +=  &quot;^\n&quot;;
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        oDoc.setProperty(&quot;SelectionNamespaces&quot;, sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XSLTemplate.6.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * &lt;b&gt;Note:&lt;/b&gt; If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID([&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
+        };
+        xslDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        xslDoc.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url &amp;&amp; xslDoc.selectSingleNode(&quot;//xsl:*[local-name() = 'import' or local-name() = 'include']&quot;) != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == &quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;) { 
+                converted.setProperty(&quot;AllowDocumentFunction&quot;, true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        var output = converted.selectSingleNode(&quot;//xsl:output&quot;);
+        this.outputMethod = output ? output.getAttribute(&quot;method&quot;) : &quot;html&quot;;
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID([&quot;Msxml2.MXXMLWriter.6.0&quot;, &quot;Msxml2.MXXMLWriter.3.0&quot;, &quot;MSXML2.MXXMLWriter&quot;, &quot;MSXML.MXXMLWriter&quot;, &quot;Microsoft.XMLDOM&quot;]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+&quot;&quot;);
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * &lt;b&gt;Note&lt;/b&gt;: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body &amp;&amp; ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '&lt;?xml') {
+                s = s.substring(s.indexOf('?&gt;') + 2);
+            }
+            var xml = ''.concat('&lt;my&gt;', s, '&lt;/my&gt;');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // make value a zero length string if null to allow clearing
+        value = (value) ? value : &quot;&quot;;
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[&quot;&quot;+nsURI]){
+            this.paramsSet[&quot;&quot;+nsURI] = new Array();
+        };
+        this.paramsSet[&quot;&quot;+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || &quot;&quot;;
+        if(this.paramsSet[nsURI] &amp;&amp; this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, &quot;&quot;, nsURI);
+                }else{
+                    this.processor.addParameter(name, &quot;&quot;);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * &lt;p&gt;Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use&lt;/p&gt;
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * &lt;p&gt;Attached by an event handler to the load event. Internal use.&lt;/p&gt;
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * &lt;p&gt;Sets the readyState property of the given DOM Document object.
+         * Internal use.&lt;/p&gt;
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null &amp;&amp; typeof oDoc.onreadystatechange == &quot;function&quot;)
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * &lt;p&gt;Emulate IE's onreadystatechange attribute&lt;/p&gt;
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * &lt;p&gt;Emulates IE's readyState property, which always gives an integer from 0 to 4:&lt;/p&gt;
+                * &lt;ul&gt;&lt;li&gt;1 == LOADING,&lt;/li&gt;
+                * &lt;li&gt;2 == LOADED,&lt;/li&gt;
+                * &lt;li&gt;3 == INTERACTIVE,&lt;/li&gt;
+                * &lt;li&gt;4 == COMPLETED&lt;/li&gt;&lt;/ul&gt;
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener(&quot;load&quot;, _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; window.Document &amp;&amp; !Document.prototype.load &amp;&amp; document.implementation.hasFeature('LS', '3.0')){
+    		//Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * &lt;p&gt;Factory method to obtain a new DOM Document object&lt;/p&gt;
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc &amp;&amp; (sUri || sName) &amp;&amp; !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open(&quot;GET&quot;, &quot;data:text/xml;charset=utf-8,&quot; + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument &amp;&amp; Sarissa.getDomDocument() &amp;&amp; Sarissa.getDomDocument(null, &quot;bar&quot;).xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == &quot;undefined&quot;) &amp;&amp; _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE.
+        * If &lt;code&gt;oNode&lt;/code&gt; is a TextNode, &lt;code&gt;bChildren&lt;/code&gt; is ignored.
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if (oNode.nodeName=='#text') {
+                return document.createTextElement(oNode.data);
+            }
+            else {
+                if(oNode.nodeName == &quot;tbody&quot; || oNode.nodeName == &quot;tr&quot;){
+                    tmp = document.createElement(&quot;table&quot;);
+                }
+                else if(oNode.nodeName == &quot;td&quot;){
+                    tmp = document.createElement(&quot;tr&quot;);
+                }
+                else if(oNode.nodeName == &quot;option&quot;){
+                    tmp = document.createElement(&quot;select&quot;);
+                }
+                else{
+                    tmp = document.createElement(&quot;div&quot;);
+                };
+                if(bChildren){
+                    tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+                }else{
+                    tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+                };
+                return tmp.getElementsByTagName(&quot;*&quot;)[0];
+            };
+            
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * &lt;p&gt;Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.&lt;/p&gt;
+     * &lt;p&gt;Many thanks to Christian Stocker for the initial patch.&lt;/p&gt;
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == &quot;parsererror&quot;){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += &quot;\n&quot; +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName(&quot;parsererror&quot;).length &gt; 0){
+            var parsererror = oDoc.getElementsByTagName(&quot;parsererror&quot;)[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+&quot;\n&quot;;
+        } else if(oDoc.parseError &amp;&amp; oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = &quot;&quot;;
+    var nodes = oNode.childNodes;
+    for(var i=0; i &lt; nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    &amp;&amp; (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    &amp;&amp; Sarissa.getDomDocument 
+    &amp;&amp; Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;, null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
+};
+/**
+ * &lt;p&gt;Deletes all child nodes of the given node&lt;/p&gt;
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * &lt;p&gt; Copies the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != &quot;undefined&quot;)  {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * &lt;p&gt; Moves the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != &quot;undefined&quot;) {
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * &lt;p&gt;Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as &lt;code&gt;array-item&lt;/code&gt; elements, 
+ * using their index/key as the value of the &lt;code&gt;key&lt;/code&gt; attribute.&lt;/p&gt;
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '&lt;' + objectName + '&gt;';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(&quot;&quot;+anyObject);
+        isLeaf = true;
+    }else{
+        s += &quot;\n&quot;;
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?&quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot;:name), indentSpace + &quot;   &quot;);
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
+        .replace(/&lt;/g, &quot;&lt;&quot;)
+        .replace(/&gt;/g, &quot;&gt;&quot;)
+        .replace(/&quot;/g, &quot;&quot;&quot;)
+        .replace(/'/g, &quot;&apos;&quot;);
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,&quot;'&quot;)
+        .replace(/&quot;/g,&quot;\&quot;&quot;)
+        .replace(/&gt;/g,&quot;&gt;&quot;)
+        .replace(/&lt;/g,&quot;&lt;&quot;)
+        .replace(/&amp;/g,&quot;&amp;&quot;);
+};
+//   EOF

Added: trunk/lib/mochi+sarissa/Sarissa_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Sarissa_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Sarissa_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,425 @@
+function Sarissa(){
+}
+Sarissa.PARSED_OK=&quot;Document contains no parsing errors&quot;;
+Sarissa.PARSED_EMPTY=&quot;Document is empty&quot;;
+Sarissa.PARSED_UNKNOWN_ERROR=&quot;Not well-formed or other error&quot;;
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM=&quot;&quot;;
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&amp;&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&amp;&amp;document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&amp;&amp;document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&amp;&amp;_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&amp;&amp;navigator.vendor&amp;&amp;(navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;)!=-1||navigator.vendor.indexOf(&quot;Apple&quot;)!=-1));
+var _SARISSA_IS_IE=document.all&amp;&amp;window.ActiveXObject&amp;&amp;navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;)&gt;-1&amp;&amp;navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;)==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument==&quot;undefined&quot;&amp;&amp;typeof Document!=&quot;undefined&quot;){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM=&quot;xsl:&quot;;
+var _SARISSA_DOM_PROGID=&quot;&quot;;
+var _SARISSA_XMLHTTP_PROGID=&quot;&quot;;
+var _SARISSA_DOM_XMLWRITER=&quot;&quot;;
+Sarissa.pickRecentProgID=function(_1){
+var _2=false;
+for(var i=0;i&lt;_1.length&amp;&amp;!_2;i++){
+try{
+var _4=new ActiveXObject(_1[i]);
+o2Store=_1[i];
+_2=true;
+}
+catch(objException){
+}
+}
+if(!_2){
+throw &quot;Could not retreive a valid progID of Class: &quot;+_1[_1.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
+}
+_1=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.XMLHTTP.6.0&quot;,&quot;MSXML2.XMLHTTP.3.0&quot;,&quot;MSXML2.XMLHTTP&quot;,&quot;Microsoft.XMLHTTP&quot;]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_5,_6){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.DOMDocument.6.0&quot;,&quot;Msxml2.DOMDocument.3.0&quot;,&quot;MSXML2.DOMDocument&quot;,&quot;MSXML.DOMDocument&quot;,&quot;Microsoft.XMLDOM&quot;]);
+}
+var _7=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_6){
+var _8=&quot;&quot;;
+if(_5){
+if(_6.indexOf(&quot;:&quot;)&gt;1){
+_8=_6.substring(0,_6.indexOf(&quot;:&quot;));
+_6=_6.substring(_6.indexOf(&quot;:&quot;)+1);
+}else{
+_8=&quot;a&quot;+(_sarissa_iNsCounter++);
+}
+}
+if(_5){
+_7.loadXML(&quot;&lt;&quot;+_8+&quot;:&quot;+_6+&quot; xmlns:&quot;+_8+&quot;=\&quot;&quot;+_5+&quot;\&quot;&quot;+&quot; /&gt;&quot;);
+}else{
+_7.loadXML(&quot;&lt;&quot;+_6+&quot; /&gt;&quot;);
+}
+}
+return _7;
+};
+Sarissa.getParseErrorText=function(_9){
+var _a=Sarissa.PARSED_OK;
+if(_9.parseError.errorCode!=0){
+_a=&quot;XML Parsing Error: &quot;+_9.parseError.reason+&quot;\nLocation: &quot;+_9.parseError.url+&quot;\nLine Number &quot;+_9.parseError.line+&quot;, Column &quot;+_9.parseError.linepos+&quot;:\n&quot;+_9.parseError.srcText+&quot;\n&quot;;
+for(var i=0;i&lt;_9.parseError.linepos;i++){
+_a+=&quot;-&quot;;
+}
+_a+=&quot;^\n&quot;;
+}else{
+if(_9.documentElement==null){
+_a=Sarissa.PARSED_EMPTY;
+}
+}
+return _a;
+};
+Sarissa.setXpathNamespaces=function(_c,_d){
+_c.setProperty(&quot;SelectionLanguage&quot;,&quot;XPath&quot;);
+_c.setProperty(&quot;SelectionNamespaces&quot;,_d);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID([&quot;Msxml2.XSLTemplate.6.0&quot;,&quot;MSXML2.XSLTemplate.3.0&quot;]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_e){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID([&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;,&quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
+}
+_e.setProperty(&quot;SelectionLanguage&quot;,&quot;XPath&quot;);
+_e.setProperty(&quot;SelectionNamespaces&quot;,&quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+var _f=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_e.url&amp;&amp;_e.selectSingleNode(&quot;//xsl:*[local-name() = 'import' or local-name() = 'include']&quot;)!=null){
+_f.async=false;
+if(_SARISSA_THREADEDDOM_PROGID==&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;){
+_f.setProperty(&quot;AllowDocumentFunction&quot;,true);
+_f.resolveExternals=true;
+}
+_f.load(_e.url);
+}else{
+_f.loadXML(_e.xml);
+}
+_f.setProperty(&quot;SelectionNamespaces&quot;,&quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+var _10=_f.selectSingleNode(&quot;//xsl:output&quot;);
+this.outputMethod=_10?_10.getAttribute(&quot;method&quot;):&quot;html&quot;;
+this.template.stylesheet=_f;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_11){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_12;
+this.processor.transform();
+return _12;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID([&quot;Msxml2.MXXMLWriter.6.0&quot;,&quot;Msxml2.MXXMLWriter.3.0&quot;,&quot;MSXML2.MXXMLWriter&quot;,&quot;MSXML.MXXMLWriter&quot;,&quot;Microsoft.XMLDOM&quot;]);
+}
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_12;
+this.processor.transform();
+var _13=new ActiveXObject(_SARISSA_DOM_PROGID);
+_13.loadXML(_12.output+&quot;&quot;);
+return _13;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_14,_15){
+this.processor.input=_14;
+this.processor.transform();
+var s=this.processor.output;
+var f=_15.createDocumentFragment();
+if(this.outputMethod==&quot;text&quot;){
+f.appendChild(_15.createTextNode(s));
+}else{
+if(_15.body&amp;&amp;_15.body.innerHTML){
+var _18=_15.createElement(&quot;div&quot;);
+_18.innerHTML=s;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}else{
+var _19=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)==&quot;&lt;?xml&quot;){
+s=s.substring(s.indexOf(&quot;?&gt;&quot;)+2);
+}
+var xml=&quot;&quot;.concat(&quot;&lt;my&gt;&quot;,s,&quot;&lt;/my&gt;&quot;);
+_19.loadXML(xml);
+var _18=_19.documentElement;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1b,_1c,_1d){
+if(_1b){
+this.processor.addParameter(_1c,_1d,_1b);
+}else{
+this.processor.addParameter(_1c,_1d);
+}
+if(!this.paramsSet[&quot;&quot;+_1b]){
+this.paramsSet[&quot;&quot;+_1b]=new Array();
+}
+this.paramsSet[&quot;&quot;+_1b][_1c]=_1d;
+};
+XSLTProcessor.prototype.getParameter=function(_1e,_1f){
+_1e=_1e||&quot;&quot;;
+if(this.paramsSet[_1e]&amp;&amp;this.paramsSet[_1e][_1f]){
+return this.paramsSet[_1e][_1f];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _20 in this.paramsSet){
+for(var _21 in this.paramsSet[_20]){
+if(_20){
+this.processor.addParameter(_21,null,_20);
+}else{
+this.processor.addParameter(_21,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_22){
+Sarissa.__setReadyState__(_22,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_23,_24){
+_23.readyState=_24;
+_23.readystate=_24;
+if(_23.onreadystatechange!=null&amp;&amp;typeof _23.onreadystatechange==&quot;function&quot;){
+_23.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_25,_26){
+var _27=document.implementation.createDocument(_25?_25:null,_26?_26:null,null);
+if(!_27.onreadystatechange){
+_27.onreadystatechange=null;
+}
+if(!_27.readyState){
+_27.readyState=0;
+}
+_27.addEventListener(&quot;load&quot;,_sarissa_XMLDocument_onload,false);
+return _27;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&amp;&amp;window.Document&amp;&amp;!Document.prototype.load&amp;&amp;document.implementation.hasFeature(&quot;LS&quot;,&quot;3.0&quot;)){
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+return _2a;
+};
+}else{
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+if(_2d&amp;&amp;(_2b||_2c)&amp;&amp;!_2d.documentElement){
+_2d.appendChild(_2d.createElementNS(_2b,_2c));
+}
+return _2d;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_2e,_2f){
+var _30=new XMLHttpRequest();
+_30.open(&quot;GET&quot;,&quot;data:text/xml;charset=utf-8,&quot;+encodeURIComponent(_2e),false);
+_30.send(null);
+return _30.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&amp;&amp;Sarissa.getDomDocument()&amp;&amp;Sarissa.getDomDocument(null,&quot;bar&quot;).xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_31);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)==&quot;undefined&quot;)&amp;&amp;_SARISSA_IS_IE){
+try{
+document.importNode=function(_34,_35){
+var tmp;
+if(_34.nodeName==&quot;tbody&quot;||_34.nodeName==&quot;tr&quot;){
+tmp=document.createElement(&quot;table&quot;);
+}else{
+if(_34.nodeName==&quot;td&quot;){
+tmp=document.createElement(&quot;tr&quot;);
+}else{
+if(_34.nodeName==&quot;option&quot;){
+tmp=document.createElement(&quot;select&quot;);
+}else{
+tmp=document.createElement(&quot;div&quot;);
+}
+}
+}
+if(_35){
+tmp.innerHTML=_34.xml?_34.xml:_34.outerHTML;
+}else{
+tmp.innerHTML=_34.xml?_34.cloneNode(false).xml:_34.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName(&quot;*&quot;)[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_37){
+var _38=Sarissa.PARSED_OK;
+if(!_37.documentElement){
+_38=Sarissa.PARSED_EMPTY;
+}else{
+if(_37.documentElement.tagName==&quot;parsererror&quot;){
+_38=_37.documentElement.firstChild.data;
+_38+=&quot;\n&quot;+_37.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_37.getElementsByTagName(&quot;parsererror&quot;).length&gt;0){
+var _39=_37.getElementsByTagName(&quot;parsererror&quot;)[0];
+_38=Sarissa.getText(_39,true)+&quot;\n&quot;;
+}else{
+if(_37.parseError&amp;&amp;_37.parseError.errorCode!=0){
+_38=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _38;
+};
+}
+Sarissa.getText=function(_3a,_3b){
+var s=&quot;&quot;;
+var _3d=_3a.childNodes;
+for(var i=0;i&lt;_3d.length;i++){
+var _3f=_3d[i];
+var _40=_3f.nodeType;
+if(_40==Node.TEXT_NODE||_40==Node.CDATA_SECTION_NODE){
+s+=_3f.data;
+}else{
+if(_3b==true&amp;&amp;(_40==Node.ELEMENT_NODE||_40==Node.DOCUMENT_NODE||_40==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_3f,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&amp;&amp;Sarissa.getDomDocument&amp;&amp;Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;,null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_41){
+return _41.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
+};
+Sarissa.clearChildNodes=function(_43){
+while(_43.firstChild){
+_43.removeChild(_43.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_44,_45,_46){
+if((!_44)||(!_45)){
+throw &quot;Both source and destination nodes must be provided&quot;;
+}
+if(!_46){
+Sarissa.clearChildNodes(_45);
+}
+var _47=_45.nodeType==Node.DOCUMENT_NODE?_45:_45.ownerDocument;
+var _48=_44.childNodes;
+if(typeof (_47.importNode)!=&quot;undefined&quot;){
+for(var i=0;i&lt;_48.length;i++){
+_45.appendChild(_47.importNode(_48[i],true));
+}
+}else{
+for(var i=0;i&lt;_48.length;i++){
+_45.appendChild(_48[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4a,_4b,_4c){
+if((!_4a)||(!_4b)){
+throw &quot;Both source and destination nodes must be provided&quot;;
+}
+if(!_4c){
+Sarissa.clearChildNodes(_4b);
+}
+var _4d=_4a.childNodes;
+if(_4a.ownerDocument==_4b.ownerDocument){
+while(_4a.firstChild){
+_4b.appendChild(_4a.firstChild);
+}
+}else{
+var _4e=_4b.nodeType==Node.DOCUMENT_NODE?_4b:_4b.ownerDocument;
+if(typeof (_4e.importNode)!=&quot;undefined&quot;){
+for(var i=0;i&lt;_4d.length;i++){
+_4b.appendChild(_4e.importNode(_4d[i],true));
+}
+}else{
+for(var i=0;i&lt;_4d.length;i++){
+_4b.appendChild(_4d[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4a);
+}
+};
+Sarissa.xmlize=function(_50,_51,_52){
+_52=_52?_52:&quot;&quot;;
+var s=_52+&quot;&lt;&quot;+_51+&quot;&gt;&quot;;
+var _54=false;
+if(!(_50 instanceof Object)||_50 instanceof Number||_50 instanceof String||_50 instanceof Boolean||_50 instanceof Date){
+s+=Sarissa.escape(&quot;&quot;+_50);
+_54=true;
+}else{
+s+=&quot;\n&quot;;
+var _55=&quot;&quot;;
+var _56=_50 instanceof Array;
+for(var _57 in _50){
+s+=Sarissa.xmlize(_50[_57],(_56?&quot;array-item key=\&quot;&quot;+_57+&quot;\&quot;&quot;:_57),_52+&quot;   &quot;);
+}
+s+=_52;
+}
+return s+=(_51.indexOf(&quot; &quot;)!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot;+_51+&quot;&gt;\n&quot;);
+};
+Sarissa.escape=function(_58){
+return _58.replace(/&amp;/g,&quot;&amp;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&gt;/g,&quot;&gt;&quot;).replace(/&quot;/g,&quot;&quot;&quot;).replace(/'/g,&quot;&apos;&quot;);
+};
+Sarissa.unescape=function(_59){
+return _59.replace(/&apos;/g,&quot;'&quot;).replace(/&quot;/g,&quot;\&quot;&quot;).replace(/&gt;/g,&quot;&gt;&quot;).replace(/&lt;/g,&quot;&lt;&quot;).replace(/&amp;/g,&quot;&amp;&quot;);
+};
+

Modified: trunk/src/AssetManager.js
===================================================================
--- trunk/src/AssetManager.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/AssetManager.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -22,8 +22,8 @@
   * Both IE6 and FF1.5 are known to support the required HTTP methods, so
   * if theese are your target platform, you can disable tunneling.
   */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = &quot;Http-Method-Equivalent&quot;;
 /**
   * Set this url to provide remote xslt-transformation for browsers that
   * doesn't support it natively.
@@ -115,7 +115,7 @@
 	this._password = password;
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.AssetManager.loadAsset = function(url, preventCaching) {
 	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
@@ -138,7 +138,14 @@
 		} catch (ex) {
 			d.errback(ex);
 		}
-		d.callback(document);
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
 	};
 	try {
 		// Why using HTTP_METHOD_TUNNEL for a GET?
@@ -161,7 +168,7 @@
 				d.errback(new Error(&quot;Request failed:&quot; + req.status));
 			});
 		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
 				handler(req);
 			} else {
 				d.errback(new Error(&quot;Request failed:&quot; + req.status));

Modified: trunk/src/Freja.js
===================================================================
--- trunk/src/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,7 +5,7 @@
 	Freja = {};
 }
 Freja.NAME = &quot;Freja&quot;;
-Freja.VERSION = &quot;2.0.alpha&quot;;
+Freja.VERSION = &quot;2.1&quot;;
 Freja.__repr__ = function () {
 	return &quot;[&quot; + this.NAME + &quot; &quot; + this.VERSION + &quot;]&quot;;
 };

Modified: trunk/src/Model.js
===================================================================
--- trunk/src/Model.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/Model.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -40,12 +40,15 @@
 Freja.Model.prototype.updateFrom = function(view) {
 	var values = view.getValues();
 	for (var i = 0; i &lt; values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
 	}
 };
 /**
   * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.save = function() {
 	var url = this.url;
@@ -68,7 +71,7 @@
 };
 /**
   * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.remove = function() {
 	var url = this.url;
@@ -80,7 +83,7 @@
 	return Freja._aux.sendXMLHttpRequest(req);
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.reload = function() {
 	this.ready = false;

Modified: trunk/src/QueryEngine.js
===================================================================
--- trunk/src/QueryEngine.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/QueryEngine.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -13,57 +13,80 @@
 	}
 };
 Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error(&quot;Can't evaluate expression &quot; + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
 	}
-	if(node) return node.nodeValue;
-
+	return null;
 };
 Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
 			}
-			// else parent element does not exist.. can't do anything
+			// else parent node non existent either, give up.
 		}
+		// not an attribute, give up.
+		throw new Error(&quot;Can't evaluate expression &quot; + expression);
 	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild &amp;&amp; (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!=&quot;&quot;) // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
 };
 /**
   * XPath query engine.
   */
 Freja.QueryEngine.XPath = function() {};
 Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node &amp;&amp; node.nodeType == 2) {
-		return node;
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node &amp;&amp; node.firstChild &amp;&amp; node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error(&quot;Can't evaluate expression &quot; + expression);
-	return null;
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
 };
 /**
   * SimplePath
@@ -71,10 +94,11 @@
 Freja.QueryEngine.SimplePath = function() {};
 Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
 Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
 	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
 		throw new Error(&quot;Can't evaluate expression &quot; + expression);
 	}
-	var parts = expression.split(/\//);
+	var parts = expression.split(&quot;/&quot;);
 	var node = document;
 	var regAttr = new RegExp(&quot;^@([\\d\\w]*)&quot;);
 	var regOffset = new RegExp(&quot;^([@\\d\\w]*)\\[([\\d]*)\\]$&quot;);

Modified: trunk/src/View.js
===================================================================
--- trunk/src/View.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/View.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -15,7 +15,7 @@
   * @param    model            Freja.Model
   * @param    placeholder      string    If supplied, this will be used instead of the
   *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.prototype.render = function(model, placeholder, xslParameters) {
 	if (typeof(placeholder) == &quot;undefined&quot;) placeholder = this.placeholder;
@@ -50,7 +50,12 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
+				if(typeof html == &quot;string&quot;) {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = &quot;&quot;;   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, &quot;onrendercomplete&quot;, this._destination)
@@ -64,7 +69,11 @@
 
 	var d = Freja._aux.createDeferred();
 	try {
-		this._destination = Freja._aux.getElement(placeholder);
+		if (typeof(placeholder) == &quot;object&quot;) {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
 		// @todo    Is this a good idea ?
 		// Perhaps we should leave it to the programmer to do this.
 		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
@@ -152,22 +161,15 @@
 Freja.View.Renderer.XSLTransformer = function() {};
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
 		if (!html) {
 			d.errback(new Error(&quot;XSL Transformation error.&quot;));
 		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// &lt;xsl:output method=&quot;html&quot; /&gt;
-			// (cedsav) don't remember all the details but method=&quot;xml&quot; is the way to go.
-			// method=&quot;html&quot; would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/&lt;textarea([^&gt;]*)\/&gt;/gi,&quot;&lt;textarea $1&gt;&lt;/textarea&gt;&quot;);
 			d.callback(html);
 		}
 	} catch (ex) {
@@ -184,7 +186,7 @@
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();

Modified: trunk/src/auxiliary/minimal.js
===================================================================
--- trunk/src/auxiliary/minimal.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/auxiliary/minimal.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,870 @@
+
 /**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * &lt;p&gt;Sarissa is a utility class. Provides &quot;static&quot; methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.&lt;/p&gt;
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = &quot;Document contains no parsing errors&quot;;
+Sarissa.PARSED_EMPTY = &quot;Document is empty&quot;;
+Sarissa.PARSED_UNKNOWN_ERROR = &quot;Not well-formed or other error&quot;;
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = &quot;&quot;;
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation &amp;&amp; true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION &amp;&amp; document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT &amp;&amp; _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent &amp;&amp; navigator.vendor &amp;&amp; (navigator.userAgent.toLowerCase().indexOf(&quot;applewebkit&quot;) != -1 || navigator.vendor.indexOf(&quot;Apple&quot;) != -1));
+var _SARISSA_IS_IE = document.all &amp;&amp; window.ActiveXObject &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;) &gt; -1  &amp;&amp; navigator.userAgent.toLowerCase().indexOf(&quot;opera&quot;) == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == &quot;undefined&quot; &amp;&amp; typeof Document !=&quot;undefined&quot;){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = &quot;xsl:&quot;;
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = &quot;&quot;;
+    var _SARISSA_XMLHTTP_PROGID = &quot;&quot;;
+    var _SARISSA_DOM_XMLWRITER = &quot;&quot;;
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw &quot;Could not retreive a valid progID of Class: &quot; + idList[idList.length-1]+&quot;. (original exception: &quot;+e+&quot;)&quot;;
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XMLHTTP.6.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.DOMDocument.6.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = &quot;&quot;;
+            if(sUri){
+                if(sName.indexOf(&quot;:&quot;) &gt; 1){
+                    prefix = sName.substring(0, sName.indexOf(&quot;:&quot;));
+                    sName = sName.substring(sName.indexOf(&quot;:&quot;)+1); 
+                }else{
+                    prefix = &quot;a&quot; + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('&lt;' + prefix+':'+sName + &quot; xmlns:&quot; + prefix + &quot;=\&quot;&quot; + sUri + &quot;\&quot;&quot; + &quot; /&gt;&quot;);
+            } else {
+                oDoc.loadXML('&lt;' + sName + &quot; /&gt;&quot;);
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = &quot;XML Parsing Error: &quot; + oDoc.parseError.reason + 
+                &quot;\nLocation: &quot; + oDoc.parseError.url + 
+                &quot;\nLine Number &quot; + oDoc.parseError.line + &quot;, Column &quot; + 
+                oDoc.parseError.linepos + 
+                &quot;:\n&quot; + oDoc.parseError.srcText +
+                &quot;\n&quot;;
+            for(var i = 0;  i &lt; oDoc.parseError.linepos;i++){
+                parseErrorText += &quot;-&quot;;
+            };
+            parseErrorText +=  &quot;^\n&quot;;
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        oDoc.setProperty(&quot;SelectionNamespaces&quot;, sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID([&quot;Msxml2.XSLTemplate.6.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * &lt;b&gt;Note:&lt;/b&gt; If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID([&quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
+        };
+        xslDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
+        xslDoc.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url &amp;&amp; xslDoc.selectSingleNode(&quot;//xsl:*[local-name() = 'import' or local-name() = 'include']&quot;) != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == &quot;MSXML2.FreeThreadedDOMDocument.6.0&quot;) { 
+                converted.setProperty(&quot;AllowDocumentFunction&quot;, true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
+        var output = converted.selectSingleNode(&quot;//xsl:output&quot;);
+        this.outputMethod = output ? output.getAttribute(&quot;method&quot;) : &quot;html&quot;;
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID([&quot;Msxml2.MXXMLWriter.6.0&quot;, &quot;Msxml2.MXXMLWriter.3.0&quot;, &quot;MSXML2.MXXMLWriter&quot;, &quot;MSXML.MXXMLWriter&quot;, &quot;Microsoft.XMLDOM&quot;]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+&quot;&quot;);
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * &lt;b&gt;Note&lt;/b&gt;: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body &amp;&amp; ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '&lt;?xml') {
+                s = s.substring(s.indexOf('?&gt;') + 2);
+            }
+            var xml = ''.concat('&lt;my&gt;', s, '&lt;/my&gt;');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[&quot;&quot;+nsURI]){
+            this.paramsSet[&quot;&quot;+nsURI] = new Array();
+        };
+        this.paramsSet[&quot;&quot;+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || &quot;&quot;;
+        if(this.paramsSet[nsURI] &amp;&amp; this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * &lt;p&gt;Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use&lt;/p&gt;
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * &lt;p&gt;Attached by an event handler to the load event. Internal use.&lt;/p&gt;
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * &lt;p&gt;Sets the readyState property of the given DOM Document object.
+         * Internal use.&lt;/p&gt;
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null &amp;&amp; typeof oDoc.onreadystatechange == &quot;function&quot;)
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * &lt;p&gt;Emulate IE's onreadystatechange attribute&lt;/p&gt;
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * &lt;p&gt;Emulates IE's readyState property, which always gives an integer from 0 to 4:&lt;/p&gt;
+                * &lt;ul&gt;&lt;li&gt;1 == LOADING,&lt;/li&gt;
+                * &lt;li&gt;2 == LOADED,&lt;/li&gt;
+                * &lt;li&gt;3 == INTERACTIVE,&lt;/li&gt;
+                * &lt;li&gt;4 == COMPLETED&lt;/li&gt;&lt;/ul&gt;
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener(&quot;load&quot;, _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; window.Document &amp;&amp; !Document.prototype.load &amp;&amp; document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * &lt;p&gt;Factory method to obtain a new DOM Document object&lt;/p&gt;
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc &amp;&amp; (sUri || sName) &amp;&amp; !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open(&quot;GET&quot;, &quot;data:text/xml;charset=utf-8,&quot; + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument &amp;&amp; Sarissa.getDomDocument() &amp;&amp; Sarissa.getDomDocument(null, &quot;bar&quot;).xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == &quot;undefined&quot;) &amp;&amp; _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == &quot;tbody&quot; || oNode.nodeName == &quot;tr&quot;){
+                tmp = document.createElement(&quot;table&quot;);
+            }
+            else if(oNode.nodeName == &quot;td&quot;){
+                tmp = document.createElement(&quot;tr&quot;);
+            }
+            else if(oNode.nodeName == &quot;option&quot;){
+                tmp = document.createElement(&quot;select&quot;);
+            }
+            else{
+                tmp = document.createElement(&quot;div&quot;);
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName(&quot;*&quot;)[0];
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * &lt;p&gt;Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.&lt;/p&gt;
+     * &lt;p&gt;Many thanks to Christian Stocker for the initial patch.&lt;/p&gt;
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == &quot;parsererror&quot;){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += &quot;\n&quot; +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName(&quot;parsererror&quot;).length &gt; 0){
+            var parsererror = oDoc.getElementsByTagName(&quot;parsererror&quot;)[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+&quot;\n&quot;;
+        } else if(oDoc.parseError &amp;&amp; oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = &quot;&quot;;
+    var nodes = oNode.childNodes;
+    for(var i=0; i &lt; nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    &amp;&amp; (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    &amp;&amp; Sarissa.getDomDocument 
+    &amp;&amp; Sarissa.getDomDocument(&quot;&quot;,&quot;foo&quot;, null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);
+};
+/**
+ * &lt;p&gt;Deletes all child nodes of the given node&lt;/p&gt;
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * &lt;p&gt; Copies the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != &quot;undefined&quot;)  {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i &lt; nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * &lt;p&gt; Moves the childNodes of nodeFrom to nodeTo&lt;/p&gt;
+ * &lt;p&gt; &lt;b&gt;Note:&lt;/b&gt; The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter&lt;/p&gt;
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw &quot;Both source and destination nodes must be provided&quot;;
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != &quot;undefined&quot;) {
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i &lt; nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * &lt;p&gt;Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as &lt;code&gt;array-item&lt;/code&gt; elements, 
+ * using their index/key as the value of the &lt;code&gt;key&lt;/code&gt; attribute.&lt;/p&gt;
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '&lt;' + objectName + '&gt;';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(&quot;&quot;+anyObject);
+        isLeaf = true;
+    }else{
+        s += &quot;\n&quot;;
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?&quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot;:name), indentSpace + &quot;   &quot;);
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?&quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
+        .replace(/&lt;/g, &quot;&lt;&quot;)
+        .replace(/&gt;/g, &quot;&gt;&quot;)
+        .replace(/&quot;/g, &quot;&quot;&quot;)
+        .replace(/'/g, &quot;&apos;&quot;);
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,&quot;'&quot;)
+        .replace(/&quot;/g,&quot;\&quot;&quot;)
+        .replace(/&gt;/g,&quot;&gt;&quot;)
+        .replace(/&lt;/g,&quot;&lt;&quot;)
+        .replace(/&amp;/g,&quot;&amp;&quot;);
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ *
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)){
+    /**
+    * &lt;p&gt;SarissaNodeList behaves as a NodeList but is only used as a result to &lt;code&gt;selectNodes&lt;/code&gt;,
+    * so it also has some properties IEs proprietery object features.&lt;/p&gt;
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** &lt;p&gt;Set an Array as the prototype object&lt;/p&gt; */
+    SarissaNodeList.prototype = new Array(0);
+    /** &lt;p&gt;Inherit the Array constructor &lt;/p&gt; */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * &lt;p&gt;Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero &lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note&lt;/b&gt; that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling &lt;code&gt;item&lt;/code&gt;
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i &lt; 0 || i &gt;= this.length)?null:this[i];
+    };
+    /**
+    * &lt;p&gt;Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).&lt;/p&gt;
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = &quot;&quot;;
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument &amp;&amp; (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * &lt;p&gt;Programmatically control namespace URI/prefix mappings for XPath
+    * queries.&lt;/p&gt;
+    * &lt;p&gt;This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.&lt;/p&gt;
+    * &lt;p&gt;Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:&lt;/p&gt;
+    * &lt;pre&gt;Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;<A HREF="aposhttp://mynsURI&amp;amp;apos&amp;quot;">aposhttp://mynsURI&amp;apos&quot;</A>);&lt;/pre&gt;
+    * &lt;p&gt;&lt;b&gt;Note 1 &lt;/b&gt;: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.&lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note 2 &lt;/b&gt;: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.&lt;/p&gt;
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            &lt;code&gt;&quot;xmlns:xhtml=&apos;<A HREF="http://www.w3.org/1999/xhtml&amp;apos;">http://www.w3.org/1999/xhtml&apos;</A>
+    * xmlns:&apos;<A HREF="http://www.w3.org/1999/XSL/Transform&amp;apos;&amp;quot;&lt;/code">http://www.w3.org/1999/XSL/Transform&apos;&quot;&lt;/code</A>&gt;
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(&quot; &quot;)&gt;-1?sNsSet.split(&quot; &quot;):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i &lt; namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(&quot;:&quot;);
+            var assignPos = ns.indexOf(&quot;=&quot;);
+            if(colonPos &gt; 0 &amp;&amp; assignPos &gt; colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw &quot;Bad format on namespace declaration(s) given&quot;;
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectNodes.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw &quot;No namespace URI found for prefix: '&quot; + prefix+&quot;'&quot;;
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i&lt;nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectNodes&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
   * Freja._aux
   * wrapper for external dependencies (frameworks).
   *
   * This is the minimal auxiliary adapter. It contains self-sufficient
   * implementations of all dependencies.
-  *
+  * 
   */
 if (typeof(Freja) == &quot;undefined&quot;) {
 	Freja = {};
@@ -29,11 +889,10 @@
     func.im_func = im_func;
     func.im_self = self;
 	return func;
-
 };
 /** formContents(elem) : Array */
 Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
+	if (!elem) elem = document;
 	var names = [];
 	var values = [];
 	var inputs = elem.getElementsByTagName(&quot;INPUT&quot;);
@@ -120,6 +979,11 @@
 	if (!src._signals[signal]) {
 		src._signals[signal] = [];
 	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item &lt; src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
 	src._signals[signal].push(fnc);
 };
 /** signal(src, signal, ...) : void */
@@ -144,12 +1008,7 @@
 };
 /** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
 Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;); }
-	catch (e) { try { req = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error(&quot;Can't create XMLHttpRequest&quot;);
+	var req = new XMLHttpRequest();
 	if (user &amp;&amp; pass) {
 		req.open(method, url, async, user, pass);
 	} else {
@@ -158,6 +1017,8 @@
 	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
 		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -179,32 +1040,8 @@
 	return d;
 };
 /** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&amp;/g, &quot;&amp;&quot;)
-			.replace(/&lt;/g, &quot;&lt;&quot;)
-			.replace(/&gt;/g, &quot;&gt;&quot;)
-			.replace(/&quot;/g, &quot;&quot;&quot;)
-			.replace(/'/g, &quot;&apos;&quot;);
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '&lt;' + objectName + '&gt;';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(&quot;&quot;+anyObject);
-		isLeaf = true;
-	} else {
-		s += &quot;\n&quot;;
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? &quot;array-item key=\&quot;&quot;+name+&quot;\&quot;&quot; : name), indentSpace + &quot;   &quot;);
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? &quot;&lt;/array-item&gt;\n&quot;:&quot;&lt;/&quot; + objectName + &quot;&gt;\n&quot;);
-};
+Freja._aux.xmlize = Sarissa.xmlize;
+
 /** serializeXML(node) : string */
 Freja._aux.serializeXML = function(node) {
 	if (node.xml) return node.xml;
@@ -212,43 +1049,19 @@
 };
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject(&quot;Msxml2.DOMDocument&quot;);
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty(&quot;SelectionLanguage&quot;, &quot;XPath&quot;);
-		return xmlDoc;
-	}
 	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
 Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != &quot;undefined&quot;) {
-		// set the parameters
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
 		for (var paramName in xslParameters) {
-			xsl.setProperty (&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='<A HREF="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</A>'&quot;);
-			var paramNode = xsl.selectSingleNode(&quot;//xsl:param[@name='&quot;+ paramName +&quot;']&quot;);
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
+			processor.setParameter(&quot;&quot;, paramName, xslParameters[paramName]);
 		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode(&quot;//xsl:param[@name='&quot;+ paramName +&quot;']&quot;);
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
 	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	 
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -287,7 +1100,7 @@
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
 /** createQueryEngine() : Freja.QueryEngine */
 Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;))) {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
 		return new Freja.QueryEngine.XPath();
 	} else {
 		return new Freja.QueryEngine.SimplePath();
@@ -332,116 +1145,3 @@
 Freja._aux.Deferred.prototype.addErrback = function(fncError) {
 	this.addCallbacks(null, fncError);
 };
-if (document.implementation &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)) {
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
-
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error(&quot;Can't evaluate expression &quot; + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i &lt; 0 || i &gt;= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i &lt; nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error(&quot;Method selectNodes is only supported by XML Elements&quot;);
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = &quot;(&quot;+sExpr+&quot;)[1]&quot;;
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length &gt; 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error(&quot;Method selectNodes is only supported by XML Elements&quot;);
-		}
-	};
-};
-
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i &lt; idList.length &amp;&amp; !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
-        };
-    };
-    throw &quot;Could not retrieve a valid progID.&quot;;
-}
-
-if(typeof XSLTProcessor == 'undefined' &amp;&amp; typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.DOMDocument.5.0&quot;, &quot;Msxml2.DOMDocument.4.0&quot;, &quot;Msxml2.DOMDocument.3.0&quot;, &quot;MSXML2.DOMDocument&quot;, &quot;MSXML.DOMDocument&quot;, &quot;Microsoft.XMLDOM&quot;]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.XMLHTTP.5.0&quot;, &quot;Msxml2.XMLHTTP.4.0&quot;, &quot;MSXML2.XMLHTTP.3.0&quot;, &quot;MSXML2.XMLHTTP&quot;, &quot;Microsoft.XMLHTTP&quot;]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.FreeThreadedDOMDocument.5.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.4.0&quot;, &quot;MSXML2.FreeThreadedDOMDocument.3.0&quot;]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID([&quot;Msxml2.XSLTemplate.5.0&quot;, &quot;Msxml2.XSLTemplate.4.0&quot;, &quot;MSXML2.XSLTemplate.3.0&quot;]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[&quot;&quot;+nsURI]){
-	        this.paramsSet[&quot;&quot;+nsURI] = new Array();
-	    };
-	    this.paramsSet[&quot;&quot;+nsURI][name] = value;
-	};
-
-}
-

Modified: trunk/src/auxiliary/mochi+sarissa.js
===================================================================
--- trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -43,7 +43,50 @@
 /** bind(func, self) : function */
 Freja._aux.bind = MochiKit.Base.bind;
 /** formContents(elem) : Array */
-Freja._aux.formContents = MochiKit.DOM.formContents;
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName(&quot;INPUT&quot;);
+	for (var i = 0; i &lt; inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == &quot;radio&quot; || input.type == &quot;checkbox&quot;) {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push(&quot;&quot;);
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName(&quot;TEXTAREA&quot;);
+	for (var i = 0; i &lt; textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName(&quot;SELECT&quot;);
+	for (var i = 0; i &lt; selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex &gt;= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : &quot;&quot;);
+			}
+		}
+	}
+	return [names, values];
+};
+
 /** getElement(id) : HTMLElement */
 Freja._aux.getElement = MochiKit.DOM.getElement;
 
@@ -66,6 +109,8 @@
 	if (method == &quot;POST&quot; || method == &quot;PUT&quot;) {
 		req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -73,17 +118,25 @@
 /** xmlize(anyObject, objectName) : string */
 Freja._aux.xmlize = Sarissa.xmlize;
 /** serializeXML(node) : string */
-Freja._aux.serializeXML = Sarissa.serialize;
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
 	return (new DOMParser()).parseFromString(text, &quot;text/xml&quot;);
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl) {
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter(&quot;&quot;, paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -91,7 +144,7 @@
 	try {
 		clone = xmlDoc.cloneNode(true);
 	} catch(e) { /* squelch */ }
-
+	
 	// Can't clone a DocumentNode in Safari &amp; Opera. Let's try something else.
 	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
 	if (!clone) {
@@ -101,23 +154,27 @@
 			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
 			try {
 				clone.appendChild(data);
-			} catch(e) {
+			} catch(e) {				
 				// Opera has already created a documentElement and can't append another root node
 				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i &gt;= 0; i--) {
+			
+				for (var i = data.childNodes.length-1; i &gt;= 0; i--) {
 					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
 				}
+				
 				// need to copy root node attributes
 				for (var i = 0; i &lt; xmlDoc.documentElement.attributes.length; i++) {
 					var name  = xmlDoc.documentElement.attributes.item(i).name;
 					var value = xmlDoc.documentElement.attributes.item(i).value;
 					clone.documentElement.setAttribute(name, value);
-				}
+				}				
 			}
 		}
 	}
+	
 	return clone;
 };
+
 /** hasSupportForXSLT() : boolean */
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != &quot;undefined&quot;); };
 /** createQueryEngine() : Freja.QueryEngine */
@@ -128,3 +185,208 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see &lt;a href=&quot;gpl.txt&quot;&gt;gpl.txt&lt;/a&gt;) or higher, 
+ * GNU LGPL version 2.1 (see &lt;a href=&quot;lgpl.txt&quot;&gt;lgpl.txt&lt;/a&gt;) or higher and Apache Software License 2.0 or higher 
+ * (see &lt;a href=&quot;asl.txt&quot;&gt;asl.txt&lt;/a&gt;). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at &lt;a href=&quot;<A HREF="http://www.gnu.org">http://www.gnu.org</A>&quot;&gt;<A HREF="http://www.gnu.org&lt;/a">http://www.gnu.org&lt;/a</A>&gt; and 
+ * &lt;a href=&quot;<A HREF="http://www.apache.org">http://www.apache.org</A>&quot;&gt;<A HREF="http://www.apache.org&lt;/a">http://www.apache.org&lt;/a</A>&gt;.
+ *
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE &amp;&amp; document.implementation.hasFeature(&quot;XPath&quot;, &quot;3.0&quot;)){
+    /**
+    * &lt;p&gt;SarissaNodeList behaves as a NodeList but is only used as a result to &lt;code&gt;selectNodes&lt;/code&gt;,
+    * so it also has some properties IEs proprietery object features.&lt;/p&gt;
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** &lt;p&gt;Set an Array as the prototype object&lt;/p&gt; */
+    SarissaNodeList.prototype = new Array(0);
+    /** &lt;p&gt;Inherit the Array constructor &lt;/p&gt; */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * &lt;p&gt;Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero &lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note&lt;/b&gt; that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling &lt;code&gt;item&lt;/code&gt;
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i &lt; 0 || i &gt;= this.length)?null:this[i];
+    };
+    /**
+    * &lt;p&gt;Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).&lt;/p&gt;
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = &quot;&quot;;
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument &amp;&amp; (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * &lt;p&gt;Programmatically control namespace URI/prefix mappings for XPath
+    * queries.&lt;/p&gt;
+    * &lt;p&gt;This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.&lt;/p&gt;
+    * &lt;p&gt;Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:&lt;/p&gt;
+    * &lt;pre&gt;Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;<A HREF="aposhttp://mynsURI&amp;amp;apos&amp;quot;">aposhttp://mynsURI&amp;apos&quot;</A>);&lt;/pre&gt;
+    * &lt;p&gt;&lt;b&gt;Note 1 &lt;/b&gt;: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.&lt;/p&gt;
+    * &lt;p&gt;&lt;b&gt;Note 2 &lt;/b&gt;: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.&lt;/p&gt;
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            &lt;code&gt;&quot;xmlns:xhtml=&apos;<A HREF="http://www.w3.org/1999/xhtml&amp;apos;">http://www.w3.org/1999/xhtml&apos;</A>
+    * xmlns:&apos;<A HREF="http://www.w3.org/1999/XSL/Transform&amp;apos;&amp;quot;&lt;/code">http://www.w3.org/1999/XSL/Transform&apos;&quot;&lt;/code</A>&gt;
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(&quot; &quot;)&gt;-1?sNsSet.split(&quot; &quot;):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i &lt; namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(&quot;:&quot;);
+            var assignPos = ns.indexOf(&quot;=&quot;);
+            if(colonPos &gt; 0 &amp;&amp; assignPos &gt; colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw &quot;Bad format on namespace declaration(s) given&quot;;
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectNodes.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw &quot;No namespace URI found for prefix: '&quot; + prefix+&quot;'&quot;;
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i&lt;nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectNodes&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    /**
+    * &lt;p&gt;Extends the XMLDocument to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * &lt;p&gt;Extends the Element to emulate IE's selectSingleNode.&lt;/p&gt;
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw &quot;Method selectNodes is only supported by XML Elements&quot;;
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+

Modified: trunk/tests/index.html
===================================================================
--- trunk/tests/index.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/index.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 &lt;html&gt;
 &lt;head&gt;
     &lt;!-- This harness does not work locally in Safari --&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;SimpleTest/TestRunner.js&quot;&gt;&lt;/script&gt;
 &lt;/head&gt;
 &lt;body&gt;

Modified: trunk/tests/test_Freja-History.html
===================================================================
--- trunk/tests/test_Freja-History.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-History.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,10 @@
 &lt;html&gt;
 &lt;head&gt;
     &lt;!-- MochiKit is needed by SimpleTest --&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;SimpleTest/SimpleTest.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Freja.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
     &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;SimpleTest/test.css&quot;&gt;
 &lt;/head&gt;
 &lt;body&gt;

Modified: trunk/tests/test_Freja-Model.html
===================================================================
--- trunk/tests/test_Freja-Model.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-Model.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,11 +1,12 @@
 &lt;html&gt;
 &lt;head&gt;
+	&lt;title&gt;Freja Test Suite&lt;/title&gt;
     &lt;!-- MochiKit is needed by SimpleTest --&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;SimpleTest/SimpleTest.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Freja.js&quot;&gt;&lt;/script&gt;
-    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;SimpleTest/test.css&quot;&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
+    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;SimpleTest/test.css&quot; /&gt;
 &lt;/head&gt;
 &lt;body&gt;
 

Modified: trunk/tests/test_Freja-View.html
===================================================================
--- trunk/tests/test_Freja-View.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-View.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,10 @@
 &lt;html&gt;
 &lt;head&gt;
     &lt;!-- MochiKit is needed by SimpleTest --&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/MochiKit.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/MochiKit.js&quot;&gt;&lt;/script&gt;
     &lt;script type=&quot;text/javascript&quot; src=&quot;SimpleTest/SimpleTest.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Sarissa.js&quot;&gt;&lt;/script&gt;
-    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/Freja.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Sarissa.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../lib/mochi+sarissa/Freja.js&quot;&gt;&lt;/script&gt;
     &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;SimpleTest/test.css&quot;&gt;
 &lt;/head&gt;
 &lt;body&gt;

Modified: trunk/tests/test_Model.js
===================================================================
--- trunk/tests/test_Model.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Model.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -43,8 +43,7 @@
 	var model = Freja.AssetManager.getModel(&quot;data/model2.xml&quot;);
 	t.is(model.get(&quot;item/@price&quot;), &quot;$3.80&quot;);
 	t.is(model.get(&quot;item/description&quot;), &quot;with Goat Cheese, a touch of Cumin and Cayenne&quot;);
-
-
+	
 	var model3 = Freja.AssetManager.getModel(&quot;data/model3.xml&quot;);
 	model3.set(&quot;item/price&quot;,&quot;$5.40&quot;);
 	t.is(model3.get(&quot;item/price&quot;), &quot;$5.40&quot;);

Modified: trunk/tests/test_View.js
===================================================================
--- trunk/tests/test_View.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_View.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -32,7 +32,7 @@
 	};
 	view.render(pojo, out);
 
-	t.ok(out.innerHTML.toLowerCase().match(&quot;&lt;p&gt;plain old javascript object&lt;/p&gt;&quot;));
+	t.ok(out.innerHTML.toLowerCase().match(&quot;&lt;p&gt;plain old javascript object&lt;/p&gt;&quot;),&quot;The rendered view should contain the text 'plain old javascript object'&quot;);
 
 	// test of form
 	var formView = Freja.AssetManager.getView(&quot;data/form-view.xsl&quot;);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000083.html">[Freja-svn] r85 - branch/2.0.1/examples/tutorial
</A></li>
	<LI>Next message: <A HREF="000085.html">[Freja-svn] r87 - trunk/external
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#84">[ date ]</a>
              <a href="thread.html#84">[ thread ]</a>
              <a href="subject.html#84">[ subject ]</a>
              <a href="author.html#84">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/freja-svn">More information about the Freja-svn
mailing list</a><br>
</body></html>
