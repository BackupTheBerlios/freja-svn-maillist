From cedsav at mail.berlios.de  Fri Mar  2 00:23:16 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Fri, 2 Mar 2007 00:23:16 +0100
Subject: [Freja-svn] r77 - branch/2.0.1/src/auxiliary
Message-ID: <200703012323.l21NNGg7007556@sheep.berlios.de>

Author: cedsav
Date: 2007-03-02 00:23:14 +0100 (Fri, 02 Mar 2007)
New Revision: 77

Modified:
   branch/2.0.1/src/auxiliary/mochi+sarissa.js
Log:
Added request header to XMLHTTPRequest for server-side framework compatibility (RoR, CakePHP)

Modified: branch/2.0.1/src/auxiliary/mochi+sarissa.js
===================================================================
--- branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-02-18 04:13:20 UTC (rev 76)
+++ branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-03-01 23:23:14 UTC (rev 77)
@@ -66,6 +66,8 @@
 	if (method == "POST" || method == "PUT") {
 		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -73,7 +75,10 @@
 /** xmlize(anyObject, objectName) : string */
 Freja._aux.xmlize = Sarissa.xmlize;
 /** serializeXML(node) : string */
-Freja._aux.serializeXML = Sarissa.serialize;
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
 	return (new DOMParser()).parseFromString(text, "text/xml");



From cedsav at mail.berlios.de  Mon Mar 12 21:36:57 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 12 Mar 2007 21:36:57 +0100
Subject: [Freja-svn] r78 - branch/2.0.1/src
Message-ID: <200703122036.l2CKavrw000464@sheep.berlios.de>

Author: cedsav
Date: 2007-03-12 21:36:52 +0100 (Mon, 12 Mar 2007)
New Revision: 78

Modified:
   branch/2.0.1/src/View.js
Log:
Fixed render() to handle serialized HTML from remote XSLT.

Modified: branch/2.0.1/src/View.js
===================================================================
--- branch/2.0.1/src/View.js	2007-03-01 23:23:14 UTC (rev 77)
+++ branch/2.0.1/src/View.js	2007-03-12 20:36:52 UTC (rev 78)
@@ -50,8 +50,12 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = "";
-				this._destination.appendChild(html);
+				if(typeof html == "string") {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = "";   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)



From cedsav at mail.berlios.de  Mon Mar 12 21:40:23 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 12 Mar 2007 21:40:23 +0100
Subject: [Freja-svn] r79 - branch/2.0.1/src
Message-ID: <200703122040.l2CKeNJF000733@sheep.berlios.de>

Author: cedsav
Date: 2007-03-12 21:40:17 +0100 (Mon, 12 Mar 2007)
New Revision: 79

Modified:
   branch/2.0.1/src/AssetManager.js
Log:
Fixed callback bug in IE6 with resource loaded from file system.
Added "201 created" in the list of successful HTTP code.

Modified: branch/2.0.1/src/AssetManager.js
===================================================================
--- branch/2.0.1/src/AssetManager.js	2007-03-12 20:36:52 UTC (rev 78)
+++ branch/2.0.1/src/AssetManager.js	2007-03-12 20:40:17 UTC (rev 79)
@@ -138,7 +138,14 @@
 		} catch (ex) {
 			d.errback(ex);
 		}
-		d.callback(document);
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
 	};
 	try {
 		// Why using HTTP_METHOD_TUNNEL for a GET?
@@ -161,7 +168,7 @@
 				d.errback(new Error("Request failed:" + req.status));
 			});
 		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
 				handler(req);
 			} else {
 				d.errback(new Error("Request failed:" + req.status));



From cedsav at mail.berlios.de  Mon Mar 12 21:42:22 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 12 Mar 2007 21:42:22 +0100
Subject: [Freja-svn] r80 - branch/2.0.1/lib
Message-ID: <200703122042.l2CKgMcn001079@sheep.berlios.de>

Author: cedsav
Date: 2007-03-12 21:42:13 +0100 (Mon, 12 Mar 2007)
New Revision: 80

Modified:
   branch/2.0.1/lib/Freja.js
Log:
Latest build w/ Mochikit+Sarissa. 

Modified: branch/2.0.1/lib/Freja.js
===================================================================
--- branch/2.0.1/lib/Freja.js	2007-03-12 20:40:17 UTC (rev 79)
+++ branch/2.0.1/lib/Freja.js	2007-03-12 20:42:13 UTC (rev 80)
@@ -2,14 +2,14 @@
 
     Freja 2.0.1
 
-    Build $Fri, 26 Jan 2007 03:09:08 UTC$
+    Build $Mon, 12 Mar 2007 20:41:24 UTC$
 
     Target: mochi+sarissa
 
     THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
     diff against the source tree, not this file.
 
-    Copyright (c) 2006 C?dric Savarese <pro at 4213miles.com>, Troels Knak-Nielsen <troelskn at gmail.com>
+    Copyright (c) 2006-2007 Cedric Savarese <cedric at veerwest.com>, Troels Knak-Nielsen <troelskn at gmail.com>
     This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>
 
 ***/
@@ -115,6 +115,8 @@
 	if (method == "POST" || method == "PUT") {
 		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -122,7 +124,10 @@
 /** xmlize(anyObject, objectName) : string */
 Freja._aux.xmlize = Sarissa.xmlize;
 /** serializeXML(node) : string */
-Freja._aux.serializeXML = Sarissa.serialize;
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
 	return (new DOMParser()).parseFromString(text, "text/xml");
@@ -388,6 +393,8 @@
     };
     Sarissa.IS_ENABLED_SELECT_NODES = true;
 };
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
 
 
 /**
@@ -489,7 +496,7 @@
 	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
 		throw new Error("Can't evaluate expression " + expression);
 	}
-	var parts = expression.split(/\//);
+	var parts = expression.split("/");
 	var node = document;
 	var regAttr = new RegExp("^@([\\d\\w]*)");
 	var regOffset = new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
@@ -727,8 +734,12 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = "";
-				this._destination.appendChild(html);
+				if(typeof html == "string") {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = "";   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
@@ -1112,7 +1123,14 @@
 		} catch (ex) {
 			d.errback(ex);
 		}
-		d.callback(document);
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
 	};
 	try {
 		// Why using HTTP_METHOD_TUNNEL for a GET?
@@ -1135,7 +1153,7 @@
 				d.errback(new Error("Request failed:" + req.status));
 			});
 		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
 				handler(req);
 			} else {
 				d.errback(new Error("Request failed:" + req.status));



From cedsav at mail.berlios.de  Mon Mar 19 23:04:41 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 19 Mar 2007 23:04:41 +0100
Subject: [Freja-svn] r81 - branch/2.0.1/src
Message-ID: <200703192204.l2JM4fWg024443@sheep.berlios.de>

Author: cedsav
Date: 2007-03-19 23:04:37 +0100 (Mon, 19 Mar 2007)
New Revision: 81

Modified:
   branch/2.0.1/src/QueryEngine.js
Log:
Fixed a bug that crashes IE7/MSXML3 after appending an empty textnode.

Modified: branch/2.0.1/src/QueryEngine.js
===================================================================
--- branch/2.0.1/src/QueryEngine.js	2007-03-12 20:42:13 UTC (rev 80)
+++ branch/2.0.1/src/QueryEngine.js	2007-03-19 22:04:37 UTC (rev 81)
@@ -64,7 +64,8 @@
 			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
 				node.firstChild.nodeValue = value;
 			} else {
-				node.appendChild(document.createTextNode(value));
+				if(value!="") // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
 			}
 			break;
 		case 2: /* Attribute */



From cedsav at mail.berlios.de  Mon Mar 19 23:08:12 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 19 Mar 2007 23:08:12 +0100
Subject: [Freja-svn] r82 - in branch/2.0.1: .
	examples/contacts/models/php_inc lib src src/auxiliary tests
Message-ID: <200703192208.l2JM8Ckp024641@sheep.berlios.de>

Author: cedsav
Date: 2007-03-19 23:07:30 +0100 (Mon, 19 Mar 2007)
New Revision: 82

Added:
   branch/2.0.1/custom_rhino.jar
   branch/2.0.1/lib/Freja_pack.js
   branch/2.0.1/lib/Sarissa_pack.js
   branch/2.0.1/pack.bat
Modified:
   branch/2.0.1/build.wsf
   branch/2.0.1/examples/contacts/models/php_inc/inc.resource.php
   branch/2.0.1/lib/Freja.js
   branch/2.0.1/lib/MochiKit.js
   branch/2.0.1/lib/Sarissa.js
   branch/2.0.1/src/AssetManager.js
   branch/2.0.1/src/Model.js
   branch/2.0.1/src/View.js
   branch/2.0.1/src/auxiliary/minimal.js
   branch/2.0.1/src/auxiliary/mochi+sarissa.js
   branch/2.0.1/tests/test_Freja-Model.html
   branch/2.0.1/tests/test_View.js
Log:


Modified: branch/2.0.1/build.wsf
===================================================================
--- branch/2.0.1/build.wsf	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/build.wsf	2007-03-19 22:07:30 UTC (rev 82)
@@ -50,7 +50,7 @@
 			"\n    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please" +
 			"\n    diff against the source tree, not this file." +
 			"\n" +
-			"\n    Copyright (c) 2006 C?dric Savarese <pro at 4213miles.com>, Troels Knak-Nielsen <troelskn at gmail.com>" +
+			"\n    Copyright (c) 2006-2007 Cedric Savarese <cedric at veerwest.com>, Troels Knak-Nielsen <troelskn at gmail.com>" +
 			"\n    This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>" +
 			"\n" +
 			"\n***" + "/" +
@@ -70,6 +70,9 @@
 		var out = FileSystem.openTextFile(outfile, 2, -2);
 		out.write(header + source);
 		out.close();
+		
+		Shell.CurrentDirectory = cwd;
+		Shell.run("pack.bat");
 	}
 	]]>
 	</script>

Added: branch/2.0.1/custom_rhino.jar
===================================================================
(Binary files differ)


Property changes on: branch/2.0.1/custom_rhino.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: branch/2.0.1/examples/contacts/models/php_inc/inc.resource.php
===================================================================
--- branch/2.0.1/examples/contacts/models/php_inc/inc.resource.php	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/examples/contacts/models/php_inc/inc.resource.php	2007-03-19 22:07:30 UTC (rev 82)
@@ -1,9 +1,12 @@
 <?php
 $request_headers = apache_request_headers();
 if (isset($request_headers['Http-Method-Equivalent'])) {
-	$REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+   $REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+} elseif (isset($request_headers['http-method-equivalent'])) {
+// IE sends the Http-Method-Equivalent header in lowercase!
+    $REQUEST_METHOD = $request_headers['http-method-equivalent'];
 } else {
-	$REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
+   $REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
 }
 
 if ($REQUEST_METHOD == "PUT" || $REQUEST_METHOD == "POST") {

Modified: branch/2.0.1/lib/Freja.js
===================================================================
--- branch/2.0.1/lib/Freja.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/lib/Freja.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -2,9 +2,9 @@
 
     Freja 2.0.1
 
-    Build $Mon, 12 Mar 2007 20:41:24 UTC$
+    Build $Mon, 19 Mar 2007 22:06:59 UTC$
 
-    Target: mochi+sarissa
+    Target: minimal
 
     THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
     diff against the source tree, not this file.
@@ -47,152 +47,662 @@
 	subClass.prototype.superconstructor = superconstructor;
 	subClass.prototype.supertype = superconstructor.prototype;
 };
+
 /**
-  * Freja._aux
-  * wrapper for external dependencies (frameworks).
-  *
-  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
-  *
-  * You shouldn't rely on this functionality - it's merely a hook for Freja towards
-  * external dependencies. This is the only part of the application you'll need to
-  * adjust, to make Freja play ball with your favourite framework.
-  */
-if (typeof(dojo) != "undefined") {
-	dojo.require("MochiKit.Base");
-	dojo.require("MochiKit.Signal");
-	dojo.require("MochiKit.Async");
-	dojo.require("Sarissa");
-}
-if (typeof(JSAN) != "undefined") {
-	JSAN.use("MochiKit.Base", []);
-	JSAN.use("MochiKit.Signal", []);
-	JSAN.use("MochiKit.Async", []);
-	JSAN.use("Sarissa", []);
-}
-try {
-	if (typeof(MochiKit.Base) == "undefined") {
-		throw "";
-	}
-	if (typeof(MochiKit.Signal) == "undefined") {
-		throw "";
-	}
-	if (typeof(MochiKit.Async) == "undefined") {
-		throw "";
-	}
-	if (typeof(Sarissa) == "undefined") {
-		throw "";
-	}
-} catch (e) {
-	throw new Error("Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!");
-}
-if (typeof(Freja) == "undefined") {
-	Freja = {};
-}
-Freja._aux = {};
-/** bind(func, self) : function */
-Freja._aux.bind = MochiKit.Base.bind;
-/** formContents(elem) : Array */
-Freja._aux.formContents = MochiKit.DOM.formContents;
-/** getElement(id) : HTMLElement */
-Freja._aux.getElement = MochiKit.DOM.getElement;
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
 
-/** connect(src, signal, fnc) : void */
-Freja._aux.connect = MochiKit.Signal.connect;
-/** signal(src, signal, arg) : void */
-Freja._aux.signal = MochiKit.Signal.signal;
-/** createDeferred() : Deferred */
-Freja._aux.createDeferred = function() {
-	return new MochiKit.Async.Deferred();
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
 };
-/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
-Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req = new XMLHttpRequest();
-	if (user && pass) {
-		req.open(method, url, async, user, pass);
-	} else {
-		req.open(method, url, async);
-	}
-	if (method == "POST" || method == "PUT") {
-		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
-	}
-	// RoR/cakePHP Ajax request detection compatibility:
-	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
-	return req;
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
 };
-/** sendXMLHttpRequest(req, sendContent) : Deferred */
-Freja._aux.sendXMLHttpRequest = MochiKit.Async.sendXMLHttpRequest;
-/** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = Sarissa.xmlize;
-/** serializeXML(node) : string */
-Freja._aux.serializeXML = function(node) {
-	if (node.xml) return node.xml;
-	return (new XMLSerializer()).serializeToString(node);
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                tmp = document.createElement("table");
+            }
+            else if(oNode.nodeName == "td"){
+                tmp = document.createElement("tr");
+            }
+            else if(oNode.nodeName == "option"){
+                tmp = document.createElement("select");
+            }
+            else{
+                tmp = document.createElement("div");
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName("*")[0];
+        };
+    }catch(e){ };
 };
-/** loadXML(string) : XMLDocument */
-Freja._aux.loadXML = function(text) {
-	return (new DOMParser()).parseFromString(text, "text/xml");
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
 };
-/** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	if(xslParameters) {
-		for (var paramName in xslParameters) {
-			processor.setParameter(null, paramName, xslParameters[paramName]);
-		}
-	}
-	 
-	return processor.transformToFragment(xml, window.document);
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
 };
-/** cloneXMLDocument(document) : XMLDocument */
-Freja._aux.cloneXMLDocument = function(xmlDoc) {
-	var clone = null;
-	try {
-		clone = xmlDoc.cloneNode(true);
-	} catch(e) { /* squelch */ }
-	
-	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
-	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
-	if (!clone) {
-		if (document.implementation && document.implementation.createDocument) {
-			clone = document.implementation.createDocument("", xmlDoc.documentElement.nodeName, null);
-			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
-			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
-			try {
-				clone.appendChild(data);
-			} catch(e) {				
-				// Opera has already created a documentElement and can't append another root node
-				var rootNode = clone.documentElement;
-			
-				for (var i = data.childNodes.length-1; i >= 0; i--) {
-					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
-				}
-				
-				// need to copy root node attributes
-				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
-					var name  = xmlDoc.documentElement.attributes.item(i).name;
-					var value = xmlDoc.documentElement.attributes.item(i).value;
-					clone.documentElement.setAttribute(name, value);
-				}				
-			}
-		}
-	}
-	
-	return clone;
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
 };
 
-/** hasSupportForXSLT() : boolean */
-Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
-/** createQueryEngine() : Freja.QueryEngine */
-Freja._aux.createQueryEngine = function() {
-	if (Sarissa.IS_ENABLED_SELECT_NODES) {
-		return new Freja.QueryEngine.XPath();
-	} else {
-		return new Freja.QueryEngine.SimplePath();
-	}
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
 };
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
 
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
 
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
 /**
  * ====================================================================
  * About
@@ -396,6 +906,294 @@
 if(_SARISSA_IS_IE)
 	 Sarissa.IS_ENABLED_SELECT_NODES = true;
 
+
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the minimal auxiliary adapter. It contains self-sufficient
+  * implementations of all dependencies.
+  * 
+  */
+if (typeof(Freja) == "undefined") {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self) : function */
+// from http://blog.ianbicking.org/prototype-and-object-prototype.html
+Freja._aux.bind = function(func, self) {
+	if(typeof (func)=="string"){
+		func=self[func];
+	}
+
+	var im_func = null;
+    if (typeof(func.im_func) == 'function') {
+        im_func = func.im_func;
+    } else {
+        im_func = func;
+    }
+    func = function () {
+        return func.im_func.apply(func.im_self, arguments);
+    }
+    func.im_func = im_func;
+    func.im_self = self;
+	return func;
+};
+/** formContents(elem) : Array */
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName("INPUT");
+	for (var i = 0; i < inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == "radio" || input.type == "checkbox") {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push("");
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName("TEXTAREA");
+	for (var i = 0; i < textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName("SELECT");
+	for (var i = 0; i < selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex >= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : "");
+			}
+		}
+	}
+	return [names, values];
+};
+/** getElement(id) : HTMLElement */
+Freja._aux.getElement = function(id) {
+	if (typeof(id) == "object") {
+		return id;
+	} else {
+		return document.getElementById(id);
+	}
+};
+
+/** connect(src, signal, fnc) : void */
+Freja._aux.connect = function(src, signal, fnc) {
+
+	if(!src) return;
+	if (src.addEventListener) {
+		var wrapper = function(e) {
+			var evt = {
+				stop : function() {
+					if (e.cancelable) {
+						e.preventDefault();
+					}
+					e.stopPropagation();
+				}
+			}
+			fnc(evt);
+		}
+		src.addEventListener(signal.replace(/^(on)/, ""), wrapper, false);
+	} else if (src.attachEvent) {
+		var wrapper = function() {
+			var e = window.event;
+			var evt = {
+				stop : function() {
+					e.cancelBubble = true;
+					e.returnValue = false;
+				}
+			}
+			fnc(evt);
+		}
+		src.attachEvent(signal, wrapper);
+	}
+	if (!src._signals) {
+		src._signals = [];
+	}
+	if (!src._signals[signal]) {
+		src._signals[signal] = [];
+	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item < src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
+	src._signals[signal].push(fnc);
+};
+/** signal(src, signal, ...) : void */
+Freja._aux.signal = function(src, signal) {
+
+	try {
+		var sigs = src._signals[signal];
+		var args = [];
+		for (var i=2; i < arguments.length; i++) {
+			args.push(arguments[i]);
+		}
+		for (var i=0; i < sigs.length; i++) {
+			try {
+				sigs[i].apply(src, args);
+			} catch (e) { /* squelch */ }
+		}
+	} catch (e) { /* squelch */ }
+};
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new Freja._aux.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user && pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == "POST" || method == "PUT") {
+		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
+	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
+	var d = Freja._aux.createDeferred();
+	var bComplete = false;
+	req.onreadystatechange = function() {
+		if (req.readyState == 4 && !bComplete) {
+			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
+				d.callback(req);
+			} else {
+				d.errback(req);
+			}
+			bComplete = true;
+		}
+	}
+	if (!sendContent) sendContent = "";
+	req.send(sendContent);
+	return d;
+};
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, "text/xml");
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter("", paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+
+	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation && document.implementation.createDocument) {
+			clone = document.implementation.createDocument("", xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+				for (var i = data.childNodes.length; i >= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				// need to copy root node attributes
+				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}
+			}
+		}
+	}
+	return clone;
+};
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};
+/** A pale replacement for MochiKit.Async.Deferred */
+Freja._aux.Deferred = function() {
+	this._good = [];
+	this._bad = [];
+	this._pending = null;
+};
+Freja._aux.Deferred.prototype.callback = function() {
+	if (this._good.length == 0) {
+		this._pending = [this.callback, arguments];
+		return;
+	}
+	for (var i=0; i < this._good.length; i++) {
+		this._good[i].apply(window, arguments);
+	}
+	this._good = [];
+};
+Freja._aux.Deferred.prototype.errback = function() {
+	if (this._bad.length == 0) {
+		this._pending = [this.errback, arguments];
+		return;
+	}
+	for (var i=0; i < this._bad.length; i++) {
+		this._bad[i].apply(window, arguments);
+	}
+	this._bad = [];
+};
+Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
+	if (fncOK) this._good[this._good.length] = fncOK;
+	if (fncError) this._bad[this._bad.length] = fncError;
+	if (this._pending) {
+		this._pending[0].apply(this, this._pending[1]);
+	}
+};
+Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
+	this.addCallbacks(fncOK);
+};
+Freja._aux.Deferred.prototype.addErrback = function(fncError) {
+	this.addCallbacks(null, fncError);
+};
 
 /**
   * The baseclass for queryengines
@@ -463,7 +1261,8 @@
 			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
 				node.firstChild.nodeValue = value;
 			} else {
-				node.appendChild(document.createTextNode(value));
+				if(value!="") // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
 			}
 			break;
 		case 2: /* Attribute */
@@ -603,7 +1402,7 @@
 };
 /**
   * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.save = function() {
 	var url = this.url;
@@ -626,7 +1425,7 @@
 };
 /**
   * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.remove = function() {
 	var url = this.url;
@@ -638,7 +1437,7 @@
 	return Freja._aux.sendXMLHttpRequest(req);
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.reload = function() {
 	this.ready = false;
@@ -699,7 +1498,7 @@
   * @param    model            Freja.Model
   * @param    placeholder      string    If supplied, this will be used instead of the
   *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.prototype.render = function(model, placeholder, xslParameters) {
 	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
@@ -753,7 +1552,11 @@
 
 	var d = Freja._aux.createDeferred();
 	try {
-		this._destination = Freja._aux.getElement(placeholder);
+		if (typeof(placeholder) == "object") {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
 		// @todo    Is this a good idea ?
 		// Perhaps we should leave it to the programmer to do this.
 		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
@@ -841,7 +1644,7 @@
 Freja.View.Renderer.XSLTransformer = function() {};
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
@@ -866,7 +1669,7 @@
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
@@ -1007,8 +1810,8 @@
   * Both IE6 and FF1.5 are known to support the required HTTP methods, so
   * if theese are your target platform, you can disable tunneling.
   */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
 /**
   * Set this url to provide remote xslt-transformation for browsers that
   * doesn't support it natively.
@@ -1100,7 +1903,7 @@
 	this._password = password;
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.AssetManager.loadAsset = function(url, preventCaching) {
 	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);

Added: branch/2.0.1/lib/Freja_pack.js
===================================================================
--- branch/2.0.1/lib/Freja_pack.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/lib/Freja_pack.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -0,0 +1,1385 @@
+if(typeof (dojo)!="undefined"){
+dojo.provide("Freja");
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja.NAME="Freja";
+Freja.VERSION="2.0.1";
+Freja.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+Freja.toString=function(){
+return this.__repr__();
+};
+Freja.Class={};
+Freja.Class.extend=function(_1,_2){
+var _3=function(){
+};
+_3.prototype=_2.prototype;
+_1.prototype=new _3();
+_1.prototype.constructor=_1;
+_1.prototype.superconstructor=_2;
+_1.prototype.supertype=_2.prototype;
+};
+function Sarissa(){
+}
+Sarissa.PARSED_OK="Document contains no parsing errors";
+Sarissa.PARSED_EMPTY="Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR="Not well-formed or other error";
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM="";
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&&_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&&navigator.vendor&&(navigator.userAgent.toLowerCase().indexOf("applewebkit")!=-1||navigator.vendor.indexOf("Apple")!=-1));
+var _SARISSA_IS_IE=document.all&&window.ActiveXObject&&navigator.userAgent.toLowerCase().indexOf("msie")>-1&&navigator.userAgent.toLowerCase().indexOf("opera")==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument=="undefined"&&typeof Document!="undefined"){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM="xsl:";
+var _SARISSA_DOM_PROGID="";
+var _SARISSA_XMLHTTP_PROGID="";
+var _SARISSA_DOM_XMLWRITER="";
+Sarissa.pickRecentProgID=function(_4){
+var _5=false;
+for(var i=0;i<_4.length&&!_5;i++){
+try{
+var _7=new ActiveXObject(_4[i]);
+o2Store=_4[i];
+_5=true;
+}
+catch(objException){
+}
+}
+if(!_5){
+throw "Could not retreive a valid progID of Class: "+_4[_4.length-1]+". (original exception: "+e+")";
+}
+_4=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_8,_9){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"]);
+}
+var _a=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_9){
+var _b="";
+if(_8){
+if(_9.indexOf(":")>1){
+_b=_9.substring(0,_9.indexOf(":"));
+_9=_9.substring(_9.indexOf(":")+1);
+}else{
+_b="a"+(_sarissa_iNsCounter++);
+}
+}
+if(_8){
+_a.loadXML("<"+_b+":"+_9+" xmlns:"+_b+"=\""+_8+"\""+" />");
+}else{
+_a.loadXML("<"+_9+" />");
+}
+}
+return _a;
+};
+Sarissa.getParseErrorText=function(_c){
+var _d=Sarissa.PARSED_OK;
+if(_c.parseError.errorCode!=0){
+_d="XML Parsing Error: "+_c.parseError.reason+"\nLocation: "+_c.parseError.url+"\nLine Number "+_c.parseError.line+", Column "+_c.parseError.linepos+":\n"+_c.parseError.srcText+"\n";
+for(var i=0;i<_c.parseError.linepos;i++){
+_d+="-";
+}
+_d+="^\n";
+}else{
+if(_c.documentElement==null){
+_d=Sarissa.PARSED_EMPTY;
+}
+}
+return _d;
+};
+Sarissa.setXpathNamespaces=function(_f,_10){
+_f.setProperty("SelectionLanguage","XPath");
+_f.setProperty("SelectionNamespaces",_10);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0","MSXML2.XSLTemplate.3.0"]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_11){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0","MSXML2.FreeThreadedDOMDocument.3.0"]);
+}
+_11.setProperty("SelectionLanguage","XPath");
+_11.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _12=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_11.url&&_11.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']")!=null){
+_12.async=false;
+if(_SARISSA_THREADEDDOM_PROGID=="MSXML2.FreeThreadedDOMDocument.6.0"){
+_12.setProperty("AllowDocumentFunction",true);
+_12.resolveExternals=true;
+}
+_12.load(_11.url);
+}else{
+_12.loadXML(_11.xml);
+}
+_12.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _13=_12.selectSingleNode("//xsl:output");
+this.outputMethod=_13?_13.getAttribute("method"):"html";
+this.template.stylesheet=_12;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_14){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_15;
+this.processor.transform();
+return _15;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0","Msxml2.MXXMLWriter.3.0","MSXML2.MXXMLWriter","MSXML.MXXMLWriter","Microsoft.XMLDOM"]);
+}
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_15;
+this.processor.transform();
+var _16=new ActiveXObject(_SARISSA_DOM_PROGID);
+_16.loadXML(_15.output+"");
+return _16;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_17,_18){
+this.processor.input=_17;
+this.processor.transform();
+var s=this.processor.output;
+var f=_18.createDocumentFragment();
+if(this.outputMethod=="text"){
+f.appendChild(_18.createTextNode(s));
+}else{
+if(_18.body&&_18.body.innerHTML){
+var _1b=_18.createElement("div");
+_1b.innerHTML=s;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}else{
+var _1c=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)=="<?xml"){
+s=s.substring(s.indexOf("?>")+2);
+}
+var xml="".concat("<my>",s,"</my>");
+_1c.loadXML(xml);
+var _1b=_1c.documentElement;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1e,_1f,_20){
+if(_1e){
+this.processor.addParameter(_1f,_20,_1e);
+}else{
+this.processor.addParameter(_1f,_20);
+}
+if(!this.paramsSet[""+_1e]){
+this.paramsSet[""+_1e]=new Array();
+}
+this.paramsSet[""+_1e][_1f]=_20;
+};
+XSLTProcessor.prototype.getParameter=function(_21,_22){
+_21=_21||"";
+if(this.paramsSet[_21]&&this.paramsSet[_21][_22]){
+return this.paramsSet[_21][_22];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _23 in this.paramsSet){
+for(var _24 in this.paramsSet[_23]){
+if(_23){
+this.processor.addParameter(_24,null,_23);
+}else{
+this.processor.addParameter(_24,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_25){
+Sarissa.__setReadyState__(_25,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_26,_27){
+_26.readyState=_27;
+_26.readystate=_27;
+if(_26.onreadystatechange!=null&&typeof _26.onreadystatechange=="function"){
+_26.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+if(!_2a.onreadystatechange){
+_2a.onreadystatechange=null;
+}
+if(!_2a.readyState){
+_2a.readyState=0;
+}
+_2a.addEventListener("load",_sarissa_XMLDocument_onload,false);
+return _2a;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&&window.Document&&!Document.prototype.load&&document.implementation.hasFeature("LS","3.0")){
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+return _2d;
+};
+}else{
+Sarissa.getDomDocument=function(_2e,_2f){
+var _30=document.implementation.createDocument(_2e?_2e:null,_2f?_2f:null,null);
+if(_30&&(_2e||_2f)&&!_30.documentElement){
+_30.appendChild(_30.createElementNS(_2e,_2f));
+}
+return _30;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var _33=new XMLHttpRequest();
+_33.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(_31),false);
+_33.send(null);
+return _33.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&&Sarissa.getDomDocument()&&Sarissa.getDomDocument(null,"bar").xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_34,_35){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_34);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)=="undefined")&&_SARISSA_IS_IE){
+try{
+document.importNode=function(_37,_38){
+var tmp;
+if(_37.nodeName=="tbody"||_37.nodeName=="tr"){
+tmp=document.createElement("table");
+}else{
+if(_37.nodeName=="td"){
+tmp=document.createElement("tr");
+}else{
+if(_37.nodeName=="option"){
+tmp=document.createElement("select");
+}else{
+tmp=document.createElement("div");
+}
+}
+}
+if(_38){
+tmp.innerHTML=_37.xml?_37.xml:_37.outerHTML;
+}else{
+tmp.innerHTML=_37.xml?_37.cloneNode(false).xml:_37.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName("*")[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_3a){
+var _3b=Sarissa.PARSED_OK;
+if(!_3a.documentElement){
+_3b=Sarissa.PARSED_EMPTY;
+}else{
+if(_3a.documentElement.tagName=="parsererror"){
+_3b=_3a.documentElement.firstChild.data;
+_3b+="\n"+_3a.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_3a.getElementsByTagName("parsererror").length>0){
+var _3c=_3a.getElementsByTagName("parsererror")[0];
+_3b=Sarissa.getText(_3c,true)+"\n";
+}else{
+if(_3a.parseError&&_3a.parseError.errorCode!=0){
+_3b=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _3b;
+};
+}
+Sarissa.getText=function(_3d,_3e){
+var s="";
+var _40=_3d.childNodes;
+for(var i=0;i<_40.length;i++){
+var _42=_40[i];
+var _43=_42.nodeType;
+if(_43==Node.TEXT_NODE||_43==Node.CDATA_SECTION_NODE){
+s+=_42.data;
+}else{
+if(_3e==true&&(_43==Node.ELEMENT_NODE||_43==Node.DOCUMENT_NODE||_43==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_42,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&&Sarissa.getDomDocument&&Sarissa.getDomDocument("","foo",null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_44){
+return _44.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/<[^>]+>/g,"");
+};
+Sarissa.clearChildNodes=function(_46){
+while(_46.firstChild){
+_46.removeChild(_46.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_47,_48,_49){
+if((!_47)||(!_48)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_49){
+Sarissa.clearChildNodes(_48);
+}
+var _4a=_48.nodeType==Node.DOCUMENT_NODE?_48:_48.ownerDocument;
+var _4b=_47.childNodes;
+if(typeof (_4a.importNode)!="undefined"){
+for(var i=0;i<_4b.length;i++){
+_48.appendChild(_4a.importNode(_4b[i],true));
+}
+}else{
+for(var i=0;i<_4b.length;i++){
+_48.appendChild(_4b[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4d,_4e,_4f){
+if((!_4d)||(!_4e)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_4f){
+Sarissa.clearChildNodes(_4e);
+}
+var _50=_4d.childNodes;
+if(_4d.ownerDocument==_4e.ownerDocument){
+while(_4d.firstChild){
+_4e.appendChild(_4d.firstChild);
+}
+}else{
+var _51=_4e.nodeType==Node.DOCUMENT_NODE?_4e:_4e.ownerDocument;
+if(typeof (_51.importNode)!="undefined"){
+for(var i=0;i<_50.length;i++){
+_4e.appendChild(_51.importNode(_50[i],true));
+}
+}else{
+for(var i=0;i<_50.length;i++){
+_4e.appendChild(_50[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4d);
+}
+};
+Sarissa.xmlize=function(_53,_54,_55){
+_55=_55?_55:"";
+var s=_55+"<"+_54+">";
+var _57=false;
+if(!(_53 instanceof Object)||_53 instanceof Number||_53 instanceof String||_53 instanceof Boolean||_53 instanceof Date){
+s+=Sarissa.escape(""+_53);
+_57=true;
+}else{
+s+="\n";
+var _58="";
+var _59=_53 instanceof Array;
+for(var _5a in _53){
+s+=Sarissa.xmlize(_53[_5a],(_59?"array-item key=\""+_5a+"\"":_5a),_55+"   ");
+}
+s+=_55;
+}
+return s+=(_54.indexOf(" ")!=-1?"</array-item>\n":"</"+_54+">\n");
+};
+Sarissa.escape=function(_5b){
+return _5b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
+};
+Sarissa.unescape=function(_5c){
+return _5c.replace(/&apos;/g,"'").replace(/&quot;/g,"\"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");
+};
+if(_SARISSA_HAS_DOM_FEATURE&&document.implementation.hasFeature("XPath","3.0")){
+function SarissaNodeList(i){
+this.length=i;
+}
+SarissaNodeList.prototype=new Array(0);
+SarissaNodeList.prototype.constructor=Array;
+SarissaNodeList.prototype.item=function(i){
+return (i<0||i>=this.length)?null:this[i];
+};
+SarissaNodeList.prototype.expr="";
+if(window.XMLDocument&&(!XMLDocument.prototype.setProperty)){
+XMLDocument.prototype.setProperty=function(x,y){
+};
+}
+Sarissa.setXpathNamespaces=function(_61,_62){
+_61._sarissa_useCustomResolver=true;
+var _63=_62.indexOf(" ")>-1?_62.split(" "):new Array(_62);
+_61._sarissa_xpathNamespaces=new Array(_63.length);
+for(var i=0;i<_63.length;i++){
+var ns=_63[i];
+var _66=ns.indexOf(":");
+var _67=ns.indexOf("=");
+if(_66>0&&_67>_66+1){
+var _68=ns.substring(_66+1,_67);
+var uri=ns.substring(_67+2,ns.length-1);
+_61._sarissa_xpathNamespaces[_68]=uri;
+}else{
+throw "Bad format on namespace declaration(s) given";
+}
+}
+};
+XMLDocument.prototype._sarissa_useCustomResolver=false;
+XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
+XMLDocument.prototype.selectNodes=function(_6a,_6b,_6c){
+var _6d=this;
+var _6e=this._sarissa_useCustomResolver?function(_6f){
+var s=_6d._sarissa_xpathNamespaces[_6f];
+if(s){
+return s;
+}else{
+throw "No namespace URI found for prefix: '"+_6f+"'";
+}
+}:this.createNSResolver(this.documentElement);
+var _71=null;
+if(!_6c){
+var _72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _73=new SarissaNodeList(_72.snapshotLength);
+_73.expr=_6a;
+for(var i=0;i<_73.length;i++){
+_73[i]=_72.snapshotItem(i);
+}
+_71=_73;
+}else{
+_71=_72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+}
+return _71;
+};
+Element.prototype.selectNodes=function(_75){
+var doc=this.ownerDocument;
+if(doc.selectNodes){
+return doc.selectNodes(_75,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+XMLDocument.prototype.selectSingleNode=function(_77,_78){
+var ctx=_78?_78:null;
+return this.selectNodes(_77,ctx,true);
+};
+Element.prototype.selectSingleNode=function(_7a){
+var doc=this.ownerDocument;
+if(doc.selectSingleNode){
+return doc.selectSingleNode(_7a,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(_SARISSA_IS_IE){
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja._aux={};
+Freja._aux.bind=function(_7c,_7d){
+if(typeof (_7c)=="string"){
+_7c=_7d[_7c];
+}
+var _7e=null;
+if(typeof (_7c.im_func)=="function"){
+_7e=_7c.im_func;
+}else{
+_7e=_7c;
+}
+_7c=function(){
+return _7c.im_func.apply(_7c.im_self,arguments);
+};
+_7c.im_func=_7e;
+_7c.im_self=_7d;
+return _7c;
+};
+Freja._aux.formContents=function(_7f){
+if(!_7f){
+_7f=document;
+}
+var _80=[];
+var _81=[];
+var _82=_7f.getElementsByTagName("INPUT");
+for(var i=0;i<_82.length;++i){
+var _84=_82[i];
+if(_84.name){
+if(_84.type=="radio"||_84.type=="checkbox"){
+if(_84.checked){
+_80.push(_84.name);
+_81.push(_84.value);
+}else{
+_80.push(_84.name);
+_81.push("");
+}
+}else{
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+}
+var _85=_7f.getElementsByTagName("TEXTAREA");
+for(var i=0;i<_85.length;++i){
+var _84=_85[i];
+if(_84.name){
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+var _86=_7f.getElementsByTagName("SELECT");
+for(var i=0;i<_86.length;++i){
+var _84=_86[i];
+if(_84.name){
+if(_84.selectedIndex>=0){
+var opt=_84.options[_84.selectedIndex];
+_80.push(_84.name);
+_81.push((opt.value)?opt.value:"");
+}
+}
+}
+return [_80,_81];
+};
+Freja._aux.getElement=function(id){
+if(typeof (id)=="object"){
+return id;
+}else{
+return document.getElementById(id);
+}
+};
+Freja._aux.connect=function(src,_8a,fnc){
+if(!src){
+return;
+}
+if(src.addEventListener){
+var _8c=function(e){
+var evt={stop:function(){
+if(e.cancelable){
+e.preventDefault();
+}
+e.stopPropagation();
+}};
+fnc(evt);
+};
+src.addEventListener(_8a.replace(/^(on)/,""),_8c,false);
+}else{
+if(src.attachEvent){
+var _8c=function(){
+var e=window.event;
+var evt={stop:function(){
+e.cancelBubble=true;
+e.returnValue=false;
+}};
+fnc(evt);
+};
+src.attachEvent(_8a,_8c);
+}
+}
+if(!src._signals){
+src._signals=[];
+}
+if(!src._signals[_8a]){
+src._signals[_8a]=[];
+}
+for(var _91=0;_91<src._signals[_8a].length;_91++){
+if(src._signals[_8a][_91].toString()==fnc.toString()){
+return;
+}
+}
+src._signals[_8a].push(fnc);
+};
+Freja._aux.signal=function(src,_93){
+try{
+var _94=src._signals[_93];
+var _95=[];
+for(var i=2;i<arguments.length;i++){
+_95.push(arguments[i]);
+}
+for(var i=0;i<_94.length;i++){
+try{
+_94[i].apply(src,_95);
+}
+catch(e){
+}
+}
+}
+catch(e){
+}
+};
+Freja._aux.createDeferred=function(){
+return new Freja._aux.Deferred();
+};
+Freja._aux.openXMLHttpRequest=function(_97,url,_99,_9a,_9b){
+var req=new XMLHttpRequest();
+if(_9a&&_9b){
+req.open(_97,url,_99,_9a,_9b);
+}else{
+req.open(_97,url,_99);
+}
+if(_97=="POST"||_97=="PUT"){
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}
+req.setRequestHeader("X-Requested-With","XMLHttpRequest");
+return req;
+};
+Freja._aux.sendXMLHttpRequest=function(req,_9e){
+var d=Freja._aux.createDeferred();
+var _a0=false;
+req.onreadystatechange=function(){
+if(req.readyState==4&&!_a0){
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+d.callback(req);
+}else{
+d.errback(req);
+}
+_a0=true;
+}
+};
+if(!_9e){
+_9e="";
+}
+req.send(_9e);
+return d;
+};
+Freja._aux.xmlize=Sarissa.xmlize;
+Freja._aux.serializeXML=function(_a1){
+if(_a1.xml){
+return _a1.xml;
+}
+return (new XMLSerializer()).serializeToString(_a1);
+};
+Freja._aux.loadXML=function(_a2){
+return (new DOMParser()).parseFromString(_a2,"text/xml");
+};
+Freja._aux.transformXSL=function(xml,xsl,_a5){
+var _a6=new XSLTProcessor();
+_a6.importStylesheet(xsl);
+if(_a5){
+for(var _a7 in _a5){
+_a6.setParameter("",_a7,_a5[_a7]);
+}
+}
+return _a6.transformToFragment(xml,window.document);
+};
+Freja._aux.cloneXMLDocument=function(_a8){
+var _a9=null;
+try{
+_a9=_a8.cloneNode(true);
+}
+catch(e){
+}
+if(!_a9){
+if(document.implementation&&document.implementation.createDocument){
+_a9=document.implementation.createDocument("",_a8.documentElement.nodeName,null);
+var _aa=_a9.importNode(_a8.documentElement.cloneNode(true),true);
+try{
+_a9.appendChild(_aa);
+}
+catch(e){
+var _ab=_a9.documentElement;
+for(var i=_aa.childNodes.length;i>=0;i--){
+_ab.insertBefore(_aa.childNodes[i],_ab.firstChild);
+}
+for(var i=0;i<_a8.documentElement.attributes.length;i++){
+var _ad=_a8.documentElement.attributes.item(i).name;
+var _ae=_a8.documentElement.attributes.item(i).value;
+_a9.documentElement.setAttribute(_ad,_ae);
+}
+}
+}
+}
+return _a9;
+};
+Freja._aux.hasSupportForXSLT=function(){
+return (typeof (XSLTProcessor)!="undefined");
+};
+Freja._aux.createQueryEngine=function(){
+if(Sarissa.IS_ENABLED_SELECT_NODES){
+return new Freja.QueryEngine.XPath();
+}else{
+return new Freja.QueryEngine.SimplePath();
+}
+};
+Freja._aux.Deferred=function(){
+this._good=[];
+this._bad=[];
+this._pending=null;
+};
+Freja._aux.Deferred.prototype.callback=function(){
+if(this._good.length==0){
+this._pending=[this.callback,arguments];
+return;
+}
+for(var i=0;i<this._good.length;i++){
+this._good[i].apply(window,arguments);
+}
+this._good=[];
+};
+Freja._aux.Deferred.prototype.errback=function(){
+if(this._bad.length==0){
+this._pending=[this.errback,arguments];
+return;
+}
+for(var i=0;i<this._bad.length;i++){
+this._bad[i].apply(window,arguments);
+}
+this._bad=[];
+};
+Freja._aux.Deferred.prototype.addCallbacks=function(_b1,_b2){
+if(_b1){
+this._good[this._good.length]=_b1;
+}
+if(_b2){
+this._bad[this._bad.length]=_b2;
+}
+if(this._pending){
+this._pending[0].apply(this,this._pending[1]);
+}
+};
+Freja._aux.Deferred.prototype.addCallback=function(_b3){
+this.addCallbacks(_b3);
+};
+Freja._aux.Deferred.prototype.addErrback=function(_b4){
+this.addCallbacks(null,_b4);
+};
+Freja.QueryEngine=function(){
+};
+Freja.QueryEngine.prototype.getElementById=function(_b5,id){
+var _b7=_b5.getElementsByTagName("*");
+for(var i=0;i<_b7.length;i++){
+if(_b7[i].getAttribute("id")==id){
+return _b7[i];
+}
+}
+};
+Freja.QueryEngine.prototype.get=function(_b9,_ba){
+var _bb=this._find(_b9,_ba);
+if(!_bb){
+throw new Error("Can't evaluate expression "+_ba);
+}
+switch(_bb.nodeType){
+case 1:
+if(_bb.firstChild&&(_bb.firstChild.nodeType==3||_bb.firstChild.nodeType==4)){
+return _bb.firstChild.nodeValue;
+}
+break;
+case 2:
+return _bb.nodeValue;
+break;
+case 3:
+case 4:
+return _bb.nodeValue;
+break;
+}
+return null;
+};
+Freja.QueryEngine.prototype.set=function(_bc,_bd,_be){
+var _bf=this._find(_bc,_bd);
+if(!_bf){
+var _c0=_bd.substr(_bd.lastIndexOf("/")+1);
+if(_c0.charAt(0)=="@"){
+var _c1=_bd.substring(0,_bd.lastIndexOf("/"));
+var _c2=this._find(_bc,_c1);
+if(_c2){
+_c2.setAttribute(_c0.substr(1),_be);
+return;
+}
+}
+throw new Error("Can't evaluate expression "+_bd);
+}
+switch(_bf.nodeType){
+case 1:
+if(_bf.firstChild&&(_bf.firstChild.nodeType==3||_bf.firstChild.nodeType==4)){
+_bf.firstChild.nodeValue=_be;
+}else{
+if(_be!=""){
+_bf.appendChild(_bc.createTextNode(_be));
+}
+}
+break;
+case 2:
+_bf.nodeValue=_be;
+break;
+case 3:
+case 4:
+_bf.nodeValue=_be;
+break;
+}
+return;
+};
+Freja.QueryEngine.XPath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find=function(_c3,_c4){
+var _c5=_c3.selectSingleNode(_c4);
+return _c5;
+};
+Freja.QueryEngine.SimplePath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find=function(_c6,_c7){
+if(!_c7.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error("Can't evaluate expression "+_c7);
+}
+var _c8=_c7.split("/");
+var _c9=_c6;
+var _ca=new RegExp("^@([\\d\\w]*)");
+var _cb=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+var _cc=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+var _cd=null;
+var _ce=0;
+for(var i=0;i<_c8.length;++i){
+var _d0=_c8[i];
+var _d1=_cc.exec(_d0);
+if(_d1){
+if(i>0&&_c8[i-1]==""){
+var cn=_c9.getElementsByTagName(_d1[1]);
+}else{
+var cn=_c9.childNodes;
+}
+for(var j=0,l=cn.length;j<l;j++){
+if(cn[j].nodeType==1&&cn[j].tagName==_d1[1]&&cn[j].getAttribute(_d1[2])==_d1[3]){
+_c9=cn[j];
+break;
+}
+}
+if(j==l){
+throw new Error("Can't evaluate expression "+_d0);
+}
+}else{
+_ce=_cb.exec(_d0);
+if(_ce){
+_d0=_ce[1];
+_ce=_ce[2]-1;
+}else{
+_ce=0;
+}
+if(_d0!=""){
+_cd=_ca.exec(_d0);
+if(_cd){
+_c9=_c9.getAttributeNode(_cd[1]);
+}else{
+_c9=_c9.getElementsByTagName(_d0).item(_ce);
+}
+}
+}
+}
+if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==3){
+return _c9.firstChild;
+}
+if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==4){
+return _c9.firstChild;
+}
+if(!_c9){
+throw new Error("Can't evaluate expression "+_c7);
+}
+return _c9;
+};
+Freja.Model=function(url,_d5){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._query=_d5;
+};
+Freja.Model.prototype.getElementById=function(id){
+if(this.document){
+return this._query.getElementById(this.document,id);
+}
+return null;
+};
+Freja.Model.prototype.get=function(_d7){
+if(this.document){
+return this._query.get(this.document,_d7);
+}
+return null;
+};
+Freja.Model.prototype.set=function(_d8,_d9){
+if(this.document){
+return this._query.set(this.document,_d8,_d9);
+}
+return null;
+};
+Freja.Model.prototype.updateFrom=function(_da){
+var _db=_da.getValues();
+for(var i=0;i<_db[0].length;++i){
+if(_db[0][i].lastIndexOf("/")!=-1){
+this.set(_db[0][i],_db[1][i]);
+}
+}
+};
+Freja.Model.prototype.save=function(){
+var url=this.url;
+var _de=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_de){
+url=_de[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var req=Freja.AssetManager.openXMLHttpRequest("POST",url);
+try{
+Freja._aux.sendXMLHttpRequest(req,Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback,d),Freja._aux.bind(d.errback,d));
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.Model.prototype.remove=function(){
+var url=this.url;
+var _e2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_e2){
+url=_e2[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("DELETE",url);
+return Freja._aux.sendXMLHttpRequest(req);
+};
+Freja.Model.prototype.reload=function(){
+this.ready=false;
+var _e4=Freja._aux.bind(function(_e5){
+this.document=_e5;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},this);
+var d=Freja.AssetManager.loadAsset(this.url,true);
+d.addCallbacks(_e4,Freja.AssetManager.onerror);
+return d;
+};
+Freja.Model.DataSource=function(_e7,_e8){
+this.createURL=_e7;
+this.indexURL=_e8;
+};
+Freja.Model.DataSource.prototype.select=function(){
+return getModel(this.indexURL);
+};
+Freja.Model.DataSource.prototype.create=function(_e9){
+var url=this.createURL;
+var _eb=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_eb){
+url=_eb[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("PUT",url);
+var _ed={};
+for(var i=0,len=_e9[0].length;i<len;++i){
+_ed[_e9[0][i]]=_e9[1][i];
+}
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_ed,"record"));
+};
+Freja.View=function(url,_f0){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._renderer=_f0;
+this._destination=null;
+this.behaviors=[];
+this.placeholder=null;
+Freja._aux.connect(this,"onrendercomplete",Freja._aux.bind(this._connectBehavior,this));
+};
+Freja.View.prototype.render=function(_f1,_f2,_f3){
+if(typeof (_f2)=="undefined"){
+_f2=this.placeholder;
+}
+if(typeof (_f3)=="undefined"){
+_f3=this.xslParameters;
+}
+var _f4=function(_f5,_f6,_f7,_f8){
+this.model=_f5;
+this.view=_f6;
+this.deferred=_f7;
+this.xslParameters=_f8;
+};
+_f4.prototype.trigger=function(){
+try{
+if(!this.view.ready){
+Freja._aux.connect(this.view,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+if(typeof (this.model)=="object"&&this.model instanceof Freja.Model&&!this.model.ready){
+Freja._aux.connect(this.model,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+var _f9;
+if(typeof (this.model)=="undefined"){
+_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+}else{
+if(this.model instanceof Freja.Model){
+_f9=this.model;
+}else{
+_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
+}
+}
+var _fa=this.view._renderer.transform(_f9,this.view,this.xslParameters);
+_fa.addCallback(Freja._aux.bind(function(_fb){
+if(typeof _fb=="string"){
+this._destination.innerHTML=_fb;
+}else{
+this._destination.innerHTML="";
+this._destination.appendChild(_fb);
+}
+},this.view));
+_fa.addCallback(Freja._aux.bind(function(){
+Freja._aux.signal(this,"onrendercomplete",this._destination);
+},this.view));
+_fa.addCallback(this.deferred.callback);
+_fa.addErrback(this.deferred.errback);
+}
+catch(ex){
+this.deferred.errback(ex);
+}
+};
+var d=Freja._aux.createDeferred();
+try{
+if(typeof (_f2)=="object"){
+this._destination=_f2;
+}else{
+this._destination=document.getElementById(_f2);
+}
+this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
+var h=new _f4(_f1,this,d,_f3);
+h.trigger();
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.prototype._connectBehavior=function(_fe){
+try{
+var _ff=function(node,_101,_102){
+Freja._aux.connect(node,_101,Freja._aux.bind(function(e){
+var _104=false;
+try{
+_104=_102(this);
+}
+catch(ex){
+throw new Error("An error ocurred in user handler.\n"+ex.message);
+}
+finally{
+if(!_104){
+e.stop();
+}
+}
+},node));
+};
+var _105=function(node,_107){
+for(var i=0,c=node.childNodes,l=c.length;i<l;++i){
+var _109=c[i];
+if(_109.nodeType==1){
+if(_109.className){
+var _10a=_109.className.split(" ");
+for(var j=0;j<_10a.length;j++){
+var _10c=_107[_10a[j]];
+if(_10c){
+for(var _10d in _10c){
+if(_10d=="init"){
+_10c.init(_109);
+}else{
+_ff(_109,_10d,_10c[_10d]);
+}
+}
+}
+}
+}
+_105(_109,_107);
+}
+}
+};
+for(var ids in this.behaviors){
+_105(_fe,this.behaviors);
+break;
+}
+}
+catch(ex){
+alert(ex.message);
+}
+};
+Freja.View.prototype.getValues=function(){
+return Freja._aux.formContents(this._destination);
+};
+Freja.View.Renderer=function(){
+};
+Freja.View.Renderer.XSLTransformer=function(){
+};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_10f,view,_111){
+var d=Freja._aux.createDeferred();
+try{
+var html=Freja._aux.transformXSL(_10f.document,view.document,_111);
+if(!html){
+d.errback(new Error("XSL Transformation error."));
+}else{
+d.callback(html);
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.Renderer.RemoteXSLTransformer=function(url){
+this.url=url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_115,view,_117){
+var d=Freja._aux.createDeferred();
+var _119=view.url;
+var _11a="xslFile="+encodeURIComponent(_119)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_115.document));
+var _11b="";
+for(var _11c in _117){
+_11b+=encodeURIComponent(_11c+","+_117[_11c]);
+}
+if(_11b.length>0){
+_11a=_11a+"&xslParam="+_11b;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
+req.onreadystatechange=function(){
+if(req.readyState==4){
+if(req.status==200){
+d.callback(req.responseText);
+}else{
+d.errback(req.responseText);
+}
+}
+};
+req.send(_11a);
+return d;
+};
+Freja.UndoHistory=function(){
+this.cache=[];
+this.maxLength=5;
+this._position=0;
+this._undoSteps=0;
+};
+Freja.UndoHistory.prototype.add=function(_11e){
+var _11f=this._position%this.maxLength;
+var _120=_11e.document;
+this.cache[_11f]={};
+this.cache[_11f].model=_11e;
+this.cache[_11f].document=Freja._aux.cloneXMLDocument(_120);
+if(!this.cache[_11f].document){
+throw new Error("Couldn't add to history.");
+}else{
+this._position++;
+var _121=_11f;
+while(this._undoSteps>0){
+_121=(_121+1)%this.maxLength;
+this.cache[_121]={};
+this._undoSteps--;
+}
+return _11f;
+}
+};
+Freja.UndoHistory.prototype.undo=function(_122){
+if(this._undoSteps<this.cache.length){
+this._undoSteps++;
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+var _123=this.cache[this._position].model;
+if(this.cache[this._position].document){
+_123.document=this.cache[this._position].document;
+}else{
+throw new Error("The model's DOMDocument wasn't properly copied into the history");
+}
+if(typeof (_122)!="undefined"&&_122>1){
+this.undo(_122-1);
+}
+}else{
+throw new Error("Nothing to undo");
+}
+};
+Freja.UndoHistory.prototype.redo=function(){
+if(this._undoSteps>0){
+this._undoSteps--;
+this._position=(this._position+1)%this.maxLength;
+var _124=this.cache[this._position].model;
+_124.document=this.cache[this._position].document;
+}else{
+throw new Error("Nothing to redo");
+}
+};
+Freja.UndoHistory.prototype.removeLast=function(){
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+this.cache[this._position]={};
+this._undoSteps=0;
+};
+Freja.AssetManager={models:[],views:[],_username:null,_password:null};
+Freja.AssetManager.HTTP_REQUEST_TYPE="async";
+Freja.AssetManager.HTTP_METHOD_TUNNEL="Http-Method-Equivalent";
+Freja.AssetManager.XSLT_SERVICE_URL="srvc-xslt.php";
+Freja.AssetManager.THROBBER_HTML="<span style='color:white;background:firebrick'>Loading ...</span>";
+Freja.AssetManager.createRenderer=function(){
+if(Freja._aux.hasSupportForXSLT()){
+return new Freja.View.Renderer.XSLTransformer();
+}else{
+return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+}
+};
+Freja.AssetManager.clearCache=function(){
+this.models=[];
+this.views=[];
+};
+Freja.AssetManager.getModel=function(url){
+for(var i=0;i<this.models.length;i++){
+if(this.models[i].url==url){
+return this.models[i];
+}
+}
+var m=new Freja.Model(url,Freja._aux.createQueryEngine());
+var _128=Freja._aux.bind(function(_129){
+this.document=_129;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},m);
+this.loadAsset(url,true).addCallbacks(_128,Freja.AssetManager.onerror);
+this.models.push(m);
+return m;
+};
+Freja.AssetManager.getView=function(url){
+for(var i=0;i<this.views.length;i++){
+if(this.views[i].url==url){
+return this.views[i];
+}
+}
+var v=new Freja.View(url,this.createRenderer());
+var _12d=Freja._aux.bind(function(_12e){
+this.document=_12e;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},v);
+this.loadAsset(url,false).addCallbacks(_12d,Freja.AssetManager.onerror);
+this.views.push(v);
+return v;
+};
+Freja.AssetManager.openXMLHttpRequest=function(_12f,url){
+var _131=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_12f!="GET"&&_12f!="POST"){
+_131=_12f;
+_12f="POST";
+}
+var req=Freja._aux.openXMLHttpRequest(_12f,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_131){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_131);
+}
+return req;
+};
+Freja.AssetManager.setCredentials=function(_133,_134){
+this._username=_133;
+this._password=_134;
+};
+Freja.AssetManager.loadAsset=function(url,_136){
+var _137=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_137){
+url=_137[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var _139=function(_13a){
+try{
+if(_13a.responseText==""){
+throw new Error("Empty response.");
+}
+if(_13a.responseXML.xml==""){
+var _13b=Freja._aux.loadXML(_13a.responseText);
+}else{
+var _13b=_13a.responseXML;
+}
+}
+catch(ex){
+d.errback(ex);
+}
+if(window.document.all){
+setTimeout(function(){
+d.callback(_13b);
+},1);
+}else{
+d.callback(_13b);
+}
+};
+try{
+if(_136&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}else{
+var req=Freja._aux.openXMLHttpRequest("GET",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+}
+var comm=Freja._aux.sendXMLHttpRequest(req);
+if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
+comm.addCallbacks(_139,function(req){
+d.errback(new Error("Request failed:"+req.status));
+});
+}else{
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+_139(req);
+}else{
+d.errback(new Error("Request failed:"+req.status));
+}
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.AssetManager.onerror=function(ex){
+alert("Freja.AssetManager.onerror\n"+ex.message);
+};
+window.getModel=Freja._aux.bind("getModel",Freja.AssetManager);
+window.getView=Freja._aux.bind("getView",Freja.AssetManager);
+

Modified: branch/2.0.1/lib/MochiKit.js
===================================================================
--- branch/2.0.1/lib/MochiKit.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/lib/MochiKit.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -2255,7 +2255,7 @@
 }
 catch(e){
 }
-if(_290==200||_290==304){
+if(_290==0||_290==200||_290==201||_290==304){
 d.callback(this);
 }else{
 var err=new MochiKit.Async.XMLHttpRequestError(this,"Request failed");

Modified: branch/2.0.1/lib/Sarissa.js
===================================================================
--- branch/2.0.1/lib/Sarissa.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/lib/Sarissa.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -1,653 +1,662 @@
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
- * The library supports Gecko based browsers like Mozilla and Firefox,
- * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
- * @version 0.9.7.6
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- * ====================================================================
- * Licence
- * ====================================================================
- * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
- * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
- * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
- * you make modifications under the ASL, i would appreciate it if you submitted those.
- * In case your copy of Sarissa does not include the license texts, you may find
- * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
- * <a href="http://www.apache.org">http://www.apache.org</a>.
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
- * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
- * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
- * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
- * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
- * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
- * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- */
-/**
- * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
- * DOM Node serialization to XML strings and other utility goodies.</p>
- * @constructor
- */
-function Sarissa(){};
-Sarissa.PARSED_OK = "Document contains no parsing errors";
-Sarissa.PARSED_EMPTY = "Document is empty";
-Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
-var _sarissa_iNsCounter = 0;
-var _SARISSA_IEPREFIX4XSLPARAM = "";
-var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
-var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
-var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
-var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
-var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
-var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
-if(!window.Node || !Node.ELEMENT_NODE){
-    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
-};
-
-if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
-
-// IE initialization
-if(_SARISSA_IS_IE){
-    // for XSLT parameter names, prefix needed by IE
-    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
-    // used to store the most recent ProgID available out of the above
-    var _SARISSA_DOM_PROGID = "";
-    var _SARISSA_XMLHTTP_PROGID = "";
-    var _SARISSA_DOM_XMLWRITER = "";
-    /**
-     * Called when the Sarissa_xx.js file is parsed, to pick most recent
-     * ProgIDs for IE, then gets destroyed.
-     * @private
-     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
-     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
-     */
-    Sarissa.pickRecentProgID = function (idList){
-        // found progID flag
-        var bFound = false;
-        for(var i=0; i < idList.length && !bFound; i++){
-            try{
-                var oDoc = new ActiveXObject(idList[i]);
-                o2Store = idList[i];
-                bFound = true;
-            }catch (objException){
-                // trap; try next progID
-            };
-        };
-        if (!bFound) {
-            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
-        };
-        idList = null;
-        return o2Store;
-    };
-    // pick best available MSXML progIDs
-    _SARISSA_DOM_PROGID = null;
-    _SARISSA_THREADEDDOM_PROGID = null;
-    _SARISSA_XSLTEMPLATE_PROGID = null;
-    _SARISSA_XMLHTTP_PROGID = null;
-    if(!window.XMLHttpRequest){
-        /**
-         * Emulate XMLHttpRequest
-         * @constructor
-         */
-        XMLHttpRequest = function() {
-            if(!_SARISSA_XMLHTTP_PROGID){
-                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
-            };
-            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
-        };
-    };
-    // we dont need this anymore
-    //============================================
-    // Factory methods (IE)
-    //============================================
-    // see non-IE version
-    Sarissa.getDomDocument = function(sUri, sName){
-        if(!_SARISSA_DOM_PROGID){
-            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
-        };
-        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        // if a root tag name was provided, we need to load it in the DOM object
-        if (sName){
-            // create an artifical namespace prefix 
-            // or reuse existing prefix if applicable
-            var prefix = "";
-            if(sUri){
-                if(sName.indexOf(":") > 1){
-                    prefix = sName.substring(0, sName.indexOf(":"));
-                    sName = sName.substring(sName.indexOf(":")+1); 
-                }else{
-                    prefix = "a" + (_sarissa_iNsCounter++);
-                };
-            };
-            // use namespaces if a namespace URI exists
-            if(sUri){
-                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
-            } else {
-                oDoc.loadXML('<' + sName + " />");
-            };
-        };
-        return oDoc;
-    };
-    // see non-IE version   
-    Sarissa.getParseErrorText = function (oDoc) {
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc.parseError.errorCode != 0){
-            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
-                "\nLocation: " + oDoc.parseError.url + 
-                "\nLine Number " + oDoc.parseError.line + ", Column " + 
-                oDoc.parseError.linepos + 
-                ":\n" + oDoc.parseError.srcText +
-                "\n";
-            for(var i = 0;  i < oDoc.parseError.linepos;i++){
-                parseErrorText += "-";
-            };
-            parseErrorText +=  "^\n";
-        }
-        else if(oDoc.documentElement == null){
-            parseErrorText = Sarissa.PARSED_EMPTY;
-        };
-        return parseErrorText;
-    };
-    // see non-IE version
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        oDoc.setProperty("SelectionLanguage", "XPath");
-        oDoc.setProperty("SelectionNamespaces", sNsSet);
-    };   
-    /**
-     * Basic implementation of Mozilla's XSLTProcessor for IE. 
-     * Reuses the same XSLT stylesheet for multiple transforms
-     * @constructor
-     */
-    XSLTProcessor = function(){
-        if(!_SARISSA_XSLTEMPLATE_PROGID){
-            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
-        };
-        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-        this.processor = null;
-    };
-    /**
-     * Imports the given XSLT DOM and compiles it to a reusable transform
-     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
-     * @argument xslDoc The XSLT DOMDocument to import
-     */
-    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-        if(!_SARISSA_THREADEDDOM_PROGID){
-            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-        };
-        xslDoc.setProperty("SelectionLanguage", "XPath");
-        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-        // convert stylesheet to free threaded
-        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-        // make included/imported stylesheets work if exist and xsl was originally loaded from url
-        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
-            converted.async = false;
-            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
-                converted.setProperty("AllowDocumentFunction", true); 
-                converted.resolveExternals = true; 
-            }
-            converted.load(xslDoc.url);
-        } else {
-            converted.loadXML(xslDoc.xml);
-        };
-        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-        var output = converted.selectSingleNode("//xsl:output");
-        this.outputMethod = output ? output.getAttribute("method") : "html";
-        this.template.stylesheet = converted;
-        this.processor = this.template.createProcessor();
-        // for getParameter and clearParameters
-        this.paramsSet = new Array();
-    };
-
-    /**
-     * Transform the given XML DOM and return the transformation result as a new DOM document
-     * @argument sourceDoc The XML DOMDocument to transform
-     * @return The transformation result as a DOM Document
-     */
-    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-        // fix for bug 1549749
-        if(_SARISSA_THREADEDDOM_PROGID){
-            this.processor.input=sourceDoc;
-            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
-            this.processor.output=outDoc;
-            this.processor.transform();
-            return outDoc;
-        }
-        else{
-            if(!_SARISSA_DOM_XMLWRITER){
-                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
-            };
-            this.processor.input = sourceDoc;
-            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
-            this.processor.output = outDoc; 
-            this.processor.transform();
-            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-            oDoc.loadXML(outDoc.output+"");
-            return oDoc;
-        };
-    };
-    
-    /**
-     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
-     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
-     * @argument sourceDoc The XML DOMDocument to transform
-     * @argument ownerDoc The owner of the result fragment
-     * @return The transformation result as a DOM Document
-     */
-    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
-        this.processor.input = sourceDoc;
-        this.processor.transform();
-        var s = this.processor.output;
-        var f = ownerDoc.createDocumentFragment();
-        if (this.outputMethod == 'text') {
-            f.appendChild(ownerDoc.createTextNode(s));
-        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
-            var container = ownerDoc.createElement('div');
-            container.innerHTML = s;
-            while (container.hasChildNodes()) {
-                f.appendChild(container.firstChild);
-            }
-        }
-        else {
-            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-            if (s.substring(0, 5) == '<?xml') {
-                s = s.substring(s.indexOf('?>') + 2);
-            }
-            var xml = ''.concat('<my>', s, '</my>');
-            oDoc.loadXML(xml);
-            var container = oDoc.documentElement;
-            while (container.hasChildNodes()) {
-                f.appendChild(container.firstChild);
-            }
-        }
-        return f;
-    };
-    
-    /**
-     * Set global XSLT parameter of the imported stylesheet
-     * @argument nsURI The parameter namespace URI
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     */
-    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-        // nsURI is optional but cannot be null 
-        if(nsURI){
-            this.processor.addParameter(name, value, nsURI);
-        }else{
-            this.processor.addParameter(name, value);
-        };
-        // update updated params for getParameter 
-        if(!this.paramsSet[""+nsURI]){
-            this.paramsSet[""+nsURI] = new Array();
-        };
-        this.paramsSet[""+nsURI][name] = value;
-    };
-    /**
-     * Gets a parameter if previously set by setParameter. Returns null
-     * otherwise
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     * @return The parameter value if reviously set by setParameter, null otherwise
-     */
-    XSLTProcessor.prototype.getParameter = function(nsURI, name){
-        nsURI = nsURI || "";
-        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
-            return this.paramsSet[nsURI][name];
-        }else{
-            return null;
-        };
-    };
-    /**
-     * Clear parameters (set them to default values as defined in the stylesheet itself)
-     */
-    XSLTProcessor.prototype.clearParameters = function(){
-        for(var nsURI in this.paramsSet){
-            for(var name in this.paramsSet[nsURI]){
-                if(nsURI){
-                    this.processor.addParameter(name, null, nsURI);
-                }else{
-                    this.processor.addParameter(name, null);
-                };
-            };
-        };
-        this.paramsSet = new Array();
-    };
-}else{ /* end IE initialization, try to deal with real browsers now ;-) */
-    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
-        /**
-         * <p>Ensures the document was loaded correctly, otherwise sets the
-         * parseError to -1 to indicate something went wrong. Internal use</p>
-         * @private
-         */
-        Sarissa.__handleLoad__ = function(oDoc){
-            Sarissa.__setReadyState__(oDoc, 4);
-        };
-        /**
-        * <p>Attached by an event handler to the load event. Internal use.</p>
-        * @private
-        */
-        _sarissa_XMLDocument_onload = function(){
-            Sarissa.__handleLoad__(this);
-        };
-        /**
-         * <p>Sets the readyState property of the given DOM Document object.
-         * Internal use.</p>
-         * @private
-         * @argument oDoc the DOM Document object to fire the
-         *          readystatechange event
-         * @argument iReadyState the number to change the readystate property to
-         */
-        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
-            oDoc.readyState = iReadyState;
-            oDoc.readystate = iReadyState;
-            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
-                oDoc.onreadystatechange();
-        };
-        Sarissa.getDomDocument = function(sUri, sName){
-            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
-            if(!oDoc.onreadystatechange){
-            
-                /**
-                * <p>Emulate IE's onreadystatechange attribute</p>
-                */
-                oDoc.onreadystatechange = null;
-            };
-            if(!oDoc.readyState){
-                /**
-                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
-                * <ul><li>1 == LOADING,</li>
-                * <li>2 == LOADED,</li>
-                * <li>3 == INTERACTIVE,</li>
-                * <li>4 == COMPLETED</li></ul>
-                */
-                oDoc.readyState = 0;
-            };
-            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
-            return oDoc;
-        };
-        if(window.XMLDocument){
-            // do nothing
-        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
-        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
-            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
-            /**
-            * <p>Factory method to obtain a new DOM Document object</p>
-            * @argument sUri the namespace of the root node (if any)
-            * @argument sUri the local name of the root node (if any)
-            * @returns a new DOM Document
-            */
-            Sarissa.getDomDocument = function(sUri, sName){
-                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
-                return oDoc;
-            };
-        }
-        else {
-            Sarissa.getDomDocument = function(sUri, sName){
-                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
-                // looks like safari does not create the root element for some unknown reason
-                if(oDoc && (sUri || sName) && !oDoc.documentElement){
-                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
-                };
-                return oDoc;
-            };
-        };
-    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
-};
-//==========================================
-// Common stuff
-//==========================================
-if(!window.DOMParser){
-    if(_SARISSA_IS_SAFARI){
-        /*
-         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
-         * @constructor
-         */
-        DOMParser = function() { };
-        /** 
-        * Construct a new DOM Document from the given XMLstring
-        * @param sXml the given XML string
-        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
-        * @return a new DOM Document from the given XML string
-        */
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            var xmlhttp = new XMLHttpRequest();
-            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
-            xmlhttp.send(null);
-            return xmlhttp.responseXML;
-        };
-    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
-        DOMParser = function() { };
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            var doc = Sarissa.getDomDocument();
-            doc.loadXML(sXml);
-            return doc;
-        };
-    };
-};
-
-if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
-    try{
-        /**
-        * Implementation of importNode for the context window document in IE
-        * @param oNode the Node to import
-        * @param bChildren whether to include the children of oNode
-        * @returns the imported node for further use
-        */
-        document.importNode = function(oNode, bChildren){
-            var tmp;
-            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
-                tmp = document.createElement("table");
-            }
-            else if(oNode.nodeName == "td"){
-                tmp = document.createElement("tr");
-            }
-            else if(oNode.nodeName == "option"){
-                tmp = document.createElement("select");
-            }
-            else{
-                tmp = document.createElement("div");
-            };
-            if(bChildren){
-                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
-            }else{
-                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
-            };
-            return tmp.getElementsByTagName("*")[0];
-        };
-    }catch(e){ };
-};
-if(!Sarissa.getParseErrorText){
-    /**
-     * <p>Returns a human readable description of the parsing error. Usefull
-     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
-     * element if you want to render it.</p>
-     * <p>Many thanks to Christian Stocker for the initial patch.</p>
-     * @argument oDoc The target DOM document
-     * @returns The parsing error description of the target Document in
-     *          human readable form (preformated text)
-     */
-    Sarissa.getParseErrorText = function (oDoc){
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(!oDoc.documentElement){
-            parseErrorText = Sarissa.PARSED_EMPTY;
-        } else if(oDoc.documentElement.tagName == "parsererror"){
-            parseErrorText = oDoc.documentElement.firstChild.data;
-            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
-        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
-            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
-            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
-        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
-            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
-        };
-        return parseErrorText;
-    };
-};
-Sarissa.getText = function(oNode, deep){
-    var s = "";
-    var nodes = oNode.childNodes;
-    for(var i=0; i < nodes.length; i++){
-        var node = nodes[i];
-        var nodeType = node.nodeType;
-        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
-            s += node.data;
-        } else if(deep == true
-                    && (nodeType == Node.ELEMENT_NODE
-                        || nodeType == Node.DOCUMENT_NODE
-                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
-            s += Sarissa.getText(node, true);
-        };
-    };
-    return s;
-};
-if(!window.XMLSerializer 
-    && Sarissa.getDomDocument 
-    && Sarissa.getDomDocument("","foo", null).xml){
-    /**
-     * Utility class to serialize DOM Node objects to XML strings
-     * @constructor
-     */
-    XMLSerializer = function(){};
-    /**
-     * Serialize the given DOM Node to an XML string
-     * @param oNode the DOM Node to serialize
-     */
-    XMLSerializer.prototype.serializeToString = function(oNode) {
-        return oNode.xml;
-    };
-};
-
-/**
- * strips tags from a markup string
- */
-Sarissa.stripTags = function (s) {
-    return s.replace(/<[^>]+>/g,"");
-};
-/**
- * <p>Deletes all child nodes of the given node</p>
- * @argument oNode the Node to empty
- */
-Sarissa.clearChildNodes = function(oNode) {
-    // need to check for firstChild due to opera 8 bug with hasChildNodes
-    while(oNode.firstChild) {
-        oNode.removeChild(oNode.firstChild);
-    };
-};
-/**
- * <p> Copies the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before 
- * the copy operation, unless you supply a true third parameter</p>
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
- */
-Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw "Both source and destination nodes must be provided";
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-    var nodes = nodeFrom.childNodes;
-    if(typeof(ownerDoc.importNode) != "undefined")  {
-        for(var i=0;i < nodes.length;i++) {
-            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-        };
-    } else {
-        for(var i=0;i < nodes.length;i++) {
-            nodeTo.appendChild(nodes[i].cloneNode(true));
-        };
-    };
-};
-
-/**
- * <p> Moves the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before 
- * the move operation, unless you supply a true third parameter</p>
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
- */ 
-Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw "Both source and destination nodes must be provided";
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var nodes = nodeFrom.childNodes;
-    // if within the same doc, just move, else copy and delete
-    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
-        while(nodeFrom.firstChild){
-            nodeTo.appendChild(nodeFrom.firstChild);
-        };
-    } else {
-        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-        if(typeof(ownerDoc.importNode) != "undefined") {
-           for(var i=0;i < nodes.length;i++) {
-               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-           };
-        }else{
-           for(var i=0;i < nodes.length;i++) {
-               nodeTo.appendChild(nodes[i].cloneNode(true));
-           };
-        };
-        Sarissa.clearChildNodes(nodeFrom);
-    };
-};
-
-/** 
- * <p>Serialize any object to an XML string. All properties are serialized using the property name
- * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
- * using their index/key as the value of the <code>key</code> attribute.</p>
- * @argument anyObject the object to serialize
- * @argument objectName a name for that object
- * @return the XML serializationj of the given object as a string
- */
-Sarissa.xmlize = function(anyObject, objectName, indentSpace){
-    indentSpace = indentSpace?indentSpace:'';
-    var s = indentSpace  + '<' + objectName + '>';
-    var isLeaf = false;
-    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
-        || anyObject instanceof Boolean || anyObject instanceof Date){
-        s += Sarissa.escape(""+anyObject);
-        isLeaf = true;
-    }else{
-        s += "\n";
-        var itemKey = '';
-        var isArrayItem = anyObject instanceof Array;
-        for(var name in anyObject){
-            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
-        };
-        s += indentSpace;
-    };
-    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
-};
-
-/** 
- * Escape the given string chacters that correspond to the five predefined XML entities
- * @param sXml the string to escape
- */
-Sarissa.escape = function(sXml){
-    return sXml.replace(/&/g, "&amp;")
-        .replace(/</g, "&lt;")
-        .replace(/>/g, "&gt;")
-        .replace(/"/g, "&quot;")
-        .replace(/'/g, "&apos;");
-};
-
-/** 
- * Unescape the given string. This turns the occurences of the predefined XML 
- * entities to become the characters they represent correspond to the five predefined XML entities
- * @param sXml the string to unescape
- */
-Sarissa.unescape = function(sXml){
-    return sXml.replace(/&apos;/g,"'")
-        .replace(/&quot;/g,"\"")
-        .replace(/&gt;/g,">")
-        .replace(/&lt;/g,"<")
-        .replace(/&amp;/g,"&");
-};
-//   EOF
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version @sarissa.version@
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // make value a zero length string if null to allow clearing
+        value = (value) ? value : "";
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, "", nsURI);
+                }else{
+                    this.processor.addParameter(name, "");
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+    		//Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE.
+        * If <code>oNode</code> is a TextNode, <code>bChildren</code> is ignored.
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if (oNode.nodeName=='#text') {
+                return document.createTextElement(oNode.data);
+            }
+            else {
+                if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                    tmp = document.createElement("table");
+                }
+                else if(oNode.nodeName == "td"){
+                    tmp = document.createElement("tr");
+                }
+                else if(oNode.nodeName == "option"){
+                    tmp = document.createElement("select");
+                }
+                else{
+                    tmp = document.createElement("div");
+                };
+                if(bChildren){
+                    tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+                }else{
+                    tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+                };
+                return tmp.getElementsByTagName("*")[0];
+            };
+            
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
+};
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+//   EOF

Added: branch/2.0.1/lib/Sarissa_pack.js
===================================================================
--- branch/2.0.1/lib/Sarissa_pack.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/lib/Sarissa_pack.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -0,0 +1,425 @@
+function Sarissa(){
+}
+Sarissa.PARSED_OK="Document contains no parsing errors";
+Sarissa.PARSED_EMPTY="Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR="Not well-formed or other error";
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM="";
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&&_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&&navigator.vendor&&(navigator.userAgent.toLowerCase().indexOf("applewebkit")!=-1||navigator.vendor.indexOf("Apple")!=-1));
+var _SARISSA_IS_IE=document.all&&window.ActiveXObject&&navigator.userAgent.toLowerCase().indexOf("msie")>-1&&navigator.userAgent.toLowerCase().indexOf("opera")==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument=="undefined"&&typeof Document!="undefined"){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM="xsl:";
+var _SARISSA_DOM_PROGID="";
+var _SARISSA_XMLHTTP_PROGID="";
+var _SARISSA_DOM_XMLWRITER="";
+Sarissa.pickRecentProgID=function(_1){
+var _2=false;
+for(var i=0;i<_1.length&&!_2;i++){
+try{
+var _4=new ActiveXObject(_1[i]);
+o2Store=_1[i];
+_2=true;
+}
+catch(objException){
+}
+}
+if(!_2){
+throw "Could not retreive a valid progID of Class: "+_1[_1.length-1]+". (original exception: "+e+")";
+}
+_1=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_5,_6){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"]);
+}
+var _7=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_6){
+var _8="";
+if(_5){
+if(_6.indexOf(":")>1){
+_8=_6.substring(0,_6.indexOf(":"));
+_6=_6.substring(_6.indexOf(":")+1);
+}else{
+_8="a"+(_sarissa_iNsCounter++);
+}
+}
+if(_5){
+_7.loadXML("<"+_8+":"+_6+" xmlns:"+_8+"=\""+_5+"\""+" />");
+}else{
+_7.loadXML("<"+_6+" />");
+}
+}
+return _7;
+};
+Sarissa.getParseErrorText=function(_9){
+var _a=Sarissa.PARSED_OK;
+if(_9.parseError.errorCode!=0){
+_a="XML Parsing Error: "+_9.parseError.reason+"\nLocation: "+_9.parseError.url+"\nLine Number "+_9.parseError.line+", Column "+_9.parseError.linepos+":\n"+_9.parseError.srcText+"\n";
+for(var i=0;i<_9.parseError.linepos;i++){
+_a+="-";
+}
+_a+="^\n";
+}else{
+if(_9.documentElement==null){
+_a=Sarissa.PARSED_EMPTY;
+}
+}
+return _a;
+};
+Sarissa.setXpathNamespaces=function(_c,_d){
+_c.setProperty("SelectionLanguage","XPath");
+_c.setProperty("SelectionNamespaces",_d);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0","MSXML2.XSLTemplate.3.0"]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_e){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0","MSXML2.FreeThreadedDOMDocument.3.0"]);
+}
+_e.setProperty("SelectionLanguage","XPath");
+_e.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _f=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_e.url&&_e.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']")!=null){
+_f.async=false;
+if(_SARISSA_THREADEDDOM_PROGID=="MSXML2.FreeThreadedDOMDocument.6.0"){
+_f.setProperty("AllowDocumentFunction",true);
+_f.resolveExternals=true;
+}
+_f.load(_e.url);
+}else{
+_f.loadXML(_e.xml);
+}
+_f.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _10=_f.selectSingleNode("//xsl:output");
+this.outputMethod=_10?_10.getAttribute("method"):"html";
+this.template.stylesheet=_f;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_11){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_12;
+this.processor.transform();
+return _12;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0","Msxml2.MXXMLWriter.3.0","MSXML2.MXXMLWriter","MSXML.MXXMLWriter","Microsoft.XMLDOM"]);
+}
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_12;
+this.processor.transform();
+var _13=new ActiveXObject(_SARISSA_DOM_PROGID);
+_13.loadXML(_12.output+"");
+return _13;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_14,_15){
+this.processor.input=_14;
+this.processor.transform();
+var s=this.processor.output;
+var f=_15.createDocumentFragment();
+if(this.outputMethod=="text"){
+f.appendChild(_15.createTextNode(s));
+}else{
+if(_15.body&&_15.body.innerHTML){
+var _18=_15.createElement("div");
+_18.innerHTML=s;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}else{
+var _19=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)=="<?xml"){
+s=s.substring(s.indexOf("?>")+2);
+}
+var xml="".concat("<my>",s,"</my>");
+_19.loadXML(xml);
+var _18=_19.documentElement;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1b,_1c,_1d){
+if(_1b){
+this.processor.addParameter(_1c,_1d,_1b);
+}else{
+this.processor.addParameter(_1c,_1d);
+}
+if(!this.paramsSet[""+_1b]){
+this.paramsSet[""+_1b]=new Array();
+}
+this.paramsSet[""+_1b][_1c]=_1d;
+};
+XSLTProcessor.prototype.getParameter=function(_1e,_1f){
+_1e=_1e||"";
+if(this.paramsSet[_1e]&&this.paramsSet[_1e][_1f]){
+return this.paramsSet[_1e][_1f];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _20 in this.paramsSet){
+for(var _21 in this.paramsSet[_20]){
+if(_20){
+this.processor.addParameter(_21,null,_20);
+}else{
+this.processor.addParameter(_21,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_22){
+Sarissa.__setReadyState__(_22,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_23,_24){
+_23.readyState=_24;
+_23.readystate=_24;
+if(_23.onreadystatechange!=null&&typeof _23.onreadystatechange=="function"){
+_23.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_25,_26){
+var _27=document.implementation.createDocument(_25?_25:null,_26?_26:null,null);
+if(!_27.onreadystatechange){
+_27.onreadystatechange=null;
+}
+if(!_27.readyState){
+_27.readyState=0;
+}
+_27.addEventListener("load",_sarissa_XMLDocument_onload,false);
+return _27;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&&window.Document&&!Document.prototype.load&&document.implementation.hasFeature("LS","3.0")){
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+return _2a;
+};
+}else{
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+if(_2d&&(_2b||_2c)&&!_2d.documentElement){
+_2d.appendChild(_2d.createElementNS(_2b,_2c));
+}
+return _2d;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_2e,_2f){
+var _30=new XMLHttpRequest();
+_30.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(_2e),false);
+_30.send(null);
+return _30.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&&Sarissa.getDomDocument()&&Sarissa.getDomDocument(null,"bar").xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_31);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)=="undefined")&&_SARISSA_IS_IE){
+try{
+document.importNode=function(_34,_35){
+var tmp;
+if(_34.nodeName=="tbody"||_34.nodeName=="tr"){
+tmp=document.createElement("table");
+}else{
+if(_34.nodeName=="td"){
+tmp=document.createElement("tr");
+}else{
+if(_34.nodeName=="option"){
+tmp=document.createElement("select");
+}else{
+tmp=document.createElement("div");
+}
+}
+}
+if(_35){
+tmp.innerHTML=_34.xml?_34.xml:_34.outerHTML;
+}else{
+tmp.innerHTML=_34.xml?_34.cloneNode(false).xml:_34.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName("*")[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_37){
+var _38=Sarissa.PARSED_OK;
+if(!_37.documentElement){
+_38=Sarissa.PARSED_EMPTY;
+}else{
+if(_37.documentElement.tagName=="parsererror"){
+_38=_37.documentElement.firstChild.data;
+_38+="\n"+_37.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_37.getElementsByTagName("parsererror").length>0){
+var _39=_37.getElementsByTagName("parsererror")[0];
+_38=Sarissa.getText(_39,true)+"\n";
+}else{
+if(_37.parseError&&_37.parseError.errorCode!=0){
+_38=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _38;
+};
+}
+Sarissa.getText=function(_3a,_3b){
+var s="";
+var _3d=_3a.childNodes;
+for(var i=0;i<_3d.length;i++){
+var _3f=_3d[i];
+var _40=_3f.nodeType;
+if(_40==Node.TEXT_NODE||_40==Node.CDATA_SECTION_NODE){
+s+=_3f.data;
+}else{
+if(_3b==true&&(_40==Node.ELEMENT_NODE||_40==Node.DOCUMENT_NODE||_40==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_3f,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&&Sarissa.getDomDocument&&Sarissa.getDomDocument("","foo",null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_41){
+return _41.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/<[^>]+>/g,"");
+};
+Sarissa.clearChildNodes=function(_43){
+while(_43.firstChild){
+_43.removeChild(_43.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_44,_45,_46){
+if((!_44)||(!_45)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_46){
+Sarissa.clearChildNodes(_45);
+}
+var _47=_45.nodeType==Node.DOCUMENT_NODE?_45:_45.ownerDocument;
+var _48=_44.childNodes;
+if(typeof (_47.importNode)!="undefined"){
+for(var i=0;i<_48.length;i++){
+_45.appendChild(_47.importNode(_48[i],true));
+}
+}else{
+for(var i=0;i<_48.length;i++){
+_45.appendChild(_48[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4a,_4b,_4c){
+if((!_4a)||(!_4b)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_4c){
+Sarissa.clearChildNodes(_4b);
+}
+var _4d=_4a.childNodes;
+if(_4a.ownerDocument==_4b.ownerDocument){
+while(_4a.firstChild){
+_4b.appendChild(_4a.firstChild);
+}
+}else{
+var _4e=_4b.nodeType==Node.DOCUMENT_NODE?_4b:_4b.ownerDocument;
+if(typeof (_4e.importNode)!="undefined"){
+for(var i=0;i<_4d.length;i++){
+_4b.appendChild(_4e.importNode(_4d[i],true));
+}
+}else{
+for(var i=0;i<_4d.length;i++){
+_4b.appendChild(_4d[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4a);
+}
+};
+Sarissa.xmlize=function(_50,_51,_52){
+_52=_52?_52:"";
+var s=_52+"<"+_51+">";
+var _54=false;
+if(!(_50 instanceof Object)||_50 instanceof Number||_50 instanceof String||_50 instanceof Boolean||_50 instanceof Date){
+s+=Sarissa.escape(""+_50);
+_54=true;
+}else{
+s+="\n";
+var _55="";
+var _56=_50 instanceof Array;
+for(var _57 in _50){
+s+=Sarissa.xmlize(_50[_57],(_56?"array-item key=\""+_57+"\"":_57),_52+"   ");
+}
+s+=_52;
+}
+return s+=(_51.indexOf(" ")!=-1?"</array-item>\n":"</"+_51+">\n");
+};
+Sarissa.escape=function(_58){
+return _58.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
+};
+Sarissa.unescape=function(_59){
+return _59.replace(/&apos;/g,"'").replace(/&quot;/g,"\"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");
+};
+

Added: branch/2.0.1/pack.bat
===================================================================
--- branch/2.0.1/pack.bat	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/pack.bat	2007-03-19 22:07:30 UTC (rev 82)
@@ -0,0 +1 @@
+java -jar custom_rhino.jar -c lib/Freja.js > lib/Freja_pack.js 2>&1
\ No newline at end of file

Modified: branch/2.0.1/src/AssetManager.js
===================================================================
--- branch/2.0.1/src/AssetManager.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/src/AssetManager.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -22,8 +22,8 @@
   * Both IE6 and FF1.5 are known to support the required HTTP methods, so
   * if theese are your target platform, you can disable tunneling.
   */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
 /**
   * Set this url to provide remote xslt-transformation for browsers that
   * doesn't support it natively.
@@ -115,7 +115,7 @@
 	this._password = password;
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.AssetManager.loadAsset = function(url, preventCaching) {
 	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);

Modified: branch/2.0.1/src/Model.js
===================================================================
--- branch/2.0.1/src/Model.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/src/Model.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -48,7 +48,7 @@
 };
 /**
   * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.save = function() {
 	var url = this.url;
@@ -71,7 +71,7 @@
 };
 /**
   * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.remove = function() {
 	var url = this.url;
@@ -83,7 +83,7 @@
 	return Freja._aux.sendXMLHttpRequest(req);
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.reload = function() {
 	this.ready = false;

Modified: branch/2.0.1/src/View.js
===================================================================
--- branch/2.0.1/src/View.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/src/View.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -15,7 +15,7 @@
   * @param    model            Freja.Model
   * @param    placeholder      string    If supplied, this will be used instead of the
   *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.prototype.render = function(model, placeholder, xslParameters) {
 	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
@@ -69,7 +69,11 @@
 
 	var d = Freja._aux.createDeferred();
 	try {
-		this._destination = Freja._aux.getElement(placeholder);
+		if (typeof(placeholder) == "object") {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
 		// @todo    Is this a good idea ?
 		// Perhaps we should leave it to the programmer to do this.
 		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
@@ -157,7 +161,7 @@
 Freja.View.Renderer.XSLTransformer = function() {};
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
@@ -182,7 +186,7 @@
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();

Modified: branch/2.0.1/src/auxiliary/minimal.js
===================================================================
--- branch/2.0.1/src/auxiliary/minimal.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/src/auxiliary/minimal.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -1,10 +1,870 @@
+
 /**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                tmp = document.createElement("table");
+            }
+            else if(oNode.nodeName == "td"){
+                tmp = document.createElement("tr");
+            }
+            else if(oNode.nodeName == "option"){
+                tmp = document.createElement("select");
+            }
+            else{
+                tmp = document.createElement("div");
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName("*")[0];
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
+};
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
   * Freja._aux
   * wrapper for external dependencies (frameworks).
   *
   * This is the minimal auxiliary adapter. It contains self-sufficient
   * implementations of all dependencies.
-  *
+  * 
   */
 if (typeof(Freja) == "undefined") {
 	Freja = {};
@@ -29,11 +889,10 @@
     func.im_func = im_func;
     func.im_self = self;
 	return func;
-
 };
 /** formContents(elem) : Array */
 Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
+	if (!elem) elem = document;
 	var names = [];
 	var values = [];
 	var inputs = elem.getElementsByTagName("INPUT");
@@ -120,6 +979,11 @@
 	if (!src._signals[signal]) {
 		src._signals[signal] = [];
 	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item < src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
 	src._signals[signal].push(fnc);
 };
 /** signal(src, signal, ...) : void */
@@ -144,12 +1008,7 @@
 };
 /** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
 Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject("Msxml2.XMLHTTP"); }
-	catch (e) { try { req = new ActiveXObject("Microsoft.XMLHTTP"); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error("Can't create XMLHttpRequest");
+	var req = new XMLHttpRequest();
 	if (user && pass) {
 		req.open(method, url, async, user, pass);
 	} else {
@@ -158,6 +1017,8 @@
 	if (method == "POST" || method == "PUT") {
 		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -179,32 +1040,8 @@
 	return d;
 };
 /** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&/g, "&amp;")
-			.replace(/</g, "&lt;")
-			.replace(/>/g, "&gt;")
-			.replace(/"/g, "&quot;")
-			.replace(/'/g, "&apos;");
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '<' + objectName + '>';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(""+anyObject);
-		isLeaf = true;
-	} else {
-		s += "\n";
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? "array-item key=\""+name+"\"" : name), indentSpace + "   ");
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? "</array-item>\n":"</" + objectName + ">\n");
-};
+Freja._aux.xmlize = Sarissa.xmlize;
+
 /** serializeXML(node) : string */
 Freja._aux.serializeXML = function(node) {
 	if (node.xml) return node.xml;
@@ -212,44 +1049,19 @@
 };
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject("Msxml2.DOMDocument");
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty("SelectionLanguage", "XPath");
-		return xmlDoc;
-	}
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
 Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != "undefined") {
-		// set the parameters
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
 		for (var paramName in xslParameters) {
-			xsl.setProperty ("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
+			processor.setParameter("", paramName, xslParameters[paramName]);
 		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
 	}
-	// return Freja._aux.serializeXML(processor.transformToDocument(xml));
-	return processor.transformToDocument(xml);
-
+	 
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -288,7 +1100,7 @@
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */
 Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation && document.implementation.hasFeature("XPath", "3.0"))) {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
 		return new Freja.QueryEngine.XPath();
 	} else {
 		return new Freja.QueryEngine.SimplePath();
@@ -333,120 +1145,3 @@
 Freja._aux.Deferred.prototype.addErrback = function(fncError) {
 	this.addCallbacks(null, fncError);
 };
-if (document.implementation && document.implementation.hasFeature("XPath", "3.0")) {
-	// Opera 9 XMLDocument Fix. Thanks to Chris D.
-	if(!XMLDocument) {
-	   var XMLDocument = Document;
-	}	
-
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
-
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error("Can't evaluate expression " + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i < 0 || i >= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i < nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = "("+sExpr+")[1]";
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length > 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		}
-	};
-};
-
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i < idList.length && !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
-        };
-    };
-    throw "Could not retrieve a valid progID.";
-}
-
-if(typeof XSLTProcessor == 'undefined' && typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[""+nsURI]){
-	        this.paramsSet[""+nsURI] = new Array();
-	    };
-	    this.paramsSet[""+nsURI][name] = value;
-	};
-
-}

Modified: branch/2.0.1/src/auxiliary/mochi+sarissa.js
===================================================================
--- branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/src/auxiliary/mochi+sarissa.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -43,7 +43,50 @@
 /** bind(func, self) : function */
 Freja._aux.bind = MochiKit.Base.bind;
 /** formContents(elem) : Array */
-Freja._aux.formContents = MochiKit.DOM.formContents;
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName("INPUT");
+	for (var i = 0; i < inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == "radio" || input.type == "checkbox") {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push("");
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName("TEXTAREA");
+	for (var i = 0; i < textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName("SELECT");
+	for (var i = 0; i < selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex >= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : "");
+			}
+		}
+	}
+	return [names, values];
+};
+
 /** getElement(id) : HTMLElement */
 Freja._aux.getElement = MochiKit.DOM.getElement;
 
@@ -89,7 +132,7 @@
 	processor.importStylesheet(xsl);
 	if(xslParameters) {
 		for (var paramName in xslParameters) {
-			processor.setParameter(null, paramName, xslParameters[paramName]);
+			processor.setParameter("", paramName, xslParameters[paramName]);
 		}
 	}
 	 

Modified: branch/2.0.1/tests/test_Freja-Model.html
===================================================================
--- branch/2.0.1/tests/test_Freja-Model.html	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/tests/test_Freja-Model.html	2007-03-19 22:07:30 UTC (rev 82)
@@ -1,11 +1,12 @@
 <html>
 <head>
+	<title>Freja Test Suite</title>
     <!-- MochiKit is needed by SimpleTest -->
     <script type="text/javascript" src="../lib/MochiKit.js"></script>
     <script type="text/javascript" src="SimpleTest/SimpleTest.js"></script>
     <script type="text/javascript" src="../lib/Sarissa.js"></script>
     <script type="text/javascript" src="../lib/Freja.js"></script>
-    <link rel="stylesheet" type="text/css" href="SimpleTest/test.css">
+    <link rel="stylesheet" type="text/css" href="SimpleTest/test.css" />
 </head>
 <body>
 

Modified: branch/2.0.1/tests/test_View.js
===================================================================
--- branch/2.0.1/tests/test_View.js	2007-03-19 22:04:37 UTC (rev 81)
+++ branch/2.0.1/tests/test_View.js	2007-03-19 22:07:30 UTC (rev 82)
@@ -32,7 +32,7 @@
 	};
 	view.render(pojo, out);
 
-	t.ok(out.innerHTML.toLowerCase().match("<p>plain old javascript object</p>"));
+	t.ok(out.innerHTML.toLowerCase().match("<p>plain old javascript object</p>"),"The rendered view should contain the text 'plain old javascript object'");
 
 	// test of form
 	var formView = Freja.AssetManager.getView("data/form-view.xsl");



From cedsav at mail.berlios.de  Mon Mar 19 23:39:44 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 19 Mar 2007 23:39:44 +0100
Subject: [Freja-svn] r83 - in branch/2.0.1/examples/basecamp_api: . css views
Message-ID: <200703192239.l2JMdioi026661@sheep.berlios.de>

Author: cedsav
Date: 2007-03-19 23:39:29 +0100 (Mon, 19 Mar 2007)
New Revision: 83

Modified:
   branch/2.0.1/examples/basecamp_api/basecamp.js
   branch/2.0.1/examples/basecamp_api/css/main.css
   branch/2.0.1/examples/basecamp_api/index.html
   branch/2.0.1/examples/basecamp_api/views/category_list.xsl
   branch/2.0.1/examples/basecamp_api/views/comment.xsl
   branch/2.0.1/examples/basecamp_api/views/message.xsl
   branch/2.0.1/examples/basecamp_api/views/message_list.xsl
   branch/2.0.1/examples/basecamp_api/views/milestone_list.xsl
   branch/2.0.1/examples/basecamp_api/views/project.xsl
   branch/2.0.1/examples/basecamp_api/views/project_selector.xsl
   branch/2.0.1/examples/basecamp_api/views/projects.xsl
   branch/2.0.1/examples/basecamp_api/views/todo_list.xsl
Log:
Made the example compatible with 2.0.1.

Modified: branch/2.0.1/examples/basecamp_api/basecamp.js
===================================================================
--- branch/2.0.1/examples/basecamp_api/basecamp.js	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/basecamp.js	2007-03-19 22:39:29 UTC (rev 83)
@@ -6,6 +6,7 @@
 	
 	// Constants
 	var BASECAMP_URL = "http://freja.projectpath.com";	
+	Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
 
 	// 3rd party libraries.
 	var helpers = new wHELPERS();	// misc. javascript functions
@@ -42,11 +43,19 @@
 			currentProjectId = projects.get("//project[status='active']/id");				
 		else 
 			currentProjectId = projectId;
-			
-		todos      = getModel("models/todos.xml"); 		// Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/todos/lists"));									
-		messages   = getModel("models/posts.xml");  // getModel(addProxyToUrl("/projects/"+currentProjectId+"/msg/archive"));	 // 		// Snapshot.
-		milestones = getModel("models/milestones.xml"); // Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/milestones/list"));
-		categories = getModel("models/categories.xml"); // Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/post_categories"));
+
+		// snapshots (used for development only)	
+	//	todos      = getModel("models/todos.xml"); 		
+	//	messages   = getModel("models/posts.xml");  
+	//	milestones = getModel("models/milestones.xml");
+	//	categories = getModel("models/categories.xml");
+
+		// Live data
+		todos      = getModel(addProxyToUrl("/projects/"+currentProjectId+"/todos/lists"));									
+		messages   = getModel(addProxyToUrl("/projects/"+currentProjectId+"/msg/archive"));	 // 		
+		milestones = getModel(addProxyToUrl("/projects/"+currentProjectId+"/milestones/list"));
+		categories = getModel(addProxyToUrl("/projects/"+currentProjectId+"/post_categories"));
+		
 		requestTemplate = getModel("models/new_request.xml");   // xml wrapper for posted data
 		messageTemplate = getModel("models/new_post.xml");      // skeleton for new data
 		commentTemplate = getModel("models/new_comment.xml");   // skeleton for new data

Modified: branch/2.0.1/examples/basecamp_api/css/main.css
===================================================================
--- branch/2.0.1/examples/basecamp_api/css/main.css	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/css/main.css	2007-03-19 22:39:29 UTC (rev 83)
@@ -19,6 +19,11 @@
 	padding: 5px 15px;
 	font-size: medium;
 }
+h4 {
+	margin: 0;
+	font-size: small;
+	padding: 5px;
+}
 form {
 	padding: 5px 15px;
 }
@@ -57,11 +62,14 @@
 }
 .frame .frameContent {
 	background-image: url(../images/frame-bg.png);
-	background-repeat: no-repeat;
+	background-repeat: repeat-y;
 }
 .frame .top {
 	background-image: url(../images/frame-top-bg.png);
 	background-repeat: no-repeat;
+	font-size: small;
+	text-transform: uppercase;
+	padding: 2px 6px;
 }
 .frame .bottom {
 	background-image: url(../images/frame-bottom-bg.png);
@@ -94,9 +102,9 @@
 }
 
 /* ------------------------------------------------------------------ */
-.messageList ul {
+ul {
 	margin: 0;
-	padding: 0;
+	padding: 5px;
 }
 .messageList ul li {
 	list-style-type: none;

Modified: branch/2.0.1/examples/basecamp_api/index.html
===================================================================
--- branch/2.0.1/examples/basecamp_api/index.html	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/index.html	2007-03-19 22:39:29 UTC (rev 83)
@@ -10,7 +10,7 @@
 <script type="text/javascript" src="lib/helpers.js"></script>
 
 <!-- Freja Framework Script -->
-<script type="text/javascript" src="../lib/Freja.js"></script>
+<script type="text/javascript" src="../../lib/Freja.js"></script>
 
 <!-- Controller Code -->
 <script type="text/javascript" src="basecamp.js"></script>
@@ -25,6 +25,7 @@
 		</div>
 		<div id="content">			
 
+
 			<div class="frame">
 				<div class="top">TO-DOS</div>
 				<div id="placeholder_todos" class="frameContent"></div>
@@ -36,6 +37,11 @@
 				<div id="placeholder_milestones" class="frameContent"></div>
 				<div class="bottom">&nbsp;</div>
 			</div>
+			<div class="frame">
+				<div class="top">Misc.</div>
+				<div id="placeholder_categories" class="frameContent"></div>
+				<div class="bottom">&nbsp;</div>
+			</div>
 
 			
 			<div class="messages">
@@ -43,14 +49,6 @@
 				<div id="placeholder_messages" class="frameContent"></div>
 				<div class="bottom"><img src="images/messages-footer.png" alt="*" /></div>
 			</div>
-			
-			<div class="frame">
-				<div class="top">Misc.</div>
-				<div id="placeholder_categories" class="frameContent"></div>
-				<div class="bottom">&nbsp;</div>
-			</div>
-			
-			
 			<div id="placeholder_debug"></div>
 			<div id="placeholder_debug2"></div>
 		</div>

Modified: branch/2.0.1/examples/basecamp_api/views/category_list.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/category_list.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/category_list.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="/post-categories">	
-	<h3>Message Categories</h3>
+	<h4>Message Categories</h4>
 	<ul>
 		<xsl:apply-templates />
 	</ul>

Modified: branch/2.0.1/examples/basecamp_api/views/comment.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/comment.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/comment.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:param name="commentId" ></xsl:param>
 <xsl:param name="title" >Edit Comment</xsl:param>
+
 <xsl:template match="/">
 	<xsl:apply-templates select="//comment[id=$commentId]" />
 </xsl:template>

Modified: branch/2.0.1/examples/basecamp_api/views/message.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/message.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/message.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,6 +1,8 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
+
 <xsl:param name="messageId" ></xsl:param>
 <xsl:param name="title" >Edit Message</xsl:param>
 <xsl:template match="posts">

Modified: branch/2.0.1/examples/basecamp_api/views/message_list.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/message_list.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/message_list.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-<xsl:output method="xml" indent="yes" encoding="UTF-8"/>
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <!-- ====================================================================================  
   MESSAGE LIST (POSTS+COMMENTS)  

Modified: branch/2.0.1/examples/basecamp_api/views/milestone_list.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/milestone_list.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/milestone_list.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="/milestones">	
-	<h3>Milestones</h3>
 	<ul>
 		<xsl:apply-templates />
 	</ul>

Modified: branch/2.0.1/examples/basecamp_api/views/project.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/project.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/project.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<xsl:apply-templates />

Modified: branch/2.0.1/examples/basecamp_api/views/project_selector.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/project_selector.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/project_selector.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<label for="currentProjectSelector" class="preField" >Current Project: </label>

Modified: branch/2.0.1/examples/basecamp_api/views/projects.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/projects.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/projects.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<xsl:apply-templates />

Modified: branch/2.0.1/examples/basecamp_api/views/todo_list.xsl
===================================================================
--- branch/2.0.1/examples/basecamp_api/views/todo_list.xsl	2007-03-19 22:07:30 UTC (rev 82)
+++ branch/2.0.1/examples/basecamp_api/views/todo_list.xsl	2007-03-19 22:39:29 UTC (rev 83)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="/todo-lists">	
-	<h3>To-do lists</h3>
 	<ul>
 		<xsl:apply-templates />
 	</ul>



From cedsav at mail.berlios.de  Mon Mar 19 23:44:00 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Mon, 19 Mar 2007 23:44:00 +0100
Subject: [Freja-svn] r84 - branch/2.0.1/examples/contacts/views
Message-ID: <200703192244.l2JMi0pF026909@sheep.berlios.de>

Author: cedsav
Date: 2007-03-19 23:43:55 +0100 (Mon, 19 Mar 2007)
New Revision: 84

Modified:
   branch/2.0.1/examples/contacts/views/create.xsl
   branch/2.0.1/examples/contacts/views/edit.xsl
   branch/2.0.1/examples/contacts/views/index.xsl
Log:
Changed XSL output method to HTML

Modified: branch/2.0.1/examples/contacts/views/create.xsl
===================================================================
--- branch/2.0.1/examples/contacts/views/create.xsl	2007-03-19 22:39:29 UTC (rev 83)
+++ branch/2.0.1/examples/contacts/views/create.xsl	2007-03-19 22:43:55 UTC (rev 84)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="/">
 	<form method="post" action="#" class="form">
 		<p>email:<input name="email" type="text" value="" /></p>

Modified: branch/2.0.1/examples/contacts/views/edit.xsl
===================================================================
--- branch/2.0.1/examples/contacts/views/edit.xsl	2007-03-19 22:39:29 UTC (rev 83)
+++ branch/2.0.1/examples/contacts/views/edit.xsl	2007-03-19 22:43:55 UTC (rev 84)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="record">	
 	<form method="post" action="#" class="form">
 	<xsl:attribute name="url"><xsl:value-of select="url" /></xsl:attribute>

Modified: branch/2.0.1/examples/contacts/views/index.xsl
===================================================================
--- branch/2.0.1/examples/contacts/views/index.xsl	2007-03-19 22:39:29 UTC (rev 83)
+++ branch/2.0.1/examples/contacts/views/index.xsl	2007-03-19 22:43:55 UTC (rev 84)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="result">
 <table border="1" cellpadding="4" cellspacing="4">
 <xsl:for-each select="record">



From cedsav at mail.berlios.de  Wed Mar 21 14:42:47 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Wed, 21 Mar 2007 14:42:47 +0100
Subject: [Freja-svn] r85 - branch/2.0.1/examples/tutorial
Message-ID: <200703211342.l2LDglc7020760@sheep.berlios.de>

Author: cedsav
Date: 2007-03-21 14:42:38 +0100 (Wed, 21 Mar 2007)
New Revision: 85

Added:
   branch/2.0.1/examples/tutorial/example2.html
   branch/2.0.1/examples/tutorial/example2.js
Log:


Added: branch/2.0.1/examples/tutorial/example2.html
===================================================================
--- branch/2.0.1/examples/tutorial/example2.html	2007-03-19 22:43:55 UTC (rev 84)
+++ branch/2.0.1/examples/tutorial/example2.html	2007-03-21 13:42:38 UTC (rev 85)
@@ -0,0 +1,19 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+<title>Freja Example 2</title>
+
+<!-- Freja Framework Script -->
+<script type="text/javascript" src="../../lib/MochiKit.js"></script>
+<script type="text/javascript" src="../../lib/Sarissa.js"></script>
+<script type="text/javascript" src="../../lib/Freja.js"></script>
+
+<!-- Controller Code -->
+<script type="text/javascript" src="example2.js"></script>
+</head>
+
+<body>
+<div id="content"><span style="color:white;background:firebrick">Loading ...</span></div>
+</body>
+</html>

Added: branch/2.0.1/examples/tutorial/example2.js
===================================================================
--- branch/2.0.1/examples/tutorial/example2.js	2007-03-19 22:43:55 UTC (rev 84)
+++ branch/2.0.1/examples/tutorial/example2.js	2007-03-21 13:42:38 UTC (rev 85)
@@ -0,0 +1,31 @@
+var data = getModel("models/data.xml");
+
+var display = getView("views/display.xsl");
+display.placeholder = "content";
+display.behaviors["editLink"] = {
+	onclick : function() {
+		edit.render(data);
+	}
+};
+
+var edit = getView("views/edit.xsl");
+edit.placeholder = "content";
+edit.behaviors["editForm"] = {
+	onsubmit : function() {
+		try {
+			data.updateFrom(edit);
+			display.render(data);
+		} catch (ex) {
+			alert(ex.message);
+		}
+	}
+};
+edit.behaviors["displayLink"] = {
+	onclick : function() {
+		display.render(data);
+	}
+};
+
+connect(window, "onload", function() {
+	display.render(data);
+});
\ No newline at end of file



From cedsav at mail.berlios.de  Wed Mar 21 16:14:58 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Wed, 21 Mar 2007 16:14:58 +0100
Subject: [Freja-svn] r86 - in trunk: . examples/basecamp_api
	examples/basecamp_api/css examples/basecamp_api/views
	examples/contacts examples/contacts/models/php_inc
	examples/contacts/views examples/tutorial
	examples/tutorial/views lib lib/minimal lib/mochi+sarissa src
	src/auxiliary tests
Message-ID: <200703211514.l2LFEwcY031999@sheep.berlios.de>

Author: cedsav
Date: 2007-03-21 16:13:46 +0100 (Wed, 21 Mar 2007)
New Revision: 86

Added:
   trunk/custom_rhino.jar
   trunk/examples/tutorial/example2.html
   trunk/examples/tutorial/example2.js
   trunk/lib/minimal/
   trunk/lib/minimal/Freja.js
   trunk/lib/minimal/Freja_pack.js
   trunk/lib/mochi+sarissa/
   trunk/lib/mochi+sarissa/Freja.js
   trunk/lib/mochi+sarissa/Freja_pack.js
   trunk/lib/mochi+sarissa/MochiKit.js
   trunk/lib/mochi+sarissa/Sarissa.js
   trunk/lib/mochi+sarissa/Sarissa_pack.js
Removed:
   trunk/examples/tutorial/example2.html
   trunk/examples/tutorial/example2.js
   trunk/lib/Freja.js
   trunk/lib/MochiKit.js
   trunk/lib/Sarissa.js
Modified:
   trunk/build.wsf
   trunk/examples/basecamp_api/basecamp.js
   trunk/examples/basecamp_api/css/main.css
   trunk/examples/basecamp_api/index.html
   trunk/examples/basecamp_api/views/category_list.xsl
   trunk/examples/basecamp_api/views/comment.xsl
   trunk/examples/basecamp_api/views/message.xsl
   trunk/examples/basecamp_api/views/message_list.xsl
   trunk/examples/basecamp_api/views/milestone_list.xsl
   trunk/examples/basecamp_api/views/project.xsl
   trunk/examples/basecamp_api/views/project_selector.xsl
   trunk/examples/basecamp_api/views/projects.xsl
   trunk/examples/basecamp_api/views/todo_list.xsl
   trunk/examples/contacts/client.html
   trunk/examples/contacts/models/php_inc/inc.resource.php
   trunk/examples/contacts/views/create.xsl
   trunk/examples/contacts/views/edit.xsl
   trunk/examples/contacts/views/index.xsl
   trunk/examples/tutorial/example.html
   trunk/examples/tutorial/example.js
   trunk/examples/tutorial/views/edit.xsl
   trunk/src/AssetManager.js
   trunk/src/Freja.js
   trunk/src/Model.js
   trunk/src/QueryEngine.js
   trunk/src/View.js
   trunk/src/auxiliary/minimal.js
   trunk/src/auxiliary/mochi+sarissa.js
   trunk/tests/index.html
   trunk/tests/test_Freja-History.html
   trunk/tests/test_Freja-Model.html
   trunk/tests/test_Freja-View.html
   trunk/tests/test_Model.js
   trunk/tests/test_View.js
Log:
Merged v2.0.1 branch. Renamed version to 2.1 (2.1 is not backward compatible due to a required change in the XSL:output method -> html instead of xml).

Modified: trunk/build.wsf
===================================================================
--- trunk/build.wsf	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/build.wsf	2007-03-21 15:13:46 UTC (rev 86)
@@ -16,10 +16,12 @@
 	
 	if (dialog.ShowOpen()) {
 		var AUXILIARY = dialog.FileName;
-
-		var outfile = cwd + "/lib/Freja.js";
+		var AUXILIARY_FOLDER = AUXILIARY.match(/\\([^\\]*)\.js$/)[1];
+		var outfile = cwd + "\\lib\\" + AUXILIARY_FOLDER + "\\Freja.js";
+		var outfile_packed = cwd + "\\lib\\" + AUXILIARY_FOLDER + "\\Freja_pack.js";
 		try {
 			FileSystem.deleteFile(outfile);
+			FileSystem.deleteFile(outfile_packed);
 		} catch (ex) {}
 
 		var file = FileSystem.openTextFile(srcDir + "/Freja.js", 1, -2);
@@ -50,7 +52,7 @@
 			"\n    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please" +
 			"\n    diff against the source tree, not this file." +
 			"\n" +
-			"\n    Copyright (c) 2006 C?dric Savarese <pro at 4213miles.com>, Troels Knak-Nielsen <troelskn at gmail.com>" +
+			"\n    Copyright (c) 2006-2007 Cedric Savarese <cedric at veerwest.com>, Troels Knak-Nielsen <troelskn at gmail.com>" +
 			"\n    This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>" +
 			"\n" +
 			"\n***" + "/" +
@@ -70,6 +72,10 @@
 		var out = FileSystem.openTextFile(outfile, 2, -2);
 		out.write(header + source);
 		out.close();
+		
+		Shell.CurrentDirectory = cwd;
+		var cmd = "%comspec% /c java -jar custom_rhino.jar -c \""+outfile+"\" > \""+outfile_packed+"\" 2>&1";
+		var r = Shell.run(cmd,0,true);
 	}
 	]]>
 	</script>

Copied: trunk/custom_rhino.jar (from rev 85, branch/2.0.1/custom_rhino.jar)

Modified: trunk/examples/basecamp_api/basecamp.js
===================================================================
--- trunk/examples/basecamp_api/basecamp.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/basecamp.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -6,6 +6,7 @@
 	
 	// Constants
 	var BASECAMP_URL = "http://freja.projectpath.com";	
+	Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
 
 	// 3rd party libraries.
 	var helpers = new wHELPERS();	// misc. javascript functions
@@ -42,11 +43,19 @@
 			currentProjectId = projects.get("//project[status='active']/id");				
 		else 
 			currentProjectId = projectId;
-			
-		todos      = getModel("models/todos.xml"); 		// Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/todos/lists"));									
-		messages   = getModel("models/posts.xml");  // getModel(addProxyToUrl("/projects/"+currentProjectId+"/msg/archive"));	 // 		// Snapshot.
-		milestones = getModel("models/milestones.xml"); // Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/milestones/list"));
-		categories = getModel("models/categories.xml"); // Snapshot. Live data: getModel(addProxyToUrl("/projects/"+currentProjectId+"/post_categories"));
+
+		// snapshots (used for development only)	
+	//	todos      = getModel("models/todos.xml"); 		
+	//	messages   = getModel("models/posts.xml");  
+	//	milestones = getModel("models/milestones.xml");
+	//	categories = getModel("models/categories.xml");
+
+		// Live data
+		todos      = getModel(addProxyToUrl("/projects/"+currentProjectId+"/todos/lists"));									
+		messages   = getModel(addProxyToUrl("/projects/"+currentProjectId+"/msg/archive"));	 // 		
+		milestones = getModel(addProxyToUrl("/projects/"+currentProjectId+"/milestones/list"));
+		categories = getModel(addProxyToUrl("/projects/"+currentProjectId+"/post_categories"));
+		
 		requestTemplate = getModel("models/new_request.xml");   // xml wrapper for posted data
 		messageTemplate = getModel("models/new_post.xml");      // skeleton for new data
 		commentTemplate = getModel("models/new_comment.xml");   // skeleton for new data

Modified: trunk/examples/basecamp_api/css/main.css
===================================================================
--- trunk/examples/basecamp_api/css/main.css	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/css/main.css	2007-03-21 15:13:46 UTC (rev 86)
@@ -19,6 +19,11 @@
 	padding: 5px 15px;
 	font-size: medium;
 }
+h4 {
+	margin: 0;
+	font-size: small;
+	padding: 5px;
+}
 form {
 	padding: 5px 15px;
 }
@@ -57,11 +62,14 @@
 }
 .frame .frameContent {
 	background-image: url(../images/frame-bg.png);
-	background-repeat: no-repeat;
+	background-repeat: repeat-y;
 }
 .frame .top {
 	background-image: url(../images/frame-top-bg.png);
 	background-repeat: no-repeat;
+	font-size: small;
+	text-transform: uppercase;
+	padding: 2px 6px;
 }
 .frame .bottom {
 	background-image: url(../images/frame-bottom-bg.png);
@@ -94,9 +102,9 @@
 }
 
 /* ------------------------------------------------------------------ */
-.messageList ul {
+ul {
 	margin: 0;
-	padding: 0;
+	padding: 5px;
 }
 .messageList ul li {
 	list-style-type: none;

Modified: trunk/examples/basecamp_api/index.html
===================================================================
--- trunk/examples/basecamp_api/index.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/index.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -10,7 +10,7 @@
 <script type="text/javascript" src="lib/helpers.js"></script>
 
 <!-- Freja Framework Script -->
-<script type="text/javascript" src="../lib/Freja.js"></script>
+<script type="text/javascript" src="../../lib/minimal/Freja.js"></script>
 
 <!-- Controller Code -->
 <script type="text/javascript" src="basecamp.js"></script>
@@ -25,6 +25,7 @@
 		</div>
 		<div id="content">			
 
+
 			<div class="frame">
 				<div class="top">TO-DOS</div>
 				<div id="placeholder_todos" class="frameContent"></div>
@@ -36,6 +37,11 @@
 				<div id="placeholder_milestones" class="frameContent"></div>
 				<div class="bottom">&nbsp;</div>
 			</div>
+			<div class="frame">
+				<div class="top">Misc.</div>
+				<div id="placeholder_categories" class="frameContent"></div>
+				<div class="bottom">&nbsp;</div>
+			</div>
 
 			
 			<div class="messages">
@@ -43,14 +49,6 @@
 				<div id="placeholder_messages" class="frameContent"></div>
 				<div class="bottom"><img src="images/messages-footer.png" alt="*" /></div>
 			</div>
-			
-			<div class="frame">
-				<div class="top">Misc.</div>
-				<div id="placeholder_categories" class="frameContent"></div>
-				<div class="bottom">&nbsp;</div>
-			</div>
-			
-			
 			<div id="placeholder_debug"></div>
 			<div id="placeholder_debug2"></div>
 		</div>

Modified: trunk/examples/basecamp_api/views/category_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/category_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/category_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="/post-categories">	
-	<h3>Message Categories</h3>
+	<h4>Message Categories</h4>
 	<ul>
 		<xsl:apply-templates />
 	</ul>

Modified: trunk/examples/basecamp_api/views/comment.xsl
===================================================================
--- trunk/examples/basecamp_api/views/comment.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/comment.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:param name="commentId" ></xsl:param>
 <xsl:param name="title" >Edit Comment</xsl:param>
+
 <xsl:template match="/">
 	<xsl:apply-templates select="//comment[id=$commentId]" />
 </xsl:template>

Modified: trunk/examples/basecamp_api/views/message.xsl
===================================================================
--- trunk/examples/basecamp_api/views/message.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/message.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,8 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
+
 <xsl:param name="messageId" ></xsl:param>
 <xsl:param name="title" >Edit Message</xsl:param>
 <xsl:template match="posts">

Modified: trunk/examples/basecamp_api/views/message_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/message_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/message_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-<xsl:output method="xml" indent="yes" encoding="UTF-8"/>
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <!-- ====================================================================================  
   MESSAGE LIST (POSTS+COMMENTS)  

Modified: trunk/examples/basecamp_api/views/milestone_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/milestone_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/milestone_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="/milestones">	
-	<h3>Milestones</h3>
 	<ul>
 		<xsl:apply-templates />
 	</ul>

Modified: trunk/examples/basecamp_api/views/project.xsl
===================================================================
--- trunk/examples/basecamp_api/views/project.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/project.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<xsl:apply-templates />

Modified: trunk/examples/basecamp_api/views/project_selector.xsl
===================================================================
--- trunk/examples/basecamp_api/views/project_selector.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/project_selector.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<label for="currentProjectSelector" class="preField" >Current Project: </label>

Modified: trunk/examples/basecamp_api/views/projects.xsl
===================================================================
--- trunk/examples/basecamp_api/views/projects.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/projects.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,6 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="projects">	
 	<xsl:apply-templates />

Modified: trunk/examples/basecamp_api/views/todo_list.xsl
===================================================================
--- trunk/examples/basecamp_api/views/todo_list.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/basecamp_api/views/todo_list.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 
 <xsl:template match="/todo-lists">	
-	<h3>To-do lists</h3>
 	<ul>
 		<xsl:apply-templates />
 	</ul>

Modified: trunk/examples/contacts/client.html
===================================================================
--- trunk/examples/contacts/client.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/client.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,9 +5,9 @@
 <title>Contacts</title>
 
 <!-- Freja Framework Script -->
-<script type="text/javascript" src="../../lib/MochiKit.js"></script>
-<script type="text/javascript" src="../../lib/Sarissa.js"></script>
-<script type="text/javascript" src="../../lib/Freja.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/MochiKit.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Sarissa.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Freja.js"></script>
 
 <!-- Controller Code -->
 <script type="text/javascript" src="client.js"></script>

Modified: trunk/examples/contacts/models/php_inc/inc.resource.php
===================================================================
--- trunk/examples/contacts/models/php_inc/inc.resource.php	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/models/php_inc/inc.resource.php	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,9 +1,12 @@
 <?php
 $request_headers = apache_request_headers();
 if (isset($request_headers['Http-Method-Equivalent'])) {
-	$REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+   $REQUEST_METHOD = $request_headers['Http-Method-Equivalent'];
+} elseif (isset($request_headers['http-method-equivalent'])) {
+// IE sends the Http-Method-Equivalent header in lowercase!
+    $REQUEST_METHOD = $request_headers['http-method-equivalent'];
 } else {
-	$REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
+   $REQUEST_METHOD = $_SERVER['REQUEST_METHOD'];
 }
 
 if ($REQUEST_METHOD == "PUT" || $REQUEST_METHOD == "POST") {

Modified: trunk/examples/contacts/views/create.xsl
===================================================================
--- trunk/examples/contacts/views/create.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/create.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="/">
 	<form method="post" action="#" class="form">
 		<p>email:<input name="email" type="text" value="" /></p>

Modified: trunk/examples/contacts/views/edit.xsl
===================================================================
--- trunk/examples/contacts/views/edit.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/edit.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="record">	
 	<form method="post" action="#" class="form">
 	<xsl:attribute name="url"><xsl:value-of select="url" /></xsl:attribute>

Modified: trunk/examples/contacts/views/index.xsl
===================================================================
--- trunk/examples/contacts/views/index.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/contacts/views/index.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <xsl:stylesheet version="1.0"
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
-
+<xsl:output method="html" indent="yes" encoding="UTF-8"/>
 <xsl:template match="result">
 <table border="1" cellpadding="4" cellspacing="4">
 <xsl:for-each select="record">

Modified: trunk/examples/tutorial/example.html
===================================================================
--- trunk/examples/tutorial/example.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,9 +5,9 @@
 <title>Freja Example</title>
 
 <!-- Freja Framework Script -->
-<script type="text/javascript" src="../../lib/MochiKit.js"></script>
-<script type="text/javascript" src="../../lib/Sarissa.js"></script>
-<script type="text/javascript" src="../../lib/Freja.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/MochiKit.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Sarissa.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Freja.js"></script>
 
 <!-- Controller Code -->
 <script type="text/javascript" src="example.js"></script>

Modified: trunk/examples/tutorial/example.js
===================================================================
--- trunk/examples/tutorial/example.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -3,34 +3,23 @@
 var display = getView("views/display.xsl");
 display.placeholder = 'content';
 display.behaviors["editLink"] = {
-	onclick : function() { dispatch('edit'); }
+	onclick : function() { edit.render(data); }
 };
 
 var edit = getView("views/edit.xsl");
 edit.placeholder = 'content';
 edit.behaviors["editForm"] = {
-	onsubmit : function() { dispatch('update'); }
+	onsubmit : function() { 
+		data.updateFrom(edit);
+		display.render(data);
+		return false;
+	}
 };
 edit.behaviors["displayLink"] = {
-	onclick : function() { dispatch('display'); }
+	onclick : function() { display.render(data); }
 };
 
-dispatch = function(action) {
-	switch (action) {
-		default:
-			// fall through to case 'display'
-		case 'display':
-			display.render(data)
-			break;
-		case 'edit':
-			edit.render(data);
-			break;
-		case 'update':
-			data.updateFrom(edit);
-			dispatch('display');
-		break;
-	}
-}
+
 connect(window, "onload", function() {
-	dispatch("display");
+	display.render(data);
 });
\ No newline at end of file

Deleted: trunk/examples/tutorial/example2.html
===================================================================
--- trunk/examples/tutorial/example2.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,19 +0,0 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml">
-<head>
-<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
-<title>Freja Example 2</title>
-
-<!-- Freja Framework Script -->
-<script type="text/javascript" src="../../lib/MochiKit.js"></script>
-<script type="text/javascript" src="../../lib/Sarissa.js"></script>
-<script type="text/javascript" src="../../lib/Freja.js"></script>
-
-<!-- Controller Code -->
-<script type="text/javascript" src="example2.js"></script>
-</head>
-
-<body>
-<div id="content"><span style="color:white;background:firebrick">Loading ...</span></div>
-</body>
-</html>

Copied: trunk/examples/tutorial/example2.html (from rev 85, branch/2.0.1/examples/tutorial/example2.html)
===================================================================
--- branch/2.0.1/examples/tutorial/example2.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,19 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+<title>Freja Example 2</title>
+
+<!-- Freja Framework Script -->
+<script type="text/javascript" src="../../lib/mochi+sarissa/MochiKit.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Sarissa.js"></script>
+<script type="text/javascript" src="../../lib/mochi+sarissa/Freja.js"></script>
+
+<!-- Controller Code -->
+<script type="text/javascript" src="example2.js"></script>
+</head>
+
+<body>
+<div id="content"><span style="color:white;background:firebrick">Loading ...</span></div>
+</body>
+</html>

Deleted: trunk/examples/tutorial/example2.js
===================================================================
--- trunk/examples/tutorial/example2.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/example2.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,31 +0,0 @@
-var data = getModel("models/data.xml");
-
-var display = getView("views/display.xsl");
-display.placeholder = "content";
-display.behaviors["editLink"] = {
-	onclick : function() {
-		edit.render(data);
-	}
-};
-
-var edit = getView("views/edit.xsl");
-edit.placeholder = "content";
-edit.behaviors["editForm"] = {
-	onsubmit : function() {
-		try {
-			data.updateFrom(edit);
-			display.render(data);
-		} catch (ex) {
-			alert(ex.message);
-		}
-	}
-};
-edit.behaviors["displayLink"] = {
-	onclick : function() {
-		display.render(data);
-	}
-};
-
-connect(window, "onload", function() {
-	display.render(data);
-});
\ No newline at end of file

Copied: trunk/examples/tutorial/example2.js (from rev 85, branch/2.0.1/examples/tutorial/example2.js)

Modified: trunk/examples/tutorial/views/edit.xsl
===================================================================
--- trunk/examples/tutorial/views/edit.xsl	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/examples/tutorial/views/edit.xsl	2007-03-21 15:13:46 UTC (rev 86)
@@ -3,7 +3,7 @@
 	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
 
 <xsl:template match="item">	
-	<form method="post" action="#" freja-behaviour="editForm">
+	<form method="post" action="#" class="editForm">
 		<h3><input name="item/name" type="text" value="{name}" /></h3>
 		<p><textarea name="item/description"><xsl:value-of select="description" /></textarea></p>
 		<p><input name="item/price" type="text" value="{price}" /></p>

Deleted: trunk/lib/Freja.js
===================================================================
--- trunk/lib/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,1248 +0,0 @@
-/***
-
-    Freja 2.0.alpha
-
-    Build $Fri, 28 Jul 2006 13:38:48 UTC$
-
-    Target: minimal
-
-    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
-    diff against the source tree, not this file.
-
-    Copyright (c) 2006 C?dric Savarese <pro at 4213miles.com>, Troels Knak-Nielsen <troelskn at gmail.com>
-    This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>
-
-***/
-
-if (typeof(dojo) != "undefined") {
-	dojo.provide("Freja");
-}
-if (typeof(Freja) == "undefined") {
-	Freja = {};
-}
-Freja.NAME = "Freja";
-Freja.VERSION = "2.0.alpha";
-Freja.__repr__ = function () {
-	return "[" + this.NAME + " " + this.VERSION + "]";
-};
-Freja.toString = function () {
-	return this.__repr__();
-};
-/**
-  * Single-hierarchy inheritance (class emulation)
-  * @see    http://www.itsalleasy.com/2006/02/05/prototype-chain/
-  *         http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/
-  *
-  * Extends one prototype by another.
-  * The subtype will have two specialpurpose properties:
-  *     superconstructor    The parent prototype's constructor
-  *     supertype        The parent prototype
-  */
-Freja.Class = {};
-Freja.Class.extend = function(subClass, superconstructor) {
-	var inlineSuper = function(){};
-	inlineSuper.prototype = superconstructor.prototype;
-	subClass.prototype = new inlineSuper();
-	subClass.prototype.constructor = subClass;
-	subClass.prototype.superconstructor = superconstructor;
-	subClass.prototype.supertype = superconstructor.prototype;
-};
-/**
-  * Freja._aux
-  * wrapper for external dependencies (frameworks).
-  *
-  * This is the minimal auxiliary adapter. It contains self-sufficient
-  * implementations of all dependencies.
-  *
-  */
-if (typeof(Freja) == "undefined") {
-	Freja = {};
-}
-Freja._aux = {};
-/** bind(func, self) : function */
-// from http://blog.ianbicking.org/prototype-and-object-prototype.html
-Freja._aux.bind = function(func, self) {
-	if(typeof (func)=="string"){
-		func=self[func];
-	}
-
-	var im_func = null;
-    if (typeof(func.im_func) == 'function') {
-        im_func = func.im_func;
-    } else {
-        im_func = func;
-    }
-    func = function () {
-        return func.im_func.apply(func.im_self, arguments);
-    }
-    func.im_func = im_func;
-    func.im_self = self;
-	return func;
-
-};
-/** formContents(elem) : Array */
-Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
-	var names = [];
-	var values = [];
-	var inputs = elem.getElementsByTagName("INPUT");
-	for (var i = 0; i < inputs.length; ++i) {
-		var input = inputs[i];
-		if (input.name) {
-			if (input.type == "radio" || input.type == "checkbox") {
-				if (input.checked) {
-					names.push(input.name);
-					values.push(input.value);
-				} else {
-					names.push(input.name);
-					values.push("");
-				}
-			} else {
-				names.push(input.name);
-				values.push(input.value);
-			}
-		}
-	}
-	var textareas = elem.getElementsByTagName("TEXTAREA");
-	for (var i = 0; i < textareas.length; ++i) {
-		var input = textareas[i];
-		if (input.name) {
-			names.push(input.name);
-			values.push(input.value);
-		}
-	}
-	var selects = elem.getElementsByTagName("SELECT");
-	for (var i = 0; i < selects.length; ++i) {
-		var input = selects[i];
-		if (input.name) {
-			if (input.selectedIndex >= 0) {
-				var opt = input.options[input.selectedIndex];
-				names.push(input.name);
-				values.push((opt.value) ? opt.value : "");
-			}
-		}
-	}
-	return [names, values];
-};
-/** getElement(id) : HTMLElement */
-Freja._aux.getElement = function(id) {
-	if (typeof(id) == "object") {
-		return id;
-	} else {
-		return document.getElementById(id);
-	}
-};
-
-/** connect(src, signal, fnc) : void */
-Freja._aux.connect = function(src, signal, fnc) {
-
-	if(!src) return;
-	if (src.addEventListener) {
-		var wrapper = function(e) {
-			var evt = {
-				stop : function() {
-					if (e.cancelable) {
-						e.preventDefault();
-					}
-					e.stopPropagation();
-				}
-			}
-			fnc(evt);
-		}
-		src.addEventListener(signal.replace(/^(on)/, ""), wrapper, false);
-	} else if (src.attachEvent) {
-		var wrapper = function() {
-			var e = window.event;
-			var evt = {
-				stop : function() {
-					e.cancelBubble = true;
-					e.returnValue = false;
-				}
-			}
-			fnc(evt);
-		}
-		src.attachEvent(signal, wrapper);
-	}
-	if (!src._signals) {
-		src._signals = [];
-	}
-	if (!src._signals[signal]) {
-		src._signals[signal] = [];
-	}
-	src._signals[signal].push(fnc);
-};
-/** signal(src, signal, ...) : void */
-Freja._aux.signal = function(src, signal) {
-
-	try {
-		var sigs = src._signals[signal];
-		var args = [];
-		for (var i=2; i < arguments.length; i++) {
-			args.push(arguments[i]);
-		}
-		for (var i=0; i < sigs.length; i++) {
-			try {
-				sigs[i].apply(src, args);
-			} catch (e) { /* squelch */ }
-		}
-	} catch (e) { /* squelch */ }
-};
-/** createDeferred() : Deferred */
-Freja._aux.createDeferred = function() {
-	return new Freja._aux.Deferred();
-};
-/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
-Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject("Msxml2.XMLHTTP"); }
-	catch (e) { try { req = new ActiveXObject("Microsoft.XMLHTTP"); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error("Can't create XMLHttpRequest");
-	if (user && pass) {
-		req.open(method, url, async, user, pass);
-	} else {
-		req.open(method, url, async);
-	}
-	if (method == "POST" || method == "PUT") {
-		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
-	}
-	return req;
-};
-/** sendXMLHttpRequest(req, sendContent) : Deferred */
-Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
-	var d = Freja._aux.createDeferred();
-	var bComplete = false;
-	req.onreadystatechange = function() {
-		if (req.readyState == 4 && !bComplete) {
-			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
-				d.callback(req);
-			} else {
-				d.errback(req);
-			}
-			bComplete = true;
-		}
-	}
-	if (!sendContent) sendContent = "";
-	req.send(sendContent);
-	return d;
-};
-/** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&/g, "&amp;")
-			.replace(/</g, "&lt;")
-			.replace(/>/g, "&gt;")
-			.replace(/"/g, "&quot;")
-			.replace(/'/g, "&apos;");
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '<' + objectName + '>';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(""+anyObject);
-		isLeaf = true;
-	} else {
-		s += "\n";
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? "array-item key=\""+name+"\"" : name), indentSpace + "   ");
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? "</array-item>\n":"</" + objectName + ">\n");
-};
-/** serializeXML(node) : string */
-Freja._aux.serializeXML = function(node) {
-	if (node.xml) return node.xml;
-	return (new XMLSerializer()).serializeToString(node);
-};
-/** loadXML(string) : XMLDocument */
-Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject("Msxml2.DOMDocument");
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty("SelectionLanguage", "XPath");
-		return xmlDoc;
-	}
-	return (new DOMParser()).parseFromString(text, "text/xml");
-};
-/** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != "undefined") {
-		// set the parameters
-		for (var paramName in xslParameters) {
-			xsl.setProperty ("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
-		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
-	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
-};
-/** cloneXMLDocument(document) : XMLDocument */
-Freja._aux.cloneXMLDocument = function(xmlDoc) {
-	var clone = null;
-	try {
-		clone = xmlDoc.cloneNode(true);
-	} catch(e) { /* squelch */ }
-
-	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
-	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
-	if (!clone) {
-		if (document.implementation && document.implementation.createDocument) {
-			clone = document.implementation.createDocument("", xmlDoc.documentElement.nodeName, null);
-			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
-			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
-			try {
-				clone.appendChild(data);
-			} catch(e) {
-				// Opera has already created a documentElement and can't append another root node
-				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i >= 0; i--) {
-					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
-				}
-				// need to copy root node attributes
-				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
-					var name  = xmlDoc.documentElement.attributes.item(i).name;
-					var value = xmlDoc.documentElement.attributes.item(i).value;
-					clone.documentElement.setAttribute(name, value);
-				}
-			}
-		}
-	}
-	return clone;
-};
-/** hasSupportForXSLT() : boolean */
-Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
-/** createQueryEngine() : Freja.QueryEngine */
-Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation && document.implementation.hasFeature("XPath", "3.0"))) {
-		return new Freja.QueryEngine.XPath();
-	} else {
-		return new Freja.QueryEngine.SimplePath();
-	}
-};
-/** A pale replacement for MochiKit.Async.Deferred */
-Freja._aux.Deferred = function() {
-	this._good = [];
-	this._bad = [];
-	this._pending = null;
-};
-Freja._aux.Deferred.prototype.callback = function() {
-	if (this._good.length == 0) {
-		this._pending = [this.callback, arguments];
-		return;
-	}
-	for (var i=0; i < this._good.length; i++) {
-		this._good[i].apply(window, arguments);
-	}
-	this._good = [];
-};
-Freja._aux.Deferred.prototype.errback = function() {
-	if (this._bad.length == 0) {
-		this._pending = [this.errback, arguments];
-		return;
-	}
-	for (var i=0; i < this._bad.length; i++) {
-		this._bad[i].apply(window, arguments);
-	}
-	this._bad = [];
-};
-Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
-	if (fncOK) this._good[this._good.length] = fncOK;
-	if (fncError) this._bad[this._bad.length] = fncError;
-	if (this._pending) {
-		this._pending[0].apply(this, this._pending[1]);
-	}
-};
-Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
-	this.addCallbacks(fncOK);
-};
-Freja._aux.Deferred.prototype.addErrback = function(fncError) {
-	this.addCallbacks(null, fncError);
-};
-if (document.implementation && document.implementation.hasFeature("XPath", "3.0")) {
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
-
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error("Can't evaluate expression " + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i < 0 || i >= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i < nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = "("+sExpr+")[1]";
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length > 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		}
-	};
-};
-
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i < idList.length && !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
-        };
-    };
-    throw "Could not retrieve a valid progID.";
-}
-
-if(typeof XSLTProcessor == 'undefined' && typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[""+nsURI]){
-	        this.paramsSet[""+nsURI] = new Array();
-	    };
-	    this.paramsSet[""+nsURI][name] = value;
-	};
-
-}
-
-
-/**
-  * The baseclass for queryengines
-  * @abstract
-  */
-Freja.QueryEngine = function() {};
-Freja.QueryEngine.prototype.getElementById = function(document, id) {
-	// getElementById doesn't work on XML document without xml:id
-	var allElements = document.getElementsByTagName("*");
-	for (var i= 0; i < allElements.length; i++) {
-		if (allElements[i].getAttribute("id") == id) {
-			return allElements[i];
-		}
-	}
-};
-Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
-	}
-	if(node) return node.nodeValue;
-
-};
-Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
-			}
-			// else parent element does not exist.. can't do anything
-		}
-	}
-};
-/**
-  * XPath query engine.
-  */
-Freja.QueryEngine.XPath = function() {};
-Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node && node.nodeType == 2) {
-		return node;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error("Can't evaluate expression " + expression);
-	return null;
-};
-/**
-  * SimplePath
-  */
-Freja.QueryEngine.SimplePath = function() {};
-Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
-Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
-	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
-		throw new Error("Can't evaluate expression " + expression);
-	}
-	var parts = expression.split(/\//);
-	var node = document;
-	var regAttr = new RegExp("^@([\\d\\w]*)");
-	var regOffset = new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
-	var regFilter = new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
-	var attr = null;
-	var offset = 0;
-	for (var i = 0; i < parts.length; ++i) {
-		var part = parts[i];
-		var filter = regFilter.exec(part);
-		if(filter) {
-			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
-			if(i>0 && parts[i-1]=='') {
-				// expression was of type //element[...]
-				var cn = node.getElementsByTagName(filter[1]);
-			} else {
-				var cn = node.childNodes;
-			}
-			for(var j=0, l=cn.length; j<l ; j++) {
-				if(cn[j].nodeType==1 && cn[j].tagName==filter[1] && cn[j].getAttribute(filter[2])== filter[3]) {
-					node = cn[j];
-					break;
-				}
-			}
-			if (j==l)
-				throw new Error("Can't evaluate expression " + part);
-		}
-		else {
-			offset = regOffset.exec(part);
-			if (offset) {
-				part = offset[1];
-				offset = offset[2] - 1;
-			} else {
-				offset = 0;
-			}
-			if (part != "") {
-				attr = regAttr.exec(part);
-				if (attr) {
-					node = node.getAttributeNode(attr[1]);
-				} else {
-					node = node.getElementsByTagName(part).item(offset);
-				}
-			}
-		}
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	if (!node) {
-		throw new Error("Can't evaluate expression " + expression);
-	}
-	return node;
-};
-/**
-  * Standard model component
-  */
-Freja.Model = function(url, query) {
-	this.url = url;
-	this.ready = false;
-	this.document = null;
-	this._query = query;
-};
-/**
-  * Returns a single value
-  */
-Freja.Model.prototype.getElementById = function(id) {
-	if (this.document) {
-		return this._query.getElementById(this.document, id);
-	}
-	return null;
-};
-/**
-  * Returns a single value
-  */
-Freja.Model.prototype.get = function(expression) {
-	if (this.document) {
-		return this._query.get(this.document, expression);
-	}
-	return null;
-};
-/**
-  * Updates a value
-  */
-Freja.Model.prototype.set = function(expression, value) {
-	if (this.document) {
-		return this._query.set(this.document, expression, value);
-	}
-	return null;
-};
-/**
-  * Updates the model from a view
-  */
-Freja.Model.prototype.updateFrom = function(view) {
-	var values = view.getValues();
-	for (var i = 0; i < values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
-	}
-};
-/**
-  * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.save = function() {
-	var url = this.url;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	// since the serialization may fail, we create a deferred for the
-	// purpose, rather than just returning the sendXMLHttpRequest directly.
-	var d = Freja._aux.createDeferred();
-	var req = Freja.AssetManager.openXMLHttpRequest("POST", url);
-	try {
-		// for some obscure reason exceptions aren't thrown back if I call the
-		// shorthand version of sendXMLHttpRequest in IE6.
-		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.remove = function() {
-	var url = this.url;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var req = Freja.AssetManager.openXMLHttpRequest("DELETE", url);
-	return Freja._aux.sendXMLHttpRequest(req);
-};
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.Model.prototype.reload = function() {
-	this.ready = false;
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, "onload");
-	}, this);
-	var d = Freja.AssetManager.loadAsset(this.url, true);
-	d.addCallbacks(onload, Freja.AssetManager.onerror);
-	return d;
-};
-/**
-  * DataSource provides a gateway-type interface to a REST service.
-  */
-Freja.Model.DataSource = function(createURL, indexURL) {
-	this.createURL = createURL;
-	this.indexURL = indexURL;
-};
-/**
-  * Returns a list of primary-keys to records in the datasource
-  */
-Freja.Model.DataSource.prototype.select = function() {
-	return getModel(this.indexURL);
-};
-/**
-  * Creates a new instance of a record
-  * @todo errback to the deferred on errors
-  */
-Freja.Model.DataSource.prototype.create = function(values) {
-	var url = this.createURL;
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var req = Freja.AssetManager.openXMLHttpRequest("PUT", url);
-	var payload = {};
-	for (var i = 0, len = values[0].length; i < len; ++i) {
-		payload[values[0][i]] = values[1][i];
-	}
-	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
-};
-
-/**
-  * Standard view component
-  */
-Freja.View = function(url, renderer) {
-	this.url = url;
-	this.ready = false;
-	this.document = null;
-	this._renderer = renderer;
-	this._destination = null;
-	this.behaviors = [];
-	this.placeholder = null;
-	Freja._aux.connect(this, "onrendercomplete", Freja._aux.bind(this._connectBehavior, this));
-};
-/**
-  * @param    model            Freja.Model
-  * @param    placeholder      string    If supplied, this will be used instead of the
-  *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.prototype.render = function(model, placeholder, xslParameters) {
-	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
-	if (typeof(xslParameters) == "undefined") xslParameters = this.xslParameters;
-
-	var Handler = function(model, view, deferred, xslParameters) {
-		this.model = model;
-		this.view = view;
-		this.deferred = deferred;
-		this.xslParameters = xslParameters;
-	};
-	Handler.prototype.trigger = function() {
-		try {
-			if (!this.view.ready) {
-				Freja._aux.connect(this.view, "onload", Freja._aux.bind(this.trigger, this));
-				return;
-			}
-			if (typeof(this.model) == "object" && this.model instanceof Freja.Model && !this.model.ready) {
-				Freja._aux.connect(this.model, "onload", Freja._aux.bind(this.trigger, this));
-				return;
-			}
-			var model;
-			if (typeof(this.model) == "undefined") {
-				// supply dummy
-				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
-			} else if (this.model instanceof Freja.Model) {
-				model = this.model;
-			} else {
-				// wrap pojo's in
-				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?>\n" + Freja._aux.xmlize(this.model, "item")) };
-			}
-
-			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
-			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
-			}, this.view));
-			trans.addCallback(Freja._aux.bind(function() {
-				Freja._aux.signal(this, "onrendercomplete", this._destination)
-			}, this.view));
-			trans.addCallback(this.deferred.callback);
-			trans.addErrback(this.deferred.errback);
-		} catch (ex) {
-			this.deferred.errback(ex);
-		}
-	};
-
-	var d = Freja._aux.createDeferred();
-	try {
-		this._destination = Freja._aux.getElement(placeholder);
-		// @todo    Is this a good idea ?
-		// Perhaps we should leave it to the programmer to do this.
-		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
-
-		var h = new Handler(model, this, d, xslParameters);
-		h.trigger();
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * Decorates the output of the primary renderer, to inject behavior.
-  * @note Maybe we could use cssQuery (http://dean.edwards.name/my/cssQuery/)
-  *       to identify targets for behavior
-  */
-Freja.View.prototype._connectBehavior = function(destination) {
-	try {
-		var connectCallback = function(node, eventType, callback) {
-
-			Freja._aux.connect(node, eventType, Freja._aux.bind(
-				function(e) {
-					var allow = false;
-					try {
-						allow = callback(this);
-					} catch (ex) {
-						throw new Error("An error ocurred in user handler.\n" + ex.message);
-					} finally {
-						if (!allow) {
-							e.stop();
-						}
-					}
-				}, node)
-			);
-		};
-		var applyHandlers = function(node, behaviors) {
-			for (var i = 0, c = node.childNodes, l = c.length; i < l; ++i) {
-				var child = c[i];
-				if (child.nodeType == 1) {
-					if(child.className) {
-						var classNames = child.className.split(' ');
-						for (var j=0;j<classNames.length;j++) {
-							var handler = behaviors[classNames[j]];
-							if (handler) {
-								for (var eventType in handler) {
-									if (eventType == "init") {
-										handler.init(child);
-									} else {
-										connectCallback(child, eventType, handler[eventType]);
-									}
-								}
-							}
-						}
-					}
-					applyHandlers(child, behaviors);
-				}
-			}
-		};
-
-		// Avoid traversing the DOM tree if there's no handler to process.
-		// @note: is there a better way? this.behaviors.length is always 0.
-		// @note  This is fine. behaviors is a hashmap, not an array.
-		for (var ids in this.behaviors) {
-			applyHandlers(destination, this.behaviors);
-			break;
-		}
-
-	} catch (ex) {
-		alert(ex.message);
-	}
-};
-/**
-  * Returns the values of a formview
-  */
-Freja.View.prototype.getValues = function() {
-	return Freja._aux.formContents(this._destination);
-};
-/**
-  * Base object for viewrenderers
-  */
-Freja.View.Renderer = function() {};
-/**
-  * XSLT based render-engine
-  */
-Freja.View.Renderer.XSLTransformer = function() {};
-Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
-        var d = Freja._aux.createDeferred();
-        try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
-		if (!html) {
-			d.errback(new Error("XSL Transformation error."));
-		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// <xsl:output method="html" />
-			// (cedsav) don't remember all the details but method="xml" is the way to go.
-			// method="html" would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
-			d.callback(html);
-		}
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * XSLT on a remote service for browser which have no native support.
-  * @param    url    URL of the transform service
-  */
-Freja.View.Renderer.RemoteXSLTransformer = function(url) {
-	this.url = url;
-};
-Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
-        var d = Freja._aux.createDeferred();
-
-	// prepare posted data  (no need to send the XSL document, just its url)
-	var xslUrl = view.url;
-	var postedData = "xslFile=" + encodeURIComponent(xslUrl) + "&xmlData=" + encodeURIComponent(Freja._aux.serializeXML(model.document));
-
-	var xslParameterString = '';
-	for (var paramname in xslParameters) {
-		xslParameterString += encodeURIComponent(paramname + "," + xslParameters[paramname]);
-	}
-	if(xslParameterString.length > 0) {
-		postedData  = postedData + '&xslParam=' + xslParameterString;
-	}
-
-	// send request to the server-side XSL transformation service
-	var req = Freja.AssetManager.openXMLHttpRequest("POST", Freja.AssetManager.XSLT_SERVICE_URL);
-	req.onreadystatechange = function() {
-		if (req.readyState == 4) {
-			if (req.status == 200) {
-				d.callback(req.responseText);
-			} else {
-				d.errback(req.responseText);
-			}
-		}
-	}
-	req.send(postedData);
-	return d;
-};
-/**
-  * This is largely s copied with minor stylistic adjustments from Freja 1.1
-  * I renamed it from Controller.history to distinguish between window.history
-  */
-Freja.UndoHistory = function() {
-	this.cache = [];
-	this.maxLength = 5;
-	this._position = 0;
-	this._undoSteps = 0;
-};
-/**
-  * Creates a snapshot of the model and stores it.
-  */
-Freja.UndoHistory.prototype.add = function(model) {
-	var historyIndex = this._position % this.maxLength;
-
-	var modelDoc = model.document;
-	this.cache[historyIndex] = {};
-	this.cache[historyIndex].model = model;
-	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
-
-	if (!this.cache[historyIndex].document) {
-		throw new Error("Couldn't add to history.");
-	} else {
-		this._position++;
-		// clear rest of the history if undo was used.
-		var clearHistoryIndex = historyIndex;
-		while (this._undoSteps > 0) {
-			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
-			this.cache[clearHistoryIndex] = {};
-			this._undoSteps--;
-		}
-		return historyIndex; // what would anybody need this for ?
-	}
-};
-/**
-  * Rolls the state back one step.
-  */
-Freja.UndoHistory.prototype.undo = function(steps) {
-	if (this._undoSteps < this.cache.length) {
-		this._undoSteps++;
-		this._position--;
-		if (this._position < 0) {
-			this._position = this.maxLength - 1;
-		}
-
-		var model = this.cache[this._position].model;
-		if (this.cache[this._position].document) {
-			model.document = this.cache[this._position].document;
-		} else {
-			throw new Error("The model's DOMDocument wasn't properly copied into the history");
-		}
-		if (typeof(steps) != "undefined" && steps > 1) {
-			this.undo(steps - 1);
-		}
-	} else {
-		throw new Error("Nothing to undo");
-	}
-};
-/**
-  * Reverts the effects of undo.
-  */
-Freja.UndoHistory.prototype.redo = function() {
-	if (this._undoSteps > 0) {
-		this._undoSteps--;
-		this._position = (this._position + 1) % this.maxLength;
-
-		var model = this.cache[this._position].model;
-		model.document = this.cache[this._position].document;
-	} else {
-		throw new Error("Nothing to redo");
-	}
-};
-/**
-  * Removes the last entry in the cache
-  */
-Freja.UndoHistory.prototype.removeLast = function() {
-	this._position--;
-
-	if (this._position < 0) {
-		this._position = this.maxLength - 1;
-	}
-	this.cache[this._position] = {};
-	this._undoSteps = 0;
-};
-
-/**
-  * main repository
-  * @static
-  */
-Freja.AssetManager = {
-	models : [],
-	views : [],
-	_username : null,
-	_password : null
-};
-/**
-  * Set to sync to make all requests synchroneous. You shouldn't use
-  * this setting for anything but testing/debugging.
-  * "async" | "sync"
-  */
-Freja.AssetManager.HTTP_REQUEST_TYPE = "async";
-/**
-  * If this is set to null, real PUT and DELETE http-requests will be made,
-  * otherwise a header will be set instead, and the request tunneled through
-  * POST.
-  *
-  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
-  * if theese are your target platform, you can disable tunneling.
-  */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
-/**
-  * Set this url to provide remote xslt-transformation for browsers that
-  * doesn't support it natively.
-  */
-Freja.AssetManager.XSLT_SERVICE_URL = "srvc-xslt.php";
-/**
-  * HTML displayed while waiting for stuff to happen
-  */
-Freja.AssetManager.THROBBER_HTML = "<span style='color:white;background:firebrick'>Loading ...</span>";
-/**
-  * returns an instance of the renderengine to use
-  */
-Freja.AssetManager.createRenderer = function() {
-//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
-	if (Freja._aux.hasSupportForXSLT()) {
-		return new Freja.View.Renderer.XSLTransformer();
-	} else {
-		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
-	}
-};
-/**
-  * Wipes all caches. This isn't something you will normally use during production,
-  * but it's very helpful for debugging/testing
-  */
-Freja.AssetManager.clearCache = function() {
-	this.models = [];
-	this.views = [];
-};
-/**
-  * Load a model-component
-  * @param    url      string
-  */
-Freja.AssetManager.getModel = function(url) {
-	for (var i=0; i < this.models.length; i++) {
-		if (this.models[i].url == url) {
-			return this.models[i];
-		}
-	}
-	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, "onload");
-	}, m);
-	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
-	this.models.push(m);
-	return m;
-};
-/**
-  * Load a view-component
-  * @param    url      string
-  */
-Freja.AssetManager.getView = function(url) {
-	for (var i=0; i < this.views.length; i++) {
-		if (this.views[i].url == url) {
-			return this.views[i];
-		}
-	}
-	var v = new Freja.View(url, this.createRenderer());
-	var onload = Freja._aux.bind(function(document) {
-		this.document = document;
-		this.ready = true;
-		Freja._aux.signal(this, "onload");
-	}, v);
-	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
-	this.views.push(v);
-	return v;
-};
-/**
-  * Creates and opens a http-request, tunneling exotic methods if needed.
-  */
-Freja.AssetManager.openXMLHttpRequest = function(method, url) {
-	var tunnel = null;
-	if (Freja.AssetManager.HTTP_METHOD_TUNNEL && method != "GET" && method != "POST") {
-		tunnel = method;
-		method = "POST";
-	}
-	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
-	if (tunnel) {
-		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
-	}
-	return req;
-};
-/**
-  * Sets username + password for Http-Authentication
-  */
-Freja.AssetManager.setCredentials = function(username, password) {
-	this._username = username;
-	this._password = password;
-};
-/**
-  * @returns MochiKit.Async.Deferred
-  */
-Freja.AssetManager.loadAsset = function(url, preventCaching) {
-	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-	if (match) {
-		url = match[1] + url; // local
-	}
-	var d = Freja._aux.createDeferred();
-	var handler = function(transport) {
-		try {
-			if (transport.responseText == "") {
-				throw new Error("Empty response.");
-			}
-			if (transport.responseXML.xml == "") {
-				// The server doesn't reply with Content-Type: text/xml
-				// this will happen if the file is loaded locally (through file://)
-				var document = Freja._aux.loadXML(transport.responseText);
-			} else {
-				var document = transport.responseXML;
-			}
-		} catch (ex) {
-			d.errback(ex);
-		}
-		d.callback(document);
-	};
-	try {
-		// Why using HTTP_METHOD_TUNNEL for a GET?
-		//-- to prevent caching, since browsers won't cache a POST
-		if (preventCaching && Freja.AssetManager.HTTP_METHOD_TUNNEL) {
-			var req = Freja._aux.openXMLHttpRequest("POST", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
-			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, "GET");
-			req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
-		} else {
-			var req = Freja._aux.openXMLHttpRequest("GET", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
-		}
-
-		// This shouldn't be nescesary, but alas it is - firefox chokes
-		// It's probably due to an error in MochiKit, so the problem
-		// should be fixed there.
-		var comm = Freja._aux.sendXMLHttpRequest(req);
-		if (Freja.AssetManager.HTTP_REQUEST_TYPE == "async") {
-			// fixes bug #7189 (http://developer.berlios.de/bugs/?func=detailbug&group_id=6277&bug_id=7189)
-			comm.addCallbacks(handler, function(req) {
-				d.errback(new Error("Request failed:" + req.status));
-			});
-		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
-				handler(req);
-			} else {
-				d.errback(new Error("Request failed:" + req.status));
-			}
-		}
-	} catch (ex) {
-		d.errback(ex);
-	}
-	return d;
-};
-/**
-  * This is a default error-handler. You should provide your own.
-  * The handler is called if an asynchronous error happens, since
-  * this could not be caught with the usual try ... catch
-  *
-  * It ought to be replaced completely with Deferred
-  */
-Freja.AssetManager.onerror = function(ex) {
-	alert("Freja.AssetManager.onerror\n" + ex.message);
-};
-/**
-  * Global exports
-  */
-window.getModel = Freja._aux.bind("getModel", Freja.AssetManager);
-window.getView = Freja._aux.bind("getView", Freja.AssetManager);
\ No newline at end of file

Deleted: trunk/lib/MochiKit.js
===================================================================
--- trunk/lib/MochiKit.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/MochiKit.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,4802 +0,0 @@
-/***
-
-    MochiKit.MochiKit 1.3.1 : PACKED VERSION
-
-    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
-    diff against the source tree, not this file.
-
-    See <http://mochikit.com/> for documentation, downloads, license, etc.
-
-    (c) 2005 Bob Ippolito.  All rights Reserved.
-
-***/
-
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Base");
-}
-if(typeof (MochiKit)=="undefined"){
-MochiKit={};
-}
-if(typeof (MochiKit.Base)=="undefined"){
-MochiKit.Base={};
-}
-MochiKit.Base.VERSION="1.3.1";
-MochiKit.Base.NAME="MochiKit.Base";
-MochiKit.Base.update=function(_1,_2){
-if(_1===null){
-_1={};
-}
-for(var i=1;i<arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!="undefined"&&o!==null){
-for(var k in o){
-_1[k]=o[k];
-}
-}
-}
-return _1;
-};
-MochiKit.Base.update(MochiKit.Base,{__repr__:function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-},toString:function(){
-return this.__repr__();
-},counter:function(n){
-if(arguments.length===0){
-n=1;
-}
-return function(){
-return n++;
-};
-},clone:function(_7){
-var me=arguments.callee;
-if(arguments.length==1){
-me.prototype=_7;
-return new me();
-}
-},flattenArguments:function(_9){
-var res=[];
-var m=MochiKit.Base;
-var _12=m.extend(null,arguments);
-while(_12.length){
-var o=_12.shift();
-if(o&&typeof (o)=="object"&&typeof (o.length)=="number"){
-for(var i=o.length-1;i>=0;i--){
-_12.unshift(o[i]);
-}
-}else{
-res.push(o);
-}
-}
-return res;
-},extend:function(_13,obj,_15){
-if(!_15){
-_15=0;
-}
-if(obj){
-var l=obj.length;
-if(typeof (l)!="number"){
-if(typeof (MochiKit.Iter)!="undefined"){
-obj=MochiKit.Iter.list(obj);
-l=obj.length;
-}else{
-throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
-}
-}
-if(!_13){
-_13=[];
-}
-for(var i=_15;i<l;i++){
-_13.push(obj[i]);
-}
-}
-return _13;
-},updatetree:function(_17,obj){
-if(_17===null){
-_17={};
-}
-for(var i=1;i<arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!="undefined"&&o!==null){
-for(var k in o){
-var v=o[k];
-if(typeof (_17[k])=="object"&&typeof (v)=="object"){
-arguments.callee(_17[k],v);
-}else{
-_17[k]=v;
-}
-}
-}
-}
-return _17;
-},setdefault:function(_19,obj){
-if(_19===null){
-_19={};
-}
-for(var i=1;i<arguments.length;i++){
-var o=arguments[i];
-for(var k in o){
-if(!(k in _19)){
-_19[k]=o[k];
-}
-}
-}
-return _19;
-},keys:function(obj){
-var _20=[];
-for(var _21 in obj){
-_20.push(_21);
-}
-return _20;
-},items:function(obj){
-var _22=[];
-var e;
-for(var _24 in obj){
-var v;
-try{
-v=obj[_24];
-}
-catch(e){
-continue;
-}
-_22.push([_24,v]);
-}
-return _22;
-},_newNamedError:function(_25,_26,_27){
-_27.prototype=new MochiKit.Base.NamedError(_25.NAME+"."+_26);
-_25[_26]=_27;
-},operator:{truth:function(a){
-return !!a;
-},lognot:function(a){
-return !a;
-},identity:function(a){
-return a;
-},not:function(a){
-return ~a;
-},neg:function(a){
-return -a;
-},add:function(a,b){
-return a+b;
-},sub:function(a,b){
-return a-b;
-},div:function(a,b){
-return a/b;
-},mod:function(a,b){
-return a%b;
-},mul:function(a,b){
-return a*b;
-},and:function(a,b){
-return a&b;
-},or:function(a,b){
-return a|b;
-},xor:function(a,b){
-return a^b;
-},lshift:function(a,b){
-return a<<b;
-},rshift:function(a,b){
-return a>>b;
-},zrshift:function(a,b){
-return a>>>b;
-},eq:function(a,b){
-return a==b;
-},ne:function(a,b){
-return a!=b;
-},gt:function(a,b){
-return a>b;
-},ge:function(a,b){
-return a>=b;
-},lt:function(a,b){
-return a<b;
-},le:function(a,b){
-return a<=b;
-},ceq:function(a,b){
-return MochiKit.Base.compare(a,b)===0;
-},cne:function(a,b){
-return MochiKit.Base.compare(a,b)!==0;
-},cgt:function(a,b){
-return MochiKit.Base.compare(a,b)==1;
-},cge:function(a,b){
-return MochiKit.Base.compare(a,b)!=-1;
-},clt:function(a,b){
-return MochiKit.Base.compare(a,b)==-1;
-},cle:function(a,b){
-return MochiKit.Base.compare(a,b)!=1;
-},logand:function(a,b){
-return a&&b;
-},logor:function(a,b){
-return a||b;
-},contains:function(a,b){
-return b in a;
-}},forwardCall:function(_30){
-return function(){
-return this[_30].apply(this,arguments);
-};
-},itemgetter:function(_31){
-return function(arg){
-return arg[_31];
-};
-},typeMatcher:function(){
-var _33={};
-for(var i=0;i<arguments.length;i++){
-var typ=arguments[i];
-_33[typ]=typ;
-}
-return function(){
-for(var i=0;i<arguments.length;i++){
-if(!(typeof (arguments[i]) in _33)){
-return false;
-}
-}
-return true;
-};
-},isNull:function(){
-for(var i=0;i<arguments.length;i++){
-if(arguments[i]!==null){
-return false;
-}
-}
-return true;
-},isUndefinedOrNull:function(){
-for(var i=0;i<arguments.length;i++){
-var o=arguments[i];
-if(!(typeof (o)=="undefined"||o===null)){
-return false;
-}
-}
-return true;
-},isEmpty:function(obj){
-return !MochiKit.Base.isNotEmpty.apply(this,arguments);
-},isNotEmpty:function(obj){
-for(var i=0;i<arguments.length;i++){
-var o=arguments[i];
-if(!(o&&o.length)){
-return false;
-}
-}
-return true;
-},isArrayLike:function(){
-for(var i=0;i<arguments.length;i++){
-var o=arguments[i];
-var typ=typeof (o);
-if((typ!="object"&&!(typ=="function"&&typeof (o.item)=="function"))||o===null||typeof (o.length)!="number"){
-return false;
-}
-}
-return true;
-},isDateLike:function(){
-for(var i=0;i<arguments.length;i++){
-var o=arguments[i];
-if(typeof (o)!="object"||o===null||typeof (o.getTime)!="function"){
-return false;
-}
-}
-return true;
-},xmap:function(fn){
-if(fn===null){
-return MochiKit.Base.extend(null,arguments,1);
-}
-var _36=[];
-for(var i=1;i<arguments.length;i++){
-_36.push(fn(arguments[i]));
-}
-return _36;
-},map:function(fn,lst){
-var m=MochiKit.Base;
-var itr=MochiKit.Iter;
-var _39=m.isArrayLike;
-if(arguments.length<=2){
-if(!_39(lst)){
-if(itr){
-lst=itr.list(lst);
-if(fn===null){
-return lst;
-}
-}else{
-throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
-}
-}
-if(fn===null){
-return m.extend(null,lst);
-}
-var _40=[];
-for(var i=0;i<lst.length;i++){
-_40.push(fn(lst[i]));
-}
-return _40;
-}else{
-if(fn===null){
-fn=Array;
-}
-var _41=null;
-for(i=1;i<arguments.length;i++){
-if(!_39(arguments[i])){
-if(itr){
-return itr.list(itr.imap.apply(null,arguments));
-}else{
-throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
-}
-}
-var l=arguments[i].length;
-if(_41===null||_41>l){
-_41=l;
-}
-}
-_40=[];
-for(i=0;i<_41;i++){
-var _42=[];
-for(var j=1;j<arguments.length;j++){
-_42.push(arguments[j][i]);
-}
-_40.push(fn.apply(this,_42));
-}
-return _40;
-}
-},xfilter:function(fn){
-var _44=[];
-if(fn===null){
-fn=MochiKit.Base.operator.truth;
-}
-for(var i=1;i<arguments.length;i++){
-var o=arguments[i];
-if(fn(o)){
-_44.push(o);
-}
-}
-return _44;
-},filter:function(fn,lst,_45){
-var _46=[];
-var m=MochiKit.Base;
-if(!m.isArrayLike(lst)){
-if(MochiKit.Iter){
-lst=MochiKit.Iter.list(lst);
-}else{
-throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
-}
-}
-if(fn===null){
-fn=m.operator.truth;
-}
-if(typeof (Array.prototype.filter)=="function"){
-return Array.prototype.filter.call(lst,fn,_45);
-}else{
-if(typeof (_45)=="undefined"||_45===null){
-for(var i=0;i<lst.length;i++){
-var o=lst[i];
-if(fn(o)){
-_46.push(o);
-}
-}
-}else{
-for(i=0;i<lst.length;i++){
-o=lst[i];
-if(fn.call(_45,o)){
-_46.push(o);
-}
-}
-}
-}
-return _46;
-},_wrapDumbFunction:function(_47){
-return function(){
-switch(arguments.length){
-case 0:
-return _47();
-case 1:
-return _47(arguments[0]);
-case 2:
-return _47(arguments[0],arguments[1]);
-case 3:
-return _47(arguments[0],arguments[1],arguments[2]);
-}
-var _48=[];
-for(var i=0;i<arguments.length;i++){
-_48.push("arguments["+i+"]");
-}
-return eval("(func("+_48.join(",")+"))");
-};
-},method:function(_49,_50){
-var m=MochiKit.Base;
-return m.bind.apply(this,m.extend([_50,_49],arguments,2));
-},bind:function(_51,_52){
-if(typeof (_51)=="string"){
-_51=_52[_51];
-}
-var _53=_51.im_func;
-var _54=_51.im_preargs;
-var _55=_51.im_self;
-var m=MochiKit.Base;
-if(typeof (_51)=="function"&&typeof (_51.apply)=="undefined"){
-_51=m._wrapDumbFunction(_51);
-}
-if(typeof (_53)!="function"){
-_53=_51;
-}
-if(typeof (_52)!="undefined"){
-_55=_52;
-}
-if(typeof (_54)=="undefined"){
-_54=[];
-}else{
-_54=_54.slice();
-}
-m.extend(_54,arguments,2);
-var _56=function(){
-var _57=arguments;
-var me=arguments.callee;
-if(me.im_preargs.length>0){
-_57=m.concat(me.im_preargs,_57);
-}
-var _52=me.im_self;
-if(!_52){
-_52=this;
-}
-return me.im_func.apply(_52,_57);
-};
-_56.im_self=_55;
-_56.im_func=_53;
-_56.im_preargs=_54;
-return _56;
-},bindMethods:function(_58){
-var _59=MochiKit.Base.bind;
-for(var k in _58){
-var _60=_58[k];
-if(typeof (_60)=="function"){
-_58[k]=_59(_60,_58);
-}
-}
-},registerComparator:function(_61,_62,_63,_64){
-MochiKit.Base.comparatorRegistry.register(_61,_62,_63,_64);
-},_primitives:{"bool":true,"string":true,"number":true},compare:function(a,b){
-if(a==b){
-return 0;
-}
-var _65=(typeof (a)=="undefined"||a===null);
-var _66=(typeof (b)=="undefined"||b===null);
-if(_65&&_66){
-return 0;
-}else{
-if(_65){
-return -1;
-}else{
-if(_66){
-return 1;
-}
-}
-}
-var m=MochiKit.Base;
-var _67=m._primitives;
-if(!(typeof (a) in _67&&typeof (b) in _67)){
-try{
-return m.comparatorRegistry.match(a,b);
-}
-catch(e){
-if(e!=m.NotFound){
-throw e;
-}
-}
-}
-if(a<b){
-return -1;
-}else{
-if(a>b){
-return 1;
-}
-}
-var _68=m.repr;
-throw new TypeError(_68(a)+" and "+_68(b)+" can not be compared");
-},compareDateLike:function(a,b){
-return MochiKit.Base.compare(a.getTime(),b.getTime());
-},compareArrayLike:function(a,b){
-var _69=MochiKit.Base.compare;
-var _70=a.length;
-var _71=0;
-if(_70>b.length){
-_71=1;
-_70=b.length;
-}else{
-if(_70<b.length){
-_71=-1;
-}
-}
-for(var i=0;i<_70;i++){
-var cmp=_69(a[i],b[i]);
-if(cmp){
-return cmp;
-}
-}
-return _71;
-},registerRepr:function(_73,_74,_75,_76){
-MochiKit.Base.reprRegistry.register(_73,_74,_75,_76);
-},repr:function(o){
-if(typeof (o)=="undefined"){
-return "undefined";
-}else{
-if(o===null){
-return "null";
-}
-}
-try{
-if(typeof (o.__repr__)=="function"){
-return o.__repr__();
-}else{
-if(typeof (o.repr)=="function"&&o.repr!=arguments.callee){
-return o.repr();
-}
-}
-return MochiKit.Base.reprRegistry.match(o);
-}
-catch(e){
-if(typeof (o.NAME)=="string"&&(o.toString==Function.prototype.toString||o.toString==Object.prototype.toString)){
-return o.NAME;
-}
-}
-try{
-var _77=(o+"");
-}
-catch(e){
-return "["+typeof (o)+"]";
-}
-if(typeof (o)=="function"){
-o=_77.replace(/^\s+/,"");
-var idx=o.indexOf("{");
-if(idx!=-1){
-o=o.substr(0,idx)+"{...}";
-}
-}
-return _77;
-},reprArrayLike:function(o){
-var m=MochiKit.Base;
-return "["+m.map(m.repr,o).join(", ")+"]";
-},reprString:function(o){
-return ("\""+o.replace(/(["\\])/g,"\\$1")+"\"").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r");
-},reprNumber:function(o){
-return o+"";
-},registerJSON:function(_79,_80,_81,_82){
-MochiKit.Base.jsonRegistry.register(_79,_80,_81,_82);
-},evalJSON:function(){
-return eval("("+arguments[0]+")");
-},serializeJSON:function(o){
-var _83=typeof (o);
-if(_83=="undefined"){
-return "undefined";
-}else{
-if(_83=="number"||_83=="boolean"){
-return o+"";
-}else{
-if(o===null){
-return "null";
-}
-}
-}
-var m=MochiKit.Base;
-var _84=m.reprString;
-if(_83=="string"){
-return _84(o);
-}
-var me=arguments.callee;
-var _85;
-if(typeof (o.__json__)=="function"){
-_85=o.__json__();
-if(o!==_85){
-return me(_85);
-}
-}
-if(typeof (o.json)=="function"){
-_85=o.json();
-if(o!==_85){
-return me(_85);
-}
-}
-if(_83!="function"&&typeof (o.length)=="number"){
-var res=[];
-for(var i=0;i<o.length;i++){
-var val=me(o[i]);
-if(typeof (val)!="string"){
-val="undefined";
-}
-res.push(val);
-}
-return "["+res.join(", ")+"]";
-}
-try{
-_85=m.jsonRegistry.match(o);
-return me(_85);
-}
-catch(e){
-if(e!=m.NotFound){
-throw e;
-}
-}
-if(_83=="function"){
-return null;
-}
-res=[];
-for(var k in o){
-var _87;
-if(typeof (k)=="number"){
-_87="\""+k+"\"";
-}else{
-if(typeof (k)=="string"){
-_87=_84(k);
-}else{
-continue;
-}
-}
-val=me(o[k]);
-if(typeof (val)!="string"){
-continue;
-}
-res.push(_87+":"+val);
-}
-return "{"+res.join(", ")+"}";
-},objEqual:function(a,b){
-return (MochiKit.Base.compare(a,b)===0);
-},arrayEqual:function(_88,arr){
-if(_88.length!=arr.length){
-return false;
-}
-return (MochiKit.Base.compare(_88,arr)===0);
-},concat:function(){
-var _90=[];
-var _91=MochiKit.Base.extend;
-for(var i=0;i<arguments.length;i++){
-_91(_90,arguments[i]);
-}
-return _90;
-},keyComparator:function(key){
-var m=MochiKit.Base;
-var _93=m.compare;
-if(arguments.length==1){
-return function(a,b){
-return _93(a[key],b[key]);
-};
-}
-var _94=m.extend(null,arguments);
-return function(a,b){
-var _95=0;
-for(var i=0;(_95===0)&&(i<_94.length);i++){
-var key=_94[i];
-_95=_93(a[key],b[key]);
-}
-return _95;
-};
-},reverseKeyComparator:function(key){
-var _96=MochiKit.Base.keyComparator.apply(this,arguments);
-return function(a,b){
-return _96(b,a);
-};
-},partial:function(_97){
-var m=MochiKit.Base;
-return m.bind.apply(this,m.extend([_97,undefined],arguments,1));
-},listMinMax:function(_98,lst){
-if(lst.length===0){
-return null;
-}
-var cur=lst[0];
-var _100=MochiKit.Base.compare;
-for(var i=1;i<lst.length;i++){
-var o=lst[i];
-if(_100(o,cur)==_98){
-cur=o;
-}
-}
-return cur;
-},objMax:function(){
-return MochiKit.Base.listMinMax(1,arguments);
-},objMin:function(){
-return MochiKit.Base.listMinMax(-1,arguments);
-},findIdentical:function(lst,_101,_102,end){
-if(typeof (end)=="undefined"||end===null){
-end=lst.length;
-}
-for(var i=(_102||0);i<end;i++){
-if(lst[i]===_101){
-return i;
-}
-}
-return -1;
-},findValue:function(lst,_104,_105,end){
-if(typeof (end)=="undefined"||end===null){
-end=lst.length;
-}
-var cmp=MochiKit.Base.compare;
-for(var i=(_105||0);i<end;i++){
-if(cmp(lst[i],_104)===0){
-return i;
-}
-}
-return -1;
-},nodeWalk:function(node,_107){
-var _108=[node];
-var _109=MochiKit.Base.extend;
-while(_108.length){
-var res=_107(_108.shift());
-if(res){
-_109(_108,res);
-}
-}
-},nameFunctions:function(_110){
-var base=_110.NAME;
-if(typeof (base)=="undefined"){
-base="";
-}else{
-base=base+".";
-}
-for(var name in _110){
-var o=_110[name];
-if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
-try{
-o.NAME=base+name;
-}
-catch(e){
-}
-}
-}
-},queryString:function(_113,_114){
-if(typeof (MochiKit.DOM)!="undefined"&&arguments.length==1&&(typeof (_113)=="string"||(typeof (_113.nodeType)!="undefined"&&_113.nodeType>0))){
-var kv=MochiKit.DOM.formContents(_113);
-_113=kv[0];
-_114=kv[1];
-}else{
-if(arguments.length==1){
-var o=_113;
-_113=[];
-_114=[];
-for(var k in o){
-var v=o[k];
-if(typeof (v)!="function"){
-_113.push(k);
-_114.push(v);
-}
-}
-}
-}
-var rval=[];
-var len=Math.min(_113.length,_114.length);
-var _118=MochiKit.Base.urlEncode;
-for(var i=0;i<len;i++){
-v=_114[i];
-if(typeof (v)!="undefined"&&v!==null){
-rval.push(_118(_113[i])+"="+_118(v));
-}
-}
-return rval.join("&");
-},parseQueryString:function(_119,_120){
-var _121=_119.replace(/\+/g,"%20").split("&");
-var o={};
-var _122;
-if(typeof (decodeURIComponent)!="undefined"){
-_122=decodeURIComponent;
-}else{
-_122=unescape;
-}
-if(_120){
-for(var i=0;i<_121.length;i++){
-var pair=_121[i].split("=");
-var name=_122(pair[0]);
-var arr=o[name];
-if(!(arr instanceof Array)){
-arr=[];
-o[name]=arr;
-}
-arr.push(_122(pair[1]));
-}
-}else{
-for(i=0;i<_121.length;i++){
-pair=_121[i].split("=");
-o[_122(pair[0])]=_122(pair[1]);
-}
-}
-return o;
-}});
-MochiKit.Base.AdapterRegistry=function(){
-this.pairs=[];
-};
-MochiKit.Base.AdapterRegistry.prototype={register:function(name,_124,wrap,_126){
-if(_126){
-this.pairs.unshift([name,_124,wrap]);
-}else{
-this.pairs.push([name,_124,wrap]);
-}
-},match:function(){
-for(var i=0;i<this.pairs.length;i++){
-var pair=this.pairs[i];
-if(pair[1].apply(this,arguments)){
-return pair[2].apply(this,arguments);
-}
-}
-throw MochiKit.Base.NotFound;
-},unregister:function(name){
-for(var i=0;i<this.pairs.length;i++){
-var pair=this.pairs[i];
-if(pair[0]==name){
-this.pairs.splice(i,1);
-return true;
-}
-}
-return false;
-}};
-MochiKit.Base.EXPORT=["counter","clone","extend","update","updatetree","setdefault","keys","items","NamedError","operator","forwardCall","itemgetter","typeMatcher","isCallable","isUndefined","isUndefinedOrNull","isNull","isEmpty","isNotEmpty","isArrayLike","isDateLike","xmap","map","xfilter","filter","bind","bindMethods","NotFound","AdapterRegistry","registerComparator","compare","registerRepr","repr","objEqual","arrayEqual","concat","keyComparator","reverseKeyComparator","partial","merge","listMinMax","listMax","listMin","objMax","objMin","nodeWalk","zip","urlEncode","queryString","serializeJSON","registerJSON","evalJSON","parseQueryString","findValue","findIdentical","flattenArguments","method"];
-MochiKit.Base.EXPORT_OK=["nameFunctions","comparatorRegistry","reprRegistry","jsonRegistry","compareDateLike","compareArrayLike","reprArrayLike","reprString","reprNumber"];
-MochiKit.Base._exportSymbols=function(_127,_128){
-if(typeof (MochiKit.__export__)=="undefined"){
-MochiKit.__export__=(MochiKit.__compat__||(typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined"));
-}
-if(!MochiKit.__export__){
-return;
-}
-var all=_128.EXPORT_TAGS[":all"];
-for(var i=0;i<all.length;i++){
-_127[all[i]]=_128[all[i]];
-}
-};
-MochiKit.Base.__new__=function(){
-var m=this;
-m.forward=m.forwardCall;
-m.find=m.findValue;
-if(typeof (encodeURIComponent)!="undefined"){
-m.urlEncode=function(_130){
-return encodeURIComponent(_130).replace(/\'/g,"%27");
-};
-}else{
-m.urlEncode=function(_131){
-return escape(_131).replace(/\+/g,"%2B").replace(/\"/g,"%22").rval.replace(/\'/g,"%27");
-};
-}
-m.NamedError=function(name){
-this.message=name;
-this.name=name;
-};
-m.NamedError.prototype=new Error();
-m.update(m.NamedError.prototype,{repr:function(){
-if(this.message&&this.message!=this.name){
-return this.name+"("+m.repr(this.message)+")";
-}else{
-return this.name+"()";
-}
-},toString:m.forwardCall("repr")});
-m.NotFound=new m.NamedError("MochiKit.Base.NotFound");
-m.listMax=m.partial(m.listMinMax,1);
-m.listMin=m.partial(m.listMinMax,-1);
-m.isCallable=m.typeMatcher("function");
-m.isUndefined=m.typeMatcher("undefined");
-m.merge=m.partial(m.update,null);
-m.zip=m.partial(m.map,null);
-m.comparatorRegistry=new m.AdapterRegistry();
-m.registerComparator("dateLike",m.isDateLike,m.compareDateLike);
-m.registerComparator("arrayLike",m.isArrayLike,m.compareArrayLike);
-m.reprRegistry=new m.AdapterRegistry();
-m.registerRepr("arrayLike",m.isArrayLike,m.reprArrayLike);
-m.registerRepr("string",m.typeMatcher("string"),m.reprString);
-m.registerRepr("numbers",m.typeMatcher("number","boolean"),m.reprNumber);
-m.jsonRegistry=new m.AdapterRegistry();
-var all=m.concat(m.EXPORT,m.EXPORT_OK);
-m.EXPORT_TAGS={":common":m.concat(m.EXPORT_OK),":all":all};
-m.nameFunctions(this);
-};
-MochiKit.Base.__new__();
-if(!MochiKit.__compat__){
-compare=MochiKit.Base.compare;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Base);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Iter");
-dojo.require("MochiKit.Base");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Iter depends on MochiKit.Base!";
-}
-if(typeof (MochiKit.Iter)=="undefined"){
-MochiKit.Iter={};
-}
-MochiKit.Iter.NAME="MochiKit.Iter";
-MochiKit.Iter.VERSION="1.3.1";
-MochiKit.Base.update(MochiKit.Iter,{__repr__:function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-},toString:function(){
-return this.__repr__();
-},registerIteratorFactory:function(name,_132,_133,_134){
-MochiKit.Iter.iteratorRegistry.register(name,_132,_133,_134);
-},iter:function(_135,_136){
-var self=MochiKit.Iter;
-if(arguments.length==2){
-return self.takewhile(function(a){
-return a!=_136;
-},_135);
-}
-if(typeof (_135.next)=="function"){
-return _135;
-}else{
-if(typeof (_135.iter)=="function"){
-return _135.iter();
-}
-}
-try{
-return self.iteratorRegistry.match(_135);
-}
-catch(e){
-var m=MochiKit.Base;
-if(e==m.NotFound){
-e=new TypeError(typeof (_135)+": "+m.repr(_135)+" is not iterable");
-}
-throw e;
-}
-},count:function(n){
-if(!n){
-n=0;
-}
-var m=MochiKit.Base;
-return {repr:function(){
-return "count("+n+")";
-},toString:m.forwardCall("repr"),next:m.counter(n)};
-},cycle:function(p){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-var lst=[];
-var _139=self.iter(p);
-return {repr:function(){
-return "cycle(...)";
-},toString:m.forwardCall("repr"),next:function(){
-try{
-var rval=_139.next();
-lst.push(rval);
-return rval;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-if(lst.length===0){
-this.next=function(){
-throw self.StopIteration;
-};
-}else{
-var i=-1;
-this.next=function(){
-i=(i+1)%lst.length;
-return lst[i];
-};
-}
-return this.next();
-}
-}};
-},repeat:function(elem,n){
-var m=MochiKit.Base;
-if(typeof (n)=="undefined"){
-return {repr:function(){
-return "repeat("+m.repr(elem)+")";
-},toString:m.forwardCall("repr"),next:function(){
-return elem;
-}};
-}
-return {repr:function(){
-return "repeat("+m.repr(elem)+", "+n+")";
-},toString:m.forwardCall("repr"),next:function(){
-if(n<=0){
-throw MochiKit.Iter.StopIteration;
-}
-n-=1;
-return elem;
-}};
-},next:function(_141){
-return _141.next();
-},izip:function(p,q){
-var m=MochiKit.Base;
-var next=MochiKit.Iter.next;
-var _144=m.map(iter,arguments);
-return {repr:function(){
-return "izip(...)";
-},toString:m.forwardCall("repr"),next:function(){
-return m.map(next,_144);
-}};
-},ifilter:function(pred,seq){
-var m=MochiKit.Base;
-seq=MochiKit.Iter.iter(seq);
-if(pred===null){
-pred=m.operator.truth;
-}
-return {repr:function(){
-return "ifilter(...)";
-},toString:m.forwardCall("repr"),next:function(){
-while(true){
-var rval=seq.next();
-if(pred(rval)){
-return rval;
-}
-}
-return undefined;
-}};
-},ifilterfalse:function(pred,seq){
-var m=MochiKit.Base;
-seq=MochiKit.Iter.iter(seq);
-if(pred===null){
-pred=m.operator.truth;
-}
-return {repr:function(){
-return "ifilterfalse(...)";
-},toString:m.forwardCall("repr"),next:function(){
-while(true){
-var rval=seq.next();
-if(!pred(rval)){
-return rval;
-}
-}
-return undefined;
-}};
-},islice:function(seq){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-seq=self.iter(seq);
-var _147=0;
-var stop=0;
-var step=1;
-var i=-1;
-if(arguments.length==2){
-stop=arguments[1];
-}else{
-if(arguments.length==3){
-_147=arguments[1];
-stop=arguments[2];
-}else{
-_147=arguments[1];
-stop=arguments[2];
-step=arguments[3];
-}
-}
-return {repr:function(){
-return "islice("+["...",_147,stop,step].join(", ")+")";
-},toString:m.forwardCall("repr"),next:function(){
-var rval;
-while(i<_147){
-rval=seq.next();
-i++;
-}
-if(_147>=stop){
-throw self.StopIteration;
-}
-_147+=step;
-return rval;
-}};
-},imap:function(fun,p,q){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-var _151=m.map(self.iter,m.extend(null,arguments,1));
-var map=m.map;
-var next=self.next;
-return {repr:function(){
-return "imap(...)";
-},toString:m.forwardCall("repr"),next:function(){
-return fun.apply(this,map(next,_151));
-}};
-},applymap:function(fun,seq,self){
-seq=MochiKit.Iter.iter(seq);
-var m=MochiKit.Base;
-return {repr:function(){
-return "applymap(...)";
-},toString:m.forwardCall("repr"),next:function(){
-return fun.apply(self,seq.next());
-}};
-},chain:function(p,q){
-var self=MochiKit.Iter;
-var m=MochiKit.Base;
-if(arguments.length==1){
-return self.iter(arguments[0]);
-}
-var _153=m.map(self.iter,arguments);
-return {repr:function(){
-return "chain(...)";
-},toString:m.forwardCall("repr"),next:function(){
-while(_153.length>1){
-try{
-return _153[0].next();
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-_153.shift();
-}
-}
-if(_153.length==1){
-var arg=_153.shift();
-this.next=m.bind("next",arg);
-return this.next();
-}
-throw self.StopIteration;
-}};
-},takewhile:function(pred,seq){
-var self=MochiKit.Iter;
-seq=self.iter(seq);
-return {repr:function(){
-return "takewhile(...)";
-},toString:MochiKit.Base.forwardCall("repr"),next:function(){
-var rval=seq.next();
-if(!pred(rval)){
-this.next=function(){
-throw self.StopIteration;
-};
-this.next();
-}
-return rval;
-}};
-},dropwhile:function(pred,seq){
-seq=MochiKit.Iter.iter(seq);
-var m=MochiKit.Base;
-var bind=m.bind;
-return {"repr":function(){
-return "dropwhile(...)";
-},"toString":m.forwardCall("repr"),"next":function(){
-while(true){
-var rval=seq.next();
-if(!pred(rval)){
-break;
-}
-}
-this.next=bind("next",seq);
-return rval;
-}};
-},_tee:function(_155,sync,_157){
-sync.pos[_155]=-1;
-var m=MochiKit.Base;
-var _158=m.listMin;
-return {repr:function(){
-return "tee("+_155+", ...)";
-},toString:m.forwardCall("repr"),next:function(){
-var rval;
-var i=sync.pos[_155];
-if(i==sync.max){
-rval=_157.next();
-sync.deque.push(rval);
-sync.max+=1;
-sync.pos[_155]+=1;
-}else{
-rval=sync.deque[i-sync.min];
-sync.pos[_155]+=1;
-if(i==sync.min&&_158(sync.pos)!=sync.min){
-sync.min+=1;
-sync.deque.shift();
-}
-}
-return rval;
-}};
-},tee:function(_159,n){
-var rval=[];
-var sync={"pos":[],"deque":[],"max":-1,"min":-1};
-if(arguments.length==1){
-n=2;
-}
-var self=MochiKit.Iter;
-_159=self.iter(_159);
-var _tee=self._tee;
-for(var i=0;i<n;i++){
-rval.push(_tee(i,sync,_159));
-}
-return rval;
-},list:function(_161){
-var m=MochiKit.Base;
-if(typeof (_161.slice)=="function"){
-return _161.slice();
-}else{
-if(m.isArrayLike(_161)){
-return m.concat(_161);
-}
-}
-var self=MochiKit.Iter;
-_161=self.iter(_161);
-var rval=[];
-try{
-while(true){
-rval.push(_161.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return rval;
-}
-return undefined;
-},reduce:function(fn,_162,_163){
-var i=0;
-var x=_163;
-var self=MochiKit.Iter;
-_162=self.iter(_162);
-if(arguments.length<3){
-try{
-x=_162.next();
-}
-catch(e){
-if(e==self.StopIteration){
-e=new TypeError("reduce() of empty sequence with no initial value");
-}
-throw e;
-}
-i++;
-}
-try{
-while(true){
-x=fn(x,_162.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-return x;
-},range:function(){
-var _165=0;
-var stop=0;
-var step=1;
-if(arguments.length==1){
-stop=arguments[0];
-}else{
-if(arguments.length==2){
-_165=arguments[0];
-stop=arguments[1];
-}else{
-if(arguments.length==3){
-_165=arguments[0];
-stop=arguments[1];
-step=arguments[2];
-}else{
-throw new TypeError("range() takes 1, 2, or 3 arguments!");
-}
-}
-}
-if(step===0){
-throw new TypeError("range() step must not be 0");
-}
-return {next:function(){
-if((step>0&&_165>=stop)||(step<0&&_165<=stop)){
-throw MochiKit.Iter.StopIteration;
-}
-var rval=_165;
-_165+=step;
-return rval;
-},repr:function(){
-return "range("+[_165,stop,step].join(", ")+")";
-},toString:MochiKit.Base.forwardCall("repr")};
-},sum:function(_166,_167){
-var x=_167||0;
-var self=MochiKit.Iter;
-_166=self.iter(_166);
-try{
-while(true){
-x+=_166.next();
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-return x;
-},exhaust:function(_168){
-var self=MochiKit.Iter;
-_168=self.iter(_168);
-try{
-while(true){
-_168.next();
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-},forEach:function(_169,func,self){
-var m=MochiKit.Base;
-if(arguments.length>2){
-func=m.bind(func,self);
-}
-if(m.isArrayLike(_169)){
-try{
-for(var i=0;i<_169.length;i++){
-func(_169[i]);
-}
-}
-catch(e){
-if(e!=MochiKit.Iter.StopIteration){
-throw e;
-}
-}
-}else{
-self=MochiKit.Iter;
-self.exhaust(self.imap(func,_169));
-}
-},every:function(_171,func){
-var self=MochiKit.Iter;
-try{
-self.ifilterfalse(func,_171).next();
-return false;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return true;
-}
-},sorted:function(_172,cmp){
-var rval=MochiKit.Iter.list(_172);
-if(arguments.length==1){
-cmp=MochiKit.Base.compare;
-}
-rval.sort(cmp);
-return rval;
-},reversed:function(_173){
-var rval=MochiKit.Iter.list(_173);
-rval.reverse();
-return rval;
-},some:function(_174,func){
-var self=MochiKit.Iter;
-try{
-self.ifilter(func,_174).next();
-return true;
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-return false;
-}
-},iextend:function(lst,_175){
-if(MochiKit.Base.isArrayLike(_175)){
-for(var i=0;i<_175.length;i++){
-lst.push(_175[i]);
-}
-}else{
-var self=MochiKit.Iter;
-_175=self.iter(_175);
-try{
-while(true){
-lst.push(_175.next());
-}
-}
-catch(e){
-if(e!=self.StopIteration){
-throw e;
-}
-}
-}
-return lst;
-},groupby:function(_176,_177){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-if(arguments.length<2){
-_177=m.operator.identity;
-}
-_176=self.iter(_176);
-var pk=undefined;
-var k=undefined;
-var v;
-function fetch(){
-v=_176.next();
-k=_177(v);
-}
-function eat(){
-var ret=v;
-v=undefined;
-return ret;
-}
-var _180=true;
-return {repr:function(){
-return "groupby(...)";
-},next:function(){
-while(k==pk){
-fetch();
-if(_180){
-_180=false;
-break;
-}
-}
-pk=k;
-return [k,{next:function(){
-if(v==undefined){
-fetch();
-}
-if(k!=pk){
-throw self.StopIteration;
-}
-return eat();
-}}];
-}};
-},groupby_as_array:function(_181,_182){
-var m=MochiKit.Base;
-var self=MochiKit.Iter;
-if(arguments.length<2){
-_182=m.operator.identity;
-}
-_181=self.iter(_181);
-var _183=[];
-var _184=true;
-var _185;
-while(true){
-try{
-var _186=_181.next();
-var key=_182(_186);
-}
-catch(e){
-if(e==self.StopIteration){
-break;
-}
-throw e;
-}
-if(_184||key!=_185){
-var _187=[];
-_183.push([key,_187]);
-}
-_187.push(_186);
-_184=false;
-_185=key;
-}
-return _183;
-},arrayLikeIter:function(_188){
-var i=0;
-return {repr:function(){
-return "arrayLikeIter(...)";
-},toString:MochiKit.Base.forwardCall("repr"),next:function(){
-if(i>=_188.length){
-throw MochiKit.Iter.StopIteration;
-}
-return _188[i++];
-}};
-},hasIterateNext:function(_189){
-return (_189&&typeof (_189.iterateNext)=="function");
-},iterateNextIter:function(_190){
-return {repr:function(){
-return "iterateNextIter(...)";
-},toString:MochiKit.Base.forwardCall("repr"),next:function(){
-var rval=_190.iterateNext();
-if(rval===null||rval===undefined){
-throw MochiKit.Iter.StopIteration;
-}
-return rval;
-}};
-}});
-MochiKit.Iter.EXPORT_OK=["iteratorRegistry","arrayLikeIter","hasIterateNext","iterateNextIter",];
-MochiKit.Iter.EXPORT=["StopIteration","registerIteratorFactory","iter","count","cycle","repeat","next","izip","ifilter","ifilterfalse","islice","imap","applymap","chain","takewhile","dropwhile","tee","list","reduce","range","sum","exhaust","forEach","every","sorted","reversed","some","iextend","groupby","groupby_as_array"];
-MochiKit.Iter.__new__=function(){
-var m=MochiKit.Base;
-this.StopIteration=new m.NamedError("StopIteration");
-this.iteratorRegistry=new m.AdapterRegistry();
-this.registerIteratorFactory("arrayLike",m.isArrayLike,this.arrayLikeIter);
-this.registerIteratorFactory("iterateNext",this.hasIterateNext,this.iterateNextIter);
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Iter.__new__();
-if(!MochiKit.__compat__){
-reduce=MochiKit.Iter.reduce;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Iter);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Logging");
-dojo.require("MochiKit.Base");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Logging depends on MochiKit.Base!";
-}
-if(typeof (MochiKit.Logging)=="undefined"){
-MochiKit.Logging={};
-}
-MochiKit.Logging.NAME="MochiKit.Logging";
-MochiKit.Logging.VERSION="1.3.1";
-MochiKit.Logging.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.Logging.toString=function(){
-return this.__repr__();
-};
-MochiKit.Logging.EXPORT=["LogLevel","LogMessage","Logger","alertListener","logger","log","logError","logDebug","logFatal","logWarning"];
-MochiKit.Logging.EXPORT_OK=["logLevelAtLeast","isLogMessage","compareLogMessage"];
-MochiKit.Logging.LogMessage=function(num,_192,info){
-this.num=num;
-this.level=_192;
-this.info=info;
-this.timestamp=new Date();
-};
-MochiKit.Logging.LogMessage.prototype={repr:function(){
-var m=MochiKit.Base;
-return "LogMessage("+m.map(m.repr,[this.num,this.level,this.info]).join(", ")+")";
-},toString:MochiKit.Base.forwardCall("repr")};
-MochiKit.Base.update(MochiKit.Logging,{logLevelAtLeast:function(_194){
-var self=MochiKit.Logging;
-if(typeof (_194)=="string"){
-_194=self.LogLevel[_194];
-}
-return function(msg){
-var _196=msg.level;
-if(typeof (_196)=="string"){
-_196=self.LogLevel[_196];
-}
-return _196>=_194;
-};
-},isLogMessage:function(){
-var _197=MochiKit.Logging.LogMessage;
-for(var i=0;i<arguments.length;i++){
-if(!(arguments[i] instanceof _197)){
-return false;
-}
-}
-return true;
-},compareLogMessage:function(a,b){
-return MochiKit.Base.compare([a.level,a.info],[b.level,b.info]);
-},alertListener:function(msg){
-alert("num: "+msg.num+"\nlevel: "+msg.level+"\ninfo: "+msg.info.join(" "));
-}});
-MochiKit.Logging.Logger=function(_198){
-this.counter=0;
-if(typeof (_198)=="undefined"||_198===null){
-_198=-1;
-}
-this.maxSize=_198;
-this._messages=[];
-this.listeners={};
-this.useNativeConsole=false;
-};
-MochiKit.Logging.Logger.prototype={clear:function(){
-this._messages.splice(0,this._messages.length);
-},logToConsole:function(msg){
-if(typeof (window)!="undefined"&&window.console&&window.console.log){
-window.console.log(msg);
-}else{
-if(typeof (opera)!="undefined"&&opera.postError){
-opera.postError(msg);
-}else{
-if(typeof (printfire)=="function"){
-printfire(msg);
-}
-}
-}
-},dispatchListeners:function(msg){
-for(var k in this.listeners){
-var pair=this.listeners[k];
-if(pair.ident!=k||(pair[0]&&!pair[0](msg))){
-continue;
-}
-pair[1](msg);
-}
-},addListener:function(_199,_200,_201){
-if(typeof (_200)=="string"){
-_200=MochiKit.Logging.logLevelAtLeast(_200);
-}
-var _202=[_200,_201];
-_202.ident=_199;
-this.listeners[_199]=_202;
-},removeListener:function(_203){
-delete this.listeners[_203];
-},baseLog:function(_204,_205){
-var msg=new MochiKit.Logging.LogMessage(this.counter,_204,MochiKit.Base.extend(null,arguments,1));
-this._messages.push(msg);
-this.dispatchListeners(msg);
-if(this.useNativeConsole){
-this.logToConsole(msg.level+": "+msg.info.join(" "));
-}
-this.counter+=1;
-while(this.maxSize>=0&&this._messages.length>this.maxSize){
-this._messages.shift();
-}
-},getMessages:function(_206){
-var _207=0;
-if(!(typeof (_206)=="undefined"||_206===null)){
-_207=Math.max(0,this._messages.length-_206);
-}
-return this._messages.slice(_207);
-},getMessageText:function(_208){
-if(typeof (_208)=="undefined"||_208===null){
-_208=30;
-}
-var _209=this.getMessages(_208);
-if(_209.length){
-var lst=map(function(m){
-return "\n  ["+m.num+"] "+m.level+": "+m.info.join(" ");
-},_209);
-lst.unshift("LAST "+_209.length+" MESSAGES:");
-return lst.join("");
-}
-return "";
-},debuggingBookmarklet:function(_210){
-if(typeof (MochiKit.LoggingPane)=="undefined"){
-alert(this.getMessageText());
-}else{
-MochiKit.LoggingPane.createLoggingPane(_210||false);
-}
-}};
-MochiKit.Logging.__new__=function(){
-this.LogLevel={ERROR:40,FATAL:50,WARNING:30,INFO:20,DEBUG:10};
-var m=MochiKit.Base;
-m.registerComparator("LogMessage",this.isLogMessage,this.compareLogMessage);
-var _211=m.partial;
-var _212=this.Logger;
-var _213=_212.prototype.baseLog;
-m.update(this.Logger.prototype,{debug:_211(_213,"DEBUG"),log:_211(_213,"INFO"),error:_211(_213,"ERROR"),fatal:_211(_213,"FATAL"),warning:_211(_213,"WARNING")});
-var self=this;
-var _214=function(name){
-return function(){
-self.logger[name].apply(self.logger,arguments);
-};
-};
-this.log=_214("log");
-this.logError=_214("error");
-this.logDebug=_214("debug");
-this.logFatal=_214("fatal");
-this.logWarning=_214("warning");
-this.logger=new _212();
-this.logger.useNativeConsole=true;
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-if(typeof (printfire)=="undefined"&&typeof (document)!="undefined"&&document.createEvent&&typeof (dispatchEvent)!="undefined"){
-printfire=function(){
-printfire.args=arguments;
-var ev=document.createEvent("Events");
-ev.initEvent("printfire",false,true);
-dispatchEvent(ev);
-};
-}
-MochiKit.Logging.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Logging);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.DateTime");
-}
-if(typeof (MochiKit)=="undefined"){
-MochiKit={};
-}
-if(typeof (MochiKit.DateTime)=="undefined"){
-MochiKit.DateTime={};
-}
-MochiKit.DateTime.NAME="MochiKit.DateTime";
-MochiKit.DateTime.VERSION="1.3.1";
-MochiKit.DateTime.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.DateTime.toString=function(){
-return this.__repr__();
-};
-MochiKit.DateTime.isoDate=function(str){
-str=str+"";
-if(typeof (str)!="string"||str.length===0){
-return null;
-}
-var iso=str.split("-");
-if(iso.length===0){
-return null;
-}
-return new Date(iso[0],iso[1]-1,iso[2]);
-};
-MochiKit.DateTime._isoRegexp=/(\d{4,})(?:-(\d{1,2})(?:-(\d{1,2})(?:[T ](\d{1,2}):(\d{1,2})(?::(\d{1,2})(?:\.(\d+))?)?(?:(Z)|([+-])(\d{1,2})(?::(\d{1,2}))?)?)?)?)?/;
-MochiKit.DateTime.isoTimestamp=function(str){
-str=str+"";
-if(typeof (str)!="string"||str.length===0){
-return null;
-}
-var res=str.match(MochiKit.DateTime._isoRegexp);
-if(typeof (res)=="undefined"||res===null){
-return null;
-}
-var year,month,day,hour,min,sec,msec;
-year=parseInt(res[1],10);
-if(typeof (res[2])=="undefined"||res[2]===""){
-return new Date(year);
-}
-month=parseInt(res[2],10)-1;
-day=parseInt(res[3],10);
-if(typeof (res[4])=="undefined"||res[4]===""){
-return new Date(year,month,day);
-}
-hour=parseInt(res[4],10);
-min=parseInt(res[5],10);
-sec=(typeof (res[6])!="undefined"&&res[6]!=="")?parseInt(res[6],10):0;
-if(typeof (res[7])!="undefined"&&res[7]!==""){
-msec=Math.round(1000*parseFloat("0."+res[7]));
-}else{
-msec=0;
-}
-if((typeof (res[8])=="undefined"||res[8]==="")&&(typeof (res[9])=="undefined"||res[9]==="")){
-return new Date(year,month,day,hour,min,sec,msec);
-}
-var ofs;
-if(typeof (res[9])!="undefined"&&res[9]!==""){
-ofs=parseInt(res[10],10)*3600000;
-if(typeof (res[11])!="undefined"&&res[11]!==""){
-ofs+=parseInt(res[11],10)*60000;
-}
-if(res[9]=="-"){
-ofs=-ofs;
-}
-}else{
-ofs=0;
-}
-return new Date(Date.UTC(year,month,day,hour,min,sec,msec)-ofs);
-};
-MochiKit.DateTime.toISOTime=function(date,_221){
-if(typeof (date)=="undefined"||date===null){
-return null;
-}
-var hh=date.getHours();
-var mm=date.getMinutes();
-var ss=date.getSeconds();
-var lst=[((_221&&(hh<10))?"0"+hh:hh),((mm<10)?"0"+mm:mm),((ss<10)?"0"+ss:ss)];
-return lst.join(":");
-};
-MochiKit.DateTime.toISOTimestamp=function(date,_225){
-if(typeof (date)=="undefined"||date===null){
-return null;
-}
-var sep=_225?"T":" ";
-var foot=_225?"Z":"";
-if(_225){
-date=new Date(date.getTime()+(date.getTimezoneOffset()*60000));
-}
-return MochiKit.DateTime.toISODate(date)+sep+MochiKit.DateTime.toISOTime(date,_225)+foot;
-};
-MochiKit.DateTime.toISODate=function(date){
-if(typeof (date)=="undefined"||date===null){
-return null;
-}
-var _228=MochiKit.DateTime._padTwo;
-return [date.getFullYear(),_228(date.getMonth()+1),_228(date.getDate())].join("-");
-};
-MochiKit.DateTime.americanDate=function(d){
-d=d+"";
-if(typeof (d)!="string"||d.length===0){
-return null;
-}
-var a=d.split("/");
-return new Date(a[2],a[0]-1,a[1]);
-};
-MochiKit.DateTime._padTwo=function(n){
-return (n>9)?n:"0"+n;
-};
-MochiKit.DateTime.toPaddedAmericanDate=function(d){
-if(typeof (d)=="undefined"||d===null){
-return null;
-}
-var _230=MochiKit.DateTime._padTwo;
-return [_230(d.getMonth()+1),_230(d.getDate()),d.getFullYear()].join("/");
-};
-MochiKit.DateTime.toAmericanDate=function(d){
-if(typeof (d)=="undefined"||d===null){
-return null;
-}
-return [d.getMonth()+1,d.getDate(),d.getFullYear()].join("/");
-};
-MochiKit.DateTime.EXPORT=["isoDate","isoTimestamp","toISOTime","toISOTimestamp","toISODate","americanDate","toPaddedAmericanDate","toAmericanDate"];
-MochiKit.DateTime.EXPORT_OK=[];
-MochiKit.DateTime.EXPORT_TAGS={":common":MochiKit.DateTime.EXPORT,":all":MochiKit.DateTime.EXPORT};
-MochiKit.DateTime.__new__=function(){
-var base=this.NAME+".";
-for(var k in this){
-var o=this[k];
-if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
-try{
-o.NAME=base+k;
-}
-catch(e){
-}
-}
-}
-};
-MochiKit.DateTime.__new__();
-if(typeof (MochiKit.Base)!="undefined"){
-MochiKit.Base._exportSymbols(this,MochiKit.DateTime);
-}else{
-(function(_231,_232){
-if((typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined")||(typeof (MochiKit.__compat__)=="boolean"&&MochiKit.__compat__)){
-var all=_232.EXPORT_TAGS[":all"];
-for(var i=0;i<all.length;i++){
-_231[all[i]]=_232[all[i]];
-}
-}
-})(this,MochiKit.DateTime);
-}
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Format");
-}
-if(typeof (MochiKit)=="undefined"){
-MochiKit={};
-}
-if(typeof (MochiKit.Format)=="undefined"){
-MochiKit.Format={};
-}
-MochiKit.Format.NAME="MochiKit.Format";
-MochiKit.Format.VERSION="1.3.1";
-MochiKit.Format.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.Format.toString=function(){
-return this.__repr__();
-};
-MochiKit.Format._numberFormatter=function(_233,_234,_235,_236,_237,_238,_239,_240,_241){
-return function(num){
-num=parseFloat(num);
-if(typeof (num)=="undefined"||num===null||isNaN(num)){
-return _233;
-}
-var _242=_234;
-var _243=_235;
-if(num<0){
-num=-num;
-}else{
-_242=_242.replace(/-/,"");
-}
-var me=arguments.callee;
-var fmt=MochiKit.Format.formatLocale(_236);
-if(_237){
-num=num*100;
-_243=fmt.percent+_243;
-}
-num=MochiKit.Format.roundToFixed(num,_238);
-var _245=num.split(/\./);
-var _246=_245[0];
-var frac=(_245.length==1)?"":_245[1];
-var res="";
-while(_246.length<_239){
-_246="0"+_246;
-}
-if(_240){
-while(_246.length>_240){
-var i=_246.length-_240;
-res=fmt.separator+_246.substring(i,_246.length)+res;
-_246=_246.substring(0,i);
-}
-}
-res=_246+res;
-if(_238>0){
-while(frac.length<_241){
-frac=frac+"0";
-}
-res=res+fmt.decimal+frac;
-}
-return _242+res+_243;
-};
-};
-MochiKit.Format.numberFormatter=function(_248,_249,_250){
-if(typeof (_249)=="undefined"){
-_249="";
-}
-var _251=_248.match(/((?:[0#]+,)?[0#]+)(?:\.([0#]+))?(%)?/);
-if(!_251){
-throw TypeError("Invalid pattern");
-}
-var _252=_248.substr(0,_251.index);
-var _253=_248.substr(_251.index+_251[0].length);
-if(_252.search(/-/)==-1){
-_252=_252+"-";
-}
-var _254=_251[1];
-var frac=(typeof (_251[2])=="string"&&_251[2]!="")?_251[2]:"";
-var _255=(typeof (_251[3])=="string"&&_251[3]!="");
-var tmp=_254.split(/,/);
-var _257;
-if(typeof (_250)=="undefined"){
-_250="default";
-}
-if(tmp.length==1){
-_257=null;
-}else{
-_257=tmp[1].length;
-}
-var _258=_254.length-_254.replace(/0/g,"").length;
-var _259=frac.length-frac.replace(/0/g,"").length;
-var _260=frac.length;
-var rval=MochiKit.Format._numberFormatter(_249,_252,_253,_250,_255,_260,_258,_257,_259);
-var m=MochiKit.Base;
-if(m){
-var fn=arguments.callee;
-var args=m.concat(arguments);
-rval.repr=function(){
-return [self.NAME,"(",map(m.repr,args).join(", "),")"].join("");
-};
-}
-return rval;
-};
-MochiKit.Format.formatLocale=function(_262){
-if(typeof (_262)=="undefined"||_262===null){
-_262="default";
-}
-if(typeof (_262)=="string"){
-var rval=MochiKit.Format.LOCALE[_262];
-if(typeof (rval)=="string"){
-rval=arguments.callee(rval);
-MochiKit.Format.LOCALE[_262]=rval;
-}
-return rval;
-}else{
-return _262;
-}
-};
-MochiKit.Format.twoDigitAverage=function(_263,_264){
-if(_264){
-var res=_263/_264;
-if(!isNaN(res)){
-return MochiKit.Format.twoDigitFloat(_263/_264);
-}
-}
-return "0";
-};
-MochiKit.Format.twoDigitFloat=function(_265){
-var sign=(_265<0?"-":"");
-var s=Math.floor(Math.abs(_265)*100).toString();
-if(s=="0"){
-return s;
-}
-if(s.length<3){
-while(s.charAt(s.length-1)=="0"){
-s=s.substring(0,s.length-1);
-}
-return sign+"0."+s;
-}
-var head=sign+s.substring(0,s.length-2);
-var tail=s.substring(s.length-2,s.length);
-if(tail=="00"){
-return head;
-}else{
-if(tail.charAt(1)=="0"){
-return head+"."+tail.charAt(0);
-}else{
-return head+"."+tail;
-}
-}
-};
-MochiKit.Format.lstrip=function(str,_270){
-str=str+"";
-if(typeof (str)!="string"){
-return null;
-}
-if(!_270){
-return str.replace(/^\s+/,"");
-}else{
-return str.replace(new RegExp("^["+_270+"]+"),"");
-}
-};
-MochiKit.Format.rstrip=function(str,_271){
-str=str+"";
-if(typeof (str)!="string"){
-return null;
-}
-if(!_271){
-return str.replace(/\s+$/,"");
-}else{
-return str.replace(new RegExp("["+_271+"]+$"),"");
-}
-};
-MochiKit.Format.strip=function(str,_272){
-var self=MochiKit.Format;
-return self.rstrip(self.lstrip(str,_272),_272);
-};
-MochiKit.Format.truncToFixed=function(_273,_274){
-_273=Math.floor(_273*Math.pow(10,_274));
-var res=(_273*Math.pow(10,-_274)).toFixed(_274);
-if(res.charAt(0)=="."){
-res="0"+res;
-}
-return res;
-};
-MochiKit.Format.roundToFixed=function(_275,_276){
-return MochiKit.Format.truncToFixed(_275+0.5*Math.pow(10,-_276),_276);
-};
-MochiKit.Format.percentFormat=function(_277){
-return MochiKit.Format.twoDigitFloat(100*_277)+"%";
-};
-MochiKit.Format.EXPORT=["truncToFixed","roundToFixed","numberFormatter","formatLocale","twoDigitAverage","twoDigitFloat","percentFormat","lstrip","rstrip","strip"];
-MochiKit.Format.LOCALE={en_US:{separator:",",decimal:".",percent:"%"},de_DE:{separator:".",decimal:",",percent:"%"},fr_FR:{separator:" ",decimal:",",percent:"%"},"default":"en_US"};
-MochiKit.Format.EXPORT_OK=[];
-MochiKit.Format.EXPORT_TAGS={":all":MochiKit.Format.EXPORT,":common":MochiKit.Format.EXPORT};
-MochiKit.Format.__new__=function(){
-var base=this.NAME+".";
-var k,v,o;
-for(k in this.LOCALE){
-o=this.LOCALE[k];
-if(typeof (o)=="object"){
-o.repr=function(){
-return this.NAME;
-};
-o.NAME=base+"LOCALE."+k;
-}
-}
-for(k in this){
-o=this[k];
-if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
-try{
-o.NAME=base+k;
-}
-catch(e){
-}
-}
-}
-};
-MochiKit.Format.__new__();
-if(typeof (MochiKit.Base)!="undefined"){
-MochiKit.Base._exportSymbols(this,MochiKit.Format);
-}else{
-(function(_278,_279){
-if((typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined")||(typeof (MochiKit.__compat__)=="boolean"&&MochiKit.__compat__)){
-var all=_279.EXPORT_TAGS[":all"];
-for(var i=0;i<all.length;i++){
-_278[all[i]]=_279[all[i]];
-}
-}
-})(this,MochiKit.Format);
-}
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Async");
-dojo.require("MochiKit.Base");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Async depends on MochiKit.Base!";
-}
-if(typeof (MochiKit.Async)=="undefined"){
-MochiKit.Async={};
-}
-MochiKit.Async.NAME="MochiKit.Async";
-MochiKit.Async.VERSION="1.3.1";
-MochiKit.Async.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.Async.toString=function(){
-return this.__repr__();
-};
-MochiKit.Async.Deferred=function(_280){
-this.chain=[];
-this.id=this._nextId();
-this.fired=-1;
-this.paused=0;
-this.results=[null,null];
-this.canceller=_280;
-this.silentlyCancelled=false;
-this.chained=false;
-};
-MochiKit.Async.Deferred.prototype={repr:function(){
-var _281;
-if(this.fired==-1){
-_281="unfired";
-}else{
-if(this.fired===0){
-_281="success";
-}else{
-_281="error";
-}
-}
-return "Deferred("+this.id+", "+_281+")";
-},toString:MochiKit.Base.forwardCall("repr"),_nextId:MochiKit.Base.counter(),cancel:function(){
-var self=MochiKit.Async;
-if(this.fired==-1){
-if(this.canceller){
-this.canceller(this);
-}else{
-this.silentlyCancelled=true;
-}
-if(this.fired==-1){
-this.errback(new self.CancelledError(this));
-}
-}else{
-if((this.fired===0)&&(this.results[0] instanceof self.Deferred)){
-this.results[0].cancel();
-}
-}
-},_pause:function(){
-this.paused++;
-},_unpause:function(){
-this.paused--;
-if((this.paused===0)&&(this.fired>=0)){
-this._fire();
-}
-},_continue:function(res){
-this._resback(res);
-this._unpause();
-},_resback:function(res){
-this.fired=((res instanceof Error)?1:0);
-this.results[this.fired]=res;
-this._fire();
-},_check:function(){
-if(this.fired!=-1){
-if(!this.silentlyCancelled){
-throw new MochiKit.Async.AlreadyCalledError(this);
-}
-this.silentlyCancelled=false;
-return;
-}
-},callback:function(res){
-this._check();
-if(res instanceof MochiKit.Async.Deferred){
-throw new Error("Deferred instances can only be chained if they are the result of a callback");
-}
-this._resback(res);
-},errback:function(res){
-this._check();
-var self=MochiKit.Async;
-if(res instanceof self.Deferred){
-throw new Error("Deferred instances can only be chained if they are the result of a callback");
-}
-if(!(res instanceof Error)){
-res=new self.GenericError(res);
-}
-this._resback(res);
-},addBoth:function(fn){
-if(arguments.length>1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(fn,fn);
-},addCallback:function(fn){
-if(arguments.length>1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(fn,null);
-},addErrback:function(fn){
-if(arguments.length>1){
-fn=MochiKit.Base.partial.apply(null,arguments);
-}
-return this.addCallbacks(null,fn);
-},addCallbacks:function(cb,eb){
-if(this.chained){
-throw new Error("Chained Deferreds can not be re-used");
-}
-this.chain.push([cb,eb]);
-if(this.fired>=0){
-this._fire();
-}
-return this;
-},_fire:function(){
-var _284=this.chain;
-var _285=this.fired;
-var res=this.results[_285];
-var self=this;
-var cb=null;
-while(_284.length>0&&this.paused===0){
-var pair=_284.shift();
-var f=pair[_285];
-if(f===null){
-continue;
-}
-try{
-res=f(res);
-_285=((res instanceof Error)?1:0);
-if(res instanceof MochiKit.Async.Deferred){
-cb=function(res){
-self._continue(res);
-};
-this._pause();
-}
-}
-catch(err){
-_285=1;
-if(!(err instanceof Error)){
-err=new MochiKit.Async.GenericError(err);
-}
-res=err;
-}
-}
-this.fired=_285;
-this.results[_285]=res;
-if(cb&&this.paused){
-res.addBoth(cb);
-res.chained=true;
-}
-}};
-MochiKit.Base.update(MochiKit.Async,{evalJSONRequest:function(){
-return eval("("+arguments[0].responseText+")");
-},succeed:function(_287){
-var d=new MochiKit.Async.Deferred();
-d.callback.apply(d,arguments);
-return d;
-},fail:function(_288){
-var d=new MochiKit.Async.Deferred();
-d.errback.apply(d,arguments);
-return d;
-},getXMLHttpRequest:function(){
-var self=arguments.callee;
-if(!self.XMLHttpRequest){
-var _289=[function(){
-return new XMLHttpRequest();
-},function(){
-return new ActiveXObject("Msxml2.XMLHTTP");
-},function(){
-return new ActiveXObject("Microsoft.XMLHTTP");
-},function(){
-return new ActiveXObject("Msxml2.XMLHTTP.4.0");
-},function(){
-throw new MochiKit.Async.BrowserComplianceError("Browser does not support XMLHttpRequest");
-}];
-for(var i=0;i<_289.length;i++){
-var func=_289[i];
-try{
-self.XMLHttpRequest=func;
-return func();
-}
-catch(e){
-}
-}
-}
-return self.XMLHttpRequest();
-},_nothing:function(){
-},_xhr_onreadystatechange:function(d){
-if(this.readyState==4){
-try{
-this.onreadystatechange=null;
-}
-catch(e){
-try{
-this.onreadystatechange=MochiKit.Async._nothing;
-}
-catch(e){
-}
-}
-var _290=null;
-try{
-_290=this.status;
-if(!_290&&MochiKit.Base.isNotEmpty(this.responseText)){
-_290=304;
-}
-}
-catch(e){
-}
-if(_290==200||_290==304){
-d.callback(this);
-}else{
-var err=new MochiKit.Async.XMLHttpRequestError(this,"Request failed");
-if(err.number){
-d.errback(err);
-}else{
-d.errback(err);
-}
-}
-}
-},_xhr_canceller:function(req){
-try{
-req.onreadystatechange=null;
-}
-catch(e){
-try{
-req.onreadystatechange=MochiKit.Async._nothing;
-}
-catch(e){
-}
-}
-req.abort();
-},sendXMLHttpRequest:function(req,_293){
-if(typeof (_293)=="undefined"||_293===null){
-_293="";
-}
-var m=MochiKit.Base;
-var self=MochiKit.Async;
-var d=new self.Deferred(m.partial(self._xhr_canceller,req));
-try{
-req.onreadystatechange=m.bind(self._xhr_onreadystatechange,req,d);
-req.send(_293);
-}
-catch(e){
-try{
-req.onreadystatechange=null;
-}
-catch(ignore){
-}
-d.errback(e);
-}
-return d;
-},doSimpleXMLHttpRequest:function(url){
-var self=MochiKit.Async;
-var req=self.getXMLHttpRequest();
-if(arguments.length>1){
-var m=MochiKit.Base;
-var qs=m.queryString.apply(null,m.extend(null,arguments,1));
-if(qs){
-url+="?"+qs;
-}
-}
-req.open("GET",url,true);
-return self.sendXMLHttpRequest(req);
-},loadJSONDoc:function(url){
-var self=MochiKit.Async;
-var d=self.doSimpleXMLHttpRequest.apply(self,arguments);
-d=d.addCallback(self.evalJSONRequest);
-return d;
-},wait:function(_296,_297){
-var d=new MochiKit.Async.Deferred();
-var m=MochiKit.Base;
-if(typeof (_297)!="undefined"){
-d.addCallback(function(){
-return _297;
-});
-}
-var _298=setTimeout(m.bind("callback",d),Math.floor(_296*1000));
-d.canceller=function(){
-try{
-clearTimeout(_298);
-}
-catch(e){
-}
-};
-return d;
-},callLater:function(_299,func){
-var m=MochiKit.Base;
-var _300=m.partial.apply(m,m.extend(null,arguments,1));
-return MochiKit.Async.wait(_299).addCallback(function(res){
-return _300();
-});
-}});
-MochiKit.Async.DeferredLock=function(){
-this.waiting=[];
-this.locked=false;
-this.id=this._nextId();
-};
-MochiKit.Async.DeferredLock.prototype={__class__:MochiKit.Async.DeferredLock,acquire:function(){
-d=new MochiKit.Async.Deferred();
-if(this.locked){
-this.waiting.push(d);
-}else{
-this.locked=true;
-d.callback(this);
-}
-return d;
-},release:function(){
-if(!this.locked){
-throw TypeError("Tried to release an unlocked DeferredLock");
-}
-this.locked=false;
-if(this.waiting.length>0){
-this.locked=true;
-this.waiting.shift().callback(this);
-}
-},_nextId:MochiKit.Base.counter(),repr:function(){
-var _301;
-if(this.locked){
-_301="locked, "+this.waiting.length+" waiting";
-}else{
-_301="unlocked";
-}
-return "DeferredLock("+this.id+", "+_301+")";
-},toString:MochiKit.Base.forwardCall("repr")};
-MochiKit.Async.DeferredList=function(list,_303,_304,_305,_306){
-this.list=list;
-this.resultList=new Array(this.list.length);
-this.chain=[];
-this.id=this._nextId();
-this.fired=-1;
-this.paused=0;
-this.results=[null,null];
-this.canceller=_306;
-this.silentlyCancelled=false;
-if(this.list.length===0&&!_303){
-this.callback(this.resultList);
-}
-this.finishedCount=0;
-this.fireOnOneCallback=_303;
-this.fireOnOneErrback=_304;
-this.consumeErrors=_305;
-var _307=0;
-MochiKit.Base.map(MochiKit.Base.bind(function(d){
-d.addCallback(MochiKit.Base.bind(this._cbDeferred,this),_307,true);
-d.addErrback(MochiKit.Base.bind(this._cbDeferred,this),_307,false);
-_307+=1;
-},this),this.list);
-};
-MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,MochiKit.Async.Deferred.prototype);
-MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,{_cbDeferred:function(_308,_309,_310){
-this.resultList[_308]=[_309,_310];
-this.finishedCount+=1;
-if(this.fired!==0){
-if(_309&&this.fireOnOneCallback){
-this.callback([_308,_310]);
-}else{
-if(!_309&&this.fireOnOneErrback){
-this.errback(_310);
-}else{
-if(this.finishedCount==this.list.length){
-this.callback(this.resultList);
-}
-}
-}
-}
-if(!_309&&this.consumeErrors){
-_310=null;
-}
-return _310;
-}});
-MochiKit.Async.gatherResults=function(_311){
-var d=new MochiKit.Async.DeferredList(_311,false,true,false);
-d.addCallback(function(_312){
-var ret=[];
-for(var i=0;i<_312.length;i++){
-ret.push(_312[i][1]);
-}
-return ret;
-});
-return d;
-};
-MochiKit.Async.maybeDeferred=function(func){
-var self=MochiKit.Async;
-var _313;
-try{
-var r=func.apply(null,MochiKit.Base.extend([],arguments,1));
-if(r instanceof self.Deferred){
-_313=r;
-}else{
-if(r instanceof Error){
-_313=self.fail(r);
-}else{
-_313=self.succeed(r);
-}
-}
-}
-catch(e){
-_313=self.fail(e);
-}
-return _313;
-};
-MochiKit.Async.EXPORT=["AlreadyCalledError","CancelledError","BrowserComplianceError","GenericError","XMLHttpRequestError","Deferred","succeed","fail","getXMLHttpRequest","doSimpleXMLHttpRequest","loadJSONDoc","wait","callLater","sendXMLHttpRequest","DeferredLock","DeferredList","gatherResults","maybeDeferred"];
-MochiKit.Async.EXPORT_OK=["evalJSONRequest"];
-MochiKit.Async.__new__=function(){
-var m=MochiKit.Base;
-var ne=m.partial(m._newNamedError,this);
-ne("AlreadyCalledError",function(_316){
-this.deferred=_316;
-});
-ne("CancelledError",function(_317){
-this.deferred=_317;
-});
-ne("BrowserComplianceError",function(msg){
-this.message=msg;
-});
-ne("GenericError",function(msg){
-this.message=msg;
-});
-ne("XMLHttpRequestError",function(req,msg){
-this.req=req;
-this.message=msg;
-try{
-this.number=req.status;
-}
-catch(e){
-}
-});
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Async.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Async);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.DOM");
-dojo.require("MochiKit.Iter");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Iter",[]);
-}
-try{
-if(typeof (MochiKit.Iter)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.DOM depends on MochiKit.Iter!";
-}
-if(typeof (MochiKit.DOM)=="undefined"){
-MochiKit.DOM={};
-}
-MochiKit.DOM.NAME="MochiKit.DOM";
-MochiKit.DOM.VERSION="1.3.1";
-MochiKit.DOM.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.DOM.toString=function(){
-return this.__repr__();
-};
-MochiKit.DOM.EXPORT=["formContents","currentWindow","currentDocument","withWindow","withDocument","registerDOMConverter","coerceToDOM","createDOM","createDOMFunc","getNodeAttribute","setNodeAttribute","updateNodeAttributes","appendChildNodes","replaceChildNodes","removeElement","swapDOM","BUTTON","TT","PRE","H1","H2","H3","BR","CANVAS","HR","LABEL","TEXTAREA","FORM","STRONG","SELECT","OPTION","OPTGROUP","LEGEND","FIELDSET","P","UL","OL","LI","TD","TR","THEAD","TBODY","TFOOT","TABLE","TH","INPUT","SPAN","A","DIV","IMG","getElement","$","computedStyle","getElementsByTagAndClassName","addToCallStack","addLoadEvent","focusOnLoad","setElementClass","toggleElementClass","addElementClass","removeElementClass","swapElementClass","hasElementClass","escapeHTML","toHTML","emitHTML","setDisplayForElement","hideElement","showElement","scrapeText","elementDimensions","elementPosition","setElementDimensions","setElementPosition","getViewportDimensions","setOpacity"];
-MochiKit.DOM.EXPORT_OK=["domConverters"];
-MochiKit.DOM.Dimensions=function(w,h){
-this.w=w;
-this.h=h;
-};
-MochiKit.DOM.Dimensions.prototype.repr=function(){
-var repr=MochiKit.Base.repr;
-return "{w: "+repr(this.w)+", h: "+repr(this.h)+"}";
-};
-MochiKit.DOM.Coordinates=function(x,y){
-this.x=x;
-this.y=y;
-};
-MochiKit.DOM.Coordinates.prototype.repr=function(){
-var repr=MochiKit.Base.repr;
-return "{x: "+repr(this.x)+", y: "+repr(this.y)+"}";
-};
-MochiKit.DOM.Coordinates.prototype.toString=function(){
-return this.repr();
-};
-MochiKit.Base.update(MochiKit.DOM,{setOpacity:function(elem,o){
-elem=MochiKit.DOM.getElement(elem);
-MochiKit.DOM.updateNodeAttributes(elem,{"style":{"opacity":o,"-moz-opacity":o,"-khtml-opacity":o,"filter":" alpha(opacity="+(o*100)+")"}});
-},getViewportDimensions:function(){
-var d=new MochiKit.DOM.Dimensions();
-var w=MochiKit.DOM._window;
-var b=MochiKit.DOM._document.body;
-if(w.innerWidth){
-d.w=w.innerWidth;
-d.h=w.innerHeight;
-}else{
-if(b.parentElement.clientWidth){
-d.w=b.parentElement.clientWidth;
-d.h=b.parentElement.clientHeight;
-}else{
-if(b&&b.clientWidth){
-d.w=b.clientWidth;
-d.h=b.clientHeight;
-}
-}
-}
-return d;
-},elementDimensions:function(elem){
-var self=MochiKit.DOM;
-if(typeof (elem.w)=="number"||typeof (elem.h)=="number"){
-return new self.Dimensions(elem.w||0,elem.h||0);
-}
-elem=self.getElement(elem);
-if(!elem){
-return undefined;
-}
-if(self.computedStyle(elem,"display")!="none"){
-return new self.Dimensions(elem.offsetWidth||0,elem.offsetHeight||0);
-}
-var s=elem.style;
-var _322=s.visibility;
-var _323=s.position;
-s.visibility="hidden";
-s.position="absolute";
-s.display="";
-var _324=elem.offsetWidth;
-var _325=elem.offsetHeight;
-s.display="none";
-s.position=_323;
-s.visibility=_322;
-return new self.Dimensions(_324,_325);
-},elementPosition:function(elem,_326){
-var self=MochiKit.DOM;
-elem=self.getElement(elem);
-if(!elem){
-return undefined;
-}
-var c=new self.Coordinates(0,0);
-if(elem.x&&elem.y){
-c.x+=elem.x||0;
-c.y+=elem.y||0;
-return c;
-}else{
-if(elem.parentNode===null||self.computedStyle(elem,"display")=="none"){
-return undefined;
-}
-}
-var box=null;
-var _329=null;
-var d=MochiKit.DOM._document;
-var de=d.documentElement;
-var b=d.body;
-if(elem.getBoundingClientRect){
-box=elem.getBoundingClientRect();
-c.x+=box.left+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
-c.y+=box.top+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
-}else{
-if(d.getBoxObjectFor){
-box=d.getBoxObjectFor(elem);
-c.x+=box.x;
-c.y+=box.y;
-}else{
-if(elem.offsetParent){
-c.x+=elem.offsetLeft;
-c.y+=elem.offsetTop;
-_329=elem.offsetParent;
-if(_329!=elem){
-while(_329){
-c.x+=_329.offsetLeft;
-c.y+=_329.offsetTop;
-_329=_329.offsetParent;
-}
-}
-var ua=navigator.userAgent.toLowerCase();
-if((typeof (opera)!="undefined"&&parseFloat(opera.version())<9)||(ua.indexOf("safari")!=-1&&self.computedStyle(elem,"position")=="absolute")){
-c.x-=b.offsetLeft;
-c.y-=b.offsetTop;
-}
-}
-}
-}
-if(typeof (_326)!="undefined"){
-_326=arguments.callee(_326);
-if(_326){
-c.x-=(_326.x||0);
-c.y-=(_326.y||0);
-}
-}
-if(elem.parentNode){
-_329=elem.parentNode;
-}else{
-_329=null;
-}
-while(_329&&_329.tagName!="BODY"&&_329.tagName!="HTML"){
-c.x-=_329.scrollLeft;
-c.y-=_329.scrollTop;
-if(_329.parentNode){
-_329=_329.parentNode;
-}else{
-_329=null;
-}
-}
-return c;
-},setElementDimensions:function(elem,_332,_333){
-elem=MochiKit.DOM.getElement(elem);
-if(typeof (_333)=="undefined"){
-_333="px";
-}
-MochiKit.DOM.updateNodeAttributes(elem,{"style":{"width":_332.w+_333,"height":_332.h+_333}});
-},setElementPosition:function(elem,_334,_335){
-elem=MochiKit.DOM.getElement(elem);
-if(typeof (_335)=="undefined"){
-_335="px";
-}
-MochiKit.DOM.updateNodeAttributes(elem,{"style":{"left":_334.x+_335,"top":_334.y+_335}});
-},currentWindow:function(){
-return MochiKit.DOM._window;
-},currentDocument:function(){
-return MochiKit.DOM._document;
-},withWindow:function(win,func){
-var self=MochiKit.DOM;
-var _337=self._document;
-var _338=self._win;
-var rval;
-try{
-self._window=win;
-self._document=win.document;
-rval=func();
-}
-catch(e){
-self._window=_338;
-self._document=_337;
-throw e;
-}
-self._window=_338;
-self._document=_337;
-return rval;
-},formContents:function(elem){
-var _339=[];
-var _340=[];
-var m=MochiKit.Base;
-var self=MochiKit.DOM;
-if(typeof (elem)=="undefined"||elem===null){
-elem=self._document;
-}else{
-elem=self.getElement(elem);
-}
-m.nodeWalk(elem,function(elem){
-var name=elem.name;
-if(m.isNotEmpty(name)){
-var _341=elem.nodeName;
-if(_341=="INPUT"&&(elem.type=="radio"||elem.type=="checkbox")&&!elem.checked){
-return null;
-}
-if(_341=="SELECT"){
-if(elem.selectedIndex>=0){
-var opt=elem.options[elem.selectedIndex];
-_339.push(name);
-_340.push((opt.value)?opt.value:opt.text);
-return null;
-}
-_339.push(name);
-_340.push("");
-return null;
-}
-if(_341=="FORM"||_341=="P"||_341=="SPAN"||_341=="DIV"){
-return elem.childNodes;
-}
-_339.push(name);
-_340.push(elem.value||"");
-return null;
-}
-return elem.childNodes;
-});
-return [_339,_340];
-},withDocument:function(doc,func){
-var self=MochiKit.DOM;
-var _344=self._document;
-var rval;
-try{
-self._document=doc;
-rval=func();
-}
-catch(e){
-self._document=_344;
-throw e;
-}
-self._document=_344;
-return rval;
-},registerDOMConverter:function(name,_345,wrap,_346){
-MochiKit.DOM.domConverters.register(name,_345,wrap,_346);
-},coerceToDOM:function(node,ctx){
-var im=MochiKit.Iter;
-var self=MochiKit.DOM;
-var iter=im.iter;
-var _350=im.repeat;
-var imap=im.imap;
-var _352=self.domConverters;
-var _353=self.coerceToDOM;
-var _354=MochiKit.Base.NotFound;
-while(true){
-if(typeof (node)=="undefined"||node===null){
-return null;
-}
-if(typeof (node.nodeType)!="undefined"&&node.nodeType>0){
-return node;
-}
-if(typeof (node)=="number"||typeof (node)=="bool"){
-node=node.toString();
-}
-if(typeof (node)=="string"){
-return self._document.createTextNode(node);
-}
-if(typeof (node.toDOM)=="function"){
-node=node.toDOM(ctx);
-continue;
-}
-if(typeof (node)=="function"){
-node=node(ctx);
-continue;
-}
-var _355=null;
-try{
-_355=iter(node);
-}
-catch(e){
-}
-if(_355){
-return imap(_353,_355,_350(ctx));
-}
-try{
-node=_352.match(node,ctx);
-continue;
-}
-catch(e){
-if(e!=_354){
-throw e;
-}
-}
-return self._document.createTextNode(node.toString());
-}
-return undefined;
-},setNodeAttribute:function(node,attr,_357){
-var o={};
-o[attr]=_357;
-try{
-return MochiKit.DOM.updateNodeAttributes(node,o);
-}
-catch(e){
-}
-return null;
-},getNodeAttribute:function(node,attr){
-var self=MochiKit.DOM;
-var _358=self.attributeArray.renames[attr];
-node=self.getElement(node);
-try{
-if(_358){
-return node[_358];
-}
-return node.getAttribute(attr);
-}
-catch(e){
-}
-return null;
-},updateNodeAttributes:function(node,_359){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)=="string"){
-elem=self.getElement(node);
-}
-if(_359){
-var _360=MochiKit.Base.updatetree;
-if(self.attributeArray.compliant){
-for(var k in _359){
-var v=_359[k];
-if(typeof (v)=="object"&&typeof (elem[k])=="object"){
-_360(elem[k],v);
-}else{
-if(k.substring(0,2)=="on"){
-if(typeof (v)=="string"){
-v=new Function(v);
-}
-elem[k]=v;
-}else{
-elem.setAttribute(k,v);
-}
-}
-}
-}else{
-var _361=self.attributeArray.renames;
-for(k in _359){
-v=_359[k];
-var _362=_361[k];
-if(k=="style"&&typeof (v)=="string"){
-elem.style.cssText=v;
-}else{
-if(typeof (_362)=="string"){
-elem[_362]=v;
-}else{
-if(typeof (elem[k])=="object"&&typeof (v)=="object"){
-_360(elem[k],v);
-}else{
-if(k.substring(0,2)=="on"){
-if(typeof (v)=="string"){
-v=new Function(v);
-}
-elem[k]=v;
-}else{
-elem.setAttribute(k,v);
-}
-}
-}
-}
-}
-}
-}
-return elem;
-},appendChildNodes:function(node){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)=="string"){
-elem=self.getElement(node);
-}
-var _363=[self.coerceToDOM(MochiKit.Base.extend(null,arguments,1),elem)];
-var _364=MochiKit.Base.concat;
-while(_363.length){
-var n=_363.shift();
-if(typeof (n)=="undefined"||n===null){
-}else{
-if(typeof (n.nodeType)=="number"){
-elem.appendChild(n);
-}else{
-_363=_364(n,_363);
-}
-}
-}
-return elem;
-},replaceChildNodes:function(node){
-var elem=node;
-var self=MochiKit.DOM;
-if(typeof (node)=="string"){
-elem=self.getElement(node);
-arguments[0]=elem;
-}
-var _365;
-while((_365=elem.firstChild)){
-elem.removeChild(_365);
-}
-if(arguments.length<2){
-return elem;
-}else{
-return self.appendChildNodes.apply(this,arguments);
-}
-},createDOM:function(name,_366){
-var elem;
-var self=MochiKit.DOM;
-var m=MochiKit.Base;
-if(typeof (_366)=="string"||typeof (_366)=="number"){
-var args=m.extend([name,null],arguments,1);
-return arguments.callee.apply(this,args);
-}
-if(typeof (name)=="string"){
-if(_366&&"name" in _366&&!self.attributeArray.compliant){
-name=("<"+name+" name=\""+self.escapeHTML(_366.name)+"\">");
-}
-elem=self._document.createElement(name);
-}else{
-elem=name;
-}
-if(_366){
-self.updateNodeAttributes(elem,_366);
-}
-if(arguments.length<=2){
-return elem;
-}else{
-var args=m.extend([elem],arguments,2);
-return self.appendChildNodes.apply(this,args);
-}
-},createDOMFunc:function(){
-var m=MochiKit.Base;
-return m.partial.apply(this,m.extend([MochiKit.DOM.createDOM],arguments));
-},swapDOM:function(dest,src){
-var self=MochiKit.DOM;
-dest=self.getElement(dest);
-var _369=dest.parentNode;
-if(src){
-src=self.getElement(src);
-_369.replaceChild(src,dest);
-}else{
-_369.removeChild(dest);
-}
-return src;
-},getElement:function(id){
-var self=MochiKit.DOM;
-if(arguments.length==1){
-return ((typeof (id)=="string")?self._document.getElementById(id):id);
-}else{
-return MochiKit.Base.map(self.getElement,arguments);
-}
-},computedStyle:function(_371,_372,_373){
-if(arguments.length==2){
-_373=_372;
-}
-var self=MochiKit.DOM;
-var el=self.getElement(_371);
-var _375=self._document;
-if(!el||el==_375){
-return undefined;
-}
-if(el.currentStyle){
-return el.currentStyle[_372];
-}
-if(typeof (_375.defaultView)=="undefined"){
-return undefined;
-}
-if(_375.defaultView===null){
-return undefined;
-}
-var _376=_375.defaultView.getComputedStyle(el,null);
-if(typeof (_376)=="undefined"||_376===null){
-return undefined;
-}
-return _376.getPropertyValue(_373);
-},getElementsByTagAndClassName:function(_377,_378,_379){
-var self=MochiKit.DOM;
-if(typeof (_377)=="undefined"||_377===null){
-_377="*";
-}
-if(typeof (_379)=="undefined"||_379===null){
-_379=self._document;
-}
-_379=self.getElement(_379);
-var _380=(_379.getElementsByTagName(_377)||self._document.all);
-if(typeof (_378)=="undefined"||_378===null){
-return MochiKit.Base.extend(null,_380);
-}
-var _381=[];
-for(var i=0;i<_380.length;i++){
-var _382=_380[i];
-var _383=_382.className.split(" ");
-for(var j=0;j<_383.length;j++){
-if(_383[j]==_378){
-_381.push(_382);
-break;
-}
-}
-}
-return _381;
-},_newCallStack:function(path,once){
-var rval=function(){
-var _386=arguments.callee.callStack;
-for(var i=0;i<_386.length;i++){
-if(_386[i].apply(this,arguments)===false){
-break;
-}
-}
-if(once){
-try{
-this[path]=null;
-}
-catch(e){
-}
-}
-};
-rval.callStack=[];
-return rval;
-},addToCallStack:function(_387,path,func,once){
-var self=MochiKit.DOM;
-var _388=_387[path];
-var _389=_388;
-if(!(typeof (_388)=="function"&&typeof (_388.callStack)=="object"&&_388.callStack!==null)){
-_389=self._newCallStack(path,once);
-if(typeof (_388)=="function"){
-_389.callStack.push(_388);
-}
-_387[path]=_389;
-}
-_389.callStack.push(func);
-},addLoadEvent:function(func){
-var self=MochiKit.DOM;
-self.addToCallStack(self._window,"onload",func,true);
-},focusOnLoad:function(_390){
-var self=MochiKit.DOM;
-self.addLoadEvent(function(){
-_390=self.getElement(_390);
-if(_390){
-_390.focus();
-}
-});
-},setElementClass:function(_391,_392){
-var self=MochiKit.DOM;
-var obj=self.getElement(_391);
-if(self.attributeArray.compliant){
-obj.setAttribute("class",_392);
-}else{
-obj.setAttribute("className",_392);
-}
-},toggleElementClass:function(_393){
-var self=MochiKit.DOM;
-for(var i=1;i<arguments.length;i++){
-var obj=self.getElement(arguments[i]);
-if(!self.addElementClass(obj,_393)){
-self.removeElementClass(obj,_393);
-}
-}
-},addElementClass:function(_394,_395){
-var self=MochiKit.DOM;
-var obj=self.getElement(_394);
-var cls=obj.className;
-if(cls.length===0){
-self.setElementClass(obj,_395);
-return true;
-}
-if(cls==_395){
-return false;
-}
-var _397=obj.className.split(" ");
-for(var i=0;i<_397.length;i++){
-if(_397[i]==_395){
-return false;
-}
-}
-self.setElementClass(obj,cls+" "+_395);
-return true;
-},removeElementClass:function(_398,_399){
-var self=MochiKit.DOM;
-var obj=self.getElement(_398);
-var cls=obj.className;
-if(cls.length===0){
-return false;
-}
-if(cls==_399){
-self.setElementClass(obj,"");
-return true;
-}
-var _400=obj.className.split(" ");
-for(var i=0;i<_400.length;i++){
-if(_400[i]==_399){
-_400.splice(i,1);
-self.setElementClass(obj,_400.join(" "));
-return true;
-}
-}
-return false;
-},swapElementClass:function(_401,_402,_403){
-var obj=MochiKit.DOM.getElement(_401);
-var res=MochiKit.DOM.removeElementClass(obj,_402);
-if(res){
-MochiKit.DOM.addElementClass(obj,_403);
-}
-return res;
-},hasElementClass:function(_404,_405){
-var obj=MochiKit.DOM.getElement(_404);
-var _406=obj.className.split(" ");
-for(var i=1;i<arguments.length;i++){
-var good=false;
-for(var j=0;j<_406.length;j++){
-if(_406[j]==arguments[i]){
-good=true;
-break;
-}
-}
-if(!good){
-return false;
-}
-}
-return true;
-},escapeHTML:function(s){
-return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
-},toHTML:function(dom){
-return MochiKit.DOM.emitHTML(dom).join("");
-},emitHTML:function(dom,lst){
-if(typeof (lst)=="undefined"||lst===null){
-lst=[];
-}
-var _409=[dom];
-var self=MochiKit.DOM;
-var _410=self.escapeHTML;
-var _411=self.attributeArray;
-while(_409.length){
-dom=_409.pop();
-if(typeof (dom)=="string"){
-lst.push(dom);
-}else{
-if(dom.nodeType==1){
-lst.push("<"+dom.nodeName.toLowerCase());
-var _412=[];
-var _413=_411(dom);
-for(var i=0;i<_413.length;i++){
-var a=_413[i];
-_412.push([" ",a.name,"=\"",_410(a.value),"\""]);
-}
-_412.sort();
-for(i=0;i<_412.length;i++){
-var _414=_412[i];
-for(var j=0;j<_414.length;j++){
-lst.push(_414[j]);
-}
-}
-if(dom.hasChildNodes()){
-lst.push(">");
-_409.push("</"+dom.nodeName.toLowerCase()+">");
-var _415=dom.childNodes;
-for(i=_415.length-1;i>=0;i--){
-_409.push(_415[i]);
-}
-}else{
-lst.push("/>");
-}
-}else{
-if(dom.nodeType==3){
-lst.push(_410(dom.nodeValue));
-}
-}
-}
-}
-return lst;
-},setDisplayForElement:function(_416,_417){
-var m=MochiKit.Base;
-var _418=m.extend(null,arguments,1);
-MochiKit.Iter.forEach(m.filter(null,m.map(MochiKit.DOM.getElement,_418)),function(_417){
-_417.style.display=_416;
-});
-},scrapeText:function(node,_419){
-var rval=[];
-(function(node){
-var cn=node.childNodes;
-if(cn){
-for(var i=0;i<cn.length;i++){
-arguments.callee.call(this,cn[i]);
-}
-}
-var _421=node.nodeValue;
-if(typeof (_421)=="string"){
-rval.push(_421);
-}
-})(MochiKit.DOM.getElement(node));
-if(_419){
-return rval;
-}else{
-return rval.join("");
-}
-},__new__:function(win){
-var m=MochiKit.Base;
-this._document=document;
-this._window=win;
-this.domConverters=new m.AdapterRegistry();
-var _422=this._document.createElement("span");
-var _423;
-if(_422&&_422.attributes&&_422.attributes.length>0){
-var _424=m.filter;
-_423=function(node){
-return _424(_423.ignoreAttrFilter,node.attributes);
-};
-_423.ignoreAttr={};
-MochiKit.Iter.forEach(_422.attributes,function(a){
-_423.ignoreAttr[a.name]=a.value;
-});
-_423.ignoreAttrFilter=function(a){
-return (_423.ignoreAttr[a.name]!=a.value);
-};
-_423.compliant=false;
-_423.renames={"class":"className","checked":"defaultChecked","usemap":"useMap","for":"htmlFor"};
-}else{
-_423=function(node){
-return node.attributes;
-};
-_423.compliant=true;
-_423.renames={};
-}
-this.attributeArray=_423;
-var _425=this.createDOMFunc;
-this.UL=_425("ul");
-this.OL=_425("ol");
-this.LI=_425("li");
-this.TD=_425("td");
-this.TR=_425("tr");
-this.TBODY=_425("tbody");
-this.THEAD=_425("thead");
-this.TFOOT=_425("tfoot");
-this.TABLE=_425("table");
-this.TH=_425("th");
-this.INPUT=_425("input");
-this.SPAN=_425("span");
-this.A=_425("a");
-this.DIV=_425("div");
-this.IMG=_425("img");
-this.BUTTON=_425("button");
-this.TT=_425("tt");
-this.PRE=_425("pre");
-this.H1=_425("h1");
-this.H2=_425("h2");
-this.H3=_425("h3");
-this.BR=_425("br");
-this.HR=_425("hr");
-this.LABEL=_425("label");
-this.TEXTAREA=_425("textarea");
-this.FORM=_425("form");
-this.P=_425("p");
-this.SELECT=_425("select");
-this.OPTION=_425("option");
-this.OPTGROUP=_425("optgroup");
-this.LEGEND=_425("legend");
-this.FIELDSET=_425("fieldset");
-this.STRONG=_425("strong");
-this.CANVAS=_425("canvas");
-this.hideElement=m.partial(this.setDisplayForElement,"none");
-this.showElement=m.partial(this.setDisplayForElement,"block");
-this.removeElement=this.swapDOM;
-this.$=this.getElement;
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-}});
-MochiKit.DOM.__new__(((typeof (window)=="undefined")?this:window));
-if(!MochiKit.__compat__){
-withWindow=MochiKit.DOM.withWindow;
-withDocument=MochiKit.DOM.withDocument;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.DOM);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.LoggingPane");
-dojo.require("MochiKit.Logging");
-dojo.require("MochiKit.Base");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Logging",[]);
-JSAN.use("MochiKit.Base",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"||typeof (MochiKit.Logging)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.LoggingPane depends on MochiKit.Base and MochiKit.Logging!";
-}
-if(typeof (MochiKit.LoggingPane)=="undefined"){
-MochiKit.LoggingPane={};
-}
-MochiKit.LoggingPane.NAME="MochiKit.LoggingPane";
-MochiKit.LoggingPane.VERSION="1.3.1";
-MochiKit.LoggingPane.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.LoggingPane.toString=function(){
-return this.__repr__();
-};
-MochiKit.LoggingPane.createLoggingPane=function(_426){
-var m=MochiKit.LoggingPane;
-_426=!(!_426);
-if(m._loggingPane&&m._loggingPane.inline!=_426){
-m._loggingPane.closePane();
-m._loggingPane=null;
-}
-if(!m._loggingPane||m._loggingPane.closed){
-m._loggingPane=new m.LoggingPane(_426,MochiKit.Logging.logger);
-}
-return m._loggingPane;
-};
-MochiKit.LoggingPane.LoggingPane=function(_427,_428){
-if(typeof (_428)=="undefined"||_428===null){
-_428=MochiKit.Logging.logger;
-}
-this.logger=_428;
-var _429=MochiKit.Base.update;
-var _430=MochiKit.Base.updatetree;
-var bind=MochiKit.Base.bind;
-var _431=MochiKit.Base.clone;
-var win=window;
-var uid="_MochiKit_LoggingPane";
-if(typeof (MochiKit.DOM)!="undefined"){
-win=MochiKit.DOM.currentWindow();
-}
-if(!_427){
-var url=win.location.href.split("?")[0].replace(/[:\/.><&]/g,"_");
-var name=uid+"_"+url;
-var nwin=win.open("",name,"dependent,resizable,height=200");
-if(!nwin){
-alert("Not able to open debugging window due to pop-up blocking.");
-return undefined;
-}
-nwin.document.write("<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\" "+"\"http://www.w3.org/TR/html4/loose.dtd\">"+"<html><head><title>[MochiKit.LoggingPane]</title></head>"+"<body></body></html>");
-nwin.document.close();
-nwin.document.title+=" "+win.document.title;
-win=nwin;
-}
-var doc=win.document;
-this.doc=doc;
-var _434=doc.getElementById(uid);
-var _435=!!_434;
-if(_434&&typeof (_434.loggingPane)!="undefined"){
-_434.loggingPane.logger=this.logger;
-_434.loggingPane.buildAndApplyFilter();
-return _434.loggingPane;
-}
-if(_435){
-var _436;
-while((_436=_434.firstChild)){
-_434.removeChild(_436);
-}
-}else{
-_434=doc.createElement("div");
-_434.id=uid;
-}
-_434.loggingPane=this;
-var _437=doc.createElement("input");
-var _438=doc.createElement("input");
-var _439=doc.createElement("button");
-var _440=doc.createElement("button");
-var _441=doc.createElement("button");
-var _442=doc.createElement("button");
-var _443=doc.createElement("div");
-var _444=doc.createElement("div");
-var _445=uid+"_Listener";
-this.colorTable=_431(this.colorTable);
-var _446=[];
-var _447=null;
-var _448=function(msg){
-var _449=msg.level;
-if(typeof (_449)=="number"){
-_449=MochiKit.Logging.LogLevel[_449];
-}
-return _449;
-};
-var _450=function(msg){
-return msg.info.join(" ");
-};
-var _451=bind(function(msg){
-var _452=_448(msg);
-var text=_450(msg);
-var c=this.colorTable[_452];
-var p=doc.createElement("span");
-p.className="MochiKit-LogMessage MochiKit-LogLevel-"+_452;
-p.style.cssText="margin: 0px; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; white-space: pre-wrap; white-space: pre-line; word-wrap: break-word; wrap-option: emergency; color: "+c;
-p.appendChild(doc.createTextNode(_452+": "+text));
-_444.appendChild(p);
-_444.appendChild(doc.createElement("br"));
-if(_443.offsetHeight>_443.scrollHeight){
-_443.scrollTop=0;
-}else{
-_443.scrollTop=_443.scrollHeight;
-}
-},this);
-var _454=function(msg){
-_446[_446.length]=msg;
-_451(msg);
-};
-var _455=function(){
-var _456,infore;
-try{
-_456=new RegExp(_437.value);
-infore=new RegExp(_438.value);
-}
-catch(e){
-logDebug("Error in filter regex: "+e.message);
-return null;
-}
-return function(msg){
-return (_456.test(_448(msg))&&infore.test(_450(msg)));
-};
-};
-var _457=function(){
-while(_444.firstChild){
-_444.removeChild(_444.firstChild);
-}
-};
-var _458=function(){
-_446=[];
-_457();
-};
-var _459=bind(function(){
-if(this.closed){
-return;
-}
-this.closed=true;
-if(MochiKit.LoggingPane._loggingPane==this){
-MochiKit.LoggingPane._loggingPane=null;
-}
-this.logger.removeListener(_445);
-_434.loggingPane=null;
-if(_427){
-_434.parentNode.removeChild(_434);
-}else{
-this.win.close();
-}
-},this);
-var _460=function(){
-_457();
-for(var i=0;i<_446.length;i++){
-var msg=_446[i];
-if(_447===null||_447(msg)){
-_451(msg);
-}
-}
-};
-this.buildAndApplyFilter=function(){
-_447=_455();
-_460();
-this.logger.removeListener(_445);
-this.logger.addListener(_445,_447,_454);
-};
-var _461=bind(function(){
-_446=this.logger.getMessages();
-_460();
-},this);
-var _462=bind(function(_463){
-_463=_463||window.event;
-key=_463.which||_463.keyCode;
-if(key==13){
-this.buildAndApplyFilter();
-}
-},this);
-var _464="display: block; z-index: 1000; left: 0px; bottom: 0px; position: fixed; width: 100%; background-color: white; font: "+this.logFont;
-if(_427){
-_464+="; height: 10em; border-top: 2px solid black";
-}else{
-_464+="; height: 100%;";
-}
-_434.style.cssText=_464;
-if(!_435){
-doc.body.appendChild(_434);
-}
-_464={"cssText":"width: 33%; display: inline; font: "+this.logFont};
-_430(_437,{"value":"FATAL|ERROR|WARNING|INFO|DEBUG","onkeypress":_462,"style":_464});
-_434.appendChild(_437);
-_430(_438,{"value":".*","onkeypress":_462,"style":_464});
-_434.appendChild(_438);
-_464="width: 8%; display:inline; font: "+this.logFont;
-_439.appendChild(doc.createTextNode("Filter"));
-_439.onclick=bind("buildAndApplyFilter",this);
-_439.style.cssText=_464;
-_434.appendChild(_439);
-_440.appendChild(doc.createTextNode("Load"));
-_440.onclick=_461;
-_440.style.cssText=_464;
-_434.appendChild(_440);
-_441.appendChild(doc.createTextNode("Clear"));
-_441.onclick=_458;
-_441.style.cssText=_464;
-_434.appendChild(_441);
-_442.appendChild(doc.createTextNode("Close"));
-_442.onclick=_459;
-_442.style.cssText=_464;
-_434.appendChild(_442);
-_443.style.cssText="overflow: auto; width: 100%";
-_444.style.cssText="width: 100%; height: "+(_427?"8em":"100%");
-_443.appendChild(_444);
-_434.appendChild(_443);
-this.buildAndApplyFilter();
-_461();
-if(_427){
-this.win=undefined;
-}else{
-this.win=win;
-}
-this.inline=_427;
-this.closePane=_459;
-this.closed=false;
-return this;
-};
-MochiKit.LoggingPane.LoggingPane.prototype={"logFont":"8pt Verdana,sans-serif","colorTable":{"ERROR":"red","FATAL":"darkred","WARNING":"blue","INFO":"black","DEBUG":"green"}};
-MochiKit.LoggingPane.EXPORT_OK=["LoggingPane"];
-MochiKit.LoggingPane.EXPORT=["createLoggingPane"];
-MochiKit.LoggingPane.__new__=function(){
-this.EXPORT_TAGS={":common":this.EXPORT,":all":MochiKit.Base.concat(this.EXPORT,this.EXPORT_OK)};
-MochiKit.Base.nameFunctions(this);
-MochiKit.LoggingPane._loggingPane=null;
-};
-MochiKit.LoggingPane.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.LoggingPane);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Color");
-dojo.require("MochiKit.Base");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Color depends on MochiKit.Base";
-}
-if(typeof (MochiKit.Color)=="undefined"){
-MochiKit.Color={};
-}
-MochiKit.Color.NAME="MochiKit.Color";
-MochiKit.Color.VERSION="1.3.1";
-MochiKit.Color.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.Color.toString=function(){
-return this.__repr__();
-};
-MochiKit.Color.Color=function(red,_466,blue,_468){
-if(typeof (_468)=="undefined"||_468===null){
-_468=1;
-}
-this.rgb={r:red,g:_466,b:blue,a:_468};
-};
-MochiKit.Color.Color.prototype={__class__:MochiKit.Color.Color,colorWithAlpha:function(_469){
-var rgb=this.rgb;
-var m=MochiKit.Color;
-return m.Color.fromRGB(rgb.r,rgb.g,rgb.b,_469);
-},colorWithHue:function(hue){
-var hsl=this.asHSL();
-hsl.h=hue;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},colorWithSaturation:function(_473){
-var hsl=this.asHSL();
-hsl.s=_473;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},colorWithLightness:function(_474){
-var hsl=this.asHSL();
-hsl.l=_474;
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},darkerColorWithLevel:function(_475){
-var hsl=this.asHSL();
-hsl.l=Math.max(hsl.l-_475,0);
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},lighterColorWithLevel:function(_476){
-var hsl=this.asHSL();
-hsl.l=Math.min(hsl.l+_476,1);
-var m=MochiKit.Color;
-return m.Color.fromHSL(hsl);
-},blendedColor:function(_477,_478){
-if(typeof (_478)=="undefined"||_478===null){
-_478=0.5;
-}
-var sf=1-_478;
-var s=this.rgb;
-var d=_477.rgb;
-var df=_478;
-return MochiKit.Color.Color.fromRGB((s.r*sf)+(d.r*df),(s.g*sf)+(d.g*df),(s.b*sf)+(d.b*df),(s.a*sf)+(d.a*df));
-},compareRGB:function(_481){
-var a=this.asRGB();
-var b=_481.asRGB();
-return MochiKit.Base.compare([a.r,a.g,a.b,a.a],[b.r,b.g,b.b,b.a]);
-},isLight:function(){
-return this.asHSL().b>0.5;
-},isDark:function(){
-return (!this.isLight());
-},toHSLString:function(){
-var c=this.asHSL();
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._hslString;
-if(!rval){
-var mid=(ccc(c.h,360).toFixed(0)+","+ccc(c.s,100).toPrecision(4)+"%"+","+ccc(c.l,100).toPrecision(4)+"%");
-var a=c.a;
-if(a>=1){
-a=1;
-rval="hsl("+mid+")";
-}else{
-if(a<=0){
-a=0;
-}
-rval="hsla("+mid+","+a+")";
-}
-this._hslString=rval;
-}
-return rval;
-},toRGBString:function(){
-var c=this.rgb;
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._rgbString;
-if(!rval){
-var mid=(ccc(c.r,255).toFixed(0)+","+ccc(c.g,255).toFixed(0)+","+ccc(c.b,255).toFixed(0));
-if(c.a!=1){
-rval="rgba("+mid+","+c.a+")";
-}else{
-rval="rgb("+mid+")";
-}
-this._rgbString=rval;
-}
-return rval;
-},asRGB:function(){
-return MochiKit.Base.clone(this.rgb);
-},toHexString:function(){
-var m=MochiKit.Color;
-var c=this.rgb;
-var ccc=MochiKit.Color.clampColorComponent;
-var rval=this._hexString;
-if(!rval){
-rval=("#"+m.toColorPart(ccc(c.r,255))+m.toColorPart(ccc(c.g,255))+m.toColorPart(ccc(c.b,255)));
-this._hexString=rval;
-}
-return rval;
-},asHSV:function(){
-var hsv=this.hsv;
-var c=this.rgb;
-if(typeof (hsv)=="undefined"||hsv===null){
-hsv=MochiKit.Color.rgbToHSV(this.rgb);
-this.hsv=hsv;
-}
-return MochiKit.Base.clone(hsv);
-},asHSL:function(){
-var hsl=this.hsl;
-var c=this.rgb;
-if(typeof (hsl)=="undefined"||hsl===null){
-hsl=MochiKit.Color.rgbToHSL(this.rgb);
-this.hsl=hsl;
-}
-return MochiKit.Base.clone(hsl);
-},toString:function(){
-return this.toRGBString();
-},repr:function(){
-var c=this.rgb;
-var col=[c.r,c.g,c.b,c.a];
-return this.__class__.NAME+"("+col.join(", ")+")";
-}};
-MochiKit.Base.update(MochiKit.Color.Color,{fromRGB:function(red,_486,blue,_487){
-var _488=MochiKit.Color.Color;
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_486=rgb.g;
-blue=rgb.b;
-if(typeof (rgb.a)=="undefined"){
-_487=undefined;
-}else{
-_487=rgb.a;
-}
-}
-return new _488(red,_486,blue,_487);
-},fromHSL:function(hue,_489,_490,_491){
-var m=MochiKit.Color;
-return m.Color.fromRGB(m.hslToRGB.apply(m,arguments));
-},fromHSV:function(hue,_492,_493,_494){
-var m=MochiKit.Color;
-return m.Color.fromRGB(m.hsvToRGB.apply(m,arguments));
-},fromName:function(name){
-var _495=MochiKit.Color.Color;
-if(name.charAt(0)=="\""){
-name=name.substr(1,name.length-2);
-}
-var _496=_495._namedColors[name.toLowerCase()];
-if(typeof (_496)=="string"){
-return _495.fromHexString(_496);
-}else{
-if(name=="transparent"){
-return _495.transparentColor();
-}
-}
-return null;
-},fromString:function(_497){
-var self=MochiKit.Color.Color;
-var _498=_497.substr(0,3);
-if(_498=="rgb"){
-return self.fromRGBString(_497);
-}else{
-if(_498=="hsl"){
-return self.fromHSLString(_497);
-}else{
-if(_497.charAt(0)=="#"){
-return self.fromHexString(_497);
-}
-}
-}
-return self.fromName(_497);
-},fromHexString:function(_499){
-if(_499.charAt(0)=="#"){
-_499=_499.substring(1);
-}
-var _500=[];
-var i,hex;
-if(_499.length==3){
-for(i=0;i<3;i++){
-hex=_499.substr(i,1);
-_500.push(parseInt(hex+hex,16)/255);
-}
-}else{
-for(i=0;i<6;i+=2){
-hex=_499.substr(i,2);
-_500.push(parseInt(hex,16)/255);
-}
-}
-var _501=MochiKit.Color.Color;
-return _501.fromRGB.apply(_501,_500);
-},_fromColorString:function(pre,_503,_504,_505){
-if(_505.indexOf(pre)===0){
-_505=_505.substring(_505.indexOf("(",3)+1,_505.length-1);
-}
-var _506=_505.split(/\s*,\s*/);
-var _507=[];
-for(var i=0;i<_506.length;i++){
-var c=_506[i];
-var val;
-var _508=c.substring(c.length-3);
-if(c.charAt(c.length-1)=="%"){
-val=0.01*parseFloat(c.substring(0,c.length-1));
-}else{
-if(_508=="deg"){
-val=parseFloat(c)/360;
-}else{
-if(_508=="rad"){
-val=parseFloat(c)/(Math.PI*2);
-}else{
-val=_504[i]*parseFloat(c);
-}
-}
-}
-_507.push(val);
-}
-return this[_503].apply(this,_507);
-},fromComputedStyle:function(elem,_509,_510){
-var d=MochiKit.DOM;
-var cls=MochiKit.Color.Color;
-for(elem=d.getElement(elem);elem;elem=elem.parentNode){
-var _511=d.computedStyle.apply(d,arguments);
-if(!_511){
-continue;
-}
-var _512=cls.fromString(_511);
-if(!_512){
-break;
-}
-if(_512.asRGB().a>0){
-return _512;
-}
-}
-return null;
-},fromBackground:function(elem){
-var cls=MochiKit.Color.Color;
-return cls.fromComputedStyle(elem,"backgroundColor","background-color")||cls.whiteColor();
-},fromText:function(elem){
-var cls=MochiKit.Color.Color;
-return cls.fromComputedStyle(elem,"color","color")||cls.blackColor();
-},namedColors:function(){
-return MochiKit.Base.clone(MochiKit.Color.Color._namedColors);
-}});
-MochiKit.Base.update(MochiKit.Color,{clampColorComponent:function(v,_513){
-v*=_513;
-if(v<0){
-return 0;
-}else{
-if(v>_513){
-return _513;
-}else{
-return v;
-}
-}
-},_hslValue:function(n1,n2,hue){
-if(hue>6){
-hue-=6;
-}else{
-if(hue<0){
-hue+=6;
-}
-}
-var val;
-if(hue<1){
-val=n1+(n2-n1)*hue;
-}else{
-if(hue<3){
-val=n2;
-}else{
-if(hue<4){
-val=n1+(n2-n1)*(4-hue);
-}else{
-val=n1;
-}
-}
-}
-return val;
-},hsvToRGB:function(hue,_516,_517,_518){
-if(arguments.length==1){
-var hsv=hue;
-hue=hsv.h;
-_516=hsv.s;
-_517=hsv.v;
-_518=hsv.a;
-}
-var red;
-var _519;
-var blue;
-if(_516===0){
-red=0;
-_519=0;
-blue=0;
-}else{
-var i=Math.floor(hue*6);
-var f=(hue*6)-i;
-var p=_517*(1-_516);
-var q=_517*(1-(_516*f));
-var t=_517*(1-(_516*(1-f)));
-switch(i){
-case 1:
-red=q;
-_519=_517;
-blue=p;
-break;
-case 2:
-red=p;
-_519=_517;
-blue=t;
-break;
-case 3:
-red=p;
-_519=q;
-blue=_517;
-break;
-case 4:
-red=t;
-_519=p;
-blue=_517;
-break;
-case 5:
-red=_517;
-_519=p;
-blue=q;
-break;
-case 6:
-case 0:
-red=_517;
-_519=t;
-blue=p;
-break;
-}
-}
-return {r:red,g:_519,b:blue,a:_518};
-},hslToRGB:function(hue,_521,_522,_523){
-if(arguments.length==1){
-var hsl=hue;
-hue=hsl.h;
-_521=hsl.s;
-_522=hsl.l;
-_523=hsl.a;
-}
-var red;
-var _524;
-var blue;
-if(_521===0){
-red=_522;
-_524=_522;
-blue=_522;
-}else{
-var m2;
-if(_522<=0.5){
-m2=_522*(1+_521);
-}else{
-m2=_522+_521-(_522*_521);
-}
-var m1=(2*_522)-m2;
-var f=MochiKit.Color._hslValue;
-var h6=hue*6;
-red=f(m1,m2,h6+2);
-_524=f(m1,m2,h6);
-blue=f(m1,m2,h6-2);
-}
-return {r:red,g:_524,b:blue,a:_523};
-},rgbToHSV:function(red,_528,blue,_529){
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_528=rgb.g;
-blue=rgb.b;
-_529=rgb.a;
-}
-var max=Math.max(Math.max(red,_528),blue);
-var min=Math.min(Math.min(red,_528),blue);
-var hue;
-var _532;
-var _533=max;
-if(min==max){
-hue=0;
-_532=0;
-}else{
-var _534=(max-min);
-_532=_534/max;
-if(red==max){
-hue=(_528-blue)/_534;
-}else{
-if(_528==max){
-hue=2+((blue-red)/_534);
-}else{
-hue=4+((red-_528)/_534);
-}
-}
-hue/=6;
-if(hue<0){
-hue+=1;
-}
-if(hue>1){
-hue-=1;
-}
-}
-return {h:hue,s:_532,v:_533,a:_529};
-},rgbToHSL:function(red,_535,blue,_536){
-if(arguments.length==1){
-var rgb=red;
-red=rgb.r;
-_535=rgb.g;
-blue=rgb.b;
-_536=rgb.a;
-}
-var max=Math.max(red,Math.max(_535,blue));
-var min=Math.min(red,Math.min(_535,blue));
-var hue;
-var _537;
-var _538=(max+min)/2;
-var _539=max-min;
-if(_539===0){
-hue=0;
-_537=0;
-}else{
-if(_538<=0.5){
-_537=_539/(max+min);
-}else{
-_537=_539/(2-max-min);
-}
-if(red==max){
-hue=(_535-blue)/_539;
-}else{
-if(_535==max){
-hue=2+((blue-red)/_539);
-}else{
-hue=4+((red-_535)/_539);
-}
-}
-hue/=6;
-if(hue<0){
-hue+=1;
-}
-if(hue>1){
-hue-=1;
-}
-}
-return {h:hue,s:_537,l:_538,a:_536};
-},toColorPart:function(num){
-num=Math.round(num);
-var _540=num.toString(16);
-if(num<16){
-return "0"+_540;
-}
-return _540;
-},__new__:function(){
-var m=MochiKit.Base;
-this.Color.fromRGBString=m.bind(this.Color._fromColorString,this.Color,"rgb","fromRGB",[1/255,1/255,1/255,1]);
-this.Color.fromHSLString=m.bind(this.Color._fromColorString,this.Color,"hsl","fromHSL",[1/360,0.01,0.01,1]);
-var _541=1/3;
-var _542={black:[0,0,0],blue:[0,0,1],brown:[0.6,0.4,0.2],cyan:[0,1,1],darkGray:[_541,_541,_541],gray:[0.5,0.5,0.5],green:[0,1,0],lightGray:[2*_541,2*_541,2*_541],magenta:[1,0,1],orange:[1,0.5,0],purple:[0.5,0,0.5],red:[1,0,0],transparent:[0,0,0,0],white:[1,1,1],yellow:[1,1,0]};
-var _543=function(name,r,g,b,a){
-var rval=this.fromRGB(r,g,b,a);
-this[name]=function(){
-return rval;
-};
-return rval;
-};
-for(var k in _542){
-var name=k+"Color";
-var _545=m.concat([_543,this.Color,name],_542[k]);
-this.Color[name]=m.bind.apply(null,_545);
-}
-var _546=function(){
-for(var i=0;i<arguments.length;i++){
-if(!(arguments[i] instanceof Color)){
-return false;
-}
-}
-return true;
-};
-var _547=function(a,b){
-return a.compareRGB(b);
-};
-m.nameFunctions(this);
-m.registerComparator(this.Color.NAME,_546,_547);
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-}});
-MochiKit.Color.EXPORT=["Color"];
-MochiKit.Color.EXPORT_OK=["clampColorComponent","rgbToHSL","hslToRGB","rgbToHSV","hsvToRGB","toColorPart"];
-MochiKit.Color.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Color);
-MochiKit.Color.Color._namedColors={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgree!
 n:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc!
 ",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"!
 #f5fffa"
,mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Signal");
-dojo.require("MochiKit.Base");
-dojo.require("MochiKit.DOM");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-JSAN.use("MochiKit.DOM",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Signal depends on MochiKit.Base!";
-}
-try{
-if(typeof (MochiKit.DOM)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Signal depends on MochiKit.DOM!";
-}
-if(typeof (MochiKit.Signal)=="undefined"){
-MochiKit.Signal={};
-}
-MochiKit.Signal.NAME="MochiKit.Signal";
-MochiKit.Signal.VERSION="1.3.1";
-MochiKit.Signal._observers=[];
-MochiKit.Signal.Event=function(src,e){
-this._event=e||window.event;
-this._src=src;
-};
-MochiKit.Base.update(MochiKit.Signal.Event.prototype,{__repr__:function(){
-var repr=MochiKit.Base.repr;
-var str="{event(): "+repr(this.event())+", src(): "+repr(this.src())+", type(): "+repr(this.type())+", target(): "+repr(this.target())+", modifier(): "+"{alt: "+repr(this.modifier().alt)+", ctrl: "+repr(this.modifier().ctrl)+", meta: "+repr(this.modifier().meta)+", shift: "+repr(this.modifier().shift)+", any: "+repr(this.modifier().any)+"}";
-if(this.type()&&this.type().indexOf("key")===0){
-str+=", key(): {code: "+repr(this.key().code)+", string: "+repr(this.key().string)+"}";
-}
-if(this.type()&&(this.type().indexOf("mouse")===0||this.type().indexOf("click")!=-1||this.type()=="contextmenu")){
-str+=", mouse(): {page: "+repr(this.mouse().page)+", client: "+repr(this.mouse().client);
-if(this.type()!="mousemove"){
-str+=", button: {left: "+repr(this.mouse().button.left)+", middle: "+repr(this.mouse().button.middle)+", right: "+repr(this.mouse().button.right)+"}}";
-}else{
-str+="}";
-}
-}
-if(this.type()=="mouseover"||this.type()=="mouseout"){
-str+=", relatedTarget(): "+repr(this.relatedTarget());
-}
-str+="}";
-return str;
-},toString:function(){
-return this.__repr__();
-},src:function(){
-return this._src;
-},event:function(){
-return this._event;
-},type:function(){
-return this._event.type||undefined;
-},target:function(){
-return this._event.target||this._event.srcElement;
-},relatedTarget:function(){
-if(this.type()=="mouseover"){
-return (this._event.relatedTarget||this._event.fromElement);
-}else{
-if(this.type()=="mouseout"){
-return (this._event.relatedTarget||this._event.toElement);
-}
-}
-return undefined;
-},modifier:function(){
-var m={};
-m.alt=this._event.altKey;
-m.ctrl=this._event.ctrlKey;
-m.meta=this._event.metaKey||false;
-m.shift=this._event.shiftKey;
-m.any=m.alt||m.ctrl||m.shift||m.meta;
-return m;
-},key:function(){
-var k={};
-if(this.type()&&this.type().indexOf("key")===0){
-if(this.type()=="keydown"||this.type()=="keyup"){
-k.code=this._event.keyCode;
-k.string=(MochiKit.Signal._specialKeys[k.code]||"KEY_UNKNOWN");
-return k;
-}else{
-if(this.type()=="keypress"){
-k.code=0;
-k.string="";
-if(typeof (this._event.charCode)!="undefined"&&this._event.charCode!==0&&!MochiKit.Signal._specialMacKeys[this._event.charCode]){
-k.code=this._event.charCode;
-k.string=String.fromCharCode(k.code);
-}else{
-if(this._event.keyCode&&typeof (this._event.charCode)=="undefined"){
-k.code=this._event.keyCode;
-k.string=String.fromCharCode(k.code);
-}
-}
-return k;
-}
-}
-}
-return undefined;
-},mouse:function(){
-var m={};
-var e=this._event;
-if(this.type()&&(this.type().indexOf("mouse")===0||this.type().indexOf("click")!=-1||this.type()=="contextmenu")){
-m.client=new MochiKit.DOM.Coordinates(0,0);
-if(e.clientX||e.clientY){
-m.client.x=(!e.clientX||e.clientX<0)?0:e.clientX;
-m.client.y=(!e.clientY||e.clientY<0)?0:e.clientY;
-}
-m.page=new MochiKit.DOM.Coordinates(0,0);
-if(e.pageX||e.pageY){
-m.page.x=(!e.pageX||e.pageX<0)?0:e.pageX;
-m.page.y=(!e.pageY||e.pageY<0)?0:e.pageY;
-}else{
-var de=MochiKit.DOM._document.documentElement;
-var b=MochiKit.DOM._document.body;
-m.page.x=e.clientX+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
-m.page.y=e.clientY+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
-}
-if(this.type()!="mousemove"){
-m.button={};
-m.button.left=false;
-m.button.right=false;
-m.button.middle=false;
-if(e.which){
-m.button.left=(e.which==1);
-m.button.middle=(e.which==2);
-m.button.right=(e.which==3);
-}else{
-m.button.left=!!(e.button&1);
-m.button.right=!!(e.button&2);
-m.button.middle=!!(e.button&4);
-}
-}
-return m;
-}
-return undefined;
-},stop:function(){
-this.stopPropagation();
-this.preventDefault();
-},stopPropagation:function(){
-if(this._event.stopPropagation){
-this._event.stopPropagation();
-}else{
-this._event.cancelBubble=true;
-}
-},preventDefault:function(){
-if(this._event.preventDefault){
-this._event.preventDefault();
-}else{
-this._event.returnValue=false;
-}
-}});
-MochiKit.Signal._specialMacKeys={3:"KEY_ENTER",63289:"KEY_NUM_PAD_CLEAR",63276:"KEY_PAGE_UP",63277:"KEY_PAGE_DOWN",63275:"KEY_END",63273:"KEY_HOME",63234:"KEY_ARROW_LEFT",63232:"KEY_ARROW_UP",63235:"KEY_ARROW_RIGHT",63233:"KEY_ARROW_DOWN",63302:"KEY_INSERT",63272:"KEY_DELETE"};
-for(i=63236;i<=63242;i++){
-MochiKit.Signal._specialMacKeys[i]="KEY_F"+(i-63236+1);
-}
-MochiKit.Signal._specialKeys={8:"KEY_BACKSPACE",9:"KEY_TAB",12:"KEY_NUM_PAD_CLEAR",13:"KEY_ENTER",16:"KEY_SHIFT",17:"KEY_CTRL",18:"KEY_ALT",19:"KEY_PAUSE",20:"KEY_CAPS_LOCK",27:"KEY_ESCAPE",32:"KEY_SPACEBAR",33:"KEY_PAGE_UP",34:"KEY_PAGE_DOWN",35:"KEY_END",36:"KEY_HOME",37:"KEY_ARROW_LEFT",38:"KEY_ARROW_UP",39:"KEY_ARROW_RIGHT",40:"KEY_ARROW_DOWN",44:"KEY_PRINT_SCREEN",45:"KEY_INSERT",46:"KEY_DELETE",59:"KEY_SEMICOLON",91:"KEY_WINDOWS_LEFT",92:"KEY_WINDOWS_RIGHT",93:"KEY_SELECT",106:"KEY_NUM_PAD_ASTERISK",107:"KEY_NUM_PAD_PLUS_SIGN",109:"KEY_NUM_PAD_HYPHEN-MINUS",110:"KEY_NUM_PAD_FULL_STOP",111:"KEY_NUM_PAD_SOLIDUS",144:"KEY_NUM_LOCK",145:"KEY_SCROLL_LOCK",186:"KEY_SEMICOLON",187:"KEY_EQUALS_SIGN",188:"KEY_COMMA",189:"KEY_HYPHEN-MINUS",190:"KEY_FULL_STOP",191:"KEY_SOLIDUS",192:"KEY_GRAVE_ACCENT",219:"KEY_LEFT_SQUARE_BRACKET",220:"KEY_REVERSE_SOLIDUS",221:"KEY_RIGHT_SQUARE_BRACKET",222:"KEY_APOSTROPHE"};
-for(var i=48;i<=57;i++){
-MochiKit.Signal._specialKeys[i]="KEY_"+(i-48);
-}
-for(i=65;i<=90;i++){
-MochiKit.Signal._specialKeys[i]="KEY_"+String.fromCharCode(i);
-}
-for(i=96;i<=105;i++){
-MochiKit.Signal._specialKeys[i]="KEY_NUM_PAD_"+(i-96);
-}
-for(i=112;i<=123;i++){
-MochiKit.Signal._specialKeys[i]="KEY_F"+(i-112+1);
-}
-MochiKit.Base.update(MochiKit.Signal,{__repr__:function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-},toString:function(){
-return this.__repr__();
-},_unloadCache:function(){
-var self=MochiKit.Signal;
-var _548=self._observers;
-for(var i=0;i<_548.length;i++){
-self._disconnect(_548[i]);
-}
-delete self._observers;
-try{
-window.onload=undefined;
-}
-catch(e){
-}
-try{
-window.onunload=undefined;
-}
-catch(e){
-}
-},_listener:function(src,func,obj,_549){
-var E=MochiKit.Signal.Event;
-if(!_549){
-return MochiKit.Base.bind(func,obj);
-}
-obj=obj||src;
-if(typeof (func)=="string"){
-return function(_551){
-obj[func].apply(obj,[new E(src,_551)]);
-};
-}else{
-return function(_552){
-func.apply(obj,[new E(src,_552)]);
-};
-}
-},connect:function(src,sig,_554,_555){
-src=MochiKit.DOM.getElement(src);
-var self=MochiKit.Signal;
-if(typeof (sig)!="string"){
-throw new Error("'sig' must be a string");
-}
-var obj=null;
-var func=null;
-if(typeof (_555)!="undefined"){
-obj=_554;
-func=_555;
-if(typeof (_555)=="string"){
-if(typeof (_554[_555])!="function"){
-throw new Error("'funcOrStr' must be a function on 'objOrFunc'");
-}
-}else{
-if(typeof (_555)!="function"){
-throw new Error("'funcOrStr' must be a function or string");
-}
-}
-}else{
-if(typeof (_554)!="function"){
-throw new Error("'objOrFunc' must be a function if 'funcOrStr' is not given");
-}else{
-func=_554;
-}
-}
-if(typeof (obj)=="undefined"||obj===null){
-obj=src;
-}
-var _556=!!(src.addEventListener||src.attachEvent);
-var _557=self._listener(src,func,obj,_556);
-if(src.addEventListener){
-src.addEventListener(sig.substr(2),_557,false);
-}else{
-if(src.attachEvent){
-src.attachEvent(sig,_557);
-}
-}
-var _558=[src,sig,_557,_556,_554,_555];
-self._observers.push(_558);
-return _558;
-},_disconnect:function(_559){
-if(!_559[3]){
-return;
-}
-var src=_559[0];
-var sig=_559[1];
-var _560=_559[2];
-if(src.removeEventListener){
-src.removeEventListener(sig.substr(2),_560,false);
-}else{
-if(src.detachEvent){
-src.detachEvent(sig,_560);
-}else{
-throw new Error("'src' must be a DOM element");
-}
-}
-},disconnect:function(_561){
-var self=MochiKit.Signal;
-var _562=self._observers;
-var m=MochiKit.Base;
-if(arguments.length>1){
-var src=MochiKit.DOM.getElement(arguments[0]);
-var sig=arguments[1];
-var obj=arguments[2];
-var func=arguments[3];
-for(var i=_562.length-1;i>=0;i--){
-var o=_562[i];
-if(o[0]===src&&o[1]===sig&&o[4]===obj&&o[5]===func){
-self._disconnect(o);
-_562.splice(i,1);
-return true;
-}
-}
-}else{
-var idx=m.findIdentical(_562,_561);
-if(idx>=0){
-self._disconnect(_561);
-_562.splice(idx,1);
-return true;
-}
-}
-return false;
-},disconnectAll:function(src,sig){
-src=MochiKit.DOM.getElement(src);
-var m=MochiKit.Base;
-var _563=m.flattenArguments(m.extend(null,arguments,1));
-var self=MochiKit.Signal;
-var _564=self._disconnect;
-var _565=self._observers;
-if(_563.length===0){
-for(var i=_565.length-1;i>=0;i--){
-var _566=_565[i];
-if(_566[0]===src){
-_564(_566);
-_565.splice(i,1);
-}
-}
-}else{
-var sigs={};
-for(var i=0;i<_563.length;i++){
-sigs[_563[i]]=true;
-}
-for(var i=_565.length-1;i>=0;i--){
-var _566=_565[i];
-if(_566[0]===src&&_566[1] in sigs){
-_564(_566);
-_565.splice(i,1);
-}
-}
-}
-},signal:function(src,sig){
-var _568=MochiKit.Signal._observers;
-src=MochiKit.DOM.getElement(src);
-var args=MochiKit.Base.extend(null,arguments,2);
-var _569=[];
-for(var i=0;i<_568.length;i++){
-var _570=_568[i];
-if(_570[0]===src&&_570[1]===sig){
-try{
-_570[2].apply(src,args);
-}
-catch(e){
-_569.push(e);
-}
-}
-}
-if(_569.length==1){
-throw _569[0];
-}else{
-if(_569.length>1){
-var e=new Error("Multiple errors thrown in handling 'sig', see errors property");
-e.errors=_569;
-throw e;
-}
-}
-}});
-MochiKit.Signal.EXPORT_OK=[];
-MochiKit.Signal.EXPORT=["connect","disconnect","signal","disconnectAll"];
-MochiKit.Signal.__new__=function(win){
-var m=MochiKit.Base;
-this._document=document;
-this._window=win;
-try{
-this.connect(window,"onunload",this._unloadCache);
-}
-catch(e){
-}
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-m.nameFunctions(this);
-};
-MochiKit.Signal.__new__(this);
-if(!MochiKit.__compat__){
-connect=MochiKit.Signal.connect;
-disconnect=MochiKit.Signal.disconnect;
-disconnectAll=MochiKit.Signal.disconnectAll;
-signal=MochiKit.Signal.signal;
-}
-MochiKit.Base._exportSymbols(this,MochiKit.Signal);
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.Visual");
-dojo.require("MochiKit.Base");
-dojo.require("MochiKit.DOM");
-dojo.require("MochiKit.Color");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-JSAN.use("MochiKit.DOM",[]);
-JSAN.use("MochiKit.Color",[]);
-}
-try{
-if(typeof (MochiKit.Base)=="undefined"||typeof (MochiKit.DOM)=="undefined"||typeof (MochiKit.Color)=="undefined"){
-throw "";
-}
-}
-catch(e){
-throw "MochiKit.Visual depends on MochiKit.Base, MochiKit.DOM and MochiKit.Color!";
-}
-if(typeof (MochiKit.Visual)=="undefined"){
-MochiKit.Visual={};
-}
-MochiKit.Visual.NAME="MochiKit.Visual";
-MochiKit.Visual.VERSION="1.3.1";
-MochiKit.Visual.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.Visual.toString=function(){
-return this.__repr__();
-};
-MochiKit.Visual._RoundCorners=function(e,_571){
-e=MochiKit.DOM.getElement(e);
-this._setOptions(_571);
-if(this.options.__unstable__wrapElement){
-e=this._doWrap(e);
-}
-var _572=this.options.color;
-var C=MochiKit.Color.Color;
-if(this.options.color=="fromElement"){
-_572=C.fromBackground(e);
-}else{
-if(!(_572 instanceof C)){
-_572=C.fromString(_572);
-}
-}
-this.isTransparent=(_572.asRGB().a<=0);
-var _574=this.options.bgColor;
-if(this.options.bgColor=="fromParent"){
-_574=C.fromBackground(e.offsetParent);
-}else{
-if(!(_574 instanceof C)){
-_574=C.fromString(_574);
-}
-}
-this._roundCornersImpl(e,_572,_574);
-};
-MochiKit.Visual._RoundCorners.prototype={_doWrap:function(e){
-var _575=e.parentNode;
-var doc=MochiKit.DOM.currentDocument();
-if(typeof (doc.defaultView)=="undefined"||doc.defaultView===null){
-return e;
-}
-var _576=doc.defaultView.getComputedStyle(e,null);
-if(typeof (_576)=="undefined"||_576===null){
-return e;
-}
-var _577=MochiKit.DOM.DIV({"style":{display:"block",marginTop:_576.getPropertyValue("padding-top"),marginRight:_576.getPropertyValue("padding-right"),marginBottom:_576.getPropertyValue("padding-bottom"),marginLeft:_576.getPropertyValue("padding-left"),padding:"0px"}});
-_577.innerHTML=e.innerHTML;
-e.innerHTML="";
-e.appendChild(_577);
-return e;
-},_roundCornersImpl:function(e,_578,_579){
-if(this.options.border){
-this._renderBorder(e,_579);
-}
-if(this._isTopRounded()){
-this._roundTopCorners(e,_578,_579);
-}
-if(this._isBottomRounded()){
-this._roundBottomCorners(e,_578,_579);
-}
-},_renderBorder:function(el,_580){
-var _581="1px solid "+this._borderColor(_580);
-var _582="border-left: "+_581;
-var _583="border-right: "+_581;
-var _584="style='"+_582+";"+_583+"'";
-el.innerHTML="<div "+_584+">"+el.innerHTML+"</div>";
-},_roundTopCorners:function(el,_585,_586){
-var _587=this._createCorner(_586);
-for(var i=0;i<this.options.numSlices;i++){
-_587.appendChild(this._createCornerSlice(_585,_586,i,"top"));
-}
-el.style.paddingTop=0;
-el.insertBefore(_587,el.firstChild);
-},_roundBottomCorners:function(el,_588,_589){
-var _590=this._createCorner(_589);
-for(var i=(this.options.numSlices-1);i>=0;i--){
-_590.appendChild(this._createCornerSlice(_588,_589,i,"bottom"));
-}
-el.style.paddingBottom=0;
-el.appendChild(_590);
-},_createCorner:function(_591){
-var dom=MochiKit.DOM;
-return dom.DIV({style:{backgroundColor:_591.toString()}});
-},_createCornerSlice:function(_592,_593,n,_594){
-var _595=MochiKit.DOM.SPAN();
-var _596=_595.style;
-_596.backgroundColor=_592.toString();
-_596.display="block";
-_596.height="1px";
-_596.overflow="hidden";
-_596.fontSize="1px";
-var _597=this._borderColor(_592,_593);
-if(this.options.border&&n===0){
-_596.borderTopStyle="solid";
-_596.borderTopWidth="1px";
-_596.borderLeftWidth="0px";
-_596.borderRightWidth="0px";
-_596.borderBottomWidth="0px";
-_596.height="0px";
-_596.borderColor=_597.toString();
-}else{
-if(_597){
-_596.borderColor=_597.toString();
-_596.borderStyle="solid";
-_596.borderWidth="0px 1px";
-}
-}
-if(!this.options.compact&&(n==(this.options.numSlices-1))){
-_596.height="2px";
-}
-this._setMargin(_595,n,_594);
-this._setBorder(_595,n,_594);
-return _595;
-},_setOptions:function(_598){
-this.options={corners:"all",color:"fromElement",bgColor:"fromParent",blend:true,border:false,compact:false,__unstable__wrapElement:false};
-MochiKit.Base.update(this.options,_598);
-this.options.numSlices=(this.options.compact?2:4);
-},_whichSideTop:function(){
-var _599=this.options.corners;
-if(this._hasString(_599,"all","top")){
-return "";
-}
-var _600=(_599.indexOf("tl")!=-1);
-var _601=(_599.indexOf("tr")!=-1);
-if(_600&&_601){
-return "";
-}
-if(_600){
-return "left";
-}
-if(_601){
-return "right";
-}
-return "";
-},_whichSideBottom:function(){
-var _602=this.options.corners;
-if(this._hasString(_602,"all","bottom")){
-return "";
-}
-var _603=(_602.indexOf("bl")!=-1);
-var _604=(_602.indexOf("br")!=-1);
-if(_603&&_604){
-return "";
-}
-if(_603){
-return "left";
-}
-if(_604){
-return "right";
-}
-return "";
-},_borderColor:function(_605,_606){
-if(_605=="transparent"){
-return _606;
-}else{
-if(this.options.border){
-return this.options.border;
-}else{
-if(this.options.blend){
-return _606.blendedColor(_605);
-}
-}
-}
-return "";
-},_setMargin:function(el,n,_607){
-var _608=this._marginSize(n)+"px";
-var _609=(_607=="top"?this._whichSideTop():this._whichSideBottom());
-var _610=el.style;
-if(_609=="left"){
-_610.marginLeft=_608;
-_610.marginRight="0px";
-}else{
-if(_609=="right"){
-_610.marginRight=_608;
-_610.marginLeft="0px";
-}else{
-_610.marginLeft=_608;
-_610.marginRight=_608;
-}
-}
-},_setBorder:function(el,n,_611){
-var _612=this._borderSize(n)+"px";
-var _613=(_611=="top"?this._whichSideTop():this._whichSideBottom());
-var _614=el.style;
-if(_613=="left"){
-_614.borderLeftWidth=_612;
-_614.borderRightWidth="0px";
-}else{
-if(_613=="right"){
-_614.borderRightWidth=_612;
-_614.borderLeftWidth="0px";
-}else{
-_614.borderLeftWidth=_612;
-_614.borderRightWidth=_612;
-}
-}
-},_marginSize:function(n){
-if(this.isTransparent){
-return 0;
-}
-var o=this.options;
-if(o.compact&&o.blend){
-var _615=[1,0];
-return _615[n];
-}else{
-if(o.compact){
-var _616=[2,1];
-return _616[n];
-}else{
-if(o.blend){
-var _617=[3,2,1,0];
-return _617[n];
-}else{
-var _618=[5,3,2,1];
-return _618[n];
-}
-}
-}
-},_borderSize:function(n){
-var o=this.options;
-var _619;
-if(o.compact&&(o.blend||this.isTransparent)){
-return 1;
-}else{
-if(o.compact){
-_619=[1,0];
-}else{
-if(o.blend){
-_619=[2,1,1,1];
-}else{
-if(o.border){
-_619=[0,2,0,0];
-}else{
-if(this.isTransparent){
-_619=[5,3,2,1];
-}else{
-return 0;
-}
-}
-}
-}
-}
-return _619[n];
-},_hasString:function(str){
-for(var i=1;i<arguments.length;i++){
-if(str.indexOf(arguments[i])!=-1){
-return true;
-}
-}
-return false;
-},_isTopRounded:function(){
-return this._hasString(this.options.corners,"all","top","tl","tr");
-},_isBottomRounded:function(){
-return this._hasString(this.options.corners,"all","bottom","bl","br");
-},_hasSingleTextChild:function(el){
-return (el.childNodes.length==1&&el.childNodes[0].nodeType==3);
-}};
-MochiKit.Visual.roundElement=function(e,_620){
-new MochiKit.Visual._RoundCorners(e,_620);
-};
-MochiKit.Visual.roundClass=function(_621,_622,_623){
-var _624=MochiKit.DOM.getElementsByTagAndClassName(_621,_622);
-for(var i=0;i<_624.length;i++){
-MochiKit.Visual.roundElement(_624[i],_623);
-}
-};
-MochiKit.Visual.Color=MochiKit.Color.Color;
-MochiKit.Visual.getElementsComputedStyle=MochiKit.DOM.computedStyle;
-MochiKit.Visual.__new__=function(){
-var m=MochiKit.Base;
-m.nameFunctions(this);
-this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
-};
-MochiKit.Visual.EXPORT=["roundElement","roundClass"];
-MochiKit.Visual.EXPORT_OK=[];
-MochiKit.Visual.__new__();
-MochiKit.Base._exportSymbols(this,MochiKit.Visual);
-if(typeof (MochiKit)=="undefined"){
-MochiKit={};
-}
-if(typeof (MochiKit.MochiKit)=="undefined"){
-MochiKit.MochiKit={};
-}
-MochiKit.MochiKit.NAME="MochiKit.MochiKit";
-MochiKit.MochiKit.VERSION="1.3.1";
-MochiKit.MochiKit.__repr__=function(){
-return "["+this.NAME+" "+this.VERSION+"]";
-};
-MochiKit.MochiKit.toString=function(){
-return this.__repr__();
-};
-MochiKit.MochiKit.SUBMODULES=["Base","Iter","Logging","DateTime","Format","Async","DOM","LoggingPane","Color","Signal","Visual"];
-if(typeof (JSAN)!="undefined"||typeof (dojo)!="undefined"){
-if(typeof (dojo)!="undefined"){
-dojo.provide("MochiKit.MochiKit");
-dojo.require("MochiKit.*");
-}
-if(typeof (JSAN)!="undefined"){
-JSAN.use("MochiKit.Base",[]);
-JSAN.use("MochiKit.Iter",[]);
-JSAN.use("MochiKit.Logging",[]);
-JSAN.use("MochiKit.DateTime",[]);
-JSAN.use("MochiKit.Format",[]);
-JSAN.use("MochiKit.Async",[]);
-JSAN.use("MochiKit.DOM",[]);
-JSAN.use("MochiKit.LoggingPane",[]);
-JSAN.use("MochiKit.Color",[]);
-JSAN.use("MochiKit.Signal",[]);
-JSAN.use("MochiKit.Visual",[]);
-}
-(function(){
-var _625=MochiKit.Base.extend;
-var self=MochiKit.MochiKit;
-var _626=self.SUBMODULES;
-var _627=[];
-var _628=[];
-var _629={};
-var i,k,m,all;
-for(i=0;i<_626.length;i++){
-m=MochiKit[_626[i]];
-_625(_627,m.EXPORT);
-_625(_628,m.EXPORT_OK);
-for(k in m.EXPORT_TAGS){
-_629[k]=_625(_629[k],m.EXPORT_TAGS[k]);
-}
-all=m.EXPORT_TAGS[":all"];
-if(!all){
-all=_625(null,m.EXPORT,m.EXPORT_OK);
-}
-var j;
-for(j=0;j<all.length;j++){
-k=all[j];
-self[k]=m[k];
-}
-}
-self.EXPORT=_627;
-self.EXPORT_OK=_628;
-self.EXPORT_TAGS=_629;
-}());
-}else{
-if(typeof (MochiKit.__compat__)=="undefined"){
-MochiKit.__compat__=true;
-}
-(function(){
-var _630=document.getElementsByTagName("script");
-var _631="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
-var base=null;
-var _632=null;
-var _633={};
-var i;
-for(i=0;i<_630.length;i++){
-var src=_630[i].getAttribute("src");
-if(!src){
-continue;
-}
-_633[src]=true;
-if(src.match(/MochiKit.js$/)){
-base=src.substring(0,src.lastIndexOf("MochiKit.js"));
-_632=_630[i];
-}
-}
-if(base===null){
-return;
-}
-var _634=MochiKit.MochiKit.SUBMODULES;
-for(var i=0;i<_634.length;i++){
-if(MochiKit[_634[i]]){
-continue;
-}
-var uri=base+_634[i]+".js";
-if(uri in _633){
-continue;
-}
-if(document.documentElement&&document.documentElement.namespaceURI==_631){
-var s=document.createElementNS(_631,"script");
-s.setAttribute("id","MochiKit_"+base+_634[i]);
-s.setAttribute("src",uri);
-s.setAttribute("type","application/x-javascript");
-_632.parentNode.appendChild(s);
-}else{
-document.write("<script src=\""+uri+"\" type=\"text/javascript\"></script>");
-}
-}
-})();
-}
-
-

Deleted: trunk/lib/Sarissa.js
===================================================================
--- trunk/lib/Sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/Sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,858 +0,0 @@
-/**
-  * Package : begin
-  */
-if (typeof(dojo) != 'undefined') {
-	dojo.provide("Sarissa");
-}
-Sarissa = {};
-Sarissa.NAME = "Sarissa";
-Sarissa.VERSION = "0.9.6.1";
-Sarissa.__repr__ = function () {
-	return "[" + this.NAME + " " + this.VERSION + "]";
-};
-Sarissa.toString = function () {
-	return this.__repr__();
-};
-/**
-  * Package : end
-  */
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
- * The library supports Gecko based browsers like Mozilla and Firefox,
- * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
- * @version 0.9.6.1
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- * ====================================================================
- * Licence
- * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit http://www.gnu.org
- *
- */
-/**
- * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument and
- * XMLHTTP objects, DOM Node serializatrion to XML strings and other goodies.</p>
- * @constructor
- */
-//function Sarissa(){};
-/** @private */
-Sarissa.PARSED_OK = "Document contains no parsing errors";
-/**
- * Tells you whether transformNode and transformNodeToObject are available. This functionality
- * is contained in sarissa_ieemu_xslt.js and is deprecated. If you want to control XSLT transformations
- * use the XSLTProcessor
- * @deprecated
- * @type boolean
- */
-Sarissa.IS_ENABLED_TRANSFORM_NODE = false;
-/**
- * tells you whether XMLHttpRequest (or equivalent) is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_XMLHTTP = false;
-/**
- * tells you whether selectNodes/selectSingleNode is available
- * @type boolean
- */
-Sarissa.IS_ENABLED_SELECT_NODES = false;
-var _sarissa_iNsCounter = 0;
-var _SARISSA_IEPREFIX4XSLPARAM = "";
-var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
-var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
-var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
-var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
-var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
-var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
-if(!window.Node || !window.Node.ELEMENT_NODE){
-    var Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
-};
-
-// IE initialization
-if(_SARISSA_IS_IE){
-    // for XSLT parameter names, prefix needed by IE
-    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
-    // used to store the most recent ProgID available out of the above
-    var _SARISSA_DOM_PROGID = "";
-    var _SARISSA_XMLHTTP_PROGID = "";
-    /**
-     * Called when the Sarissa_xx.js file is parsed, to pick most recent
-     * ProgIDs for IE, then gets destroyed.
-     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
-     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
-     */
-    pickRecentProgID = function (idList, enabledList){
-        // found progID flag
-        var bFound = false;
-        for(var i=0; i < idList.length && !bFound; i++){
-            try{
-                var oDoc = new ActiveXObject(idList[i]);
-                o2Store = idList[i];
-                bFound = true;
-                for(var j=0;j<enabledList.length;j++)
-                    if(i <= enabledList[j][1])
-                        Sarissa["IS_ENABLED_"+enabledList[j][0]] = true;
-            }catch (objException){
-                // trap; try next progID
-            };
-        };
-        if (!bFound)
-            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
-        idList = null;
-        return o2Store;
-    };
-    // pick best available MSXML progIDs
-    _SARISSA_DOM_PROGID = pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"], [["SELECT_NODES", 2],["TRANSFORM_NODE", 2]]);
-    _SARISSA_XMLHTTP_PROGID = pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"], [["XMLHTTP", 4]]);
-    _SARISSA_THREADEDDOM_PROGID = pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"], [["XSLTPROC", 2]]);
-    // we dont need this anymore
-    pickRecentProgID = null;
-    //============================================
-    // Factory methods (IE)
-    //============================================
-    // see non-IE version
-    Sarissa.getDomDocument = function(sUri, sName){
-        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        // if a root tag name was provided, we need to load it in the DOM
-        // object
-        if (sName){
-            // if needed, create an artifical namespace prefix the way Moz
-            // does
-            if (sUri){
-                oDoc.loadXML("<a" + _sarissa_iNsCounter + ":" + sName + " xmlns:a" + _sarissa_iNsCounter + "=\"" + sUri + "\" />");
-                // don't use the same prefix again
-                ++_sarissa_iNsCounter;
-            }
-            else
-                oDoc.loadXML("<" + sName + "/>");
-        };
-        return oDoc;
-    };
-    // see non-IE version
-    Sarissa.getParseErrorText = function (oDoc) {
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc.parseError != 0){
-            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason +
-                "\nLocation: " + oDoc.parseError.url +
-                "\nLine Number " + oDoc.parseError.line + ", Column " +
-                oDoc.parseError.linepos +
-                ":\n" + oDoc.parseError.srcText +
-                "\n";
-            for(var i = 0;  i < oDoc.parseError.linepos;i++){
-                parseErrorText += "-";
-            };
-            parseErrorText +=  "^\n";
-        };
-        return parseErrorText;
-    };
-    // see non-IE version
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        oDoc.setProperty("SelectionLanguage", "XPath");
-        oDoc.setProperty("SelectionNamespaces", sNsSet);
-    };
-    /**
-     * Basic implementation of Mozilla's XSLTProcessor for IE.
-     * Reuses the same XSLT stylesheet for multiple transforms
-     * @constructor
-     */
-    XSLTProcessor = function(){
-        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-        this.processor = null;
-    };
-    /**
-     * Impoprts the given XSLT DOM and compiles it to a reusable transform
-     * @argument xslDoc The XSLT DOMDocument to import
-     */
-    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-        // convert stylesheet to free threaded
-        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-        converted.loadXML(xslDoc.xml);
-        this.template.stylesheet = converted;
-        this.processor = this.template.createProcessor();
-        // (re)set default param values
-        this.paramsSet = new Array();
-    };
-    /**
-     * Transform the given XML DOM
-     * @argument sourceDoc The XML DOMDocument to transform
-     * @return The transformation result as a DOM Document
-     */
-    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-        this.processor.input = sourceDoc;
-        var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-        this.processor.output = outDoc;
-        this.processor.transform();
-        return outDoc;
-    };
-    /**
-     * Set global XSLT parameter of the imported stylesheet
-     * @argument nsURI The parameter namespace URI
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     */
-    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-        /* nsURI is optional but cannot be null */
-        if(nsURI){
-            this.processor.addParameter(name, value, nsURI);
-        }else{
-            this.processor.addParameter(name, value);
-        };
-        /* update updated params for getParameter */
-        if(!this.paramsSet[""+nsURI]){
-            this.paramsSet[""+nsURI] = new Array();
-        };
-        this.paramsSet[""+nsURI][name] = value;
-    };
-    /**
-     * Gets a parameter if previously set by setParameter. Returns null
-     * otherwise
-     * @argument name The parameter base name
-     * @argument value The new parameter value
-     * @return The parameter value if reviously set by setParameter, null otherwise
-     */
-    XSLTProcessor.prototype.getParameter = function(nsURI, name){
-        nsURI = nsURI || "";
-        if(nsURI in this.paramsSet && name in this.paramsSet[nsURI]){
-            return this.paramsSet[nsURI][name];
-        }else{
-            return null;
-        };
-    };
-}
-else{ /* end IE initialization, try to deal with real browsers now ;-) */
-    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
-        /**
-         * <p>Ensures the document was loaded correctly, otherwise sets the
-         * parseError to -1 to indicate something went wrong. Internal use</p>
-         * @private
-         */
-        Sarissa.__handleLoad__ = function(oDoc){
-            if (!oDoc.documentElement || oDoc.documentElement.tagName == "parsererror")
-                oDoc.parseError = -1;
-            Sarissa.__setReadyState__(oDoc, 4);
-        };
-        /**
-        * <p>Attached by an event handler to the load event. Internal use.</p>
-        * @private
-        */
-        _sarissa_XMLDocument_onload = function(){
-            Sarissa.__handleLoad__(this);
-        };
-        /**
-         * <p>Sets the readyState property of the given DOM Document object.
-         * Internal use.</p>
-         * @private
-         * @argument oDoc the DOM Document object to fire the
-         *          readystatechange event
-         * @argument iReadyState the number to change the readystate property to
-         */
-        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
-            oDoc.readyState = iReadyState;
-            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
-                oDoc.onreadystatechange();
-        };
-        Sarissa.getDomDocument = function(sUri, sName){
-            var oDoc = document.implementation.createDocument(sUri?sUri:"", sName?sName:"", null);
-            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
-            return oDoc;
-        };
-        if(window.XMLDocument){
-            /**
-            * <p>Emulate IE's onreadystatechange attribute</p>
-            */
-            XMLDocument.prototype.onreadystatechange = null;
-            /**
-            * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
-            * <ul><li>1 == LOADING,</li>
-            * <li>2 == LOADED,</li>
-            * <li>3 == INTERACTIVE,</li>
-            * <li>4 == COMPLETED</li></ul>
-            */
-            XMLDocument.prototype.readyState = 0;
-            /**
-            * <p>Emulate IE's parseError attribute</p>
-            */
-            XMLDocument.prototype.parseError = 0;
-
-            // NOTE: setting async to false will only work with documents
-            // called over HTTP (meaning a server), not the local file system,
-            // unless you are using Moz 1.4+.
-            // BTW the try>catch block is for 1.4; I haven't found a way to check if
-            // the property is implemented without
-            // causing an error and I dont want to use user agent stuff for that...
-            var _SARISSA_SYNC_NON_IMPLEMENTED = false;// ("async" in XMLDocument.prototype) ? false: true;
-            /**
-            * <p>Keeps a handle to the original load() method. Internal use and only
-            * if Mozilla version is lower than 1.4</p>
-            * @private
-            */
-            XMLDocument.prototype._sarissa_load = XMLDocument.prototype.load;
-
-            /**
-            * <p>Overrides the original load method to provide synchronous loading for
-            * Mozilla versions prior to 1.4, using an XMLHttpRequest object (if
-            * async is set to false)</p>
-            * @returns the DOM Object as it was before the load() call (may be  empty)
-            */
-            XMLDocument.prototype.load = function(sURI) {
-                var oDoc = document.implementation.createDocument("", "", null);
-                Sarissa.copyChildNodes(this, oDoc);
-                this.parseError = 0;
-                Sarissa.__setReadyState__(this, 1);
-                try {
-                    if(this.async == false && _SARISSA_SYNC_NON_IMPLEMENTED) {
-                        var tmp = new XMLHttpRequest();
-                        tmp.open("GET", sURI, false);
-                        tmp.send(null);
-                        Sarissa.__setReadyState__(this, 2);
-                        Sarissa.copyChildNodes(tmp.responseXML, this);
-                        Sarissa.__setReadyState__(this, 3);
-                    }
-                    else {
-                        this._sarissa_load(sURI);
-                    };
-                }
-                catch (objException) {
-                    this.parseError = -1;
-                }
-                finally {
-                    if(this.async == false){
-                        Sarissa.__handleLoad__(this);
-                    };
-                };
-                return oDoc;
-            };
-
-
-        }//if(window.XMLDocument)
-        else if(document.implementation && document.implementation.hasFeature && document.implementation.hasFeature('LS', '3.0')){
-            Document.prototype.async = true;
-            Document.prototype.onreadystatechange = null;
-            Document.prototype.parseError = 0;
-            Document.prototype.load = function(sURI) {
-                var parser = document.implementation.createLSParser(this.async ? document.implementation.MODE_ASYNCHRONOUS : document.implementation.MODE_SYNCHRONOUS, null);
-                if(this.async){
-                    var self = this;
-                    parser.addEventListener("load",
-                        function(e) {
-                            self.readyState = 4;
-                            Sarissa.copyChildNodes(e.newDocument, self.documentElement, false);
-                            self.onreadystatechange.call();
-                        },
-                        false);
-                };
-                try {
-                    var oDoc = parser.parseURI(sURI);
-                }
-                catch(e){
-                    this.parseError = -1;
-                };
-                if(!this.async)
-                   Sarissa.copyChildNodes(oDoc, this.documentElement, false);
-                return oDoc;
-            };
-            /**
-            * <p>Factory method to obtain a new DOM Document object</p>
-            * @argument sUri the namespace of the root node (if any)
-            * @argument sUri the local name of the root node (if any)
-            * @returns a new DOM Document
-            */
-            Sarissa.getDomDocument = function(sUri, sName){
-                return document.implementation.createDocument(sUri?sUri:"", sName?sName:"", null);
-            };
-        };
-    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
-};
-//==========================================
-// Common stuff
-//==========================================
-if(!window.DOMParser){
-    /*
-    * DOMParser is a utility class, used to construct DOMDocuments from XML strings
-    * @constructor
-    */
-    DOMParser = function() {
-    };
-    if(_SARISSA_IS_SAFARI){
-        /**
-        * Construct a new DOM Document from the given XMLstring
-        * @param sXml the given XML string
-        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml).
-        * @return a new DOM Document from the given XML string
-        */
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            if(contentType.toLowerCase() != "application/xml"){
-                throw "Cannot handle content type: \"" + contentType + "\"";
-            };
-            var xmlhttp = new XMLHttpRequest();
-            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(str), false);
-            xmlhttp.send(null);
-            return xmlhttp.responseXML;
-        };
-    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && "loadXML" in Sarissa.getDomDocument()){
-        DOMParser.prototype.parseFromString = function(sXml, contentType){
-            var doc = Sarissa.getDomDocument();
-            doc.loadXML(sXml);
-            return doc;
-        };
-    };
-};
-
-if(window.XMLHttpRequest){
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-}
-else if(_SARISSA_IS_IE){
-    /**
-     * Emulate XMLHttpRequest
-     * @constructor
-     */
-    XMLHttpRequest = function() {
-        return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
-    };
-    Sarissa.IS_ENABLED_XMLHTTP = true;
-};
-
-if(!window.document.importNode && _SARISSA_IS_IE){
-    try{
-        /**
-        * Implements importNode for the current window document in IE using innerHTML.
-        * Testing showed that DOM was multiple times slower than innerHTML for this,
-        * sorry folks. If you encounter trouble (who knows what IE does behind innerHTML)
-        * please gimme a call.
-        * @param oNode the Node to import
-        * @param bChildren whether to include the children of oNode
-        * @returns the imported node for further use
-        */
-        window.document.importNode = function(oNode, bChildren){
-            var importNode = document.createElement("div");
-            if(bChildren)
-                importNode.innerHTML = Sarissa.serialize(oNode);
-            else
-                importNode.innerHTML = Sarissa.serialize(oNode.cloneNode(false));
-            return importNode.firstChild;
-        };
-        }catch(e){};
-};
-if(!Sarissa.getParseErrorText){
-    /**
-     * <p>Returns a human readable description of the parsing error. Usefull
-     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
-     * element if you want to render it.</p>
-     * <p>Many thanks to Christian Stocker for the initial patch.</p>
-     * @argument oDoc The target DOM document
-     * @returns The parsing error description of the target Document in
-     *          human readable form (preformated text)
-     */
-    Sarissa.getParseErrorText = function (oDoc){
-        var parseErrorText = Sarissa.PARSED_OK;
-        if(oDoc && oDoc.parseError && oDoc.parseError != 0){
-            /*moz*/
-            if(oDoc.documentElement.tagName == "parsererror"){
-                parseErrorText = oDoc.documentElement.firstChild.data;
-                parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
-            }/*konq*/
-            else{
-                parseErrorText = Sarissa.getText(oDoc.documentElement);/*.getElementsByTagName("h1")[0], false) + "\n";
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName("body")[0], false) + "\n";
-                parseErrorText += Sarissa.getText(oDoc.documentElement.getElementsByTagName("pre")[0], false);*/
-            };
-        };
-        return parseErrorText;
-    };
-};
-Sarissa.getText = function(oNode, deep){
-    var s = "";
-    var nodes = oNode.childNodes;
-    for(var i=0; i < nodes.length; i++){
-        var node = nodes[i];
-        var nodeType = node.nodeType;
-        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
-            s += node.data;
-        }else if(deep == true
-                    && (nodeType == Node.ELEMENT_NODE
-                        || nodeType == Node.DOCUMENT_NODE
-                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
-            s += Sarissa.getText(node, true);
-        };
-    };
-    return s;
-};
-if(window.XMLSerializer){
-    /**
-     * <p>Factory method to obtain the serialization of a DOM Node</p>
-     * @returns the serialized Node as an XML string
-     */
-    Sarissa.serialize = function(oDoc){
-        var s = null;
-        if(oDoc){
-            s = oDoc.innerHTML?oDoc.innerHTML:(new XMLSerializer()).serializeToString(oDoc);
-        };
-        return s;
-    };
-}else{
-    if(Sarissa.getDomDocument && (Sarissa.getDomDocument("","foo", null)).xml){
-        // see non-IE version
-        Sarissa.serialize = function(oDoc) {
-            var s = null;
-            if(oDoc){
-                s = oDoc.innerHTML?oDoc.innerHTML:oDoc.xml;
-            };
-            return s;
-        };
-        /**
-         * Utility class to serialize DOM Node objects to XML strings
-         * @constructor
-         */
-        XMLSerializer = function(){};
-        /**
-         * Serialize the given DOM Node to an XML string
-         * @param oNode the DOM Node to serialize
-         */
-        XMLSerializer.prototype.serializeToString = function(oNode) {
-            return oNode.xml;
-        };
-    };
-};
-
-/**
- * strips tags from a markup string
- */
-Sarissa.stripTags = function (s) {
-    return s.replace(/<[^>]+>/g,"");
-};
-/**
- * <p>Deletes all child nodes of the given node</p>
- * @argument oNode the Node to empty
- */
-Sarissa.clearChildNodes = function(oNode) {
-    // need to check for firstChild due to opera 8 bug with hasChildNodes
-    while(oNode.firstChild){
-        oNode.removeChild(oNode.firstChild);
-    };
-};
-/**
- * <p> Copies the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before
- * the copy operation, unless you supply a true third parameter</p>
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
- */
-Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw "Both source and destination nodes must be provided";
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-    var nodes = nodeFrom.childNodes;
-    if(ownerDoc.importNode && (!_SARISSA_IS_IE)) {
-        for(var i=0;i < nodes.length;i++) {
-            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-        };
-    }
-    else{
-        for(var i=0;i < nodes.length;i++) {
-            nodeTo.appendChild(nodes[i].cloneNode(true));
-        };
-    };
-};
-
-/**
- * <p> Moves the childNodes of nodeFrom to nodeTo</p>
- * <p> <b>Note:</b> The second object's original content is deleted before
- * the move operation, unless you supply a true third parameter</p>
- * @argument nodeFrom the Node to copy the childNodes from
- * @argument nodeTo the Node to copy the childNodes to
- * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
- */
-Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
-    if((!nodeFrom) || (!nodeTo)){
-        throw "Both source and destination nodes must be provided";
-    };
-    if(!bPreserveExisting){
-        Sarissa.clearChildNodes(nodeTo);
-    };
-    var nodes = nodeFrom.childNodes;
-    // if within the same doc, just move, else copy and delete
-    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
-        while(nodeFrom.firstChild){
-            nodeTo.appendChild(nodeFrom.firstChild);
-        };
-    }else{
-        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
-        if(ownerDoc.importNode && (!_SARISSA_IS_IE)) {
-           for(var i=0;i < nodes.length;i++) {
-               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
-           };
-        }else{
-           for(var i=0;i < nodes.length;i++) {
-               nodeTo.appendChild(nodes[i].cloneNode(true));
-           };
-        };
-        Sarissa.clearChildNodes(nodeFrom);
-    };
-};
-
-/**
- * <p>Serialize any object to an XML string. All properties are serialized using the property name
- * as the XML element name. Array elements are rendered as <code>array-item</code> elements,
- * using their index/key as the value of the <code>key</code> attribute.</p>
- * @argument anyObject the object to serialize
- * @argument objectName a name for that object
- * @return the XML serializationj of the given object as a string
- */
-Sarissa.xmlize = function(anyObject, objectName, indentSpace){
-    indentSpace = indentSpace?indentSpace:'';
-    var s = indentSpace  + '<' + objectName + '>';
-    var isLeaf = false;
-    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-        || anyObject instanceof Boolean || anyObject instanceof Date){
-        s += Sarissa.escape(""+anyObject);
-        isLeaf = true;
-    }else{
-        s += "\n";
-        var itemKey = '';
-        var isArrayItem = anyObject instanceof Array;
-        for(var name in anyObject){
-            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
-        };
-        s += indentSpace;
-    };
-    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
-};
-
-/**
- * Escape the given string chacters that correspond to the five predefined XML entities
- * @param sXml the string to escape
- */
-Sarissa.escape = function(sXml){
-    return sXml.replace(/&/g, "&amp;")
-        .replace(/</g, "&lt;")
-        .replace(/>/g, "&gt;")
-        .replace(/"/g, "&quot;")
-        .replace(/'/g, "&apos;");
-};
-
-/**
- * Unescape the given string. This turns the occurences of the predefined XML
- * entities to become the characters they represent correspond to the five predefined XML entities
- * @param sXml the string to unescape
- */
-Sarissa.unescape = function(sXml){
-    return sXml.replace(/&apos;/g,"'")
-        .replace(/&quot;/g,"\"")
-        .replace(/&gt;/g,">")
-        .replace(/&lt;/g,"<")
-        .replace(/&amp;/g,"&");
-};
-// EOF
-/**
- * ====================================================================
- * About
- * ====================================================================
- * Sarissa cross browser XML library - IE XPath Emulation
- * @version 0.9.6.1
- * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
- *
- * This script emulates Internet Explorer's selectNodes and selectSingleNode
- * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
- * is easy with IE's setProperty.
- * USers may also map a namespace prefix to a default (unprefixed) namespace in the
- * source document with Sarissa.setXpathNamespaces
- *
- *
- * ====================================================================
- * Licence
- * ====================================================================
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License version 2 or
- * the GNU Lesser General Public License version 2.1 as published by
- * the Free Software Foundation (your choice between the two).
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License or GNU Lesser General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * or GNU Lesser General Public License along with this program; if not,
- * write to the Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
- * or visit http://www.gnu.org
- *
- */
-if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
-    /**
-    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
-    * so it also has some properties IEs proprietery object features.</p>
-    * @private
-    * @constructor
-    * @argument i the (initial) list size
-    */
-    function SarissaNodeList(i){
-        this.length = i;
-    };
-    /** <p>Set an Array as the prototype object</p> */
-    SarissaNodeList.prototype = new Array(0);
-    /** <p>Inherit the Array constructor </p> */
-    SarissaNodeList.prototype.constructor = Array;
-    /**
-    * <p>Returns the node at the specified index or null if the given index
-    * is greater than the list size or less than zero </p>
-    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
-    * array notation instead of calling <code>item</code>
-    * @argument i the index of the member to return
-    * @returns the member corresponding to the given index
-    */
-    SarissaNodeList.prototype.item = function(i) {
-        return (i < 0 || i >= this.length)?null:this[i];
-    };
-    /**
-    * <p>Emulate IE's expr property
-    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
-    * @returns the XPath expression passed to selectNodes that resulted in
-    *          this SarissaNodeList
-    */
-    SarissaNodeList.prototype.expr = "";
-    /** dummy, used to accept IE's stuff without throwing errors */
-    XMLDocument.prototype.setProperty  = function(x,y){};
-    /**
-    * <p>Programmatically control namespace URI/prefix mappings for XPath
-    * queries.</p>
-    * <p>This method comes especially handy when used to apply XPath queries
-    * on XML documents with a default namespace, as there is no other way
-    * of mapping that to a prefix.</p>
-    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
-    * are looking for elements in the null namespace. If you need to look
-    * for nodes in the default namespace, you need to map a prefix to it
-    * first like:</p>
-    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
-    * <p><b>Note 1 </b>: Use this method only if the source document features
-    * a default namespace (without a prefix), otherwise just use IE's setProperty
-    * (moz will rezolve non-default namespaces by itself). You will need to map that
-    * namespace to a prefix for queries to work.</p>
-    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
-    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
-    * @param oDoc The target XMLDocument to set the namespace mappings for.
-    * @param sNsSet A whilespace-seperated list of namespace declarations as
-    *            those would appear in an XML document. E.g.:
-    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
-    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
-    * @throws An error if the format of the given namespace declarations is bad.
-    */
-    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
-        //oDoc._sarissa_setXpathNamespaces(sNsSet);
-        oDoc._sarissa_useCustomResolver = true;
-        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
-        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
-        for(var i=0;i < namespaces.length;i++){
-            var ns = namespaces[i];
-            var colonPos = ns.indexOf(":");
-            var assignPos = ns.indexOf("=");
-            if(colonPos == 5 && assignPos > colonPos+2){
-                var prefix = ns.substring(colonPos+1, assignPos);
-                var uri = ns.substring(assignPos+2, ns.length-1);
-                oDoc._sarissa_xpathNamespaces[prefix] = uri;
-            }else{
-                throw "Bad format on namespace declaration(s) given";
-            };
-        };
-    };
-    /**
-    * @private Flag to control whether a custom namespace resolver should
-    *          be used, set to true by Sarissa.setXpathNamespaces
-    */
-    XMLDocument.prototype._sarissa_useCustomResolver = false;
-    /** @private */
-    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
-    /**
-    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as a SarissaNodeList
-    * @throws An error if no namespace URI is found for the given prefix.
-    */
-    XMLDocument.prototype.selectNodes = function(sExpr, contextNode){
-        var nsDoc = this;
-        var nsresolver = this._sarissa_useCustomResolver
-        ? function(prefix){
-            var s = nsDoc._sarissa_xpathNamespaces[prefix];
-            if(s)return s;
-            else throw "No namespace URI found for prefix: '" + prefix+"'";
-            }
-        : this.createNSResolver(this.documentElement);
-            var oResult = this.evaluate(sExpr,
-                    (contextNode?contextNode:this),
-                    nsresolver,
-                    XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-        var nodeList = new SarissaNodeList(oResult.snapshotLength);
-        nodeList.expr = sExpr;
-        for(var i=0;i<nodeList.length;i++)
-            nodeList[i] = oResult.snapshotItem(i);
-        return nodeList;
-    };
-    /**
-    * <p>Extends the Element to emulate IE's selectNodes</p>
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An
-    *             error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectNodes = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectNodes)
-            return doc.selectNodes(sExpr, this);
-        else
-            throw "Method selectNodes is only supported by XML Elements";
-    };
-    /**
-    * <p>Extends the XMLDocument to emulate IE's selectSingleNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @argument contextNode this is for internal use only by the same
-    *           method when called on Elements
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    */
-    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
-        var ctx = contextNode?contextNode:null;
-        sExpr = "("+sExpr+")[1]";
-        var nodeList = this.selectNodes(sExpr, ctx);
-        if(nodeList.length > 0)
-            return nodeList.item(0);
-        else
-            return null;
-    };
-    /**
-    * <p>Extends the Element to emulate IE's selectNodes.</p>
-    * @argument sExpr the XPath expression to use
-    * @returns the result of the XPath search as an (Sarissa)NodeList
-    * @throws An error if invoked on an HTML Element as this is only be
-    *             available to XML Elements.
-    */
-    Element.prototype.selectSingleNode = function(sExpr){
-        var doc = this.ownerDocument;
-        if(doc.selectSingleNode)
-            return doc.selectSingleNode(sExpr, this);
-        else
-            throw "Method selectNodes is only supported by XML Elements";
-    };
-    Sarissa.IS_ENABLED_SELECT_NODES = true;
-};
-// EOF
\ No newline at end of file

Added: trunk/lib/minimal/Freja.js
===================================================================
--- trunk/lib/minimal/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/minimal/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1984 @@
+/***
+
+    Freja 2.1
+
+    Build $Wed, 21 Mar 2007 15:05:31 UTC$
+
+    Target: minimal
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    Copyright (c) 2006-2007 Cedric Savarese <cedric at veerwest.com>, Troels Knak-Nielsen <troelskn at gmail.com>
+    This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>
+
+***/
+
+if (typeof(dojo) != "undefined") {
+	dojo.provide("Freja");
+}
+if (typeof(Freja) == "undefined") {
+	Freja = {};
+}
+Freja.NAME = "Freja";
+Freja.VERSION = "2.1";
+Freja.__repr__ = function () {
+	return "[" + this.NAME + " " + this.VERSION + "]";
+};
+Freja.toString = function () {
+	return this.__repr__();
+};
+/**
+  * Single-hierarchy inheritance (class emulation)
+  * @see    http://www.itsalleasy.com/2006/02/05/prototype-chain/
+  *         http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
+  */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                tmp = document.createElement("table");
+            }
+            else if(oNode.nodeName == "td"){
+                tmp = document.createElement("tr");
+            }
+            else if(oNode.nodeName == "option"){
+                tmp = document.createElement("select");
+            }
+            else{
+                tmp = document.createElement("div");
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName("*")[0];
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
+};
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the minimal auxiliary adapter. It contains self-sufficient
+  * implementations of all dependencies.
+  * 
+  */
+if (typeof(Freja) == "undefined") {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self) : function */
+// from http://blog.ianbicking.org/prototype-and-object-prototype.html
+Freja._aux.bind = function(func, self) {
+	if(typeof (func)=="string"){
+		func=self[func];
+	}
+
+	var im_func = null;
+    if (typeof(func.im_func) == 'function') {
+        im_func = func.im_func;
+    } else {
+        im_func = func;
+    }
+    func = function () {
+        return func.im_func.apply(func.im_self, arguments);
+    }
+    func.im_func = im_func;
+    func.im_self = self;
+	return func;
+};
+/** formContents(elem) : Array */
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName("INPUT");
+	for (var i = 0; i < inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == "radio" || input.type == "checkbox") {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push("");
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName("TEXTAREA");
+	for (var i = 0; i < textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName("SELECT");
+	for (var i = 0; i < selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex >= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : "");
+			}
+		}
+	}
+	return [names, values];
+};
+/** getElement(id) : HTMLElement */
+Freja._aux.getElement = function(id) {
+	if (typeof(id) == "object") {
+		return id;
+	} else {
+		return document.getElementById(id);
+	}
+};
+
+/** connect(src, signal, fnc) : void */
+Freja._aux.connect = function(src, signal, fnc) {
+
+	if(!src) return;
+	if (src.addEventListener) {
+		var wrapper = function(e) {
+			var evt = {
+				stop : function() {
+					if (e.cancelable) {
+						e.preventDefault();
+					}
+					e.stopPropagation();
+				}
+			}
+			fnc(evt);
+		}
+		src.addEventListener(signal.replace(/^(on)/, ""), wrapper, false);
+	} else if (src.attachEvent) {
+		var wrapper = function() {
+			var e = window.event;
+			var evt = {
+				stop : function() {
+					e.cancelBubble = true;
+					e.returnValue = false;
+				}
+			}
+			fnc(evt);
+		}
+		src.attachEvent(signal, wrapper);
+	}
+	if (!src._signals) {
+		src._signals = [];
+	}
+	if (!src._signals[signal]) {
+		src._signals[signal] = [];
+	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item < src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
+	src._signals[signal].push(fnc);
+};
+/** signal(src, signal, ...) : void */
+Freja._aux.signal = function(src, signal) {
+
+	try {
+		var sigs = src._signals[signal];
+		var args = [];
+		for (var i=2; i < arguments.length; i++) {
+			args.push(arguments[i]);
+		}
+		for (var i=0; i < sigs.length; i++) {
+			try {
+				sigs[i].apply(src, args);
+			} catch (e) { /* squelch */ }
+		}
+	} catch (e) { /* squelch */ }
+};
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new Freja._aux.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user && pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == "POST" || method == "PUT") {
+		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
+	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = function(req, sendContent) {
+	var d = Freja._aux.createDeferred();
+	var bComplete = false;
+	req.onreadystatechange = function() {
+		if (req.readyState == 4 && !bComplete) {
+			if (req.status == 0 || req.status == 200 || req.status == 201 || req.status == 304) {
+				d.callback(req);
+			} else {
+				d.errback(req);
+			}
+			bComplete = true;
+		}
+	}
+	if (!sendContent) sendContent = "";
+	req.send(sendContent);
+	return d;
+};
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, "text/xml");
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter("", paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+
+	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation && document.implementation.createDocument) {
+			clone = document.implementation.createDocument("", xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+				for (var i = data.childNodes.length; i >= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				// need to copy root node attributes
+				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}
+			}
+		}
+	}
+	return clone;
+};
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};
+/** A pale replacement for MochiKit.Async.Deferred */
+Freja._aux.Deferred = function() {
+	this._good = [];
+	this._bad = [];
+	this._pending = null;
+};
+Freja._aux.Deferred.prototype.callback = function() {
+	if (this._good.length == 0) {
+		this._pending = [this.callback, arguments];
+		return;
+	}
+	for (var i=0; i < this._good.length; i++) {
+		this._good[i].apply(window, arguments);
+	}
+	this._good = [];
+};
+Freja._aux.Deferred.prototype.errback = function() {
+	if (this._bad.length == 0) {
+		this._pending = [this.errback, arguments];
+		return;
+	}
+	for (var i=0; i < this._bad.length; i++) {
+		this._bad[i].apply(window, arguments);
+	}
+	this._bad = [];
+};
+Freja._aux.Deferred.prototype.addCallbacks = function(fncOK, fncError) {
+	if (fncOK) this._good[this._good.length] = fncOK;
+	if (fncError) this._bad[this._bad.length] = fncError;
+	if (this._pending) {
+		this._pending[0].apply(this, this._pending[1]);
+	}
+};
+Freja._aux.Deferred.prototype.addCallback = function(fncOK) {
+	this.addCallbacks(fncOK);
+};
+Freja._aux.Deferred.prototype.addErrback = function(fncError) {
+	this.addCallbacks(null, fncError);
+};
+
+/**
+  * The baseclass for queryengines
+  * @abstract
+  */
+Freja.QueryEngine = function() {};
+Freja.QueryEngine.prototype.getElementById = function(document, id) {
+	// getElementById doesn't work on XML document without xml:id
+	var allElements = document.getElementsByTagName("*");
+	for (var i= 0; i < allElements.length; i++) {
+		if (allElements[i].getAttribute("id") == id) {
+			return allElements[i];
+		}
+	}
+};
+Freja.QueryEngine.prototype.get = function(document, expression) {
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error("Can't evaluate expression " + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
+	}
+	return null;
+};
+Freja.QueryEngine.prototype.set = function(document, expression, value) {
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
+			}
+			// else parent node non existent either, give up.
+		}
+		// not an attribute, give up.
+		throw new Error("Can't evaluate expression " + expression);
+	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!="") // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
+};
+/**
+  * XPath query engine.
+  */
+Freja.QueryEngine.XPath = function() {};
+Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
+};
+/**
+  * SimplePath
+  */
+Freja.QueryEngine.SimplePath = function() {};
+Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
+	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
+		throw new Error("Can't evaluate expression " + expression);
+	}
+	var parts = expression.split("/");
+	var node = document;
+	var regAttr = new RegExp("^@([\\d\\w]*)");
+	var regOffset = new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+	var regFilter = new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+	var attr = null;
+	var offset = 0;
+	for (var i = 0; i < parts.length; ++i) {
+		var part = parts[i];
+		var filter = regFilter.exec(part);
+		if(filter) {
+			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
+			if(i>0 && parts[i-1]=='') {
+				// expression was of type //element[...]
+				var cn = node.getElementsByTagName(filter[1]);
+			} else {
+				var cn = node.childNodes;
+			}
+			for(var j=0, l=cn.length; j<l ; j++) {
+				if(cn[j].nodeType==1 && cn[j].tagName==filter[1] && cn[j].getAttribute(filter[2])== filter[3]) {
+					node = cn[j];
+					break;
+				}
+			}
+			if (j==l)
+				throw new Error("Can't evaluate expression " + part);
+		}
+		else {
+			offset = regOffset.exec(part);
+			if (offset) {
+				part = offset[1];
+				offset = offset[2] - 1;
+			} else {
+				offset = 0;
+			}
+			if (part != "") {
+				attr = regAttr.exec(part);
+				if (attr) {
+					node = node.getAttributeNode(attr[1]);
+				} else {
+					node = node.getElementsByTagName(part).item(offset);
+				}
+			}
+		}
+	}
+	if (node && node.firstChild && node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	}
+	if (node && node.firstChild && node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+
+	if (!node) {
+		throw new Error("Can't evaluate expression " + expression);
+	}
+	return node;
+};
+/**
+  * Standard model component
+  */
+Freja.Model = function(url, query) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._query = query;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.getElementById = function(id) {
+	if (this.document) {
+		return this._query.getElementById(this.document, id);
+	}
+	return null;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.get = function(expression) {
+	if (this.document) {
+		return this._query.get(this.document, expression);
+	}
+	return null;
+};
+/**
+  * Updates a value
+  */
+Freja.Model.prototype.set = function(expression, value) {
+	if (this.document) {
+		return this._query.set(this.document, expression, value);
+	}
+	return null;
+};
+/**
+  * Updates the model from a view
+  */
+Freja.Model.prototype.updateFrom = function(view) {
+	var values = view.getValues();
+	for (var i = 0; i < values[0].length; ++i) {
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
+	}
+};
+/**
+  * Writes the model back to the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.save = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	// since the serialization may fail, we create a deferred for the
+	// purpose, rather than just returning the sendXMLHttpRequest directly.
+	var d = Freja._aux.createDeferred();
+	var req = Freja.AssetManager.openXMLHttpRequest("POST", url);
+	try {
+		// for some obscure reason exceptions aren't thrown back if I call the
+		// shorthand version of sendXMLHttpRequest in IE6.
+		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Deletes the model from the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.remove = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest("DELETE", url);
+	return Freja._aux.sendXMLHttpRequest(req);
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.reload = function() {
+	this.ready = false;
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, this);
+	var d = Freja.AssetManager.loadAsset(this.url, true);
+	d.addCallbacks(onload, Freja.AssetManager.onerror);
+	return d;
+};
+/**
+  * DataSource provides a gateway-type interface to a REST service.
+  */
+Freja.Model.DataSource = function(createURL, indexURL) {
+	this.createURL = createURL;
+	this.indexURL = indexURL;
+};
+/**
+  * Returns a list of primary-keys to records in the datasource
+  */
+Freja.Model.DataSource.prototype.select = function() {
+	return getModel(this.indexURL);
+};
+/**
+  * Creates a new instance of a record
+  * @todo errback to the deferred on errors
+  */
+Freja.Model.DataSource.prototype.create = function(values) {
+	var url = this.createURL;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest("PUT", url);
+	var payload = {};
+	for (var i = 0, len = values[0].length; i < len; ++i) {
+		payload[values[0][i]] = values[1][i];
+	}
+	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
+};
+
+/**
+  * Standard view component
+  */
+Freja.View = function(url, renderer) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._renderer = renderer;
+	this._destination = null;
+	this.behaviors = [];
+	this.placeholder = null;
+	Freja._aux.connect(this, "onrendercomplete", Freja._aux.bind(this._connectBehavior, this));
+};
+/**
+  * @param    model            Freja.Model
+  * @param    placeholder      string    If supplied, this will be used instead of the
+  *                                      default placeholder.
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.prototype.render = function(model, placeholder, xslParameters) {
+	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
+	if (typeof(xslParameters) == "undefined") xslParameters = this.xslParameters;
+
+	var Handler = function(model, view, deferred, xslParameters) {
+		this.model = model;
+		this.view = view;
+		this.deferred = deferred;
+		this.xslParameters = xslParameters;
+	};
+	Handler.prototype.trigger = function() {
+		try {
+			if (!this.view.ready) {
+				Freja._aux.connect(this.view, "onload", Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			if (typeof(this.model) == "object" && this.model instanceof Freja.Model && !this.model.ready) {
+				Freja._aux.connect(this.model, "onload", Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			var model;
+			if (typeof(this.model) == "undefined") {
+				// supply dummy
+				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+			} else if (this.model instanceof Freja.Model) {
+				model = this.model;
+			} else {
+				// wrap pojo's in
+				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?>\n" + Freja._aux.xmlize(this.model, "item")) };
+			}
+
+			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
+			trans.addCallback(Freja._aux.bind(function(html) {
+				if(typeof html == "string") {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = "";   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
+			}, this.view));
+			trans.addCallback(Freja._aux.bind(function() {
+				Freja._aux.signal(this, "onrendercomplete", this._destination)
+			}, this.view));
+			trans.addCallback(this.deferred.callback);
+			trans.addErrback(this.deferred.errback);
+		} catch (ex) {
+			this.deferred.errback(ex);
+		}
+	};
+
+	var d = Freja._aux.createDeferred();
+	try {
+		if (typeof(placeholder) == "object") {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
+		// @todo    Is this a good idea ?
+		// Perhaps we should leave it to the programmer to do this.
+		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
+
+		var h = new Handler(model, this, d, xslParameters);
+		h.trigger();
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Decorates the output of the primary renderer, to inject behavior.
+  * @note Maybe we could use cssQuery (http://dean.edwards.name/my/cssQuery/)
+  *       to identify targets for behavior
+  */
+Freja.View.prototype._connectBehavior = function(destination) {
+	try {
+		var connectCallback = function(node, eventType, callback) {
+
+			Freja._aux.connect(node, eventType, Freja._aux.bind(
+				function(e) {
+					var allow = false;
+					try {
+						allow = callback(this);
+					} catch (ex) {
+						throw new Error("An error ocurred in user handler.\n" + ex.message);
+					} finally {
+						if (!allow) {
+							e.stop();
+						}
+					}
+				}, node)
+			);
+		};
+		var applyHandlers = function(node, behaviors) {
+			for (var i = 0, c = node.childNodes, l = c.length; i < l; ++i) {
+				var child = c[i];
+				if (child.nodeType == 1) {
+					if(child.className) {
+						var classNames = child.className.split(' ');
+						for (var j=0;j<classNames.length;j++) {
+							var handler = behaviors[classNames[j]];
+							if (handler) {
+								for (var eventType in handler) {
+									if (eventType == "init") {
+										handler.init(child);
+									} else {
+										connectCallback(child, eventType, handler[eventType]);
+									}
+								}
+							}
+						}
+					}
+					applyHandlers(child, behaviors);
+				}
+			}
+		};
+
+		// Avoid traversing the DOM tree if there's no handler to process.
+		// @note: is there a better way? this.behaviors.length is always 0.
+		// @note  This is fine. behaviors is a hashmap, not an array.
+		for (var ids in this.behaviors) {
+			applyHandlers(destination, this.behaviors);
+			break;
+		}
+
+	} catch (ex) {
+		alert(ex.message);
+	}
+};
+/**
+  * Returns the values of a formview
+  */
+Freja.View.prototype.getValues = function() {
+	return Freja._aux.formContents(this._destination);
+};
+/**
+  * Base object for viewrenderers
+  */
+Freja.View.Renderer = function() {};
+/**
+  * XSLT based render-engine
+  */
+Freja.View.Renderer.XSLTransformer = function() {};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+        try {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
+			d.errback(new Error("XSL Transformation error."));
+		} else {
+			d.callback(html);
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * XSLT on a remote service for browser which have no native support.
+  * @param    url    URL of the transform service
+  */
+Freja.View.Renderer.RemoteXSLTransformer = function(url) {
+	this.url = url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+
+	// prepare posted data  (no need to send the XSL document, just its url)
+	var xslUrl = view.url;
+	var postedData = "xslFile=" + encodeURIComponent(xslUrl) + "&xmlData=" + encodeURIComponent(Freja._aux.serializeXML(model.document));
+
+	var xslParameterString = '';
+	for (var paramname in xslParameters) {
+		xslParameterString += encodeURIComponent(paramname + "," + xslParameters[paramname]);
+	}
+	if(xslParameterString.length > 0) {
+		postedData  = postedData + '&xslParam=' + xslParameterString;
+	}
+
+	// send request to the server-side XSL transformation service
+	var req = Freja.AssetManager.openXMLHttpRequest("POST", Freja.AssetManager.XSLT_SERVICE_URL);
+	req.onreadystatechange = function() {
+		if (req.readyState == 4) {
+			if (req.status == 200) {
+				d.callback(req.responseText);
+			} else {
+				d.errback(req.responseText);
+			}
+		}
+	}
+	req.send(postedData);
+	return d;
+};
+/**
+  * This is largely s copied with minor stylistic adjustments from Freja 1.1
+  * I renamed it from Controller.history to distinguish between window.history
+  */
+Freja.UndoHistory = function() {
+	this.cache = [];
+	this.maxLength = 5;
+	this._position = 0;
+	this._undoSteps = 0;
+};
+/**
+  * Creates a snapshot of the model and stores it.
+  */
+Freja.UndoHistory.prototype.add = function(model) {
+	var historyIndex = this._position % this.maxLength;
+
+	var modelDoc = model.document;
+	this.cache[historyIndex] = {};
+	this.cache[historyIndex].model = model;
+	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
+
+	if (!this.cache[historyIndex].document) {
+		throw new Error("Couldn't add to history.");
+	} else {
+		this._position++;
+		// clear rest of the history if undo was used.
+		var clearHistoryIndex = historyIndex;
+		while (this._undoSteps > 0) {
+			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
+			this.cache[clearHistoryIndex] = {};
+			this._undoSteps--;
+		}
+		return historyIndex; // what would anybody need this for ?
+	}
+};
+/**
+  * Rolls the state back one step.
+  */
+Freja.UndoHistory.prototype.undo = function(steps) {
+	if (this._undoSteps < this.cache.length) {
+		this._undoSteps++;
+		this._position--;
+		if (this._position < 0) {
+			this._position = this.maxLength - 1;
+		}
+
+		var model = this.cache[this._position].model;
+		if (this.cache[this._position].document) {
+			model.document = this.cache[this._position].document;
+		} else {
+			throw new Error("The model's DOMDocument wasn't properly copied into the history");
+		}
+		if (typeof(steps) != "undefined" && steps > 1) {
+			this.undo(steps - 1);
+		}
+	} else {
+		throw new Error("Nothing to undo");
+	}
+};
+/**
+  * Reverts the effects of undo.
+  */
+Freja.UndoHistory.prototype.redo = function() {
+	if (this._undoSteps > 0) {
+		this._undoSteps--;
+		this._position = (this._position + 1) % this.maxLength;
+
+		var model = this.cache[this._position].model;
+		model.document = this.cache[this._position].document;
+	} else {
+		throw new Error("Nothing to redo");
+	}
+};
+/**
+  * Removes the last entry in the cache
+  */
+Freja.UndoHistory.prototype.removeLast = function() {
+	this._position--;
+
+	if (this._position < 0) {
+		this._position = this.maxLength - 1;
+	}
+	this.cache[this._position] = {};
+	this._undoSteps = 0;
+};
+
+/**
+  * main repository
+  * @static
+  */
+Freja.AssetManager = {
+	models : [],
+	views : [],
+	_username : null,
+	_password : null
+};
+/**
+  * Set to sync to make all requests synchroneous. You shouldn't use
+  * this setting for anything but testing/debugging.
+  * "async" | "sync"
+  */
+Freja.AssetManager.HTTP_REQUEST_TYPE = "async";
+/**
+  * If this is set to null, real PUT and DELETE http-requests will be made,
+  * otherwise a header will be set instead, and the request tunneled through
+  * POST.
+  *
+  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
+  * if theese are your target platform, you can disable tunneling.
+  */
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
+/**
+  * Set this url to provide remote xslt-transformation for browsers that
+  * doesn't support it natively.
+  */
+Freja.AssetManager.XSLT_SERVICE_URL = "srvc-xslt.php";
+/**
+  * HTML displayed while waiting for stuff to happen
+  */
+Freja.AssetManager.THROBBER_HTML = "<span style='color:white;background:firebrick'>Loading ...</span>";
+/**
+  * returns an instance of the renderengine to use
+  */
+Freja.AssetManager.createRenderer = function() {
+//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	if (Freja._aux.hasSupportForXSLT()) {
+		return new Freja.View.Renderer.XSLTransformer();
+	} else {
+		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	}
+};
+/**
+  * Wipes all caches. This isn't something you will normally use during production,
+  * but it's very helpful for debugging/testing
+  */
+Freja.AssetManager.clearCache = function() {
+	this.models = [];
+	this.views = [];
+};
+/**
+  * Load a model-component
+  * @param    url      string
+  */
+Freja.AssetManager.getModel = function(url) {
+	for (var i=0; i < this.models.length; i++) {
+		if (this.models[i].url == url) {
+			return this.models[i];
+		}
+	}
+	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, m);
+	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.models.push(m);
+	return m;
+};
+/**
+  * Load a view-component
+  * @param    url      string
+  */
+Freja.AssetManager.getView = function(url) {
+	for (var i=0; i < this.views.length; i++) {
+		if (this.views[i].url == url) {
+			return this.views[i];
+		}
+	}
+	var v = new Freja.View(url, this.createRenderer());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, v);
+	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.views.push(v);
+	return v;
+};
+/**
+  * Creates and opens a http-request, tunneling exotic methods if needed.
+  */
+Freja.AssetManager.openXMLHttpRequest = function(method, url) {
+	var tunnel = null;
+	if (Freja.AssetManager.HTTP_METHOD_TUNNEL && method != "GET" && method != "POST") {
+		tunnel = method;
+		method = "POST";
+	}
+	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+	if (tunnel) {
+		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
+	}
+	return req;
+};
+/**
+  * Sets username + password for Http-Authentication
+  */
+Freja.AssetManager.setCredentials = function(username, password) {
+	this._username = username;
+	this._password = password;
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.AssetManager.loadAsset = function(url, preventCaching) {
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var d = Freja._aux.createDeferred();
+	var handler = function(transport) {
+		try {
+			if (transport.responseText == "") {
+				throw new Error("Empty response.");
+			}
+			if (transport.responseXML.xml == "") {
+				// The server doesn't reply with Content-Type: text/xml
+				// this will happen if the file is loaded locally (through file://)
+				var document = Freja._aux.loadXML(transport.responseText);
+			} else {
+				var document = transport.responseXML;
+			}
+		} catch (ex) {
+			d.errback(ex);
+		}
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
+	};
+	try {
+		// Why using HTTP_METHOD_TUNNEL for a GET?
+		//-- to prevent caching, since browsers won't cache a POST
+		if (preventCaching && Freja.AssetManager.HTTP_METHOD_TUNNEL) {
+			var req = Freja._aux.openXMLHttpRequest("POST", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, "GET");
+			req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
+		} else {
+			var req = Freja._aux.openXMLHttpRequest("GET", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+		}
+
+		// This shouldn't be nescesary, but alas it is - firefox chokes
+		// It's probably due to an error in MochiKit, so the problem
+		// should be fixed there.
+		var comm = Freja._aux.sendXMLHttpRequest(req);
+		if (Freja.AssetManager.HTTP_REQUEST_TYPE == "async") {
+			// fixes bug #7189 (http://developer.berlios.de/bugs/?func=detailbug&group_id=6277&bug_id=7189)
+			comm.addCallbacks(handler, function(req) {
+				d.errback(new Error("Request failed:" + req.status));
+			});
+		} else {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
+				handler(req);
+			} else {
+				d.errback(new Error("Request failed:" + req.status));
+			}
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * This is a default error-handler. You should provide your own.
+  * The handler is called if an asynchronous error happens, since
+  * this could not be caught with the usual try ... catch
+  *
+  * It ought to be replaced completely with Deferred
+  */
+Freja.AssetManager.onerror = function(ex) {
+	alert("Freja.AssetManager.onerror\n" + ex.message);
+};
+/**
+  * Global exports
+  */
+window.getModel = Freja._aux.bind("getModel", Freja.AssetManager);
+window.getView = Freja._aux.bind("getView", Freja.AssetManager);
\ No newline at end of file

Added: trunk/lib/minimal/Freja_pack.js
===================================================================
--- trunk/lib/minimal/Freja_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/minimal/Freja_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1385 @@
+if(typeof (dojo)!="undefined"){
+dojo.provide("Freja");
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja.NAME="Freja";
+Freja.VERSION="2.1";
+Freja.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+Freja.toString=function(){
+return this.__repr__();
+};
+Freja.Class={};
+Freja.Class.extend=function(_1,_2){
+var _3=function(){
+};
+_3.prototype=_2.prototype;
+_1.prototype=new _3();
+_1.prototype.constructor=_1;
+_1.prototype.superconstructor=_2;
+_1.prototype.supertype=_2.prototype;
+};
+function Sarissa(){
+}
+Sarissa.PARSED_OK="Document contains no parsing errors";
+Sarissa.PARSED_EMPTY="Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR="Not well-formed or other error";
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM="";
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&&_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&&navigator.vendor&&(navigator.userAgent.toLowerCase().indexOf("applewebkit")!=-1||navigator.vendor.indexOf("Apple")!=-1));
+var _SARISSA_IS_IE=document.all&&window.ActiveXObject&&navigator.userAgent.toLowerCase().indexOf("msie")>-1&&navigator.userAgent.toLowerCase().indexOf("opera")==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument=="undefined"&&typeof Document!="undefined"){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM="xsl:";
+var _SARISSA_DOM_PROGID="";
+var _SARISSA_XMLHTTP_PROGID="";
+var _SARISSA_DOM_XMLWRITER="";
+Sarissa.pickRecentProgID=function(_4){
+var _5=false;
+for(var i=0;i<_4.length&&!_5;i++){
+try{
+var _7=new ActiveXObject(_4[i]);
+o2Store=_4[i];
+_5=true;
+}
+catch(objException){
+}
+}
+if(!_5){
+throw "Could not retreive a valid progID of Class: "+_4[_4.length-1]+". (original exception: "+e+")";
+}
+_4=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_8,_9){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"]);
+}
+var _a=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_9){
+var _b="";
+if(_8){
+if(_9.indexOf(":")>1){
+_b=_9.substring(0,_9.indexOf(":"));
+_9=_9.substring(_9.indexOf(":")+1);
+}else{
+_b="a"+(_sarissa_iNsCounter++);
+}
+}
+if(_8){
+_a.loadXML("<"+_b+":"+_9+" xmlns:"+_b+"=\""+_8+"\""+" />");
+}else{
+_a.loadXML("<"+_9+" />");
+}
+}
+return _a;
+};
+Sarissa.getParseErrorText=function(_c){
+var _d=Sarissa.PARSED_OK;
+if(_c.parseError.errorCode!=0){
+_d="XML Parsing Error: "+_c.parseError.reason+"\nLocation: "+_c.parseError.url+"\nLine Number "+_c.parseError.line+", Column "+_c.parseError.linepos+":\n"+_c.parseError.srcText+"\n";
+for(var i=0;i<_c.parseError.linepos;i++){
+_d+="-";
+}
+_d+="^\n";
+}else{
+if(_c.documentElement==null){
+_d=Sarissa.PARSED_EMPTY;
+}
+}
+return _d;
+};
+Sarissa.setXpathNamespaces=function(_f,_10){
+_f.setProperty("SelectionLanguage","XPath");
+_f.setProperty("SelectionNamespaces",_10);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0","MSXML2.XSLTemplate.3.0"]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_11){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0","MSXML2.FreeThreadedDOMDocument.3.0"]);
+}
+_11.setProperty("SelectionLanguage","XPath");
+_11.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _12=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_11.url&&_11.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']")!=null){
+_12.async=false;
+if(_SARISSA_THREADEDDOM_PROGID=="MSXML2.FreeThreadedDOMDocument.6.0"){
+_12.setProperty("AllowDocumentFunction",true);
+_12.resolveExternals=true;
+}
+_12.load(_11.url);
+}else{
+_12.loadXML(_11.xml);
+}
+_12.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _13=_12.selectSingleNode("//xsl:output");
+this.outputMethod=_13?_13.getAttribute("method"):"html";
+this.template.stylesheet=_12;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_14){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_15;
+this.processor.transform();
+return _15;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0","Msxml2.MXXMLWriter.3.0","MSXML2.MXXMLWriter","MSXML.MXXMLWriter","Microsoft.XMLDOM"]);
+}
+this.processor.input=_14;
+var _15=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_15;
+this.processor.transform();
+var _16=new ActiveXObject(_SARISSA_DOM_PROGID);
+_16.loadXML(_15.output+"");
+return _16;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_17,_18){
+this.processor.input=_17;
+this.processor.transform();
+var s=this.processor.output;
+var f=_18.createDocumentFragment();
+if(this.outputMethod=="text"){
+f.appendChild(_18.createTextNode(s));
+}else{
+if(_18.body&&_18.body.innerHTML){
+var _1b=_18.createElement("div");
+_1b.innerHTML=s;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}else{
+var _1c=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)=="<?xml"){
+s=s.substring(s.indexOf("?>")+2);
+}
+var xml="".concat("<my>",s,"</my>");
+_1c.loadXML(xml);
+var _1b=_1c.documentElement;
+while(_1b.hasChildNodes()){
+f.appendChild(_1b.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1e,_1f,_20){
+if(_1e){
+this.processor.addParameter(_1f,_20,_1e);
+}else{
+this.processor.addParameter(_1f,_20);
+}
+if(!this.paramsSet[""+_1e]){
+this.paramsSet[""+_1e]=new Array();
+}
+this.paramsSet[""+_1e][_1f]=_20;
+};
+XSLTProcessor.prototype.getParameter=function(_21,_22){
+_21=_21||"";
+if(this.paramsSet[_21]&&this.paramsSet[_21][_22]){
+return this.paramsSet[_21][_22];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _23 in this.paramsSet){
+for(var _24 in this.paramsSet[_23]){
+if(_23){
+this.processor.addParameter(_24,null,_23);
+}else{
+this.processor.addParameter(_24,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_25){
+Sarissa.__setReadyState__(_25,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_26,_27){
+_26.readyState=_27;
+_26.readystate=_27;
+if(_26.onreadystatechange!=null&&typeof _26.onreadystatechange=="function"){
+_26.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+if(!_2a.onreadystatechange){
+_2a.onreadystatechange=null;
+}
+if(!_2a.readyState){
+_2a.readyState=0;
+}
+_2a.addEventListener("load",_sarissa_XMLDocument_onload,false);
+return _2a;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&&window.Document&&!Document.prototype.load&&document.implementation.hasFeature("LS","3.0")){
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+return _2d;
+};
+}else{
+Sarissa.getDomDocument=function(_2e,_2f){
+var _30=document.implementation.createDocument(_2e?_2e:null,_2f?_2f:null,null);
+if(_30&&(_2e||_2f)&&!_30.documentElement){
+_30.appendChild(_30.createElementNS(_2e,_2f));
+}
+return _30;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var _33=new XMLHttpRequest();
+_33.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(_31),false);
+_33.send(null);
+return _33.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&&Sarissa.getDomDocument()&&Sarissa.getDomDocument(null,"bar").xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_34,_35){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_34);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)=="undefined")&&_SARISSA_IS_IE){
+try{
+document.importNode=function(_37,_38){
+var tmp;
+if(_37.nodeName=="tbody"||_37.nodeName=="tr"){
+tmp=document.createElement("table");
+}else{
+if(_37.nodeName=="td"){
+tmp=document.createElement("tr");
+}else{
+if(_37.nodeName=="option"){
+tmp=document.createElement("select");
+}else{
+tmp=document.createElement("div");
+}
+}
+}
+if(_38){
+tmp.innerHTML=_37.xml?_37.xml:_37.outerHTML;
+}else{
+tmp.innerHTML=_37.xml?_37.cloneNode(false).xml:_37.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName("*")[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_3a){
+var _3b=Sarissa.PARSED_OK;
+if(!_3a.documentElement){
+_3b=Sarissa.PARSED_EMPTY;
+}else{
+if(_3a.documentElement.tagName=="parsererror"){
+_3b=_3a.documentElement.firstChild.data;
+_3b+="\n"+_3a.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_3a.getElementsByTagName("parsererror").length>0){
+var _3c=_3a.getElementsByTagName("parsererror")[0];
+_3b=Sarissa.getText(_3c,true)+"\n";
+}else{
+if(_3a.parseError&&_3a.parseError.errorCode!=0){
+_3b=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _3b;
+};
+}
+Sarissa.getText=function(_3d,_3e){
+var s="";
+var _40=_3d.childNodes;
+for(var i=0;i<_40.length;i++){
+var _42=_40[i];
+var _43=_42.nodeType;
+if(_43==Node.TEXT_NODE||_43==Node.CDATA_SECTION_NODE){
+s+=_42.data;
+}else{
+if(_3e==true&&(_43==Node.ELEMENT_NODE||_43==Node.DOCUMENT_NODE||_43==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_42,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&&Sarissa.getDomDocument&&Sarissa.getDomDocument("","foo",null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_44){
+return _44.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/<[^>]+>/g,"");
+};
+Sarissa.clearChildNodes=function(_46){
+while(_46.firstChild){
+_46.removeChild(_46.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_47,_48,_49){
+if((!_47)||(!_48)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_49){
+Sarissa.clearChildNodes(_48);
+}
+var _4a=_48.nodeType==Node.DOCUMENT_NODE?_48:_48.ownerDocument;
+var _4b=_47.childNodes;
+if(typeof (_4a.importNode)!="undefined"){
+for(var i=0;i<_4b.length;i++){
+_48.appendChild(_4a.importNode(_4b[i],true));
+}
+}else{
+for(var i=0;i<_4b.length;i++){
+_48.appendChild(_4b[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4d,_4e,_4f){
+if((!_4d)||(!_4e)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_4f){
+Sarissa.clearChildNodes(_4e);
+}
+var _50=_4d.childNodes;
+if(_4d.ownerDocument==_4e.ownerDocument){
+while(_4d.firstChild){
+_4e.appendChild(_4d.firstChild);
+}
+}else{
+var _51=_4e.nodeType==Node.DOCUMENT_NODE?_4e:_4e.ownerDocument;
+if(typeof (_51.importNode)!="undefined"){
+for(var i=0;i<_50.length;i++){
+_4e.appendChild(_51.importNode(_50[i],true));
+}
+}else{
+for(var i=0;i<_50.length;i++){
+_4e.appendChild(_50[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4d);
+}
+};
+Sarissa.xmlize=function(_53,_54,_55){
+_55=_55?_55:"";
+var s=_55+"<"+_54+">";
+var _57=false;
+if(!(_53 instanceof Object)||_53 instanceof Number||_53 instanceof String||_53 instanceof Boolean||_53 instanceof Date){
+s+=Sarissa.escape(""+_53);
+_57=true;
+}else{
+s+="\n";
+var _58="";
+var _59=_53 instanceof Array;
+for(var _5a in _53){
+s+=Sarissa.xmlize(_53[_5a],(_59?"array-item key=\""+_5a+"\"":_5a),_55+"   ");
+}
+s+=_55;
+}
+return s+=(_54.indexOf(" ")!=-1?"</array-item>\n":"</"+_54+">\n");
+};
+Sarissa.escape=function(_5b){
+return _5b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
+};
+Sarissa.unescape=function(_5c){
+return _5c.replace(/&apos;/g,"'").replace(/&quot;/g,"\"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");
+};
+if(_SARISSA_HAS_DOM_FEATURE&&document.implementation.hasFeature("XPath","3.0")){
+function SarissaNodeList(i){
+this.length=i;
+}
+SarissaNodeList.prototype=new Array(0);
+SarissaNodeList.prototype.constructor=Array;
+SarissaNodeList.prototype.item=function(i){
+return (i<0||i>=this.length)?null:this[i];
+};
+SarissaNodeList.prototype.expr="";
+if(window.XMLDocument&&(!XMLDocument.prototype.setProperty)){
+XMLDocument.prototype.setProperty=function(x,y){
+};
+}
+Sarissa.setXpathNamespaces=function(_61,_62){
+_61._sarissa_useCustomResolver=true;
+var _63=_62.indexOf(" ")>-1?_62.split(" "):new Array(_62);
+_61._sarissa_xpathNamespaces=new Array(_63.length);
+for(var i=0;i<_63.length;i++){
+var ns=_63[i];
+var _66=ns.indexOf(":");
+var _67=ns.indexOf("=");
+if(_66>0&&_67>_66+1){
+var _68=ns.substring(_66+1,_67);
+var uri=ns.substring(_67+2,ns.length-1);
+_61._sarissa_xpathNamespaces[_68]=uri;
+}else{
+throw "Bad format on namespace declaration(s) given";
+}
+}
+};
+XMLDocument.prototype._sarissa_useCustomResolver=false;
+XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
+XMLDocument.prototype.selectNodes=function(_6a,_6b,_6c){
+var _6d=this;
+var _6e=this._sarissa_useCustomResolver?function(_6f){
+var s=_6d._sarissa_xpathNamespaces[_6f];
+if(s){
+return s;
+}else{
+throw "No namespace URI found for prefix: '"+_6f+"'";
+}
+}:this.createNSResolver(this.documentElement);
+var _71=null;
+if(!_6c){
+var _72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _73=new SarissaNodeList(_72.snapshotLength);
+_73.expr=_6a;
+for(var i=0;i<_73.length;i++){
+_73[i]=_72.snapshotItem(i);
+}
+_71=_73;
+}else{
+_71=_72=this.evaluate(_6a,(_6b?_6b:this),_6e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+}
+return _71;
+};
+Element.prototype.selectNodes=function(_75){
+var doc=this.ownerDocument;
+if(doc.selectNodes){
+return doc.selectNodes(_75,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+XMLDocument.prototype.selectSingleNode=function(_77,_78){
+var ctx=_78?_78:null;
+return this.selectNodes(_77,ctx,true);
+};
+Element.prototype.selectSingleNode=function(_7a){
+var doc=this.ownerDocument;
+if(doc.selectSingleNode){
+return doc.selectSingleNode(_7a,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(_SARISSA_IS_IE){
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja._aux={};
+Freja._aux.bind=function(_7c,_7d){
+if(typeof (_7c)=="string"){
+_7c=_7d[_7c];
+}
+var _7e=null;
+if(typeof (_7c.im_func)=="function"){
+_7e=_7c.im_func;
+}else{
+_7e=_7c;
+}
+_7c=function(){
+return _7c.im_func.apply(_7c.im_self,arguments);
+};
+_7c.im_func=_7e;
+_7c.im_self=_7d;
+return _7c;
+};
+Freja._aux.formContents=function(_7f){
+if(!_7f){
+_7f=document;
+}
+var _80=[];
+var _81=[];
+var _82=_7f.getElementsByTagName("INPUT");
+for(var i=0;i<_82.length;++i){
+var _84=_82[i];
+if(_84.name){
+if(_84.type=="radio"||_84.type=="checkbox"){
+if(_84.checked){
+_80.push(_84.name);
+_81.push(_84.value);
+}else{
+_80.push(_84.name);
+_81.push("");
+}
+}else{
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+}
+var _85=_7f.getElementsByTagName("TEXTAREA");
+for(var i=0;i<_85.length;++i){
+var _84=_85[i];
+if(_84.name){
+_80.push(_84.name);
+_81.push(_84.value);
+}
+}
+var _86=_7f.getElementsByTagName("SELECT");
+for(var i=0;i<_86.length;++i){
+var _84=_86[i];
+if(_84.name){
+if(_84.selectedIndex>=0){
+var opt=_84.options[_84.selectedIndex];
+_80.push(_84.name);
+_81.push((opt.value)?opt.value:"");
+}
+}
+}
+return [_80,_81];
+};
+Freja._aux.getElement=function(id){
+if(typeof (id)=="object"){
+return id;
+}else{
+return document.getElementById(id);
+}
+};
+Freja._aux.connect=function(src,_8a,fnc){
+if(!src){
+return;
+}
+if(src.addEventListener){
+var _8c=function(e){
+var evt={stop:function(){
+if(e.cancelable){
+e.preventDefault();
+}
+e.stopPropagation();
+}};
+fnc(evt);
+};
+src.addEventListener(_8a.replace(/^(on)/,""),_8c,false);
+}else{
+if(src.attachEvent){
+var _8c=function(){
+var e=window.event;
+var evt={stop:function(){
+e.cancelBubble=true;
+e.returnValue=false;
+}};
+fnc(evt);
+};
+src.attachEvent(_8a,_8c);
+}
+}
+if(!src._signals){
+src._signals=[];
+}
+if(!src._signals[_8a]){
+src._signals[_8a]=[];
+}
+for(var _91=0;_91<src._signals[_8a].length;_91++){
+if(src._signals[_8a][_91].toString()==fnc.toString()){
+return;
+}
+}
+src._signals[_8a].push(fnc);
+};
+Freja._aux.signal=function(src,_93){
+try{
+var _94=src._signals[_93];
+var _95=[];
+for(var i=2;i<arguments.length;i++){
+_95.push(arguments[i]);
+}
+for(var i=0;i<_94.length;i++){
+try{
+_94[i].apply(src,_95);
+}
+catch(e){
+}
+}
+}
+catch(e){
+}
+};
+Freja._aux.createDeferred=function(){
+return new Freja._aux.Deferred();
+};
+Freja._aux.openXMLHttpRequest=function(_97,url,_99,_9a,_9b){
+var req=new XMLHttpRequest();
+if(_9a&&_9b){
+req.open(_97,url,_99,_9a,_9b);
+}else{
+req.open(_97,url,_99);
+}
+if(_97=="POST"||_97=="PUT"){
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}
+req.setRequestHeader("X-Requested-With","XMLHttpRequest");
+return req;
+};
+Freja._aux.sendXMLHttpRequest=function(req,_9e){
+var d=Freja._aux.createDeferred();
+var _a0=false;
+req.onreadystatechange=function(){
+if(req.readyState==4&&!_a0){
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+d.callback(req);
+}else{
+d.errback(req);
+}
+_a0=true;
+}
+};
+if(!_9e){
+_9e="";
+}
+req.send(_9e);
+return d;
+};
+Freja._aux.xmlize=Sarissa.xmlize;
+Freja._aux.serializeXML=function(_a1){
+if(_a1.xml){
+return _a1.xml;
+}
+return (new XMLSerializer()).serializeToString(_a1);
+};
+Freja._aux.loadXML=function(_a2){
+return (new DOMParser()).parseFromString(_a2,"text/xml");
+};
+Freja._aux.transformXSL=function(xml,xsl,_a5){
+var _a6=new XSLTProcessor();
+_a6.importStylesheet(xsl);
+if(_a5){
+for(var _a7 in _a5){
+_a6.setParameter("",_a7,_a5[_a7]);
+}
+}
+return _a6.transformToFragment(xml,window.document);
+};
+Freja._aux.cloneXMLDocument=function(_a8){
+var _a9=null;
+try{
+_a9=_a8.cloneNode(true);
+}
+catch(e){
+}
+if(!_a9){
+if(document.implementation&&document.implementation.createDocument){
+_a9=document.implementation.createDocument("",_a8.documentElement.nodeName,null);
+var _aa=_a9.importNode(_a8.documentElement.cloneNode(true),true);
+try{
+_a9.appendChild(_aa);
+}
+catch(e){
+var _ab=_a9.documentElement;
+for(var i=_aa.childNodes.length;i>=0;i--){
+_ab.insertBefore(_aa.childNodes[i],_ab.firstChild);
+}
+for(var i=0;i<_a8.documentElement.attributes.length;i++){
+var _ad=_a8.documentElement.attributes.item(i).name;
+var _ae=_a8.documentElement.attributes.item(i).value;
+_a9.documentElement.setAttribute(_ad,_ae);
+}
+}
+}
+}
+return _a9;
+};
+Freja._aux.hasSupportForXSLT=function(){
+return (typeof (XSLTProcessor)!="undefined");
+};
+Freja._aux.createQueryEngine=function(){
+if(Sarissa.IS_ENABLED_SELECT_NODES){
+return new Freja.QueryEngine.XPath();
+}else{
+return new Freja.QueryEngine.SimplePath();
+}
+};
+Freja._aux.Deferred=function(){
+this._good=[];
+this._bad=[];
+this._pending=null;
+};
+Freja._aux.Deferred.prototype.callback=function(){
+if(this._good.length==0){
+this._pending=[this.callback,arguments];
+return;
+}
+for(var i=0;i<this._good.length;i++){
+this._good[i].apply(window,arguments);
+}
+this._good=[];
+};
+Freja._aux.Deferred.prototype.errback=function(){
+if(this._bad.length==0){
+this._pending=[this.errback,arguments];
+return;
+}
+for(var i=0;i<this._bad.length;i++){
+this._bad[i].apply(window,arguments);
+}
+this._bad=[];
+};
+Freja._aux.Deferred.prototype.addCallbacks=function(_b1,_b2){
+if(_b1){
+this._good[this._good.length]=_b1;
+}
+if(_b2){
+this._bad[this._bad.length]=_b2;
+}
+if(this._pending){
+this._pending[0].apply(this,this._pending[1]);
+}
+};
+Freja._aux.Deferred.prototype.addCallback=function(_b3){
+this.addCallbacks(_b3);
+};
+Freja._aux.Deferred.prototype.addErrback=function(_b4){
+this.addCallbacks(null,_b4);
+};
+Freja.QueryEngine=function(){
+};
+Freja.QueryEngine.prototype.getElementById=function(_b5,id){
+var _b7=_b5.getElementsByTagName("*");
+for(var i=0;i<_b7.length;i++){
+if(_b7[i].getAttribute("id")==id){
+return _b7[i];
+}
+}
+};
+Freja.QueryEngine.prototype.get=function(_b9,_ba){
+var _bb=this._find(_b9,_ba);
+if(!_bb){
+throw new Error("Can't evaluate expression "+_ba);
+}
+switch(_bb.nodeType){
+case 1:
+if(_bb.firstChild&&(_bb.firstChild.nodeType==3||_bb.firstChild.nodeType==4)){
+return _bb.firstChild.nodeValue;
+}
+break;
+case 2:
+return _bb.nodeValue;
+break;
+case 3:
+case 4:
+return _bb.nodeValue;
+break;
+}
+return null;
+};
+Freja.QueryEngine.prototype.set=function(_bc,_bd,_be){
+var _bf=this._find(_bc,_bd);
+if(!_bf){
+var _c0=_bd.substr(_bd.lastIndexOf("/")+1);
+if(_c0.charAt(0)=="@"){
+var _c1=_bd.substring(0,_bd.lastIndexOf("/"));
+var _c2=this._find(_bc,_c1);
+if(_c2){
+_c2.setAttribute(_c0.substr(1),_be);
+return;
+}
+}
+throw new Error("Can't evaluate expression "+_bd);
+}
+switch(_bf.nodeType){
+case 1:
+if(_bf.firstChild&&(_bf.firstChild.nodeType==3||_bf.firstChild.nodeType==4)){
+_bf.firstChild.nodeValue=_be;
+}else{
+if(_be!=""){
+_bf.appendChild(_bc.createTextNode(_be));
+}
+}
+break;
+case 2:
+_bf.nodeValue=_be;
+break;
+case 3:
+case 4:
+_bf.nodeValue=_be;
+break;
+}
+return;
+};
+Freja.QueryEngine.XPath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find=function(_c3,_c4){
+var _c5=_c3.selectSingleNode(_c4);
+return _c5;
+};
+Freja.QueryEngine.SimplePath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find=function(_c6,_c7){
+if(!_c7.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error("Can't evaluate expression "+_c7);
+}
+var _c8=_c7.split("/");
+var _c9=_c6;
+var _ca=new RegExp("^@([\\d\\w]*)");
+var _cb=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+var _cc=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+var _cd=null;
+var _ce=0;
+for(var i=0;i<_c8.length;++i){
+var _d0=_c8[i];
+var _d1=_cc.exec(_d0);
+if(_d1){
+if(i>0&&_c8[i-1]==""){
+var cn=_c9.getElementsByTagName(_d1[1]);
+}else{
+var cn=_c9.childNodes;
+}
+for(var j=0,l=cn.length;j<l;j++){
+if(cn[j].nodeType==1&&cn[j].tagName==_d1[1]&&cn[j].getAttribute(_d1[2])==_d1[3]){
+_c9=cn[j];
+break;
+}
+}
+if(j==l){
+throw new Error("Can't evaluate expression "+_d0);
+}
+}else{
+_ce=_cb.exec(_d0);
+if(_ce){
+_d0=_ce[1];
+_ce=_ce[2]-1;
+}else{
+_ce=0;
+}
+if(_d0!=""){
+_cd=_ca.exec(_d0);
+if(_cd){
+_c9=_c9.getAttributeNode(_cd[1]);
+}else{
+_c9=_c9.getElementsByTagName(_d0).item(_ce);
+}
+}
+}
+}
+if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==3){
+return _c9.firstChild;
+}
+if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==4){
+return _c9.firstChild;
+}
+if(!_c9){
+throw new Error("Can't evaluate expression "+_c7);
+}
+return _c9;
+};
+Freja.Model=function(url,_d5){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._query=_d5;
+};
+Freja.Model.prototype.getElementById=function(id){
+if(this.document){
+return this._query.getElementById(this.document,id);
+}
+return null;
+};
+Freja.Model.prototype.get=function(_d7){
+if(this.document){
+return this._query.get(this.document,_d7);
+}
+return null;
+};
+Freja.Model.prototype.set=function(_d8,_d9){
+if(this.document){
+return this._query.set(this.document,_d8,_d9);
+}
+return null;
+};
+Freja.Model.prototype.updateFrom=function(_da){
+var _db=_da.getValues();
+for(var i=0;i<_db[0].length;++i){
+if(_db[0][i].lastIndexOf("/")!=-1){
+this.set(_db[0][i],_db[1][i]);
+}
+}
+};
+Freja.Model.prototype.save=function(){
+var url=this.url;
+var _de=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_de){
+url=_de[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var req=Freja.AssetManager.openXMLHttpRequest("POST",url);
+try{
+Freja._aux.sendXMLHttpRequest(req,Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback,d),Freja._aux.bind(d.errback,d));
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.Model.prototype.remove=function(){
+var url=this.url;
+var _e2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_e2){
+url=_e2[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("DELETE",url);
+return Freja._aux.sendXMLHttpRequest(req);
+};
+Freja.Model.prototype.reload=function(){
+this.ready=false;
+var _e4=Freja._aux.bind(function(_e5){
+this.document=_e5;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},this);
+var d=Freja.AssetManager.loadAsset(this.url,true);
+d.addCallbacks(_e4,Freja.AssetManager.onerror);
+return d;
+};
+Freja.Model.DataSource=function(_e7,_e8){
+this.createURL=_e7;
+this.indexURL=_e8;
+};
+Freja.Model.DataSource.prototype.select=function(){
+return getModel(this.indexURL);
+};
+Freja.Model.DataSource.prototype.create=function(_e9){
+var url=this.createURL;
+var _eb=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_eb){
+url=_eb[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("PUT",url);
+var _ed={};
+for(var i=0,len=_e9[0].length;i<len;++i){
+_ed[_e9[0][i]]=_e9[1][i];
+}
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_ed,"record"));
+};
+Freja.View=function(url,_f0){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._renderer=_f0;
+this._destination=null;
+this.behaviors=[];
+this.placeholder=null;
+Freja._aux.connect(this,"onrendercomplete",Freja._aux.bind(this._connectBehavior,this));
+};
+Freja.View.prototype.render=function(_f1,_f2,_f3){
+if(typeof (_f2)=="undefined"){
+_f2=this.placeholder;
+}
+if(typeof (_f3)=="undefined"){
+_f3=this.xslParameters;
+}
+var _f4=function(_f5,_f6,_f7,_f8){
+this.model=_f5;
+this.view=_f6;
+this.deferred=_f7;
+this.xslParameters=_f8;
+};
+_f4.prototype.trigger=function(){
+try{
+if(!this.view.ready){
+Freja._aux.connect(this.view,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+if(typeof (this.model)=="object"&&this.model instanceof Freja.Model&&!this.model.ready){
+Freja._aux.connect(this.model,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+var _f9;
+if(typeof (this.model)=="undefined"){
+_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+}else{
+if(this.model instanceof Freja.Model){
+_f9=this.model;
+}else{
+_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
+}
+}
+var _fa=this.view._renderer.transform(_f9,this.view,this.xslParameters);
+_fa.addCallback(Freja._aux.bind(function(_fb){
+if(typeof _fb=="string"){
+this._destination.innerHTML=_fb;
+}else{
+this._destination.innerHTML="";
+this._destination.appendChild(_fb);
+}
+},this.view));
+_fa.addCallback(Freja._aux.bind(function(){
+Freja._aux.signal(this,"onrendercomplete",this._destination);
+},this.view));
+_fa.addCallback(this.deferred.callback);
+_fa.addErrback(this.deferred.errback);
+}
+catch(ex){
+this.deferred.errback(ex);
+}
+};
+var d=Freja._aux.createDeferred();
+try{
+if(typeof (_f2)=="object"){
+this._destination=_f2;
+}else{
+this._destination=document.getElementById(_f2);
+}
+this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
+var h=new _f4(_f1,this,d,_f3);
+h.trigger();
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.prototype._connectBehavior=function(_fe){
+try{
+var _ff=function(node,_101,_102){
+Freja._aux.connect(node,_101,Freja._aux.bind(function(e){
+var _104=false;
+try{
+_104=_102(this);
+}
+catch(ex){
+throw new Error("An error ocurred in user handler.\n"+ex.message);
+}
+finally{
+if(!_104){
+e.stop();
+}
+}
+},node));
+};
+var _105=function(node,_107){
+for(var i=0,c=node.childNodes,l=c.length;i<l;++i){
+var _109=c[i];
+if(_109.nodeType==1){
+if(_109.className){
+var _10a=_109.className.split(" ");
+for(var j=0;j<_10a.length;j++){
+var _10c=_107[_10a[j]];
+if(_10c){
+for(var _10d in _10c){
+if(_10d=="init"){
+_10c.init(_109);
+}else{
+_ff(_109,_10d,_10c[_10d]);
+}
+}
+}
+}
+}
+_105(_109,_107);
+}
+}
+};
+for(var ids in this.behaviors){
+_105(_fe,this.behaviors);
+break;
+}
+}
+catch(ex){
+alert(ex.message);
+}
+};
+Freja.View.prototype.getValues=function(){
+return Freja._aux.formContents(this._destination);
+};
+Freja.View.Renderer=function(){
+};
+Freja.View.Renderer.XSLTransformer=function(){
+};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_10f,view,_111){
+var d=Freja._aux.createDeferred();
+try{
+var html=Freja._aux.transformXSL(_10f.document,view.document,_111);
+if(!html){
+d.errback(new Error("XSL Transformation error."));
+}else{
+d.callback(html);
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.Renderer.RemoteXSLTransformer=function(url){
+this.url=url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_115,view,_117){
+var d=Freja._aux.createDeferred();
+var _119=view.url;
+var _11a="xslFile="+encodeURIComponent(_119)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_115.document));
+var _11b="";
+for(var _11c in _117){
+_11b+=encodeURIComponent(_11c+","+_117[_11c]);
+}
+if(_11b.length>0){
+_11a=_11a+"&xslParam="+_11b;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
+req.onreadystatechange=function(){
+if(req.readyState==4){
+if(req.status==200){
+d.callback(req.responseText);
+}else{
+d.errback(req.responseText);
+}
+}
+};
+req.send(_11a);
+return d;
+};
+Freja.UndoHistory=function(){
+this.cache=[];
+this.maxLength=5;
+this._position=0;
+this._undoSteps=0;
+};
+Freja.UndoHistory.prototype.add=function(_11e){
+var _11f=this._position%this.maxLength;
+var _120=_11e.document;
+this.cache[_11f]={};
+this.cache[_11f].model=_11e;
+this.cache[_11f].document=Freja._aux.cloneXMLDocument(_120);
+if(!this.cache[_11f].document){
+throw new Error("Couldn't add to history.");
+}else{
+this._position++;
+var _121=_11f;
+while(this._undoSteps>0){
+_121=(_121+1)%this.maxLength;
+this.cache[_121]={};
+this._undoSteps--;
+}
+return _11f;
+}
+};
+Freja.UndoHistory.prototype.undo=function(_122){
+if(this._undoSteps<this.cache.length){
+this._undoSteps++;
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+var _123=this.cache[this._position].model;
+if(this.cache[this._position].document){
+_123.document=this.cache[this._position].document;
+}else{
+throw new Error("The model's DOMDocument wasn't properly copied into the history");
+}
+if(typeof (_122)!="undefined"&&_122>1){
+this.undo(_122-1);
+}
+}else{
+throw new Error("Nothing to undo");
+}
+};
+Freja.UndoHistory.prototype.redo=function(){
+if(this._undoSteps>0){
+this._undoSteps--;
+this._position=(this._position+1)%this.maxLength;
+var _124=this.cache[this._position].model;
+_124.document=this.cache[this._position].document;
+}else{
+throw new Error("Nothing to redo");
+}
+};
+Freja.UndoHistory.prototype.removeLast=function(){
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+this.cache[this._position]={};
+this._undoSteps=0;
+};
+Freja.AssetManager={models:[],views:[],_username:null,_password:null};
+Freja.AssetManager.HTTP_REQUEST_TYPE="async";
+Freja.AssetManager.HTTP_METHOD_TUNNEL="Http-Method-Equivalent";
+Freja.AssetManager.XSLT_SERVICE_URL="srvc-xslt.php";
+Freja.AssetManager.THROBBER_HTML="<span style='color:white;background:firebrick'>Loading ...</span>";
+Freja.AssetManager.createRenderer=function(){
+if(Freja._aux.hasSupportForXSLT()){
+return new Freja.View.Renderer.XSLTransformer();
+}else{
+return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+}
+};
+Freja.AssetManager.clearCache=function(){
+this.models=[];
+this.views=[];
+};
+Freja.AssetManager.getModel=function(url){
+for(var i=0;i<this.models.length;i++){
+if(this.models[i].url==url){
+return this.models[i];
+}
+}
+var m=new Freja.Model(url,Freja._aux.createQueryEngine());
+var _128=Freja._aux.bind(function(_129){
+this.document=_129;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},m);
+this.loadAsset(url,true).addCallbacks(_128,Freja.AssetManager.onerror);
+this.models.push(m);
+return m;
+};
+Freja.AssetManager.getView=function(url){
+for(var i=0;i<this.views.length;i++){
+if(this.views[i].url==url){
+return this.views[i];
+}
+}
+var v=new Freja.View(url,this.createRenderer());
+var _12d=Freja._aux.bind(function(_12e){
+this.document=_12e;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},v);
+this.loadAsset(url,false).addCallbacks(_12d,Freja.AssetManager.onerror);
+this.views.push(v);
+return v;
+};
+Freja.AssetManager.openXMLHttpRequest=function(_12f,url){
+var _131=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_12f!="GET"&&_12f!="POST"){
+_131=_12f;
+_12f="POST";
+}
+var req=Freja._aux.openXMLHttpRequest(_12f,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_131){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_131);
+}
+return req;
+};
+Freja.AssetManager.setCredentials=function(_133,_134){
+this._username=_133;
+this._password=_134;
+};
+Freja.AssetManager.loadAsset=function(url,_136){
+var _137=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_137){
+url=_137[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var _139=function(_13a){
+try{
+if(_13a.responseText==""){
+throw new Error("Empty response.");
+}
+if(_13a.responseXML.xml==""){
+var _13b=Freja._aux.loadXML(_13a.responseText);
+}else{
+var _13b=_13a.responseXML;
+}
+}
+catch(ex){
+d.errback(ex);
+}
+if(window.document.all){
+setTimeout(function(){
+d.callback(_13b);
+},1);
+}else{
+d.callback(_13b);
+}
+};
+try{
+if(_136&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}else{
+var req=Freja._aux.openXMLHttpRequest("GET",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+}
+var comm=Freja._aux.sendXMLHttpRequest(req);
+if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
+comm.addCallbacks(_139,function(req){
+d.errback(new Error("Request failed:"+req.status));
+});
+}else{
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+_139(req);
+}else{
+d.errback(new Error("Request failed:"+req.status));
+}
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.AssetManager.onerror=function(ex){
+alert("Freja.AssetManager.onerror\n"+ex.message);
+};
+window.getModel=Freja._aux.bind("getModel",Freja.AssetManager);
+window.getView=Freja._aux.bind("getView",Freja.AssetManager);
+

Added: trunk/lib/mochi+sarissa/Freja.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,1229 @@
+/***
+
+    Freja 2.1
+
+    Build $Wed, 21 Mar 2007 15:06:18 UTC$
+
+    Target: mochi+sarissa
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    Copyright (c) 2006-2007 Cedric Savarese <cedric at veerwest.com>, Troels Knak-Nielsen <troelskn at gmail.com>
+    This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>
+
+***/
+
+if (typeof(dojo) != "undefined") {
+	dojo.provide("Freja");
+}
+if (typeof(Freja) == "undefined") {
+	Freja = {};
+}
+Freja.NAME = "Freja";
+Freja.VERSION = "2.1";
+Freja.__repr__ = function () {
+	return "[" + this.NAME + " " + this.VERSION + "]";
+};
+Freja.toString = function () {
+	return this.__repr__();
+};
+/**
+  * Single-hierarchy inheritance (class emulation)
+  * @see    http://www.itsalleasy.com/2006/02/05/prototype-chain/
+  *         http://www.itsalleasy.com/2006/02/24/classjs-third-time-is-the-charm/
+  *
+  * Extends one prototype by another.
+  * The subtype will have two specialpurpose properties:
+  *     superconstructor    The parent prototype's constructor
+  *     supertype        The parent prototype
+  */
+Freja.Class = {};
+Freja.Class.extend = function(subClass, superconstructor) {
+	var inlineSuper = function(){};
+	inlineSuper.prototype = superconstructor.prototype;
+	subClass.prototype = new inlineSuper();
+	subClass.prototype.constructor = subClass;
+	subClass.prototype.superconstructor = superconstructor;
+	subClass.prototype.supertype = superconstructor.prototype;
+};
+/**
+  * Freja._aux
+  * wrapper for external dependencies (frameworks).
+  *
+  * This is the default auxiliary adapter. It bridges Freja to MochiKit + Sarissa
+  *
+  * You shouldn't rely on this functionality - it's merely a hook for Freja towards
+  * external dependencies. This is the only part of the application you'll need to
+  * adjust, to make Freja play ball with your favourite framework.
+  */
+if (typeof(dojo) != "undefined") {
+	dojo.require("MochiKit.Base");
+	dojo.require("MochiKit.Signal");
+	dojo.require("MochiKit.Async");
+	dojo.require("Sarissa");
+}
+if (typeof(JSAN) != "undefined") {
+	JSAN.use("MochiKit.Base", []);
+	JSAN.use("MochiKit.Signal", []);
+	JSAN.use("MochiKit.Async", []);
+	JSAN.use("Sarissa", []);
+}
+try {
+	if (typeof(MochiKit.Base) == "undefined") {
+		throw "";
+	}
+	if (typeof(MochiKit.Signal) == "undefined") {
+		throw "";
+	}
+	if (typeof(MochiKit.Async) == "undefined") {
+		throw "";
+	}
+	if (typeof(Sarissa) == "undefined") {
+		throw "";
+	}
+} catch (e) {
+	throw new Error("Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!");
+}
+if (typeof(Freja) == "undefined") {
+	Freja = {};
+}
+Freja._aux = {};
+/** bind(func, self) : function */
+Freja._aux.bind = MochiKit.Base.bind;
+/** formContents(elem) : Array */
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName("INPUT");
+	for (var i = 0; i < inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == "radio" || input.type == "checkbox") {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push("");
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName("TEXTAREA");
+	for (var i = 0; i < textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName("SELECT");
+	for (var i = 0; i < selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex >= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : "");
+			}
+		}
+	}
+	return [names, values];
+};
+
+/** getElement(id) : HTMLElement */
+Freja._aux.getElement = MochiKit.DOM.getElement;
+
+/** connect(src, signal, fnc) : void */
+Freja._aux.connect = MochiKit.Signal.connect;
+/** signal(src, signal, arg) : void */
+Freja._aux.signal = MochiKit.Signal.signal;
+/** createDeferred() : Deferred */
+Freja._aux.createDeferred = function() {
+	return new MochiKit.Async.Deferred();
+};
+/** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
+Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
+	var req = new XMLHttpRequest();
+	if (user && pass) {
+		req.open(method, url, async, user, pass);
+	} else {
+		req.open(method, url, async);
+	}
+	if (method == "POST" || method == "PUT") {
+		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
+	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
+	return req;
+};
+/** sendXMLHttpRequest(req, sendContent) : Deferred */
+Freja._aux.sendXMLHttpRequest = MochiKit.Async.sendXMLHttpRequest;
+/** xmlize(anyObject, objectName) : string */
+Freja._aux.xmlize = Sarissa.xmlize;
+/** serializeXML(node) : string */
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
+/** loadXML(string) : XMLDocument */
+Freja._aux.loadXML = function(text) {
+	return (new DOMParser()).parseFromString(text, "text/xml");
+};
+/** transformXSL(XMLDocument, XSLDocument) : string */
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter("", paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
+};
+/** cloneXMLDocument(document) : XMLDocument */
+Freja._aux.cloneXMLDocument = function(xmlDoc) {
+	var clone = null;
+	try {
+		clone = xmlDoc.cloneNode(true);
+	} catch(e) { /* squelch */ }
+	
+	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
+	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
+	if (!clone) {
+		if (document.implementation && document.implementation.createDocument) {
+			clone = document.implementation.createDocument("", xmlDoc.documentElement.nodeName, null);
+			// importNode is not safe in Safari ! the source document is altered. used cloneNode to fix the prblm
+			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
+			try {
+				clone.appendChild(data);
+			} catch(e) {				
+				// Opera has already created a documentElement and can't append another root node
+				var rootNode = clone.documentElement;
+			
+				for (var i = data.childNodes.length-1; i >= 0; i--) {
+					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
+				}
+				
+				// need to copy root node attributes
+				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
+					var name  = xmlDoc.documentElement.attributes.item(i).name;
+					var value = xmlDoc.documentElement.attributes.item(i).value;
+					clone.documentElement.setAttribute(name, value);
+				}				
+			}
+		}
+	}
+	
+	return clone;
+};
+
+/** hasSupportForXSLT() : boolean */
+Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
+/** createQueryEngine() : Freja.QueryEngine */
+Freja._aux.createQueryEngine = function() {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
+		return new Freja.QueryEngine.XPath();
+	} else {
+		return new Freja.QueryEngine.SimplePath();
+	}
+};
+
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
+  * The baseclass for queryengines
+  * @abstract
+  */
+Freja.QueryEngine = function() {};
+Freja.QueryEngine.prototype.getElementById = function(document, id) {
+	// getElementById doesn't work on XML document without xml:id
+	var allElements = document.getElementsByTagName("*");
+	for (var i= 0; i < allElements.length; i++) {
+		if (allElements[i].getAttribute("id") == id) {
+			return allElements[i];
+		}
+	}
+};
+Freja.QueryEngine.prototype.get = function(document, expression) {
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error("Can't evaluate expression " + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
+	}
+	return null;
+};
+Freja.QueryEngine.prototype.set = function(document, expression, value) {
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
+			}
+			// else parent node non existent either, give up.
+		}
+		// not an attribute, give up.
+		throw new Error("Can't evaluate expression " + expression);
+	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!="") // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
+};
+/**
+  * XPath query engine.
+  */
+Freja.QueryEngine.XPath = function() {};
+Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
+};
+/**
+  * SimplePath
+  */
+Freja.QueryEngine.SimplePath = function() {};
+Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
+	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
+		throw new Error("Can't evaluate expression " + expression);
+	}
+	var parts = expression.split("/");
+	var node = document;
+	var regAttr = new RegExp("^@([\\d\\w]*)");
+	var regOffset = new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+	var regFilter = new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+	var attr = null;
+	var offset = 0;
+	for (var i = 0; i < parts.length; ++i) {
+		var part = parts[i];
+		var filter = regFilter.exec(part);
+		if(filter) {
+			// filter[1] element name, filter[2] attribute name, filter[3] attribute value
+			if(i>0 && parts[i-1]=='') {
+				// expression was of type //element[...]
+				var cn = node.getElementsByTagName(filter[1]);
+			} else {
+				var cn = node.childNodes;
+			}
+			for(var j=0, l=cn.length; j<l ; j++) {
+				if(cn[j].nodeType==1 && cn[j].tagName==filter[1] && cn[j].getAttribute(filter[2])== filter[3]) {
+					node = cn[j];
+					break;
+				}
+			}
+			if (j==l)
+				throw new Error("Can't evaluate expression " + part);
+		}
+		else {
+			offset = regOffset.exec(part);
+			if (offset) {
+				part = offset[1];
+				offset = offset[2] - 1;
+			} else {
+				offset = 0;
+			}
+			if (part != "") {
+				attr = regAttr.exec(part);
+				if (attr) {
+					node = node.getAttributeNode(attr[1]);
+				} else {
+					node = node.getElementsByTagName(part).item(offset);
+				}
+			}
+		}
+	}
+	if (node && node.firstChild && node.firstChild.nodeType == 3) {
+		return node.firstChild;
+	}
+	if (node && node.firstChild && node.firstChild.nodeType == 4) {
+		return node.firstChild;
+	}
+
+	if (!node) {
+		throw new Error("Can't evaluate expression " + expression);
+	}
+	return node;
+};
+/**
+  * Standard model component
+  */
+Freja.Model = function(url, query) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._query = query;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.getElementById = function(id) {
+	if (this.document) {
+		return this._query.getElementById(this.document, id);
+	}
+	return null;
+};
+/**
+  * Returns a single value
+  */
+Freja.Model.prototype.get = function(expression) {
+	if (this.document) {
+		return this._query.get(this.document, expression);
+	}
+	return null;
+};
+/**
+  * Updates a value
+  */
+Freja.Model.prototype.set = function(expression, value) {
+	if (this.document) {
+		return this._query.set(this.document, expression, value);
+	}
+	return null;
+};
+/**
+  * Updates the model from a view
+  */
+Freja.Model.prototype.updateFrom = function(view) {
+	var values = view.getValues();
+	for (var i = 0; i < values[0].length; ++i) {
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
+	}
+};
+/**
+  * Writes the model back to the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.save = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	// since the serialization may fail, we create a deferred for the
+	// purpose, rather than just returning the sendXMLHttpRequest directly.
+	var d = Freja._aux.createDeferred();
+	var req = Freja.AssetManager.openXMLHttpRequest("POST", url);
+	try {
+		// for some obscure reason exceptions aren't thrown back if I call the
+		// shorthand version of sendXMLHttpRequest in IE6.
+		Freja._aux.sendXMLHttpRequest(req, Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback, d), Freja._aux.bind(d.errback, d));
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Deletes the model from the remote service
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.remove = function() {
+	var url = this.url;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest("DELETE", url);
+	return Freja._aux.sendXMLHttpRequest(req);
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.Model.prototype.reload = function() {
+	this.ready = false;
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, this);
+	var d = Freja.AssetManager.loadAsset(this.url, true);
+	d.addCallbacks(onload, Freja.AssetManager.onerror);
+	return d;
+};
+/**
+  * DataSource provides a gateway-type interface to a REST service.
+  */
+Freja.Model.DataSource = function(createURL, indexURL) {
+	this.createURL = createURL;
+	this.indexURL = indexURL;
+};
+/**
+  * Returns a list of primary-keys to records in the datasource
+  */
+Freja.Model.DataSource.prototype.select = function() {
+	return getModel(this.indexURL);
+};
+/**
+  * Creates a new instance of a record
+  * @todo errback to the deferred on errors
+  */
+Freja.Model.DataSource.prototype.create = function(values) {
+	var url = this.createURL;
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var req = Freja.AssetManager.openXMLHttpRequest("PUT", url);
+	var payload = {};
+	for (var i = 0, len = values[0].length; i < len; ++i) {
+		payload[values[0][i]] = values[1][i];
+	}
+	return Freja._aux.sendXMLHttpRequest(req, Freja._aux.xmlize(payload, 'record'));
+};
+
+/**
+  * Standard view component
+  */
+Freja.View = function(url, renderer) {
+	this.url = url;
+	this.ready = false;
+	this.document = null;
+	this._renderer = renderer;
+	this._destination = null;
+	this.behaviors = [];
+	this.placeholder = null;
+	Freja._aux.connect(this, "onrendercomplete", Freja._aux.bind(this._connectBehavior, this));
+};
+/**
+  * @param    model            Freja.Model
+  * @param    placeholder      string    If supplied, this will be used instead of the
+  *                                      default placeholder.
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.prototype.render = function(model, placeholder, xslParameters) {
+	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
+	if (typeof(xslParameters) == "undefined") xslParameters = this.xslParameters;
+
+	var Handler = function(model, view, deferred, xslParameters) {
+		this.model = model;
+		this.view = view;
+		this.deferred = deferred;
+		this.xslParameters = xslParameters;
+	};
+	Handler.prototype.trigger = function() {
+		try {
+			if (!this.view.ready) {
+				Freja._aux.connect(this.view, "onload", Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			if (typeof(this.model) == "object" && this.model instanceof Freja.Model && !this.model.ready) {
+				Freja._aux.connect(this.model, "onload", Freja._aux.bind(this.trigger, this));
+				return;
+			}
+			var model;
+			if (typeof(this.model) == "undefined") {
+				// supply dummy
+				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+			} else if (this.model instanceof Freja.Model) {
+				model = this.model;
+			} else {
+				// wrap pojo's in
+				model = { document : Freja._aux.loadXML("<?xml version='1.0' ?>\n" + Freja._aux.xmlize(this.model, "item")) };
+			}
+
+			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
+			trans.addCallback(Freja._aux.bind(function(html) {
+				if(typeof html == "string") {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = "";   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
+			}, this.view));
+			trans.addCallback(Freja._aux.bind(function() {
+				Freja._aux.signal(this, "onrendercomplete", this._destination)
+			}, this.view));
+			trans.addCallback(this.deferred.callback);
+			trans.addErrback(this.deferred.errback);
+		} catch (ex) {
+			this.deferred.errback(ex);
+		}
+	};
+
+	var d = Freja._aux.createDeferred();
+	try {
+		if (typeof(placeholder) == "object") {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
+		// @todo    Is this a good idea ?
+		// Perhaps we should leave it to the programmer to do this.
+		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
+
+		var h = new Handler(model, this, d, xslParameters);
+		h.trigger();
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * Decorates the output of the primary renderer, to inject behavior.
+  * @note Maybe we could use cssQuery (http://dean.edwards.name/my/cssQuery/)
+  *       to identify targets for behavior
+  */
+Freja.View.prototype._connectBehavior = function(destination) {
+	try {
+		var connectCallback = function(node, eventType, callback) {
+
+			Freja._aux.connect(node, eventType, Freja._aux.bind(
+				function(e) {
+					var allow = false;
+					try {
+						allow = callback(this);
+					} catch (ex) {
+						throw new Error("An error ocurred in user handler.\n" + ex.message);
+					} finally {
+						if (!allow) {
+							e.stop();
+						}
+					}
+				}, node)
+			);
+		};
+		var applyHandlers = function(node, behaviors) {
+			for (var i = 0, c = node.childNodes, l = c.length; i < l; ++i) {
+				var child = c[i];
+				if (child.nodeType == 1) {
+					if(child.className) {
+						var classNames = child.className.split(' ');
+						for (var j=0;j<classNames.length;j++) {
+							var handler = behaviors[classNames[j]];
+							if (handler) {
+								for (var eventType in handler) {
+									if (eventType == "init") {
+										handler.init(child);
+									} else {
+										connectCallback(child, eventType, handler[eventType]);
+									}
+								}
+							}
+						}
+					}
+					applyHandlers(child, behaviors);
+				}
+			}
+		};
+
+		// Avoid traversing the DOM tree if there's no handler to process.
+		// @note: is there a better way? this.behaviors.length is always 0.
+		// @note  This is fine. behaviors is a hashmap, not an array.
+		for (var ids in this.behaviors) {
+			applyHandlers(destination, this.behaviors);
+			break;
+		}
+
+	} catch (ex) {
+		alert(ex.message);
+	}
+};
+/**
+  * Returns the values of a formview
+  */
+Freja.View.prototype.getValues = function() {
+	return Freja._aux.formContents(this._destination);
+};
+/**
+  * Base object for viewrenderers
+  */
+Freja.View.Renderer = function() {};
+/**
+  * XSLT based render-engine
+  */
+Freja.View.Renderer.XSLTransformer = function() {};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+        try {
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+		if (!html) {
+			d.errback(new Error("XSL Transformation error."));
+		} else {
+			d.callback(html);
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * XSLT on a remote service for browser which have no native support.
+  * @param    url    URL of the transform service
+  */
+Freja.View.Renderer.RemoteXSLTransformer = function(url) {
+	this.url = url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
+        var d = Freja._aux.createDeferred();
+
+	// prepare posted data  (no need to send the XSL document, just its url)
+	var xslUrl = view.url;
+	var postedData = "xslFile=" + encodeURIComponent(xslUrl) + "&xmlData=" + encodeURIComponent(Freja._aux.serializeXML(model.document));
+
+	var xslParameterString = '';
+	for (var paramname in xslParameters) {
+		xslParameterString += encodeURIComponent(paramname + "," + xslParameters[paramname]);
+	}
+	if(xslParameterString.length > 0) {
+		postedData  = postedData + '&xslParam=' + xslParameterString;
+	}
+
+	// send request to the server-side XSL transformation service
+	var req = Freja.AssetManager.openXMLHttpRequest("POST", Freja.AssetManager.XSLT_SERVICE_URL);
+	req.onreadystatechange = function() {
+		if (req.readyState == 4) {
+			if (req.status == 200) {
+				d.callback(req.responseText);
+			} else {
+				d.errback(req.responseText);
+			}
+		}
+	}
+	req.send(postedData);
+	return d;
+};
+/**
+  * This is largely s copied with minor stylistic adjustments from Freja 1.1
+  * I renamed it from Controller.history to distinguish between window.history
+  */
+Freja.UndoHistory = function() {
+	this.cache = [];
+	this.maxLength = 5;
+	this._position = 0;
+	this._undoSteps = 0;
+};
+/**
+  * Creates a snapshot of the model and stores it.
+  */
+Freja.UndoHistory.prototype.add = function(model) {
+	var historyIndex = this._position % this.maxLength;
+
+	var modelDoc = model.document;
+	this.cache[historyIndex] = {};
+	this.cache[historyIndex].model = model;
+	this.cache[historyIndex].document = Freja._aux.cloneXMLDocument(modelDoc);
+
+	if (!this.cache[historyIndex].document) {
+		throw new Error("Couldn't add to history.");
+	} else {
+		this._position++;
+		// clear rest of the history if undo was used.
+		var clearHistoryIndex = historyIndex;
+		while (this._undoSteps > 0) {
+			clearHistoryIndex = (clearHistoryIndex + 1) % this.maxLength;
+			this.cache[clearHistoryIndex] = {};
+			this._undoSteps--;
+		}
+		return historyIndex; // what would anybody need this for ?
+	}
+};
+/**
+  * Rolls the state back one step.
+  */
+Freja.UndoHistory.prototype.undo = function(steps) {
+	if (this._undoSteps < this.cache.length) {
+		this._undoSteps++;
+		this._position--;
+		if (this._position < 0) {
+			this._position = this.maxLength - 1;
+		}
+
+		var model = this.cache[this._position].model;
+		if (this.cache[this._position].document) {
+			model.document = this.cache[this._position].document;
+		} else {
+			throw new Error("The model's DOMDocument wasn't properly copied into the history");
+		}
+		if (typeof(steps) != "undefined" && steps > 1) {
+			this.undo(steps - 1);
+		}
+	} else {
+		throw new Error("Nothing to undo");
+	}
+};
+/**
+  * Reverts the effects of undo.
+  */
+Freja.UndoHistory.prototype.redo = function() {
+	if (this._undoSteps > 0) {
+		this._undoSteps--;
+		this._position = (this._position + 1) % this.maxLength;
+
+		var model = this.cache[this._position].model;
+		model.document = this.cache[this._position].document;
+	} else {
+		throw new Error("Nothing to redo");
+	}
+};
+/**
+  * Removes the last entry in the cache
+  */
+Freja.UndoHistory.prototype.removeLast = function() {
+	this._position--;
+
+	if (this._position < 0) {
+		this._position = this.maxLength - 1;
+	}
+	this.cache[this._position] = {};
+	this._undoSteps = 0;
+};
+
+/**
+  * main repository
+  * @static
+  */
+Freja.AssetManager = {
+	models : [],
+	views : [],
+	_username : null,
+	_password : null
+};
+/**
+  * Set to sync to make all requests synchroneous. You shouldn't use
+  * this setting for anything but testing/debugging.
+  * "async" | "sync"
+  */
+Freja.AssetManager.HTTP_REQUEST_TYPE = "async";
+/**
+  * If this is set to null, real PUT and DELETE http-requests will be made,
+  * otherwise a header will be set instead, and the request tunneled through
+  * POST.
+  *
+  * Both IE6 and FF1.5 are known to support the required HTTP methods, so
+  * if theese are your target platform, you can disable tunneling.
+  */
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
+/**
+  * Set this url to provide remote xslt-transformation for browsers that
+  * doesn't support it natively.
+  */
+Freja.AssetManager.XSLT_SERVICE_URL = "srvc-xslt.php";
+/**
+  * HTML displayed while waiting for stuff to happen
+  */
+Freja.AssetManager.THROBBER_HTML = "<span style='color:white;background:firebrick'>Loading ...</span>";
+/**
+  * returns an instance of the renderengine to use
+  */
+Freja.AssetManager.createRenderer = function() {
+//	return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	if (Freja._aux.hasSupportForXSLT()) {
+		return new Freja.View.Renderer.XSLTransformer();
+	} else {
+		return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+	}
+};
+/**
+  * Wipes all caches. This isn't something you will normally use during production,
+  * but it's very helpful for debugging/testing
+  */
+Freja.AssetManager.clearCache = function() {
+	this.models = [];
+	this.views = [];
+};
+/**
+  * Load a model-component
+  * @param    url      string
+  */
+Freja.AssetManager.getModel = function(url) {
+	for (var i=0; i < this.models.length; i++) {
+		if (this.models[i].url == url) {
+			return this.models[i];
+		}
+	}
+	var m = new Freja.Model(url, Freja._aux.createQueryEngine());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, m);
+	this.loadAsset(url, true).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.models.push(m);
+	return m;
+};
+/**
+  * Load a view-component
+  * @param    url      string
+  */
+Freja.AssetManager.getView = function(url) {
+	for (var i=0; i < this.views.length; i++) {
+		if (this.views[i].url == url) {
+			return this.views[i];
+		}
+	}
+	var v = new Freja.View(url, this.createRenderer());
+	var onload = Freja._aux.bind(function(document) {
+		this.document = document;
+		this.ready = true;
+		Freja._aux.signal(this, "onload");
+	}, v);
+	this.loadAsset(url, false).addCallbacks(onload, Freja.AssetManager.onerror);
+	this.views.push(v);
+	return v;
+};
+/**
+  * Creates and opens a http-request, tunneling exotic methods if needed.
+  */
+Freja.AssetManager.openXMLHttpRequest = function(method, url) {
+	var tunnel = null;
+	if (Freja.AssetManager.HTTP_METHOD_TUNNEL && method != "GET" && method != "POST") {
+		tunnel = method;
+		method = "POST";
+	}
+	var req = Freja._aux.openXMLHttpRequest(method, url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+	if (tunnel) {
+		req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, tunnel);
+	}
+	return req;
+};
+/**
+  * Sets username + password for Http-Authentication
+  */
+Freja.AssetManager.setCredentials = function(username, password) {
+	this._username = username;
+	this._password = password;
+};
+/**
+  * @returns Freja._aux.Deferred
+  */
+Freja.AssetManager.loadAsset = function(url, preventCaching) {
+	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+	if (match) {
+		url = match[1] + url; // local
+	}
+	var d = Freja._aux.createDeferred();
+	var handler = function(transport) {
+		try {
+			if (transport.responseText == "") {
+				throw new Error("Empty response.");
+			}
+			if (transport.responseXML.xml == "") {
+				// The server doesn't reply with Content-Type: text/xml
+				// this will happen if the file is loaded locally (through file://)
+				var document = Freja._aux.loadXML(transport.responseText);
+			} else {
+				var document = transport.responseXML;
+			}
+		} catch (ex) {
+			d.errback(ex);
+		}
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
+	};
+	try {
+		// Why using HTTP_METHOD_TUNNEL for a GET?
+		//-- to prevent caching, since browsers won't cache a POST
+		if (preventCaching && Freja.AssetManager.HTTP_METHOD_TUNNEL) {
+			var req = Freja._aux.openXMLHttpRequest("POST", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+			req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL, "GET");
+			req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
+		} else {
+			var req = Freja._aux.openXMLHttpRequest("GET", url, Freja.AssetManager.HTTP_REQUEST_TYPE == "async", Freja.AssetManager._username, Freja.AssetManager._password);
+		}
+
+		// This shouldn't be nescesary, but alas it is - firefox chokes
+		// It's probably due to an error in MochiKit, so the problem
+		// should be fixed there.
+		var comm = Freja._aux.sendXMLHttpRequest(req);
+		if (Freja.AssetManager.HTTP_REQUEST_TYPE == "async") {
+			// fixes bug #7189 (http://developer.berlios.de/bugs/?func=detailbug&group_id=6277&bug_id=7189)
+			comm.addCallbacks(handler, function(req) {
+				d.errback(new Error("Request failed:" + req.status));
+			});
+		} else {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
+				handler(req);
+			} else {
+				d.errback(new Error("Request failed:" + req.status));
+			}
+		}
+	} catch (ex) {
+		d.errback(ex);
+	}
+	return d;
+};
+/**
+  * This is a default error-handler. You should provide your own.
+  * The handler is called if an asynchronous error happens, since
+  * this could not be caught with the usual try ... catch
+  *
+  * It ought to be replaced completely with Deferred
+  */
+Freja.AssetManager.onerror = function(ex) {
+	alert("Freja.AssetManager.onerror\n" + ex.message);
+};
+/**
+  * Global exports
+  */
+window.getModel = Freja._aux.bind("getModel", Freja.AssetManager);
+window.getView = Freja._aux.bind("getView", Freja.AssetManager);
\ No newline at end of file

Added: trunk/lib/mochi+sarissa/Freja_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,851 @@
+if(typeof (dojo)!="undefined"){
+dojo.provide("Freja");
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja.NAME="Freja";
+Freja.VERSION="2.1";
+Freja.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+Freja.toString=function(){
+return this.__repr__();
+};
+Freja.Class={};
+Freja.Class.extend=function(_1,_2){
+var _3=function(){
+};
+_3.prototype=_2.prototype;
+_1.prototype=new _3();
+_1.prototype.constructor=_1;
+_1.prototype.superconstructor=_2;
+_1.prototype.supertype=_2.prototype;
+};
+if(typeof (dojo)!="undefined"){
+dojo.require("MochiKit.Base");
+dojo.require("MochiKit.Signal");
+dojo.require("MochiKit.Async");
+dojo.require("Sarissa");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+JSAN.use("MochiKit.Signal",[]);
+JSAN.use("MochiKit.Async",[]);
+JSAN.use("Sarissa",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+if(typeof (MochiKit.Signal)=="undefined"){
+throw "";
+}
+if(typeof (MochiKit.Async)=="undefined"){
+throw "";
+}
+if(typeof (Sarissa)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw new Error("Freja depends on MochiKit.Base, MochiKit.Signal, MochiKit.Async and Sarissa!");
+}
+if(typeof (Freja)=="undefined"){
+Freja={};
+}
+Freja._aux={};
+Freja._aux.bind=MochiKit.Base.bind;
+Freja._aux.formContents=function(_4){
+if(!_4){
+_4=document;
+}
+var _5=[];
+var _6=[];
+var _7=_4.getElementsByTagName("INPUT");
+for(var i=0;i<_7.length;++i){
+var _9=_7[i];
+if(_9.name){
+if(_9.type=="radio"||_9.type=="checkbox"){
+if(_9.checked){
+_5.push(_9.name);
+_6.push(_9.value);
+}else{
+_5.push(_9.name);
+_6.push("");
+}
+}else{
+_5.push(_9.name);
+_6.push(_9.value);
+}
+}
+}
+var _a=_4.getElementsByTagName("TEXTAREA");
+for(var i=0;i<_a.length;++i){
+var _9=_a[i];
+if(_9.name){
+_5.push(_9.name);
+_6.push(_9.value);
+}
+}
+var _b=_4.getElementsByTagName("SELECT");
+for(var i=0;i<_b.length;++i){
+var _9=_b[i];
+if(_9.name){
+if(_9.selectedIndex>=0){
+var _c=_9.options[_9.selectedIndex];
+_5.push(_9.name);
+_6.push((_c.value)?_c.value:"");
+}
+}
+}
+return [_5,_6];
+};
+Freja._aux.getElement=MochiKit.DOM.getElement;
+Freja._aux.connect=MochiKit.Signal.connect;
+Freja._aux.signal=MochiKit.Signal.signal;
+Freja._aux.createDeferred=function(){
+return new MochiKit.Async.Deferred();
+};
+Freja._aux.openXMLHttpRequest=function(_d,_e,_f,_10,_11){
+var req=new XMLHttpRequest();
+if(_10&&_11){
+req.open(_d,_e,_f,_10,_11);
+}else{
+req.open(_d,_e,_f);
+}
+if(_d=="POST"||_d=="PUT"){
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}
+req.setRequestHeader("X-Requested-With","XMLHttpRequest");
+return req;
+};
+Freja._aux.sendXMLHttpRequest=MochiKit.Async.sendXMLHttpRequest;
+Freja._aux.xmlize=Sarissa.xmlize;
+Freja._aux.serializeXML=function(_13){
+if(_13.xml){
+return _13.xml;
+}
+return (new XMLSerializer()).serializeToString(_13);
+};
+Freja._aux.loadXML=function(_14){
+return (new DOMParser()).parseFromString(_14,"text/xml");
+};
+Freja._aux.transformXSL=function(xml,xsl,_17){
+var _18=new XSLTProcessor();
+_18.importStylesheet(xsl);
+if(_17){
+for(var _19 in _17){
+_18.setParameter("",_19,_17[_19]);
+}
+}
+return _18.transformToFragment(xml,window.document);
+};
+Freja._aux.cloneXMLDocument=function(_1a){
+var _1b=null;
+try{
+_1b=_1a.cloneNode(true);
+}
+catch(e){
+}
+if(!_1b){
+if(document.implementation&&document.implementation.createDocument){
+_1b=document.implementation.createDocument("",_1a.documentElement.nodeName,null);
+var _1c=_1b.importNode(_1a.documentElement.cloneNode(true),true);
+try{
+_1b.appendChild(_1c);
+}
+catch(e){
+var _1d=_1b.documentElement;
+for(var i=_1c.childNodes.length-1;i>=0;i--){
+_1d.insertBefore(_1c.childNodes[i],_1d.firstChild);
+}
+for(var i=0;i<_1a.documentElement.attributes.length;i++){
+var _1f=_1a.documentElement.attributes.item(i).name;
+var _20=_1a.documentElement.attributes.item(i).value;
+_1b.documentElement.setAttribute(_1f,_20);
+}
+}
+}
+}
+return _1b;
+};
+Freja._aux.hasSupportForXSLT=function(){
+return (typeof (XSLTProcessor)!="undefined");
+};
+Freja._aux.createQueryEngine=function(){
+if(Sarissa.IS_ENABLED_SELECT_NODES){
+return new Freja.QueryEngine.XPath();
+}else{
+return new Freja.QueryEngine.SimplePath();
+}
+};
+if(_SARISSA_HAS_DOM_FEATURE&&document.implementation.hasFeature("XPath","3.0")){
+function SarissaNodeList(i){
+this.length=i;
+}
+SarissaNodeList.prototype=new Array(0);
+SarissaNodeList.prototype.constructor=Array;
+SarissaNodeList.prototype.item=function(i){
+return (i<0||i>=this.length)?null:this[i];
+};
+SarissaNodeList.prototype.expr="";
+if(window.XMLDocument&&(!XMLDocument.prototype.setProperty)){
+XMLDocument.prototype.setProperty=function(x,y){
+};
+}
+Sarissa.setXpathNamespaces=function(_25,_26){
+_25._sarissa_useCustomResolver=true;
+var _27=_26.indexOf(" ")>-1?_26.split(" "):new Array(_26);
+_25._sarissa_xpathNamespaces=new Array(_27.length);
+for(var i=0;i<_27.length;i++){
+var ns=_27[i];
+var _2a=ns.indexOf(":");
+var _2b=ns.indexOf("=");
+if(_2a>0&&_2b>_2a+1){
+var _2c=ns.substring(_2a+1,_2b);
+var uri=ns.substring(_2b+2,ns.length-1);
+_25._sarissa_xpathNamespaces[_2c]=uri;
+}else{
+throw "Bad format on namespace declaration(s) given";
+}
+}
+};
+XMLDocument.prototype._sarissa_useCustomResolver=false;
+XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
+XMLDocument.prototype.selectNodes=function(_2e,_2f,_30){
+var _31=this;
+var _32=this._sarissa_useCustomResolver?function(_33){
+var s=_31._sarissa_xpathNamespaces[_33];
+if(s){
+return s;
+}else{
+throw "No namespace URI found for prefix: '"+_33+"'";
+}
+}:this.createNSResolver(this.documentElement);
+var _35=null;
+if(!_30){
+var _36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _37=new SarissaNodeList(_36.snapshotLength);
+_37.expr=_2e;
+for(var i=0;i<_37.length;i++){
+_37[i]=_36.snapshotItem(i);
+}
+_35=_37;
+}else{
+_35=_36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+}
+return _35;
+};
+Element.prototype.selectNodes=function(_39){
+var doc=this.ownerDocument;
+if(doc.selectNodes){
+return doc.selectNodes(_39,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+XMLDocument.prototype.selectSingleNode=function(_3b,_3c){
+var ctx=_3c?_3c:null;
+return this.selectNodes(_3b,ctx,true);
+};
+Element.prototype.selectSingleNode=function(_3e){
+var doc=this.ownerDocument;
+if(doc.selectSingleNode){
+return doc.selectSingleNode(_3e,this);
+}else{
+throw "Method selectNodes is only supported by XML Elements";
+}
+};
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+if(_SARISSA_IS_IE){
+Sarissa.IS_ENABLED_SELECT_NODES=true;
+}
+Freja.QueryEngine=function(){
+};
+Freja.QueryEngine.prototype.getElementById=function(_40,id){
+var _42=_40.getElementsByTagName("*");
+for(var i=0;i<_42.length;i++){
+if(_42[i].getAttribute("id")==id){
+return _42[i];
+}
+}
+};
+Freja.QueryEngine.prototype.get=function(_44,_45){
+var _46=this._find(_44,_45);
+if(!_46){
+throw new Error("Can't evaluate expression "+_45);
+}
+switch(_46.nodeType){
+case 1:
+if(_46.firstChild&&(_46.firstChild.nodeType==3||_46.firstChild.nodeType==4)){
+return _46.firstChild.nodeValue;
+}
+break;
+case 2:
+return _46.nodeValue;
+break;
+case 3:
+case 4:
+return _46.nodeValue;
+break;
+}
+return null;
+};
+Freja.QueryEngine.prototype.set=function(_47,_48,_49){
+var _4a=this._find(_47,_48);
+if(!_4a){
+var _4b=_48.substr(_48.lastIndexOf("/")+1);
+if(_4b.charAt(0)=="@"){
+var _4c=_48.substring(0,_48.lastIndexOf("/"));
+var _4d=this._find(_47,_4c);
+if(_4d){
+_4d.setAttribute(_4b.substr(1),_49);
+return;
+}
+}
+throw new Error("Can't evaluate expression "+_48);
+}
+switch(_4a.nodeType){
+case 1:
+if(_4a.firstChild&&(_4a.firstChild.nodeType==3||_4a.firstChild.nodeType==4)){
+_4a.firstChild.nodeValue=_49;
+}else{
+if(_49!=""){
+_4a.appendChild(_47.createTextNode(_49));
+}
+}
+break;
+case 2:
+_4a.nodeValue=_49;
+break;
+case 3:
+case 4:
+_4a.nodeValue=_49;
+break;
+}
+return;
+};
+Freja.QueryEngine.XPath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
+Freja.QueryEngine.XPath.prototype._find=function(_4e,_4f){
+var _50=_4e.selectSingleNode(_4f);
+return _50;
+};
+Freja.QueryEngine.SimplePath=function(){
+};
+Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
+Freja.QueryEngine.SimplePath.prototype._find=function(_51,_52){
+if(!_52.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error("Can't evaluate expression "+_52);
+}
+var _53=_52.split("/");
+var _54=_51;
+var _55=new RegExp("^@([\\d\\w]*)");
+var _56=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+var _57=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+var _58=null;
+var _59=0;
+for(var i=0;i<_53.length;++i){
+var _5b=_53[i];
+var _5c=_57.exec(_5b);
+if(_5c){
+if(i>0&&_53[i-1]==""){
+var cn=_54.getElementsByTagName(_5c[1]);
+}else{
+var cn=_54.childNodes;
+}
+for(var j=0,l=cn.length;j<l;j++){
+if(cn[j].nodeType==1&&cn[j].tagName==_5c[1]&&cn[j].getAttribute(_5c[2])==_5c[3]){
+_54=cn[j];
+break;
+}
+}
+if(j==l){
+throw new Error("Can't evaluate expression "+_5b);
+}
+}else{
+_59=_56.exec(_5b);
+if(_59){
+_5b=_59[1];
+_59=_59[2]-1;
+}else{
+_59=0;
+}
+if(_5b!=""){
+_58=_55.exec(_5b);
+if(_58){
+_54=_54.getAttributeNode(_58[1]);
+}else{
+_54=_54.getElementsByTagName(_5b).item(_59);
+}
+}
+}
+}
+if(_54&&_54.firstChild&&_54.firstChild.nodeType==3){
+return _54.firstChild;
+}
+if(_54&&_54.firstChild&&_54.firstChild.nodeType==4){
+return _54.firstChild;
+}
+if(!_54){
+throw new Error("Can't evaluate expression "+_52);
+}
+return _54;
+};
+Freja.Model=function(url,_60){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._query=_60;
+};
+Freja.Model.prototype.getElementById=function(id){
+if(this.document){
+return this._query.getElementById(this.document,id);
+}
+return null;
+};
+Freja.Model.prototype.get=function(_62){
+if(this.document){
+return this._query.get(this.document,_62);
+}
+return null;
+};
+Freja.Model.prototype.set=function(_63,_64){
+if(this.document){
+return this._query.set(this.document,_63,_64);
+}
+return null;
+};
+Freja.Model.prototype.updateFrom=function(_65){
+var _66=_65.getValues();
+for(var i=0;i<_66[0].length;++i){
+if(_66[0][i].lastIndexOf("/")!=-1){
+this.set(_66[0][i],_66[1][i]);
+}
+}
+};
+Freja.Model.prototype.save=function(){
+var url=this.url;
+var _69=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_69){
+url=_69[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var req=Freja.AssetManager.openXMLHttpRequest("POST",url);
+try{
+Freja._aux.sendXMLHttpRequest(req,Freja._aux.serializeXML(this.document)).addCallbacks(Freja._aux.bind(d.callback,d),Freja._aux.bind(d.errback,d));
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.Model.prototype.remove=function(){
+var url=this.url;
+var _6d=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_6d){
+url=_6d[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("DELETE",url);
+return Freja._aux.sendXMLHttpRequest(req);
+};
+Freja.Model.prototype.reload=function(){
+this.ready=false;
+var _6f=Freja._aux.bind(function(_70){
+this.document=_70;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},this);
+var d=Freja.AssetManager.loadAsset(this.url,true);
+d.addCallbacks(_6f,Freja.AssetManager.onerror);
+return d;
+};
+Freja.Model.DataSource=function(_72,_73){
+this.createURL=_72;
+this.indexURL=_73;
+};
+Freja.Model.DataSource.prototype.select=function(){
+return getModel(this.indexURL);
+};
+Freja.Model.DataSource.prototype.create=function(_74){
+var url=this.createURL;
+var _76=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_76){
+url=_76[1]+url;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("PUT",url);
+var _78={};
+for(var i=0,len=_74[0].length;i<len;++i){
+_78[_74[0][i]]=_74[1][i];
+}
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_78,"record"));
+};
+Freja.View=function(url,_7b){
+this.url=url;
+this.ready=false;
+this.document=null;
+this._renderer=_7b;
+this._destination=null;
+this.behaviors=[];
+this.placeholder=null;
+Freja._aux.connect(this,"onrendercomplete",Freja._aux.bind(this._connectBehavior,this));
+};
+Freja.View.prototype.render=function(_7c,_7d,_7e){
+if(typeof (_7d)=="undefined"){
+_7d=this.placeholder;
+}
+if(typeof (_7e)=="undefined"){
+_7e=this.xslParameters;
+}
+var _7f=function(_80,_81,_82,_83){
+this.model=_80;
+this.view=_81;
+this.deferred=_82;
+this.xslParameters=_83;
+};
+_7f.prototype.trigger=function(){
+try{
+if(!this.view.ready){
+Freja._aux.connect(this.view,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+if(typeof (this.model)=="object"&&this.model instanceof Freja.Model&&!this.model.ready){
+Freja._aux.connect(this.model,"onload",Freja._aux.bind(this.trigger,this));
+return;
+}
+var _84;
+if(typeof (this.model)=="undefined"){
+_84={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+}else{
+if(this.model instanceof Freja.Model){
+_84=this.model;
+}else{
+_84={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
+}
+}
+var _85=this.view._renderer.transform(_84,this.view,this.xslParameters);
+_85.addCallback(Freja._aux.bind(function(_86){
+if(typeof _86=="string"){
+this._destination.innerHTML=_86;
+}else{
+this._destination.innerHTML="";
+this._destination.appendChild(_86);
+}
+},this.view));
+_85.addCallback(Freja._aux.bind(function(){
+Freja._aux.signal(this,"onrendercomplete",this._destination);
+},this.view));
+_85.addCallback(this.deferred.callback);
+_85.addErrback(this.deferred.errback);
+}
+catch(ex){
+this.deferred.errback(ex);
+}
+};
+var d=Freja._aux.createDeferred();
+try{
+if(typeof (_7d)=="object"){
+this._destination=_7d;
+}else{
+this._destination=document.getElementById(_7d);
+}
+this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
+var h=new _7f(_7c,this,d,_7e);
+h.trigger();
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.prototype._connectBehavior=function(_89){
+try{
+var _8a=function(_8b,_8c,_8d){
+Freja._aux.connect(_8b,_8c,Freja._aux.bind(function(e){
+var _8f=false;
+try{
+_8f=_8d(this);
+}
+catch(ex){
+throw new Error("An error ocurred in user handler.\n"+ex.message);
+}
+finally{
+if(!_8f){
+e.stop();
+}
+}
+},_8b));
+};
+var _90=function(_91,_92){
+for(var i=0,c=_91.childNodes,l=c.length;i<l;++i){
+var _94=c[i];
+if(_94.nodeType==1){
+if(_94.className){
+var _95=_94.className.split(" ");
+for(var j=0;j<_95.length;j++){
+var _97=_92[_95[j]];
+if(_97){
+for(var _98 in _97){
+if(_98=="init"){
+_97.init(_94);
+}else{
+_8a(_94,_98,_97[_98]);
+}
+}
+}
+}
+}
+_90(_94,_92);
+}
+}
+};
+for(var ids in this.behaviors){
+_90(_89,this.behaviors);
+break;
+}
+}
+catch(ex){
+alert(ex.message);
+}
+};
+Freja.View.prototype.getValues=function(){
+return Freja._aux.formContents(this._destination);
+};
+Freja.View.Renderer=function(){
+};
+Freja.View.Renderer.XSLTransformer=function(){
+};
+Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9a,_9b,_9c){
+var d=Freja._aux.createDeferred();
+try{
+var _9e=Freja._aux.transformXSL(_9a.document,_9b.document,_9c);
+if(!_9e){
+d.errback(new Error("XSL Transformation error."));
+}else{
+d.callback(_9e);
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.View.Renderer.RemoteXSLTransformer=function(url){
+this.url=url;
+};
+Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a0,_a1,_a2){
+var d=Freja._aux.createDeferred();
+var _a4=_a1.url;
+var _a5="xslFile="+encodeURIComponent(_a4)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_a0.document));
+var _a6="";
+for(var _a7 in _a2){
+_a6+=encodeURIComponent(_a7+","+_a2[_a7]);
+}
+if(_a6.length>0){
+_a5=_a5+"&xslParam="+_a6;
+}
+var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
+req.onreadystatechange=function(){
+if(req.readyState==4){
+if(req.status==200){
+d.callback(req.responseText);
+}else{
+d.errback(req.responseText);
+}
+}
+};
+req.send(_a5);
+return d;
+};
+Freja.UndoHistory=function(){
+this.cache=[];
+this.maxLength=5;
+this._position=0;
+this._undoSteps=0;
+};
+Freja.UndoHistory.prototype.add=function(_a9){
+var _aa=this._position%this.maxLength;
+var _ab=_a9.document;
+this.cache[_aa]={};
+this.cache[_aa].model=_a9;
+this.cache[_aa].document=Freja._aux.cloneXMLDocument(_ab);
+if(!this.cache[_aa].document){
+throw new Error("Couldn't add to history.");
+}else{
+this._position++;
+var _ac=_aa;
+while(this._undoSteps>0){
+_ac=(_ac+1)%this.maxLength;
+this.cache[_ac]={};
+this._undoSteps--;
+}
+return _aa;
+}
+};
+Freja.UndoHistory.prototype.undo=function(_ad){
+if(this._undoSteps<this.cache.length){
+this._undoSteps++;
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+var _ae=this.cache[this._position].model;
+if(this.cache[this._position].document){
+_ae.document=this.cache[this._position].document;
+}else{
+throw new Error("The model's DOMDocument wasn't properly copied into the history");
+}
+if(typeof (_ad)!="undefined"&&_ad>1){
+this.undo(_ad-1);
+}
+}else{
+throw new Error("Nothing to undo");
+}
+};
+Freja.UndoHistory.prototype.redo=function(){
+if(this._undoSteps>0){
+this._undoSteps--;
+this._position=(this._position+1)%this.maxLength;
+var _af=this.cache[this._position].model;
+_af.document=this.cache[this._position].document;
+}else{
+throw new Error("Nothing to redo");
+}
+};
+Freja.UndoHistory.prototype.removeLast=function(){
+this._position--;
+if(this._position<0){
+this._position=this.maxLength-1;
+}
+this.cache[this._position]={};
+this._undoSteps=0;
+};
+Freja.AssetManager={models:[],views:[],_username:null,_password:null};
+Freja.AssetManager.HTTP_REQUEST_TYPE="async";
+Freja.AssetManager.HTTP_METHOD_TUNNEL="Http-Method-Equivalent";
+Freja.AssetManager.XSLT_SERVICE_URL="srvc-xslt.php";
+Freja.AssetManager.THROBBER_HTML="<span style='color:white;background:firebrick'>Loading ...</span>";
+Freja.AssetManager.createRenderer=function(){
+if(Freja._aux.hasSupportForXSLT()){
+return new Freja.View.Renderer.XSLTransformer();
+}else{
+return new Freja.View.Renderer.RemoteXSLTransformer(this.XSLT_SERVICE_URL);
+}
+};
+Freja.AssetManager.clearCache=function(){
+this.models=[];
+this.views=[];
+};
+Freja.AssetManager.getModel=function(url){
+for(var i=0;i<this.models.length;i++){
+if(this.models[i].url==url){
+return this.models[i];
+}
+}
+var m=new Freja.Model(url,Freja._aux.createQueryEngine());
+var _b3=Freja._aux.bind(function(_b4){
+this.document=_b4;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},m);
+this.loadAsset(url,true).addCallbacks(_b3,Freja.AssetManager.onerror);
+this.models.push(m);
+return m;
+};
+Freja.AssetManager.getView=function(url){
+for(var i=0;i<this.views.length;i++){
+if(this.views[i].url==url){
+return this.views[i];
+}
+}
+var v=new Freja.View(url,this.createRenderer());
+var _b8=Freja._aux.bind(function(_b9){
+this.document=_b9;
+this.ready=true;
+Freja._aux.signal(this,"onload");
+},v);
+this.loadAsset(url,false).addCallbacks(_b8,Freja.AssetManager.onerror);
+this.views.push(v);
+return v;
+};
+Freja.AssetManager.openXMLHttpRequest=function(_ba,url){
+var _bc=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_ba!="GET"&&_ba!="POST"){
+_bc=_ba;
+_ba="POST";
+}
+var req=Freja._aux.openXMLHttpRequest(_ba,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_bc){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_bc);
+}
+return req;
+};
+Freja.AssetManager.setCredentials=function(_be,_bf){
+this._username=_be;
+this._password=_bf;
+};
+Freja.AssetManager.loadAsset=function(url,_c1){
+var _c2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_c2){
+url=_c2[1]+url;
+}
+var d=Freja._aux.createDeferred();
+var _c4=function(_c5){
+try{
+if(_c5.responseText==""){
+throw new Error("Empty response.");
+}
+if(_c5.responseXML.xml==""){
+var _c6=Freja._aux.loadXML(_c5.responseText);
+}else{
+var _c6=_c5.responseXML;
+}
+}
+catch(ex){
+d.errback(ex);
+}
+if(window.document.all){
+setTimeout(function(){
+d.callback(_c6);
+},1);
+}else{
+d.callback(_c6);
+}
+};
+try{
+if(_c1&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
+req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
+}else{
+var req=Freja._aux.openXMLHttpRequest("GET",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+}
+var _c8=Freja._aux.sendXMLHttpRequest(req);
+if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
+_c8.addCallbacks(_c4,function(req){
+d.errback(new Error("Request failed:"+req.status));
+});
+}else{
+if(req.status==0||req.status==200||req.status==201||req.status==304){
+_c4(req);
+}else{
+d.errback(new Error("Request failed:"+req.status));
+}
+}
+}
+catch(ex){
+d.errback(ex);
+}
+return d;
+};
+Freja.AssetManager.onerror=function(ex){
+alert("Freja.AssetManager.onerror\n"+ex.message);
+};
+window.getModel=Freja._aux.bind("getModel",Freja.AssetManager);
+window.getView=Freja._aux.bind("getView",Freja.AssetManager);
+

Added: trunk/lib/mochi+sarissa/MochiKit.js
===================================================================
--- trunk/lib/mochi+sarissa/MochiKit.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/MochiKit.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,4802 @@
+/***
+
+    MochiKit.MochiKit 1.3.1 : PACKED VERSION
+
+    THIS FILE IS AUTOMATICALLY GENERATED.  If creating patches, please
+    diff against the source tree, not this file.
+
+    See <http://mochikit.com/> for documentation, downloads, license, etc.
+
+    (c) 2005 Bob Ippolito.  All rights Reserved.
+
+***/
+
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Base");
+}
+if(typeof (MochiKit)=="undefined"){
+MochiKit={};
+}
+if(typeof (MochiKit.Base)=="undefined"){
+MochiKit.Base={};
+}
+MochiKit.Base.VERSION="1.3.1";
+MochiKit.Base.NAME="MochiKit.Base";
+MochiKit.Base.update=function(_1,_2){
+if(_1===null){
+_1={};
+}
+for(var i=1;i<arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!="undefined"&&o!==null){
+for(var k in o){
+_1[k]=o[k];
+}
+}
+}
+return _1;
+};
+MochiKit.Base.update(MochiKit.Base,{__repr__:function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+},toString:function(){
+return this.__repr__();
+},counter:function(n){
+if(arguments.length===0){
+n=1;
+}
+return function(){
+return n++;
+};
+},clone:function(_7){
+var me=arguments.callee;
+if(arguments.length==1){
+me.prototype=_7;
+return new me();
+}
+},flattenArguments:function(_9){
+var res=[];
+var m=MochiKit.Base;
+var _12=m.extend(null,arguments);
+while(_12.length){
+var o=_12.shift();
+if(o&&typeof (o)=="object"&&typeof (o.length)=="number"){
+for(var i=o.length-1;i>=0;i--){
+_12.unshift(o[i]);
+}
+}else{
+res.push(o);
+}
+}
+return res;
+},extend:function(_13,obj,_15){
+if(!_15){
+_15=0;
+}
+if(obj){
+var l=obj.length;
+if(typeof (l)!="number"){
+if(typeof (MochiKit.Iter)!="undefined"){
+obj=MochiKit.Iter.list(obj);
+l=obj.length;
+}else{
+throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
+}
+}
+if(!_13){
+_13=[];
+}
+for(var i=_15;i<l;i++){
+_13.push(obj[i]);
+}
+}
+return _13;
+},updatetree:function(_17,obj){
+if(_17===null){
+_17={};
+}
+for(var i=1;i<arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!="undefined"&&o!==null){
+for(var k in o){
+var v=o[k];
+if(typeof (_17[k])=="object"&&typeof (v)=="object"){
+arguments.callee(_17[k],v);
+}else{
+_17[k]=v;
+}
+}
+}
+}
+return _17;
+},setdefault:function(_19,obj){
+if(_19===null){
+_19={};
+}
+for(var i=1;i<arguments.length;i++){
+var o=arguments[i];
+for(var k in o){
+if(!(k in _19)){
+_19[k]=o[k];
+}
+}
+}
+return _19;
+},keys:function(obj){
+var _20=[];
+for(var _21 in obj){
+_20.push(_21);
+}
+return _20;
+},items:function(obj){
+var _22=[];
+var e;
+for(var _24 in obj){
+var v;
+try{
+v=obj[_24];
+}
+catch(e){
+continue;
+}
+_22.push([_24,v]);
+}
+return _22;
+},_newNamedError:function(_25,_26,_27){
+_27.prototype=new MochiKit.Base.NamedError(_25.NAME+"."+_26);
+_25[_26]=_27;
+},operator:{truth:function(a){
+return !!a;
+},lognot:function(a){
+return !a;
+},identity:function(a){
+return a;
+},not:function(a){
+return ~a;
+},neg:function(a){
+return -a;
+},add:function(a,b){
+return a+b;
+},sub:function(a,b){
+return a-b;
+},div:function(a,b){
+return a/b;
+},mod:function(a,b){
+return a%b;
+},mul:function(a,b){
+return a*b;
+},and:function(a,b){
+return a&b;
+},or:function(a,b){
+return a|b;
+},xor:function(a,b){
+return a^b;
+},lshift:function(a,b){
+return a<<b;
+},rshift:function(a,b){
+return a>>b;
+},zrshift:function(a,b){
+return a>>>b;
+},eq:function(a,b){
+return a==b;
+},ne:function(a,b){
+return a!=b;
+},gt:function(a,b){
+return a>b;
+},ge:function(a,b){
+return a>=b;
+},lt:function(a,b){
+return a<b;
+},le:function(a,b){
+return a<=b;
+},ceq:function(a,b){
+return MochiKit.Base.compare(a,b)===0;
+},cne:function(a,b){
+return MochiKit.Base.compare(a,b)!==0;
+},cgt:function(a,b){
+return MochiKit.Base.compare(a,b)==1;
+},cge:function(a,b){
+return MochiKit.Base.compare(a,b)!=-1;
+},clt:function(a,b){
+return MochiKit.Base.compare(a,b)==-1;
+},cle:function(a,b){
+return MochiKit.Base.compare(a,b)!=1;
+},logand:function(a,b){
+return a&&b;
+},logor:function(a,b){
+return a||b;
+},contains:function(a,b){
+return b in a;
+}},forwardCall:function(_30){
+return function(){
+return this[_30].apply(this,arguments);
+};
+},itemgetter:function(_31){
+return function(arg){
+return arg[_31];
+};
+},typeMatcher:function(){
+var _33={};
+for(var i=0;i<arguments.length;i++){
+var typ=arguments[i];
+_33[typ]=typ;
+}
+return function(){
+for(var i=0;i<arguments.length;i++){
+if(!(typeof (arguments[i]) in _33)){
+return false;
+}
+}
+return true;
+};
+},isNull:function(){
+for(var i=0;i<arguments.length;i++){
+if(arguments[i]!==null){
+return false;
+}
+}
+return true;
+},isUndefinedOrNull:function(){
+for(var i=0;i<arguments.length;i++){
+var o=arguments[i];
+if(!(typeof (o)=="undefined"||o===null)){
+return false;
+}
+}
+return true;
+},isEmpty:function(obj){
+return !MochiKit.Base.isNotEmpty.apply(this,arguments);
+},isNotEmpty:function(obj){
+for(var i=0;i<arguments.length;i++){
+var o=arguments[i];
+if(!(o&&o.length)){
+return false;
+}
+}
+return true;
+},isArrayLike:function(){
+for(var i=0;i<arguments.length;i++){
+var o=arguments[i];
+var typ=typeof (o);
+if((typ!="object"&&!(typ=="function"&&typeof (o.item)=="function"))||o===null||typeof (o.length)!="number"){
+return false;
+}
+}
+return true;
+},isDateLike:function(){
+for(var i=0;i<arguments.length;i++){
+var o=arguments[i];
+if(typeof (o)!="object"||o===null||typeof (o.getTime)!="function"){
+return false;
+}
+}
+return true;
+},xmap:function(fn){
+if(fn===null){
+return MochiKit.Base.extend(null,arguments,1);
+}
+var _36=[];
+for(var i=1;i<arguments.length;i++){
+_36.push(fn(arguments[i]));
+}
+return _36;
+},map:function(fn,lst){
+var m=MochiKit.Base;
+var itr=MochiKit.Iter;
+var _39=m.isArrayLike;
+if(arguments.length<=2){
+if(!_39(lst)){
+if(itr){
+lst=itr.list(lst);
+if(fn===null){
+return lst;
+}
+}else{
+throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
+}
+}
+if(fn===null){
+return m.extend(null,lst);
+}
+var _40=[];
+for(var i=0;i<lst.length;i++){
+_40.push(fn(lst[i]));
+}
+return _40;
+}else{
+if(fn===null){
+fn=Array;
+}
+var _41=null;
+for(i=1;i<arguments.length;i++){
+if(!_39(arguments[i])){
+if(itr){
+return itr.list(itr.imap.apply(null,arguments));
+}else{
+throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
+}
+}
+var l=arguments[i].length;
+if(_41===null||_41>l){
+_41=l;
+}
+}
+_40=[];
+for(i=0;i<_41;i++){
+var _42=[];
+for(var j=1;j<arguments.length;j++){
+_42.push(arguments[j][i]);
+}
+_40.push(fn.apply(this,_42));
+}
+return _40;
+}
+},xfilter:function(fn){
+var _44=[];
+if(fn===null){
+fn=MochiKit.Base.operator.truth;
+}
+for(var i=1;i<arguments.length;i++){
+var o=arguments[i];
+if(fn(o)){
+_44.push(o);
+}
+}
+return _44;
+},filter:function(fn,lst,_45){
+var _46=[];
+var m=MochiKit.Base;
+if(!m.isArrayLike(lst)){
+if(MochiKit.Iter){
+lst=MochiKit.Iter.list(lst);
+}else{
+throw new TypeError("Argument not an array-like and MochiKit.Iter not present");
+}
+}
+if(fn===null){
+fn=m.operator.truth;
+}
+if(typeof (Array.prototype.filter)=="function"){
+return Array.prototype.filter.call(lst,fn,_45);
+}else{
+if(typeof (_45)=="undefined"||_45===null){
+for(var i=0;i<lst.length;i++){
+var o=lst[i];
+if(fn(o)){
+_46.push(o);
+}
+}
+}else{
+for(i=0;i<lst.length;i++){
+o=lst[i];
+if(fn.call(_45,o)){
+_46.push(o);
+}
+}
+}
+}
+return _46;
+},_wrapDumbFunction:function(_47){
+return function(){
+switch(arguments.length){
+case 0:
+return _47();
+case 1:
+return _47(arguments[0]);
+case 2:
+return _47(arguments[0],arguments[1]);
+case 3:
+return _47(arguments[0],arguments[1],arguments[2]);
+}
+var _48=[];
+for(var i=0;i<arguments.length;i++){
+_48.push("arguments["+i+"]");
+}
+return eval("(func("+_48.join(",")+"))");
+};
+},method:function(_49,_50){
+var m=MochiKit.Base;
+return m.bind.apply(this,m.extend([_50,_49],arguments,2));
+},bind:function(_51,_52){
+if(typeof (_51)=="string"){
+_51=_52[_51];
+}
+var _53=_51.im_func;
+var _54=_51.im_preargs;
+var _55=_51.im_self;
+var m=MochiKit.Base;
+if(typeof (_51)=="function"&&typeof (_51.apply)=="undefined"){
+_51=m._wrapDumbFunction(_51);
+}
+if(typeof (_53)!="function"){
+_53=_51;
+}
+if(typeof (_52)!="undefined"){
+_55=_52;
+}
+if(typeof (_54)=="undefined"){
+_54=[];
+}else{
+_54=_54.slice();
+}
+m.extend(_54,arguments,2);
+var _56=function(){
+var _57=arguments;
+var me=arguments.callee;
+if(me.im_preargs.length>0){
+_57=m.concat(me.im_preargs,_57);
+}
+var _52=me.im_self;
+if(!_52){
+_52=this;
+}
+return me.im_func.apply(_52,_57);
+};
+_56.im_self=_55;
+_56.im_func=_53;
+_56.im_preargs=_54;
+return _56;
+},bindMethods:function(_58){
+var _59=MochiKit.Base.bind;
+for(var k in _58){
+var _60=_58[k];
+if(typeof (_60)=="function"){
+_58[k]=_59(_60,_58);
+}
+}
+},registerComparator:function(_61,_62,_63,_64){
+MochiKit.Base.comparatorRegistry.register(_61,_62,_63,_64);
+},_primitives:{"bool":true,"string":true,"number":true},compare:function(a,b){
+if(a==b){
+return 0;
+}
+var _65=(typeof (a)=="undefined"||a===null);
+var _66=(typeof (b)=="undefined"||b===null);
+if(_65&&_66){
+return 0;
+}else{
+if(_65){
+return -1;
+}else{
+if(_66){
+return 1;
+}
+}
+}
+var m=MochiKit.Base;
+var _67=m._primitives;
+if(!(typeof (a) in _67&&typeof (b) in _67)){
+try{
+return m.comparatorRegistry.match(a,b);
+}
+catch(e){
+if(e!=m.NotFound){
+throw e;
+}
+}
+}
+if(a<b){
+return -1;
+}else{
+if(a>b){
+return 1;
+}
+}
+var _68=m.repr;
+throw new TypeError(_68(a)+" and "+_68(b)+" can not be compared");
+},compareDateLike:function(a,b){
+return MochiKit.Base.compare(a.getTime(),b.getTime());
+},compareArrayLike:function(a,b){
+var _69=MochiKit.Base.compare;
+var _70=a.length;
+var _71=0;
+if(_70>b.length){
+_71=1;
+_70=b.length;
+}else{
+if(_70<b.length){
+_71=-1;
+}
+}
+for(var i=0;i<_70;i++){
+var cmp=_69(a[i],b[i]);
+if(cmp){
+return cmp;
+}
+}
+return _71;
+},registerRepr:function(_73,_74,_75,_76){
+MochiKit.Base.reprRegistry.register(_73,_74,_75,_76);
+},repr:function(o){
+if(typeof (o)=="undefined"){
+return "undefined";
+}else{
+if(o===null){
+return "null";
+}
+}
+try{
+if(typeof (o.__repr__)=="function"){
+return o.__repr__();
+}else{
+if(typeof (o.repr)=="function"&&o.repr!=arguments.callee){
+return o.repr();
+}
+}
+return MochiKit.Base.reprRegistry.match(o);
+}
+catch(e){
+if(typeof (o.NAME)=="string"&&(o.toString==Function.prototype.toString||o.toString==Object.prototype.toString)){
+return o.NAME;
+}
+}
+try{
+var _77=(o+"");
+}
+catch(e){
+return "["+typeof (o)+"]";
+}
+if(typeof (o)=="function"){
+o=_77.replace(/^\s+/,"");
+var idx=o.indexOf("{");
+if(idx!=-1){
+o=o.substr(0,idx)+"{...}";
+}
+}
+return _77;
+},reprArrayLike:function(o){
+var m=MochiKit.Base;
+return "["+m.map(m.repr,o).join(", ")+"]";
+},reprString:function(o){
+return ("\""+o.replace(/(["\\])/g,"\\$1")+"\"").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r");
+},reprNumber:function(o){
+return o+"";
+},registerJSON:function(_79,_80,_81,_82){
+MochiKit.Base.jsonRegistry.register(_79,_80,_81,_82);
+},evalJSON:function(){
+return eval("("+arguments[0]+")");
+},serializeJSON:function(o){
+var _83=typeof (o);
+if(_83=="undefined"){
+return "undefined";
+}else{
+if(_83=="number"||_83=="boolean"){
+return o+"";
+}else{
+if(o===null){
+return "null";
+}
+}
+}
+var m=MochiKit.Base;
+var _84=m.reprString;
+if(_83=="string"){
+return _84(o);
+}
+var me=arguments.callee;
+var _85;
+if(typeof (o.__json__)=="function"){
+_85=o.__json__();
+if(o!==_85){
+return me(_85);
+}
+}
+if(typeof (o.json)=="function"){
+_85=o.json();
+if(o!==_85){
+return me(_85);
+}
+}
+if(_83!="function"&&typeof (o.length)=="number"){
+var res=[];
+for(var i=0;i<o.length;i++){
+var val=me(o[i]);
+if(typeof (val)!="string"){
+val="undefined";
+}
+res.push(val);
+}
+return "["+res.join(", ")+"]";
+}
+try{
+_85=m.jsonRegistry.match(o);
+return me(_85);
+}
+catch(e){
+if(e!=m.NotFound){
+throw e;
+}
+}
+if(_83=="function"){
+return null;
+}
+res=[];
+for(var k in o){
+var _87;
+if(typeof (k)=="number"){
+_87="\""+k+"\"";
+}else{
+if(typeof (k)=="string"){
+_87=_84(k);
+}else{
+continue;
+}
+}
+val=me(o[k]);
+if(typeof (val)!="string"){
+continue;
+}
+res.push(_87+":"+val);
+}
+return "{"+res.join(", ")+"}";
+},objEqual:function(a,b){
+return (MochiKit.Base.compare(a,b)===0);
+},arrayEqual:function(_88,arr){
+if(_88.length!=arr.length){
+return false;
+}
+return (MochiKit.Base.compare(_88,arr)===0);
+},concat:function(){
+var _90=[];
+var _91=MochiKit.Base.extend;
+for(var i=0;i<arguments.length;i++){
+_91(_90,arguments[i]);
+}
+return _90;
+},keyComparator:function(key){
+var m=MochiKit.Base;
+var _93=m.compare;
+if(arguments.length==1){
+return function(a,b){
+return _93(a[key],b[key]);
+};
+}
+var _94=m.extend(null,arguments);
+return function(a,b){
+var _95=0;
+for(var i=0;(_95===0)&&(i<_94.length);i++){
+var key=_94[i];
+_95=_93(a[key],b[key]);
+}
+return _95;
+};
+},reverseKeyComparator:function(key){
+var _96=MochiKit.Base.keyComparator.apply(this,arguments);
+return function(a,b){
+return _96(b,a);
+};
+},partial:function(_97){
+var m=MochiKit.Base;
+return m.bind.apply(this,m.extend([_97,undefined],arguments,1));
+},listMinMax:function(_98,lst){
+if(lst.length===0){
+return null;
+}
+var cur=lst[0];
+var _100=MochiKit.Base.compare;
+for(var i=1;i<lst.length;i++){
+var o=lst[i];
+if(_100(o,cur)==_98){
+cur=o;
+}
+}
+return cur;
+},objMax:function(){
+return MochiKit.Base.listMinMax(1,arguments);
+},objMin:function(){
+return MochiKit.Base.listMinMax(-1,arguments);
+},findIdentical:function(lst,_101,_102,end){
+if(typeof (end)=="undefined"||end===null){
+end=lst.length;
+}
+for(var i=(_102||0);i<end;i++){
+if(lst[i]===_101){
+return i;
+}
+}
+return -1;
+},findValue:function(lst,_104,_105,end){
+if(typeof (end)=="undefined"||end===null){
+end=lst.length;
+}
+var cmp=MochiKit.Base.compare;
+for(var i=(_105||0);i<end;i++){
+if(cmp(lst[i],_104)===0){
+return i;
+}
+}
+return -1;
+},nodeWalk:function(node,_107){
+var _108=[node];
+var _109=MochiKit.Base.extend;
+while(_108.length){
+var res=_107(_108.shift());
+if(res){
+_109(_108,res);
+}
+}
+},nameFunctions:function(_110){
+var base=_110.NAME;
+if(typeof (base)=="undefined"){
+base="";
+}else{
+base=base+".";
+}
+for(var name in _110){
+var o=_110[name];
+if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
+try{
+o.NAME=base+name;
+}
+catch(e){
+}
+}
+}
+},queryString:function(_113,_114){
+if(typeof (MochiKit.DOM)!="undefined"&&arguments.length==1&&(typeof (_113)=="string"||(typeof (_113.nodeType)!="undefined"&&_113.nodeType>0))){
+var kv=MochiKit.DOM.formContents(_113);
+_113=kv[0];
+_114=kv[1];
+}else{
+if(arguments.length==1){
+var o=_113;
+_113=[];
+_114=[];
+for(var k in o){
+var v=o[k];
+if(typeof (v)!="function"){
+_113.push(k);
+_114.push(v);
+}
+}
+}
+}
+var rval=[];
+var len=Math.min(_113.length,_114.length);
+var _118=MochiKit.Base.urlEncode;
+for(var i=0;i<len;i++){
+v=_114[i];
+if(typeof (v)!="undefined"&&v!==null){
+rval.push(_118(_113[i])+"="+_118(v));
+}
+}
+return rval.join("&");
+},parseQueryString:function(_119,_120){
+var _121=_119.replace(/\+/g,"%20").split("&");
+var o={};
+var _122;
+if(typeof (decodeURIComponent)!="undefined"){
+_122=decodeURIComponent;
+}else{
+_122=unescape;
+}
+if(_120){
+for(var i=0;i<_121.length;i++){
+var pair=_121[i].split("=");
+var name=_122(pair[0]);
+var arr=o[name];
+if(!(arr instanceof Array)){
+arr=[];
+o[name]=arr;
+}
+arr.push(_122(pair[1]));
+}
+}else{
+for(i=0;i<_121.length;i++){
+pair=_121[i].split("=");
+o[_122(pair[0])]=_122(pair[1]);
+}
+}
+return o;
+}});
+MochiKit.Base.AdapterRegistry=function(){
+this.pairs=[];
+};
+MochiKit.Base.AdapterRegistry.prototype={register:function(name,_124,wrap,_126){
+if(_126){
+this.pairs.unshift([name,_124,wrap]);
+}else{
+this.pairs.push([name,_124,wrap]);
+}
+},match:function(){
+for(var i=0;i<this.pairs.length;i++){
+var pair=this.pairs[i];
+if(pair[1].apply(this,arguments)){
+return pair[2].apply(this,arguments);
+}
+}
+throw MochiKit.Base.NotFound;
+},unregister:function(name){
+for(var i=0;i<this.pairs.length;i++){
+var pair=this.pairs[i];
+if(pair[0]==name){
+this.pairs.splice(i,1);
+return true;
+}
+}
+return false;
+}};
+MochiKit.Base.EXPORT=["counter","clone","extend","update","updatetree","setdefault","keys","items","NamedError","operator","forwardCall","itemgetter","typeMatcher","isCallable","isUndefined","isUndefinedOrNull","isNull","isEmpty","isNotEmpty","isArrayLike","isDateLike","xmap","map","xfilter","filter","bind","bindMethods","NotFound","AdapterRegistry","registerComparator","compare","registerRepr","repr","objEqual","arrayEqual","concat","keyComparator","reverseKeyComparator","partial","merge","listMinMax","listMax","listMin","objMax","objMin","nodeWalk","zip","urlEncode","queryString","serializeJSON","registerJSON","evalJSON","parseQueryString","findValue","findIdentical","flattenArguments","method"];
+MochiKit.Base.EXPORT_OK=["nameFunctions","comparatorRegistry","reprRegistry","jsonRegistry","compareDateLike","compareArrayLike","reprArrayLike","reprString","reprNumber"];
+MochiKit.Base._exportSymbols=function(_127,_128){
+if(typeof (MochiKit.__export__)=="undefined"){
+MochiKit.__export__=(MochiKit.__compat__||(typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined"));
+}
+if(!MochiKit.__export__){
+return;
+}
+var all=_128.EXPORT_TAGS[":all"];
+for(var i=0;i<all.length;i++){
+_127[all[i]]=_128[all[i]];
+}
+};
+MochiKit.Base.__new__=function(){
+var m=this;
+m.forward=m.forwardCall;
+m.find=m.findValue;
+if(typeof (encodeURIComponent)!="undefined"){
+m.urlEncode=function(_130){
+return encodeURIComponent(_130).replace(/\'/g,"%27");
+};
+}else{
+m.urlEncode=function(_131){
+return escape(_131).replace(/\+/g,"%2B").replace(/\"/g,"%22").rval.replace(/\'/g,"%27");
+};
+}
+m.NamedError=function(name){
+this.message=name;
+this.name=name;
+};
+m.NamedError.prototype=new Error();
+m.update(m.NamedError.prototype,{repr:function(){
+if(this.message&&this.message!=this.name){
+return this.name+"("+m.repr(this.message)+")";
+}else{
+return this.name+"()";
+}
+},toString:m.forwardCall("repr")});
+m.NotFound=new m.NamedError("MochiKit.Base.NotFound");
+m.listMax=m.partial(m.listMinMax,1);
+m.listMin=m.partial(m.listMinMax,-1);
+m.isCallable=m.typeMatcher("function");
+m.isUndefined=m.typeMatcher("undefined");
+m.merge=m.partial(m.update,null);
+m.zip=m.partial(m.map,null);
+m.comparatorRegistry=new m.AdapterRegistry();
+m.registerComparator("dateLike",m.isDateLike,m.compareDateLike);
+m.registerComparator("arrayLike",m.isArrayLike,m.compareArrayLike);
+m.reprRegistry=new m.AdapterRegistry();
+m.registerRepr("arrayLike",m.isArrayLike,m.reprArrayLike);
+m.registerRepr("string",m.typeMatcher("string"),m.reprString);
+m.registerRepr("numbers",m.typeMatcher("number","boolean"),m.reprNumber);
+m.jsonRegistry=new m.AdapterRegistry();
+var all=m.concat(m.EXPORT,m.EXPORT_OK);
+m.EXPORT_TAGS={":common":m.concat(m.EXPORT_OK),":all":all};
+m.nameFunctions(this);
+};
+MochiKit.Base.__new__();
+if(!MochiKit.__compat__){
+compare=MochiKit.Base.compare;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Base);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Iter");
+dojo.require("MochiKit.Base");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Iter depends on MochiKit.Base!";
+}
+if(typeof (MochiKit.Iter)=="undefined"){
+MochiKit.Iter={};
+}
+MochiKit.Iter.NAME="MochiKit.Iter";
+MochiKit.Iter.VERSION="1.3.1";
+MochiKit.Base.update(MochiKit.Iter,{__repr__:function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+},toString:function(){
+return this.__repr__();
+},registerIteratorFactory:function(name,_132,_133,_134){
+MochiKit.Iter.iteratorRegistry.register(name,_132,_133,_134);
+},iter:function(_135,_136){
+var self=MochiKit.Iter;
+if(arguments.length==2){
+return self.takewhile(function(a){
+return a!=_136;
+},_135);
+}
+if(typeof (_135.next)=="function"){
+return _135;
+}else{
+if(typeof (_135.iter)=="function"){
+return _135.iter();
+}
+}
+try{
+return self.iteratorRegistry.match(_135);
+}
+catch(e){
+var m=MochiKit.Base;
+if(e==m.NotFound){
+e=new TypeError(typeof (_135)+": "+m.repr(_135)+" is not iterable");
+}
+throw e;
+}
+},count:function(n){
+if(!n){
+n=0;
+}
+var m=MochiKit.Base;
+return {repr:function(){
+return "count("+n+")";
+},toString:m.forwardCall("repr"),next:m.counter(n)};
+},cycle:function(p){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+var lst=[];
+var _139=self.iter(p);
+return {repr:function(){
+return "cycle(...)";
+},toString:m.forwardCall("repr"),next:function(){
+try{
+var rval=_139.next();
+lst.push(rval);
+return rval;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+if(lst.length===0){
+this.next=function(){
+throw self.StopIteration;
+};
+}else{
+var i=-1;
+this.next=function(){
+i=(i+1)%lst.length;
+return lst[i];
+};
+}
+return this.next();
+}
+}};
+},repeat:function(elem,n){
+var m=MochiKit.Base;
+if(typeof (n)=="undefined"){
+return {repr:function(){
+return "repeat("+m.repr(elem)+")";
+},toString:m.forwardCall("repr"),next:function(){
+return elem;
+}};
+}
+return {repr:function(){
+return "repeat("+m.repr(elem)+", "+n+")";
+},toString:m.forwardCall("repr"),next:function(){
+if(n<=0){
+throw MochiKit.Iter.StopIteration;
+}
+n-=1;
+return elem;
+}};
+},next:function(_141){
+return _141.next();
+},izip:function(p,q){
+var m=MochiKit.Base;
+var next=MochiKit.Iter.next;
+var _144=m.map(iter,arguments);
+return {repr:function(){
+return "izip(...)";
+},toString:m.forwardCall("repr"),next:function(){
+return m.map(next,_144);
+}};
+},ifilter:function(pred,seq){
+var m=MochiKit.Base;
+seq=MochiKit.Iter.iter(seq);
+if(pred===null){
+pred=m.operator.truth;
+}
+return {repr:function(){
+return "ifilter(...)";
+},toString:m.forwardCall("repr"),next:function(){
+while(true){
+var rval=seq.next();
+if(pred(rval)){
+return rval;
+}
+}
+return undefined;
+}};
+},ifilterfalse:function(pred,seq){
+var m=MochiKit.Base;
+seq=MochiKit.Iter.iter(seq);
+if(pred===null){
+pred=m.operator.truth;
+}
+return {repr:function(){
+return "ifilterfalse(...)";
+},toString:m.forwardCall("repr"),next:function(){
+while(true){
+var rval=seq.next();
+if(!pred(rval)){
+return rval;
+}
+}
+return undefined;
+}};
+},islice:function(seq){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+seq=self.iter(seq);
+var _147=0;
+var stop=0;
+var step=1;
+var i=-1;
+if(arguments.length==2){
+stop=arguments[1];
+}else{
+if(arguments.length==3){
+_147=arguments[1];
+stop=arguments[2];
+}else{
+_147=arguments[1];
+stop=arguments[2];
+step=arguments[3];
+}
+}
+return {repr:function(){
+return "islice("+["...",_147,stop,step].join(", ")+")";
+},toString:m.forwardCall("repr"),next:function(){
+var rval;
+while(i<_147){
+rval=seq.next();
+i++;
+}
+if(_147>=stop){
+throw self.StopIteration;
+}
+_147+=step;
+return rval;
+}};
+},imap:function(fun,p,q){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+var _151=m.map(self.iter,m.extend(null,arguments,1));
+var map=m.map;
+var next=self.next;
+return {repr:function(){
+return "imap(...)";
+},toString:m.forwardCall("repr"),next:function(){
+return fun.apply(this,map(next,_151));
+}};
+},applymap:function(fun,seq,self){
+seq=MochiKit.Iter.iter(seq);
+var m=MochiKit.Base;
+return {repr:function(){
+return "applymap(...)";
+},toString:m.forwardCall("repr"),next:function(){
+return fun.apply(self,seq.next());
+}};
+},chain:function(p,q){
+var self=MochiKit.Iter;
+var m=MochiKit.Base;
+if(arguments.length==1){
+return self.iter(arguments[0]);
+}
+var _153=m.map(self.iter,arguments);
+return {repr:function(){
+return "chain(...)";
+},toString:m.forwardCall("repr"),next:function(){
+while(_153.length>1){
+try{
+return _153[0].next();
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+_153.shift();
+}
+}
+if(_153.length==1){
+var arg=_153.shift();
+this.next=m.bind("next",arg);
+return this.next();
+}
+throw self.StopIteration;
+}};
+},takewhile:function(pred,seq){
+var self=MochiKit.Iter;
+seq=self.iter(seq);
+return {repr:function(){
+return "takewhile(...)";
+},toString:MochiKit.Base.forwardCall("repr"),next:function(){
+var rval=seq.next();
+if(!pred(rval)){
+this.next=function(){
+throw self.StopIteration;
+};
+this.next();
+}
+return rval;
+}};
+},dropwhile:function(pred,seq){
+seq=MochiKit.Iter.iter(seq);
+var m=MochiKit.Base;
+var bind=m.bind;
+return {"repr":function(){
+return "dropwhile(...)";
+},"toString":m.forwardCall("repr"),"next":function(){
+while(true){
+var rval=seq.next();
+if(!pred(rval)){
+break;
+}
+}
+this.next=bind("next",seq);
+return rval;
+}};
+},_tee:function(_155,sync,_157){
+sync.pos[_155]=-1;
+var m=MochiKit.Base;
+var _158=m.listMin;
+return {repr:function(){
+return "tee("+_155+", ...)";
+},toString:m.forwardCall("repr"),next:function(){
+var rval;
+var i=sync.pos[_155];
+if(i==sync.max){
+rval=_157.next();
+sync.deque.push(rval);
+sync.max+=1;
+sync.pos[_155]+=1;
+}else{
+rval=sync.deque[i-sync.min];
+sync.pos[_155]+=1;
+if(i==sync.min&&_158(sync.pos)!=sync.min){
+sync.min+=1;
+sync.deque.shift();
+}
+}
+return rval;
+}};
+},tee:function(_159,n){
+var rval=[];
+var sync={"pos":[],"deque":[],"max":-1,"min":-1};
+if(arguments.length==1){
+n=2;
+}
+var self=MochiKit.Iter;
+_159=self.iter(_159);
+var _tee=self._tee;
+for(var i=0;i<n;i++){
+rval.push(_tee(i,sync,_159));
+}
+return rval;
+},list:function(_161){
+var m=MochiKit.Base;
+if(typeof (_161.slice)=="function"){
+return _161.slice();
+}else{
+if(m.isArrayLike(_161)){
+return m.concat(_161);
+}
+}
+var self=MochiKit.Iter;
+_161=self.iter(_161);
+var rval=[];
+try{
+while(true){
+rval.push(_161.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return rval;
+}
+return undefined;
+},reduce:function(fn,_162,_163){
+var i=0;
+var x=_163;
+var self=MochiKit.Iter;
+_162=self.iter(_162);
+if(arguments.length<3){
+try{
+x=_162.next();
+}
+catch(e){
+if(e==self.StopIteration){
+e=new TypeError("reduce() of empty sequence with no initial value");
+}
+throw e;
+}
+i++;
+}
+try{
+while(true){
+x=fn(x,_162.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+return x;
+},range:function(){
+var _165=0;
+var stop=0;
+var step=1;
+if(arguments.length==1){
+stop=arguments[0];
+}else{
+if(arguments.length==2){
+_165=arguments[0];
+stop=arguments[1];
+}else{
+if(arguments.length==3){
+_165=arguments[0];
+stop=arguments[1];
+step=arguments[2];
+}else{
+throw new TypeError("range() takes 1, 2, or 3 arguments!");
+}
+}
+}
+if(step===0){
+throw new TypeError("range() step must not be 0");
+}
+return {next:function(){
+if((step>0&&_165>=stop)||(step<0&&_165<=stop)){
+throw MochiKit.Iter.StopIteration;
+}
+var rval=_165;
+_165+=step;
+return rval;
+},repr:function(){
+return "range("+[_165,stop,step].join(", ")+")";
+},toString:MochiKit.Base.forwardCall("repr")};
+},sum:function(_166,_167){
+var x=_167||0;
+var self=MochiKit.Iter;
+_166=self.iter(_166);
+try{
+while(true){
+x+=_166.next();
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+return x;
+},exhaust:function(_168){
+var self=MochiKit.Iter;
+_168=self.iter(_168);
+try{
+while(true){
+_168.next();
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+},forEach:function(_169,func,self){
+var m=MochiKit.Base;
+if(arguments.length>2){
+func=m.bind(func,self);
+}
+if(m.isArrayLike(_169)){
+try{
+for(var i=0;i<_169.length;i++){
+func(_169[i]);
+}
+}
+catch(e){
+if(e!=MochiKit.Iter.StopIteration){
+throw e;
+}
+}
+}else{
+self=MochiKit.Iter;
+self.exhaust(self.imap(func,_169));
+}
+},every:function(_171,func){
+var self=MochiKit.Iter;
+try{
+self.ifilterfalse(func,_171).next();
+return false;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return true;
+}
+},sorted:function(_172,cmp){
+var rval=MochiKit.Iter.list(_172);
+if(arguments.length==1){
+cmp=MochiKit.Base.compare;
+}
+rval.sort(cmp);
+return rval;
+},reversed:function(_173){
+var rval=MochiKit.Iter.list(_173);
+rval.reverse();
+return rval;
+},some:function(_174,func){
+var self=MochiKit.Iter;
+try{
+self.ifilter(func,_174).next();
+return true;
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+return false;
+}
+},iextend:function(lst,_175){
+if(MochiKit.Base.isArrayLike(_175)){
+for(var i=0;i<_175.length;i++){
+lst.push(_175[i]);
+}
+}else{
+var self=MochiKit.Iter;
+_175=self.iter(_175);
+try{
+while(true){
+lst.push(_175.next());
+}
+}
+catch(e){
+if(e!=self.StopIteration){
+throw e;
+}
+}
+}
+return lst;
+},groupby:function(_176,_177){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+if(arguments.length<2){
+_177=m.operator.identity;
+}
+_176=self.iter(_176);
+var pk=undefined;
+var k=undefined;
+var v;
+function fetch(){
+v=_176.next();
+k=_177(v);
+}
+function eat(){
+var ret=v;
+v=undefined;
+return ret;
+}
+var _180=true;
+return {repr:function(){
+return "groupby(...)";
+},next:function(){
+while(k==pk){
+fetch();
+if(_180){
+_180=false;
+break;
+}
+}
+pk=k;
+return [k,{next:function(){
+if(v==undefined){
+fetch();
+}
+if(k!=pk){
+throw self.StopIteration;
+}
+return eat();
+}}];
+}};
+},groupby_as_array:function(_181,_182){
+var m=MochiKit.Base;
+var self=MochiKit.Iter;
+if(arguments.length<2){
+_182=m.operator.identity;
+}
+_181=self.iter(_181);
+var _183=[];
+var _184=true;
+var _185;
+while(true){
+try{
+var _186=_181.next();
+var key=_182(_186);
+}
+catch(e){
+if(e==self.StopIteration){
+break;
+}
+throw e;
+}
+if(_184||key!=_185){
+var _187=[];
+_183.push([key,_187]);
+}
+_187.push(_186);
+_184=false;
+_185=key;
+}
+return _183;
+},arrayLikeIter:function(_188){
+var i=0;
+return {repr:function(){
+return "arrayLikeIter(...)";
+},toString:MochiKit.Base.forwardCall("repr"),next:function(){
+if(i>=_188.length){
+throw MochiKit.Iter.StopIteration;
+}
+return _188[i++];
+}};
+},hasIterateNext:function(_189){
+return (_189&&typeof (_189.iterateNext)=="function");
+},iterateNextIter:function(_190){
+return {repr:function(){
+return "iterateNextIter(...)";
+},toString:MochiKit.Base.forwardCall("repr"),next:function(){
+var rval=_190.iterateNext();
+if(rval===null||rval===undefined){
+throw MochiKit.Iter.StopIteration;
+}
+return rval;
+}};
+}});
+MochiKit.Iter.EXPORT_OK=["iteratorRegistry","arrayLikeIter","hasIterateNext","iterateNextIter",];
+MochiKit.Iter.EXPORT=["StopIteration","registerIteratorFactory","iter","count","cycle","repeat","next","izip","ifilter","ifilterfalse","islice","imap","applymap","chain","takewhile","dropwhile","tee","list","reduce","range","sum","exhaust","forEach","every","sorted","reversed","some","iextend","groupby","groupby_as_array"];
+MochiKit.Iter.__new__=function(){
+var m=MochiKit.Base;
+this.StopIteration=new m.NamedError("StopIteration");
+this.iteratorRegistry=new m.AdapterRegistry();
+this.registerIteratorFactory("arrayLike",m.isArrayLike,this.arrayLikeIter);
+this.registerIteratorFactory("iterateNext",this.hasIterateNext,this.iterateNextIter);
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Iter.__new__();
+if(!MochiKit.__compat__){
+reduce=MochiKit.Iter.reduce;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Iter);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Logging");
+dojo.require("MochiKit.Base");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Logging depends on MochiKit.Base!";
+}
+if(typeof (MochiKit.Logging)=="undefined"){
+MochiKit.Logging={};
+}
+MochiKit.Logging.NAME="MochiKit.Logging";
+MochiKit.Logging.VERSION="1.3.1";
+MochiKit.Logging.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.Logging.toString=function(){
+return this.__repr__();
+};
+MochiKit.Logging.EXPORT=["LogLevel","LogMessage","Logger","alertListener","logger","log","logError","logDebug","logFatal","logWarning"];
+MochiKit.Logging.EXPORT_OK=["logLevelAtLeast","isLogMessage","compareLogMessage"];
+MochiKit.Logging.LogMessage=function(num,_192,info){
+this.num=num;
+this.level=_192;
+this.info=info;
+this.timestamp=new Date();
+};
+MochiKit.Logging.LogMessage.prototype={repr:function(){
+var m=MochiKit.Base;
+return "LogMessage("+m.map(m.repr,[this.num,this.level,this.info]).join(", ")+")";
+},toString:MochiKit.Base.forwardCall("repr")};
+MochiKit.Base.update(MochiKit.Logging,{logLevelAtLeast:function(_194){
+var self=MochiKit.Logging;
+if(typeof (_194)=="string"){
+_194=self.LogLevel[_194];
+}
+return function(msg){
+var _196=msg.level;
+if(typeof (_196)=="string"){
+_196=self.LogLevel[_196];
+}
+return _196>=_194;
+};
+},isLogMessage:function(){
+var _197=MochiKit.Logging.LogMessage;
+for(var i=0;i<arguments.length;i++){
+if(!(arguments[i] instanceof _197)){
+return false;
+}
+}
+return true;
+},compareLogMessage:function(a,b){
+return MochiKit.Base.compare([a.level,a.info],[b.level,b.info]);
+},alertListener:function(msg){
+alert("num: "+msg.num+"\nlevel: "+msg.level+"\ninfo: "+msg.info.join(" "));
+}});
+MochiKit.Logging.Logger=function(_198){
+this.counter=0;
+if(typeof (_198)=="undefined"||_198===null){
+_198=-1;
+}
+this.maxSize=_198;
+this._messages=[];
+this.listeners={};
+this.useNativeConsole=false;
+};
+MochiKit.Logging.Logger.prototype={clear:function(){
+this._messages.splice(0,this._messages.length);
+},logToConsole:function(msg){
+if(typeof (window)!="undefined"&&window.console&&window.console.log){
+window.console.log(msg);
+}else{
+if(typeof (opera)!="undefined"&&opera.postError){
+opera.postError(msg);
+}else{
+if(typeof (printfire)=="function"){
+printfire(msg);
+}
+}
+}
+},dispatchListeners:function(msg){
+for(var k in this.listeners){
+var pair=this.listeners[k];
+if(pair.ident!=k||(pair[0]&&!pair[0](msg))){
+continue;
+}
+pair[1](msg);
+}
+},addListener:function(_199,_200,_201){
+if(typeof (_200)=="string"){
+_200=MochiKit.Logging.logLevelAtLeast(_200);
+}
+var _202=[_200,_201];
+_202.ident=_199;
+this.listeners[_199]=_202;
+},removeListener:function(_203){
+delete this.listeners[_203];
+},baseLog:function(_204,_205){
+var msg=new MochiKit.Logging.LogMessage(this.counter,_204,MochiKit.Base.extend(null,arguments,1));
+this._messages.push(msg);
+this.dispatchListeners(msg);
+if(this.useNativeConsole){
+this.logToConsole(msg.level+": "+msg.info.join(" "));
+}
+this.counter+=1;
+while(this.maxSize>=0&&this._messages.length>this.maxSize){
+this._messages.shift();
+}
+},getMessages:function(_206){
+var _207=0;
+if(!(typeof (_206)=="undefined"||_206===null)){
+_207=Math.max(0,this._messages.length-_206);
+}
+return this._messages.slice(_207);
+},getMessageText:function(_208){
+if(typeof (_208)=="undefined"||_208===null){
+_208=30;
+}
+var _209=this.getMessages(_208);
+if(_209.length){
+var lst=map(function(m){
+return "\n  ["+m.num+"] "+m.level+": "+m.info.join(" ");
+},_209);
+lst.unshift("LAST "+_209.length+" MESSAGES:");
+return lst.join("");
+}
+return "";
+},debuggingBookmarklet:function(_210){
+if(typeof (MochiKit.LoggingPane)=="undefined"){
+alert(this.getMessageText());
+}else{
+MochiKit.LoggingPane.createLoggingPane(_210||false);
+}
+}};
+MochiKit.Logging.__new__=function(){
+this.LogLevel={ERROR:40,FATAL:50,WARNING:30,INFO:20,DEBUG:10};
+var m=MochiKit.Base;
+m.registerComparator("LogMessage",this.isLogMessage,this.compareLogMessage);
+var _211=m.partial;
+var _212=this.Logger;
+var _213=_212.prototype.baseLog;
+m.update(this.Logger.prototype,{debug:_211(_213,"DEBUG"),log:_211(_213,"INFO"),error:_211(_213,"ERROR"),fatal:_211(_213,"FATAL"),warning:_211(_213,"WARNING")});
+var self=this;
+var _214=function(name){
+return function(){
+self.logger[name].apply(self.logger,arguments);
+};
+};
+this.log=_214("log");
+this.logError=_214("error");
+this.logDebug=_214("debug");
+this.logFatal=_214("fatal");
+this.logWarning=_214("warning");
+this.logger=new _212();
+this.logger.useNativeConsole=true;
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+if(typeof (printfire)=="undefined"&&typeof (document)!="undefined"&&document.createEvent&&typeof (dispatchEvent)!="undefined"){
+printfire=function(){
+printfire.args=arguments;
+var ev=document.createEvent("Events");
+ev.initEvent("printfire",false,true);
+dispatchEvent(ev);
+};
+}
+MochiKit.Logging.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Logging);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.DateTime");
+}
+if(typeof (MochiKit)=="undefined"){
+MochiKit={};
+}
+if(typeof (MochiKit.DateTime)=="undefined"){
+MochiKit.DateTime={};
+}
+MochiKit.DateTime.NAME="MochiKit.DateTime";
+MochiKit.DateTime.VERSION="1.3.1";
+MochiKit.DateTime.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.DateTime.toString=function(){
+return this.__repr__();
+};
+MochiKit.DateTime.isoDate=function(str){
+str=str+"";
+if(typeof (str)!="string"||str.length===0){
+return null;
+}
+var iso=str.split("-");
+if(iso.length===0){
+return null;
+}
+return new Date(iso[0],iso[1]-1,iso[2]);
+};
+MochiKit.DateTime._isoRegexp=/(\d{4,})(?:-(\d{1,2})(?:-(\d{1,2})(?:[T ](\d{1,2}):(\d{1,2})(?::(\d{1,2})(?:\.(\d+))?)?(?:(Z)|([+-])(\d{1,2})(?::(\d{1,2}))?)?)?)?)?/;
+MochiKit.DateTime.isoTimestamp=function(str){
+str=str+"";
+if(typeof (str)!="string"||str.length===0){
+return null;
+}
+var res=str.match(MochiKit.DateTime._isoRegexp);
+if(typeof (res)=="undefined"||res===null){
+return null;
+}
+var year,month,day,hour,min,sec,msec;
+year=parseInt(res[1],10);
+if(typeof (res[2])=="undefined"||res[2]===""){
+return new Date(year);
+}
+month=parseInt(res[2],10)-1;
+day=parseInt(res[3],10);
+if(typeof (res[4])=="undefined"||res[4]===""){
+return new Date(year,month,day);
+}
+hour=parseInt(res[4],10);
+min=parseInt(res[5],10);
+sec=(typeof (res[6])!="undefined"&&res[6]!=="")?parseInt(res[6],10):0;
+if(typeof (res[7])!="undefined"&&res[7]!==""){
+msec=Math.round(1000*parseFloat("0."+res[7]));
+}else{
+msec=0;
+}
+if((typeof (res[8])=="undefined"||res[8]==="")&&(typeof (res[9])=="undefined"||res[9]==="")){
+return new Date(year,month,day,hour,min,sec,msec);
+}
+var ofs;
+if(typeof (res[9])!="undefined"&&res[9]!==""){
+ofs=parseInt(res[10],10)*3600000;
+if(typeof (res[11])!="undefined"&&res[11]!==""){
+ofs+=parseInt(res[11],10)*60000;
+}
+if(res[9]=="-"){
+ofs=-ofs;
+}
+}else{
+ofs=0;
+}
+return new Date(Date.UTC(year,month,day,hour,min,sec,msec)-ofs);
+};
+MochiKit.DateTime.toISOTime=function(date,_221){
+if(typeof (date)=="undefined"||date===null){
+return null;
+}
+var hh=date.getHours();
+var mm=date.getMinutes();
+var ss=date.getSeconds();
+var lst=[((_221&&(hh<10))?"0"+hh:hh),((mm<10)?"0"+mm:mm),((ss<10)?"0"+ss:ss)];
+return lst.join(":");
+};
+MochiKit.DateTime.toISOTimestamp=function(date,_225){
+if(typeof (date)=="undefined"||date===null){
+return null;
+}
+var sep=_225?"T":" ";
+var foot=_225?"Z":"";
+if(_225){
+date=new Date(date.getTime()+(date.getTimezoneOffset()*60000));
+}
+return MochiKit.DateTime.toISODate(date)+sep+MochiKit.DateTime.toISOTime(date,_225)+foot;
+};
+MochiKit.DateTime.toISODate=function(date){
+if(typeof (date)=="undefined"||date===null){
+return null;
+}
+var _228=MochiKit.DateTime._padTwo;
+return [date.getFullYear(),_228(date.getMonth()+1),_228(date.getDate())].join("-");
+};
+MochiKit.DateTime.americanDate=function(d){
+d=d+"";
+if(typeof (d)!="string"||d.length===0){
+return null;
+}
+var a=d.split("/");
+return new Date(a[2],a[0]-1,a[1]);
+};
+MochiKit.DateTime._padTwo=function(n){
+return (n>9)?n:"0"+n;
+};
+MochiKit.DateTime.toPaddedAmericanDate=function(d){
+if(typeof (d)=="undefined"||d===null){
+return null;
+}
+var _230=MochiKit.DateTime._padTwo;
+return [_230(d.getMonth()+1),_230(d.getDate()),d.getFullYear()].join("/");
+};
+MochiKit.DateTime.toAmericanDate=function(d){
+if(typeof (d)=="undefined"||d===null){
+return null;
+}
+return [d.getMonth()+1,d.getDate(),d.getFullYear()].join("/");
+};
+MochiKit.DateTime.EXPORT=["isoDate","isoTimestamp","toISOTime","toISOTimestamp","toISODate","americanDate","toPaddedAmericanDate","toAmericanDate"];
+MochiKit.DateTime.EXPORT_OK=[];
+MochiKit.DateTime.EXPORT_TAGS={":common":MochiKit.DateTime.EXPORT,":all":MochiKit.DateTime.EXPORT};
+MochiKit.DateTime.__new__=function(){
+var base=this.NAME+".";
+for(var k in this){
+var o=this[k];
+if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
+try{
+o.NAME=base+k;
+}
+catch(e){
+}
+}
+}
+};
+MochiKit.DateTime.__new__();
+if(typeof (MochiKit.Base)!="undefined"){
+MochiKit.Base._exportSymbols(this,MochiKit.DateTime);
+}else{
+(function(_231,_232){
+if((typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined")||(typeof (MochiKit.__compat__)=="boolean"&&MochiKit.__compat__)){
+var all=_232.EXPORT_TAGS[":all"];
+for(var i=0;i<all.length;i++){
+_231[all[i]]=_232[all[i]];
+}
+}
+})(this,MochiKit.DateTime);
+}
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Format");
+}
+if(typeof (MochiKit)=="undefined"){
+MochiKit={};
+}
+if(typeof (MochiKit.Format)=="undefined"){
+MochiKit.Format={};
+}
+MochiKit.Format.NAME="MochiKit.Format";
+MochiKit.Format.VERSION="1.3.1";
+MochiKit.Format.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.Format.toString=function(){
+return this.__repr__();
+};
+MochiKit.Format._numberFormatter=function(_233,_234,_235,_236,_237,_238,_239,_240,_241){
+return function(num){
+num=parseFloat(num);
+if(typeof (num)=="undefined"||num===null||isNaN(num)){
+return _233;
+}
+var _242=_234;
+var _243=_235;
+if(num<0){
+num=-num;
+}else{
+_242=_242.replace(/-/,"");
+}
+var me=arguments.callee;
+var fmt=MochiKit.Format.formatLocale(_236);
+if(_237){
+num=num*100;
+_243=fmt.percent+_243;
+}
+num=MochiKit.Format.roundToFixed(num,_238);
+var _245=num.split(/\./);
+var _246=_245[0];
+var frac=(_245.length==1)?"":_245[1];
+var res="";
+while(_246.length<_239){
+_246="0"+_246;
+}
+if(_240){
+while(_246.length>_240){
+var i=_246.length-_240;
+res=fmt.separator+_246.substring(i,_246.length)+res;
+_246=_246.substring(0,i);
+}
+}
+res=_246+res;
+if(_238>0){
+while(frac.length<_241){
+frac=frac+"0";
+}
+res=res+fmt.decimal+frac;
+}
+return _242+res+_243;
+};
+};
+MochiKit.Format.numberFormatter=function(_248,_249,_250){
+if(typeof (_249)=="undefined"){
+_249="";
+}
+var _251=_248.match(/((?:[0#]+,)?[0#]+)(?:\.([0#]+))?(%)?/);
+if(!_251){
+throw TypeError("Invalid pattern");
+}
+var _252=_248.substr(0,_251.index);
+var _253=_248.substr(_251.index+_251[0].length);
+if(_252.search(/-/)==-1){
+_252=_252+"-";
+}
+var _254=_251[1];
+var frac=(typeof (_251[2])=="string"&&_251[2]!="")?_251[2]:"";
+var _255=(typeof (_251[3])=="string"&&_251[3]!="");
+var tmp=_254.split(/,/);
+var _257;
+if(typeof (_250)=="undefined"){
+_250="default";
+}
+if(tmp.length==1){
+_257=null;
+}else{
+_257=tmp[1].length;
+}
+var _258=_254.length-_254.replace(/0/g,"").length;
+var _259=frac.length-frac.replace(/0/g,"").length;
+var _260=frac.length;
+var rval=MochiKit.Format._numberFormatter(_249,_252,_253,_250,_255,_260,_258,_257,_259);
+var m=MochiKit.Base;
+if(m){
+var fn=arguments.callee;
+var args=m.concat(arguments);
+rval.repr=function(){
+return [self.NAME,"(",map(m.repr,args).join(", "),")"].join("");
+};
+}
+return rval;
+};
+MochiKit.Format.formatLocale=function(_262){
+if(typeof (_262)=="undefined"||_262===null){
+_262="default";
+}
+if(typeof (_262)=="string"){
+var rval=MochiKit.Format.LOCALE[_262];
+if(typeof (rval)=="string"){
+rval=arguments.callee(rval);
+MochiKit.Format.LOCALE[_262]=rval;
+}
+return rval;
+}else{
+return _262;
+}
+};
+MochiKit.Format.twoDigitAverage=function(_263,_264){
+if(_264){
+var res=_263/_264;
+if(!isNaN(res)){
+return MochiKit.Format.twoDigitFloat(_263/_264);
+}
+}
+return "0";
+};
+MochiKit.Format.twoDigitFloat=function(_265){
+var sign=(_265<0?"-":"");
+var s=Math.floor(Math.abs(_265)*100).toString();
+if(s=="0"){
+return s;
+}
+if(s.length<3){
+while(s.charAt(s.length-1)=="0"){
+s=s.substring(0,s.length-1);
+}
+return sign+"0."+s;
+}
+var head=sign+s.substring(0,s.length-2);
+var tail=s.substring(s.length-2,s.length);
+if(tail=="00"){
+return head;
+}else{
+if(tail.charAt(1)=="0"){
+return head+"."+tail.charAt(0);
+}else{
+return head+"."+tail;
+}
+}
+};
+MochiKit.Format.lstrip=function(str,_270){
+str=str+"";
+if(typeof (str)!="string"){
+return null;
+}
+if(!_270){
+return str.replace(/^\s+/,"");
+}else{
+return str.replace(new RegExp("^["+_270+"]+"),"");
+}
+};
+MochiKit.Format.rstrip=function(str,_271){
+str=str+"";
+if(typeof (str)!="string"){
+return null;
+}
+if(!_271){
+return str.replace(/\s+$/,"");
+}else{
+return str.replace(new RegExp("["+_271+"]+$"),"");
+}
+};
+MochiKit.Format.strip=function(str,_272){
+var self=MochiKit.Format;
+return self.rstrip(self.lstrip(str,_272),_272);
+};
+MochiKit.Format.truncToFixed=function(_273,_274){
+_273=Math.floor(_273*Math.pow(10,_274));
+var res=(_273*Math.pow(10,-_274)).toFixed(_274);
+if(res.charAt(0)=="."){
+res="0"+res;
+}
+return res;
+};
+MochiKit.Format.roundToFixed=function(_275,_276){
+return MochiKit.Format.truncToFixed(_275+0.5*Math.pow(10,-_276),_276);
+};
+MochiKit.Format.percentFormat=function(_277){
+return MochiKit.Format.twoDigitFloat(100*_277)+"%";
+};
+MochiKit.Format.EXPORT=["truncToFixed","roundToFixed","numberFormatter","formatLocale","twoDigitAverage","twoDigitFloat","percentFormat","lstrip","rstrip","strip"];
+MochiKit.Format.LOCALE={en_US:{separator:",",decimal:".",percent:"%"},de_DE:{separator:".",decimal:",",percent:"%"},fr_FR:{separator:" ",decimal:",",percent:"%"},"default":"en_US"};
+MochiKit.Format.EXPORT_OK=[];
+MochiKit.Format.EXPORT_TAGS={":all":MochiKit.Format.EXPORT,":common":MochiKit.Format.EXPORT};
+MochiKit.Format.__new__=function(){
+var base=this.NAME+".";
+var k,v,o;
+for(k in this.LOCALE){
+o=this.LOCALE[k];
+if(typeof (o)=="object"){
+o.repr=function(){
+return this.NAME;
+};
+o.NAME=base+"LOCALE."+k;
+}
+}
+for(k in this){
+o=this[k];
+if(typeof (o)=="function"&&typeof (o.NAME)=="undefined"){
+try{
+o.NAME=base+k;
+}
+catch(e){
+}
+}
+}
+};
+MochiKit.Format.__new__();
+if(typeof (MochiKit.Base)!="undefined"){
+MochiKit.Base._exportSymbols(this,MochiKit.Format);
+}else{
+(function(_278,_279){
+if((typeof (JSAN)=="undefined"&&typeof (dojo)=="undefined")||(typeof (MochiKit.__compat__)=="boolean"&&MochiKit.__compat__)){
+var all=_279.EXPORT_TAGS[":all"];
+for(var i=0;i<all.length;i++){
+_278[all[i]]=_279[all[i]];
+}
+}
+})(this,MochiKit.Format);
+}
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Async");
+dojo.require("MochiKit.Base");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Async depends on MochiKit.Base!";
+}
+if(typeof (MochiKit.Async)=="undefined"){
+MochiKit.Async={};
+}
+MochiKit.Async.NAME="MochiKit.Async";
+MochiKit.Async.VERSION="1.3.1";
+MochiKit.Async.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.Async.toString=function(){
+return this.__repr__();
+};
+MochiKit.Async.Deferred=function(_280){
+this.chain=[];
+this.id=this._nextId();
+this.fired=-1;
+this.paused=0;
+this.results=[null,null];
+this.canceller=_280;
+this.silentlyCancelled=false;
+this.chained=false;
+};
+MochiKit.Async.Deferred.prototype={repr:function(){
+var _281;
+if(this.fired==-1){
+_281="unfired";
+}else{
+if(this.fired===0){
+_281="success";
+}else{
+_281="error";
+}
+}
+return "Deferred("+this.id+", "+_281+")";
+},toString:MochiKit.Base.forwardCall("repr"),_nextId:MochiKit.Base.counter(),cancel:function(){
+var self=MochiKit.Async;
+if(this.fired==-1){
+if(this.canceller){
+this.canceller(this);
+}else{
+this.silentlyCancelled=true;
+}
+if(this.fired==-1){
+this.errback(new self.CancelledError(this));
+}
+}else{
+if((this.fired===0)&&(this.results[0] instanceof self.Deferred)){
+this.results[0].cancel();
+}
+}
+},_pause:function(){
+this.paused++;
+},_unpause:function(){
+this.paused--;
+if((this.paused===0)&&(this.fired>=0)){
+this._fire();
+}
+},_continue:function(res){
+this._resback(res);
+this._unpause();
+},_resback:function(res){
+this.fired=((res instanceof Error)?1:0);
+this.results[this.fired]=res;
+this._fire();
+},_check:function(){
+if(this.fired!=-1){
+if(!this.silentlyCancelled){
+throw new MochiKit.Async.AlreadyCalledError(this);
+}
+this.silentlyCancelled=false;
+return;
+}
+},callback:function(res){
+this._check();
+if(res instanceof MochiKit.Async.Deferred){
+throw new Error("Deferred instances can only be chained if they are the result of a callback");
+}
+this._resback(res);
+},errback:function(res){
+this._check();
+var self=MochiKit.Async;
+if(res instanceof self.Deferred){
+throw new Error("Deferred instances can only be chained if they are the result of a callback");
+}
+if(!(res instanceof Error)){
+res=new self.GenericError(res);
+}
+this._resback(res);
+},addBoth:function(fn){
+if(arguments.length>1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(fn,fn);
+},addCallback:function(fn){
+if(arguments.length>1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(fn,null);
+},addErrback:function(fn){
+if(arguments.length>1){
+fn=MochiKit.Base.partial.apply(null,arguments);
+}
+return this.addCallbacks(null,fn);
+},addCallbacks:function(cb,eb){
+if(this.chained){
+throw new Error("Chained Deferreds can not be re-used");
+}
+this.chain.push([cb,eb]);
+if(this.fired>=0){
+this._fire();
+}
+return this;
+},_fire:function(){
+var _284=this.chain;
+var _285=this.fired;
+var res=this.results[_285];
+var self=this;
+var cb=null;
+while(_284.length>0&&this.paused===0){
+var pair=_284.shift();
+var f=pair[_285];
+if(f===null){
+continue;
+}
+try{
+res=f(res);
+_285=((res instanceof Error)?1:0);
+if(res instanceof MochiKit.Async.Deferred){
+cb=function(res){
+self._continue(res);
+};
+this._pause();
+}
+}
+catch(err){
+_285=1;
+if(!(err instanceof Error)){
+err=new MochiKit.Async.GenericError(err);
+}
+res=err;
+}
+}
+this.fired=_285;
+this.results[_285]=res;
+if(cb&&this.paused){
+res.addBoth(cb);
+res.chained=true;
+}
+}};
+MochiKit.Base.update(MochiKit.Async,{evalJSONRequest:function(){
+return eval("("+arguments[0].responseText+")");
+},succeed:function(_287){
+var d=new MochiKit.Async.Deferred();
+d.callback.apply(d,arguments);
+return d;
+},fail:function(_288){
+var d=new MochiKit.Async.Deferred();
+d.errback.apply(d,arguments);
+return d;
+},getXMLHttpRequest:function(){
+var self=arguments.callee;
+if(!self.XMLHttpRequest){
+var _289=[function(){
+return new XMLHttpRequest();
+},function(){
+return new ActiveXObject("Msxml2.XMLHTTP");
+},function(){
+return new ActiveXObject("Microsoft.XMLHTTP");
+},function(){
+return new ActiveXObject("Msxml2.XMLHTTP.4.0");
+},function(){
+throw new MochiKit.Async.BrowserComplianceError("Browser does not support XMLHttpRequest");
+}];
+for(var i=0;i<_289.length;i++){
+var func=_289[i];
+try{
+self.XMLHttpRequest=func;
+return func();
+}
+catch(e){
+}
+}
+}
+return self.XMLHttpRequest();
+},_nothing:function(){
+},_xhr_onreadystatechange:function(d){
+if(this.readyState==4){
+try{
+this.onreadystatechange=null;
+}
+catch(e){
+try{
+this.onreadystatechange=MochiKit.Async._nothing;
+}
+catch(e){
+}
+}
+var _290=null;
+try{
+_290=this.status;
+if(!_290&&MochiKit.Base.isNotEmpty(this.responseText)){
+_290=304;
+}
+}
+catch(e){
+}
+if(_290==0||_290==200||_290==201||_290==304){
+d.callback(this);
+}else{
+var err=new MochiKit.Async.XMLHttpRequestError(this,"Request failed");
+if(err.number){
+d.errback(err);
+}else{
+d.errback(err);
+}
+}
+}
+},_xhr_canceller:function(req){
+try{
+req.onreadystatechange=null;
+}
+catch(e){
+try{
+req.onreadystatechange=MochiKit.Async._nothing;
+}
+catch(e){
+}
+}
+req.abort();
+},sendXMLHttpRequest:function(req,_293){
+if(typeof (_293)=="undefined"||_293===null){
+_293="";
+}
+var m=MochiKit.Base;
+var self=MochiKit.Async;
+var d=new self.Deferred(m.partial(self._xhr_canceller,req));
+try{
+req.onreadystatechange=m.bind(self._xhr_onreadystatechange,req,d);
+req.send(_293);
+}
+catch(e){
+try{
+req.onreadystatechange=null;
+}
+catch(ignore){
+}
+d.errback(e);
+}
+return d;
+},doSimpleXMLHttpRequest:function(url){
+var self=MochiKit.Async;
+var req=self.getXMLHttpRequest();
+if(arguments.length>1){
+var m=MochiKit.Base;
+var qs=m.queryString.apply(null,m.extend(null,arguments,1));
+if(qs){
+url+="?"+qs;
+}
+}
+req.open("GET",url,true);
+return self.sendXMLHttpRequest(req);
+},loadJSONDoc:function(url){
+var self=MochiKit.Async;
+var d=self.doSimpleXMLHttpRequest.apply(self,arguments);
+d=d.addCallback(self.evalJSONRequest);
+return d;
+},wait:function(_296,_297){
+var d=new MochiKit.Async.Deferred();
+var m=MochiKit.Base;
+if(typeof (_297)!="undefined"){
+d.addCallback(function(){
+return _297;
+});
+}
+var _298=setTimeout(m.bind("callback",d),Math.floor(_296*1000));
+d.canceller=function(){
+try{
+clearTimeout(_298);
+}
+catch(e){
+}
+};
+return d;
+},callLater:function(_299,func){
+var m=MochiKit.Base;
+var _300=m.partial.apply(m,m.extend(null,arguments,1));
+return MochiKit.Async.wait(_299).addCallback(function(res){
+return _300();
+});
+}});
+MochiKit.Async.DeferredLock=function(){
+this.waiting=[];
+this.locked=false;
+this.id=this._nextId();
+};
+MochiKit.Async.DeferredLock.prototype={__class__:MochiKit.Async.DeferredLock,acquire:function(){
+d=new MochiKit.Async.Deferred();
+if(this.locked){
+this.waiting.push(d);
+}else{
+this.locked=true;
+d.callback(this);
+}
+return d;
+},release:function(){
+if(!this.locked){
+throw TypeError("Tried to release an unlocked DeferredLock");
+}
+this.locked=false;
+if(this.waiting.length>0){
+this.locked=true;
+this.waiting.shift().callback(this);
+}
+},_nextId:MochiKit.Base.counter(),repr:function(){
+var _301;
+if(this.locked){
+_301="locked, "+this.waiting.length+" waiting";
+}else{
+_301="unlocked";
+}
+return "DeferredLock("+this.id+", "+_301+")";
+},toString:MochiKit.Base.forwardCall("repr")};
+MochiKit.Async.DeferredList=function(list,_303,_304,_305,_306){
+this.list=list;
+this.resultList=new Array(this.list.length);
+this.chain=[];
+this.id=this._nextId();
+this.fired=-1;
+this.paused=0;
+this.results=[null,null];
+this.canceller=_306;
+this.silentlyCancelled=false;
+if(this.list.length===0&&!_303){
+this.callback(this.resultList);
+}
+this.finishedCount=0;
+this.fireOnOneCallback=_303;
+this.fireOnOneErrback=_304;
+this.consumeErrors=_305;
+var _307=0;
+MochiKit.Base.map(MochiKit.Base.bind(function(d){
+d.addCallback(MochiKit.Base.bind(this._cbDeferred,this),_307,true);
+d.addErrback(MochiKit.Base.bind(this._cbDeferred,this),_307,false);
+_307+=1;
+},this),this.list);
+};
+MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,MochiKit.Async.Deferred.prototype);
+MochiKit.Base.update(MochiKit.Async.DeferredList.prototype,{_cbDeferred:function(_308,_309,_310){
+this.resultList[_308]=[_309,_310];
+this.finishedCount+=1;
+if(this.fired!==0){
+if(_309&&this.fireOnOneCallback){
+this.callback([_308,_310]);
+}else{
+if(!_309&&this.fireOnOneErrback){
+this.errback(_310);
+}else{
+if(this.finishedCount==this.list.length){
+this.callback(this.resultList);
+}
+}
+}
+}
+if(!_309&&this.consumeErrors){
+_310=null;
+}
+return _310;
+}});
+MochiKit.Async.gatherResults=function(_311){
+var d=new MochiKit.Async.DeferredList(_311,false,true,false);
+d.addCallback(function(_312){
+var ret=[];
+for(var i=0;i<_312.length;i++){
+ret.push(_312[i][1]);
+}
+return ret;
+});
+return d;
+};
+MochiKit.Async.maybeDeferred=function(func){
+var self=MochiKit.Async;
+var _313;
+try{
+var r=func.apply(null,MochiKit.Base.extend([],arguments,1));
+if(r instanceof self.Deferred){
+_313=r;
+}else{
+if(r instanceof Error){
+_313=self.fail(r);
+}else{
+_313=self.succeed(r);
+}
+}
+}
+catch(e){
+_313=self.fail(e);
+}
+return _313;
+};
+MochiKit.Async.EXPORT=["AlreadyCalledError","CancelledError","BrowserComplianceError","GenericError","XMLHttpRequestError","Deferred","succeed","fail","getXMLHttpRequest","doSimpleXMLHttpRequest","loadJSONDoc","wait","callLater","sendXMLHttpRequest","DeferredLock","DeferredList","gatherResults","maybeDeferred"];
+MochiKit.Async.EXPORT_OK=["evalJSONRequest"];
+MochiKit.Async.__new__=function(){
+var m=MochiKit.Base;
+var ne=m.partial(m._newNamedError,this);
+ne("AlreadyCalledError",function(_316){
+this.deferred=_316;
+});
+ne("CancelledError",function(_317){
+this.deferred=_317;
+});
+ne("BrowserComplianceError",function(msg){
+this.message=msg;
+});
+ne("GenericError",function(msg){
+this.message=msg;
+});
+ne("XMLHttpRequestError",function(req,msg){
+this.req=req;
+this.message=msg;
+try{
+this.number=req.status;
+}
+catch(e){
+}
+});
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Async.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Async);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.DOM");
+dojo.require("MochiKit.Iter");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Iter",[]);
+}
+try{
+if(typeof (MochiKit.Iter)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.DOM depends on MochiKit.Iter!";
+}
+if(typeof (MochiKit.DOM)=="undefined"){
+MochiKit.DOM={};
+}
+MochiKit.DOM.NAME="MochiKit.DOM";
+MochiKit.DOM.VERSION="1.3.1";
+MochiKit.DOM.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.DOM.toString=function(){
+return this.__repr__();
+};
+MochiKit.DOM.EXPORT=["formContents","currentWindow","currentDocument","withWindow","withDocument","registerDOMConverter","coerceToDOM","createDOM","createDOMFunc","getNodeAttribute","setNodeAttribute","updateNodeAttributes","appendChildNodes","replaceChildNodes","removeElement","swapDOM","BUTTON","TT","PRE","H1","H2","H3","BR","CANVAS","HR","LABEL","TEXTAREA","FORM","STRONG","SELECT","OPTION","OPTGROUP","LEGEND","FIELDSET","P","UL","OL","LI","TD","TR","THEAD","TBODY","TFOOT","TABLE","TH","INPUT","SPAN","A","DIV","IMG","getElement","$","computedStyle","getElementsByTagAndClassName","addToCallStack","addLoadEvent","focusOnLoad","setElementClass","toggleElementClass","addElementClass","removeElementClass","swapElementClass","hasElementClass","escapeHTML","toHTML","emitHTML","setDisplayForElement","hideElement","showElement","scrapeText","elementDimensions","elementPosition","setElementDimensions","setElementPosition","getViewportDimensions","setOpacity"];
+MochiKit.DOM.EXPORT_OK=["domConverters"];
+MochiKit.DOM.Dimensions=function(w,h){
+this.w=w;
+this.h=h;
+};
+MochiKit.DOM.Dimensions.prototype.repr=function(){
+var repr=MochiKit.Base.repr;
+return "{w: "+repr(this.w)+", h: "+repr(this.h)+"}";
+};
+MochiKit.DOM.Coordinates=function(x,y){
+this.x=x;
+this.y=y;
+};
+MochiKit.DOM.Coordinates.prototype.repr=function(){
+var repr=MochiKit.Base.repr;
+return "{x: "+repr(this.x)+", y: "+repr(this.y)+"}";
+};
+MochiKit.DOM.Coordinates.prototype.toString=function(){
+return this.repr();
+};
+MochiKit.Base.update(MochiKit.DOM,{setOpacity:function(elem,o){
+elem=MochiKit.DOM.getElement(elem);
+MochiKit.DOM.updateNodeAttributes(elem,{"style":{"opacity":o,"-moz-opacity":o,"-khtml-opacity":o,"filter":" alpha(opacity="+(o*100)+")"}});
+},getViewportDimensions:function(){
+var d=new MochiKit.DOM.Dimensions();
+var w=MochiKit.DOM._window;
+var b=MochiKit.DOM._document.body;
+if(w.innerWidth){
+d.w=w.innerWidth;
+d.h=w.innerHeight;
+}else{
+if(b.parentElement.clientWidth){
+d.w=b.parentElement.clientWidth;
+d.h=b.parentElement.clientHeight;
+}else{
+if(b&&b.clientWidth){
+d.w=b.clientWidth;
+d.h=b.clientHeight;
+}
+}
+}
+return d;
+},elementDimensions:function(elem){
+var self=MochiKit.DOM;
+if(typeof (elem.w)=="number"||typeof (elem.h)=="number"){
+return new self.Dimensions(elem.w||0,elem.h||0);
+}
+elem=self.getElement(elem);
+if(!elem){
+return undefined;
+}
+if(self.computedStyle(elem,"display")!="none"){
+return new self.Dimensions(elem.offsetWidth||0,elem.offsetHeight||0);
+}
+var s=elem.style;
+var _322=s.visibility;
+var _323=s.position;
+s.visibility="hidden";
+s.position="absolute";
+s.display="";
+var _324=elem.offsetWidth;
+var _325=elem.offsetHeight;
+s.display="none";
+s.position=_323;
+s.visibility=_322;
+return new self.Dimensions(_324,_325);
+},elementPosition:function(elem,_326){
+var self=MochiKit.DOM;
+elem=self.getElement(elem);
+if(!elem){
+return undefined;
+}
+var c=new self.Coordinates(0,0);
+if(elem.x&&elem.y){
+c.x+=elem.x||0;
+c.y+=elem.y||0;
+return c;
+}else{
+if(elem.parentNode===null||self.computedStyle(elem,"display")=="none"){
+return undefined;
+}
+}
+var box=null;
+var _329=null;
+var d=MochiKit.DOM._document;
+var de=d.documentElement;
+var b=d.body;
+if(elem.getBoundingClientRect){
+box=elem.getBoundingClientRect();
+c.x+=box.left+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
+c.y+=box.top+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
+}else{
+if(d.getBoxObjectFor){
+box=d.getBoxObjectFor(elem);
+c.x+=box.x;
+c.y+=box.y;
+}else{
+if(elem.offsetParent){
+c.x+=elem.offsetLeft;
+c.y+=elem.offsetTop;
+_329=elem.offsetParent;
+if(_329!=elem){
+while(_329){
+c.x+=_329.offsetLeft;
+c.y+=_329.offsetTop;
+_329=_329.offsetParent;
+}
+}
+var ua=navigator.userAgent.toLowerCase();
+if((typeof (opera)!="undefined"&&parseFloat(opera.version())<9)||(ua.indexOf("safari")!=-1&&self.computedStyle(elem,"position")=="absolute")){
+c.x-=b.offsetLeft;
+c.y-=b.offsetTop;
+}
+}
+}
+}
+if(typeof (_326)!="undefined"){
+_326=arguments.callee(_326);
+if(_326){
+c.x-=(_326.x||0);
+c.y-=(_326.y||0);
+}
+}
+if(elem.parentNode){
+_329=elem.parentNode;
+}else{
+_329=null;
+}
+while(_329&&_329.tagName!="BODY"&&_329.tagName!="HTML"){
+c.x-=_329.scrollLeft;
+c.y-=_329.scrollTop;
+if(_329.parentNode){
+_329=_329.parentNode;
+}else{
+_329=null;
+}
+}
+return c;
+},setElementDimensions:function(elem,_332,_333){
+elem=MochiKit.DOM.getElement(elem);
+if(typeof (_333)=="undefined"){
+_333="px";
+}
+MochiKit.DOM.updateNodeAttributes(elem,{"style":{"width":_332.w+_333,"height":_332.h+_333}});
+},setElementPosition:function(elem,_334,_335){
+elem=MochiKit.DOM.getElement(elem);
+if(typeof (_335)=="undefined"){
+_335="px";
+}
+MochiKit.DOM.updateNodeAttributes(elem,{"style":{"left":_334.x+_335,"top":_334.y+_335}});
+},currentWindow:function(){
+return MochiKit.DOM._window;
+},currentDocument:function(){
+return MochiKit.DOM._document;
+},withWindow:function(win,func){
+var self=MochiKit.DOM;
+var _337=self._document;
+var _338=self._win;
+var rval;
+try{
+self._window=win;
+self._document=win.document;
+rval=func();
+}
+catch(e){
+self._window=_338;
+self._document=_337;
+throw e;
+}
+self._window=_338;
+self._document=_337;
+return rval;
+},formContents:function(elem){
+var _339=[];
+var _340=[];
+var m=MochiKit.Base;
+var self=MochiKit.DOM;
+if(typeof (elem)=="undefined"||elem===null){
+elem=self._document;
+}else{
+elem=self.getElement(elem);
+}
+m.nodeWalk(elem,function(elem){
+var name=elem.name;
+if(m.isNotEmpty(name)){
+var _341=elem.nodeName;
+if(_341=="INPUT"&&(elem.type=="radio"||elem.type=="checkbox")&&!elem.checked){
+return null;
+}
+if(_341=="SELECT"){
+if(elem.selectedIndex>=0){
+var opt=elem.options[elem.selectedIndex];
+_339.push(name);
+_340.push((opt.value)?opt.value:opt.text);
+return null;
+}
+_339.push(name);
+_340.push("");
+return null;
+}
+if(_341=="FORM"||_341=="P"||_341=="SPAN"||_341=="DIV"){
+return elem.childNodes;
+}
+_339.push(name);
+_340.push(elem.value||"");
+return null;
+}
+return elem.childNodes;
+});
+return [_339,_340];
+},withDocument:function(doc,func){
+var self=MochiKit.DOM;
+var _344=self._document;
+var rval;
+try{
+self._document=doc;
+rval=func();
+}
+catch(e){
+self._document=_344;
+throw e;
+}
+self._document=_344;
+return rval;
+},registerDOMConverter:function(name,_345,wrap,_346){
+MochiKit.DOM.domConverters.register(name,_345,wrap,_346);
+},coerceToDOM:function(node,ctx){
+var im=MochiKit.Iter;
+var self=MochiKit.DOM;
+var iter=im.iter;
+var _350=im.repeat;
+var imap=im.imap;
+var _352=self.domConverters;
+var _353=self.coerceToDOM;
+var _354=MochiKit.Base.NotFound;
+while(true){
+if(typeof (node)=="undefined"||node===null){
+return null;
+}
+if(typeof (node.nodeType)!="undefined"&&node.nodeType>0){
+return node;
+}
+if(typeof (node)=="number"||typeof (node)=="bool"){
+node=node.toString();
+}
+if(typeof (node)=="string"){
+return self._document.createTextNode(node);
+}
+if(typeof (node.toDOM)=="function"){
+node=node.toDOM(ctx);
+continue;
+}
+if(typeof (node)=="function"){
+node=node(ctx);
+continue;
+}
+var _355=null;
+try{
+_355=iter(node);
+}
+catch(e){
+}
+if(_355){
+return imap(_353,_355,_350(ctx));
+}
+try{
+node=_352.match(node,ctx);
+continue;
+}
+catch(e){
+if(e!=_354){
+throw e;
+}
+}
+return self._document.createTextNode(node.toString());
+}
+return undefined;
+},setNodeAttribute:function(node,attr,_357){
+var o={};
+o[attr]=_357;
+try{
+return MochiKit.DOM.updateNodeAttributes(node,o);
+}
+catch(e){
+}
+return null;
+},getNodeAttribute:function(node,attr){
+var self=MochiKit.DOM;
+var _358=self.attributeArray.renames[attr];
+node=self.getElement(node);
+try{
+if(_358){
+return node[_358];
+}
+return node.getAttribute(attr);
+}
+catch(e){
+}
+return null;
+},updateNodeAttributes:function(node,_359){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)=="string"){
+elem=self.getElement(node);
+}
+if(_359){
+var _360=MochiKit.Base.updatetree;
+if(self.attributeArray.compliant){
+for(var k in _359){
+var v=_359[k];
+if(typeof (v)=="object"&&typeof (elem[k])=="object"){
+_360(elem[k],v);
+}else{
+if(k.substring(0,2)=="on"){
+if(typeof (v)=="string"){
+v=new Function(v);
+}
+elem[k]=v;
+}else{
+elem.setAttribute(k,v);
+}
+}
+}
+}else{
+var _361=self.attributeArray.renames;
+for(k in _359){
+v=_359[k];
+var _362=_361[k];
+if(k=="style"&&typeof (v)=="string"){
+elem.style.cssText=v;
+}else{
+if(typeof (_362)=="string"){
+elem[_362]=v;
+}else{
+if(typeof (elem[k])=="object"&&typeof (v)=="object"){
+_360(elem[k],v);
+}else{
+if(k.substring(0,2)=="on"){
+if(typeof (v)=="string"){
+v=new Function(v);
+}
+elem[k]=v;
+}else{
+elem.setAttribute(k,v);
+}
+}
+}
+}
+}
+}
+}
+return elem;
+},appendChildNodes:function(node){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)=="string"){
+elem=self.getElement(node);
+}
+var _363=[self.coerceToDOM(MochiKit.Base.extend(null,arguments,1),elem)];
+var _364=MochiKit.Base.concat;
+while(_363.length){
+var n=_363.shift();
+if(typeof (n)=="undefined"||n===null){
+}else{
+if(typeof (n.nodeType)=="number"){
+elem.appendChild(n);
+}else{
+_363=_364(n,_363);
+}
+}
+}
+return elem;
+},replaceChildNodes:function(node){
+var elem=node;
+var self=MochiKit.DOM;
+if(typeof (node)=="string"){
+elem=self.getElement(node);
+arguments[0]=elem;
+}
+var _365;
+while((_365=elem.firstChild)){
+elem.removeChild(_365);
+}
+if(arguments.length<2){
+return elem;
+}else{
+return self.appendChildNodes.apply(this,arguments);
+}
+},createDOM:function(name,_366){
+var elem;
+var self=MochiKit.DOM;
+var m=MochiKit.Base;
+if(typeof (_366)=="string"||typeof (_366)=="number"){
+var args=m.extend([name,null],arguments,1);
+return arguments.callee.apply(this,args);
+}
+if(typeof (name)=="string"){
+if(_366&&"name" in _366&&!self.attributeArray.compliant){
+name=("<"+name+" name=\""+self.escapeHTML(_366.name)+"\">");
+}
+elem=self._document.createElement(name);
+}else{
+elem=name;
+}
+if(_366){
+self.updateNodeAttributes(elem,_366);
+}
+if(arguments.length<=2){
+return elem;
+}else{
+var args=m.extend([elem],arguments,2);
+return self.appendChildNodes.apply(this,args);
+}
+},createDOMFunc:function(){
+var m=MochiKit.Base;
+return m.partial.apply(this,m.extend([MochiKit.DOM.createDOM],arguments));
+},swapDOM:function(dest,src){
+var self=MochiKit.DOM;
+dest=self.getElement(dest);
+var _369=dest.parentNode;
+if(src){
+src=self.getElement(src);
+_369.replaceChild(src,dest);
+}else{
+_369.removeChild(dest);
+}
+return src;
+},getElement:function(id){
+var self=MochiKit.DOM;
+if(arguments.length==1){
+return ((typeof (id)=="string")?self._document.getElementById(id):id);
+}else{
+return MochiKit.Base.map(self.getElement,arguments);
+}
+},computedStyle:function(_371,_372,_373){
+if(arguments.length==2){
+_373=_372;
+}
+var self=MochiKit.DOM;
+var el=self.getElement(_371);
+var _375=self._document;
+if(!el||el==_375){
+return undefined;
+}
+if(el.currentStyle){
+return el.currentStyle[_372];
+}
+if(typeof (_375.defaultView)=="undefined"){
+return undefined;
+}
+if(_375.defaultView===null){
+return undefined;
+}
+var _376=_375.defaultView.getComputedStyle(el,null);
+if(typeof (_376)=="undefined"||_376===null){
+return undefined;
+}
+return _376.getPropertyValue(_373);
+},getElementsByTagAndClassName:function(_377,_378,_379){
+var self=MochiKit.DOM;
+if(typeof (_377)=="undefined"||_377===null){
+_377="*";
+}
+if(typeof (_379)=="undefined"||_379===null){
+_379=self._document;
+}
+_379=self.getElement(_379);
+var _380=(_379.getElementsByTagName(_377)||self._document.all);
+if(typeof (_378)=="undefined"||_378===null){
+return MochiKit.Base.extend(null,_380);
+}
+var _381=[];
+for(var i=0;i<_380.length;i++){
+var _382=_380[i];
+var _383=_382.className.split(" ");
+for(var j=0;j<_383.length;j++){
+if(_383[j]==_378){
+_381.push(_382);
+break;
+}
+}
+}
+return _381;
+},_newCallStack:function(path,once){
+var rval=function(){
+var _386=arguments.callee.callStack;
+for(var i=0;i<_386.length;i++){
+if(_386[i].apply(this,arguments)===false){
+break;
+}
+}
+if(once){
+try{
+this[path]=null;
+}
+catch(e){
+}
+}
+};
+rval.callStack=[];
+return rval;
+},addToCallStack:function(_387,path,func,once){
+var self=MochiKit.DOM;
+var _388=_387[path];
+var _389=_388;
+if(!(typeof (_388)=="function"&&typeof (_388.callStack)=="object"&&_388.callStack!==null)){
+_389=self._newCallStack(path,once);
+if(typeof (_388)=="function"){
+_389.callStack.push(_388);
+}
+_387[path]=_389;
+}
+_389.callStack.push(func);
+},addLoadEvent:function(func){
+var self=MochiKit.DOM;
+self.addToCallStack(self._window,"onload",func,true);
+},focusOnLoad:function(_390){
+var self=MochiKit.DOM;
+self.addLoadEvent(function(){
+_390=self.getElement(_390);
+if(_390){
+_390.focus();
+}
+});
+},setElementClass:function(_391,_392){
+var self=MochiKit.DOM;
+var obj=self.getElement(_391);
+if(self.attributeArray.compliant){
+obj.setAttribute("class",_392);
+}else{
+obj.setAttribute("className",_392);
+}
+},toggleElementClass:function(_393){
+var self=MochiKit.DOM;
+for(var i=1;i<arguments.length;i++){
+var obj=self.getElement(arguments[i]);
+if(!self.addElementClass(obj,_393)){
+self.removeElementClass(obj,_393);
+}
+}
+},addElementClass:function(_394,_395){
+var self=MochiKit.DOM;
+var obj=self.getElement(_394);
+var cls=obj.className;
+if(cls.length===0){
+self.setElementClass(obj,_395);
+return true;
+}
+if(cls==_395){
+return false;
+}
+var _397=obj.className.split(" ");
+for(var i=0;i<_397.length;i++){
+if(_397[i]==_395){
+return false;
+}
+}
+self.setElementClass(obj,cls+" "+_395);
+return true;
+},removeElementClass:function(_398,_399){
+var self=MochiKit.DOM;
+var obj=self.getElement(_398);
+var cls=obj.className;
+if(cls.length===0){
+return false;
+}
+if(cls==_399){
+self.setElementClass(obj,"");
+return true;
+}
+var _400=obj.className.split(" ");
+for(var i=0;i<_400.length;i++){
+if(_400[i]==_399){
+_400.splice(i,1);
+self.setElementClass(obj,_400.join(" "));
+return true;
+}
+}
+return false;
+},swapElementClass:function(_401,_402,_403){
+var obj=MochiKit.DOM.getElement(_401);
+var res=MochiKit.DOM.removeElementClass(obj,_402);
+if(res){
+MochiKit.DOM.addElementClass(obj,_403);
+}
+return res;
+},hasElementClass:function(_404,_405){
+var obj=MochiKit.DOM.getElement(_404);
+var _406=obj.className.split(" ");
+for(var i=1;i<arguments.length;i++){
+var good=false;
+for(var j=0;j<_406.length;j++){
+if(_406[j]==arguments[i]){
+good=true;
+break;
+}
+}
+if(!good){
+return false;
+}
+}
+return true;
+},escapeHTML:function(s){
+return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
+},toHTML:function(dom){
+return MochiKit.DOM.emitHTML(dom).join("");
+},emitHTML:function(dom,lst){
+if(typeof (lst)=="undefined"||lst===null){
+lst=[];
+}
+var _409=[dom];
+var self=MochiKit.DOM;
+var _410=self.escapeHTML;
+var _411=self.attributeArray;
+while(_409.length){
+dom=_409.pop();
+if(typeof (dom)=="string"){
+lst.push(dom);
+}else{
+if(dom.nodeType==1){
+lst.push("<"+dom.nodeName.toLowerCase());
+var _412=[];
+var _413=_411(dom);
+for(var i=0;i<_413.length;i++){
+var a=_413[i];
+_412.push([" ",a.name,"=\"",_410(a.value),"\""]);
+}
+_412.sort();
+for(i=0;i<_412.length;i++){
+var _414=_412[i];
+for(var j=0;j<_414.length;j++){
+lst.push(_414[j]);
+}
+}
+if(dom.hasChildNodes()){
+lst.push(">");
+_409.push("</"+dom.nodeName.toLowerCase()+">");
+var _415=dom.childNodes;
+for(i=_415.length-1;i>=0;i--){
+_409.push(_415[i]);
+}
+}else{
+lst.push("/>");
+}
+}else{
+if(dom.nodeType==3){
+lst.push(_410(dom.nodeValue));
+}
+}
+}
+}
+return lst;
+},setDisplayForElement:function(_416,_417){
+var m=MochiKit.Base;
+var _418=m.extend(null,arguments,1);
+MochiKit.Iter.forEach(m.filter(null,m.map(MochiKit.DOM.getElement,_418)),function(_417){
+_417.style.display=_416;
+});
+},scrapeText:function(node,_419){
+var rval=[];
+(function(node){
+var cn=node.childNodes;
+if(cn){
+for(var i=0;i<cn.length;i++){
+arguments.callee.call(this,cn[i]);
+}
+}
+var _421=node.nodeValue;
+if(typeof (_421)=="string"){
+rval.push(_421);
+}
+})(MochiKit.DOM.getElement(node));
+if(_419){
+return rval;
+}else{
+return rval.join("");
+}
+},__new__:function(win){
+var m=MochiKit.Base;
+this._document=document;
+this._window=win;
+this.domConverters=new m.AdapterRegistry();
+var _422=this._document.createElement("span");
+var _423;
+if(_422&&_422.attributes&&_422.attributes.length>0){
+var _424=m.filter;
+_423=function(node){
+return _424(_423.ignoreAttrFilter,node.attributes);
+};
+_423.ignoreAttr={};
+MochiKit.Iter.forEach(_422.attributes,function(a){
+_423.ignoreAttr[a.name]=a.value;
+});
+_423.ignoreAttrFilter=function(a){
+return (_423.ignoreAttr[a.name]!=a.value);
+};
+_423.compliant=false;
+_423.renames={"class":"className","checked":"defaultChecked","usemap":"useMap","for":"htmlFor"};
+}else{
+_423=function(node){
+return node.attributes;
+};
+_423.compliant=true;
+_423.renames={};
+}
+this.attributeArray=_423;
+var _425=this.createDOMFunc;
+this.UL=_425("ul");
+this.OL=_425("ol");
+this.LI=_425("li");
+this.TD=_425("td");
+this.TR=_425("tr");
+this.TBODY=_425("tbody");
+this.THEAD=_425("thead");
+this.TFOOT=_425("tfoot");
+this.TABLE=_425("table");
+this.TH=_425("th");
+this.INPUT=_425("input");
+this.SPAN=_425("span");
+this.A=_425("a");
+this.DIV=_425("div");
+this.IMG=_425("img");
+this.BUTTON=_425("button");
+this.TT=_425("tt");
+this.PRE=_425("pre");
+this.H1=_425("h1");
+this.H2=_425("h2");
+this.H3=_425("h3");
+this.BR=_425("br");
+this.HR=_425("hr");
+this.LABEL=_425("label");
+this.TEXTAREA=_425("textarea");
+this.FORM=_425("form");
+this.P=_425("p");
+this.SELECT=_425("select");
+this.OPTION=_425("option");
+this.OPTGROUP=_425("optgroup");
+this.LEGEND=_425("legend");
+this.FIELDSET=_425("fieldset");
+this.STRONG=_425("strong");
+this.CANVAS=_425("canvas");
+this.hideElement=m.partial(this.setDisplayForElement,"none");
+this.showElement=m.partial(this.setDisplayForElement,"block");
+this.removeElement=this.swapDOM;
+this.$=this.getElement;
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+}});
+MochiKit.DOM.__new__(((typeof (window)=="undefined")?this:window));
+if(!MochiKit.__compat__){
+withWindow=MochiKit.DOM.withWindow;
+withDocument=MochiKit.DOM.withDocument;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.DOM);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.LoggingPane");
+dojo.require("MochiKit.Logging");
+dojo.require("MochiKit.Base");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Logging",[]);
+JSAN.use("MochiKit.Base",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"||typeof (MochiKit.Logging)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.LoggingPane depends on MochiKit.Base and MochiKit.Logging!";
+}
+if(typeof (MochiKit.LoggingPane)=="undefined"){
+MochiKit.LoggingPane={};
+}
+MochiKit.LoggingPane.NAME="MochiKit.LoggingPane";
+MochiKit.LoggingPane.VERSION="1.3.1";
+MochiKit.LoggingPane.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.LoggingPane.toString=function(){
+return this.__repr__();
+};
+MochiKit.LoggingPane.createLoggingPane=function(_426){
+var m=MochiKit.LoggingPane;
+_426=!(!_426);
+if(m._loggingPane&&m._loggingPane.inline!=_426){
+m._loggingPane.closePane();
+m._loggingPane=null;
+}
+if(!m._loggingPane||m._loggingPane.closed){
+m._loggingPane=new m.LoggingPane(_426,MochiKit.Logging.logger);
+}
+return m._loggingPane;
+};
+MochiKit.LoggingPane.LoggingPane=function(_427,_428){
+if(typeof (_428)=="undefined"||_428===null){
+_428=MochiKit.Logging.logger;
+}
+this.logger=_428;
+var _429=MochiKit.Base.update;
+var _430=MochiKit.Base.updatetree;
+var bind=MochiKit.Base.bind;
+var _431=MochiKit.Base.clone;
+var win=window;
+var uid="_MochiKit_LoggingPane";
+if(typeof (MochiKit.DOM)!="undefined"){
+win=MochiKit.DOM.currentWindow();
+}
+if(!_427){
+var url=win.location.href.split("?")[0].replace(/[:\/.><&]/g,"_");
+var name=uid+"_"+url;
+var nwin=win.open("",name,"dependent,resizable,height=200");
+if(!nwin){
+alert("Not able to open debugging window due to pop-up blocking.");
+return undefined;
+}
+nwin.document.write("<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\" "+"\"http://www.w3.org/TR/html4/loose.dtd\">"+"<html><head><title>[MochiKit.LoggingPane]</title></head>"+"<body></body></html>");
+nwin.document.close();
+nwin.document.title+=" "+win.document.title;
+win=nwin;
+}
+var doc=win.document;
+this.doc=doc;
+var _434=doc.getElementById(uid);
+var _435=!!_434;
+if(_434&&typeof (_434.loggingPane)!="undefined"){
+_434.loggingPane.logger=this.logger;
+_434.loggingPane.buildAndApplyFilter();
+return _434.loggingPane;
+}
+if(_435){
+var _436;
+while((_436=_434.firstChild)){
+_434.removeChild(_436);
+}
+}else{
+_434=doc.createElement("div");
+_434.id=uid;
+}
+_434.loggingPane=this;
+var _437=doc.createElement("input");
+var _438=doc.createElement("input");
+var _439=doc.createElement("button");
+var _440=doc.createElement("button");
+var _441=doc.createElement("button");
+var _442=doc.createElement("button");
+var _443=doc.createElement("div");
+var _444=doc.createElement("div");
+var _445=uid+"_Listener";
+this.colorTable=_431(this.colorTable);
+var _446=[];
+var _447=null;
+var _448=function(msg){
+var _449=msg.level;
+if(typeof (_449)=="number"){
+_449=MochiKit.Logging.LogLevel[_449];
+}
+return _449;
+};
+var _450=function(msg){
+return msg.info.join(" ");
+};
+var _451=bind(function(msg){
+var _452=_448(msg);
+var text=_450(msg);
+var c=this.colorTable[_452];
+var p=doc.createElement("span");
+p.className="MochiKit-LogMessage MochiKit-LogLevel-"+_452;
+p.style.cssText="margin: 0px; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; white-space: pre-wrap; white-space: pre-line; word-wrap: break-word; wrap-option: emergency; color: "+c;
+p.appendChild(doc.createTextNode(_452+": "+text));
+_444.appendChild(p);
+_444.appendChild(doc.createElement("br"));
+if(_443.offsetHeight>_443.scrollHeight){
+_443.scrollTop=0;
+}else{
+_443.scrollTop=_443.scrollHeight;
+}
+},this);
+var _454=function(msg){
+_446[_446.length]=msg;
+_451(msg);
+};
+var _455=function(){
+var _456,infore;
+try{
+_456=new RegExp(_437.value);
+infore=new RegExp(_438.value);
+}
+catch(e){
+logDebug("Error in filter regex: "+e.message);
+return null;
+}
+return function(msg){
+return (_456.test(_448(msg))&&infore.test(_450(msg)));
+};
+};
+var _457=function(){
+while(_444.firstChild){
+_444.removeChild(_444.firstChild);
+}
+};
+var _458=function(){
+_446=[];
+_457();
+};
+var _459=bind(function(){
+if(this.closed){
+return;
+}
+this.closed=true;
+if(MochiKit.LoggingPane._loggingPane==this){
+MochiKit.LoggingPane._loggingPane=null;
+}
+this.logger.removeListener(_445);
+_434.loggingPane=null;
+if(_427){
+_434.parentNode.removeChild(_434);
+}else{
+this.win.close();
+}
+},this);
+var _460=function(){
+_457();
+for(var i=0;i<_446.length;i++){
+var msg=_446[i];
+if(_447===null||_447(msg)){
+_451(msg);
+}
+}
+};
+this.buildAndApplyFilter=function(){
+_447=_455();
+_460();
+this.logger.removeListener(_445);
+this.logger.addListener(_445,_447,_454);
+};
+var _461=bind(function(){
+_446=this.logger.getMessages();
+_460();
+},this);
+var _462=bind(function(_463){
+_463=_463||window.event;
+key=_463.which||_463.keyCode;
+if(key==13){
+this.buildAndApplyFilter();
+}
+},this);
+var _464="display: block; z-index: 1000; left: 0px; bottom: 0px; position: fixed; width: 100%; background-color: white; font: "+this.logFont;
+if(_427){
+_464+="; height: 10em; border-top: 2px solid black";
+}else{
+_464+="; height: 100%;";
+}
+_434.style.cssText=_464;
+if(!_435){
+doc.body.appendChild(_434);
+}
+_464={"cssText":"width: 33%; display: inline; font: "+this.logFont};
+_430(_437,{"value":"FATAL|ERROR|WARNING|INFO|DEBUG","onkeypress":_462,"style":_464});
+_434.appendChild(_437);
+_430(_438,{"value":".*","onkeypress":_462,"style":_464});
+_434.appendChild(_438);
+_464="width: 8%; display:inline; font: "+this.logFont;
+_439.appendChild(doc.createTextNode("Filter"));
+_439.onclick=bind("buildAndApplyFilter",this);
+_439.style.cssText=_464;
+_434.appendChild(_439);
+_440.appendChild(doc.createTextNode("Load"));
+_440.onclick=_461;
+_440.style.cssText=_464;
+_434.appendChild(_440);
+_441.appendChild(doc.createTextNode("Clear"));
+_441.onclick=_458;
+_441.style.cssText=_464;
+_434.appendChild(_441);
+_442.appendChild(doc.createTextNode("Close"));
+_442.onclick=_459;
+_442.style.cssText=_464;
+_434.appendChild(_442);
+_443.style.cssText="overflow: auto; width: 100%";
+_444.style.cssText="width: 100%; height: "+(_427?"8em":"100%");
+_443.appendChild(_444);
+_434.appendChild(_443);
+this.buildAndApplyFilter();
+_461();
+if(_427){
+this.win=undefined;
+}else{
+this.win=win;
+}
+this.inline=_427;
+this.closePane=_459;
+this.closed=false;
+return this;
+};
+MochiKit.LoggingPane.LoggingPane.prototype={"logFont":"8pt Verdana,sans-serif","colorTable":{"ERROR":"red","FATAL":"darkred","WARNING":"blue","INFO":"black","DEBUG":"green"}};
+MochiKit.LoggingPane.EXPORT_OK=["LoggingPane"];
+MochiKit.LoggingPane.EXPORT=["createLoggingPane"];
+MochiKit.LoggingPane.__new__=function(){
+this.EXPORT_TAGS={":common":this.EXPORT,":all":MochiKit.Base.concat(this.EXPORT,this.EXPORT_OK)};
+MochiKit.Base.nameFunctions(this);
+MochiKit.LoggingPane._loggingPane=null;
+};
+MochiKit.LoggingPane.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.LoggingPane);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Color");
+dojo.require("MochiKit.Base");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Color depends on MochiKit.Base";
+}
+if(typeof (MochiKit.Color)=="undefined"){
+MochiKit.Color={};
+}
+MochiKit.Color.NAME="MochiKit.Color";
+MochiKit.Color.VERSION="1.3.1";
+MochiKit.Color.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.Color.toString=function(){
+return this.__repr__();
+};
+MochiKit.Color.Color=function(red,_466,blue,_468){
+if(typeof (_468)=="undefined"||_468===null){
+_468=1;
+}
+this.rgb={r:red,g:_466,b:blue,a:_468};
+};
+MochiKit.Color.Color.prototype={__class__:MochiKit.Color.Color,colorWithAlpha:function(_469){
+var rgb=this.rgb;
+var m=MochiKit.Color;
+return m.Color.fromRGB(rgb.r,rgb.g,rgb.b,_469);
+},colorWithHue:function(hue){
+var hsl=this.asHSL();
+hsl.h=hue;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},colorWithSaturation:function(_473){
+var hsl=this.asHSL();
+hsl.s=_473;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},colorWithLightness:function(_474){
+var hsl=this.asHSL();
+hsl.l=_474;
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},darkerColorWithLevel:function(_475){
+var hsl=this.asHSL();
+hsl.l=Math.max(hsl.l-_475,0);
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},lighterColorWithLevel:function(_476){
+var hsl=this.asHSL();
+hsl.l=Math.min(hsl.l+_476,1);
+var m=MochiKit.Color;
+return m.Color.fromHSL(hsl);
+},blendedColor:function(_477,_478){
+if(typeof (_478)=="undefined"||_478===null){
+_478=0.5;
+}
+var sf=1-_478;
+var s=this.rgb;
+var d=_477.rgb;
+var df=_478;
+return MochiKit.Color.Color.fromRGB((s.r*sf)+(d.r*df),(s.g*sf)+(d.g*df),(s.b*sf)+(d.b*df),(s.a*sf)+(d.a*df));
+},compareRGB:function(_481){
+var a=this.asRGB();
+var b=_481.asRGB();
+return MochiKit.Base.compare([a.r,a.g,a.b,a.a],[b.r,b.g,b.b,b.a]);
+},isLight:function(){
+return this.asHSL().b>0.5;
+},isDark:function(){
+return (!this.isLight());
+},toHSLString:function(){
+var c=this.asHSL();
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._hslString;
+if(!rval){
+var mid=(ccc(c.h,360).toFixed(0)+","+ccc(c.s,100).toPrecision(4)+"%"+","+ccc(c.l,100).toPrecision(4)+"%");
+var a=c.a;
+if(a>=1){
+a=1;
+rval="hsl("+mid+")";
+}else{
+if(a<=0){
+a=0;
+}
+rval="hsla("+mid+","+a+")";
+}
+this._hslString=rval;
+}
+return rval;
+},toRGBString:function(){
+var c=this.rgb;
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._rgbString;
+if(!rval){
+var mid=(ccc(c.r,255).toFixed(0)+","+ccc(c.g,255).toFixed(0)+","+ccc(c.b,255).toFixed(0));
+if(c.a!=1){
+rval="rgba("+mid+","+c.a+")";
+}else{
+rval="rgb("+mid+")";
+}
+this._rgbString=rval;
+}
+return rval;
+},asRGB:function(){
+return MochiKit.Base.clone(this.rgb);
+},toHexString:function(){
+var m=MochiKit.Color;
+var c=this.rgb;
+var ccc=MochiKit.Color.clampColorComponent;
+var rval=this._hexString;
+if(!rval){
+rval=("#"+m.toColorPart(ccc(c.r,255))+m.toColorPart(ccc(c.g,255))+m.toColorPart(ccc(c.b,255)));
+this._hexString=rval;
+}
+return rval;
+},asHSV:function(){
+var hsv=this.hsv;
+var c=this.rgb;
+if(typeof (hsv)=="undefined"||hsv===null){
+hsv=MochiKit.Color.rgbToHSV(this.rgb);
+this.hsv=hsv;
+}
+return MochiKit.Base.clone(hsv);
+},asHSL:function(){
+var hsl=this.hsl;
+var c=this.rgb;
+if(typeof (hsl)=="undefined"||hsl===null){
+hsl=MochiKit.Color.rgbToHSL(this.rgb);
+this.hsl=hsl;
+}
+return MochiKit.Base.clone(hsl);
+},toString:function(){
+return this.toRGBString();
+},repr:function(){
+var c=this.rgb;
+var col=[c.r,c.g,c.b,c.a];
+return this.__class__.NAME+"("+col.join(", ")+")";
+}};
+MochiKit.Base.update(MochiKit.Color.Color,{fromRGB:function(red,_486,blue,_487){
+var _488=MochiKit.Color.Color;
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_486=rgb.g;
+blue=rgb.b;
+if(typeof (rgb.a)=="undefined"){
+_487=undefined;
+}else{
+_487=rgb.a;
+}
+}
+return new _488(red,_486,blue,_487);
+},fromHSL:function(hue,_489,_490,_491){
+var m=MochiKit.Color;
+return m.Color.fromRGB(m.hslToRGB.apply(m,arguments));
+},fromHSV:function(hue,_492,_493,_494){
+var m=MochiKit.Color;
+return m.Color.fromRGB(m.hsvToRGB.apply(m,arguments));
+},fromName:function(name){
+var _495=MochiKit.Color.Color;
+if(name.charAt(0)=="\""){
+name=name.substr(1,name.length-2);
+}
+var _496=_495._namedColors[name.toLowerCase()];
+if(typeof (_496)=="string"){
+return _495.fromHexString(_496);
+}else{
+if(name=="transparent"){
+return _495.transparentColor();
+}
+}
+return null;
+},fromString:function(_497){
+var self=MochiKit.Color.Color;
+var _498=_497.substr(0,3);
+if(_498=="rgb"){
+return self.fromRGBString(_497);
+}else{
+if(_498=="hsl"){
+return self.fromHSLString(_497);
+}else{
+if(_497.charAt(0)=="#"){
+return self.fromHexString(_497);
+}
+}
+}
+return self.fromName(_497);
+},fromHexString:function(_499){
+if(_499.charAt(0)=="#"){
+_499=_499.substring(1);
+}
+var _500=[];
+var i,hex;
+if(_499.length==3){
+for(i=0;i<3;i++){
+hex=_499.substr(i,1);
+_500.push(parseInt(hex+hex,16)/255);
+}
+}else{
+for(i=0;i<6;i+=2){
+hex=_499.substr(i,2);
+_500.push(parseInt(hex,16)/255);
+}
+}
+var _501=MochiKit.Color.Color;
+return _501.fromRGB.apply(_501,_500);
+},_fromColorString:function(pre,_503,_504,_505){
+if(_505.indexOf(pre)===0){
+_505=_505.substring(_505.indexOf("(",3)+1,_505.length-1);
+}
+var _506=_505.split(/\s*,\s*/);
+var _507=[];
+for(var i=0;i<_506.length;i++){
+var c=_506[i];
+var val;
+var _508=c.substring(c.length-3);
+if(c.charAt(c.length-1)=="%"){
+val=0.01*parseFloat(c.substring(0,c.length-1));
+}else{
+if(_508=="deg"){
+val=parseFloat(c)/360;
+}else{
+if(_508=="rad"){
+val=parseFloat(c)/(Math.PI*2);
+}else{
+val=_504[i]*parseFloat(c);
+}
+}
+}
+_507.push(val);
+}
+return this[_503].apply(this,_507);
+},fromComputedStyle:function(elem,_509,_510){
+var d=MochiKit.DOM;
+var cls=MochiKit.Color.Color;
+for(elem=d.getElement(elem);elem;elem=elem.parentNode){
+var _511=d.computedStyle.apply(d,arguments);
+if(!_511){
+continue;
+}
+var _512=cls.fromString(_511);
+if(!_512){
+break;
+}
+if(_512.asRGB().a>0){
+return _512;
+}
+}
+return null;
+},fromBackground:function(elem){
+var cls=MochiKit.Color.Color;
+return cls.fromComputedStyle(elem,"backgroundColor","background-color")||cls.whiteColor();
+},fromText:function(elem){
+var cls=MochiKit.Color.Color;
+return cls.fromComputedStyle(elem,"color","color")||cls.blackColor();
+},namedColors:function(){
+return MochiKit.Base.clone(MochiKit.Color.Color._namedColors);
+}});
+MochiKit.Base.update(MochiKit.Color,{clampColorComponent:function(v,_513){
+v*=_513;
+if(v<0){
+return 0;
+}else{
+if(v>_513){
+return _513;
+}else{
+return v;
+}
+}
+},_hslValue:function(n1,n2,hue){
+if(hue>6){
+hue-=6;
+}else{
+if(hue<0){
+hue+=6;
+}
+}
+var val;
+if(hue<1){
+val=n1+(n2-n1)*hue;
+}else{
+if(hue<3){
+val=n2;
+}else{
+if(hue<4){
+val=n1+(n2-n1)*(4-hue);
+}else{
+val=n1;
+}
+}
+}
+return val;
+},hsvToRGB:function(hue,_516,_517,_518){
+if(arguments.length==1){
+var hsv=hue;
+hue=hsv.h;
+_516=hsv.s;
+_517=hsv.v;
+_518=hsv.a;
+}
+var red;
+var _519;
+var blue;
+if(_516===0){
+red=0;
+_519=0;
+blue=0;
+}else{
+var i=Math.floor(hue*6);
+var f=(hue*6)-i;
+var p=_517*(1-_516);
+var q=_517*(1-(_516*f));
+var t=_517*(1-(_516*(1-f)));
+switch(i){
+case 1:
+red=q;
+_519=_517;
+blue=p;
+break;
+case 2:
+red=p;
+_519=_517;
+blue=t;
+break;
+case 3:
+red=p;
+_519=q;
+blue=_517;
+break;
+case 4:
+red=t;
+_519=p;
+blue=_517;
+break;
+case 5:
+red=_517;
+_519=p;
+blue=q;
+break;
+case 6:
+case 0:
+red=_517;
+_519=t;
+blue=p;
+break;
+}
+}
+return {r:red,g:_519,b:blue,a:_518};
+},hslToRGB:function(hue,_521,_522,_523){
+if(arguments.length==1){
+var hsl=hue;
+hue=hsl.h;
+_521=hsl.s;
+_522=hsl.l;
+_523=hsl.a;
+}
+var red;
+var _524;
+var blue;
+if(_521===0){
+red=_522;
+_524=_522;
+blue=_522;
+}else{
+var m2;
+if(_522<=0.5){
+m2=_522*(1+_521);
+}else{
+m2=_522+_521-(_522*_521);
+}
+var m1=(2*_522)-m2;
+var f=MochiKit.Color._hslValue;
+var h6=hue*6;
+red=f(m1,m2,h6+2);
+_524=f(m1,m2,h6);
+blue=f(m1,m2,h6-2);
+}
+return {r:red,g:_524,b:blue,a:_523};
+},rgbToHSV:function(red,_528,blue,_529){
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_528=rgb.g;
+blue=rgb.b;
+_529=rgb.a;
+}
+var max=Math.max(Math.max(red,_528),blue);
+var min=Math.min(Math.min(red,_528),blue);
+var hue;
+var _532;
+var _533=max;
+if(min==max){
+hue=0;
+_532=0;
+}else{
+var _534=(max-min);
+_532=_534/max;
+if(red==max){
+hue=(_528-blue)/_534;
+}else{
+if(_528==max){
+hue=2+((blue-red)/_534);
+}else{
+hue=4+((red-_528)/_534);
+}
+}
+hue/=6;
+if(hue<0){
+hue+=1;
+}
+if(hue>1){
+hue-=1;
+}
+}
+return {h:hue,s:_532,v:_533,a:_529};
+},rgbToHSL:function(red,_535,blue,_536){
+if(arguments.length==1){
+var rgb=red;
+red=rgb.r;
+_535=rgb.g;
+blue=rgb.b;
+_536=rgb.a;
+}
+var max=Math.max(red,Math.max(_535,blue));
+var min=Math.min(red,Math.min(_535,blue));
+var hue;
+var _537;
+var _538=(max+min)/2;
+var _539=max-min;
+if(_539===0){
+hue=0;
+_537=0;
+}else{
+if(_538<=0.5){
+_537=_539/(max+min);
+}else{
+_537=_539/(2-max-min);
+}
+if(red==max){
+hue=(_535-blue)/_539;
+}else{
+if(_535==max){
+hue=2+((blue-red)/_539);
+}else{
+hue=4+((red-_535)/_539);
+}
+}
+hue/=6;
+if(hue<0){
+hue+=1;
+}
+if(hue>1){
+hue-=1;
+}
+}
+return {h:hue,s:_537,l:_538,a:_536};
+},toColorPart:function(num){
+num=Math.round(num);
+var _540=num.toString(16);
+if(num<16){
+return "0"+_540;
+}
+return _540;
+},__new__:function(){
+var m=MochiKit.Base;
+this.Color.fromRGBString=m.bind(this.Color._fromColorString,this.Color,"rgb","fromRGB",[1/255,1/255,1/255,1]);
+this.Color.fromHSLString=m.bind(this.Color._fromColorString,this.Color,"hsl","fromHSL",[1/360,0.01,0.01,1]);
+var _541=1/3;
+var _542={black:[0,0,0],blue:[0,0,1],brown:[0.6,0.4,0.2],cyan:[0,1,1],darkGray:[_541,_541,_541],gray:[0.5,0.5,0.5],green:[0,1,0],lightGray:[2*_541,2*_541,2*_541],magenta:[1,0,1],orange:[1,0.5,0],purple:[0.5,0,0.5],red:[1,0,0],transparent:[0,0,0,0],white:[1,1,1],yellow:[1,1,0]};
+var _543=function(name,r,g,b,a){
+var rval=this.fromRGB(r,g,b,a);
+this[name]=function(){
+return rval;
+};
+return rval;
+};
+for(var k in _542){
+var name=k+"Color";
+var _545=m.concat([_543,this.Color,name],_542[k]);
+this.Color[name]=m.bind.apply(null,_545);
+}
+var _546=function(){
+for(var i=0;i<arguments.length;i++){
+if(!(arguments[i] instanceof Color)){
+return false;
+}
+}
+return true;
+};
+var _547=function(a,b){
+return a.compareRGB(b);
+};
+m.nameFunctions(this);
+m.registerComparator(this.Color.NAME,_546,_547);
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+}});
+MochiKit.Color.EXPORT=["Color"];
+MochiKit.Color.EXPORT_OK=["clampColorComponent","rgbToHSL","hslToRGB","rgbToHSV","hsvToRGB","toColorPart"];
+MochiKit.Color.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Color);
+MochiKit.Color.Color._namedColors={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgree!
 n:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc!
 ",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"!
 #f5fffa"
,mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Signal");
+dojo.require("MochiKit.Base");
+dojo.require("MochiKit.DOM");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+JSAN.use("MochiKit.DOM",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Signal depends on MochiKit.Base!";
+}
+try{
+if(typeof (MochiKit.DOM)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Signal depends on MochiKit.DOM!";
+}
+if(typeof (MochiKit.Signal)=="undefined"){
+MochiKit.Signal={};
+}
+MochiKit.Signal.NAME="MochiKit.Signal";
+MochiKit.Signal.VERSION="1.3.1";
+MochiKit.Signal._observers=[];
+MochiKit.Signal.Event=function(src,e){
+this._event=e||window.event;
+this._src=src;
+};
+MochiKit.Base.update(MochiKit.Signal.Event.prototype,{__repr__:function(){
+var repr=MochiKit.Base.repr;
+var str="{event(): "+repr(this.event())+", src(): "+repr(this.src())+", type(): "+repr(this.type())+", target(): "+repr(this.target())+", modifier(): "+"{alt: "+repr(this.modifier().alt)+", ctrl: "+repr(this.modifier().ctrl)+", meta: "+repr(this.modifier().meta)+", shift: "+repr(this.modifier().shift)+", any: "+repr(this.modifier().any)+"}";
+if(this.type()&&this.type().indexOf("key")===0){
+str+=", key(): {code: "+repr(this.key().code)+", string: "+repr(this.key().string)+"}";
+}
+if(this.type()&&(this.type().indexOf("mouse")===0||this.type().indexOf("click")!=-1||this.type()=="contextmenu")){
+str+=", mouse(): {page: "+repr(this.mouse().page)+", client: "+repr(this.mouse().client);
+if(this.type()!="mousemove"){
+str+=", button: {left: "+repr(this.mouse().button.left)+", middle: "+repr(this.mouse().button.middle)+", right: "+repr(this.mouse().button.right)+"}}";
+}else{
+str+="}";
+}
+}
+if(this.type()=="mouseover"||this.type()=="mouseout"){
+str+=", relatedTarget(): "+repr(this.relatedTarget());
+}
+str+="}";
+return str;
+},toString:function(){
+return this.__repr__();
+},src:function(){
+return this._src;
+},event:function(){
+return this._event;
+},type:function(){
+return this._event.type||undefined;
+},target:function(){
+return this._event.target||this._event.srcElement;
+},relatedTarget:function(){
+if(this.type()=="mouseover"){
+return (this._event.relatedTarget||this._event.fromElement);
+}else{
+if(this.type()=="mouseout"){
+return (this._event.relatedTarget||this._event.toElement);
+}
+}
+return undefined;
+},modifier:function(){
+var m={};
+m.alt=this._event.altKey;
+m.ctrl=this._event.ctrlKey;
+m.meta=this._event.metaKey||false;
+m.shift=this._event.shiftKey;
+m.any=m.alt||m.ctrl||m.shift||m.meta;
+return m;
+},key:function(){
+var k={};
+if(this.type()&&this.type().indexOf("key")===0){
+if(this.type()=="keydown"||this.type()=="keyup"){
+k.code=this._event.keyCode;
+k.string=(MochiKit.Signal._specialKeys[k.code]||"KEY_UNKNOWN");
+return k;
+}else{
+if(this.type()=="keypress"){
+k.code=0;
+k.string="";
+if(typeof (this._event.charCode)!="undefined"&&this._event.charCode!==0&&!MochiKit.Signal._specialMacKeys[this._event.charCode]){
+k.code=this._event.charCode;
+k.string=String.fromCharCode(k.code);
+}else{
+if(this._event.keyCode&&typeof (this._event.charCode)=="undefined"){
+k.code=this._event.keyCode;
+k.string=String.fromCharCode(k.code);
+}
+}
+return k;
+}
+}
+}
+return undefined;
+},mouse:function(){
+var m={};
+var e=this._event;
+if(this.type()&&(this.type().indexOf("mouse")===0||this.type().indexOf("click")!=-1||this.type()=="contextmenu")){
+m.client=new MochiKit.DOM.Coordinates(0,0);
+if(e.clientX||e.clientY){
+m.client.x=(!e.clientX||e.clientX<0)?0:e.clientX;
+m.client.y=(!e.clientY||e.clientY<0)?0:e.clientY;
+}
+m.page=new MochiKit.DOM.Coordinates(0,0);
+if(e.pageX||e.pageY){
+m.page.x=(!e.pageX||e.pageX<0)?0:e.pageX;
+m.page.y=(!e.pageY||e.pageY<0)?0:e.pageY;
+}else{
+var de=MochiKit.DOM._document.documentElement;
+var b=MochiKit.DOM._document.body;
+m.page.x=e.clientX+(de.scrollLeft||b.scrollLeft)-(de.clientLeft||b.clientLeft);
+m.page.y=e.clientY+(de.scrollTop||b.scrollTop)-(de.clientTop||b.clientTop);
+}
+if(this.type()!="mousemove"){
+m.button={};
+m.button.left=false;
+m.button.right=false;
+m.button.middle=false;
+if(e.which){
+m.button.left=(e.which==1);
+m.button.middle=(e.which==2);
+m.button.right=(e.which==3);
+}else{
+m.button.left=!!(e.button&1);
+m.button.right=!!(e.button&2);
+m.button.middle=!!(e.button&4);
+}
+}
+return m;
+}
+return undefined;
+},stop:function(){
+this.stopPropagation();
+this.preventDefault();
+},stopPropagation:function(){
+if(this._event.stopPropagation){
+this._event.stopPropagation();
+}else{
+this._event.cancelBubble=true;
+}
+},preventDefault:function(){
+if(this._event.preventDefault){
+this._event.preventDefault();
+}else{
+this._event.returnValue=false;
+}
+}});
+MochiKit.Signal._specialMacKeys={3:"KEY_ENTER",63289:"KEY_NUM_PAD_CLEAR",63276:"KEY_PAGE_UP",63277:"KEY_PAGE_DOWN",63275:"KEY_END",63273:"KEY_HOME",63234:"KEY_ARROW_LEFT",63232:"KEY_ARROW_UP",63235:"KEY_ARROW_RIGHT",63233:"KEY_ARROW_DOWN",63302:"KEY_INSERT",63272:"KEY_DELETE"};
+for(i=63236;i<=63242;i++){
+MochiKit.Signal._specialMacKeys[i]="KEY_F"+(i-63236+1);
+}
+MochiKit.Signal._specialKeys={8:"KEY_BACKSPACE",9:"KEY_TAB",12:"KEY_NUM_PAD_CLEAR",13:"KEY_ENTER",16:"KEY_SHIFT",17:"KEY_CTRL",18:"KEY_ALT",19:"KEY_PAUSE",20:"KEY_CAPS_LOCK",27:"KEY_ESCAPE",32:"KEY_SPACEBAR",33:"KEY_PAGE_UP",34:"KEY_PAGE_DOWN",35:"KEY_END",36:"KEY_HOME",37:"KEY_ARROW_LEFT",38:"KEY_ARROW_UP",39:"KEY_ARROW_RIGHT",40:"KEY_ARROW_DOWN",44:"KEY_PRINT_SCREEN",45:"KEY_INSERT",46:"KEY_DELETE",59:"KEY_SEMICOLON",91:"KEY_WINDOWS_LEFT",92:"KEY_WINDOWS_RIGHT",93:"KEY_SELECT",106:"KEY_NUM_PAD_ASTERISK",107:"KEY_NUM_PAD_PLUS_SIGN",109:"KEY_NUM_PAD_HYPHEN-MINUS",110:"KEY_NUM_PAD_FULL_STOP",111:"KEY_NUM_PAD_SOLIDUS",144:"KEY_NUM_LOCK",145:"KEY_SCROLL_LOCK",186:"KEY_SEMICOLON",187:"KEY_EQUALS_SIGN",188:"KEY_COMMA",189:"KEY_HYPHEN-MINUS",190:"KEY_FULL_STOP",191:"KEY_SOLIDUS",192:"KEY_GRAVE_ACCENT",219:"KEY_LEFT_SQUARE_BRACKET",220:"KEY_REVERSE_SOLIDUS",221:"KEY_RIGHT_SQUARE_BRACKET",222:"KEY_APOSTROPHE"};
+for(var i=48;i<=57;i++){
+MochiKit.Signal._specialKeys[i]="KEY_"+(i-48);
+}
+for(i=65;i<=90;i++){
+MochiKit.Signal._specialKeys[i]="KEY_"+String.fromCharCode(i);
+}
+for(i=96;i<=105;i++){
+MochiKit.Signal._specialKeys[i]="KEY_NUM_PAD_"+(i-96);
+}
+for(i=112;i<=123;i++){
+MochiKit.Signal._specialKeys[i]="KEY_F"+(i-112+1);
+}
+MochiKit.Base.update(MochiKit.Signal,{__repr__:function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+},toString:function(){
+return this.__repr__();
+},_unloadCache:function(){
+var self=MochiKit.Signal;
+var _548=self._observers;
+for(var i=0;i<_548.length;i++){
+self._disconnect(_548[i]);
+}
+delete self._observers;
+try{
+window.onload=undefined;
+}
+catch(e){
+}
+try{
+window.onunload=undefined;
+}
+catch(e){
+}
+},_listener:function(src,func,obj,_549){
+var E=MochiKit.Signal.Event;
+if(!_549){
+return MochiKit.Base.bind(func,obj);
+}
+obj=obj||src;
+if(typeof (func)=="string"){
+return function(_551){
+obj[func].apply(obj,[new E(src,_551)]);
+};
+}else{
+return function(_552){
+func.apply(obj,[new E(src,_552)]);
+};
+}
+},connect:function(src,sig,_554,_555){
+src=MochiKit.DOM.getElement(src);
+var self=MochiKit.Signal;
+if(typeof (sig)!="string"){
+throw new Error("'sig' must be a string");
+}
+var obj=null;
+var func=null;
+if(typeof (_555)!="undefined"){
+obj=_554;
+func=_555;
+if(typeof (_555)=="string"){
+if(typeof (_554[_555])!="function"){
+throw new Error("'funcOrStr' must be a function on 'objOrFunc'");
+}
+}else{
+if(typeof (_555)!="function"){
+throw new Error("'funcOrStr' must be a function or string");
+}
+}
+}else{
+if(typeof (_554)!="function"){
+throw new Error("'objOrFunc' must be a function if 'funcOrStr' is not given");
+}else{
+func=_554;
+}
+}
+if(typeof (obj)=="undefined"||obj===null){
+obj=src;
+}
+var _556=!!(src.addEventListener||src.attachEvent);
+var _557=self._listener(src,func,obj,_556);
+if(src.addEventListener){
+src.addEventListener(sig.substr(2),_557,false);
+}else{
+if(src.attachEvent){
+src.attachEvent(sig,_557);
+}
+}
+var _558=[src,sig,_557,_556,_554,_555];
+self._observers.push(_558);
+return _558;
+},_disconnect:function(_559){
+if(!_559[3]){
+return;
+}
+var src=_559[0];
+var sig=_559[1];
+var _560=_559[2];
+if(src.removeEventListener){
+src.removeEventListener(sig.substr(2),_560,false);
+}else{
+if(src.detachEvent){
+src.detachEvent(sig,_560);
+}else{
+throw new Error("'src' must be a DOM element");
+}
+}
+},disconnect:function(_561){
+var self=MochiKit.Signal;
+var _562=self._observers;
+var m=MochiKit.Base;
+if(arguments.length>1){
+var src=MochiKit.DOM.getElement(arguments[0]);
+var sig=arguments[1];
+var obj=arguments[2];
+var func=arguments[3];
+for(var i=_562.length-1;i>=0;i--){
+var o=_562[i];
+if(o[0]===src&&o[1]===sig&&o[4]===obj&&o[5]===func){
+self._disconnect(o);
+_562.splice(i,1);
+return true;
+}
+}
+}else{
+var idx=m.findIdentical(_562,_561);
+if(idx>=0){
+self._disconnect(_561);
+_562.splice(idx,1);
+return true;
+}
+}
+return false;
+},disconnectAll:function(src,sig){
+src=MochiKit.DOM.getElement(src);
+var m=MochiKit.Base;
+var _563=m.flattenArguments(m.extend(null,arguments,1));
+var self=MochiKit.Signal;
+var _564=self._disconnect;
+var _565=self._observers;
+if(_563.length===0){
+for(var i=_565.length-1;i>=0;i--){
+var _566=_565[i];
+if(_566[0]===src){
+_564(_566);
+_565.splice(i,1);
+}
+}
+}else{
+var sigs={};
+for(var i=0;i<_563.length;i++){
+sigs[_563[i]]=true;
+}
+for(var i=_565.length-1;i>=0;i--){
+var _566=_565[i];
+if(_566[0]===src&&_566[1] in sigs){
+_564(_566);
+_565.splice(i,1);
+}
+}
+}
+},signal:function(src,sig){
+var _568=MochiKit.Signal._observers;
+src=MochiKit.DOM.getElement(src);
+var args=MochiKit.Base.extend(null,arguments,2);
+var _569=[];
+for(var i=0;i<_568.length;i++){
+var _570=_568[i];
+if(_570[0]===src&&_570[1]===sig){
+try{
+_570[2].apply(src,args);
+}
+catch(e){
+_569.push(e);
+}
+}
+}
+if(_569.length==1){
+throw _569[0];
+}else{
+if(_569.length>1){
+var e=new Error("Multiple errors thrown in handling 'sig', see errors property");
+e.errors=_569;
+throw e;
+}
+}
+}});
+MochiKit.Signal.EXPORT_OK=[];
+MochiKit.Signal.EXPORT=["connect","disconnect","signal","disconnectAll"];
+MochiKit.Signal.__new__=function(win){
+var m=MochiKit.Base;
+this._document=document;
+this._window=win;
+try{
+this.connect(window,"onunload",this._unloadCache);
+}
+catch(e){
+}
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+m.nameFunctions(this);
+};
+MochiKit.Signal.__new__(this);
+if(!MochiKit.__compat__){
+connect=MochiKit.Signal.connect;
+disconnect=MochiKit.Signal.disconnect;
+disconnectAll=MochiKit.Signal.disconnectAll;
+signal=MochiKit.Signal.signal;
+}
+MochiKit.Base._exportSymbols(this,MochiKit.Signal);
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.Visual");
+dojo.require("MochiKit.Base");
+dojo.require("MochiKit.DOM");
+dojo.require("MochiKit.Color");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+JSAN.use("MochiKit.DOM",[]);
+JSAN.use("MochiKit.Color",[]);
+}
+try{
+if(typeof (MochiKit.Base)=="undefined"||typeof (MochiKit.DOM)=="undefined"||typeof (MochiKit.Color)=="undefined"){
+throw "";
+}
+}
+catch(e){
+throw "MochiKit.Visual depends on MochiKit.Base, MochiKit.DOM and MochiKit.Color!";
+}
+if(typeof (MochiKit.Visual)=="undefined"){
+MochiKit.Visual={};
+}
+MochiKit.Visual.NAME="MochiKit.Visual";
+MochiKit.Visual.VERSION="1.3.1";
+MochiKit.Visual.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.Visual.toString=function(){
+return this.__repr__();
+};
+MochiKit.Visual._RoundCorners=function(e,_571){
+e=MochiKit.DOM.getElement(e);
+this._setOptions(_571);
+if(this.options.__unstable__wrapElement){
+e=this._doWrap(e);
+}
+var _572=this.options.color;
+var C=MochiKit.Color.Color;
+if(this.options.color=="fromElement"){
+_572=C.fromBackground(e);
+}else{
+if(!(_572 instanceof C)){
+_572=C.fromString(_572);
+}
+}
+this.isTransparent=(_572.asRGB().a<=0);
+var _574=this.options.bgColor;
+if(this.options.bgColor=="fromParent"){
+_574=C.fromBackground(e.offsetParent);
+}else{
+if(!(_574 instanceof C)){
+_574=C.fromString(_574);
+}
+}
+this._roundCornersImpl(e,_572,_574);
+};
+MochiKit.Visual._RoundCorners.prototype={_doWrap:function(e){
+var _575=e.parentNode;
+var doc=MochiKit.DOM.currentDocument();
+if(typeof (doc.defaultView)=="undefined"||doc.defaultView===null){
+return e;
+}
+var _576=doc.defaultView.getComputedStyle(e,null);
+if(typeof (_576)=="undefined"||_576===null){
+return e;
+}
+var _577=MochiKit.DOM.DIV({"style":{display:"block",marginTop:_576.getPropertyValue("padding-top"),marginRight:_576.getPropertyValue("padding-right"),marginBottom:_576.getPropertyValue("padding-bottom"),marginLeft:_576.getPropertyValue("padding-left"),padding:"0px"}});
+_577.innerHTML=e.innerHTML;
+e.innerHTML="";
+e.appendChild(_577);
+return e;
+},_roundCornersImpl:function(e,_578,_579){
+if(this.options.border){
+this._renderBorder(e,_579);
+}
+if(this._isTopRounded()){
+this._roundTopCorners(e,_578,_579);
+}
+if(this._isBottomRounded()){
+this._roundBottomCorners(e,_578,_579);
+}
+},_renderBorder:function(el,_580){
+var _581="1px solid "+this._borderColor(_580);
+var _582="border-left: "+_581;
+var _583="border-right: "+_581;
+var _584="style='"+_582+";"+_583+"'";
+el.innerHTML="<div "+_584+">"+el.innerHTML+"</div>";
+},_roundTopCorners:function(el,_585,_586){
+var _587=this._createCorner(_586);
+for(var i=0;i<this.options.numSlices;i++){
+_587.appendChild(this._createCornerSlice(_585,_586,i,"top"));
+}
+el.style.paddingTop=0;
+el.insertBefore(_587,el.firstChild);
+},_roundBottomCorners:function(el,_588,_589){
+var _590=this._createCorner(_589);
+for(var i=(this.options.numSlices-1);i>=0;i--){
+_590.appendChild(this._createCornerSlice(_588,_589,i,"bottom"));
+}
+el.style.paddingBottom=0;
+el.appendChild(_590);
+},_createCorner:function(_591){
+var dom=MochiKit.DOM;
+return dom.DIV({style:{backgroundColor:_591.toString()}});
+},_createCornerSlice:function(_592,_593,n,_594){
+var _595=MochiKit.DOM.SPAN();
+var _596=_595.style;
+_596.backgroundColor=_592.toString();
+_596.display="block";
+_596.height="1px";
+_596.overflow="hidden";
+_596.fontSize="1px";
+var _597=this._borderColor(_592,_593);
+if(this.options.border&&n===0){
+_596.borderTopStyle="solid";
+_596.borderTopWidth="1px";
+_596.borderLeftWidth="0px";
+_596.borderRightWidth="0px";
+_596.borderBottomWidth="0px";
+_596.height="0px";
+_596.borderColor=_597.toString();
+}else{
+if(_597){
+_596.borderColor=_597.toString();
+_596.borderStyle="solid";
+_596.borderWidth="0px 1px";
+}
+}
+if(!this.options.compact&&(n==(this.options.numSlices-1))){
+_596.height="2px";
+}
+this._setMargin(_595,n,_594);
+this._setBorder(_595,n,_594);
+return _595;
+},_setOptions:function(_598){
+this.options={corners:"all",color:"fromElement",bgColor:"fromParent",blend:true,border:false,compact:false,__unstable__wrapElement:false};
+MochiKit.Base.update(this.options,_598);
+this.options.numSlices=(this.options.compact?2:4);
+},_whichSideTop:function(){
+var _599=this.options.corners;
+if(this._hasString(_599,"all","top")){
+return "";
+}
+var _600=(_599.indexOf("tl")!=-1);
+var _601=(_599.indexOf("tr")!=-1);
+if(_600&&_601){
+return "";
+}
+if(_600){
+return "left";
+}
+if(_601){
+return "right";
+}
+return "";
+},_whichSideBottom:function(){
+var _602=this.options.corners;
+if(this._hasString(_602,"all","bottom")){
+return "";
+}
+var _603=(_602.indexOf("bl")!=-1);
+var _604=(_602.indexOf("br")!=-1);
+if(_603&&_604){
+return "";
+}
+if(_603){
+return "left";
+}
+if(_604){
+return "right";
+}
+return "";
+},_borderColor:function(_605,_606){
+if(_605=="transparent"){
+return _606;
+}else{
+if(this.options.border){
+return this.options.border;
+}else{
+if(this.options.blend){
+return _606.blendedColor(_605);
+}
+}
+}
+return "";
+},_setMargin:function(el,n,_607){
+var _608=this._marginSize(n)+"px";
+var _609=(_607=="top"?this._whichSideTop():this._whichSideBottom());
+var _610=el.style;
+if(_609=="left"){
+_610.marginLeft=_608;
+_610.marginRight="0px";
+}else{
+if(_609=="right"){
+_610.marginRight=_608;
+_610.marginLeft="0px";
+}else{
+_610.marginLeft=_608;
+_610.marginRight=_608;
+}
+}
+},_setBorder:function(el,n,_611){
+var _612=this._borderSize(n)+"px";
+var _613=(_611=="top"?this._whichSideTop():this._whichSideBottom());
+var _614=el.style;
+if(_613=="left"){
+_614.borderLeftWidth=_612;
+_614.borderRightWidth="0px";
+}else{
+if(_613=="right"){
+_614.borderRightWidth=_612;
+_614.borderLeftWidth="0px";
+}else{
+_614.borderLeftWidth=_612;
+_614.borderRightWidth=_612;
+}
+}
+},_marginSize:function(n){
+if(this.isTransparent){
+return 0;
+}
+var o=this.options;
+if(o.compact&&o.blend){
+var _615=[1,0];
+return _615[n];
+}else{
+if(o.compact){
+var _616=[2,1];
+return _616[n];
+}else{
+if(o.blend){
+var _617=[3,2,1,0];
+return _617[n];
+}else{
+var _618=[5,3,2,1];
+return _618[n];
+}
+}
+}
+},_borderSize:function(n){
+var o=this.options;
+var _619;
+if(o.compact&&(o.blend||this.isTransparent)){
+return 1;
+}else{
+if(o.compact){
+_619=[1,0];
+}else{
+if(o.blend){
+_619=[2,1,1,1];
+}else{
+if(o.border){
+_619=[0,2,0,0];
+}else{
+if(this.isTransparent){
+_619=[5,3,2,1];
+}else{
+return 0;
+}
+}
+}
+}
+}
+return _619[n];
+},_hasString:function(str){
+for(var i=1;i<arguments.length;i++){
+if(str.indexOf(arguments[i])!=-1){
+return true;
+}
+}
+return false;
+},_isTopRounded:function(){
+return this._hasString(this.options.corners,"all","top","tl","tr");
+},_isBottomRounded:function(){
+return this._hasString(this.options.corners,"all","bottom","bl","br");
+},_hasSingleTextChild:function(el){
+return (el.childNodes.length==1&&el.childNodes[0].nodeType==3);
+}};
+MochiKit.Visual.roundElement=function(e,_620){
+new MochiKit.Visual._RoundCorners(e,_620);
+};
+MochiKit.Visual.roundClass=function(_621,_622,_623){
+var _624=MochiKit.DOM.getElementsByTagAndClassName(_621,_622);
+for(var i=0;i<_624.length;i++){
+MochiKit.Visual.roundElement(_624[i],_623);
+}
+};
+MochiKit.Visual.Color=MochiKit.Color.Color;
+MochiKit.Visual.getElementsComputedStyle=MochiKit.DOM.computedStyle;
+MochiKit.Visual.__new__=function(){
+var m=MochiKit.Base;
+m.nameFunctions(this);
+this.EXPORT_TAGS={":common":this.EXPORT,":all":m.concat(this.EXPORT,this.EXPORT_OK)};
+};
+MochiKit.Visual.EXPORT=["roundElement","roundClass"];
+MochiKit.Visual.EXPORT_OK=[];
+MochiKit.Visual.__new__();
+MochiKit.Base._exportSymbols(this,MochiKit.Visual);
+if(typeof (MochiKit)=="undefined"){
+MochiKit={};
+}
+if(typeof (MochiKit.MochiKit)=="undefined"){
+MochiKit.MochiKit={};
+}
+MochiKit.MochiKit.NAME="MochiKit.MochiKit";
+MochiKit.MochiKit.VERSION="1.3.1";
+MochiKit.MochiKit.__repr__=function(){
+return "["+this.NAME+" "+this.VERSION+"]";
+};
+MochiKit.MochiKit.toString=function(){
+return this.__repr__();
+};
+MochiKit.MochiKit.SUBMODULES=["Base","Iter","Logging","DateTime","Format","Async","DOM","LoggingPane","Color","Signal","Visual"];
+if(typeof (JSAN)!="undefined"||typeof (dojo)!="undefined"){
+if(typeof (dojo)!="undefined"){
+dojo.provide("MochiKit.MochiKit");
+dojo.require("MochiKit.*");
+}
+if(typeof (JSAN)!="undefined"){
+JSAN.use("MochiKit.Base",[]);
+JSAN.use("MochiKit.Iter",[]);
+JSAN.use("MochiKit.Logging",[]);
+JSAN.use("MochiKit.DateTime",[]);
+JSAN.use("MochiKit.Format",[]);
+JSAN.use("MochiKit.Async",[]);
+JSAN.use("MochiKit.DOM",[]);
+JSAN.use("MochiKit.LoggingPane",[]);
+JSAN.use("MochiKit.Color",[]);
+JSAN.use("MochiKit.Signal",[]);
+JSAN.use("MochiKit.Visual",[]);
+}
+(function(){
+var _625=MochiKit.Base.extend;
+var self=MochiKit.MochiKit;
+var _626=self.SUBMODULES;
+var _627=[];
+var _628=[];
+var _629={};
+var i,k,m,all;
+for(i=0;i<_626.length;i++){
+m=MochiKit[_626[i]];
+_625(_627,m.EXPORT);
+_625(_628,m.EXPORT_OK);
+for(k in m.EXPORT_TAGS){
+_629[k]=_625(_629[k],m.EXPORT_TAGS[k]);
+}
+all=m.EXPORT_TAGS[":all"];
+if(!all){
+all=_625(null,m.EXPORT,m.EXPORT_OK);
+}
+var j;
+for(j=0;j<all.length;j++){
+k=all[j];
+self[k]=m[k];
+}
+}
+self.EXPORT=_627;
+self.EXPORT_OK=_628;
+self.EXPORT_TAGS=_629;
+}());
+}else{
+if(typeof (MochiKit.__compat__)=="undefined"){
+MochiKit.__compat__=true;
+}
+(function(){
+var _630=document.getElementsByTagName("script");
+var _631="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
+var base=null;
+var _632=null;
+var _633={};
+var i;
+for(i=0;i<_630.length;i++){
+var src=_630[i].getAttribute("src");
+if(!src){
+continue;
+}
+_633[src]=true;
+if(src.match(/MochiKit.js$/)){
+base=src.substring(0,src.lastIndexOf("MochiKit.js"));
+_632=_630[i];
+}
+}
+if(base===null){
+return;
+}
+var _634=MochiKit.MochiKit.SUBMODULES;
+for(var i=0;i<_634.length;i++){
+if(MochiKit[_634[i]]){
+continue;
+}
+var uri=base+_634[i]+".js";
+if(uri in _633){
+continue;
+}
+if(document.documentElement&&document.documentElement.namespaceURI==_631){
+var s=document.createElementNS(_631,"script");
+s.setAttribute("id","MochiKit_"+base+_634[i]);
+s.setAttribute("src",uri);
+s.setAttribute("type","application/x-javascript");
+_632.parentNode.appendChild(s);
+}else{
+document.write("<script src=\""+uri+"\" type=\"text/javascript\"></script>");
+}
+}
+})();
+}
+
+

Added: trunk/lib/mochi+sarissa/Sarissa.js
===================================================================
--- trunk/lib/mochi+sarissa/Sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,662 @@
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version @sarissa.version@
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // make value a zero length string if null to allow clearing
+        value = (value) ? value : "";
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, "", nsURI);
+                }else{
+                    this.processor.addParameter(name, "");
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+    		//Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE.
+        * If <code>oNode</code> is a TextNode, <code>bChildren</code> is ignored.
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if (oNode.nodeName=='#text') {
+                return document.createTextElement(oNode.data);
+            }
+            else {
+                if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                    tmp = document.createElement("table");
+                }
+                else if(oNode.nodeName == "td"){
+                    tmp = document.createElement("tr");
+                }
+                else if(oNode.nodeName == "option"){
+                    tmp = document.createElement("select");
+                }
+                else{
+                    tmp = document.createElement("div");
+                };
+                if(bChildren){
+                    tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+                }else{
+                    tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+                };
+                return tmp.getElementsByTagName("*")[0];
+            };
+            
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
+};
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+//   EOF

Added: trunk/lib/mochi+sarissa/Sarissa_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Sarissa_pack.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/lib/mochi+sarissa/Sarissa_pack.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -0,0 +1,425 @@
+function Sarissa(){
+}
+Sarissa.PARSED_OK="Document contains no parsing errors";
+Sarissa.PARSED_EMPTY="Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR="Not well-formed or other error";
+var _sarissa_iNsCounter=0;
+var _SARISSA_IEPREFIX4XSLPARAM="";
+var _SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&&true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE=_SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.hasFeature;
+var _SARISSA_IS_MOZ=_SARISSA_HAS_DOM_CREATE_DOCUMENT&&_SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI=(navigator.userAgent&&navigator.vendor&&(navigator.userAgent.toLowerCase().indexOf("applewebkit")!=-1||navigator.vendor.indexOf("Apple")!=-1));
+var _SARISSA_IS_IE=document.all&&window.ActiveXObject&&navigator.userAgent.toLowerCase().indexOf("msie")>-1&&navigator.userAgent.toLowerCase().indexOf("opera")==-1;
+if(!window.Node||!Node.ELEMENT_NODE){
+Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};
+}
+if(typeof XMLDocument=="undefined"&&typeof Document!="undefined"){
+XMLDocument=Document;
+}
+if(_SARISSA_IS_IE){
+_SARISSA_IEPREFIX4XSLPARAM="xsl:";
+var _SARISSA_DOM_PROGID="";
+var _SARISSA_XMLHTTP_PROGID="";
+var _SARISSA_DOM_XMLWRITER="";
+Sarissa.pickRecentProgID=function(_1){
+var _2=false;
+for(var i=0;i<_1.length&&!_2;i++){
+try{
+var _4=new ActiveXObject(_1[i]);
+o2Store=_1[i];
+_2=true;
+}
+catch(objException){
+}
+}
+if(!_2){
+throw "Could not retreive a valid progID of Class: "+_1[_1.length-1]+". (original exception: "+e+")";
+}
+_1=null;
+return o2Store;
+};
+_SARISSA_DOM_PROGID=null;
+_SARISSA_THREADEDDOM_PROGID=null;
+_SARISSA_XSLTEMPLATE_PROGID=null;
+_SARISSA_XMLHTTP_PROGID=null;
+if(!window.XMLHttpRequest){
+XMLHttpRequest=function(){
+if(!_SARISSA_XMLHTTP_PROGID){
+_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"]);
+}
+return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+};
+}
+Sarissa.getDomDocument=function(_5,_6){
+if(!_SARISSA_DOM_PROGID){
+_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"]);
+}
+var _7=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(_6){
+var _8="";
+if(_5){
+if(_6.indexOf(":")>1){
+_8=_6.substring(0,_6.indexOf(":"));
+_6=_6.substring(_6.indexOf(":")+1);
+}else{
+_8="a"+(_sarissa_iNsCounter++);
+}
+}
+if(_5){
+_7.loadXML("<"+_8+":"+_6+" xmlns:"+_8+"=\""+_5+"\""+" />");
+}else{
+_7.loadXML("<"+_6+" />");
+}
+}
+return _7;
+};
+Sarissa.getParseErrorText=function(_9){
+var _a=Sarissa.PARSED_OK;
+if(_9.parseError.errorCode!=0){
+_a="XML Parsing Error: "+_9.parseError.reason+"\nLocation: "+_9.parseError.url+"\nLine Number "+_9.parseError.line+", Column "+_9.parseError.linepos+":\n"+_9.parseError.srcText+"\n";
+for(var i=0;i<_9.parseError.linepos;i++){
+_a+="-";
+}
+_a+="^\n";
+}else{
+if(_9.documentElement==null){
+_a=Sarissa.PARSED_EMPTY;
+}
+}
+return _a;
+};
+Sarissa.setXpathNamespaces=function(_c,_d){
+_c.setProperty("SelectionLanguage","XPath");
+_c.setProperty("SelectionNamespaces",_d);
+};
+XSLTProcessor=function(){
+if(!_SARISSA_XSLTEMPLATE_PROGID){
+_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0","MSXML2.XSLTemplate.3.0"]);
+}
+this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+this.processor=null;
+};
+XSLTProcessor.prototype.importStylesheet=function(_e){
+if(!_SARISSA_THREADEDDOM_PROGID){
+_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0","MSXML2.FreeThreadedDOMDocument.3.0"]);
+}
+_e.setProperty("SelectionLanguage","XPath");
+_e.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _f=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+if(_e.url&&_e.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']")!=null){
+_f.async=false;
+if(_SARISSA_THREADEDDOM_PROGID=="MSXML2.FreeThreadedDOMDocument.6.0"){
+_f.setProperty("AllowDocumentFunction",true);
+_f.resolveExternals=true;
+}
+_f.load(_e.url);
+}else{
+_f.loadXML(_e.xml);
+}
+_f.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+var _10=_f.selectSingleNode("//xsl:output");
+this.outputMethod=_10?_10.getAttribute("method"):"html";
+this.template.stylesheet=_f;
+this.processor=this.template.createProcessor();
+this.paramsSet=new Array();
+};
+XSLTProcessor.prototype.transformToDocument=function(_11){
+if(_SARISSA_THREADEDDOM_PROGID){
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_PROGID);
+this.processor.output=_12;
+this.processor.transform();
+return _12;
+}else{
+if(!_SARISSA_DOM_XMLWRITER){
+_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0","Msxml2.MXXMLWriter.3.0","MSXML2.MXXMLWriter","MSXML.MXXMLWriter","Microsoft.XMLDOM"]);
+}
+this.processor.input=_11;
+var _12=new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+this.processor.output=_12;
+this.processor.transform();
+var _13=new ActiveXObject(_SARISSA_DOM_PROGID);
+_13.loadXML(_12.output+"");
+return _13;
+}
+};
+XSLTProcessor.prototype.transformToFragment=function(_14,_15){
+this.processor.input=_14;
+this.processor.transform();
+var s=this.processor.output;
+var f=_15.createDocumentFragment();
+if(this.outputMethod=="text"){
+f.appendChild(_15.createTextNode(s));
+}else{
+if(_15.body&&_15.body.innerHTML){
+var _18=_15.createElement("div");
+_18.innerHTML=s;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}else{
+var _19=new ActiveXObject(_SARISSA_DOM_PROGID);
+if(s.substring(0,5)=="<?xml"){
+s=s.substring(s.indexOf("?>")+2);
+}
+var xml="".concat("<my>",s,"</my>");
+_19.loadXML(xml);
+var _18=_19.documentElement;
+while(_18.hasChildNodes()){
+f.appendChild(_18.firstChild);
+}
+}
+}
+return f;
+};
+XSLTProcessor.prototype.setParameter=function(_1b,_1c,_1d){
+if(_1b){
+this.processor.addParameter(_1c,_1d,_1b);
+}else{
+this.processor.addParameter(_1c,_1d);
+}
+if(!this.paramsSet[""+_1b]){
+this.paramsSet[""+_1b]=new Array();
+}
+this.paramsSet[""+_1b][_1c]=_1d;
+};
+XSLTProcessor.prototype.getParameter=function(_1e,_1f){
+_1e=_1e||"";
+if(this.paramsSet[_1e]&&this.paramsSet[_1e][_1f]){
+return this.paramsSet[_1e][_1f];
+}else{
+return null;
+}
+};
+XSLTProcessor.prototype.clearParameters=function(){
+for(var _20 in this.paramsSet){
+for(var _21 in this.paramsSet[_20]){
+if(_20){
+this.processor.addParameter(_21,null,_20);
+}else{
+this.processor.addParameter(_21,null);
+}
+}
+}
+this.paramsSet=new Array();
+};
+}else{
+if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+Sarissa.__handleLoad__=function(_22){
+Sarissa.__setReadyState__(_22,4);
+};
+_sarissa_XMLDocument_onload=function(){
+Sarissa.__handleLoad__(this);
+};
+Sarissa.__setReadyState__=function(_23,_24){
+_23.readyState=_24;
+_23.readystate=_24;
+if(_23.onreadystatechange!=null&&typeof _23.onreadystatechange=="function"){
+_23.onreadystatechange();
+}
+};
+Sarissa.getDomDocument=function(_25,_26){
+var _27=document.implementation.createDocument(_25?_25:null,_26?_26:null,null);
+if(!_27.onreadystatechange){
+_27.onreadystatechange=null;
+}
+if(!_27.readyState){
+_27.readyState=0;
+}
+_27.addEventListener("load",_sarissa_XMLDocument_onload,false);
+return _27;
+};
+if(window.XMLDocument){
+}else{
+if(_SARISSA_HAS_DOM_FEATURE&&window.Document&&!Document.prototype.load&&document.implementation.hasFeature("LS","3.0")){
+Sarissa.getDomDocument=function(_28,_29){
+var _2a=document.implementation.createDocument(_28?_28:null,_29?_29:null,null);
+return _2a;
+};
+}else{
+Sarissa.getDomDocument=function(_2b,_2c){
+var _2d=document.implementation.createDocument(_2b?_2b:null,_2c?_2c:null,null);
+if(_2d&&(_2b||_2c)&&!_2d.documentElement){
+_2d.appendChild(_2d.createElementNS(_2b,_2c));
+}
+return _2d;
+};
+}
+}
+}
+}
+if(!window.DOMParser){
+if(_SARISSA_IS_SAFARI){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_2e,_2f){
+var _30=new XMLHttpRequest();
+_30.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(_2e),false);
+_30.send(null);
+return _30.responseXML;
+};
+}else{
+if(Sarissa.getDomDocument&&Sarissa.getDomDocument()&&Sarissa.getDomDocument(null,"bar").xml){
+DOMParser=function(){
+};
+DOMParser.prototype.parseFromString=function(_31,_32){
+var doc=Sarissa.getDomDocument();
+doc.loadXML(_31);
+return doc;
+};
+}
+}
+}
+if((typeof (document.importNode)=="undefined")&&_SARISSA_IS_IE){
+try{
+document.importNode=function(_34,_35){
+var tmp;
+if(_34.nodeName=="tbody"||_34.nodeName=="tr"){
+tmp=document.createElement("table");
+}else{
+if(_34.nodeName=="td"){
+tmp=document.createElement("tr");
+}else{
+if(_34.nodeName=="option"){
+tmp=document.createElement("select");
+}else{
+tmp=document.createElement("div");
+}
+}
+}
+if(_35){
+tmp.innerHTML=_34.xml?_34.xml:_34.outerHTML;
+}else{
+tmp.innerHTML=_34.xml?_34.cloneNode(false).xml:_34.cloneNode(false).outerHTML;
+}
+return tmp.getElementsByTagName("*")[0];
+};
+}
+catch(e){
+}
+}
+if(!Sarissa.getParseErrorText){
+Sarissa.getParseErrorText=function(_37){
+var _38=Sarissa.PARSED_OK;
+if(!_37.documentElement){
+_38=Sarissa.PARSED_EMPTY;
+}else{
+if(_37.documentElement.tagName=="parsererror"){
+_38=_37.documentElement.firstChild.data;
+_38+="\n"+_37.documentElement.firstChild.nextSibling.firstChild.data;
+}else{
+if(_37.getElementsByTagName("parsererror").length>0){
+var _39=_37.getElementsByTagName("parsererror")[0];
+_38=Sarissa.getText(_39,true)+"\n";
+}else{
+if(_37.parseError&&_37.parseError.errorCode!=0){
+_38=Sarissa.PARSED_UNKNOWN_ERROR;
+}
+}
+}
+}
+return _38;
+};
+}
+Sarissa.getText=function(_3a,_3b){
+var s="";
+var _3d=_3a.childNodes;
+for(var i=0;i<_3d.length;i++){
+var _3f=_3d[i];
+var _40=_3f.nodeType;
+if(_40==Node.TEXT_NODE||_40==Node.CDATA_SECTION_NODE){
+s+=_3f.data;
+}else{
+if(_3b==true&&(_40==Node.ELEMENT_NODE||_40==Node.DOCUMENT_NODE||_40==Node.DOCUMENT_FRAGMENT_NODE)){
+s+=Sarissa.getText(_3f,true);
+}
+}
+}
+return s;
+};
+if(!window.XMLSerializer&&Sarissa.getDomDocument&&Sarissa.getDomDocument("","foo",null).xml){
+XMLSerializer=function(){
+};
+XMLSerializer.prototype.serializeToString=function(_41){
+return _41.xml;
+};
+}
+Sarissa.stripTags=function(s){
+return s.replace(/<[^>]+>/g,"");
+};
+Sarissa.clearChildNodes=function(_43){
+while(_43.firstChild){
+_43.removeChild(_43.firstChild);
+}
+};
+Sarissa.copyChildNodes=function(_44,_45,_46){
+if((!_44)||(!_45)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_46){
+Sarissa.clearChildNodes(_45);
+}
+var _47=_45.nodeType==Node.DOCUMENT_NODE?_45:_45.ownerDocument;
+var _48=_44.childNodes;
+if(typeof (_47.importNode)!="undefined"){
+for(var i=0;i<_48.length;i++){
+_45.appendChild(_47.importNode(_48[i],true));
+}
+}else{
+for(var i=0;i<_48.length;i++){
+_45.appendChild(_48[i].cloneNode(true));
+}
+}
+};
+Sarissa.moveChildNodes=function(_4a,_4b,_4c){
+if((!_4a)||(!_4b)){
+throw "Both source and destination nodes must be provided";
+}
+if(!_4c){
+Sarissa.clearChildNodes(_4b);
+}
+var _4d=_4a.childNodes;
+if(_4a.ownerDocument==_4b.ownerDocument){
+while(_4a.firstChild){
+_4b.appendChild(_4a.firstChild);
+}
+}else{
+var _4e=_4b.nodeType==Node.DOCUMENT_NODE?_4b:_4b.ownerDocument;
+if(typeof (_4e.importNode)!="undefined"){
+for(var i=0;i<_4d.length;i++){
+_4b.appendChild(_4e.importNode(_4d[i],true));
+}
+}else{
+for(var i=0;i<_4d.length;i++){
+_4b.appendChild(_4d[i].cloneNode(true));
+}
+}
+Sarissa.clearChildNodes(_4a);
+}
+};
+Sarissa.xmlize=function(_50,_51,_52){
+_52=_52?_52:"";
+var s=_52+"<"+_51+">";
+var _54=false;
+if(!(_50 instanceof Object)||_50 instanceof Number||_50 instanceof String||_50 instanceof Boolean||_50 instanceof Date){
+s+=Sarissa.escape(""+_50);
+_54=true;
+}else{
+s+="\n";
+var _55="";
+var _56=_50 instanceof Array;
+for(var _57 in _50){
+s+=Sarissa.xmlize(_50[_57],(_56?"array-item key=\""+_57+"\"":_57),_52+"   ");
+}
+s+=_52;
+}
+return s+=(_51.indexOf(" ")!=-1?"</array-item>\n":"</"+_51+">\n");
+};
+Sarissa.escape=function(_58){
+return _58.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
+};
+Sarissa.unescape=function(_59){
+return _59.replace(/&apos;/g,"'").replace(/&quot;/g,"\"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");
+};
+

Modified: trunk/src/AssetManager.js
===================================================================
--- trunk/src/AssetManager.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/AssetManager.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -22,8 +22,8 @@
   * Both IE6 and FF1.5 are known to support the required HTTP methods, so
   * if theese are your target platform, you can disable tunneling.
   */
-// Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
-Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
+//  Freja.AssetManager.HTTP_METHOD_TUNNEL = null;
+  Freja.AssetManager.HTTP_METHOD_TUNNEL = "Http-Method-Equivalent";
 /**
   * Set this url to provide remote xslt-transformation for browsers that
   * doesn't support it natively.
@@ -115,7 +115,7 @@
 	this._password = password;
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.AssetManager.loadAsset = function(url, preventCaching) {
 	var match = /^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
@@ -138,7 +138,14 @@
 		} catch (ex) {
 			d.errback(ex);
 		}
-		d.callback(document);
+		if(window.document.all) { 				
+			// Weird bug in IE6 when assets are loaded from local file system.
+			// Despite the async request, the document is loaded and the onload signal is sent 
+			// before the getModel function exits (giving no chance to attach a handler to onload).
+			// Using a 1ms timeout here fixes the problem.
+			setTimeout(function() { d.callback(document); }, 1);		
+		} else
+			d.callback(document);
 	};
 	try {
 		// Why using HTTP_METHOD_TUNNEL for a GET?
@@ -161,7 +168,7 @@
 				d.errback(new Error("Request failed:" + req.status));
 			});
 		} else {
-			if (req.status == 0 || req.status == 200 || req.status == 304) {
+			if (req.status == 0 || req.status == 200 ||  req.status == 201 ||  req.status == 304) {
 				handler(req);
 			} else {
 				d.errback(new Error("Request failed:" + req.status));

Modified: trunk/src/Freja.js
===================================================================
--- trunk/src/Freja.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/Freja.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -5,7 +5,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.0.alpha";
+Freja.VERSION = "2.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };

Modified: trunk/src/Model.js
===================================================================
--- trunk/src/Model.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/Model.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -40,12 +40,15 @@
 Freja.Model.prototype.updateFrom = function(view) {
 	var values = view.getValues();
 	for (var i = 0; i < values[0].length; ++i) {
-		this.set(values[0][i], values[1][i]);
+		// try not to process field names that are not meant to be xpath expressions
+		if(values[0][i].lastIndexOf('/') != -1) {		
+			this.set(values[0][i], values[1][i]);
+		}
 	}
 };
 /**
   * Writes the model back to the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.save = function() {
 	var url = this.url;
@@ -68,7 +71,7 @@
 };
 /**
   * Deletes the model from the remote service
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.remove = function() {
 	var url = this.url;
@@ -80,7 +83,7 @@
 	return Freja._aux.sendXMLHttpRequest(req);
 };
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.Model.prototype.reload = function() {
 	this.ready = false;

Modified: trunk/src/QueryEngine.js
===================================================================
--- trunk/src/QueryEngine.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/QueryEngine.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -13,57 +13,80 @@
 	}
 };
 Freja.QueryEngine.prototype.get = function(document, expression) {
-	try {
-		var node = this._find(document, expression);
-	} catch(x) {
-		return null;
+	
+	var node = this._find(document, expression);
+
+	if(!node) throw new Error("Can't evaluate expression " + expression);
+
+	switch(node.nodeType) {
+		case 1: /* element */
+			// return content of text nodes
+			// @TO-DO: return more than just firstchild?
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				return node.firstChild.nodeValue;
+			}
+			break;
+		case 2: /* Attribute */
+			return node.nodeValue;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			return node.nodeValue;
+			break;	
 	}
-	if(node) return node.nodeValue;
-
+	return null;
 };
 Freja.QueryEngine.prototype.set = function(document, expression, value) {
-	try {
-		var node = this._find(document, expression);
-		if(node)
-			node.nodeValue = value;
-	} catch(x) {
-		// text node not found. Might need to be created.
-		// try not to process field names that are not meant to be xpath expressions
-		if(expression.lastIndexOf('/') != -1) {
-			var nodeName = expression.substr(expression.lastIndexOf('/')+1);
-			if(nodeName.charAt(0)=='@') {
-				// trying to set a non-existing attribute. Let's create it.
-				var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
-				var pNode = this._find(document, parentExpression);
-				if(pNode) {
-					// this._find returns a text node
-					pNode = pNode.parentNode;
-					pNode.setAttribute(nodeName.substr(1),value);
-				}
+	var node = this._find(document, expression);
+	if(!node) {
+		// Could not evaluate expression.
+		// Check if we're trying to set a non-existent attribute
+		var nodeName = expression.substr(expression.lastIndexOf('/')+1);
+		if(nodeName.charAt(0)=='@') {
+			// Let's try to create the attribute.
+			var parentExpression =  expression.substring(0, expression.lastIndexOf('/'));
+			var pNode = this._find(document, parentExpression);
+			if(pNode) {				
+				pNode.setAttribute(nodeName.substr(1),value);
+				return;
 			}
-			// else parent element does not exist.. can't do anything
+			// else parent node non existent either, give up.
 		}
+		// not an attribute, give up.
+		throw new Error("Can't evaluate expression " + expression);
 	}
+
+	// Expression succesfully evaluated. Set content
+	switch(node.nodeType) {
+		case 1: /* element */
+			// @TO-DO: set more than just firstchild			
+			if(node.firstChild && (node.firstChild.nodeType == 3 || node.firstChild.nodeType == 4)) {
+				node.firstChild.nodeValue = value;
+			} else {
+				if(value!="") // prevent a subsequent IE7/MSXML3 crash in view rendering.
+					node.appendChild(document.createTextNode(value));
+			}
+			break;
+		case 2: /* Attribute */
+			node.nodeValue = value;
+			break;
+		case 3: /* text node */
+			// fall through
+		case 4: /* CDATA section */
+			node.nodeValue = value;
+			break;	
+	}
+	return ;
 };
 /**
   * XPath query engine.
   */
 Freja.QueryEngine.XPath = function() {};
 Freja.Class.extend(Freja.QueryEngine.XPath, Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find = function(document, expression) {
-	var node = document.selectSingleNode(expression);
-	if (node && node.nodeType == 2) {
-		return node;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 3) {
-		return node.firstChild;
-	}
-	if (node && node.firstChild && node.firstChild.nodeType == 4) {
-		return node.firstChild;
-	}
-
-	throw new Error("Can't evaluate expression " + expression);
-	return null;
+Freja.QueryEngine.XPath.prototype._find = function(document, expression) {	
+	var result = document.selectSingleNode(expression);	
+	return result;
 };
 /**
   * SimplePath
@@ -71,10 +94,11 @@
 Freja.QueryEngine.SimplePath = function() {};
 Freja.Class.extend(Freja.QueryEngine.SimplePath, Freja.QueryEngine);
 Freja.QueryEngine.SimplePath.prototype._find = function(document, expression) {
+	
 	if (!expression.match(/^[\d\w\/@\[\]=_\-']*$/)) {
 		throw new Error("Can't evaluate expression " + expression);
 	}
-	var parts = expression.split(/\//);
+	var parts = expression.split("/");
 	var node = document;
 	var regAttr = new RegExp("^@([\\d\\w]*)");
 	var regOffset = new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");

Modified: trunk/src/View.js
===================================================================
--- trunk/src/View.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/View.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -15,7 +15,7 @@
   * @param    model            Freja.Model
   * @param    placeholder      string    If supplied, this will be used instead of the
   *                                      default placeholder.
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.prototype.render = function(model, placeholder, xslParameters) {
 	if (typeof(placeholder) == "undefined") placeholder = this.placeholder;
@@ -50,7 +50,12 @@
 
 			var trans = this.view._renderer.transform(model, this.view, this.xslParameters);
 			trans.addCallback(Freja._aux.bind(function(html) {
-				this._destination.innerHTML = html;
+				if(typeof html == "string") {
+					this._destination.innerHTML = html;  // Remote XSLT (serialized HTML *not* XML)
+				} else {
+					this._destination.innerHTML = "";   
+					this._destination.appendChild(html); // Browser XSLT (DOM fragment)
+				}
 			}, this.view));
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
@@ -64,7 +69,11 @@
 
 	var d = Freja._aux.createDeferred();
 	try {
-		this._destination = Freja._aux.getElement(placeholder);
+		if (typeof(placeholder) == "object") {
+			this._destination = placeholder;
+		} else {
+			this._destination = document.getElementById(placeholder);
+		}
 		// @todo    Is this a good idea ?
 		// Perhaps we should leave it to the programmer to do this.
 		this._destination.innerHTML = Freja.AssetManager.THROBBER_HTML;
@@ -152,22 +161,15 @@
 Freja.View.Renderer.XSLTransformer = function() {};
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
         try {
-		var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
+			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
 		if (!html) {
 			d.errback(new Error("XSL Transformation error."));
 		} else {
-			// fix empty textareas
-			// Can't this be fixed by outputting as html rather than xml ?
-			// <xsl:output method="html" />
-			// (cedsav) don't remember all the details but method="xml" is the way to go.
-			// method="html" would output html not xhtml, plus I think it implies that
-			// you want to output a valid html document (with html, head and body tags).
-			html = html.replace(/<textarea([^>]*)\/>/gi,"<textarea $1></textarea>");
 			d.callback(html);
 		}
 	} catch (ex) {
@@ -184,7 +186,7 @@
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer, Freja.View.Renderer);
 /**
-  * @returns MochiKit.Async.Deferred
+  * @returns Freja._aux.Deferred
   */
 Freja.View.Renderer.RemoteXSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();

Modified: trunk/src/auxiliary/minimal.js
===================================================================
--- trunk/src/auxiliary/minimal.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/auxiliary/minimal.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,870 @@
+
 /**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa is an ECMAScript library acting as a cross-browser wrapper for native XML APIs.
+ * The library supports Gecko based browsers like Mozilla and Firefox,
+ * Internet Explorer (5.5+ with MSXML3.0+), Konqueror, Safari and a little of Opera
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+/**
+ * <p>Sarissa is a utility class. Provides "static" methods for DOMDocument, 
+ * DOM Node serialization to XML strings and other utility goodies.</p>
+ * @constructor
+ */
+function Sarissa(){};
+Sarissa.PARSED_OK = "Document contains no parsing errors";
+Sarissa.PARSED_EMPTY = "Document is empty";
+Sarissa.PARSED_UNKNOWN_ERROR = "Not well-formed or other error";
+var _sarissa_iNsCounter = 0;
+var _SARISSA_IEPREFIX4XSLPARAM = "";
+var _SARISSA_HAS_DOM_IMPLEMENTATION = document.implementation && true;
+var _SARISSA_HAS_DOM_CREATE_DOCUMENT = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.createDocument;
+var _SARISSA_HAS_DOM_FEATURE = _SARISSA_HAS_DOM_IMPLEMENTATION && document.implementation.hasFeature;
+var _SARISSA_IS_MOZ = _SARISSA_HAS_DOM_CREATE_DOCUMENT && _SARISSA_HAS_DOM_FEATURE;
+var _SARISSA_IS_SAFARI = (navigator.userAgent && navigator.vendor && (navigator.userAgent.toLowerCase().indexOf("applewebkit") != -1 || navigator.vendor.indexOf("Apple") != -1));
+var _SARISSA_IS_IE = document.all && window.ActiveXObject && navigator.userAgent.toLowerCase().indexOf("msie") > -1  && navigator.userAgent.toLowerCase().indexOf("opera") == -1;
+if(!window.Node || !Node.ELEMENT_NODE){
+    Node = {ELEMENT_NODE: 1, ATTRIBUTE_NODE: 2, TEXT_NODE: 3, CDATA_SECTION_NODE: 4, ENTITY_REFERENCE_NODE: 5,  ENTITY_NODE: 6, PROCESSING_INSTRUCTION_NODE: 7, COMMENT_NODE: 8, DOCUMENT_NODE: 9, DOCUMENT_TYPE_NODE: 10, DOCUMENT_FRAGMENT_NODE: 11, NOTATION_NODE: 12};
+};
+
+if(typeof XMLDocument == "undefined" && typeof Document !="undefined"){ XMLDocument = Document; } 
+
+// IE initialization
+if(_SARISSA_IS_IE){
+    // for XSLT parameter names, prefix needed by IE
+    _SARISSA_IEPREFIX4XSLPARAM = "xsl:";
+    // used to store the most recent ProgID available out of the above
+    var _SARISSA_DOM_PROGID = "";
+    var _SARISSA_XMLHTTP_PROGID = "";
+    var _SARISSA_DOM_XMLWRITER = "";
+    /**
+     * Called when the Sarissa_xx.js file is parsed, to pick most recent
+     * ProgIDs for IE, then gets destroyed.
+     * @private
+     * @param idList an array of MSXML PROGIDs from which the most recent will be picked for a given object
+     * @param enabledList an array of arrays where each array has two items; the index of the PROGID for which a certain feature is enabled
+     */
+    Sarissa.pickRecentProgID = function (idList){
+        // found progID flag
+        var bFound = false;
+        for(var i=0; i < idList.length && !bFound; i++){
+            try{
+                var oDoc = new ActiveXObject(idList[i]);
+                o2Store = idList[i];
+                bFound = true;
+            }catch (objException){
+                // trap; try next progID
+            };
+        };
+        if (!bFound) {
+            throw "Could not retreive a valid progID of Class: " + idList[idList.length-1]+". (original exception: "+e+")";
+        };
+        idList = null;
+        return o2Store;
+    };
+    // pick best available MSXML progIDs
+    _SARISSA_DOM_PROGID = null;
+    _SARISSA_THREADEDDOM_PROGID = null;
+    _SARISSA_XSLTEMPLATE_PROGID = null;
+    _SARISSA_XMLHTTP_PROGID = null;
+    if(!window.XMLHttpRequest){
+        /**
+         * Emulate XMLHttpRequest
+         * @constructor
+         */
+        XMLHttpRequest = function() {
+            if(!_SARISSA_XMLHTTP_PROGID){
+                _SARISSA_XMLHTTP_PROGID = Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
+            };
+            return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);
+        };
+    };
+    // we dont need this anymore
+    //============================================
+    // Factory methods (IE)
+    //============================================
+    // see non-IE version
+    Sarissa.getDomDocument = function(sUri, sName){
+        if(!_SARISSA_DOM_PROGID){
+            _SARISSA_DOM_PROGID = Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
+        };
+        var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+        // if a root tag name was provided, we need to load it in the DOM object
+        if (sName){
+            // create an artifical namespace prefix 
+            // or reuse existing prefix if applicable
+            var prefix = "";
+            if(sUri){
+                if(sName.indexOf(":") > 1){
+                    prefix = sName.substring(0, sName.indexOf(":"));
+                    sName = sName.substring(sName.indexOf(":")+1); 
+                }else{
+                    prefix = "a" + (_sarissa_iNsCounter++);
+                };
+            };
+            // use namespaces if a namespace URI exists
+            if(sUri){
+                oDoc.loadXML('<' + prefix+':'+sName + " xmlns:" + prefix + "=\"" + sUri + "\"" + " />");
+            } else {
+                oDoc.loadXML('<' + sName + " />");
+            };
+        };
+        return oDoc;
+    };
+    // see non-IE version   
+    Sarissa.getParseErrorText = function (oDoc) {
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(oDoc.parseError.errorCode != 0){
+            parseErrorText = "XML Parsing Error: " + oDoc.parseError.reason + 
+                "\nLocation: " + oDoc.parseError.url + 
+                "\nLine Number " + oDoc.parseError.line + ", Column " + 
+                oDoc.parseError.linepos + 
+                ":\n" + oDoc.parseError.srcText +
+                "\n";
+            for(var i = 0;  i < oDoc.parseError.linepos;i++){
+                parseErrorText += "-";
+            };
+            parseErrorText +=  "^\n";
+        }
+        else if(oDoc.documentElement == null){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        };
+        return parseErrorText;
+    };
+    // see non-IE version
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        oDoc.setProperty("SelectionLanguage", "XPath");
+        oDoc.setProperty("SelectionNamespaces", sNsSet);
+    };   
+    /**
+     * Basic implementation of Mozilla's XSLTProcessor for IE. 
+     * Reuses the same XSLT stylesheet for multiple transforms
+     * @constructor
+     */
+    XSLTProcessor = function(){
+        if(!_SARISSA_XSLTEMPLATE_PROGID){
+            _SARISSA_XSLTEMPLATE_PROGID = Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0", "MSXML2.XSLTemplate.3.0"]);
+        };
+        this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
+        this.processor = null;
+    };
+    /**
+     * Imports the given XSLT DOM and compiles it to a reusable transform
+     * <b>Note:</b> If the stylesheet was loaded from a URL and contains xsl:import or xsl:include elements,it will be reloaded to resolve those
+     * @argument xslDoc The XSLT DOMDocument to import
+     */
+    XSLTProcessor.prototype.importStylesheet = function(xslDoc){
+        if(!_SARISSA_THREADEDDOM_PROGID){
+            _SARISSA_THREADEDDOM_PROGID = Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
+        };
+        xslDoc.setProperty("SelectionLanguage", "XPath");
+        xslDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        // convert stylesheet to free threaded
+        var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
+        // make included/imported stylesheets work if exist and xsl was originally loaded from url
+        if(xslDoc.url && xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']") != null){
+            converted.async = false;
+            if (_SARISSA_THREADEDDOM_PROGID == "MSXML2.FreeThreadedDOMDocument.6.0") { 
+                converted.setProperty("AllowDocumentFunction", true); 
+                converted.resolveExternals = true; 
+            }
+            converted.load(xslDoc.url);
+        } else {
+            converted.loadXML(xslDoc.xml);
+        };
+        converted.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
+        var output = converted.selectSingleNode("//xsl:output");
+        this.outputMethod = output ? output.getAttribute("method") : "html";
+        this.template.stylesheet = converted;
+        this.processor = this.template.createProcessor();
+        // for getParameter and clearParameters
+        this.paramsSet = new Array();
+    };
+
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM document
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
+        // fix for bug 1549749
+        if(_SARISSA_THREADEDDOM_PROGID){
+            this.processor.input=sourceDoc;
+            var outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);
+            this.processor.output=outDoc;
+            this.processor.transform();
+            return outDoc;
+        }
+        else{
+            if(!_SARISSA_DOM_XMLWRITER){
+                _SARISSA_DOM_XMLWRITER = Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0", "Msxml2.MXXMLWriter.3.0", "MSXML2.MXXMLWriter", "MSXML.MXXMLWriter", "Microsoft.XMLDOM"]);
+            };
+            this.processor.input = sourceDoc;
+            var outDoc = new ActiveXObject(_SARISSA_DOM_XMLWRITER);
+            this.processor.output = outDoc; 
+            this.processor.transform();
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            oDoc.loadXML(outDoc.output+"");
+            return oDoc;
+        };
+    };
+    
+    /**
+     * Transform the given XML DOM and return the transformation result as a new DOM fragment.
+     * <b>Note</b>: The xsl:output method must match the nature of the owner document (XML/HTML).
+     * @argument sourceDoc The XML DOMDocument to transform
+     * @argument ownerDoc The owner of the result fragment
+     * @return The transformation result as a DOM Document
+     */
+    XSLTProcessor.prototype.transformToFragment = function (sourceDoc, ownerDoc) {
+        this.processor.input = sourceDoc;
+        this.processor.transform();
+        var s = this.processor.output;
+        var f = ownerDoc.createDocumentFragment();
+        if (this.outputMethod == 'text') {
+            f.appendChild(ownerDoc.createTextNode(s));
+        } else if (ownerDoc.body && ownerDoc.body.innerHTML) {
+            var container = ownerDoc.createElement('div');
+            container.innerHTML = s;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        else {
+            var oDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
+            if (s.substring(0, 5) == '<?xml') {
+                s = s.substring(s.indexOf('?>') + 2);
+            }
+            var xml = ''.concat('<my>', s, '</my>');
+            oDoc.loadXML(xml);
+            var container = oDoc.documentElement;
+            while (container.hasChildNodes()) {
+                f.appendChild(container.firstChild);
+            }
+        }
+        return f;
+    };
+    
+    /**
+     * Set global XSLT parameter of the imported stylesheet
+     * @argument nsURI The parameter namespace URI
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     */
+    XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
+        // nsURI is optional but cannot be null 
+        if(nsURI){
+            this.processor.addParameter(name, value, nsURI);
+        }else{
+            this.processor.addParameter(name, value);
+        };
+        // update updated params for getParameter 
+        if(!this.paramsSet[""+nsURI]){
+            this.paramsSet[""+nsURI] = new Array();
+        };
+        this.paramsSet[""+nsURI][name] = value;
+    };
+    /**
+     * Gets a parameter if previously set by setParameter. Returns null
+     * otherwise
+     * @argument name The parameter base name
+     * @argument value The new parameter value
+     * @return The parameter value if reviously set by setParameter, null otherwise
+     */
+    XSLTProcessor.prototype.getParameter = function(nsURI, name){
+        nsURI = nsURI || "";
+        if(this.paramsSet[nsURI] && this.paramsSet[nsURI][name]){
+            return this.paramsSet[nsURI][name];
+        }else{
+            return null;
+        };
+    };
+    /**
+     * Clear parameters (set them to default values as defined in the stylesheet itself)
+     */
+    XSLTProcessor.prototype.clearParameters = function(){
+        for(var nsURI in this.paramsSet){
+            for(var name in this.paramsSet[nsURI]){
+                if(nsURI){
+                    this.processor.addParameter(name, null, nsURI);
+                }else{
+                    this.processor.addParameter(name, null);
+                };
+            };
+        };
+        this.paramsSet = new Array();
+    };
+}else{ /* end IE initialization, try to deal with real browsers now ;-) */
+    if(_SARISSA_HAS_DOM_CREATE_DOCUMENT){
+        /**
+         * <p>Ensures the document was loaded correctly, otherwise sets the
+         * parseError to -1 to indicate something went wrong. Internal use</p>
+         * @private
+         */
+        Sarissa.__handleLoad__ = function(oDoc){
+            Sarissa.__setReadyState__(oDoc, 4);
+        };
+        /**
+        * <p>Attached by an event handler to the load event. Internal use.</p>
+        * @private
+        */
+        _sarissa_XMLDocument_onload = function(){
+            Sarissa.__handleLoad__(this);
+        };
+        /**
+         * <p>Sets the readyState property of the given DOM Document object.
+         * Internal use.</p>
+         * @private
+         * @argument oDoc the DOM Document object to fire the
+         *          readystatechange event
+         * @argument iReadyState the number to change the readystate property to
+         */
+        Sarissa.__setReadyState__ = function(oDoc, iReadyState){
+            oDoc.readyState = iReadyState;
+            oDoc.readystate = iReadyState;
+            if (oDoc.onreadystatechange != null && typeof oDoc.onreadystatechange == "function")
+                oDoc.onreadystatechange();
+        };
+        Sarissa.getDomDocument = function(sUri, sName){
+            var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+            if(!oDoc.onreadystatechange){
+            
+                /**
+                * <p>Emulate IE's onreadystatechange attribute</p>
+                */
+                oDoc.onreadystatechange = null;
+            };
+            if(!oDoc.readyState){
+                /**
+                * <p>Emulates IE's readyState property, which always gives an integer from 0 to 4:</p>
+                * <ul><li>1 == LOADING,</li>
+                * <li>2 == LOADED,</li>
+                * <li>3 == INTERACTIVE,</li>
+                * <li>4 == COMPLETED</li></ul>
+                */
+                oDoc.readyState = 0;
+            };
+            oDoc.addEventListener("load", _sarissa_XMLDocument_onload, false);
+            return oDoc;
+        };
+        if(window.XMLDocument){
+            // do nothing
+        }// TODO: check if the new document has content before trying to copynodes, check  for error handling in DOM 3 LS
+        else if(_SARISSA_HAS_DOM_FEATURE && window.Document && !Document.prototype.load && document.implementation.hasFeature('LS', '3.0')){
+            //Opera 9 may get the XPath branch which gives creates XMLDocument, therefore it doesn't reach here which is good
+            /**
+            * <p>Factory method to obtain a new DOM Document object</p>
+            * @argument sUri the namespace of the root node (if any)
+            * @argument sUri the local name of the root node (if any)
+            * @returns a new DOM Document
+            */
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                return oDoc;
+            };
+        }
+        else {
+            Sarissa.getDomDocument = function(sUri, sName){
+                var oDoc = document.implementation.createDocument(sUri?sUri:null, sName?sName:null, null);
+                // looks like safari does not create the root element for some unknown reason
+                if(oDoc && (sUri || sName) && !oDoc.documentElement){
+                    oDoc.appendChild(oDoc.createElementNS(sUri, sName));
+                };
+                return oDoc;
+            };
+        };
+    };//if(_SARISSA_HAS_DOM_CREATE_DOCUMENT)
+};
+//==========================================
+// Common stuff
+//==========================================
+if(!window.DOMParser){
+    if(_SARISSA_IS_SAFARI){
+        /*
+         * DOMParser is a utility class, used to construct DOMDocuments from XML strings
+         * @constructor
+         */
+        DOMParser = function() { };
+        /** 
+        * Construct a new DOM Document from the given XMLstring
+        * @param sXml the given XML string
+        * @param contentType the content type of the document the given string represents (one of text/xml, application/xml, application/xhtml+xml). 
+        * @return a new DOM Document from the given XML string
+        */
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var xmlhttp = new XMLHttpRequest();
+            xmlhttp.open("GET", "data:text/xml;charset=utf-8," + encodeURIComponent(sXml), false);
+            xmlhttp.send(null);
+            return xmlhttp.responseXML;
+        };
+    }else if(Sarissa.getDomDocument && Sarissa.getDomDocument() && Sarissa.getDomDocument(null, "bar").xml){
+        DOMParser = function() { };
+        DOMParser.prototype.parseFromString = function(sXml, contentType){
+            var doc = Sarissa.getDomDocument();
+            doc.loadXML(sXml);
+            return doc;
+        };
+    };
+};
+
+if((typeof(document.importNode) == "undefined") && _SARISSA_IS_IE){
+    try{
+        /**
+        * Implementation of importNode for the context window document in IE
+        * @param oNode the Node to import
+        * @param bChildren whether to include the children of oNode
+        * @returns the imported node for further use
+        */
+        document.importNode = function(oNode, bChildren){
+            var tmp;
+            if(oNode.nodeName == "tbody" || oNode.nodeName == "tr"){
+                tmp = document.createElement("table");
+            }
+            else if(oNode.nodeName == "td"){
+                tmp = document.createElement("tr");
+            }
+            else if(oNode.nodeName == "option"){
+                tmp = document.createElement("select");
+            }
+            else{
+                tmp = document.createElement("div");
+            };
+            if(bChildren){
+                tmp.innerHTML = oNode.xml ? oNode.xml : oNode.outerHTML;
+            }else{
+                tmp.innerHTML = oNode.xml ? oNode.cloneNode(false).xml : oNode.cloneNode(false).outerHTML;
+            };
+            return tmp.getElementsByTagName("*")[0];
+        };
+    }catch(e){ };
+};
+if(!Sarissa.getParseErrorText){
+    /**
+     * <p>Returns a human readable description of the parsing error. Usefull
+     * for debugging. Tip: append the returned error string in a &lt;pre&gt;
+     * element if you want to render it.</p>
+     * <p>Many thanks to Christian Stocker for the initial patch.</p>
+     * @argument oDoc The target DOM document
+     * @returns The parsing error description of the target Document in
+     *          human readable form (preformated text)
+     */
+    Sarissa.getParseErrorText = function (oDoc){
+        var parseErrorText = Sarissa.PARSED_OK;
+        if(!oDoc.documentElement){
+            parseErrorText = Sarissa.PARSED_EMPTY;
+        } else if(oDoc.documentElement.tagName == "parsererror"){
+            parseErrorText = oDoc.documentElement.firstChild.data;
+            parseErrorText += "\n" +  oDoc.documentElement.firstChild.nextSibling.firstChild.data;
+        } else if(oDoc.getElementsByTagName("parsererror").length > 0){
+            var parsererror = oDoc.getElementsByTagName("parsererror")[0];
+            parseErrorText = Sarissa.getText(parsererror, true)+"\n";
+        } else if(oDoc.parseError && oDoc.parseError.errorCode != 0){
+            parseErrorText = Sarissa.PARSED_UNKNOWN_ERROR;
+        };
+        return parseErrorText;
+    };
+};
+Sarissa.getText = function(oNode, deep){
+    var s = "";
+    var nodes = oNode.childNodes;
+    for(var i=0; i < nodes.length; i++){
+        var node = nodes[i];
+        var nodeType = node.nodeType;
+        if(nodeType == Node.TEXT_NODE || nodeType == Node.CDATA_SECTION_NODE){
+            s += node.data;
+        } else if(deep == true
+                    && (nodeType == Node.ELEMENT_NODE
+                        || nodeType == Node.DOCUMENT_NODE
+                        || nodeType == Node.DOCUMENT_FRAGMENT_NODE)){
+            s += Sarissa.getText(node, true);
+        };
+    };
+    return s;
+};
+if(!window.XMLSerializer 
+    && Sarissa.getDomDocument 
+    && Sarissa.getDomDocument("","foo", null).xml){
+    /**
+     * Utility class to serialize DOM Node objects to XML strings
+     * @constructor
+     */
+    XMLSerializer = function(){};
+    /**
+     * Serialize the given DOM Node to an XML string
+     * @param oNode the DOM Node to serialize
+     */
+    XMLSerializer.prototype.serializeToString = function(oNode) {
+        return oNode.xml;
+    };
+};
+
+/**
+ * strips tags from a markup string
+ */
+Sarissa.stripTags = function (s) {
+    return s.replace(/<[^>]+>/g,"");
+};
+/**
+ * <p>Deletes all child nodes of the given node</p>
+ * @argument oNode the Node to empty
+ */
+Sarissa.clearChildNodes = function(oNode) {
+    // need to check for firstChild due to opera 8 bug with hasChildNodes
+    while(oNode.firstChild) {
+        oNode.removeChild(oNode.firstChild);
+    };
+};
+/**
+ * <p> Copies the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the copy operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is false
+ */
+Sarissa.copyChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+    var nodes = nodeFrom.childNodes;
+    if(typeof(ownerDoc.importNode) != "undefined")  {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+        };
+    } else {
+        for(var i=0;i < nodes.length;i++) {
+            nodeTo.appendChild(nodes[i].cloneNode(true));
+        };
+    };
+};
+
+/**
+ * <p> Moves the childNodes of nodeFrom to nodeTo</p>
+ * <p> <b>Note:</b> The second object's original content is deleted before 
+ * the move operation, unless you supply a true third parameter</p>
+ * @argument nodeFrom the Node to copy the childNodes from
+ * @argument nodeTo the Node to copy the childNodes to
+ * @argument bPreserveExisting whether to preserve the original content of nodeTo, default is
+ */ 
+Sarissa.moveChildNodes = function(nodeFrom, nodeTo, bPreserveExisting) {
+    if((!nodeFrom) || (!nodeTo)){
+        throw "Both source and destination nodes must be provided";
+    };
+    if(!bPreserveExisting){
+        Sarissa.clearChildNodes(nodeTo);
+    };
+    var nodes = nodeFrom.childNodes;
+    // if within the same doc, just move, else copy and delete
+    if(nodeFrom.ownerDocument == nodeTo.ownerDocument){
+        while(nodeFrom.firstChild){
+            nodeTo.appendChild(nodeFrom.firstChild);
+        };
+    } else {
+        var ownerDoc = nodeTo.nodeType == Node.DOCUMENT_NODE ? nodeTo : nodeTo.ownerDocument;
+        if(typeof(ownerDoc.importNode) != "undefined") {
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(ownerDoc.importNode(nodes[i], true));
+           };
+        }else{
+           for(var i=0;i < nodes.length;i++) {
+               nodeTo.appendChild(nodes[i].cloneNode(true));
+           };
+        };
+        Sarissa.clearChildNodes(nodeFrom);
+    };
+};
+
+/** 
+ * <p>Serialize any object to an XML string. All properties are serialized using the property name
+ * as the XML element name. Array elements are rendered as <code>array-item</code> elements, 
+ * using their index/key as the value of the <code>key</code> attribute.</p>
+ * @argument anyObject the object to serialize
+ * @argument objectName a name for that object
+ * @return the XML serializationj of the given object as a string
+ */
+Sarissa.xmlize = function(anyObject, objectName, indentSpace){
+    indentSpace = indentSpace?indentSpace:'';
+    var s = indentSpace  + '<' + objectName + '>';
+    var isLeaf = false;
+    if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String 
+        || anyObject instanceof Boolean || anyObject instanceof Date){
+        s += Sarissa.escape(""+anyObject);
+        isLeaf = true;
+    }else{
+        s += "\n";
+        var itemKey = '';
+        var isArrayItem = anyObject instanceof Array;
+        for(var name in anyObject){
+            s += Sarissa.xmlize(anyObject[name], (isArrayItem?"array-item key=\""+name+"\"":name), indentSpace + "   ");
+        };
+        s += indentSpace;
+    };
+    return s += (objectName.indexOf(' ')!=-1?"</array-item>\n":"</" + objectName + ">\n");
+};
+
+/** 
+ * Escape the given string chacters that correspond to the five predefined XML entities
+ * @param sXml the string to escape
+ */
+Sarissa.escape = function(sXml){
+    return sXml.replace(/&/g, "&amp;")
+        .replace(/</g, "&lt;")
+        .replace(/>/g, "&gt;")
+        .replace(/"/g, "&quot;")
+        .replace(/'/g, "&apos;");
+};
+
+/** 
+ * Unescape the given string. This turns the occurences of the predefined XML 
+ * entities to become the characters they represent correspond to the five predefined XML entities
+ * @param sXml the string to unescape
+ */
+Sarissa.unescape = function(sXml){
+    return sXml.replace(/&apos;/g,"'")
+        .replace(/&quot;/g,"\"")
+        .replace(/&gt;/g,">")
+        .replace(/&lt;/g,"<")
+        .replace(/&amp;/g,"&");
+};
+/*
+ * Sarissa's IE XPath Emulation 
+ */
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+
+
+/**
   * Freja._aux
   * wrapper for external dependencies (frameworks).
   *
   * This is the minimal auxiliary adapter. It contains self-sufficient
   * implementations of all dependencies.
-  *
+  * 
   */
 if (typeof(Freja) == "undefined") {
 	Freja = {};
@@ -29,11 +889,10 @@
     func.im_func = im_func;
     func.im_self = self;
 	return func;
-
 };
 /** formContents(elem) : Array */
 Freja._aux.formContents = function(elem) {
-	if (!elem) v = document;
+	if (!elem) elem = document;
 	var names = [];
 	var values = [];
 	var inputs = elem.getElementsByTagName("INPUT");
@@ -120,6 +979,11 @@
 	if (!src._signals[signal]) {
 		src._signals[signal] = [];
 	}
+	// checks if the callback has already been registered with the same function  (Thx to Chris D)
+	for(var item=0; item < src._signals[signal].length;item++) {
+        if(src._signals[signal][item].toString() == fnc.toString()) return;
+    } 
+    
 	src._signals[signal].push(fnc);
 };
 /** signal(src, signal, ...) : void */
@@ -144,12 +1008,7 @@
 };
 /** openXMLHttpRequest(method, url, async, user, pass) : XMLHttpRequest */
 Freja._aux.openXMLHttpRequest = function(method, url, async, user, pass) {
-	var req;
-	method = method.toUpperCase();
-	try { req = new ActiveXObject("Msxml2.XMLHTTP"); }
-	catch (e) { try { req = new ActiveXObject("Microsoft.XMLHTTP"); }
-	catch (e) { req = new XMLHttpRequest(); }}
-	if (!req) throw new Error("Can't create XMLHttpRequest");
+	var req = new XMLHttpRequest();
 	if (user && pass) {
 		req.open(method, url, async, user, pass);
 	} else {
@@ -158,6 +1017,8 @@
 	if (method == "POST" || method == "PUT") {
 		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -179,32 +1040,8 @@
 	return d;
 };
 /** xmlize(anyObject, objectName) : string */
-Freja._aux.xmlize = function(anyObject, objectName, indentSpace) {
-	var escape = function(sXml) {
-		return sXml.replace(/&/g, "&amp;")
-			.replace(/</g, "&lt;")
-			.replace(/>/g, "&gt;")
-			.replace(/"/g, "&quot;")
-			.replace(/'/g, "&apos;");
-	};
-	indentSpace = indentSpace ? indentSpace : '';
-	var s = indentSpace  + '<' + objectName + '>';
-	var isLeaf = false;
-	if(!(anyObject instanceof Object) || anyObject instanceof Number || anyObject instanceof String
-	|| anyObject instanceof Boolean || anyObject instanceof Date){
-		s += escape(""+anyObject);
-		isLeaf = true;
-	} else {
-		s += "\n";
-		var itemKey = '';
-		var isArrayItem = anyObject instanceof Array;
-		for (var name in anyObject) {
-			s += Freja._aux.xmlize(anyObject[name], (isArrayItem ? "array-item key=\""+name+"\"" : name), indentSpace + "   ");
-		};
-		s += indentSpace;
-	};
-	return s += (objectName.indexOf(' ') != -1 ? "</array-item>\n":"</" + objectName + ">\n");
-};
+Freja._aux.xmlize = Sarissa.xmlize;
+
 /** serializeXML(node) : string */
 Freja._aux.serializeXML = function(node) {
 	if (node.xml) return node.xml;
@@ -212,43 +1049,19 @@
 };
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
-	if (window.ActiveXObject) {
-		var xmlDoc = new ActiveXObject("Msxml2.DOMDocument");
-		xmlDoc.loadXML(text);
-		xmlDoc.setProperty("SelectionLanguage", "XPath");
-		return xmlDoc;
-	}
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
 Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
-	if (typeof(xml.transformNode) != "undefined") {
-		// set the parameters
+	var processor = new XSLTProcessor();
+	processor.importStylesheet(xsl);
+	if(xslParameters) {
 		for (var paramName in xslParameters) {
-			xsl.setProperty ("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			paramNode.appendChild(xsl.createTextNode(xslParameters[paramName]));
-			// @TODO: check if we have the 'select' attribute and remove it.
+			processor.setParameter("", paramName, xslParameters[paramName]);
 		}
-		var result = xml.transformNode(xsl);
-
-		// clean the stylesheet.
-		for (var paramName in xslParameters) {
-			var paramNode = xsl.selectSingleNode("//xsl:param[@name='"+ paramName +"']");
-			while(paramNode.firstChild) {
-				paramNode.removeChild(paramNode.firstChild);
-			}
-		}
-		return result;
-	};
-
-	var processor = new XSLTProcessor();
-	processor.importStylesheet(xsl);
-	for (var paramName in xslParameters) {
-		processor.setParameter(null, paramName, xslParameters[paramName]);
 	}
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	 
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -287,7 +1100,7 @@
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */
 Freja._aux.createQueryEngine = function() {
-	if (window.ActiveXObject || (document.implementation && document.implementation.hasFeature("XPath", "3.0"))) {
+	if (Sarissa.IS_ENABLED_SELECT_NODES) {
 		return new Freja.QueryEngine.XPath();
 	} else {
 		return new Freja.QueryEngine.SimplePath();
@@ -332,116 +1145,3 @@
 Freja._aux.Deferred.prototype.addErrback = function(fncError) {
 	this.addCallbacks(null, fncError);
 };
-if (document.implementation && document.implementation.hasFeature("XPath", "3.0")) {
-	XMLDocument.prototype.selectNodes = function(sExpr, contextNode) {
-		var nsDoc = this;
-		var nsresolver = this.createNSResolver(this.documentElement);
-
-		try {
-			var oResult = this.evaluate(sExpr,
-				(contextNode ? contextNode : this),
-				nsresolver,
-				XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
-		} catch(e) {
-			throw new Error("Can't evaluate expression " + sExpr);
-		}
-		var nodeList = new Array(oResult.snapshotLength);
-		nodeList.item = function(i) {
-			return (i < 0 || i >= this.length) ? null : this[i];
-		};
-		nodeList.expr = sExpr;
-		for (var i = 0;i < nodeList.length; i++) {
-			nodeList[i] = oResult.snapshotItem(i);
-		};
-		return nodeList;
-	    };
-	Element.prototype.selectNodes = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectNodes) {
-			return doc.selectNodes(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		};
-	};
-	XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode) {
-		var ctx = contextNode ? contextNode : null;
-		sExpr = "("+sExpr+")[1]";
-		var nodeList = this.selectNodes(sExpr, ctx);
-		if (nodeList.length > 0) {
-			return nodeList.item(0);
-		} else {
-			return null;
-		}
-	};
-	Element.prototype.selectSingleNode = function(sExpr) {
-		var doc = this.ownerDocument;
-		if (doc.selectSingleNode) {
-			return doc.selectSingleNode(sExpr, this);
-		} else {
-			throw new Error("Method selectNodes is only supported by XML Elements");
-		}
-	};
-};
-
-// Adapated From Sarissa
-// * @version 0.9.6.1
-// * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
-
-Freja._aux.pickRecentProgID = function(idList) {
-    var bFound = false;
-    for(var i=0; i < idList.length && !bFound; i++){
-        try{
-            var oDoc = new ActiveXObject(idList[i]);
-            return idList[i];
-        } catch (objException){ // trap; try next progID
-        };
-    };
-    throw "Could not retrieve a valid progID.";
-}
-
-if(typeof XSLTProcessor == 'undefined' && typeof ActiveXObject  != 'undefined') {
-
-    _SARISSA_DOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.DOMDocument.5.0", "Msxml2.DOMDocument.4.0", "Msxml2.DOMDocument.3.0", "MSXML2.DOMDocument", "MSXML.DOMDocument", "Microsoft.XMLDOM"]);
-    _SARISSA_XMLHTTP_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XMLHTTP.5.0", "Msxml2.XMLHTTP.4.0", "MSXML2.XMLHTTP.3.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]);
-    _SARISSA_THREADEDDOM_PROGID = Freja._aux.pickRecentProgID(["Msxml2.FreeThreadedDOMDocument.5.0", "MSXML2.FreeThreadedDOMDocument.4.0", "MSXML2.FreeThreadedDOMDocument.3.0"]);
-    _SARISSA_XSLTEMPLATE_PROGID = Freja._aux.pickRecentProgID(["Msxml2.XSLTemplate.5.0", "Msxml2.XSLTemplate.4.0", "MSXML2.XSLTemplate.3.0"]);
-
-	XSLTProcessor = function(){
-	    this.template = new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);
-	    this.processor = null;
-	};
-
-	XSLTProcessor.prototype.importStylesheet = function(xslDoc){
-	    // convert stylesheet to free threaded
-	    var converted = new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);
-	    converted.loadXML(xslDoc.xml);
-	    this.template.stylesheet = converted;
-	    this.processor = this.template.createProcessor();
-	    // (re)set default param values
-	    this.paramsSet = new Array();
-	};
-
-	XSLTProcessor.prototype.transformToDocument = function(sourceDoc){
-	    this.processor.input = sourceDoc;
-	    var outDoc = new ActiveXObject(_SARISSA_DOM_PROGID);
-	    this.processor.output = outDoc;
-	    this.processor.transform();
-	    return outDoc;
-	};
-
-	XSLTProcessor.prototype.setParameter = function(nsURI, name, value){
-	    /* nsURI is optional but cannot be null */
-	    if(nsURI){
-	        this.processor.addParameter(name, value, nsURI);
-	    }else{
-	        this.processor.addParameter(name, value);
-	    };
-	    /* update updated params for getParameter */
-	    if(!this.paramsSet[""+nsURI]){
-	        this.paramsSet[""+nsURI] = new Array();
-	    };
-	    this.paramsSet[""+nsURI][name] = value;
-	};
-
-}
-

Modified: trunk/src/auxiliary/mochi+sarissa.js
===================================================================
--- trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -43,7 +43,50 @@
 /** bind(func, self) : function */
 Freja._aux.bind = MochiKit.Base.bind;
 /** formContents(elem) : Array */
-Freja._aux.formContents = MochiKit.DOM.formContents;
+Freja._aux.formContents = function(elem) {
+	if (!elem) elem = document;
+	var names = [];
+	var values = [];
+	var inputs = elem.getElementsByTagName("INPUT");
+	for (var i = 0; i < inputs.length; ++i) {
+		var input = inputs[i];
+		if (input.name) {
+			if (input.type == "radio" || input.type == "checkbox") {
+				if (input.checked) {
+					names.push(input.name);
+					values.push(input.value);
+				} else {
+					names.push(input.name);
+					values.push("");
+				}
+			} else {
+				names.push(input.name);
+				values.push(input.value);
+			}
+		}
+	}
+	var textareas = elem.getElementsByTagName("TEXTAREA");
+	for (var i = 0; i < textareas.length; ++i) {
+		var input = textareas[i];
+		if (input.name) {
+			names.push(input.name);
+			values.push(input.value);
+		}
+	}
+	var selects = elem.getElementsByTagName("SELECT");
+	for (var i = 0; i < selects.length; ++i) {
+		var input = selects[i];
+		if (input.name) {
+			if (input.selectedIndex >= 0) {
+				var opt = input.options[input.selectedIndex];
+				names.push(input.name);
+				values.push((opt.value) ? opt.value : "");
+			}
+		}
+	}
+	return [names, values];
+};
+
 /** getElement(id) : HTMLElement */
 Freja._aux.getElement = MochiKit.DOM.getElement;
 
@@ -66,6 +109,8 @@
 	if (method == "POST" || method == "PUT") {
 		req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
 	}
+	// RoR/cakePHP Ajax request detection compatibility:
+	req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');	
 	return req;
 };
 /** sendXMLHttpRequest(req, sendContent) : Deferred */
@@ -73,17 +118,25 @@
 /** xmlize(anyObject, objectName) : string */
 Freja._aux.xmlize = Sarissa.xmlize;
 /** serializeXML(node) : string */
-Freja._aux.serializeXML = Sarissa.serialize;
+Freja._aux.serializeXML = function(node) {
+	if (node.xml) return node.xml;
+	return (new XMLSerializer()).serializeToString(node);
+};
 /** loadXML(string) : XMLDocument */
 Freja._aux.loadXML = function(text) {
 	return (new DOMParser()).parseFromString(text, "text/xml");
 };
 /** transformXSL(XMLDocument, XSLDocument) : string */
-Freja._aux.transformXSL = function(xml, xsl) {
+Freja._aux.transformXSL = function(xml, xsl, xslParameters) {
 	var processor = new XSLTProcessor();
 	processor.importStylesheet(xsl);
-	return Freja._aux.serializeXML(processor.transformToDocument(xml));
-
+	if(xslParameters) {
+		for (var paramName in xslParameters) {
+			processor.setParameter("", paramName, xslParameters[paramName]);
+		}
+	}
+	 
+	return processor.transformToFragment(xml, window.document);
 };
 /** cloneXMLDocument(document) : XMLDocument */
 Freja._aux.cloneXMLDocument = function(xmlDoc) {
@@ -91,7 +144,7 @@
 	try {
 		clone = xmlDoc.cloneNode(true);
 	} catch(e) { /* squelch */ }
-
+	
 	// Can't clone a DocumentNode in Safari & Opera. Let's try something else.
 	// @note Wouldn't it be easier to serialize the document to string and the parse it to a new document ?
 	if (!clone) {
@@ -101,23 +154,27 @@
 			var data = clone.importNode(xmlDoc.documentElement.cloneNode(true), true);
 			try {
 				clone.appendChild(data);
-			} catch(e) {
+			} catch(e) {				
 				// Opera has already created a documentElement and can't append another root node
 				var rootNode = clone.documentElement;
-				for (var i = data.childNodes.length; i >= 0; i--) {
+			
+				for (var i = data.childNodes.length-1; i >= 0; i--) {
 					rootNode.insertBefore(data.childNodes[i], rootNode.firstChild);
 				}
+				
 				// need to copy root node attributes
 				for (var i = 0; i < xmlDoc.documentElement.attributes.length; i++) {
 					var name  = xmlDoc.documentElement.attributes.item(i).name;
 					var value = xmlDoc.documentElement.attributes.item(i).value;
 					clone.documentElement.setAttribute(name, value);
-				}
+				}				
 			}
 		}
 	}
+	
 	return clone;
 };
+
 /** hasSupportForXSLT() : boolean */
 Freja._aux.hasSupportForXSLT = function() { return (typeof(XSLTProcessor) != "undefined"); };
 /** createQueryEngine() : Freja.QueryEngine */
@@ -128,3 +185,208 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+
+
+/**
+ * ====================================================================
+ * About
+ * ====================================================================
+ * Sarissa cross browser XML library - IE XPath Emulation 
+ * @version 0.9.7.6
+ * @author: Manos Batsis, mailto: mbatsis at users full stop sourceforge full stop net
+ *
+ * This script emulates Internet Explorer's selectNodes and selectSingleNode
+ * for Mozilla. Associating namespace prefixes with URIs for your XPath queries
+ * is easy with IE's setProperty. 
+ * USers may also map a namespace prefix to a default (unprefixed) namespace in the
+ * source document with Sarissa.setXpathNamespaces
+ *
+ *
+ * ====================================================================
+ * Licence
+ * ====================================================================
+ * Sarissa is free software distributed under the GNU GPL version 2 (see <a href="gpl.txt">gpl.txt</a>) or higher, 
+ * GNU LGPL version 2.1 (see <a href="lgpl.txt">lgpl.txt</a>) or higher and Apache Software License 2.0 or higher 
+ * (see <a href="asl.txt">asl.txt</a>). This means you can choose one of the three and use that if you like. If 
+ * you make modifications under the ASL, i would appreciate it if you submitted those.
+ * In case your copy of Sarissa does not include the license texts, you may find
+ * them online in various formats at <a href="http://www.gnu.org">http://www.gnu.org</a> and 
+ * <a href="http://www.apache.org">http://www.apache.org</a>.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY 
+ * KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
+ * WARRANTIES OF MERCHANTABILITY,FITNESS FOR A PARTICULAR PURPOSE 
+ * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
+ * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR 
+ * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
+ * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+ */
+if(_SARISSA_HAS_DOM_FEATURE && document.implementation.hasFeature("XPath", "3.0")){
+    /**
+    * <p>SarissaNodeList behaves as a NodeList but is only used as a result to <code>selectNodes</code>,
+    * so it also has some properties IEs proprietery object features.</p>
+    * @private
+    * @constructor
+    * @argument i the (initial) list size
+    */
+    function SarissaNodeList(i){
+        this.length = i;
+    };
+    /** <p>Set an Array as the prototype object</p> */
+    SarissaNodeList.prototype = new Array(0);
+    /** <p>Inherit the Array constructor </p> */
+    SarissaNodeList.prototype.constructor = Array;
+    /**
+    * <p>Returns the node at the specified index or null if the given index
+    * is greater than the list size or less than zero </p>
+    * <p><b>Note</b> that in ECMAScript you can also use the square-bracket
+    * array notation instead of calling <code>item</code>
+    * @argument i the index of the member to return
+    * @returns the member corresponding to the given index
+    */
+    SarissaNodeList.prototype.item = function(i) {
+        return (i < 0 || i >= this.length)?null:this[i];
+    };
+    /**
+    * <p>Emulate IE's expr property
+    * (Here the SarissaNodeList object is given as the result of selectNodes).</p>
+    * @returns the XPath expression passed to selectNodes that resulted in
+    *          this SarissaNodeList
+    */
+    SarissaNodeList.prototype.expr = "";
+    /** dummy, used to accept IE's stuff without throwing errors */
+    if(window.XMLDocument && (!XMLDocument.prototype.setProperty)){
+        XMLDocument.prototype.setProperty  = function(x,y){};
+    };
+    /**
+    * <p>Programmatically control namespace URI/prefix mappings for XPath
+    * queries.</p>
+    * <p>This method comes especially handy when used to apply XPath queries
+    * on XML documents with a default namespace, as there is no other way
+    * of mapping that to a prefix.</p>
+    * <p>Using no namespace prefix in DOM Level 3 XPath queries, implies you
+    * are looking for elements in the null namespace. If you need to look
+    * for nodes in the default namespace, you need to map a prefix to it
+    * first like:</p>
+    * <pre>Sarissa.setXpathNamespaces(oDoc, &quot;xmlns:myprefix=&amp;aposhttp://mynsURI&amp;apos&quot;);</pre>
+    * <p><b>Note 1 </b>: Use this method only if the source document features
+    * a default namespace (without a prefix), otherwise just use IE's setProperty
+    * (moz will rezolve non-default namespaces by itself). You will need to map that
+    * namespace to a prefix for queries to work.</p>
+    * <p><b>Note 2 </b>: This method calls IE's setProperty method to set the
+    * appropriate namespace-prefix mappings, so you dont have to do that.</p>
+    * @param oDoc The target XMLDocument to set the namespace mappings for.
+    * @param sNsSet A whilespace-seperated list of namespace declarations as
+    *            those would appear in an XML document. E.g.:
+    *            <code>&quot;xmlns:xhtml=&apos;http://www.w3.org/1999/xhtml&apos;
+    * xmlns:&apos;http://www.w3.org/1999/XSL/Transform&apos;&quot;</code>
+    * @throws An error if the format of the given namespace declarations is bad.
+    */
+    Sarissa.setXpathNamespaces = function(oDoc, sNsSet) {
+        //oDoc._sarissa_setXpathNamespaces(sNsSet);
+        oDoc._sarissa_useCustomResolver = true;
+        var namespaces = sNsSet.indexOf(" ")>-1?sNsSet.split(" "):new Array(sNsSet);
+        oDoc._sarissa_xpathNamespaces = new Array(namespaces.length);
+        for(var i=0;i < namespaces.length;i++){
+            var ns = namespaces[i];
+            var colonPos = ns.indexOf(":");
+            var assignPos = ns.indexOf("=");
+            if(colonPos > 0 && assignPos > colonPos+1){
+                var prefix = ns.substring(colonPos+1, assignPos);
+                var uri = ns.substring(assignPos+2, ns.length-1);
+                oDoc._sarissa_xpathNamespaces[prefix] = uri;
+            }else{
+                throw "Bad format on namespace declaration(s) given";
+            };
+        };
+    };
+    /**
+    * @private Flag to control whether a custom namespace resolver should
+    *          be used, set to true by Sarissa.setXpathNamespaces
+    */
+    XMLDocument.prototype._sarissa_useCustomResolver = false;
+    /** @private */
+    XMLDocument.prototype._sarissa_xpathNamespaces = new Array();
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectNodes.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as a SarissaNodeList
+    * @throws An error if no namespace URI is found for the given prefix.
+    */
+    XMLDocument.prototype.selectNodes = function(sExpr, contextNode, returnSingle){
+        var nsDoc = this;
+        var nsresolver = this._sarissa_useCustomResolver
+        ? function(prefix){
+            var s = nsDoc._sarissa_xpathNamespaces[prefix];
+            if(s)return s;
+            else throw "No namespace URI found for prefix: '" + prefix+"'";
+            }
+        : this.createNSResolver(this.documentElement);
+        var result = null;
+        if(!returnSingle){
+            var oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+            var nodeList = new SarissaNodeList(oResult.snapshotLength);
+            nodeList.expr = sExpr;
+            for(var i=0;i<nodeList.length;i++)
+                nodeList[i] = oResult.snapshotItem(i);
+            result = nodeList;
+        }
+        else {
+            result = oResult = this.evaluate(sExpr,
+                (contextNode?contextNode:this),
+                nsresolver,
+                XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
+        };
+        return result;      
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectNodes</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An
+    *             error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectNodes = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectNodes)
+            return doc.selectNodes(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    /**
+    * <p>Extends the XMLDocument to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @argument contextNode this is for internal use only by the same
+    *           method when called on Elements
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    */
+    XMLDocument.prototype.selectSingleNode = function(sExpr, contextNode){
+        var ctx = contextNode?contextNode:null;
+        return this.selectNodes(sExpr, ctx, true);
+    };
+    /**
+    * <p>Extends the Element to emulate IE's selectSingleNode.</p>
+    * @argument sExpr the XPath expression to use
+    * @returns the result of the XPath search as an (Sarissa)NodeList
+    * @throws An error if invoked on an HTML Element as this is only be
+    *             available to XML Elements.
+    */
+    Element.prototype.selectSingleNode = function(sExpr){
+        var doc = this.ownerDocument;
+        if(doc.selectSingleNode)
+            return doc.selectSingleNode(sExpr, this);
+        else
+            throw "Method selectNodes is only supported by XML Elements";
+    };
+    Sarissa.IS_ENABLED_SELECT_NODES = true;
+};
+if(_SARISSA_IS_IE)
+	 Sarissa.IS_ENABLED_SELECT_NODES = true;
+

Modified: trunk/tests/index.html
===================================================================
--- trunk/tests/index.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/index.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,7 +1,7 @@
 <html>
 <head>
     <!-- This harness does not work locally in Safari -->
-    <script type="text/javascript" src="../lib/MochiKit.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/MochiKit.js"></script>
     <script type="text/javascript" src="SimpleTest/TestRunner.js"></script>
 </head>
 <body>

Modified: trunk/tests/test_Freja-History.html
===================================================================
--- trunk/tests/test_Freja-History.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-History.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,10 @@
 <html>
 <head>
     <!-- MochiKit is needed by SimpleTest -->
-    <script type="text/javascript" src="../lib/MochiKit.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/MochiKit.js"></script>
     <script type="text/javascript" src="SimpleTest/SimpleTest.js"></script>
-    <script type="text/javascript" src="../lib/Sarissa.js"></script>
-    <script type="text/javascript" src="../lib/Freja.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/Sarissa.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/Freja.js"></script>
     <link rel="stylesheet" type="text/css" href="SimpleTest/test.css">
 </head>
 <body>

Modified: trunk/tests/test_Freja-Model.html
===================================================================
--- trunk/tests/test_Freja-Model.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-Model.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,11 +1,12 @@
 <html>
 <head>
+	<title>Freja Test Suite</title>
     <!-- MochiKit is needed by SimpleTest -->
-    <script type="text/javascript" src="../lib/MochiKit.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/MochiKit.js"></script>
     <script type="text/javascript" src="SimpleTest/SimpleTest.js"></script>
-    <script type="text/javascript" src="../lib/Sarissa.js"></script>
-    <script type="text/javascript" src="../lib/Freja.js"></script>
-    <link rel="stylesheet" type="text/css" href="SimpleTest/test.css">
+    <script type="text/javascript" src="../lib/mochi+sarissa/Sarissa.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/Freja.js"></script>
+    <link rel="stylesheet" type="text/css" href="SimpleTest/test.css" />
 </head>
 <body>
 

Modified: trunk/tests/test_Freja-View.html
===================================================================
--- trunk/tests/test_Freja-View.html	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Freja-View.html	2007-03-21 15:13:46 UTC (rev 86)
@@ -1,10 +1,10 @@
 <html>
 <head>
     <!-- MochiKit is needed by SimpleTest -->
-    <script type="text/javascript" src="../lib/MochiKit.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/MochiKit.js"></script>
     <script type="text/javascript" src="SimpleTest/SimpleTest.js"></script>
-    <script type="text/javascript" src="../lib/Sarissa.js"></script>
-    <script type="text/javascript" src="../lib/Freja.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/Sarissa.js"></script>
+    <script type="text/javascript" src="../lib/mochi+sarissa/Freja.js"></script>
     <link rel="stylesheet" type="text/css" href="SimpleTest/test.css">
 </head>
 <body>

Modified: trunk/tests/test_Model.js
===================================================================
--- trunk/tests/test_Model.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_Model.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -43,8 +43,7 @@
 	var model = Freja.AssetManager.getModel("data/model2.xml");
 	t.is(model.get("item/@price"), "$3.80");
 	t.is(model.get("item/description"), "with Goat Cheese, a touch of Cumin and Cayenne");
-
-
+	
 	var model3 = Freja.AssetManager.getModel("data/model3.xml");
 	model3.set("item/price","$5.40");
 	t.is(model3.get("item/price"), "$5.40");

Modified: trunk/tests/test_View.js
===================================================================
--- trunk/tests/test_View.js	2007-03-21 13:42:38 UTC (rev 85)
+++ trunk/tests/test_View.js	2007-03-21 15:13:46 UTC (rev 86)
@@ -32,7 +32,7 @@
 	};
 	view.render(pojo, out);
 
-	t.ok(out.innerHTML.toLowerCase().match("<p>plain old javascript object</p>"));
+	t.ok(out.innerHTML.toLowerCase().match("<p>plain old javascript object</p>"),"The rendered view should contain the text 'plain old javascript object'");
 
 	// test of form
 	var formView = Freja.AssetManager.getView("data/form-view.xsl");



From cedsav at mail.berlios.de  Wed Mar 21 20:05:18 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Wed, 21 Mar 2007 20:05:18 +0100
Subject: [Freja-svn] r87 - trunk/external
Message-ID: <200703211905.l2LJ5IgW028367@sheep.berlios.de>

Author: cedsav
Date: 2007-03-21 20:05:13 +0100 (Wed, 21 Mar 2007)
New Revision: 87

Modified:
   trunk/external/srvc-xslt.php
Log:
Fixed character encoding issue with remote XSLT

Modified: trunk/external/srvc-xslt.php
===================================================================
--- trunk/external/srvc-xslt.php	2007-03-21 15:13:46 UTC (rev 86)
+++ trunk/external/srvc-xslt.php	2007-03-21 19:05:13 UTC (rev 87)
@@ -1,4 +1,8 @@
 <?php
+	// XSL Transformation Service for Freja
+	// PHP4.0 Version 1.0
+
+
 	function error_handler($errno, $errstr, $errfile, $errline) {
 		if (error_reporting() == 0) {
 			return;
@@ -9,8 +13,7 @@
 		}
 		error_log($errstr."\n", 3, $filename);
 		header("HTTP/1.0 500 Internal Error");
-		//header('Content-Type: text/xml');
-		/*echo "<?xml version='1.0' ?><error>".$errstr."</error>";*/
+		header('Content-Type: text/plain; charset="UTF-8"');
 		echo "Error: ".$errstr;
 		exit;
 	}
@@ -22,20 +25,7 @@
 		set_exception_handler('exception_handler');
 	}
 
-	// XSL Transformation Service for Freja
-	// PHP4.0 Version 1.0
-
-	// Freja - a javascript Model-View-Controller Framework geared toward Zero-Latency Web Applications
-	// v1.0 Beta - Dec. 2005
-	// Copyright (c) 2005 C?dric Savarese <pro at 4213miles.com>
-	// This software is licensed under the CC-GNU LGPL <http://creativecommons.org/licenses/LGPL/2.1/>
-	// Documentation : http://www.csscripting.com/freja
-
-
 	if (isset($_POST['xmlData']) && isset($_POST['xslFile'])) {
-//		if (get_magic_quotes_gpc()) {
-//			array_map('stripslashes', $_POST);
-//		}
 		$root = realpath(dirname(__FILE__)."/../");
 		$xmlData = stripslashes($_POST['xmlData']);
 		$path = isset($_GET['path']) ? ("/".stripslashes($_GET['path'])) : "";
@@ -66,7 +56,7 @@
 			$xhtmlOuput = str_replace('<?xml version="1.0"?>','',$xslDoc->result_dump_mem($transformedData));
 
 			header("HTTP/1.0 200 Ok");
-			header('Content-Type: text/xml');
+			header('Content-Type: text/xml, charset="UTF-8"');
 			echo $xhtmlOuput;
 
 		} else {



From cedsav at mail.berlios.de  Wed Mar 21 21:35:14 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Wed, 21 Mar 2007 21:35:14 +0100
Subject: [Freja-svn] r88 - in trunk: lib/minimal lib/mochi+sarissa
	src/auxiliary
Message-ID: <200703212035.l2LKZE81001912@sheep.berlios.de>

Author: cedsav
Date: 2007-03-21 21:30:15 +0100 (Wed, 21 Mar 2007)
New Revision: 88

Modified:
   trunk/lib/minimal/Freja.js
   trunk/lib/minimal/Freja_pack.js
   trunk/lib/mochi+sarissa/Freja.js
   trunk/lib/mochi+sarissa/Freja_pack.js
   trunk/src/auxiliary/minimal.js
   trunk/src/auxiliary/mochi+sarissa.js
Log:
Added Freja._aux.importNode method.

Modified: trunk/lib/minimal/Freja.js
===================================================================
--- trunk/lib/minimal/Freja.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/lib/minimal/Freja.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -2,7 +2,7 @@
 
     Freja 2.1
 
-    Build $Wed, 21 Mar 2007 15:05:31 UTC$
+    Build $Wed, 21 Mar 2007 20:26:12 UTC$
 
     Target: minimal
 
@@ -1194,7 +1194,13 @@
 Freja._aux.Deferred.prototype.addErrback = function(fncError) {
 	this.addCallbacks(null, fncError);
 };
-
+Freja._aux.importNode = function(document, node, deep) {
+	if(typeof deep =='undefined') deep = true;
+	if(document.importNode)
+		return document.importNode(node,deep);
+	else
+		return node.cloneNode(deep);
+}
 /**
   * The baseclass for queryengines
   * @abstract

Modified: trunk/lib/minimal/Freja_pack.js
===================================================================
--- trunk/lib/minimal/Freja_pack.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/lib/minimal/Freja_pack.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -796,67 +796,77 @@
 Freja._aux.Deferred.prototype.addErrback=function(_b4){
 this.addCallbacks(null,_b4);
 };
+Freja._aux.importNode=function(_b5,_b6,_b7){
+if(typeof _b7=="undefined"){
+_b7=true;
+}
+if(_b5.importNode){
+return _b5.importNode(_b6,_b7);
+}else{
+return _b6.cloneNode(_b7);
+}
+};
 Freja.QueryEngine=function(){
 };
-Freja.QueryEngine.prototype.getElementById=function(_b5,id){
-var _b7=_b5.getElementsByTagName("*");
-for(var i=0;i<_b7.length;i++){
-if(_b7[i].getAttribute("id")==id){
-return _b7[i];
+Freja.QueryEngine.prototype.getElementById=function(_b8,id){
+var _ba=_b8.getElementsByTagName("*");
+for(var i=0;i<_ba.length;i++){
+if(_ba[i].getAttribute("id")==id){
+return _ba[i];
 }
 }
 };
-Freja.QueryEngine.prototype.get=function(_b9,_ba){
-var _bb=this._find(_b9,_ba);
-if(!_bb){
-throw new Error("Can't evaluate expression "+_ba);
+Freja.QueryEngine.prototype.get=function(_bc,_bd){
+var _be=this._find(_bc,_bd);
+if(!_be){
+throw new Error("Can't evaluate expression "+_bd);
 }
-switch(_bb.nodeType){
+switch(_be.nodeType){
 case 1:
-if(_bb.firstChild&&(_bb.firstChild.nodeType==3||_bb.firstChild.nodeType==4)){
-return _bb.firstChild.nodeValue;
+if(_be.firstChild&&(_be.firstChild.nodeType==3||_be.firstChild.nodeType==4)){
+return _be.firstChild.nodeValue;
 }
 break;
 case 2:
-return _bb.nodeValue;
+return _be.nodeValue;
 break;
 case 3:
 case 4:
-return _bb.nodeValue;
+return _be.nodeValue;
 break;
 }
 return null;
 };
-Freja.QueryEngine.prototype.set=function(_bc,_bd,_be){
-var _bf=this._find(_bc,_bd);
-if(!_bf){
-var _c0=_bd.substr(_bd.lastIndexOf("/")+1);
-if(_c0.charAt(0)=="@"){
-var _c1=_bd.substring(0,_bd.lastIndexOf("/"));
-var _c2=this._find(_bc,_c1);
-if(_c2){
-_c2.setAttribute(_c0.substr(1),_be);
+Freja.QueryEngine.prototype.set=function(_bf,_c0,_c1){
+var _c2=this._find(_bf,_c0);
+if(!_c2){
+var _c3=_c0.substr(_c0.lastIndexOf("/")+1);
+if(_c3.charAt(0)=="@"){
+var _c4=_c0.substring(0,_c0.lastIndexOf("/"));
+var _c5=this._find(_bf,_c4);
+if(_c5){
+_c5.setAttribute(_c3.substr(1),_c1);
 return;
 }
 }
-throw new Error("Can't evaluate expression "+_bd);
+throw new Error("Can't evaluate expression "+_c0);
 }
-switch(_bf.nodeType){
+switch(_c2.nodeType){
 case 1:
-if(_bf.firstChild&&(_bf.firstChild.nodeType==3||_bf.firstChild.nodeType==4)){
-_bf.firstChild.nodeValue=_be;
+if(_c2.firstChild&&(_c2.firstChild.nodeType==3||_c2.firstChild.nodeType==4)){
+_c2.firstChild.nodeValue=_c1;
 }else{
-if(_be!=""){
-_bf.appendChild(_bc.createTextNode(_be));
+if(_c1!=""){
+_c2.appendChild(_bf.createTextNode(_c1));
 }
 }
 break;
 case 2:
-_bf.nodeValue=_be;
+_c2.nodeValue=_c1;
 break;
 case 3:
 case 4:
-_bf.nodeValue=_be;
+_c2.nodeValue=_c1;
 break;
 }
 return;
@@ -864,76 +874,76 @@
 Freja.QueryEngine.XPath=function(){
 };
 Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find=function(_c3,_c4){
-var _c5=_c3.selectSingleNode(_c4);
-return _c5;
+Freja.QueryEngine.XPath.prototype._find=function(_c6,_c7){
+var _c8=_c6.selectSingleNode(_c7);
+return _c8;
 };
 Freja.QueryEngine.SimplePath=function(){
 };
 Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
-Freja.QueryEngine.SimplePath.prototype._find=function(_c6,_c7){
-if(!_c7.match(/^[\d\w\/@\[\]=_\-']*$/)){
-throw new Error("Can't evaluate expression "+_c7);
+Freja.QueryEngine.SimplePath.prototype._find=function(_c9,_ca){
+if(!_ca.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error("Can't evaluate expression "+_ca);
 }
-var _c8=_c7.split("/");
-var _c9=_c6;
-var _ca=new RegExp("^@([\\d\\w]*)");
-var _cb=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
-var _cc=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
-var _cd=null;
-var _ce=0;
-for(var i=0;i<_c8.length;++i){
-var _d0=_c8[i];
-var _d1=_cc.exec(_d0);
-if(_d1){
-if(i>0&&_c8[i-1]==""){
-var cn=_c9.getElementsByTagName(_d1[1]);
+var _cb=_ca.split("/");
+var _cc=_c9;
+var _cd=new RegExp("^@([\\d\\w]*)");
+var _ce=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+var _cf=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+var _d0=null;
+var _d1=0;
+for(var i=0;i<_cb.length;++i){
+var _d3=_cb[i];
+var _d4=_cf.exec(_d3);
+if(_d4){
+if(i>0&&_cb[i-1]==""){
+var cn=_cc.getElementsByTagName(_d4[1]);
 }else{
-var cn=_c9.childNodes;
+var cn=_cc.childNodes;
 }
 for(var j=0,l=cn.length;j<l;j++){
-if(cn[j].nodeType==1&&cn[j].tagName==_d1[1]&&cn[j].getAttribute(_d1[2])==_d1[3]){
-_c9=cn[j];
+if(cn[j].nodeType==1&&cn[j].tagName==_d4[1]&&cn[j].getAttribute(_d4[2])==_d4[3]){
+_cc=cn[j];
 break;
 }
 }
 if(j==l){
-throw new Error("Can't evaluate expression "+_d0);
+throw new Error("Can't evaluate expression "+_d3);
 }
 }else{
-_ce=_cb.exec(_d0);
-if(_ce){
-_d0=_ce[1];
-_ce=_ce[2]-1;
+_d1=_ce.exec(_d3);
+if(_d1){
+_d3=_d1[1];
+_d1=_d1[2]-1;
 }else{
-_ce=0;
+_d1=0;
 }
-if(_d0!=""){
-_cd=_ca.exec(_d0);
-if(_cd){
-_c9=_c9.getAttributeNode(_cd[1]);
+if(_d3!=""){
+_d0=_cd.exec(_d3);
+if(_d0){
+_cc=_cc.getAttributeNode(_d0[1]);
 }else{
-_c9=_c9.getElementsByTagName(_d0).item(_ce);
+_cc=_cc.getElementsByTagName(_d3).item(_d1);
 }
 }
 }
 }
-if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==3){
-return _c9.firstChild;
+if(_cc&&_cc.firstChild&&_cc.firstChild.nodeType==3){
+return _cc.firstChild;
 }
-if(_c9&&_c9.firstChild&&_c9.firstChild.nodeType==4){
-return _c9.firstChild;
+if(_cc&&_cc.firstChild&&_cc.firstChild.nodeType==4){
+return _cc.firstChild;
 }
-if(!_c9){
-throw new Error("Can't evaluate expression "+_c7);
+if(!_cc){
+throw new Error("Can't evaluate expression "+_ca);
 }
-return _c9;
+return _cc;
 };
-Freja.Model=function(url,_d5){
+Freja.Model=function(url,_d8){
 this.url=url;
 this.ready=false;
 this.document=null;
-this._query=_d5;
+this._query=_d8;
 };
 Freja.Model.prototype.getElementById=function(id){
 if(this.document){
@@ -941,31 +951,31 @@
 }
 return null;
 };
-Freja.Model.prototype.get=function(_d7){
+Freja.Model.prototype.get=function(_da){
 if(this.document){
-return this._query.get(this.document,_d7);
+return this._query.get(this.document,_da);
 }
 return null;
 };
-Freja.Model.prototype.set=function(_d8,_d9){
+Freja.Model.prototype.set=function(_db,_dc){
 if(this.document){
-return this._query.set(this.document,_d8,_d9);
+return this._query.set(this.document,_db,_dc);
 }
 return null;
 };
-Freja.Model.prototype.updateFrom=function(_da){
-var _db=_da.getValues();
-for(var i=0;i<_db[0].length;++i){
-if(_db[0][i].lastIndexOf("/")!=-1){
-this.set(_db[0][i],_db[1][i]);
+Freja.Model.prototype.updateFrom=function(_dd){
+var _de=_dd.getValues();
+for(var i=0;i<_de[0].length;++i){
+if(_de[0][i].lastIndexOf("/")!=-1){
+this.set(_de[0][i],_de[1][i]);
 }
 }
 };
 Freja.Model.prototype.save=function(){
 var url=this.url;
-var _de=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_de){
-url=_de[1]+url;
+var _e1=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_e1){
+url=_e1[1]+url;
 }
 var d=Freja._aux.createDeferred();
 var req=Freja.AssetManager.openXMLHttpRequest("POST",url);
@@ -979,68 +989,68 @@
 };
 Freja.Model.prototype.remove=function(){
 var url=this.url;
-var _e2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_e2){
-url=_e2[1]+url;
+var _e5=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_e5){
+url=_e5[1]+url;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("DELETE",url);
 return Freja._aux.sendXMLHttpRequest(req);
 };
 Freja.Model.prototype.reload=function(){
 this.ready=false;
-var _e4=Freja._aux.bind(function(_e5){
-this.document=_e5;
+var _e7=Freja._aux.bind(function(_e8){
+this.document=_e8;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },this);
 var d=Freja.AssetManager.loadAsset(this.url,true);
-d.addCallbacks(_e4,Freja.AssetManager.onerror);
+d.addCallbacks(_e7,Freja.AssetManager.onerror);
 return d;
 };
-Freja.Model.DataSource=function(_e7,_e8){
-this.createURL=_e7;
-this.indexURL=_e8;
+Freja.Model.DataSource=function(_ea,_eb){
+this.createURL=_ea;
+this.indexURL=_eb;
 };
 Freja.Model.DataSource.prototype.select=function(){
 return getModel(this.indexURL);
 };
-Freja.Model.DataSource.prototype.create=function(_e9){
+Freja.Model.DataSource.prototype.create=function(_ec){
 var url=this.createURL;
-var _eb=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_eb){
-url=_eb[1]+url;
+var _ee=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_ee){
+url=_ee[1]+url;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("PUT",url);
-var _ed={};
-for(var i=0,len=_e9[0].length;i<len;++i){
-_ed[_e9[0][i]]=_e9[1][i];
+var _f0={};
+for(var i=0,len=_ec[0].length;i<len;++i){
+_f0[_ec[0][i]]=_ec[1][i];
 }
-return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_ed,"record"));
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_f0,"record"));
 };
-Freja.View=function(url,_f0){
+Freja.View=function(url,_f3){
 this.url=url;
 this.ready=false;
 this.document=null;
-this._renderer=_f0;
+this._renderer=_f3;
 this._destination=null;
 this.behaviors=[];
 this.placeholder=null;
 Freja._aux.connect(this,"onrendercomplete",Freja._aux.bind(this._connectBehavior,this));
 };
-Freja.View.prototype.render=function(_f1,_f2,_f3){
-if(typeof (_f2)=="undefined"){
-_f2=this.placeholder;
+Freja.View.prototype.render=function(_f4,_f5,_f6){
+if(typeof (_f5)=="undefined"){
+_f5=this.placeholder;
 }
-if(typeof (_f3)=="undefined"){
-_f3=this.xslParameters;
+if(typeof (_f6)=="undefined"){
+_f6=this.xslParameters;
 }
-var _f4=function(_f5,_f6,_f7,_f8){
-this.model=_f5;
-this.view=_f6;
-this.deferred=_f7;
-this.xslParameters=_f8;
+var _f7=function(_f8,_f9,_fa,_fb){
+this.model=_f8;
+this.view=_f9;
+this.deferred=_fa;
+this.xslParameters=_fb;
 };
-_f4.prototype.trigger=function(){
+_f7.prototype.trigger=function(){
 try{
 if(!this.view.ready){
 Freja._aux.connect(this.view,"onload",Freja._aux.bind(this.trigger,this));
@@ -1050,30 +1060,30 @@
 Freja._aux.connect(this.model,"onload",Freja._aux.bind(this.trigger,this));
 return;
 }
-var _f9;
+var _fc;
 if(typeof (this.model)=="undefined"){
-_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+_fc={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
 }else{
 if(this.model instanceof Freja.Model){
-_f9=this.model;
+_fc=this.model;
 }else{
-_f9={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
+_fc={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
 }
 }
-var _fa=this.view._renderer.transform(_f9,this.view,this.xslParameters);
-_fa.addCallback(Freja._aux.bind(function(_fb){
-if(typeof _fb=="string"){
-this._destination.innerHTML=_fb;
+var _fd=this.view._renderer.transform(_fc,this.view,this.xslParameters);
+_fd.addCallback(Freja._aux.bind(function(_fe){
+if(typeof _fe=="string"){
+this._destination.innerHTML=_fe;
 }else{
 this._destination.innerHTML="";
-this._destination.appendChild(_fb);
+this._destination.appendChild(_fe);
 }
 },this.view));
-_fa.addCallback(Freja._aux.bind(function(){
+_fd.addCallback(Freja._aux.bind(function(){
 Freja._aux.signal(this,"onrendercomplete",this._destination);
 },this.view));
-_fa.addCallback(this.deferred.callback);
-_fa.addErrback(this.deferred.errback);
+_fd.addCallback(this.deferred.callback);
+_fd.addErrback(this.deferred.errback);
 }
 catch(ex){
 this.deferred.errback(ex);
@@ -1081,13 +1091,13 @@
 };
 var d=Freja._aux.createDeferred();
 try{
-if(typeof (_f2)=="object"){
-this._destination=_f2;
+if(typeof (_f5)=="object"){
+this._destination=_f5;
 }else{
-this._destination=document.getElementById(_f2);
+this._destination=document.getElementById(_f5);
 }
 this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
-var h=new _f4(_f1,this,d,_f3);
+var h=new _f7(_f4,this,d,_f6);
 h.trigger();
 }
 catch(ex){
@@ -1095,49 +1105,49 @@
 }
 return d;
 };
-Freja.View.prototype._connectBehavior=function(_fe){
+Freja.View.prototype._connectBehavior=function(_101){
 try{
-var _ff=function(node,_101,_102){
-Freja._aux.connect(node,_101,Freja._aux.bind(function(e){
-var _104=false;
+var _102=function(node,_104,_105){
+Freja._aux.connect(node,_104,Freja._aux.bind(function(e){
+var _107=false;
 try{
-_104=_102(this);
+_107=_105(this);
 }
 catch(ex){
 throw new Error("An error ocurred in user handler.\n"+ex.message);
 }
 finally{
-if(!_104){
+if(!_107){
 e.stop();
 }
 }
 },node));
 };
-var _105=function(node,_107){
+var _108=function(node,_10a){
 for(var i=0,c=node.childNodes,l=c.length;i<l;++i){
-var _109=c[i];
-if(_109.nodeType==1){
-if(_109.className){
-var _10a=_109.className.split(" ");
-for(var j=0;j<_10a.length;j++){
-var _10c=_107[_10a[j]];
-if(_10c){
-for(var _10d in _10c){
-if(_10d=="init"){
-_10c.init(_109);
+var _10c=c[i];
+if(_10c.nodeType==1){
+if(_10c.className){
+var _10d=_10c.className.split(" ");
+for(var j=0;j<_10d.length;j++){
+var _10f=_10a[_10d[j]];
+if(_10f){
+for(var _110 in _10f){
+if(_110=="init"){
+_10f.init(_10c);
 }else{
-_ff(_109,_10d,_10c[_10d]);
+_102(_10c,_110,_10f[_110]);
 }
 }
 }
 }
 }
-_105(_109,_107);
+_108(_10c,_10a);
 }
 }
 };
 for(var ids in this.behaviors){
-_105(_fe,this.behaviors);
+_108(_101,this.behaviors);
 break;
 }
 }
@@ -1153,10 +1163,10 @@
 Freja.View.Renderer.XSLTransformer=function(){
 };
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.XSLTransformer.prototype.transform=function(_10f,view,_111){
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_112,view,_114){
 var d=Freja._aux.createDeferred();
 try{
-var html=Freja._aux.transformXSL(_10f.document,view.document,_111);
+var html=Freja._aux.transformXSL(_112.document,view.document,_114);
 if(!html){
 d.errback(new Error("XSL Transformation error."));
 }else{
@@ -1172,16 +1182,16 @@
 this.url=url;
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_115,view,_117){
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_118,view,_11a){
 var d=Freja._aux.createDeferred();
-var _119=view.url;
-var _11a="xslFile="+encodeURIComponent(_119)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_115.document));
-var _11b="";
-for(var _11c in _117){
-_11b+=encodeURIComponent(_11c+","+_117[_11c]);
+var _11c=view.url;
+var _11d="xslFile="+encodeURIComponent(_11c)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_118.document));
+var _11e="";
+for(var _11f in _11a){
+_11e+=encodeURIComponent(_11f+","+_11a[_11f]);
 }
-if(_11b.length>0){
-_11a=_11a+"&xslParam="+_11b;
+if(_11e.length>0){
+_11d=_11d+"&xslParam="+_11e;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
 req.onreadystatechange=function(){
@@ -1193,7 +1203,7 @@
 }
 }
 };
-req.send(_11a);
+req.send(_11d);
 return d;
 };
 Freja.UndoHistory=function(){
@@ -1202,40 +1212,40 @@
 this._position=0;
 this._undoSteps=0;
 };
-Freja.UndoHistory.prototype.add=function(_11e){
-var _11f=this._position%this.maxLength;
-var _120=_11e.document;
-this.cache[_11f]={};
-this.cache[_11f].model=_11e;
-this.cache[_11f].document=Freja._aux.cloneXMLDocument(_120);
-if(!this.cache[_11f].document){
+Freja.UndoHistory.prototype.add=function(_121){
+var _122=this._position%this.maxLength;
+var _123=_121.document;
+this.cache[_122]={};
+this.cache[_122].model=_121;
+this.cache[_122].document=Freja._aux.cloneXMLDocument(_123);
+if(!this.cache[_122].document){
 throw new Error("Couldn't add to history.");
 }else{
 this._position++;
-var _121=_11f;
+var _124=_122;
 while(this._undoSteps>0){
-_121=(_121+1)%this.maxLength;
-this.cache[_121]={};
+_124=(_124+1)%this.maxLength;
+this.cache[_124]={};
 this._undoSteps--;
 }
-return _11f;
+return _122;
 }
 };
-Freja.UndoHistory.prototype.undo=function(_122){
+Freja.UndoHistory.prototype.undo=function(_125){
 if(this._undoSteps<this.cache.length){
 this._undoSteps++;
 this._position--;
 if(this._position<0){
 this._position=this.maxLength-1;
 }
-var _123=this.cache[this._position].model;
+var _126=this.cache[this._position].model;
 if(this.cache[this._position].document){
-_123.document=this.cache[this._position].document;
+_126.document=this.cache[this._position].document;
 }else{
 throw new Error("The model's DOMDocument wasn't properly copied into the history");
 }
-if(typeof (_122)!="undefined"&&_122>1){
-this.undo(_122-1);
+if(typeof (_125)!="undefined"&&_125>1){
+this.undo(_125-1);
 }
 }else{
 throw new Error("Nothing to undo");
@@ -1245,8 +1255,8 @@
 if(this._undoSteps>0){
 this._undoSteps--;
 this._position=(this._position+1)%this.maxLength;
-var _124=this.cache[this._position].model;
-_124.document=this.cache[this._position].document;
+var _127=this.cache[this._position].model;
+_127.document=this.cache[this._position].document;
 }else{
 throw new Error("Nothing to redo");
 }
@@ -1282,12 +1292,12 @@
 }
 }
 var m=new Freja.Model(url,Freja._aux.createQueryEngine());
-var _128=Freja._aux.bind(function(_129){
-this.document=_129;
+var _12b=Freja._aux.bind(function(_12c){
+this.document=_12c;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },m);
-this.loadAsset(url,true).addCallbacks(_128,Freja.AssetManager.onerror);
+this.loadAsset(url,true).addCallbacks(_12b,Freja.AssetManager.onerror);
 this.models.push(m);
 return m;
 };
@@ -1298,46 +1308,46 @@
 }
 }
 var v=new Freja.View(url,this.createRenderer());
-var _12d=Freja._aux.bind(function(_12e){
-this.document=_12e;
+var _130=Freja._aux.bind(function(_131){
+this.document=_131;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },v);
-this.loadAsset(url,false).addCallbacks(_12d,Freja.AssetManager.onerror);
+this.loadAsset(url,false).addCallbacks(_130,Freja.AssetManager.onerror);
 this.views.push(v);
 return v;
 };
-Freja.AssetManager.openXMLHttpRequest=function(_12f,url){
-var _131=null;
-if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_12f!="GET"&&_12f!="POST"){
-_131=_12f;
-_12f="POST";
+Freja.AssetManager.openXMLHttpRequest=function(_132,url){
+var _134=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_132!="GET"&&_132!="POST"){
+_134=_132;
+_132="POST";
 }
-var req=Freja._aux.openXMLHttpRequest(_12f,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
-if(_131){
-req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_131);
+var req=Freja._aux.openXMLHttpRequest(_132,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_134){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_134);
 }
 return req;
 };
-Freja.AssetManager.setCredentials=function(_133,_134){
-this._username=_133;
-this._password=_134;
+Freja.AssetManager.setCredentials=function(_136,_137){
+this._username=_136;
+this._password=_137;
 };
-Freja.AssetManager.loadAsset=function(url,_136){
-var _137=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_137){
-url=_137[1]+url;
+Freja.AssetManager.loadAsset=function(url,_139){
+var _13a=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_13a){
+url=_13a[1]+url;
 }
 var d=Freja._aux.createDeferred();
-var _139=function(_13a){
+var _13c=function(_13d){
 try{
-if(_13a.responseText==""){
+if(_13d.responseText==""){
 throw new Error("Empty response.");
 }
-if(_13a.responseXML.xml==""){
-var _13b=Freja._aux.loadXML(_13a.responseText);
+if(_13d.responseXML.xml==""){
+var _13e=Freja._aux.loadXML(_13d.responseText);
 }else{
-var _13b=_13a.responseXML;
+var _13e=_13d.responseXML;
 }
 }
 catch(ex){
@@ -1345,14 +1355,14 @@
 }
 if(window.document.all){
 setTimeout(function(){
-d.callback(_13b);
+d.callback(_13e);
 },1);
 }else{
-d.callback(_13b);
+d.callback(_13e);
 }
 };
 try{
-if(_136&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+if(_139&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
 var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
 req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
@@ -1361,12 +1371,12 @@
 }
 var comm=Freja._aux.sendXMLHttpRequest(req);
 if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
-comm.addCallbacks(_139,function(req){
+comm.addCallbacks(_13c,function(req){
 d.errback(new Error("Request failed:"+req.status));
 });
 }else{
 if(req.status==0||req.status==200||req.status==201||req.status==304){
-_139(req);
+_13c(req);
 }else{
 d.errback(new Error("Request failed:"+req.status));
 }

Modified: trunk/lib/mochi+sarissa/Freja.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/lib/mochi+sarissa/Freja.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -2,7 +2,7 @@
 
     Freja 2.1
 
-    Build $Wed, 21 Mar 2007 15:06:18 UTC$
+    Build $Wed, 21 Mar 2007 20:26:16 UTC$
 
     Target: mochi+sarissa
 
@@ -234,8 +234,14 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+Freja._aux.importNode = function(document, node, deep) {
+	if(typeof deep =='undefined') deep = true;
+	if(document.importNode)
+		return document.importNode(node,deep);
+	else
+		return node.cloneNode(deep);
+}
 
-
 /**
  * ====================================================================
  * About

Modified: trunk/lib/mochi+sarissa/Freja_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -180,6 +180,16 @@
 return new Freja.QueryEngine.SimplePath();
 }
 };
+Freja._aux.importNode=function(_21,_22,_23){
+if(typeof _23=="undefined"){
+_23=true;
+}
+if(_21.importNode){
+return _21.importNode(_22,_23);
+}else{
+return _22.cloneNode(_23);
+}
+};
 if(_SARISSA_HAS_DOM_FEATURE&&document.implementation.hasFeature("XPath","3.0")){
 function SarissaNodeList(i){
 this.length=i;
@@ -194,18 +204,18 @@
 XMLDocument.prototype.setProperty=function(x,y){
 };
 }
-Sarissa.setXpathNamespaces=function(_25,_26){
-_25._sarissa_useCustomResolver=true;
-var _27=_26.indexOf(" ")>-1?_26.split(" "):new Array(_26);
-_25._sarissa_xpathNamespaces=new Array(_27.length);
-for(var i=0;i<_27.length;i++){
-var ns=_27[i];
-var _2a=ns.indexOf(":");
-var _2b=ns.indexOf("=");
-if(_2a>0&&_2b>_2a+1){
-var _2c=ns.substring(_2a+1,_2b);
-var uri=ns.substring(_2b+2,ns.length-1);
-_25._sarissa_xpathNamespaces[_2c]=uri;
+Sarissa.setXpathNamespaces=function(_28,_29){
+_28._sarissa_useCustomResolver=true;
+var _2a=_29.indexOf(" ")>-1?_29.split(" "):new Array(_29);
+_28._sarissa_xpathNamespaces=new Array(_2a.length);
+for(var i=0;i<_2a.length;i++){
+var ns=_2a[i];
+var _2d=ns.indexOf(":");
+var _2e=ns.indexOf("=");
+if(_2d>0&&_2e>_2d+1){
+var _2f=ns.substring(_2d+1,_2e);
+var uri=ns.substring(_2e+2,ns.length-1);
+_28._sarissa_xpathNamespaces[_2f]=uri;
 }else{
 throw "Bad format on namespace declaration(s) given";
 }
@@ -213,46 +223,46 @@
 };
 XMLDocument.prototype._sarissa_useCustomResolver=false;
 XMLDocument.prototype._sarissa_xpathNamespaces=new Array();
-XMLDocument.prototype.selectNodes=function(_2e,_2f,_30){
-var _31=this;
-var _32=this._sarissa_useCustomResolver?function(_33){
-var s=_31._sarissa_xpathNamespaces[_33];
+XMLDocument.prototype.selectNodes=function(_31,_32,_33){
+var _34=this;
+var _35=this._sarissa_useCustomResolver?function(_36){
+var s=_34._sarissa_xpathNamespaces[_36];
 if(s){
 return s;
 }else{
-throw "No namespace URI found for prefix: '"+_33+"'";
+throw "No namespace URI found for prefix: '"+_36+"'";
 }
 }:this.createNSResolver(this.documentElement);
-var _35=null;
-if(!_30){
-var _36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
-var _37=new SarissaNodeList(_36.snapshotLength);
-_37.expr=_2e;
-for(var i=0;i<_37.length;i++){
-_37[i]=_36.snapshotItem(i);
+var _38=null;
+if(!_33){
+var _39=this.evaluate(_31,(_32?_32:this),_35,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
+var _3a=new SarissaNodeList(_39.snapshotLength);
+_3a.expr=_31;
+for(var i=0;i<_3a.length;i++){
+_3a[i]=_39.snapshotItem(i);
 }
-_35=_37;
+_38=_3a;
 }else{
-_35=_36=this.evaluate(_2e,(_2f?_2f:this),_32,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
+_38=_39=this.evaluate(_31,(_32?_32:this),_35,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
 }
-return _35;
+return _38;
 };
-Element.prototype.selectNodes=function(_39){
+Element.prototype.selectNodes=function(_3c){
 var doc=this.ownerDocument;
 if(doc.selectNodes){
-return doc.selectNodes(_39,this);
+return doc.selectNodes(_3c,this);
 }else{
 throw "Method selectNodes is only supported by XML Elements";
 }
 };
-XMLDocument.prototype.selectSingleNode=function(_3b,_3c){
-var ctx=_3c?_3c:null;
-return this.selectNodes(_3b,ctx,true);
+XMLDocument.prototype.selectSingleNode=function(_3e,_3f){
+var ctx=_3f?_3f:null;
+return this.selectNodes(_3e,ctx,true);
 };
-Element.prototype.selectSingleNode=function(_3e){
+Element.prototype.selectSingleNode=function(_41){
 var doc=this.ownerDocument;
 if(doc.selectSingleNode){
-return doc.selectSingleNode(_3e,this);
+return doc.selectSingleNode(_41,this);
 }else{
 throw "Method selectNodes is only supported by XML Elements";
 }
@@ -264,65 +274,65 @@
 }
 Freja.QueryEngine=function(){
 };
-Freja.QueryEngine.prototype.getElementById=function(_40,id){
-var _42=_40.getElementsByTagName("*");
-for(var i=0;i<_42.length;i++){
-if(_42[i].getAttribute("id")==id){
-return _42[i];
+Freja.QueryEngine.prototype.getElementById=function(_43,id){
+var _45=_43.getElementsByTagName("*");
+for(var i=0;i<_45.length;i++){
+if(_45[i].getAttribute("id")==id){
+return _45[i];
 }
 }
 };
-Freja.QueryEngine.prototype.get=function(_44,_45){
-var _46=this._find(_44,_45);
-if(!_46){
-throw new Error("Can't evaluate expression "+_45);
+Freja.QueryEngine.prototype.get=function(_47,_48){
+var _49=this._find(_47,_48);
+if(!_49){
+throw new Error("Can't evaluate expression "+_48);
 }
-switch(_46.nodeType){
+switch(_49.nodeType){
 case 1:
-if(_46.firstChild&&(_46.firstChild.nodeType==3||_46.firstChild.nodeType==4)){
-return _46.firstChild.nodeValue;
+if(_49.firstChild&&(_49.firstChild.nodeType==3||_49.firstChild.nodeType==4)){
+return _49.firstChild.nodeValue;
 }
 break;
 case 2:
-return _46.nodeValue;
+return _49.nodeValue;
 break;
 case 3:
 case 4:
-return _46.nodeValue;
+return _49.nodeValue;
 break;
 }
 return null;
 };
-Freja.QueryEngine.prototype.set=function(_47,_48,_49){
-var _4a=this._find(_47,_48);
-if(!_4a){
-var _4b=_48.substr(_48.lastIndexOf("/")+1);
-if(_4b.charAt(0)=="@"){
-var _4c=_48.substring(0,_48.lastIndexOf("/"));
-var _4d=this._find(_47,_4c);
-if(_4d){
-_4d.setAttribute(_4b.substr(1),_49);
+Freja.QueryEngine.prototype.set=function(_4a,_4b,_4c){
+var _4d=this._find(_4a,_4b);
+if(!_4d){
+var _4e=_4b.substr(_4b.lastIndexOf("/")+1);
+if(_4e.charAt(0)=="@"){
+var _4f=_4b.substring(0,_4b.lastIndexOf("/"));
+var _50=this._find(_4a,_4f);
+if(_50){
+_50.setAttribute(_4e.substr(1),_4c);
 return;
 }
 }
-throw new Error("Can't evaluate expression "+_48);
+throw new Error("Can't evaluate expression "+_4b);
 }
-switch(_4a.nodeType){
+switch(_4d.nodeType){
 case 1:
-if(_4a.firstChild&&(_4a.firstChild.nodeType==3||_4a.firstChild.nodeType==4)){
-_4a.firstChild.nodeValue=_49;
+if(_4d.firstChild&&(_4d.firstChild.nodeType==3||_4d.firstChild.nodeType==4)){
+_4d.firstChild.nodeValue=_4c;
 }else{
-if(_49!=""){
-_4a.appendChild(_47.createTextNode(_49));
+if(_4c!=""){
+_4d.appendChild(_4a.createTextNode(_4c));
 }
 }
 break;
 case 2:
-_4a.nodeValue=_49;
+_4d.nodeValue=_4c;
 break;
 case 3:
 case 4:
-_4a.nodeValue=_49;
+_4d.nodeValue=_4c;
 break;
 }
 return;
@@ -330,76 +340,76 @@
 Freja.QueryEngine.XPath=function(){
 };
 Freja.Class.extend(Freja.QueryEngine.XPath,Freja.QueryEngine);
-Freja.QueryEngine.XPath.prototype._find=function(_4e,_4f){
-var _50=_4e.selectSingleNode(_4f);
-return _50;
+Freja.QueryEngine.XPath.prototype._find=function(_51,_52){
+var _53=_51.selectSingleNode(_52);
+return _53;
 };
 Freja.QueryEngine.SimplePath=function(){
 };
 Freja.Class.extend(Freja.QueryEngine.SimplePath,Freja.QueryEngine);
-Freja.QueryEngine.SimplePath.prototype._find=function(_51,_52){
-if(!_52.match(/^[\d\w\/@\[\]=_\-']*$/)){
-throw new Error("Can't evaluate expression "+_52);
+Freja.QueryEngine.SimplePath.prototype._find=function(_54,_55){
+if(!_55.match(/^[\d\w\/@\[\]=_\-']*$/)){
+throw new Error("Can't evaluate expression "+_55);
 }
-var _53=_52.split("/");
-var _54=_51;
-var _55=new RegExp("^@([\\d\\w]*)");
-var _56=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
-var _57=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
-var _58=null;
-var _59=0;
-for(var i=0;i<_53.length;++i){
-var _5b=_53[i];
-var _5c=_57.exec(_5b);
-if(_5c){
-if(i>0&&_53[i-1]==""){
-var cn=_54.getElementsByTagName(_5c[1]);
+var _56=_55.split("/");
+var _57=_54;
+var _58=new RegExp("^@([\\d\\w]*)");
+var _59=new RegExp("^([@\\d\\w]*)\\[([\\d]*)\\]$");
+var _5a=new RegExp("^([\\d\\w]+)\\[@([@\\d\\w]+)=['\"]{1}(.*)['\"]{1}\\]$");
+var _5b=null;
+var _5c=0;
+for(var i=0;i<_56.length;++i){
+var _5e=_56[i];
+var _5f=_5a.exec(_5e);
+if(_5f){
+if(i>0&&_56[i-1]==""){
+var cn=_57.getElementsByTagName(_5f[1]);
 }else{
-var cn=_54.childNodes;
+var cn=_57.childNodes;
 }
 for(var j=0,l=cn.length;j<l;j++){
-if(cn[j].nodeType==1&&cn[j].tagName==_5c[1]&&cn[j].getAttribute(_5c[2])==_5c[3]){
-_54=cn[j];
+if(cn[j].nodeType==1&&cn[j].tagName==_5f[1]&&cn[j].getAttribute(_5f[2])==_5f[3]){
+_57=cn[j];
 break;
 }
 }
 if(j==l){
-throw new Error("Can't evaluate expression "+_5b);
+throw new Error("Can't evaluate expression "+_5e);
 }
 }else{
-_59=_56.exec(_5b);
-if(_59){
-_5b=_59[1];
-_59=_59[2]-1;
+_5c=_59.exec(_5e);
+if(_5c){
+_5e=_5c[1];
+_5c=_5c[2]-1;
 }else{
-_59=0;
+_5c=0;
 }
-if(_5b!=""){
-_58=_55.exec(_5b);
-if(_58){
-_54=_54.getAttributeNode(_58[1]);
+if(_5e!=""){
+_5b=_58.exec(_5e);
+if(_5b){
+_57=_57.getAttributeNode(_5b[1]);
 }else{
-_54=_54.getElementsByTagName(_5b).item(_59);
+_57=_57.getElementsByTagName(_5e).item(_5c);
 }
 }
 }
 }
-if(_54&&_54.firstChild&&_54.firstChild.nodeType==3){
-return _54.firstChild;
+if(_57&&_57.firstChild&&_57.firstChild.nodeType==3){
+return _57.firstChild;
 }
-if(_54&&_54.firstChild&&_54.firstChild.nodeType==4){
-return _54.firstChild;
+if(_57&&_57.firstChild&&_57.firstChild.nodeType==4){
+return _57.firstChild;
 }
-if(!_54){
-throw new Error("Can't evaluate expression "+_52);
+if(!_57){
+throw new Error("Can't evaluate expression "+_55);
 }
-return _54;
+return _57;
 };
-Freja.Model=function(url,_60){
+Freja.Model=function(url,_63){
 this.url=url;
 this.ready=false;
 this.document=null;
-this._query=_60;
+this._query=_63;
 };
 Freja.Model.prototype.getElementById=function(id){
 if(this.document){
@@ -407,31 +417,31 @@
 }
 return null;
 };
-Freja.Model.prototype.get=function(_62){
+Freja.Model.prototype.get=function(_65){
 if(this.document){
-return this._query.get(this.document,_62);
+return this._query.get(this.document,_65);
 }
 return null;
 };
-Freja.Model.prototype.set=function(_63,_64){
+Freja.Model.prototype.set=function(_66,_67){
 if(this.document){
-return this._query.set(this.document,_63,_64);
+return this._query.set(this.document,_66,_67);
 }
 return null;
 };
-Freja.Model.prototype.updateFrom=function(_65){
-var _66=_65.getValues();
-for(var i=0;i<_66[0].length;++i){
-if(_66[0][i].lastIndexOf("/")!=-1){
-this.set(_66[0][i],_66[1][i]);
+Freja.Model.prototype.updateFrom=function(_68){
+var _69=_68.getValues();
+for(var i=0;i<_69[0].length;++i){
+if(_69[0][i].lastIndexOf("/")!=-1){
+this.set(_69[0][i],_69[1][i]);
 }
 }
 };
 Freja.Model.prototype.save=function(){
 var url=this.url;
-var _69=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_69){
-url=_69[1]+url;
+var _6c=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_6c){
+url=_6c[1]+url;
 }
 var d=Freja._aux.createDeferred();
 var req=Freja.AssetManager.openXMLHttpRequest("POST",url);
@@ -445,68 +455,68 @@
 };
 Freja.Model.prototype.remove=function(){
 var url=this.url;
-var _6d=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_6d){
-url=_6d[1]+url;
+var _70=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_70){
+url=_70[1]+url;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("DELETE",url);
 return Freja._aux.sendXMLHttpRequest(req);
 };
 Freja.Model.prototype.reload=function(){
 this.ready=false;
-var _6f=Freja._aux.bind(function(_70){
-this.document=_70;
+var _72=Freja._aux.bind(function(_73){
+this.document=_73;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },this);
 var d=Freja.AssetManager.loadAsset(this.url,true);
-d.addCallbacks(_6f,Freja.AssetManager.onerror);
+d.addCallbacks(_72,Freja.AssetManager.onerror);
 return d;
 };
-Freja.Model.DataSource=function(_72,_73){
-this.createURL=_72;
-this.indexURL=_73;
+Freja.Model.DataSource=function(_75,_76){
+this.createURL=_75;
+this.indexURL=_76;
 };
 Freja.Model.DataSource.prototype.select=function(){
 return getModel(this.indexURL);
 };
-Freja.Model.DataSource.prototype.create=function(_74){
+Freja.Model.DataSource.prototype.create=function(_77){
 var url=this.createURL;
-var _76=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_76){
-url=_76[1]+url;
+var _79=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_79){
+url=_79[1]+url;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("PUT",url);
-var _78={};
-for(var i=0,len=_74[0].length;i<len;++i){
-_78[_74[0][i]]=_74[1][i];
+var _7b={};
+for(var i=0,len=_77[0].length;i<len;++i){
+_7b[_77[0][i]]=_77[1][i];
 }
-return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_78,"record"));
+return Freja._aux.sendXMLHttpRequest(req,Freja._aux.xmlize(_7b,"record"));
 };
-Freja.View=function(url,_7b){
+Freja.View=function(url,_7e){
 this.url=url;
 this.ready=false;
 this.document=null;
-this._renderer=_7b;
+this._renderer=_7e;
 this._destination=null;
 this.behaviors=[];
 this.placeholder=null;
 Freja._aux.connect(this,"onrendercomplete",Freja._aux.bind(this._connectBehavior,this));
 };
-Freja.View.prototype.render=function(_7c,_7d,_7e){
-if(typeof (_7d)=="undefined"){
-_7d=this.placeholder;
+Freja.View.prototype.render=function(_7f,_80,_81){
+if(typeof (_80)=="undefined"){
+_80=this.placeholder;
 }
-if(typeof (_7e)=="undefined"){
-_7e=this.xslParameters;
+if(typeof (_81)=="undefined"){
+_81=this.xslParameters;
 }
-var _7f=function(_80,_81,_82,_83){
-this.model=_80;
-this.view=_81;
-this.deferred=_82;
-this.xslParameters=_83;
+var _82=function(_83,_84,_85,_86){
+this.model=_83;
+this.view=_84;
+this.deferred=_85;
+this.xslParameters=_86;
 };
-_7f.prototype.trigger=function(){
+_82.prototype.trigger=function(){
 try{
 if(!this.view.ready){
 Freja._aux.connect(this.view,"onload",Freja._aux.bind(this.trigger,this));
@@ -516,30 +526,30 @@
 Freja._aux.connect(this.model,"onload",Freja._aux.bind(this.trigger,this));
 return;
 }
-var _84;
+var _87;
 if(typeof (this.model)=="undefined"){
-_84={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
+_87={document:Freja._aux.loadXML("<?xml version='1.0' ?><dummy/>")};
 }else{
 if(this.model instanceof Freja.Model){
-_84=this.model;
+_87=this.model;
 }else{
-_84={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
+_87={document:Freja._aux.loadXML("<?xml version='1.0' ?>\n"+Freja._aux.xmlize(this.model,"item"))};
 }
 }
-var _85=this.view._renderer.transform(_84,this.view,this.xslParameters);
-_85.addCallback(Freja._aux.bind(function(_86){
-if(typeof _86=="string"){
-this._destination.innerHTML=_86;
+var _88=this.view._renderer.transform(_87,this.view,this.xslParameters);
+_88.addCallback(Freja._aux.bind(function(_89){
+if(typeof _89=="string"){
+this._destination.innerHTML=_89;
 }else{
 this._destination.innerHTML="";
-this._destination.appendChild(_86);
+this._destination.appendChild(_89);
 }
 },this.view));
-_85.addCallback(Freja._aux.bind(function(){
+_88.addCallback(Freja._aux.bind(function(){
 Freja._aux.signal(this,"onrendercomplete",this._destination);
 },this.view));
-_85.addCallback(this.deferred.callback);
-_85.addErrback(this.deferred.errback);
+_88.addCallback(this.deferred.callback);
+_88.addErrback(this.deferred.errback);
 }
 catch(ex){
 this.deferred.errback(ex);
@@ -547,13 +557,13 @@
 };
 var d=Freja._aux.createDeferred();
 try{
-if(typeof (_7d)=="object"){
-this._destination=_7d;
+if(typeof (_80)=="object"){
+this._destination=_80;
 }else{
-this._destination=document.getElementById(_7d);
+this._destination=document.getElementById(_80);
 }
 this._destination.innerHTML=Freja.AssetManager.THROBBER_HTML;
-var h=new _7f(_7c,this,d,_7e);
+var h=new _82(_7f,this,d,_81);
 h.trigger();
 }
 catch(ex){
@@ -561,49 +571,49 @@
 }
 return d;
 };
-Freja.View.prototype._connectBehavior=function(_89){
+Freja.View.prototype._connectBehavior=function(_8c){
 try{
-var _8a=function(_8b,_8c,_8d){
-Freja._aux.connect(_8b,_8c,Freja._aux.bind(function(e){
-var _8f=false;
+var _8d=function(_8e,_8f,_90){
+Freja._aux.connect(_8e,_8f,Freja._aux.bind(function(e){
+var _92=false;
 try{
-_8f=_8d(this);
+_92=_90(this);
 }
 catch(ex){
 throw new Error("An error ocurred in user handler.\n"+ex.message);
 }
 finally{
-if(!_8f){
+if(!_92){
 e.stop();
 }
 }
-},_8b));
+},_8e));
 };
-var _90=function(_91,_92){
-for(var i=0,c=_91.childNodes,l=c.length;i<l;++i){
-var _94=c[i];
-if(_94.nodeType==1){
-if(_94.className){
-var _95=_94.className.split(" ");
-for(var j=0;j<_95.length;j++){
-var _97=_92[_95[j]];
-if(_97){
-for(var _98 in _97){
-if(_98=="init"){
-_97.init(_94);
+var _93=function(_94,_95){
+for(var i=0,c=_94.childNodes,l=c.length;i<l;++i){
+var _97=c[i];
+if(_97.nodeType==1){
+if(_97.className){
+var _98=_97.className.split(" ");
+for(var j=0;j<_98.length;j++){
+var _9a=_95[_98[j]];
+if(_9a){
+for(var _9b in _9a){
+if(_9b=="init"){
+_9a.init(_97);
 }else{
-_8a(_94,_98,_97[_98]);
+_8d(_97,_9b,_9a[_9b]);
 }
 }
 }
 }
 }
-_90(_94,_92);
+_93(_97,_95);
 }
 }
 };
 for(var ids in this.behaviors){
-_90(_89,this.behaviors);
+_93(_8c,this.behaviors);
 break;
 }
 }
@@ -619,14 +629,14 @@
 Freja.View.Renderer.XSLTransformer=function(){
 };
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9a,_9b,_9c){
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9d,_9e,_9f){
 var d=Freja._aux.createDeferred();
 try{
-var _9e=Freja._aux.transformXSL(_9a.document,_9b.document,_9c);
-if(!_9e){
+var _a1=Freja._aux.transformXSL(_9d.document,_9e.document,_9f);
+if(!_a1){
 d.errback(new Error("XSL Transformation error."));
 }else{
-d.callback(_9e);
+d.callback(_a1);
 }
 }
 catch(ex){
@@ -638,16 +648,16 @@
 this.url=url;
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a0,_a1,_a2){
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a3,_a4,_a5){
 var d=Freja._aux.createDeferred();
-var _a4=_a1.url;
-var _a5="xslFile="+encodeURIComponent(_a4)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_a0.document));
-var _a6="";
-for(var _a7 in _a2){
-_a6+=encodeURIComponent(_a7+","+_a2[_a7]);
+var _a7=_a4.url;
+var _a8="xslFile="+encodeURIComponent(_a7)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_a3.document));
+var _a9="";
+for(var _aa in _a5){
+_a9+=encodeURIComponent(_aa+","+_a5[_aa]);
 }
-if(_a6.length>0){
-_a5=_a5+"&xslParam="+_a6;
+if(_a9.length>0){
+_a8=_a8+"&xslParam="+_a9;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
 req.onreadystatechange=function(){
@@ -659,7 +669,7 @@
 }
 }
 };
-req.send(_a5);
+req.send(_a8);
 return d;
 };
 Freja.UndoHistory=function(){
@@ -668,40 +678,40 @@
 this._position=0;
 this._undoSteps=0;
 };
-Freja.UndoHistory.prototype.add=function(_a9){
-var _aa=this._position%this.maxLength;
-var _ab=_a9.document;
-this.cache[_aa]={};
-this.cache[_aa].model=_a9;
-this.cache[_aa].document=Freja._aux.cloneXMLDocument(_ab);
-if(!this.cache[_aa].document){
+Freja.UndoHistory.prototype.add=function(_ac){
+var _ad=this._position%this.maxLength;
+var _ae=_ac.document;
+this.cache[_ad]={};
+this.cache[_ad].model=_ac;
+this.cache[_ad].document=Freja._aux.cloneXMLDocument(_ae);
+if(!this.cache[_ad].document){
 throw new Error("Couldn't add to history.");
 }else{
 this._position++;
-var _ac=_aa;
+var _af=_ad;
 while(this._undoSteps>0){
-_ac=(_ac+1)%this.maxLength;
-this.cache[_ac]={};
+_af=(_af+1)%this.maxLength;
+this.cache[_af]={};
 this._undoSteps--;
 }
-return _aa;
+return _ad;
 }
 };
-Freja.UndoHistory.prototype.undo=function(_ad){
+Freja.UndoHistory.prototype.undo=function(_b0){
 if(this._undoSteps<this.cache.length){
 this._undoSteps++;
 this._position--;
 if(this._position<0){
 this._position=this.maxLength-1;
 }
-var _ae=this.cache[this._position].model;
+var _b1=this.cache[this._position].model;
 if(this.cache[this._position].document){
-_ae.document=this.cache[this._position].document;
+_b1.document=this.cache[this._position].document;
 }else{
 throw new Error("The model's DOMDocument wasn't properly copied into the history");
 }
-if(typeof (_ad)!="undefined"&&_ad>1){
-this.undo(_ad-1);
+if(typeof (_b0)!="undefined"&&_b0>1){
+this.undo(_b0-1);
 }
 }else{
 throw new Error("Nothing to undo");
@@ -711,8 +721,8 @@
 if(this._undoSteps>0){
 this._undoSteps--;
 this._position=(this._position+1)%this.maxLength;
-var _af=this.cache[this._position].model;
-_af.document=this.cache[this._position].document;
+var _b2=this.cache[this._position].model;
+_b2.document=this.cache[this._position].document;
 }else{
 throw new Error("Nothing to redo");
 }
@@ -748,12 +758,12 @@
 }
 }
 var m=new Freja.Model(url,Freja._aux.createQueryEngine());
-var _b3=Freja._aux.bind(function(_b4){
-this.document=_b4;
+var _b6=Freja._aux.bind(function(_b7){
+this.document=_b7;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },m);
-this.loadAsset(url,true).addCallbacks(_b3,Freja.AssetManager.onerror);
+this.loadAsset(url,true).addCallbacks(_b6,Freja.AssetManager.onerror);
 this.models.push(m);
 return m;
 };
@@ -764,46 +774,46 @@
 }
 }
 var v=new Freja.View(url,this.createRenderer());
-var _b8=Freja._aux.bind(function(_b9){
-this.document=_b9;
+var _bb=Freja._aux.bind(function(_bc){
+this.document=_bc;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },v);
-this.loadAsset(url,false).addCallbacks(_b8,Freja.AssetManager.onerror);
+this.loadAsset(url,false).addCallbacks(_bb,Freja.AssetManager.onerror);
 this.views.push(v);
 return v;
 };
-Freja.AssetManager.openXMLHttpRequest=function(_ba,url){
-var _bc=null;
-if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_ba!="GET"&&_ba!="POST"){
-_bc=_ba;
-_ba="POST";
+Freja.AssetManager.openXMLHttpRequest=function(_bd,url){
+var _bf=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_bd!="GET"&&_bd!="POST"){
+_bf=_bd;
+_bd="POST";
 }
-var req=Freja._aux.openXMLHttpRequest(_ba,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
-if(_bc){
-req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_bc);
+var req=Freja._aux.openXMLHttpRequest(_bd,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_bf){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_bf);
 }
 return req;
 };
-Freja.AssetManager.setCredentials=function(_be,_bf){
-this._username=_be;
-this._password=_bf;
+Freja.AssetManager.setCredentials=function(_c1,_c2){
+this._username=_c1;
+this._password=_c2;
 };
-Freja.AssetManager.loadAsset=function(url,_c1){
-var _c2=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_c2){
-url=_c2[1]+url;
+Freja.AssetManager.loadAsset=function(url,_c4){
+var _c5=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_c5){
+url=_c5[1]+url;
 }
 var d=Freja._aux.createDeferred();
-var _c4=function(_c5){
+var _c7=function(_c8){
 try{
-if(_c5.responseText==""){
+if(_c8.responseText==""){
 throw new Error("Empty response.");
 }
-if(_c5.responseXML.xml==""){
-var _c6=Freja._aux.loadXML(_c5.responseText);
+if(_c8.responseXML.xml==""){
+var _c9=Freja._aux.loadXML(_c8.responseText);
 }else{
-var _c6=_c5.responseXML;
+var _c9=_c8.responseXML;
 }
 }
 catch(ex){
@@ -811,28 +821,28 @@
 }
 if(window.document.all){
 setTimeout(function(){
-d.callback(_c6);
+d.callback(_c9);
 },1);
 }else{
-d.callback(_c6);
+d.callback(_c9);
 }
 };
 try{
-if(_c1&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+if(_c4&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
 var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
 req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
 }else{
 var req=Freja._aux.openXMLHttpRequest("GET",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 }
-var _c8=Freja._aux.sendXMLHttpRequest(req);
+var _cb=Freja._aux.sendXMLHttpRequest(req);
 if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
-_c8.addCallbacks(_c4,function(req){
+_cb.addCallbacks(_c7,function(req){
 d.errback(new Error("Request failed:"+req.status));
 });
 }else{
 if(req.status==0||req.status==200||req.status==201||req.status==304){
-_c4(req);
+_c7(req);
 }else{
 d.errback(new Error("Request failed:"+req.status));
 }

Modified: trunk/src/auxiliary/minimal.js
===================================================================
--- trunk/src/auxiliary/minimal.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/src/auxiliary/minimal.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -1145,3 +1145,10 @@
 Freja._aux.Deferred.prototype.addErrback = function(fncError) {
 	this.addCallbacks(null, fncError);
 };
+Freja._aux.importNode = function(document, node, deep) {
+	if(typeof deep =='undefined') deep = true;
+	if(document.importNode)
+		return document.importNode(node,deep);
+	else
+		return node.cloneNode(deep);
+}
\ No newline at end of file

Modified: trunk/src/auxiliary/mochi+sarissa.js
===================================================================
--- trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 19:05:13 UTC (rev 87)
+++ trunk/src/auxiliary/mochi+sarissa.js	2007-03-21 20:30:15 UTC (rev 88)
@@ -185,8 +185,14 @@
 		return new Freja.QueryEngine.SimplePath();
 	}
 };
+Freja._aux.importNode = function(document, node, deep) {
+	if(typeof deep =='undefined') deep = true;
+	if(document.importNode)
+		return document.importNode(node,deep);
+	else
+		return node.cloneNode(deep);
+}
 
-
 /**
  * ====================================================================
  * About



From cedsav at mail.berlios.de  Thu Mar 29 23:55:43 2007
From: cedsav at mail.berlios.de (cedsav at mail.berlios.de)
Date: Thu, 29 Mar 2007 23:55:43 +0200
Subject: [Freja-svn] r89 - in trunk: examples/tutorial lib/minimal
	lib/mochi+sarissa src src/auxiliary
Message-ID: <200703292155.l2TLthdK019190@sheep.berlios.de>

Author: cedsav
Date: 2007-03-29 23:55:30 +0200 (Thu, 29 Mar 2007)
New Revision: 89

Modified:
   trunk/examples/tutorial/example.html
   trunk/examples/tutorial/example.js
   trunk/lib/minimal/Freja.js
   trunk/lib/minimal/Freja_pack.js
   trunk/lib/mochi+sarissa/Freja.js
   trunk/lib/mochi+sarissa/Freja_pack.js
   trunk/src/Freja.js
   trunk/src/Model.js
   trunk/src/View.js
   trunk/src/auxiliary/minimal.js
Log:
Fixed deferred scope bug in View.render();
Modified tutorial example to show use of callbacks.
Changed version number to 2.1.1


Modified: trunk/examples/tutorial/example.html
===================================================================
--- trunk/examples/tutorial/example.html	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/examples/tutorial/example.html	2007-03-29 21:55:30 UTC (rev 89)
@@ -5,9 +5,11 @@
 <title>Freja Example</title>
 
 <!-- Freja Framework Script -->
+<!--  
 <script type="text/javascript" src="../../lib/mochi+sarissa/MochiKit.js"></script>
 <script type="text/javascript" src="../../lib/mochi+sarissa/Sarissa.js"></script>
-<script type="text/javascript" src="../../lib/mochi+sarissa/Freja.js"></script>
+-->
+<script type="text/javascript" src="../../lib/minimal/Freja.js"></script>
 
 <!-- Controller Code -->
 <script type="text/javascript" src="example.js"></script>

Modified: trunk/examples/tutorial/example.js
===================================================================
--- trunk/examples/tutorial/example.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/examples/tutorial/example.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -3,7 +3,7 @@
 var display = getView("views/display.xsl");
 display.placeholder = 'content';
 display.behaviors["editLink"] = {
-	onclick : function() { edit.render(data); }
+	onclick : function() { edit.render(data).addErrback(errback); }
 };
 
 var edit = getView("views/edit.xsl");
@@ -11,15 +11,25 @@
 edit.behaviors["editForm"] = {
 	onsubmit : function() { 
 		data.updateFrom(edit);
-		display.render(data);
+		display.render(data).addCallbacks(callback,errback);
 		return false;
 	}
 };
 edit.behaviors["displayLink"] = {
-	onclick : function() { display.render(data); }
+	onclick : function() { 
+		display.render(data).addErrback(errback);
+	}
 };
 
 
-connect(window, "onload", function() {
-	display.render(data);
-});
\ No newline at end of file
+Freja._aux.connect(window, "onload", function() {
+	display.render(data).addErrback(errback);
+});
+
+
+function callback() {
+	alert('ok');
+}
+function errback(x) {
+	alert('errob:'+x.message+'\n'+x.stack);
+}
\ No newline at end of file

Modified: trunk/lib/minimal/Freja.js
===================================================================
--- trunk/lib/minimal/Freja.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/lib/minimal/Freja.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -1,8 +1,8 @@
 /***
 
-    Freja 2.1
+    Freja 2.1.1
 
-    Build $Wed, 21 Mar 2007 20:26:12 UTC$
+    Build $Thu, 29 Mar 2007 20:39:48 UTC$
 
     Target: minimal
 
@@ -21,7 +21,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.1";
+Freja.VERSION = "2.1.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };
@@ -1039,16 +1039,18 @@
 Freja._aux.signal = function(src, signal) {
 
 	try {
-		var sigs = src._signals[signal];
-		var args = [];
-		for (var i=2; i < arguments.length; i++) {
-			args.push(arguments[i]);
+		if(src._signals && src._signals[signal]) {
+			var sigs = src._signals[signal];
+			var args = [];
+			for (var i=2; i < arguments.length; i++) {
+				args.push(arguments[i]);
+			}
+			for (var i=0; i < sigs.length; i++) {
+				try {
+					sigs[i].apply(src, args);
+				} catch (e) { /* squelch */ }
+			}
 		}
-		for (var i=0; i < sigs.length; i++) {
-			try {
-				sigs[i].apply(src, args);
-			} catch (e) { /* squelch */ }
-		}
 	} catch (e) { /* squelch */ }
 };
 /** createDeferred() : Deferred */
@@ -1402,7 +1404,11 @@
 	for (var i = 0; i < values[0].length; ++i) {
 		// try not to process field names that are not meant to be xpath expressions
 		if(values[0][i].lastIndexOf('/') != -1) {		
-			this.set(values[0][i], values[1][i]);
+			try {
+				this.set(values[0][i], values[1][i]);
+			} catch(x) {
+				// couldn't set the value.
+			}
 		}
 	}
 };
@@ -1549,8 +1555,14 @@
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
 			}, this.view));
-			trans.addCallback(this.deferred.callback);
-			trans.addErrback(this.deferred.errback);
+			trans.addCallback(Freja._aux.bind(
+				function() { 
+					this.deferred.callback();
+				}, this));
+			trans.addErrback(Freja._aux.bind(
+				function(ex) { 
+					this.deferred.errback(ex);
+				}, this));
 		} catch (ex) {
 			this.deferred.errback(ex);
 		}
@@ -1654,6 +1666,7 @@
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
+       
         try {
 			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
 		if (!html) {

Modified: trunk/lib/minimal/Freja_pack.js
===================================================================
--- trunk/lib/minimal/Freja_pack.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/lib/minimal/Freja_pack.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -5,7 +5,7 @@
 Freja={};
 }
 Freja.NAME="Freja";
-Freja.VERSION="2.1";
+Freja.VERSION="2.1.1";
 Freja.__repr__=function(){
 return "["+this.NAME+" "+this.VERSION+"]";
 };
@@ -644,6 +644,7 @@
 };
 Freja._aux.signal=function(src,_93){
 try{
+if(src._signals&&src._signals[_93]){
 var _94=src._signals[_93];
 var _95=[];
 for(var i=2;i<arguments.length;i++){
@@ -657,6 +658,7 @@
 }
 }
 }
+}
 catch(e){
 }
 };
@@ -967,9 +969,13 @@
 var _de=_dd.getValues();
 for(var i=0;i<_de[0].length;++i){
 if(_de[0][i].lastIndexOf("/")!=-1){
+try{
 this.set(_de[0][i],_de[1][i]);
 }
+catch(x){
 }
+}
+}
 };
 Freja.Model.prototype.save=function(){
 var url=this.url;
@@ -1082,8 +1088,12 @@
 _fd.addCallback(Freja._aux.bind(function(){
 Freja._aux.signal(this,"onrendercomplete",this._destination);
 },this.view));
-_fd.addCallback(this.deferred.callback);
-_fd.addErrback(this.deferred.errback);
+_fd.addCallback(Freja._aux.bind(function(){
+this.deferred.callback();
+},this));
+_fd.addErrback(Freja._aux.bind(function(ex){
+this.deferred.errback(ex);
+},this));
 }
 catch(ex){
 this.deferred.errback(ex);
@@ -1105,49 +1115,49 @@
 }
 return d;
 };
-Freja.View.prototype._connectBehavior=function(_101){
+Freja.View.prototype._connectBehavior=function(_102){
 try{
-var _102=function(node,_104,_105){
-Freja._aux.connect(node,_104,Freja._aux.bind(function(e){
-var _107=false;
+var _103=function(node,_105,_106){
+Freja._aux.connect(node,_105,Freja._aux.bind(function(e){
+var _108=false;
 try{
-_107=_105(this);
+_108=_106(this);
 }
 catch(ex){
 throw new Error("An error ocurred in user handler.\n"+ex.message);
 }
 finally{
-if(!_107){
+if(!_108){
 e.stop();
 }
 }
 },node));
 };
-var _108=function(node,_10a){
+var _109=function(node,_10b){
 for(var i=0,c=node.childNodes,l=c.length;i<l;++i){
-var _10c=c[i];
-if(_10c.nodeType==1){
-if(_10c.className){
-var _10d=_10c.className.split(" ");
-for(var j=0;j<_10d.length;j++){
-var _10f=_10a[_10d[j]];
-if(_10f){
-for(var _110 in _10f){
-if(_110=="init"){
-_10f.init(_10c);
+var _10d=c[i];
+if(_10d.nodeType==1){
+if(_10d.className){
+var _10e=_10d.className.split(" ");
+for(var j=0;j<_10e.length;j++){
+var _110=_10b[_10e[j]];
+if(_110){
+for(var _111 in _110){
+if(_111=="init"){
+_110.init(_10d);
 }else{
-_102(_10c,_110,_10f[_110]);
+_103(_10d,_111,_110[_111]);
 }
 }
 }
 }
 }
-_108(_10c,_10a);
+_109(_10d,_10b);
 }
 }
 };
 for(var ids in this.behaviors){
-_108(_101,this.behaviors);
+_109(_102,this.behaviors);
 break;
 }
 }
@@ -1163,10 +1173,10 @@
 Freja.View.Renderer.XSLTransformer=function(){
 };
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.XSLTransformer.prototype.transform=function(_112,view,_114){
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_113,view,_115){
 var d=Freja._aux.createDeferred();
 try{
-var html=Freja._aux.transformXSL(_112.document,view.document,_114);
+var html=Freja._aux.transformXSL(_113.document,view.document,_115);
 if(!html){
 d.errback(new Error("XSL Transformation error."));
 }else{
@@ -1182,16 +1192,16 @@
 this.url=url;
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_118,view,_11a){
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_119,view,_11b){
 var d=Freja._aux.createDeferred();
-var _11c=view.url;
-var _11d="xslFile="+encodeURIComponent(_11c)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_118.document));
-var _11e="";
-for(var _11f in _11a){
-_11e+=encodeURIComponent(_11f+","+_11a[_11f]);
+var _11d=view.url;
+var _11e="xslFile="+encodeURIComponent(_11d)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_119.document));
+var _11f="";
+for(var _120 in _11b){
+_11f+=encodeURIComponent(_120+","+_11b[_120]);
 }
-if(_11e.length>0){
-_11d=_11d+"&xslParam="+_11e;
+if(_11f.length>0){
+_11e=_11e+"&xslParam="+_11f;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
 req.onreadystatechange=function(){
@@ -1203,7 +1213,7 @@
 }
 }
 };
-req.send(_11d);
+req.send(_11e);
 return d;
 };
 Freja.UndoHistory=function(){
@@ -1212,40 +1222,40 @@
 this._position=0;
 this._undoSteps=0;
 };
-Freja.UndoHistory.prototype.add=function(_121){
-var _122=this._position%this.maxLength;
-var _123=_121.document;
-this.cache[_122]={};
-this.cache[_122].model=_121;
-this.cache[_122].document=Freja._aux.cloneXMLDocument(_123);
-if(!this.cache[_122].document){
+Freja.UndoHistory.prototype.add=function(_122){
+var _123=this._position%this.maxLength;
+var _124=_122.document;
+this.cache[_123]={};
+this.cache[_123].model=_122;
+this.cache[_123].document=Freja._aux.cloneXMLDocument(_124);
+if(!this.cache[_123].document){
 throw new Error("Couldn't add to history.");
 }else{
 this._position++;
-var _124=_122;
+var _125=_123;
 while(this._undoSteps>0){
-_124=(_124+1)%this.maxLength;
-this.cache[_124]={};
+_125=(_125+1)%this.maxLength;
+this.cache[_125]={};
 this._undoSteps--;
 }
-return _122;
+return _123;
 }
 };
-Freja.UndoHistory.prototype.undo=function(_125){
+Freja.UndoHistory.prototype.undo=function(_126){
 if(this._undoSteps<this.cache.length){
 this._undoSteps++;
 this._position--;
 if(this._position<0){
 this._position=this.maxLength-1;
 }
-var _126=this.cache[this._position].model;
+var _127=this.cache[this._position].model;
 if(this.cache[this._position].document){
-_126.document=this.cache[this._position].document;
+_127.document=this.cache[this._position].document;
 }else{
 throw new Error("The model's DOMDocument wasn't properly copied into the history");
 }
-if(typeof (_125)!="undefined"&&_125>1){
-this.undo(_125-1);
+if(typeof (_126)!="undefined"&&_126>1){
+this.undo(_126-1);
 }
 }else{
 throw new Error("Nothing to undo");
@@ -1255,8 +1265,8 @@
 if(this._undoSteps>0){
 this._undoSteps--;
 this._position=(this._position+1)%this.maxLength;
-var _127=this.cache[this._position].model;
-_127.document=this.cache[this._position].document;
+var _128=this.cache[this._position].model;
+_128.document=this.cache[this._position].document;
 }else{
 throw new Error("Nothing to redo");
 }
@@ -1292,12 +1302,12 @@
 }
 }
 var m=new Freja.Model(url,Freja._aux.createQueryEngine());
-var _12b=Freja._aux.bind(function(_12c){
-this.document=_12c;
+var _12c=Freja._aux.bind(function(_12d){
+this.document=_12d;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },m);
-this.loadAsset(url,true).addCallbacks(_12b,Freja.AssetManager.onerror);
+this.loadAsset(url,true).addCallbacks(_12c,Freja.AssetManager.onerror);
 this.models.push(m);
 return m;
 };
@@ -1308,46 +1318,46 @@
 }
 }
 var v=new Freja.View(url,this.createRenderer());
-var _130=Freja._aux.bind(function(_131){
-this.document=_131;
+var _131=Freja._aux.bind(function(_132){
+this.document=_132;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },v);
-this.loadAsset(url,false).addCallbacks(_130,Freja.AssetManager.onerror);
+this.loadAsset(url,false).addCallbacks(_131,Freja.AssetManager.onerror);
 this.views.push(v);
 return v;
 };
-Freja.AssetManager.openXMLHttpRequest=function(_132,url){
-var _134=null;
-if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_132!="GET"&&_132!="POST"){
-_134=_132;
-_132="POST";
+Freja.AssetManager.openXMLHttpRequest=function(_133,url){
+var _135=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_133!="GET"&&_133!="POST"){
+_135=_133;
+_133="POST";
 }
-var req=Freja._aux.openXMLHttpRequest(_132,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
-if(_134){
-req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_134);
+var req=Freja._aux.openXMLHttpRequest(_133,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_135){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_135);
 }
 return req;
 };
-Freja.AssetManager.setCredentials=function(_136,_137){
-this._username=_136;
-this._password=_137;
+Freja.AssetManager.setCredentials=function(_137,_138){
+this._username=_137;
+this._password=_138;
 };
-Freja.AssetManager.loadAsset=function(url,_139){
-var _13a=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_13a){
-url=_13a[1]+url;
+Freja.AssetManager.loadAsset=function(url,_13a){
+var _13b=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_13b){
+url=_13b[1]+url;
 }
 var d=Freja._aux.createDeferred();
-var _13c=function(_13d){
+var _13d=function(_13e){
 try{
-if(_13d.responseText==""){
+if(_13e.responseText==""){
 throw new Error("Empty response.");
 }
-if(_13d.responseXML.xml==""){
-var _13e=Freja._aux.loadXML(_13d.responseText);
+if(_13e.responseXML.xml==""){
+var _13f=Freja._aux.loadXML(_13e.responseText);
 }else{
-var _13e=_13d.responseXML;
+var _13f=_13e.responseXML;
 }
 }
 catch(ex){
@@ -1355,14 +1365,14 @@
 }
 if(window.document.all){
 setTimeout(function(){
-d.callback(_13e);
+d.callback(_13f);
 },1);
 }else{
-d.callback(_13e);
+d.callback(_13f);
 }
 };
 try{
-if(_139&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+if(_13a&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
 var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
 req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
@@ -1371,12 +1381,12 @@
 }
 var comm=Freja._aux.sendXMLHttpRequest(req);
 if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
-comm.addCallbacks(_13c,function(req){
+comm.addCallbacks(_13d,function(req){
 d.errback(new Error("Request failed:"+req.status));
 });
 }else{
 if(req.status==0||req.status==200||req.status==201||req.status==304){
-_13c(req);
+_13d(req);
 }else{
 d.errback(new Error("Request failed:"+req.status));
 }

Modified: trunk/lib/mochi+sarissa/Freja.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/lib/mochi+sarissa/Freja.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -1,8 +1,8 @@
 /***
 
-    Freja 2.1
+    Freja 2.1.1
 
-    Build $Wed, 21 Mar 2007 20:26:16 UTC$
+    Build $Thu, 29 Mar 2007 20:39:45 UTC$
 
     Target: mochi+sarissa
 
@@ -21,7 +21,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.1";
+Freja.VERSION = "2.1.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };
@@ -647,7 +647,11 @@
 	for (var i = 0; i < values[0].length; ++i) {
 		// try not to process field names that are not meant to be xpath expressions
 		if(values[0][i].lastIndexOf('/') != -1) {		
-			this.set(values[0][i], values[1][i]);
+			try {
+				this.set(values[0][i], values[1][i]);
+			} catch(x) {
+				// couldn't set the value.
+			}
 		}
 	}
 };
@@ -794,8 +798,14 @@
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
 			}, this.view));
-			trans.addCallback(this.deferred.callback);
-			trans.addErrback(this.deferred.errback);
+			trans.addCallback(Freja._aux.bind(
+				function() { 
+					this.deferred.callback();
+				}, this));
+			trans.addErrback(Freja._aux.bind(
+				function(ex) { 
+					this.deferred.errback(ex);
+				}, this));
 		} catch (ex) {
 			this.deferred.errback(ex);
 		}
@@ -899,6 +909,7 @@
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
+       
         try {
 			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
 		if (!html) {

Modified: trunk/lib/mochi+sarissa/Freja_pack.js
===================================================================
--- trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/lib/mochi+sarissa/Freja_pack.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -5,7 +5,7 @@
 Freja={};
 }
 Freja.NAME="Freja";
-Freja.VERSION="2.1";
+Freja.VERSION="2.1.1";
 Freja.__repr__=function(){
 return "["+this.NAME+" "+this.VERSION+"]";
 };
@@ -433,9 +433,13 @@
 var _69=_68.getValues();
 for(var i=0;i<_69[0].length;++i){
 if(_69[0][i].lastIndexOf("/")!=-1){
+try{
 this.set(_69[0][i],_69[1][i]);
 }
+catch(x){
 }
+}
+}
 };
 Freja.Model.prototype.save=function(){
 var url=this.url;
@@ -548,8 +552,12 @@
 _88.addCallback(Freja._aux.bind(function(){
 Freja._aux.signal(this,"onrendercomplete",this._destination);
 },this.view));
-_88.addCallback(this.deferred.callback);
-_88.addErrback(this.deferred.errback);
+_88.addCallback(Freja._aux.bind(function(){
+this.deferred.callback();
+},this));
+_88.addErrback(Freja._aux.bind(function(ex){
+this.deferred.errback(ex);
+},this));
 }
 catch(ex){
 this.deferred.errback(ex);
@@ -571,49 +579,49 @@
 }
 return d;
 };
-Freja.View.prototype._connectBehavior=function(_8c){
+Freja.View.prototype._connectBehavior=function(_8d){
 try{
-var _8d=function(_8e,_8f,_90){
-Freja._aux.connect(_8e,_8f,Freja._aux.bind(function(e){
-var _92=false;
+var _8e=function(_8f,_90,_91){
+Freja._aux.connect(_8f,_90,Freja._aux.bind(function(e){
+var _93=false;
 try{
-_92=_90(this);
+_93=_91(this);
 }
 catch(ex){
 throw new Error("An error ocurred in user handler.\n"+ex.message);
 }
 finally{
-if(!_92){
+if(!_93){
 e.stop();
 }
 }
-},_8e));
+},_8f));
 };
-var _93=function(_94,_95){
-for(var i=0,c=_94.childNodes,l=c.length;i<l;++i){
-var _97=c[i];
-if(_97.nodeType==1){
-if(_97.className){
-var _98=_97.className.split(" ");
-for(var j=0;j<_98.length;j++){
-var _9a=_95[_98[j]];
-if(_9a){
-for(var _9b in _9a){
-if(_9b=="init"){
-_9a.init(_97);
+var _94=function(_95,_96){
+for(var i=0,c=_95.childNodes,l=c.length;i<l;++i){
+var _98=c[i];
+if(_98.nodeType==1){
+if(_98.className){
+var _99=_98.className.split(" ");
+for(var j=0;j<_99.length;j++){
+var _9b=_96[_99[j]];
+if(_9b){
+for(var _9c in _9b){
+if(_9c=="init"){
+_9b.init(_98);
 }else{
-_8d(_97,_9b,_9a[_9b]);
+_8e(_98,_9c,_9b[_9c]);
 }
 }
 }
 }
 }
-_93(_97,_95);
+_94(_98,_96);
 }
 }
 };
 for(var ids in this.behaviors){
-_93(_8c,this.behaviors);
+_94(_8d,this.behaviors);
 break;
 }
 }
@@ -629,14 +637,14 @@
 Freja.View.Renderer.XSLTransformer=function(){
 };
 Freja.Class.extend(Freja.View.Renderer.XSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9d,_9e,_9f){
+Freja.View.Renderer.XSLTransformer.prototype.transform=function(_9e,_9f,_a0){
 var d=Freja._aux.createDeferred();
 try{
-var _a1=Freja._aux.transformXSL(_9d.document,_9e.document,_9f);
-if(!_a1){
+var _a2=Freja._aux.transformXSL(_9e.document,_9f.document,_a0);
+if(!_a2){
 d.errback(new Error("XSL Transformation error."));
 }else{
-d.callback(_a1);
+d.callback(_a2);
 }
 }
 catch(ex){
@@ -648,16 +656,16 @@
 this.url=url;
 };
 Freja.Class.extend(Freja.View.Renderer.RemoteXSLTransformer,Freja.View.Renderer);
-Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a3,_a4,_a5){
+Freja.View.Renderer.RemoteXSLTransformer.prototype.transform=function(_a4,_a5,_a6){
 var d=Freja._aux.createDeferred();
-var _a7=_a4.url;
-var _a8="xslFile="+encodeURIComponent(_a7)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_a3.document));
-var _a9="";
-for(var _aa in _a5){
-_a9+=encodeURIComponent(_aa+","+_a5[_aa]);
+var _a8=_a5.url;
+var _a9="xslFile="+encodeURIComponent(_a8)+"&xmlData="+encodeURIComponent(Freja._aux.serializeXML(_a4.document));
+var _aa="";
+for(var _ab in _a6){
+_aa+=encodeURIComponent(_ab+","+_a6[_ab]);
 }
-if(_a9.length>0){
-_a8=_a8+"&xslParam="+_a9;
+if(_aa.length>0){
+_a9=_a9+"&xslParam="+_aa;
 }
 var req=Freja.AssetManager.openXMLHttpRequest("POST",Freja.AssetManager.XSLT_SERVICE_URL);
 req.onreadystatechange=function(){
@@ -669,7 +677,7 @@
 }
 }
 };
-req.send(_a8);
+req.send(_a9);
 return d;
 };
 Freja.UndoHistory=function(){
@@ -678,40 +686,40 @@
 this._position=0;
 this._undoSteps=0;
 };
-Freja.UndoHistory.prototype.add=function(_ac){
-var _ad=this._position%this.maxLength;
-var _ae=_ac.document;
-this.cache[_ad]={};
-this.cache[_ad].model=_ac;
-this.cache[_ad].document=Freja._aux.cloneXMLDocument(_ae);
-if(!this.cache[_ad].document){
+Freja.UndoHistory.prototype.add=function(_ad){
+var _ae=this._position%this.maxLength;
+var _af=_ad.document;
+this.cache[_ae]={};
+this.cache[_ae].model=_ad;
+this.cache[_ae].document=Freja._aux.cloneXMLDocument(_af);
+if(!this.cache[_ae].document){
 throw new Error("Couldn't add to history.");
 }else{
 this._position++;
-var _af=_ad;
+var _b0=_ae;
 while(this._undoSteps>0){
-_af=(_af+1)%this.maxLength;
-this.cache[_af]={};
+_b0=(_b0+1)%this.maxLength;
+this.cache[_b0]={};
 this._undoSteps--;
 }
-return _ad;
+return _ae;
 }
 };
-Freja.UndoHistory.prototype.undo=function(_b0){
+Freja.UndoHistory.prototype.undo=function(_b1){
 if(this._undoSteps<this.cache.length){
 this._undoSteps++;
 this._position--;
 if(this._position<0){
 this._position=this.maxLength-1;
 }
-var _b1=this.cache[this._position].model;
+var _b2=this.cache[this._position].model;
 if(this.cache[this._position].document){
-_b1.document=this.cache[this._position].document;
+_b2.document=this.cache[this._position].document;
 }else{
 throw new Error("The model's DOMDocument wasn't properly copied into the history");
 }
-if(typeof (_b0)!="undefined"&&_b0>1){
-this.undo(_b0-1);
+if(typeof (_b1)!="undefined"&&_b1>1){
+this.undo(_b1-1);
 }
 }else{
 throw new Error("Nothing to undo");
@@ -721,8 +729,8 @@
 if(this._undoSteps>0){
 this._undoSteps--;
 this._position=(this._position+1)%this.maxLength;
-var _b2=this.cache[this._position].model;
-_b2.document=this.cache[this._position].document;
+var _b3=this.cache[this._position].model;
+_b3.document=this.cache[this._position].document;
 }else{
 throw new Error("Nothing to redo");
 }
@@ -758,12 +766,12 @@
 }
 }
 var m=new Freja.Model(url,Freja._aux.createQueryEngine());
-var _b6=Freja._aux.bind(function(_b7){
-this.document=_b7;
+var _b7=Freja._aux.bind(function(_b8){
+this.document=_b8;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },m);
-this.loadAsset(url,true).addCallbacks(_b6,Freja.AssetManager.onerror);
+this.loadAsset(url,true).addCallbacks(_b7,Freja.AssetManager.onerror);
 this.models.push(m);
 return m;
 };
@@ -774,46 +782,46 @@
 }
 }
 var v=new Freja.View(url,this.createRenderer());
-var _bb=Freja._aux.bind(function(_bc){
-this.document=_bc;
+var _bc=Freja._aux.bind(function(_bd){
+this.document=_bd;
 this.ready=true;
 Freja._aux.signal(this,"onload");
 },v);
-this.loadAsset(url,false).addCallbacks(_bb,Freja.AssetManager.onerror);
+this.loadAsset(url,false).addCallbacks(_bc,Freja.AssetManager.onerror);
 this.views.push(v);
 return v;
 };
-Freja.AssetManager.openXMLHttpRequest=function(_bd,url){
-var _bf=null;
-if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_bd!="GET"&&_bd!="POST"){
-_bf=_bd;
-_bd="POST";
+Freja.AssetManager.openXMLHttpRequest=function(_be,url){
+var _c0=null;
+if(Freja.AssetManager.HTTP_METHOD_TUNNEL&&_be!="GET"&&_be!="POST"){
+_c0=_be;
+_be="POST";
 }
-var req=Freja._aux.openXMLHttpRequest(_bd,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
-if(_bf){
-req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_bf);
+var req=Freja._aux.openXMLHttpRequest(_be,url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
+if(_c0){
+req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,_c0);
 }
 return req;
 };
-Freja.AssetManager.setCredentials=function(_c1,_c2){
-this._username=_c1;
-this._password=_c2;
+Freja.AssetManager.setCredentials=function(_c2,_c3){
+this._username=_c2;
+this._password=_c3;
 };
-Freja.AssetManager.loadAsset=function(url,_c4){
-var _c5=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
-if(_c5){
-url=_c5[1]+url;
+Freja.AssetManager.loadAsset=function(url,_c5){
+var _c6=/^(file:\/\/.*\/)([^\/]*)$/.exec(window.location.href);
+if(_c6){
+url=_c6[1]+url;
 }
 var d=Freja._aux.createDeferred();
-var _c7=function(_c8){
+var _c8=function(_c9){
 try{
-if(_c8.responseText==""){
+if(_c9.responseText==""){
 throw new Error("Empty response.");
 }
-if(_c8.responseXML.xml==""){
-var _c9=Freja._aux.loadXML(_c8.responseText);
+if(_c9.responseXML.xml==""){
+var _ca=Freja._aux.loadXML(_c9.responseText);
 }else{
-var _c9=_c8.responseXML;
+var _ca=_c9.responseXML;
 }
 }
 catch(ex){
@@ -821,28 +829,28 @@
 }
 if(window.document.all){
 setTimeout(function(){
-d.callback(_c9);
+d.callback(_ca);
 },1);
 }else{
-d.callback(_c9);
+d.callback(_ca);
 }
 };
 try{
-if(_c4&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
+if(_c5&&Freja.AssetManager.HTTP_METHOD_TUNNEL){
 var req=Freja._aux.openXMLHttpRequest("POST",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 req.setRequestHeader(Freja.AssetManager.HTTP_METHOD_TUNNEL,"GET");
 req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
 }else{
 var req=Freja._aux.openXMLHttpRequest("GET",url,Freja.AssetManager.HTTP_REQUEST_TYPE=="async",Freja.AssetManager._username,Freja.AssetManager._password);
 }
-var _cb=Freja._aux.sendXMLHttpRequest(req);
+var _cc=Freja._aux.sendXMLHttpRequest(req);
 if(Freja.AssetManager.HTTP_REQUEST_TYPE=="async"){
-_cb.addCallbacks(_c7,function(req){
+_cc.addCallbacks(_c8,function(req){
 d.errback(new Error("Request failed:"+req.status));
 });
 }else{
 if(req.status==0||req.status==200||req.status==201||req.status==304){
-_c7(req);
+_c8(req);
 }else{
 d.errback(new Error("Request failed:"+req.status));
 }

Modified: trunk/src/Freja.js
===================================================================
--- trunk/src/Freja.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/src/Freja.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -5,7 +5,7 @@
 	Freja = {};
 }
 Freja.NAME = "Freja";
-Freja.VERSION = "2.1";
+Freja.VERSION = "2.1.1";
 Freja.__repr__ = function () {
 	return "[" + this.NAME + " " + this.VERSION + "]";
 };

Modified: trunk/src/Model.js
===================================================================
--- trunk/src/Model.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/src/Model.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -42,7 +42,12 @@
 	for (var i = 0; i < values[0].length; ++i) {
 		// try not to process field names that are not meant to be xpath expressions
 		if(values[0][i].lastIndexOf('/') != -1) {		
-			this.set(values[0][i], values[1][i]);
+			try {
+				this.set(values[0][i], values[1][i]);
+			} catch(x) {
+				// couldn't set the value.
+				// @TODO: Throw new Error.
+			}
 		}
 	}
 };

Modified: trunk/src/View.js
===================================================================
--- trunk/src/View.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/src/View.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -60,8 +60,14 @@
 			trans.addCallback(Freja._aux.bind(function() {
 				Freja._aux.signal(this, "onrendercomplete", this._destination)
 			}, this.view));
-			trans.addCallback(this.deferred.callback);
-			trans.addErrback(this.deferred.errback);
+			trans.addCallback(Freja._aux.bind(
+				function() { 
+					this.deferred.callback();
+				}, this));
+			trans.addErrback(Freja._aux.bind(
+				function(ex) { 
+					this.deferred.errback(ex);
+				}, this));
 		} catch (ex) {
 			this.deferred.errback(ex);
 		}
@@ -165,6 +171,7 @@
   */
 Freja.View.Renderer.XSLTransformer.prototype.transform = function(model, view, xslParameters) {
         var d = Freja._aux.createDeferred();
+       
         try {
 			var html = Freja._aux.transformXSL(model.document, view.document, xslParameters);
 		if (!html) {

Modified: trunk/src/auxiliary/minimal.js
===================================================================
--- trunk/src/auxiliary/minimal.js	2007-03-21 20:30:15 UTC (rev 88)
+++ trunk/src/auxiliary/minimal.js	2007-03-29 21:55:30 UTC (rev 89)
@@ -990,16 +990,18 @@
 Freja._aux.signal = function(src, signal) {
 
 	try {
-		var sigs = src._signals[signal];
-		var args = [];
-		for (var i=2; i < arguments.length; i++) {
-			args.push(arguments[i]);
+		if(src._signals && src._signals[signal]) {
+			var sigs = src._signals[signal];
+			var args = [];
+			for (var i=2; i < arguments.length; i++) {
+				args.push(arguments[i]);
+			}
+			for (var i=0; i < sigs.length; i++) {
+				try {
+					sigs[i].apply(src, args);
+				} catch (e) { /* squelch */ }
+			}
 		}
-		for (var i=0; i < sigs.length; i++) {
-			try {
-				sigs[i].apply(src, args);
-			} catch (e) { /* squelch */ }
-		}
 	} catch (e) { /* squelch */ }
 };
 /** createDeferred() : Deferred */



